<link href="css/msGoalAction.css" rel="stylesheet" />
<style>
    .xx1 .k-multiselect ul > li.k-button > span:first-child {
        white-space: pre;
        max-width: 156px;
        overflow: hidden;
        text-overflow: ellipsis;
        float: left;
    }

    .checkbox > label input:checked ~ .ResourcePlanning {
        background-color: #38baf8;
    }

    .buttonkpi {
        height: 30px;
        background-color: #38baf8; /*
        margin-left: 12px;*/
        position: relative;
        padding-right: 18px;
        display: inline-block;
        border-radius: 3px;
    }

    .styleiconkpi {
        height: 28px;
        background-color: #38baf8;
        width: 77px;
        top: 8px;
        position: relative;
        left: 9px;
    }

    .textkpi {
        color: white;
        margin-left: 12px;
        position: relative;
        top: 5px;
    }

    .styleiconassigfile {
        height: 30px !important;
        background-color: #38baf8;
        margin-left: 8px;
        position: relative;
        padding-right: 18px;
        display: inline-block;
        border-radius: 3px;
        width: initial !important;
    }

    .iconassigfilestyle {
        top: 6px;
        position: relative;
        margin-left: 8px
    }

    .icon-32.cursor-pointer.icon-add + .popover.fade.top {
        margin-left: 0 !important
    }
    .icon-32.cursor-pointer.icon-add-activity + .popover.fade.top {
        margin-left: 0 !important
    }

    .icon-32.cursor-pointer.icon-add + .popover-content {
        max-width: 180px !important
    }
    .icon-32.cursor-pointer.icon-add-activity + .popover-content {
        max-width: 180px !important
    }

    .showicontooltipAssignedAction + .popover.fade.left > .popover-content {
        width: 160px !important
    }

    .icon-32.cursor-pointer.icon-add.btnaddcost.kgv-customtooltip + .popover.fade.top,
    .icon-32.cursor-pointer.icon-add-activity.btnaddcost.kgv-customtooltip + .popover.fade.top,
    .icon-32.cursor-pointer.icon-todos#btnaddtodo.kgv-customtooltip + .popover.fade.top {
        margin-left: -30px !important
    }
    .icon-32.cursor-pointer.icon-todosnew#btnaddtodo.kgv-customtooltip + .popover.fade.top {
        margin-left: -30px !important
    }
    .icon-32.cursor-pointer.icon-todosnew#btnaddtodo.kgv-customtooltip + .popover.fade.top {
        margin-left: -30px !important
    }

    #btnaddtodo.kgv-customtooltip + .popover.fade.top > .arrow:nth-child(1) {
        left: 80% !important
    }

    .btnaddcost.kgv-customtooltip + .popover.fade.top > .arrow:nth-child(1) {
        left: 80% !important
    }

    #subpanel {
        margin-top: 20px !important;
    }

    #btnaddtodo.khanh-has-activity + .popover.fade.top {
        left: 1120px !important
    }

    .icon-32.cursor-pointer.icon-todos + .popover.fade.top {
        margin-left: 0 !important
    }
    .icon-32.cursor-pointer.icon-todosnew + .popover.fade.top {
        margin-left: 0 !important
    }

    .popover-title + .popover-content {
        width: 80px !important;
        padding: 8px 6px;
    }
    #btnaddtodo + .popover.fade .popover-title + .popover-content,
    .icon-add-activity.btnaddcost + .popover.fade .popover-title + .popover-content {
        overflow: hidden;
    }

    .popover-content {
        width: 180px !important
    }

    .icon-32.cursor-pointer.icon-todos + .popover.fade.top {
        margin-left: 0 !important
    }
    .icon-32.cursor-pointer.icon-todosnew + .popover.fade.top {
        margin-left: 0 !important
    }

    /*.popover-title + .popover-content {
        width: 80px !important;
        padding: 8px 6px
    }*/

    .div-action {
        width: 450px;
        height: 100px;
        background-color: white;
        position: absolute;
        z-index: 1;
        left: 30px;
        margin-top: 57px;
        display: none;
        margin-left: -30px;
    }

    #fEditAction .ms-drop {
        margin-left: 181px !important;
        width: 300px !important;
        margin-top: 3px !important;
    }

    .ms-wrapper label {
        white-space: pre;
    }

    .numberofday {
    }

        .numberofday .k-numerictextbox .k-input {
            width: 90px !important;
            padding-right: 5px !important;
        }

    .divtag .k-multiselect-wrap input[class~="k-input"] {
        background-color: transparent !important;
        border-width: 0 !important;
    }

    .divtag .k-multiselect-wrap {
        border-radius: 0px !important;
        padding-right: 18px !important;
    }

    .divtag .k-multiselect.k-header {
        border-color: #E7E7E7 !important;
    }

    .k-animation-container .k-state-focused {
        border-width: 0;
        border-color: #E7E7E7;
        box-shadow: none;
    }

    .divtag .k-multiselect-wrap li[class~="k-button"] {
        color: #2e2e2e;
        border-color: #fafafa;
        background-color: #fafafa;
        border-radius: 30px;
        max-width: 99%;
    }

        .divtag .k-multiselect-wrap li[class~="k-button"]:hover {
            color: #2e2e2e;
            border-color: #EBEBEB;
            background-color: #EBEBEB;
            border-radius: 30px;
            max-width: 99%;
        }

    .divtag .k-multiselect, #ddlSubProductConnection-list, #ddlResponsibility-list {
        width: 393px !important;
    }

    .lblAdvertising {
    }

    .lblAdvertiser {
        overflow: hidden;
    }

    .selectAdvertiser {
        float: left;
        margin-left: 10px;
    }

    #area-edit-action .k-datepicker {
        padding: 0 !important;
    }

    #area-edit-action .k-datepicker .k-select {
        width: 21px !important;
        padding-top: 1px;
    }

    #area-edit-action .k-datepicker .k-input {
        height: 22px !important;
    }

    #picker { margin-right: 5px; }

    .k-selected-color {
        height: 29px !important;
    }

    .k-colorpicker {
        width: 28px;
    }

    .k-colorpicker .k-select {
        display: none;
    }

    .btn-fibu {
        background-color: #38baf8;
        border: none;
        border-radius: 3px;
        height: 24px;
        width: 18px;
        vertical-align: middle;
        padding-left: 5px;
        margin-top: 3px;
        margin-right: 3px;
    }

    .auto-stream { width: 91%; }

    ul.ulsub {
        list-style-type: none;
        padding-left: 6px !important;
        margin-bottom: 0 !important;
    }

    ul.ulsub li {
        margin-right: 3px;
        margin-top: 3px;
        padding: 3px;
        box-shadow: 0 2px 6px rgba(0,0,0,.2),0 2px 3px rgba(0,0,0,.05);
        padding-bottom: 5px;
        display: inline-block;
    }

    .ebebeb {
        background-color: #ebebeb;
    }

    .group-sub {
        background-color: #F7F7F7;
    }

    .ulsub .popover {
        z-index: 100005;
    }

    .ulsub .popover .popover-content {
        padding: 9px 14px;
        border-radius: 0 !important;
    }

    ul.ulpop {
        list-style-type: circle;
        min-width: 200px;
        max-width: 400px;
        min-height: 40px;
        display: block;
        padding-left: 20px;
    }

    ul.ulpop li {
        box-shadow: none;
        display: list-item;
        word-wrap: break-word;
    }

    .divtag .popover-title {
        font-size: 15px;
        padding: 3px 14px;
    }

    .master-goal-label {
        padding: 0px;
    }

    .master-goal-cost {
        color: #8B8891;
        font-weight: normal;
        font-size: 11px;
        width: 130px;
        margin-right: 6px;
    }

    .mg-firstcost {
        padding: 0px;
        font-size: 11px;
    }

    .mg-notfirstcost {
        padding: 0 0 0 2px;
        font-size: 11px;
        margin-left: 20px;
    }

    .row-cost:hover .icon-arow-towway-vertical, .todos:hover .icon-arow-towway-vertical {
        background-position: -154px -8px;
        text-indent: -999px;
        float: left;
        margin-left: -12px;
        margin-right: -20px;
        margin-top: 7px;
        display: block;
    }

    .input-truecost { width: 98px !important; }

    .table-cost .ui-sortable-placeholder {
        height: 45px !important;
    }
    .total-cost {
        font-size: 11px;
        color: #8B8891;
        font-weight: normal;
        margin-left: 11px;
    }

    .abs-bottom-left {
        position: absolute;
        bottom: 0;
        left: 0;
    }

    .abs-bottom-right {
        position: absolute;
        bottom: 0;
        right: 0;
    }

    .group-crm {
        border: 1px solid #56AFD9;
    }

    .col-md-6 {
        width: 49%;
    }

    .col-md-6-1 {
        width: 47% !important;
    }

    .w-70per {
        width: 70.5% !important;
    }

    .date-cost {
        width: 98% !important;
    }

    .k-input {
        padding: 0em 0;
    }

    .margintop40 {
        margin-top: 40px;
    }

    label.ms-select-lable::after {
        content: '';
        font: 8px "Glyphicons Halflings", monospace;
        color: #90817c;
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        right: 10px;
        top: 8px;
        padding: 0 0 2px;
        position: absolute;
        pointer-events: none;
    }

    .a69 {
        width: 69% !important;
    }

    .noReminder {
        display: none !important;
    }

    .timecost.col-md-3 .col-1 {
        width: 98px !important;
    }

    .timecost.col-md-3 .col-2 {
        width: 45px !important;
        padding: 0;
        padding-left: 12px;
        padding-right: 18px !important;
    }

    .clear.department + .k-widget.k-multiselect.k-header {
        width: 97% !important;
        border-color: #c5c5c5 !important;
    }

    .timecost.col-md-3 .col-2 .k-numerictextbox {
        width: 50px !important;
    }

    .timecost.col-md-3 .col-2 .numberofday .k-numerictextbox .k-input {
        width: 41px !important;
    }

    .timecost.col-md-3 .col-3 {
        width: 98px !important;
        padding: 0 !important;
    }

    .timecost.col-md-3 .col-4 {
        padding: 0 !important;
        text-align: right;
    }

    .timecost.col-md-3 .col-4-1 {
        padding: 0 !important;
        padding-left: 3px !important;
    }

    .timecost.col-md-3 .col-4-2 {
        margin-left: 17px !important;
        padding: 0 !important;
    }

    .masteritem {
    }

    .masteritem .k-numerictextbox .k-input {
        width: 68px;
    }

    .w-93per { width: 93% !important; }
    .masternotify {
        color: red;
        position: absolute;
        z-index: 10;
        left: 5px;
        top: 22px;
        font-size: 25px;
    }
    .temp-button { margin-top: 0 !important; }
    .temp-place { margin-bottom: 10px; }
    .temp-place span { border-color: #38baf8 !important; }
    .temp-place .k-dropdown {
        background-color: #38baf8;
        border-radius: 3px;
        width: 190px;
    }
    .temp-place .k-dropdown-wrap {
        background-color: #38baf8;
        border-radius: 3px;
    }
    .temp-place .k-state-hover { color: white !important; }
    .temp-place .k-input {
        background-color: #38baf8;
        color: white !important;
    }

    .temp-place .k-select { background-color: #38baf8; }
    .reset-colmd { margin: 0; padding: 0; }
    .st-activities-col {
        width: 90%;
        padding-left: 15px;
        padding-right: 15px;
    }

    .cv-100 {
        width: 100% !important;
        float: left;
    }

    .cv-50 {
        width: 50% !important;
        float: left;
    }

    .cv-25 {
        width: 25% !important;
        float: left;
    }

    .cv-label {
        overflow: hidden;
        word-break: break-all;
        height: 17px;
    }

    #fEditAction .modal-textarea {
        min-height: 70px;
        display: inline-block;
        width: 91%;
        max-height: 155px;
    }

    #fEditAction .modal-textarea-autosize {
        display: inline-block;
        max-height: 70px;
    }

    .todo-col3 .k-multiselect-wrap .k-input {
        border: 0 !important;
        background-color: #fff !important;
    }
    /*fix todo responsibility style*/
    .todo-col3 .k-multiselect .k-button {
        color: #2e2e2e;
        border-color: #fafafa;
        background-color: #fafafa;
        border-radius: 30px;
    }

    #popEditAction div.ms-modal-body { overflow-y: scroll; }

    #div.k-animation-container div.k-notification-wrap {
        padding-top: 4px !important;
    }

    div.k-animation-container div.k-notification-wrap span.k-i-close {
        display: none;
    }

    div.k-animation-container div.k-notification-wrap .k-i-note {
        display: none;
    }

    div.k-animation-container div.k-notification-wrap .k-icon.k-i-info {
        margin-top: -4px;
    }

    .k-widget.k-notification.k-notification-info {
        background-color: #38baf8;
        border-color: #38baf8;
    }

    div#hoand-k-notification-8290 {
        display: inline-block;
        padding-left: 3px;
    }

    .dropdown-main-mastergoal-color { color: black; }

    .form-group.divtag > div.k-multiselect.k-widget > div.k-multiselect-wrap > ul.k-reset > li.k-button {
        overflow-x: hidden
    }

    .form-group.divtag > div.k-multiselect.k-widget > div.k-multiselect-wrap > ul.k-reset > li.k-button > span:last-child {
        background-color: #fafafa
    }

    .dnbTextAreaEditor {
        margin-top: -5px;
        margin-right: -3px;
        margin-left: -3px;
    }

    .dnbTextAreaEditor > table.k-editor {
        border: none;
        background-color: transparent;
    }

    .dnbTextAreaEditor > table.k-editor .k-editable-area { border-color: #E7E7E7; }
    .dnbTextAreaEditor td.k-editor-toolbar-wrap { height: 0 }
    .dnb-parent-pin-editor-form .k-colorpicker .k-select {
        display: block;
        opacity: 0
    }

    .dnb-flex { display: flex; }

    .icon-zoom {
        background-position: -180px -662px;
        cursor: pointer;
        width: 22px !important;
        height: 20px !important;
    }

    .dnb-popup-temp .k-editor-toolbar-wrap .k-selected-color {
        height: 3px !important
    }

    .title-oneline {
        max-width: 563px;
        overflow: hidden;
        max-height: 17px;
    }

    .dnbTextEditorViewRole { position: relative }

    .dnbTextEditorViewRole:after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        display: block;
        width: 100%;
        height: 100%;
        opacity: 0
    }

    .lblSubjetThema {
        margin-bottom: 5px;
        max-width: 210px;
        max-height: 17px;
        overflow: hidden;
    }

    .titleActionField {
        max-width: 427px;
        max-height: 17px;
        overflow: hidden;
    }

    .col-md-6.noPaddingRight.truecost .col-md-6.noPaddingLeft.noPaddingRight .form-group.has-currency.action-cost .k-numeric-wrap.k-state-default.k-expand-padding > input,
    .col-md-6.noPaddingRight.truecost .col-md-6.noPaddingLeft.noPaddingRight .form-group.has-currency.action-cost .k-numeric-wrap.k-state-default.k-expand-padding.k-state-focused > input {
        padding-right: 19px !important;
    }

    .positionWhenHoverBtnAddActioncost {
        position: relative !important;
    }

    .k-coloreditor-header.k-hstack { display: none; }
    #dnbMultipleAdvertiser_taglist > li > span {word-break: break-word;}
    #tablecost .row.row-cost:not([style*="display: none;"]):last-child .btnaddcost {
        display: inline-block
    }
</style>
<div id="loading-editaction" class="loading"></div>
<div id="popActionFibu"></div>
<div id="popSelectAction"></div>
<div id="popadvertiser"></div>
<div id="area-edit-action" class="pop-wrapper">
    <div id="pop-Reminder"></div>

    <div class="modal-body ms-modal-body">
        <form id="fEditAction">

            <div class="row" style="margin-left: 0; margin-right: 12px; margin-top: 0; margin-bottom: 10px; display: inline-block;float: left;" data-bind="invisible: isDisordered">
                <div class="pull-left temp-place" id="btemplate">
                    <button type="button" class="ms-button pull-left temp-button" data-bind="events:{ click: saveTemplate}, visible: isSaveTemplate, disabled: roleEdit" id="btnAddTemplate">
                        <span class="icon-20 icon-left-block plus-status"></span>
                        <span id="lblAddTemplate">Add template</span>
                    </button>

                    <input data-option-label="{Name: kLg.btnSelectTemp}"
                           data-role="dropdownlist"
                           data-auto-bind="false"
                           data-value-primitive="false"
                           data-text-field="Name"
                           data-value-field="Id"
                           class="pull-left" data-bind="value: templateId, source: templateSource, disabled: roleEdit, events: {change: selectTemplate}, enabled: isActiveTemp" id="dropTemp" />

                    <button id="btnDeleteTemplate" type="button" class="ms-left-button temp-button" data-bind="events:{ click: deleteTemplate}, disabled: roleEdit ">
                        <span class="icon-20 icon-bin-sub icon-left-block margin-right6"></span>
                        <span id="lblDeleteTemplate">Delete template</span>
                    </button>
                </div>
            </div>
            <div style=" float: right;">
                <a style="margin-bottom: 20px" role="button" href="javascript:vmGoalAction.showPopupGoalActionEval(3);" class="pull-left rpkpi buttonkpi ShowtooltipiconevaluationAction">
                    <span role="presentation" class="font-focus styleiconkpi"></span>
                    <!--<span id="lblEvaluationicon" class="textkpi">Bewertung</span>-->
                </a>

                <a style=" padding-right: 6px;" role="button" class=" pull-left styleiconassigfile showicontooltipAssignedAction" tabindex="2"
                   data-bind="visible: IsFileAssignedRole, attr: { href: fileAssignHref}">
                    <span id="iconEmpty" role="presentation" class="icon-16 icon-file iconassigfilestyle"></span>
                    <!--<span id="lblFileAssignedicon" style="color: white; ">Zugeordnete Dateien</span>-->
                </a>
            </div>
            <div class="row" style="margin-left: 0; margin-right: 0; margin-top: 0; margin-bottom: 10px;">
                <div class="col-md-12" style="margin-bottom: 10px; margin-left: 0; margin-right: 0; padding: 0;">
                    <label class="modal-label" id="lblName">Name</label>
                    <div class="clear"></div>
                    <input id="txtName" name="txtName" data-placement="bottom"
                           class="modal-input col-md-12 txtInput" type="text"
                           data-value-update="keyup" maxlength="130"
                           onkeypress=" vmEditAction.activeModelChange() "
                           data-bind="value: action.Name, disabled: roleEdit"
                           style="width: 96%;min-width:908px;">

                    <div style="float: right">
                        <input id="picker" class="pointer" name="picker" data-bind="value:action.Color, disabled: roleEdit" type="color" style="height: 30px; width: 30px;" />
                    </div>
                </div>
            </div>

            <div class="clear"></div>

            <!-- connection -->
            <div style="width: 100%;">
                <div class="cv-50" data-bind="visible: customViewOption.HasMasterBudget">
                    <label class="modal-label master-goal-label pull-left" id="lblMasterGoal">#:kLg.textMasterbudget#</label>
                    <div class="clear"></div>
                    <div id="masterdata" data-bind="source: action.MasterBudgets" data-template="masterbudget">
                    </div>
                </div>

                <div class="cv-50" data-bind="visible: customViewOption.HasRegion" style="width: 49% !important;">
                    <label class="modal-label master-goal-label pull-left" id="lblRegion"></label>
                    <div class="clear"></div>

                    <div style="min-height: 18px;" data-bind="visible: isVisibleSelectedRegion">
                        <div class="pull-left" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: labeRegionSrc" data-template="selectedregion" class="ulsub"></ul>
                        </div>
                    </div>
                    <input id="txtAutoRegion" class="auto-stream"
                           data-role="autocomplete"
                           data-text-field="Name"
                           data-value-field="ObjectId"
                           data-filter="contains"
                           data-bind="value: autoRegionValue, source: autoRegionSrc, events:{ select: selectRegionGroup, change: changeRegionGroup }, enabled: isSyncSelectable" />

                    <div class="ms-dropdow" style="right: 5px;">
                        <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit, events:{click: openSelectRegion}, visible:isHasKpi"></span>
                    </div>

                </div>
            </div>
            <div class="clear"></div>

            <!-- sub product group -->
            <div id="subpanel" class="row" style="margin-bottom: 10px;">
                <div class="col-md-6" data-bind="visible: customViewOption.HasProduct" style="padding: 0 10px 0 0;">
                    <div class="form-group divtag">
                        <label id="lblSubProductGroup" class="titleActionField">Abc xyz</label>
                        <div class="clear"></div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedSub" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: displaySrc" data-template="selectedsub" class="ulsub"></ul>
                        </div>
                        <input id="txtSubPg" class="auto-stream"
                               data-role="autocomplete"
                               data-text-field="Name"
                               data-value-field="ObjectId"
                               data-filter="contains"
                               data-bind="value: autoSubValue, source: autoSubSrc, events:{ select: selectSubProductGroup, change: changeSubProductGroup }, enabled: isSyncSelectable" />

                        <div class="ms-dropdow" style="right: 5px;">
                            <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit, events:{click: openSubProduct}, visible:isHasKpi"></span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6" data-bind="visible: customViewOption.HasMarket" style="padding: 0;">
                    <div class="form-group divtag">
                        <label id="lblSubClientGroup" class="titleActionField"
                               style="max-width:460px;overflow:hidden;">Abc xyz</label>
                        <div class="clear"></div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedClient" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: displayClientSrc" data-template="selectedclient" class="ulsub"></ul>
                        </div>

                        <input id="txtSubClient" class="auto-stream"
                               data-role="autocomplete"
                               data-text-field="Name"
                               data-value-field="ObjectId"
                               data-filter="contains"
                               data-bind="value: autoClientValue, source: autoClientSrc, events:{ select: selectSubClientGroup, change: changeSubClientGroup }, enabled: isSyncSelectable" />

                        <div class="ms-dropdow" style="right: 5px;">
                            <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit, events:{click: openSubClient}, visible:isHasKpi"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clear"></div>

            <!-- CUSTOMER JOURNEY -->
            <div style="width: 100%;">
                <div class="cv-50" data-bind="visible: customViewOption.HasCustomerJourney" style="width: 49% !important;">
                    <label class="modal-label master-goal-label pull-left title-oneline titleActionField" id="lblCustomerJourney">Customer Journey</label>
                    <div class="clear"></div>

                    <div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedCus" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: displayCusSrc" data-template="selectedcus" class="ulsub"></ul>
                        </div>
                    </div>
                    <input id="txtAutoCustomerJourney" class="auto-stream"
                           data-role="autocomplete"
                           data-text-field="Name"
                           data-value-field="ObjectId"
                           data-filter="contains"
                           data-bind="value: autoCusValue, source: autoCusSrc, events:{ select: selectCusGroup, change: changeCusGroup }, disabled: roleEdit" />

                    <div class="ms-dropdow" style="right: 5px;">
                        <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit, events:{click: openSelectCus}"></span>
                    </div>

                </div>
            </div>
            <div class="clear"></div>

            <hr class="modal-mass-hr">

            <div class="cv-50" data-bind="visible: customViewOption.HasDescription"
                 style="padding-right:9px;box-sizing:border-box">
                <div class="form-group" style="padding-right:16px">
                    <div class="dnb-flex" style="justify-content: space-between;">
                        <label id="lblDescription" class="cv-label" data-bind="text: customViewOption.LabelDescription">Beschreibung</label>
                        <div class="icon-32 icon-zoom" data-id="txt-area-description"
                             onclick="vmCommon.TexEditor.addWindowEditor(this)"> </div>
                    </div>
                    <div class="clear"></div>
                    <div class="dnbTextAreaEditor">
                        <textarea rows="1" id="txt-area-description"
                                  class="modal-textarea"
                                  data-role="editor" data-tools="[]"
                                  data-bind="value: action.Description,
                                            disabled: roleEdit,
                                            events: {
                                                select: togglePlaceholderKendoEditor,
                                                keyup: onKeyUpChangeValKendoEditor,
                                                keydown: onKeyDownChangeValKendoEditor,
                                                paste: onPasteValKendoEditor
                                            }">
                         </textarea>
                    </div>
                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasExpectedEffect"
                 style="padding-right:9px;box-sizing:border-box;">
                <div class="form-group">
                    <div class="dnb-flex" style="justify-content: space-between;">
                        <div class="dnb-flex">
                            <label id="lblExpectedEffect" class="cv-label">Expected result</label>
                            <div style="margin-left: 3px;">
                                <span class="icon-20 icon-kpi-goal-small pointer"
                                      data-bind="visible: isHasKpi, events:{click: openKpiIndexTime}"
                                      style="margin-top: -1px;"></span>
                            </div>
                        </div>
                        <div class="icon-32 icon-zoom" data-id="txt-area-expectedeffect"
                             onclick="vmCommon.TexEditor.addWindowEditor(this)">
                        </div>
                    </div>
                    <div class="clear"></div>
                    <div class="dnbTextAreaEditor">
                        <textarea rows="1" id="txt-area-expectedeffect"
                                  class="modal-textarea"
                                  data-role="editor" data-tools="[]"
                                  data-bind="value: action.ExpectedEffect,
                                            disabled: roleEdit,
                                            events: {
                                                select: togglePlaceholderKendoEditor,
                                                keyup: onKeyUpChangeValKendoEditor,
                                                keydown: onKeyDownChangeValKendoEditor,
                                                paste: onPasteValKendoEditor
                                            }">
                         </textarea>
                    </div>
                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasResponsibility"
                 style="box-sizing:border-box;padding-right:20px">
                <div class="form-group divtag">
                    <label id="lblPerson">Verantwortung</label>
                    <div class="clear"></div>

                    <select data-role="multiselect"
                            data-placeholder=""
                            data-filter="contains"
                            data-text-field="Name"
                            data-value-field="AccountId"
                            data-bind="source: listPerson, value: action.People, disabled: roleEdit,
                                events: { change: autoChangePeople, filtering: multiSelectFiltering}"
                            id="ddlResponsibility">
                    </select>
                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasActualEffect">
                <div class="form-group" style="padding-right:15px">
                    <div class="dnb-flex" style="justify-content: space-between;">
                        <div class="dnb-flex">
                            <label id="lblActualEffect" class="cv-label">Actual result</label>
                            <div style="margin-left: 3px;">
                                <span class="icon-20 icon-kpi-goal-small pointer"
                                      data-bind="visible: isHasKpi, events:{click: openKpiIndexTime}"
                                      style="margin-top: -1px;"></span>
                            </div>
                        </div>
                        <div class="icon-32 icon-zoom" data-id="txt-area-actualeffect"
                             onclick="vmCommon.TexEditor.addWindowEditor(this)">
                        </div>
                    </div>
                    <div class="clear"></div>
                    <div class="dnbTextAreaEditor">
                        <textarea rows="1" id="txt-area-actualeffect"
                                  class="modal-textarea"
                                  data-role="editor" data-tools="[]"
                                  data-bind="value: action.ActualEffect,
                                            disabled: roleEdit,
                                            events: {
                                                select: togglePlaceholderKendoEditor,
                                                keyup: onKeyUpChangeValKendoEditor,
                                                keydown: onKeyDownChangeValKendoEditor,
                                                paste: onPasteValKendoEditor
                                            }">
                         </textarea>
                    </div>
                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasInvolvedPeople">
                <div class="form-group divtag">
                    <label id="lblPersonInvolved">Other involved people</label>
                    <div class="clear"></div>

                    <select data-role="multiselect"
                            data-placeholder=""
                            data-filter="contains"
                            data-text-field="Name"
                            data-value-field="AccountId"
                            data-bind="source: listPersonInvolved, value: action.PeopleInvolved, disabled: roleEdit,
                                events: { change: autoChangePeopleInvolved, filtering: multiSelectFiltering}"
                            id="ddlResponsibility2"></select>

                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasCategory">
                <div class="form-group divtag">
                    <label id="lblCategory" class="title-oneline">Kategorie</label>
                    <div class="clear"></div>
                    <select data-role="multiselect"
                            data-placeholder=""
                            data-filter="contains"
                            data-text-field="Name"
                            data-value-field="Id"
                            data-bind="source: listActionCategory,
                                events:{filtering: multiSelectFiltering},
                                value: action.Categories, disabled: roleEdit">
                    </select>
                </div>
            </div>

            <div class="cv-50" data-bind="visible: customViewOption.HasField">
                <div class="form-group divtag">
                    <label id="lblField" style="max-width:90%;" class="cv-label pull-left title-oneline">Field</label>
                    <div class="clear"></div>
                    <select data-role="multiselect"
                            data-placeholder=""
                            data-filter="contains"
                            data-text-field="Name"
                            data-value-field="Id"
                            data-bind="source: listActionField,
                                events:{filtering: multiSelectFiltering},
                                value: action.Fields, disabled: roleEdit">
                    </select>
                </div>
            </div>
            <div class="clear"></div>
            <div>
                <div class="cv-25">
                    <div class="form-group">
                        <label id="lblInstrument" class="lblInstrument pull-left title-oneline" style="margin-bottom: 5px;max-width: 200px;">Instrument</label>
                        <div class="pull-left">
                            <span class="icon-20 icon-kpi-goal-small pointer" style="margin-left: 3px;margin-top: 0;"
                                  data-bind="events:{click: openKpiIndexTime}, visible: isHasKpiSecond">
                            </span>
                        </div>
                        <div class="clear"></div>
                        <select style="width: 200px;"
                                data-role="dropdownlist" data-filter="contains"
                                data-text-field="Name"
                                data-value-field="Id"
                                data-bind="source: listActionInstrument,
                                           value: action.Instrument, disabled: roleEdit,
                                           events:{select: selectInstrument, filtering: filteringInInstrument}">
                        </select>
                    </div>
                </div>

                <div class="cv-25" data-bind="visible: customViewOption.HasAdvertising">
                    <div class="form-group">
                        <label id="lblAdvertisingMaterial" style="max-width:200px;" class="cv-label lblAdvertising pull-left title-oneline">AdvertisingMaterial</label>
                        <div class="clear"></div>

                        <select id="ddlAdvertising"
                                style="width: 200px;"
                                data-role="dropdownlist" data-filter="contains"
                                data-option-label=" "
                                data-auto-bind="false"
                                data-value-primitive="true"
                                data-text-field="Name"
                                data-value-field="Id"
                                data-bind="source: listActAdvertisingMaterial,
                                    value: action.AdvertisingMaterial, disabled: roleEdit,
                                    events:{change: changeAdvertising, select: selectAdvertising,
                                            filtering: filteringInAdvertising}"></select>

                    </div>
                </div>
                <style>
                    input[class*="col-"], span[class*="col-"] { float: left }
                    #dnbMultipleAdvertiser_taglist + input { background: transparent !important; border: none !important; }
                    #dnbMultipleAdvertiser_taglist > li { background: transparent; border: none; text-align:left;}
                </style>
                <div class="cv-25" data-bind="visible: customViewOption.HasAdvertiser">
                    <div class="form-group">
                        <div>
                            <label id="lblAdvertiser" style="max-width:80%;" class="cv-label lblAdvertiser pull-left">Advertiser</label>
                            <span class="icon-20 icon-kpi-blue-small pointer" style="margin-left: 3px;" 
                                  data-bind="events:{click: openKpiIndex}, visible: isVisibleKpi"></span>
                            <span class="icon-20 icon-kpi-goal-small pointer" style="margin-left: 3px;"
                                  data-bind="visible: isMultipleAdvertiserShow, events:{click: openKpiIndexTime}"></span>
                        </div>
                        <div class="clear"></div>
                        <div>
                            <input class="auto-stream" style="width: 200px;float: left;"
                                   data-role="autocomplete" data-filter="contains"
                                   data-text-field="Name" data-value-field="Id"
                                   data-bind="value: action.AdvertiserName, source: listActAdvertiser,
                                        invisible: isMultipleAdvertiser,
                                        events:{ select: selectAdvertiser, change: changeAdvertiser }, disabled: roleEdit" />
                            <select id="dnbMultipleAdvertiser" class="auto-stream" style="width: 200px;float: left;"
                                    data-role="multiselect" data-placeholder="" data-filter="contains"
                                    data-text-field="Name" data-value-field="Id"
                                    data-bind="value: action.ActionAdvertisers, source: listActAdvertiser,
                                        visible: isMultipleAdvertiser,
                                        events:{ filtering: multiSelectFiltering, change: onChangeMultipleAdvertiser }, disabled: roleEdit" ></select>
                            <span class="icon-24 icon-right-block iconright-modal-mass selectAdvertiser pointer" data-bind="disabled: roleEdit, events:{click: openSelectAdvertiser}"></span>
                        </div>
                    </div>
                </div>

                <div class="cv-25" data-bind="visible: customViewOption.HasSubjectThema">
                    <div class="form-group">
                        <label id="lblSubjetThema" class="lblSubjetThema">Subjet\Thema</label>
                        <div class="clear"></div>
                        <input class="col-md-8 txtInput"
                               id="acSubjetThema"
                               style="width: 170px;"
                               maxlength="100"
                               data-placeholder=" "
                               data-role="autocomplete"
                               data-text-field="Name"
                               data-value-field="Id"
                               data-filter="contains"
                               data-bind="value: subjetThemaName, source: listSubjetThemas, events: {select: selectSubjetThema}, disabled: roleEdit" />
                        <span class="icon-32 icon-add col-md-4 margin-left10 pointer" style="margin-top: -1px !important; width: 0px;" data-bind="events: {click: addCatSubjetThema}"></span>
                    </div>
                </div>
            </div>

            <!-- action cost -->

            <div class="clear"></div>
            <div class="row" style="margin-left: 0; margin-right: 0; margin-top: 10px;">
                <style>
                    #popEditAction div[class*="col-"] {
                        float: left
                    }

                    .col-md-3 {
                        width: 25%
                    }

                    .col-md-4 {
                        width: 33.33333333%
                    }

                    .col-md-5 {
                        width: 41.66666667%
                    }

                    .col-md-8 {
                        width: 66.66666667%
                    }
                </style>
                <div class="col-md-5 hidden descost">
                    <div class="col-md-8 reset-colmd"><label style="max-width: 350px; white-space: pre; overflow: hidden; text-overflow: ellipsis;"
                                                             data-bind="text: customViewOption.LabelActivity">Activity</label></div>
                    <div class="col-md-4 reset-colmd"><label id="lblCostKategorie" class="title-oneline"
                                                             style="margin-left: 15px;max-width: 162px">Kategorie</label></div>
                </div>
                <div class="col-md-6 goal-modal-first-col timecost">
                    <div class="row">
                        <div class="col-md-6 col-1" style="width: 120px; padding-right: 0px;">
                            <div class="">
                                <label id="lblDateStart">Start</label>
                            </div>
                        </div>

                        <div class="col-md-6 col-2" style="width: 97px; padding-right: 10px;">
                            <div class="">
                                <label id="lblNumberOfDay">NumberOfDay</label>
                            </div>
                        </div>

                        <div class="col-md-6 col-3" style="width: 155px; padding-left: 10px;">
                            <div class="">
                                <label id="lblDateEnd">End</label>
                            </div>
                        </div>
                        <div class="col-md-6 col-4" style="width: 42px; padding-left: 5px;">
                            <div class="">
                                <label id="lblFinish">Finish</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 noPaddingRight truecost" style="padding-left: 10px;">
                    <div class="col-md-6 noPaddingLeft noPaddingRight" style="width: 47%;">
                        <div class="" style="padding-bottom: 2px;">
                            <label id="lblExpectedCost" style="margin-bottom: 0">Expected cost</label>
                            <br />
                            <span data-bind="text: totalExpectedCost, visible: enableRemoveCost" class="total-cost" style="margin-left: 0"></span>
                        </div>
                    </div>

                    <div class="col-md-6 noPaddingLeft noPaddingRight ">
                        <div class="" style="padding-bottom: 2px;">
                            <label id="lblActualCost" style="margin-bottom: 0">Actual cost</label>
                            <br />
                            <span data-bind="text: totalActualCost, visible: enableRemoveCost" class="total-cost" style="margin-left: 0"></span>
                        </div>
                    </div>
                </div>

            </div>
            <div data-template="actioncost" data-bind="source: action.ActionCosts" class="table-cost" id="tablecost">
            </div>

            <div class="clear"></div>
            <!--todo-col1-->
            <div class="row" style="margin-left: 0;margin-right: 0;margin-bottom: 0px;margin-top: 10px;" data-bind="visible: action.ActionTodos.length > 0">
                <div style="float: left; width: 40%;">
                    <label id="lblTodoDescription" 
                           style="float: left; width: 351px; margin-left: 15px; max-width: 351px; white-space: pre; overflow: hidden; text-overflow: ellipsis;" 
                           data-bind="text: customViewOption.LabelTodo">To Dos</label>
                    <label id="lblTodoKategorie" class="title-oneline" style="float: left; margin-left: 16px;max-width:116px">Kategorie</label>
                </div>
                <div>
                    <label id="lblField" style="margin-left: 10px; max-width: 90%; white-space: pre; width: 150px; overflow: hidden; text-overflow: ellipsis; float: left;" 
                           class="cv-label pull-left title-oneline">Field</label>
                </div>
                <div style="float: left; width: 19%;">
                    <label id="lblTodoDueDate" style="margin-left: -7px;" class="pull-left">Due Date</label>
                    <label id="lblTodoFinish" class="pull-right" style="margin-right: 5px;">Finish</label>
                </div>
                <div style="float: left; width: 36%;">
                    <label id="lblTodoRespon">Reponsibilities</label>
                </div>
            </div>
            <div class="clear"></div>
            <div data-template="actiontodos" data-bind="source: action.ActionTodos" class="table-cost" id="todostablecost">
            </div>

            <span id="btnaddtodo" class="icon-32 cursor-pointer icon-todosnew kgv-customtooltip"
                  data-bind="events:{click: addActionTodos, mouseover: showLblTooltipAdd}, 
                  attr: { data-content: customViewOption.LblTooltipTodo },
                  disabled: roleEdit, visible: hidenicontodo"
                  style="position: absolute; right: 16px;"></span>
            <div class="clear"></div>

            <div style="margin-top:50px" class="cv-50" data-bind="visible: customViewOption.HasUpStream">
                <div class="form-group">
                    <label id="lblUpStream">UpStream</label>
                    <div class="clear"></div>
                    <input id="txtUpStream" class="auto-stream"
                           data-placeholder="&nbsp;"
                           data-value-primitive="false"
                           data-role="autocomplete"
                           data-auto-bind="false"
                           data-text-field="Name"
                           data-value-field="Id"
                           data-filter="contains"
                           data-bind="value: actionSelectName, source: actionStream, events: { select: autoSelectStream, change: autoChangeStream}, disabled: isDisabledConStream" />

                    <div class="ms-dropdow" style="right:15px;">
                        <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit" onclick="showSelectAction()"></span>
                    </div>
                </div>
            </div>

            <div style="margin-top:60px" class="cv-50">
                <div class="col-md-6 goal-modal-first-col" data-bind="visible: customViewOption.HasResourcePlanning">
                    <div class="checkbox" style="padding-left: 0px; padding-top: 6px;">
                        <label>
                            <span class="checkbox-inline" style="padding-left:0">
                                <label>
                                    <span id="lblEP">EP</span>
                                    <input type="checkbox"
                                           id="cbPlan"
                                           data-bind="checked: action.IsCalendar, disabled: roleEdit" />
                                    <span class="checkmarkd"></span>
                                </label>
                            </span>

                        </label>
                    </div>

                </div>
                <div class="col-md-6 noPaddingRight noPaddingLeft" data-bind="visible: customViewOption.HasVisibility">
                    <div class="checkbox" style="padding-left: 0px; padding-top: 6px;">
                        <label>
                            <span class="checkbox-inline" style="padding-left: 0px;">
                                <label>
                                    <span id="lblVisibility">Visibility</span>
                                    <input type="checkbox"
                                           id="cbVisibility"
                                           data-bind="checked: action.Visibility, disabled: roleEdit, events : { change: onChangeVisibility }" />
                                    <span class="checkmarkd"></span>
                                </label>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- stream, bla..bla --><!--khanh-->
            <div class="row" style="margin-left: 0; margin-right: 0">

            </div>

            <!-- ap connection -->
            <div class="row" style="margin-left: 0; margin-right: 0;margin-bottom: 12px;" data-bind="visible: hasLink, invisible: isDisordered">
                <label id="lblApConnection">Action plan connections</label><br />
                <span class="icon-32 cursor-pointer icon-add" data-bind="events: {click : addLink }, visible: action.Visibility"></span>
                <table class="tbgrid modal-table modal-mass-tb-status" style="margin-top: 6px;">
                    <tbody data-template="temp-link" data-bind="source: action.Links"></tbody>
                </table>
                <div></div>

                <script id="temp-kpiinfo" type="text/x-kendo-template">
                    <span class="icon-20 #:vmCommon.getGaIcon(LinkTypeId, IsMasterLink)# pull-left"></span>
                    <div style="min-height: 22px;width: 65px;float:right;">
                        # var kovArrow = KpiInfo.Trend == 1 ? 'kpi-overview-up' : (KpiInfo.Trend == 2 ? 'kpi-overview-equal' : (KpiInfo.Trend == 3 ? 'kpi-overview-down' : ''));#
                        #if (ApEvaluation != null){#
                        <div class="pull-left kpi-overview kpi-overview-goal #:kovArrow# #:ChoseColorPercent(ApEvaluation)#">
                            <span style="margin-top:1px;max-width:70px;width:100%;text-align: center;" title="#:ApEvaluation#">#:ApEvaluation#</span>
                        </div>
                        #}else if (KpiInfo.IsShow){#
                        #var kovBg = KpiInfo.Percent < 70.51 ? 'kpi-overview-bgdown' : (KpiInfo.Percent < 99.5 ? 'kpi-overview-bgequal' : 'kpi-overview-bgup');#
                        #var classMsaKpiBg = 'msa-kpi-bg';#
                        #if(KpiInfo.Percent <= 60) { classMsaKpiBg += '60'; } else if(KpiInfo.Percent <= 80) { classMsaKpiBg += '60-80'; } else { classMsaKpiBg += '80'; }#

                        <div class="pull-left kpi-overview #:kovArrow# #:kovBg# #:classMsaKpiBg#">
                            <span class="xnxx"></span>
                            <span style="margin-top: 2px;padding: 0 4px 0 4px;" title="#:KpiInfo.PercentStr#%">#:KpiInfo.PercentStr#%</span>
                        </div>
                        #}else if (TodoPercent != null){#
                        #var classMsaKpiBg = 'msa-kpi-bg';#
                        #if(TodoPercent <= 60) { classMsaKpiBg += '60'; } else if(TodoPercent <= 80) { classMsaKpiBg += '60-80'; } else { classMsaKpiBg += '80'; }#
                        <div class="pull-left kpi-overview #:classMsaKpiBg#">
                            <span class="xnxx"></span>
                            <span style="margin-top: 2px;padding: 0 4px 0 4px;" title="#:TodoPercent#%">#:Math.round(TodoPercent, 2)#%</span>
                        </div>
                        #}#
                    </div>
                </script>

                <script id="temp-link" type="text/x-kendo-template">
                    <tr data-bind="visible: IsShow">
                        <td width="54%">
                            <div class="file-sub" style="max-width: 470px;overflow: hidden;">
                                <span class="goalactionpath" data-bind="{ text: Path }"></span>
                            </div>
                        </td>
                        <td width="35%">
                            <div class="file-sub" style="max-width: 300px;overflow: hidden;">
                                <span class="linkname" data-bind="{ text: LinkName, events : { dblclick: openGoalAction } }"></span>
                            </div>
                        </td>
                        <td width="8%" style="padding: 3px;border-right: none;">
                            <div style="width: 100%;">
                                <div class="kpiinfo" id="link-#:LinkId#-#:Id#" style="display: flex;margin-top: 2px;float: left;">
                                    #=vmCommon.bindingContent("temp-kpiinfo", data)#
                                </div>
                            </div>
                        </td>
                        <td width="3%" style="padding: 5px;border-left: none;">
                            <div class="ms-dropdow" style="float:right;" data-bind="disabled: roleEdit, invisible: IsMasterLink">
                                <div class="icon-24 iconright-modal-mass margin-right6 pointer" data-toggle="dropdown" style="width: 23px; height: 23px;"></div>
                                #if(vmGoalAction.actionOptions.role > 0){#
                                #var pad = kLg.language == 'de' ? -226: -169;#
                                <ul aria-labelledby="btnGroupVerticalDrop1" class="popup-menu dropdown-menu ms-popup-menu posAbsolute" role="menu" style="left:#:pad#px;">
                                    #if (RoleId > 0){#
                                    <li data-bind="events: {click : editLink }">
                                        <a class="dropdow-menu-li-a">
                                            <span class="icon-24 icon-left-block icon-edit"></span><span>#:kLg.lblEditApConnection#</span>
                                        </a>
                                    </li>
                                    <li role="presentation" class="divider"></li>
                                    #}#
                                    <li data-bind="events: {click : addLinkBeLow }">
                                        <a class="dropdow-menu-li-a">
                                            <span class="icon-24 icon-left-block icon-add-region"></span><span>#:kLg.lblAddApConnection#</span>
                                        </a>
                                    </li>
                                    #if (RoleId > 0){#
                                    <li role="presentation" class="divider"></li>
                                    <li data-bind="events: {click : deleteLink }">
                                        <a class="dropdow-menu-li-a">
                                            <span class="icon-24 icon-left-block icon-delete"></span><span>#:kLg.lblDeleteApConnection#</span>
                                        </a>
                                    </li>
                                    #}#
                                </ul>
                                #}#
                            </div>
                        </td>
                    </tr>
                </script>
            </div>

            <label class="popup-lable" id="lblStatusProtocol" style="margin-top: 20px;">Statusprotokoll</label>
            <div id="tableEditAction">
                <table id="gridStatusProtocol" class="tbgrid modal-table modal-mass-tb-status">
                    <thead>
                        <tr>
                            <th class="title bg-grey" width="160px" id="lblDateStatus">Datum</th>
                            <th class="title bg-grey" width="160px" id="lblStatus">Status</th>
                            <th class="title bg-grey" width="450px" id="lblComment">Bemerkung</th>
                            <th class="title bg-grey" width="48px"></th>
                        </tr>
                    </thead>
                    <tbody data-template="temp-status" data-bind="source: action.Status"></tbody>
                </table>

                <script id="temp-status" type="text/x-kendo-template">
                    <tr data-bind="visible: IsOrigin">
                        <td>
                            <div class="input-append date form_datetime1">
                                <input data-role="datepicker" data-bind="value: Date, disabled: roleEdit" maxlength="10" onblur="vmEditAction.checkDate(this)" />
                            </div>
                        </td>
                        <td>
                            <label class="ms-select-lable">
                                <select data-role="dropdownlist" data-filter="contains"
                                        data-text-field="Name" data-value-field="Id"
                                        data-bind="source: listProtocolStatus,
                                            events:{filtering: dropdownListFiltering},
                                            value: StatusId, disabled: roleEdit"></select>
                            </label>
                        </td>
                        <td>
                            # var randomId = "dnbStatusEditor_" + Id; #
                            <div>
                                <div class="dnb-flex" style="justify-content: flex-end;padding-top:5px;">
                                    <div class="icon-32 icon-zoom" data-id="#:randomId#"
                                         onclick="vmCommon.TexEditor.addWindowEditor(this)">
                                    </div>
                                </div>
                                <div class="dnbTextAreaEditor">
                                    <textarea rows="1" id="#:randomId#"
                                              class="modal-textarea-autosize w-95per dnbStatusKendoEditor"
                                              data-role="editor" data-tools="[]"
                                              data-bind="value: Description,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                     </textarea>
                                </div>
                            </div>
                        </td>
                        <td class="td-bin td-v-align-middle"><span data-bind="events:{ click: delStatus}" class="icon-32  icon-bin"></span></td>
                    </tr>
                </script>
            </div>
            <div class="modal-mass-iconplus">
                <button data-bind="events:{ click: addStatus}" type="button" class="ms-button">
                    <span class="icon-16  icon-right-block  icon-plus plus-status"></span>
                    <span id="lblAddStatus">Add status</span>
                </button>
            </div>
        </form>
    </div>
    <div class="modal-market-footer">
        <button id="btnUpdate" type="button" class="ms-button" data-bind="events: {click: update}">
            <span class="icon-20 icon-close"></span>
            <span id="lblClose">Close</span>
        </button>
        <span class="pull-right foot-last-change" data-bind="text: LastChange">Last change:</span>
    </div>
</div>

<script id="selectedregion" type="text/html">
    <li data-bind="attr:{oid: ObjectId, otype: TypeId}" rtype="3">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;">
            <span class="pull-left" data-bind="text: Name" style="margin-right: 3px;"></span>
            <input type="checkbox" class="pull-left" data-bind="checked: IsCheck, disabled: roleEdit, events:{change: onChangeRegionCheck}" style="margin-top: 3px;" />
        </div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer; zoom: 85%; margin-top: 3px;color:transparent;" data-bind="events:{click: removeRegion, invisible: roleEdit}">x</span>
    </li>
</script>

<script id="selectedsub" type="text/html">
    <li data-bind="attr:{ oid: ObjectId, otype: TypeId}" rtype="1">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;"><span style="">#:Name#</span></div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer; zoom: 85%; margin-top: 3px;color:transparent;" data-bind="events:{click: removeSubProduct}">x</span>
    </li>
</script>

<script id="selectedcus" type="text/html">
    <li data-bind="attr:{ oid: ObjectId, otype: TypeId}" rtype="1">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;"><span style="">#:Name#</span></div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer; zoom: 85%; margin-top: 3px;color:transparent;" data-bind="events:{click: removeCustomerJourney}">x</span>
    </li>
</script>

<script id="selectedclient" type="text/html">
    <li data-bind="attr:{oid: ObjectId, otype: TypeId}" rtype="2">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;">
            #if(OrganisationId){#
            <a style="text-decoration: underline;cursor: pointer;" data-bind="events:{click: redirectOrg}">#:Name#</a>
            #}else{#
            <span style="">#:Name#</span>
            #}#

        </div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer;zoom: 85%;margin-top: 3px;color:transparent;" data-bind="events:{click: removeSubClient}">x</span>
    </li>
</script>

<script id="subchild" type="text/html">
    <ul class="ulpop">
        #for(var i = 0; i < data.length; i++){#
        <li>
            <span>#:data[i].Name#</span>
        </li>
        #}#
    </ul>
</script>

<script id="actiontodos" type="text/x-kendo-template">
    <div class="row todos" style="margin-left: 0; margin-right: 0; margin-bottom: 0px; position: relative;">
        <span class="icon-16 icon-arow-towway-vertical"></span>
        <div class="todo-col1 pull-left" style="width: 40%; overflow: hidden;">
            <div class="todo-name pull-left" style="width: 150px; margin-bottom: 10px;">
                # var textValue = Name || ' ' ; #
                # var fixHeight = vmCommon.getHeightTextAreaFlex(textValue, 25); #
                <textarea type="text" rows="1"
                          class="w-98per modal-textarea-autosize"
                          style="height: #:fixHeight#"
                          data-bind="value: Name, disabled: roleEdit, events: {keyup: autoSizeX}" onkeypress="vmEditAction.activeModelChange()" />
            </div>
            <div class="pull-left">

                <select style="width: 118px; margin-left: 19px;"
                        data-role="dropdownlist" data-filter="contains"
                        data-option-label=" "
                        data-auto-bind="false"
                        data-value-primitive="true"
                        data-text-field="Name"
                        data-value-field="Id"
                        data-bind="source: listActionCategory,
                            events:{filtering: dropdownListFiltering},
                            value: CategoryId, disabled: roleEdit">
                </select>
            </div>
        </div>

        <div style="float: left;width: 16%; margin-left: -12px;">
            <div class="form-group divtag">
                <div class="clear department"  ></div>
                <select data-role="multiselect"
                        data-placeholder=""
                        data-filter="contains"
                        data-text-field="Name"
                        data-value-field="Id"
                        data-bind="source: listActionFieldDepartmentTodos,
                                events:{filtering: multiSelectFiltering},
                                value: ActionTodoDepartments, disabled: roleEdit">
                </select>
            </div>
        </div>
        <div class="todo-col2 pull-left" style="width: 19%;">
            <div class="pull-left xx1" style="width: 120px;">
                <div class="input-append date">
                    <input data-role="datepicker"
                           data-bind="value: DueDate, disabled: roleEdit, events: {change: changeTodoDueDate}"
                           name="todoDueDate" class="date-cost" />
                </div>
            </div>

            <div class="pull-left xx2" style="display: block; width: 15px; margin-left: 5px;" data-bind="click: setActionTodoOutlook, disabled: roleEdit">
                <div data-bind="click: setActionTodoOutlook">
                    <div class="icon-24 iconright-modal-mass margin-right6 pointer" data-toggle="dropdown" style="width: 23px; height: 23px;"></div>
                    <ul role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: auto; top: auto; bottom: auto;">
                        <li class="reminder" data-bind="click: openTodoReminder, visible: IsShowReminderX">
                            <a class="dropdow-menu-li-a a69" data-toggle="modal" data-target=".bs-example-modal-lg">
                                <span class="icon-24  icon-left-block icon-reminder"></span><span class="lblReminder" style="margin-left: 10px;">Erinnerung</span>
                            </a>
                        </li>
                        <li data-bind="visible: IsShowReminderX" role="presentation" class="divider icon-divider reminder"></li>
                        <li>
                            <a class="dropdow-menu-li-a a69 assignInfo" href="mailto:?Subject=" target="_top">
                                <span class="icon-24 icon-left-block icon-assigninfo"></span><span class="lblAssignInfo" style="margin-left: 10px;">Zuweisen / Info</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="pull-left xx3" style="width: 10px; margin-left: 20px; margin-top: 0px;">
                <!--<input type="checkbox" data-bind="checked: Finish, disabled: roleEdit, events:{change: changeTodoFinish}" />-->
                <span class="checkbox-inline" style="padding-left:0">
                <label>
                    <input type="checkbox" data-bind="checked: Finish, disabled: roleEdit, events:{change: changeTodoFinish}">
                         <span class="checkmarkd"></span>
                 </label>
                 </span>
            </div>

        </div>
        <div class="todo-col3 pull-left" style="width: 41%;">

            <div class="pull-left xx1" style="width: 79%; margin-bottom: 10px;" data-bind="attr: {todopersonid: Id,id: Id+'_ddlTodoResponsibility'}">
                <select data-role="multiselect"
                        data-placeholder=""
                        data-filter="contains"
                        data-text-field="PersonName"
                        data-value-field="PersonIdTmp"
                        data-bind="source: listTodoPersons, value: Persons, disabled: roleEdit,
                            events: {change: changeTodoResponsibility, filtering: multiSelectFiltering}">
                </select>
            </div>

            <div class="pull-left xx2" style="width: 22%;">
                <!--<span class="icon-32 icon-folder-circle pull-left" style="cursor: pointer; margin-left: 9px;"
                      data-bind="disabled: roleEdit, attr: {hasFile: Files.length > 0, fopenid: Id}, events: {click: openTodoFileAssign}"></span>-->
                <span class="icon-32 icon-folder-circle pull-left" style="cursor: pointer; margin-left: 9px;"
                      data-bind="attr: {hasFile: Files.length > 0, fopenid: Id}, events: {click: openTodoFileAssign}"></span>
                <span data-bind="events:{ click: removeActionTodos}" class="icon-32 icon-bin pull-right icondeletewhentodo" style="margin-right: 8px;"></span>
            </div>


        </div>
    </div>
</script>

<script id="actioncost" type="text/html">
    <div class="row row-cost" style="margin-left: 0; margin-right: 0;position: relative;" data-bind="visible: IsShow">
        <span class="icon-16 icon-arow-towway-vertical"></span>
        <div class="col-md-5 hidden descost">
            <div class="col-md-8 reset-colmd">
                # var textValue = Description || ' ' ; #
                # var fixHeight = vmCommon.getHeightTextAreaFlex(textValue, 25); #
                <textarea type="text" rows="1"
                          class="w-98per modal-textarea-autosize"
                          style="height: #:fixHeight#"
                          data-bind="value: Description, disabled: roleEdit, events: {keyup: autoSizeX}" onkeypress="vmEditAction.activeModelChange()" />
            </div>
            <div class="col-md-4 reset-colmd">
                <select style="width: 163px; margin-left: 15px;"
                        data-role="dropdownlist" data-filter="contains"
                        data-option-label=" "
                        data-auto-bind="false"
                        data-value-primitive="true"
                        data-text-field="Name"
                        data-value-field="Id"
                        data-bind="source: listActionCategory,
                            events:{filtering: dropdownListFiltering},
                            value: CategoryId, disabled: roleEdit">
                </select>
            </div>
        </div>
        <div class="col-md-6 goal-modal-first-col timecost">
            <div class="row">
                <div class="col-md-6 col-1" style="width: 120px; padding-right: 0px;">
                    <div class="form-group">
                        <div class="input-append date">
                            <input data-role="datepicker" data-bind="value: StartDate, disabled: IsConnectionUp" name="start" class="date-cost" />
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-2" style="width: 75px; padding-right: 25px;">
                    <div class="form-group numberofday">
                        <input data-bind="value:NumberOfDay, events:{change: numberOfDayChange}, disabled: roleEdit" data-format="\#"
                               data-role="numerictextbox" data-spinners="false" onkeypress="vmEditAction.activeModelChange()" data-min="0" name="day"
                               class="input-append numeric-right field_value" style="width: 100px" maxlength="3" />
                    </div>
                </div>

                <div class="col-md-6 col-3" style="width: 120px;">
                    <div class="form-group">
                        <div class="input-append date pull-left">
                            <input data-role="datepicker" data-bind="value: EndDate, disabled: roleEdit" name="end" class="date-cost" />
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-4-1" style="width: 15px;" data-bind="click: setGoalActionOutlook, disabled: roleEdit">
                    <div data-bind="click: setGoalActionOutlook">
                        <div class="icon-24 iconright-modal-mass margin-right6 pointer" data-toggle="dropdown" style="width: 23px; height: 23px;"></div>
                        <ul role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: auto; top: auto; bottom: auto;">
                            <li class="reminder" data-bind="click: openReminder, visible: isShowReminder"><a class="dropdow-menu-li-a a69" data-toggle="modal" data-target=".bs-example-modal-lg"> <span class="icon-24  icon-left-block icon-reminder"></span><span class="lblReminder" style="margin-left: 10px;">Erinnerung</span></a></li>
                            <li data-bind="visible: isShowReminder" role="presentation" class="divider icon-divider reminder"></li>
                            <li><a class="dropdow-menu-li-a a69 assignInfo" href="mailto:?Subject=" target="_top"><span class="icon-24  icon-left-block icon-assigninfo"></span><span class="lblAssignInfo" style="margin-left: 10px;">Zuweisen / Info</span></a></li>
                        </ul>
                    </div>
                </div>

                <div class="col-md-6 col-4-2" style="width: 10px;">
                    <div class="form-group">

                        <span class="checkbox-inline" style="padding-left:0;">
                            <label>
                                <input type="checkbox" data-bind="checked: Finish, disabled: roleEdit, events:{change: changeFinish}">
                                <span class="checkmarkd"></span>
                            </label>
                        </span>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-6 noPaddingRight truecost" style="padding-left: 10px;">
            <div class="col-md-6 noPaddingLeft noPaddingRight" style="width: 47%">
                <div class="form-group has-currency action-cost">
                    <input data-role="numerictextbox" class="text-right" focusevent="cost-focus" data-spinners="false" data-max="999999999999"
                           onkeypress=" vmEditAction.activeModelChange() "
                           data-format="#:cF#"
                           data-bind="value: ExpectedCost, events:{change: changeCost}, disabled: roleEdit"
                           style="width: 78%" />
                </div>
            </div>

            <div class="col-md-6 noPaddingLeft noPaddingRight" style="width: 51%">
                <div class="form-group has-currency action-cost">
                    <input data-role="numerictextbox" focusevent="cost-focus" class="text-right" data-spinners="false" data-max="999999999999"
                           onkeypress=" vmEditAction.activeModelChange() "
                           data-format="#:cF#"
                           data-bind="value: ActualCost, events:{change: changeCost}, disabled: roleEdit"
                           style="width: 72%" />

                    <div class="pull-right" style="width: 25%; position: relative">
                        <button type="button" class="btn-fibu pull-left" data-bind="events={click: openActionFibu}, visible: isHasFibu">
                            <span class="icon-20 icon-fibucost"></span>
                            <span></span>
                        </button>

                    </div>
                </div>
            </div>
        </div>

        <div data-bind="invisible:IsConnectionUp"
             class="grp-btns-activities"
             style="position: absolute;right: 40px;margin-right: 3px;">
            <span data-bind="events:{ click: removeActionCost}, visible: enableRemoveCost"
                  class="icon-32 icon-bin pull-right icondeletewhencost"></span>
            <!--khanh-->
        </div>
        <span class="icon-32 cursor-pointer icon-add-activity btnaddcost kgv-customtooltip"
              data-bind="events:{click: addActionCost, mouseover: showLblTooltipAdd },
                    attr: { data-content: customViewOption.LblTooltipActivity },
                        disabled: roleEdit, visible: IsShowAddCost"
              style="position: absolute; right: 4px;"></span>
    </div>
</script>

<script id="masterbudget" type="text/html">
    <div class="masteritem" style="margin-left: 0; margin-right: 0; margin-top: 0; padding-right: 0;" data-bind="visible: IsVisible">

        <div style="padding-left: 0; padding-right: 15px;">
            <div class="form-group" data-bind="disabled: roleEdit" style="margin-bottom: 0;">
                <div>
                    <div style="height: 18px;" data-bind="visible: HasMasterGoalCost">
                        <label class="master-goal-cost" data-bind="text: Budget"></label>
                        <label class="master-goal-cost" data-bind="text: ExpectedCost"></label>
                        <label class="master-goal-cost" data-bind="text: ActualCost"></label>
                    </div>
                    <div class="clear"></div>
                    <span class="masternotify hidden">*</span>
                    <select data-role="dropdownlist" data-filter="contains"
                            class="select-master w-80per pull-left" style="margin-right: 5px;"
                            data-value-primitive="true"
                            data-text-field="Name"
                            data-value-field="Id"
                            data-template="ddMasterActionTemplate"
                            data-bind="source: Src, value: MasterId, disabled: roleEdit,
                                events: {change: changeMasterBudget, select: selectMasterBudget, filtering: dropdownListFiltering},
                                disabled: roleEdit"></select>

                    <div class="percentdiv" style="width: 77px; float: left;" data-bind="visible: isRemovableMaster">
                        <input class="text-right" data-role="numerictextbox" style="width: 100%;" data-spinners="false" data-bind="value: MPercent, events:{change: changePercent}, disabled: roleEdit" data-min="0" data-max="100" data-format="#:pF#" maxlength="2" />
                    </div>

                    <div class="mastermenu" style="position: relative; float: right;top: 2px;" data-bind="invisible: roleEdit">
                        <div class="icon-24 iconright-modal-mass margin-right6 pointer" data-toggle="dropdown" style="width: 23px; height: 23px; float: right; margin-right: 1px;"></div>
                        <ul role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: 27px; top: 0;z-index: 1040;">
                            <li data-bind="events: {click: addMasterBudget}">
                                <a class="dropdow-menu-li-a a69" data-toggle="modal" data-target=".bs-example-modal-lg"><span class="icon-24 icon-left-block icon-add-region"></span><span>#:kLg.textAllocateBudget#</span></a>
                            </li>
                            <li role="presentation" class="divider" data-bind="visible: isRemovableMaster"></li>
                            <li data-bind="events: {click: removeMasterBudget}, visible: isRemovableMaster">
                                <a class="dropdow-menu-li-a a69" data-toggle="modal" data-target=".bs-example-modal-lg"><span class="icon-24 icon-left-block icon-delete"></span><span>#:kLg.Delele#</span></a>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>

        </div>
    </div>

</script>


<script id="actionTemplateChooser" type="text/html">
    <div class="modal-body ms-modal-body" style="overflow: auto; height: 285px">
        <form>
            <table id='tblTemp' class="tbgrid modal-table">
                <thead>
                    <tr>
                        <th class="title bg-grey" style="width: 55px;"></th>
                        <th class="title bg-grey" id="lblTemplateName">#:kLg.lblTemplateName#</th>
                    </tr>
                </thead>
                <tbody>
                    # for(var i = 0; i < data.length; i ++) { #
                    <tr>
                        <td>
                            <input type="checkbox" id="#=data[i].Id#" />
                        </td>
                        <td>#:data[i].Name#</td>
                    </tr>
                    # } #
                </tbody>
            </table>
        </form>
    </div>
    <div class="modal-market-footer" id="divImportFooter">
        <button type="button" class="ms-button" onclick="vmEditAction.deleteTemplate()"><span class="icon-20 icon-update margin-right6"></span><span class="btnChoose">#:kLg.lblDelete#</span></button>
    </div>
</script>

<script id="ddMasterActionTemplate" type="text/x-kendo-template">
    # if (data.IsMain) {#
    <strong class="dropdown-main-mastergoal-color">#: data.Name#</strong>
    #} else {#
    <span class="#: data.IsFinish ? 'k-state-disabled dropdown-mastergoal-color': ''#" style="padding-left:1em;">#: data.Name#</span>
    #}#

</script>

<script src="Scripts/jquery.multiple.selectwithicon.js"></script>
<script type="text/html" id="tempShowDescription">
    <div style="min-width: 50px; max-width: 300px">
        <div class="row-wrapper">
            <div class="content-break-word" style="text-align: center; color:black;font-size: 14px">#:data#</div>
            <div class="clear"></div>
        </div>
    </div>
</script>
<script type="text/javascript">
    function setupTooltipAddCost() {
        var userAgent = window.navigator.userAgent.toLowerCase();
        var ios = /iphone|ipod|ipad/.test(userAgent);
        if (!ios) {
            vmCommon.ShowToolTipDesIconBtnAddActionCost('.btnaddcost', kLg.addnewactivity, '#tempShowDescription', "top");
        }
        return !ios;
    }
    function setupTooltipAddTodoAddCost() {
        if (setupTooltipAddCost()) {
            vmCommon.ShowToolTipDesIconBtnAddActionCost('#btnaddtodo', kLg.addnewtodo, '#tempShowDescription', "top");
        }
    }

    vmGoalAction.GoalMaster = {};
    var isSelectMaster = false, isSelectRegion = false;

    var vmEditAction = vmEditAction || {};
    vmEditAction.viewModel = undefined;
    vmEditAction.isValidStream = true;
    vmEditAction.isValidSub = true;
    vmEditAction.isValidClient = true;

    vmEditAction.enumTypeSubjetThema = 15;
    vmEditAction.enumCategoriesMarketing = 1;
    vmEditAction.enumCheckExistedCategoryName = -3;

    vmEditAction.ActionFibus = [];
    vmEditAction.Advertisers = {};
    vmEditAction.KpiFormatDataSource = {};

    vmEditAction.dicActionTodoFile = {};
    vmEditAction.backupParentFile = null;
    var menuLinkCache = null;
    vmEditAction.TempCache = [];

    vmEditAction.typeActionConnect = {
        no: 0,
        add: 1,
        edit: 2,
        remove: 3
    };

    var msCurrency = vmGoalAction.actionOptions ? vmGoalAction.actionOptions.currency : "";
    var cF = (msCurrency ? msCurrency : "").encodeDola() + " ##,#.00";
    var pF = "# \\\%", isAutoPercent = false, maxMasterIndex = 0;

    var srcIndex = 0, desIndex = 0, isChangePosition = false, maxIndex = 0;

    vmEditAction.popTemplate = undefined;

    vmEditAction.getRating = function (from, to) {
        var currencies = vmGoalAction.actionOptions.currencyRates || [];

        var fromRate = 1, toRate = 1;
        for (var i = 0; i < currencies.length; i++) {
            if (currencies[i].Name === from) fromRate = currencies[i].Rate;
            if (currencies[i].Name === to) toRate = currencies[i].Rate;
        }

        return fromRate / toRate;
    };

    vmEditAction.reloadTodoFilesIcon = function () {
        setTimeout(function () {
            $(".todo-col3 .xx2 span[hasFile~='true']").removeClass("icon-folder-circle");
            $(".todo-col3 .xx2 span[hasFile~='true']").addClass("icon-assignedfile-circle");

            $(".todo-col3 .xx2 span[hasFile~='false']").removeClass("icon-assignedfile-circle");
            $(".todo-col3 .xx2 span[hasFile~='false']").addClass("icon-folder-circle");
        }, 800);
    };

    vmEditAction.bindSortTable = function (el) {
        $(el).sortable({
            axis: "y",
            items: "div.row-cost",
            helper: function (event, ui) {
                var $clone = $(ui).clone();
                $clone.css("position", "absolute");
                return $clone.get(0);
            },
            cursor: "n-resize",
            revert: false,
            opacity: 0.5,
            zIndex: 10003,
            tolerance: "pointer",
            containment: $(el),
            start: function (event, ui) {
                if ($("#tablecost").children(":visible").length < 2) {
                    $(ui.sender).sortable('cancel');
                    return;
                } // < 2 thì k được scroll
                srcIndex = ui.item.index();
                $('#area-edit-action .modal-body.ms-modal-body').css({ "overflow-x": "hidden" });
            },
            stop: function (event, ui) {
                if ($("#tablecost").children(":visible").length < 2) {
                    $(ui.sender).sortable('cancel');
                    return;
                }// < 2 thì k được scroll
                isChangePosition = true;
                desIndex = ui.item.index();
                var costs = vmCommon.deepCopy(vmEditAction.viewModel.action.ActionCosts);
                $('#area-edit-action .modal-body.ms-modal-body').css({ "overflow-x": " " });
                //var costs = vmEditAction.viewModel.action.ActionCosts;
                if (costs.length <= 1) return;

                for (var i = 0; i < costs.length; i++) {
                    costs[i].StartDate = vmEditAction.viewModel.action.ActionCosts[i].StartDate;
                    costs[i].EndDate = vmEditAction.viewModel.action.ActionCosts[i].EndDate;
                }

                var temp = costs.splice(srcIndex, 1);
                costs.splice(desIndex, 0, temp[0]);
                vmEditAction.viewModel.action.set("ActionCosts", costs);
                vmEditAction.viewModel.updateVisibleLastAddActionCost();

                vmEditAction.AutoWidthByTodoCost(vmEditAction.viewModel.action);

                $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
                $("#tablecost input[data-role='datepicker'][name='start']").kendoDatePicker({
                    weekNumber: true
                    ,
                    change: function (e) {
                        vmEditAction.viewModel.startDateChange(e);
                    }
                });
                $("#tablecost input[data-role='datepicker'][name='end']").kendoDatePicker({
                    weekNumber: true
                    ,
                    change: function (e) {
                        vmEditAction.viewModel.endDateChange(e);
                    }
                });

                bindAutoFocus();
                bindEndDateAutoformat();
                bindStartDateAutoformat();
                setupTooltipAddTodoAddCost();
            }
        });
        //khanhgv
        void function setupTooltip() {
            vmCommon.ShowToolTipDesIcon('.ShowtooltipiconevaluationAction', kLg.Evaluationiconiconactionplan, '#tempShowDescription', "left");
            vmCommon.ShowToolTipDesIcon('.showicontooltipAssignedAction', kLg.titleFileAssigned, '#tempShowDescription', "left");
        }();
    };

    function setBlurChangeDate() {
        $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

        $("#tablecost input[data-role='datepicker'][name='start']").kendoDatePicker({
            weekNumber: true,
            change: function (e) {
                vmEditAction.viewModel.startDateChange(e);
            }
        });
        $("#tablecost input[data-role='datepicker'][name='end']").kendoDatePicker({
            weekNumber: true,
            change: function (e) {
                vmEditAction.viewModel.endDateChange(e);
            }
        });

        bindStartDateAutoformat();
        bindEndDateAutoformat();

    };

    function setBlurTodoDateChange() {
        var todoDueDates = $("input[name~='todoDueDate']:not([todoeventxx])");
        todoDueDates.preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
        for (var i = 0; i < todoDueDates.length; i++) {
            $(todoDueDates[i]).attr("todoeventxx", "xnxx");
            $(todoDueDates[i]).off("keyup change").on("keyup change", function (e) {
                var valueDate = $(e.currentTarget).val().trim();
                var isValidIpnt = /\d|\/|\./.test(valueDate);
                if (valueDate != '' && !isValidIpnt) {
                    ShowToolTip2($(e.currentTarget), kLg.msgDateInValid);
                    $(e.currentTarget).val(valueDate.slice(0, -1));
                } else {
                    vmCommon.autoFormatInputDateString($(e.currentTarget), kLg.language);
                    DestroyToolTip($(e.currentTarget));
                    $(e.currentTarget).val(valueDate);
                }

            });
            $(todoDueDates[i]).off("blur").on("blur", function (e) {
                vmCommon.autoFormatInputDateString($(e.currentTarget), kLg.language);
                var valueDate = $(e.currentTarget).val().trim();

                var isValidDate = /(\d{1,2})(\/|\.)(\d{1,2})(\/|\.)(\d{4})/.test(valueDate);
                if (valueDate != '' && !isValidDate) {
                    ShowToolTip2($(e.currentTarget), kLg.msgDateInValid);
                } else {
                    DestroyToolTip($(e.currentTarget));
                }
            });
        }
    }

    function createEvaluationIcon() {
        var s = "margin-left: 4px; margin-top: 4px; line-height:4px;";

    }

    $(document).ready(function () {
        vmFile.assginedIcon("popEditAction");
        vmFile.vmObject = vmEditAction;

        limitedTabKey();

        setTimeout(function () {
            setBlurChangeDate();
            vmEditAction.reloadTodoFilesIcon();
            setBlurTodoDateChange();

            if (document.getElementById('popEditAction_wnd_title')) {
                $('#popEditAction_wnd_title').next().children().each(function (index) {
                    if (index == 1) $(this).attr('tabindex', 2);
                    else $(this).attr('tabindex', 3);
                });
            };

        }, 1000);

    });
    vmEditAction.initTabIndex = function () {
        var tabId = 0;
        $('#popEditAction #fEditAction').find('input, #area-edit-goal input[type="checkbox"], button:not(.temp-button), .k-multiselect-wrap, .k-dropdown, textarea')
            .each(function () {
                if ($(this).prop('disabled')) {
                    $(this).attr('tabindex', '-1');
                } else {
                    $(this).attr('tabindex', tabId);
                }
            });
        $('#fEditAction #btemplate > button, #btemplate > span[aria-disabled="false"]').attr('tabindex', 1);
    };
    vmEditAction.dataservice = (function () {
        var createAction = function (entryDate, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("createAction", entryDate, successFunc, 'loading-editaction');
        };

        var updateAction = function (entryDate, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("updateAction", entryDate, successFunc, 'loading-editaction');
        };
        var updateFromFormatPopup = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("updateactionfromformatpopup", entryData, successFunc, 'loading-editaction');
        };
        var getSubMarketMenu = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getSubMarketMenu", entryData, successFunc, 'loading-editaction');
        };
        var createTemplate = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("saveactiontemplate", entryData, successFunc, 'loading-editaction');
        };
        var getTemplates = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getActionTemplates", entryData, successFunc, 'loading-editaction');
        };
        var deleteTemplateByList = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("deleteActionTemplatesByList", entryData, successFunc, 'loading-editaction');
        };

        var getAdvertiserMenu = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getadvertisermenu", entryData, successFunc, "loading-editaction");
        };
        var getAdvertiserMenu2 = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getadvertisermenu2", entryData, successFunc, "loading-editaction");
        };
        var getKpiSetting = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getkpisetting", entryData, successFunc, "loading-editaction");
        };
        var getKpiActionSetting = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getkpiactionsetting", entryData, successFunc, "loading-editaction");
        };

        var getCustomViews = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getselectedviews", entryData, successFunc, "loading-editaction");
        };

        var getKpiFormatData = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("getkpiformatdata", entryData, successFunc, "loading-editaction");
        };
        var updateStatusFromFormatPopup = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("updatestatusfromformatpopup", entryData, successFunc, 'loading-editaction');
        };
        var addStatusFromFormatPopup = function (entryData, successFunc) {
            vmGoalAction.dataservice.callAjaxByPost("addstatusfromformatpopup", entryData, successFunc, 'loading-editaction');
        };

        return {
            createAction: createAction,
            updateAction: updateAction,
            updateFromFormatPopup: updateFromFormatPopup,
            updateStatusFromFormatPopup: updateStatusFromFormatPopup,
            addStatusFromFormatPopup: addStatusFromFormatPopup,
            createTemplate: createTemplate,
            getTemplates: getTemplates,
            deleteTemplateByList: deleteTemplateByList,
            getSubMarketMenu: getSubMarketMenu,
            getAdvertiserMenu: getAdvertiserMenu,
            getAdvertiserMenu2: getAdvertiserMenu2,
            getKpiSetting: getKpiSetting,
            getKpiActionSetting: getKpiActionSetting,
            getCustomViews: getCustomViews,
            getKpiFormatData: getKpiFormatData
        };
    })();

    vmEditAction.synchronizedDefaultViews = function () {
        //If has view and has default value
        if (customViews == undefined || customViewOption == undefined) return;

        var viewModel = vmEditAction.viewModel;
        var actionModel = vmEditAction.viewModel.action;
        var currentAdvertiser = vmCommon.deepCopy(actionModel.Advertiser);
        // #region 1. advertising/advertiser
        if (customViewOption.HasAdvertising) {
            //get default advertising
            let sDefaultAdv = customViews[vmCommon.ActionCustomViewType.ADVERTISING].DefaultValue;
            var defaultAdvertising = sDefaultAdv ? sDefaultAdv.split(',').filter(e => { return e != ''; }) : [];
            if (defaultAdvertising.length > 0) {
                defaultAdvertising = defaultAdvertising.map(f => { return Number(f); });
            }
            else defaultAdvertising = null;

            //get default advertiser
            var defaultAdvertiser = customViewOption.HasAdvertiser ? customViews[vmCommon.ActionCustomViewType.ADVERTISER].DefaultValue : null;
            if (defaultAdvertiser) {
                defaultAdvertiser = defaultAdvertiser.split(',').filter(e => {
                    return e != '';
                }).map(f => Number(f));

                if (defaultAdvertiser.length < 1 || defaultAdvertising.length > 1)
                    defaultAdvertiser = null;
            }
            else
                defaultAdvertiser = null;

            // building source
            const lstAllAdsingId = vmGoalAction.setting.ActAdvertisingMaterial.filter(a => a.Id > 0).map(a => a.Id);
            if (viewModel.isMultipleAdvertiser) {                
                switch (true) {
                    case (defaultAdvertising == null):
                    // #region instrument 0 tick Advsing
                        viewModel.set('listActAdvertisingMaterial', vmGoalAction.setting.ActAdvertisingMaterial);
                        updateSrcAdv();
                    // #endregion
                        break;
                    case (defaultAdvertising != null && defaultAdvertising.length == 1 && defaultAdvertiser == null):
                    // #region tick 1 Advsing 0 Advser
                        viewModel.set('listActAdvertisingMaterial', vmGoalAction.setting.ActAdvertisingMaterial);
                        updateSrcAdv();
                        clearActionAdvertisers();
                        setStateDelete();
                    // #endregion
                        break;
                    case (defaultAdvertising != null && defaultAdvertising.length == 1 && defaultAdvertiser != null && defaultAdvertiser.length == 1):
                    // #region tick 1 Advsing 1 Advser
                        viewModel.set('listActAdvertisingMaterial', vmGoalAction.setting.ActAdvertisingMaterial);
                        updateSrcAdv(defaultAdvertising[0]);
                        // Set 1 Advertising
                        var advId = defaultAdvertiser[0];
                        var adv = viewModel.listActAdvertiser.find(a => a.Id == advId);
                        viewModel.set("isMultipleAdvertiser", false); viewModel.set("isMultipleAdvertiserShow", false);
                        viewModel.set("action.AdvertisingMaterial", defaultAdvertising[0]);

                        // Set 1 Advertiser
                        for (var i = actionModel.ActionAdvertisers.length - 1; i > -1; i--) {
                            if (actionModel.ActionAdvertisers[i].Id != advId) {
                                actionModel.ActionAdvertisers.splice(i, 1);
                            }
                        }
                        if (adv) {
                            adv = vmCommon.deepCopy(adv);
                            viewModel.set("action.Advertiser", adv.Id);
                            viewModel.set("action.AdvertiserName", adv.Name);
                            viewModel.set("isVisibleKpi", true);

                            if (!actionModel.ActionAdvertisers.length) {
                                actionModel.ActionAdvertisers.push(adv);

                                var enableSI = vmGoalAction.checkEnableSI(actionModel);
                                var endDate = changeHourOfDate(vmGoalAction.getIndexOfMaxDate(actionModel.ActionCosts).MaxDate);
                                vmEditAction.dataservice.getKpiSetting({
                                    Advertiser: adv.Id, IsMultiSelect: false, Advertisers: [adv.Id],
                                    KpiFormatIds: actionModel.Formats.filter(function (it) { return it.DataState != dataState.Deleted; }).map(function (it) { return it.KpiFormatId; }),
                                    EnableSI: enableSI, EndDate: endDate
                                }, function (res) {
                                    const newK = res.value.find(nk => nk.AdvertiserId == adv.Id);
                                    if (newK) {
                                        actionModel.KpiData.push(newK);
                                        actionModel.KpiData.sort(function (a, b) { return a.AdvertiserIndex - b.AdvertiserIndex; });
                                    }
                                });
                            }
                            setStateDelete([adv.Id]);

                        } else {
                            setStateDelete();
                        }
                        // #endregion
                        break;
                    case (defaultAdvertising != null && lstAllAdsingId.length == defaultAdvertising.length):
                    // #region Advsing = Max
                    case (defaultAdvertising != null && 1 < defaultAdvertising.length && lstAllAdsingId.length > defaultAdvertising.length):
                        // 1 < Advsing < Max
                        const lstAdvsing = vmGoalAction.setting.ActAdvertisingMaterial.filter(sA => sA.Id < 0 || defaultAdvertising.includes(sA.Id));
                        // filter source Advertising
                        viewModel.set('listActAdvertisingMaterial', lstAdvsing);
                        
                        // filter source Advertiser
                        updateSrcAdv();

                        // filter value Advertiser
                        var lstAdvId = vmCommon.deepCopy(viewModel.listActAdvertiser.map(ad => ad.Id));
                        for (var _i = actionModel.ActionAdvertisers.length - 1; _i > -1; _i--) {
                            if (!lstAdvId.includes(actionModel.ActionAdvertisers[_i].Id)) {
                                actionModel.ActionAdvertisers.splice(_i, 1);
                            }
                        }
                        setStateDelete(vmCommon.deepCopy(actionModel.ActionAdvertisers.map(a => a.Id)));
                    // #endregion
                    // không break vì xong case này thì chạy tiếp xuống case dưới
                    case (defaultAdvertising != null && 1 < defaultAdvertising.length && lstAllAdsingId.length > defaultAdvertising.length):
                        // #region 1 < Advsing < Max

                        // option
                        if (!actionModel.ActionAdvertisers.length) {
                            viewModel.set("isMultipleAdvertiser", false); viewModel.set("isMultipleAdvertiserShow", false);
                            viewModel.set("action.AdvertisingMaterial", null);
                        }
                        // #endregion
                        break;
                    default:
                        // Instrument null, 
                        break;
                }
                if (customViewOption.HasAdvertiser == false) {
                    clearActionAdvertisers();
                    setStateDelete();
                }
            } else {
                // #region code cũ chọn 1 Advertising (để nguyên)
                // #region set resource
                if (defaultAdvertising == null || defaultAdvertising.length == 1) {
                    viewModel.set('listActAdvertisingMaterial', vmGoalAction.setting.ActAdvertisingMaterial);
                    if (defaultAdvertising != null && defaultAdvertising.length == 1) {
                        viewModel.set("listActAdvertiser", vmEditAction.getAdvertiserSrc(defaultAdvertising));
                    } else
                        viewModel.set("listActAdvertiser", vmEditAction.getAdvertiserSrc(viewModel.action.AdvertisingMaterial ? [viewModel.action.AdvertisingMaterial] : viewModel.listActAdvertisingMaterial.map(t => t.Id)));
                } else {
                    let sourceActAdvertisingMaterial = vmGoalAction.setting.ActAdvertisingMaterial.filter(a => {
                        let f = defaultAdvertising.find(e => { return e == a.Id });
                        return f != undefined || a.Id < 0;
                    });
                    viewModel.set('listActAdvertisingMaterial', sourceActAdvertisingMaterial);
                    viewModel.set("listActAdvertiser", vmEditAction.getAdvertiserSrc(sourceActAdvertisingMaterial.map(t => t.Id)));
                }
                // #endregion set resource
                // #region set value
                if (defaultAdvertising != null && defaultAdvertising.indexOf(actionModel.AdvertisingMaterial) == -1) {
                    if (defaultAdvertising.length == 1) {
                        viewModel.set("action.AdvertisingMaterial", defaultAdvertising[0]);
                    }
                    else if (defaultAdvertising.length > 1) {
                        viewModel.set("action.AdvertisingMaterial", null);
                    }

                    viewModel.set("isVisibleKpi", false);
                    viewModel.set("action.Advertiser", null);
                    viewModel.set("action.AdvertiserName", "");

                    vmEditAction.formatService.clear();
                    setStateDelete();

                    var child = { isVisibleKpi: false, Advertiser: null, AdvertiserName: "", KpiFormatId: null, KpiFormatIds: [] };
                    var setData = function (ads) {
                        setStateDelete();
                        vmEditAction.viewModel.set("isVisibleKpi", vmEditAction.viewModel.isHasKpi && ads.isVisibleKpi);

                        viewModel.set("action.Advertiser", ads.Advertiser);
                        viewModel.set("action.AdvertiserName", ads.AdvertiserName);

                        vmEditAction.formatService.clear();
                        child.KpiFormatIds.forEach(function (it) {
                            vmEditAction.formatService.add(it);
                        });
                    };
                    var selectAdvertisingCallBack = function (datas) {
                        if (datas.length == 0) return false;

                        var advertisers = $.grep(datas, function (it) { return it.TypeId == 1; });

                        var advertiser = undefined;
                        if (defaultAdvertiser) {
                            advertiser = vmCommon.findByFunc(advertisers, function (it) { return it.Id == defaultAdvertiser; });
                        } else if (advertisers.length == 1 && defaultAdvertising.length == 1) {
                            advertiser = advertisers[0];
                        }

                        if (advertiser == undefined) return false;

                        var formats = $.grep(datas, function (it) { return it.TypeId == 3 && it.ParentId == advertiser.Id; });
                        if (defaultAdvertiser == null && formats.length > 1) return false;

                        child.isVisibleKpi = true;
                        child.Advertiser = Number(advertiser.Id);
                        child.AdvertiserName = advertiser.Name;

                        if (formats.length == 1) {
                            child.KpiFormatIds = [Number(formats[0].Id)];
                        } else {
                            vmEditAction.formatService.clear();
                        }

                        return advertiser.Id != currentAdvertiser;
                    }
                    if (defaultAdvertising.length >= 1) {
                        if (customViewOption.HasAdvertiser && (defaultAdvertiser == null || defaultAdvertiser != actionModel.Advertiser)) {
                            if (vmEditAction.Advertisers["" + defaultAdvertising[0]]) {
                                var flag = selectAdvertisingCallBack(vmEditAction.Advertisers["" + defaultAdvertising[0]]);
                                setData(child);
                                if (flag) {
                                    vmEditAction.updateKpiActionData();
                                }
                            } else {
                                vmEditAction.dataservice.getAdvertiserMenu({ AdvertisingId: defaultAdvertising[0] }, function (res) {
                                    var datas = res.value;
                                    vmEditAction.Advertisers["" + defaultAdvertising[0]] = datas;
                                    var advertisers = $.grep(datas, function (it) { return it.TypeId == 1; });
                                    if ((defaultAdvertiser == null || defaultAdvertiser.length == 1) && advertisers.length == 1 && advertisers[0].Id == actionModel.Advertiser) return;

                                    var flag = selectAdvertisingCallBack(datas);
                                    setData(child);
                                    if (flag) {
                                        vmEditAction.updateKpiActionData();
                                    }
                                });
                            }
                        }
                    }
                } else {
                    viewModel.set("isVisibleKpi", false);
                    viewModel.set("action.Advertiser", null);
                    viewModel.set("action.AdvertiserName", "");
                    vmEditAction.formatService.clear();
                    vmEditAction.updateKpiActionData();
                }
                // #endregion set value
                // #endregion chọn 1 Advertising 
            }
        } else if (viewModel.isMultipleAdvertiser) {
            clearActionAdvertisers();
            setStateDelete();
        }
        // #endregion advertising/advertiser
        //9. category
        var cates = vmEditAction.getCategorySrc();
        var cateIds = cates.map(t => t.Id);
        actionModel.set("Categories", actionModel.Categories.filter(t => cateIds.indexOf(t.Id) >= 0));
        actionModel.ActionTodos.forEach(t => {
            if (t.CategoryId > 0 && cateIds.indexOf(t.CategoryId) == -1) t.set("CategoryId", null);
        });

        actionModel.ActionCosts.forEach(t => {
            if (t.CategoryId > 0 && cateIds.indexOf(t.CategoryId) == -1) t.set("CategoryId", null);
        });

        viewModel.set("listActionCategory", cates);
    };

    vmEditAction.synchronizedViews = function () {
        //run after change instrument
        if (customViews == undefined || customViewOption == undefined) return;

        var viewModel = vmEditAction.viewModel;
        var actionModel = vmEditAction.viewModel.action;

        if (customViewOption.HasMasterBudget == false || vmGoalAction.actionOptions.isDisordered) {
            vmEditAction.clearMasterAlert();
            actionModel.set("MasterBudgets", $.grep(actionModel.MasterBudgets, function (it) { return it.Id > 0; }).map(function (it) { it.set("DataState", dataState.Deleted); it.set("IsVisible", false); return it; }));

            viewModel.set("isRemovableMaster", false);
        } else {
            vmEditAction.clearMasterAlert();

            if (actionModel.MasterBudgets.some(function (it) { return it.DataState != dataState.Deleted; }) == false) {
                var newMaster = new MasterBudget();
                newMaster.MPercent = 100;

                actionModel.MasterBudgets.push(newMaster);
            }

            var visibleMasters = $.grep(actionModel.MasterBudgets, function (it) { return it.IsVisible; });

            isAutoPercent = actionModel.MasterBudgets.length === 1;
            viewModel.set("isRemovableMaster", visibleMasters > 1);
            viewModel.rebindMasterSourceModel();
        }

        if (customViewOption.HasProduct == false || vmGoalAction.actionOptions.isDisordered) {
            
            var labeSrc = viewModel.labeSubSrc;
            for (var i = labeSrc.length - 1; i >= 0; i--) {
                var item = labeSrc[i];

                item.IsSelect = false;
                item.set("DataState", item.Id > 0 ? dataState.Deleted : dataState.Unchanged);
                viewModel.autoSubSrc.push(item);
                labeSrc.splice(i, 1);
            }

            vmEditAction.isValidSub = true;
            viewModel.set("isVisibleSelectedSub", false);
            vmEditAction.syncKpiService.clearTopic(viewModel, vmCommon.KpiGoalTopicType.Product);
        }

        if (customViewOption.HasCustomerJourney == false || vmGoalAction.actionOptions.isDisordered) {
            
            var labeCusSrc = viewModel.labeCusSrc;
            for (var i = labeCusSrc.length - 1; i >= 0; i--) {
                var item = labeCusSrc[i];

                item.IsSelect = false;
                item.set("DataState", item.Id > 0 ? dataState.Deleted : dataState.Unchanged);
                viewModel.autoCusSrc.push(item);
                labeCusSrc.splice(i, 1);
            }
            viewModel.set("isVisibleSelectedCus", false);
        }

        if (customViewOption.HasMarket == false || vmGoalAction.actionOptions.isDisordered) {
            
            var labeSrc = viewModel.labeClientSrc;
            for (var i = labeSrc.length - 1; i >= 0; i--) {
                var item = labeSrc[i];

                item.IsSelect = false;
                item.set("DataState", item.Id > 0 ? dataState.Deleted : dataState.Unchanged);
                viewModel.autoClientSrc.push(item);
                labeSrc.splice(i, 1);
            }

            viewModel.set("isVisibleSelectedClient", false);
            vmEditAction.syncKpiService.clearTopic(viewModel, vmCommon.KpiGoalTopicType.Market);
        }

        if (customViewOption.HasDescription == false) actionModel.set("Description", "");
        if (customViewOption.HasExpectedEffect == false) actionModel.set("ExpectedEffect", "");
        if (customViewOption.HasActualEffect == false) actionModel.set("ActualEffect", "");

        viewModel.set("isHasKpiSecond", !customViewOption.HasExpectedEffect && !customViewOption.HasActualEffect && viewModel.isHasKpi);

        if (customViewOption.HasResponsibility == false) actionModel.set("People", []);
        if (customViewOption.HasInvolvedPeople == false) actionModel.set("PeopleInvolved", []);
        if (customViewOption.HasCategory == false) actionModel.set("Categories", []);
        if (customViewOption.HasField == false) actionModel.set("Fields", []);

        if (customViewOption.HasAdvertising == false) {
            viewModel.set("isVisibleKpi", false);

            actionModel.set("Advertiser", null);
            actionModel.set("AdvertiserName", "");

            vmEditAction.formatService.clear();

            actionModel.set("AdvertisingMaterial", null);
            if (actionModel.KpiData.length) actionModel.KpiData.filter(kpiD => { kpiD.DataState = dataState.Deleted; });
        }

        if (customViewOption.HasSubjectThema == false) {
            actionModel.set("subjetThemaName", "");
            actionModel.set("SubjectThema", null);
        }

        if (customViewOption.HasRegion == false) {
            viewModel.labeRegionSrc.forEach(function (it) {
                it.set("IsCheck", false);
                it.set("DataState", it.Id > 0 ? dataState.Deleted : dataState.Unchanged);
                viewModel.autoRegionSrc.push(it);
            });

            viewModel.set("labeRegionSrc", []);
            viewModel.autoRegionSrc.sort(function (a, b) { return a.Index - b.Index; });
            vmEditAction.syncKpiService.clearTopic(viewModel, vmCommon.KpiGoalTopicType.LandRegion);
        }

        if (customViewOption.HasCost == false) {
            actionModel.set("ExpectedCost", 0);
            actionModel.set("ActualCost", 0);

            actionModel.ActionCosts.forEach(function (it) { it.set("ExpectedCost", 0); it.set("ActualCost", 0); if (it.DataState == dataState.Unchanged) it.set("DataState", dataState.Modified); });
        }
        vmEditAction.visibleCostField(customViewOption.HasCost);

        if (customViewOption.HasUpStream == false) {
            vmEditAction.isValidStream = true;
            viewModel.set("actionSelect", null);
            vmEditAction.actionUpStreamId = null;
            vmEditAction.paths = null;

            vmEditAction.removeUpStreamTooltip();

            actionModel.set("ActionUpStreamConnectionAction", null);
            vmEditAction.theAction.ActionUpStreamConnectionAction = null;
            viewModel.set("actionSelectName", null);

            vmEditAction.bindActionCostByUpStream();
        }

        if (customViewOption.HasResourcePlanning == false) actionModel.set("IsCalendar", true);
        if (customViewOption.HasVisibility == false) actionModel.set("Visibility", true);
    };

    vmEditAction.setupLanguageCustomView = function () {
        if (customViews == undefined || customViewOption == undefined) return;

        if (customViewOption.HasActualEffect) {
            var labelActual = customViews[vmCommon.ActionCustomViewType.ACTUALEFFECT];
            $('#area-edit-action #lblActualEffect').text(labelActual && labelActual.Label ? labelActual.Label : kLg.gaLblActualEffect);
        }
        if (customViewOption.HasExpectedEffect) {
            var labelExpected = customViews[vmCommon.ActionCustomViewType.EXPECTEDEFFECT];
            $('#area-edit-action #lblExpectedEffect').text(labelExpected && labelExpected.Label ? labelExpected.Label : kLg.gaLblExpectedEffect);
        }
        if (customViewOption.HasField) {
            var labelField = customViews[vmCommon.ActionCustomViewType.FIELD];
            $('#area-edit-action #lblField').text(labelField && labelField.Label ? labelField.Label : kLg.gaLblField);
        }
        if (customViewOption.HasCategory && language !== 'pm') {
            var labelField = customViews[vmCommon.ActionCustomViewType.CATEGORY];
            $('#area-edit-action #lblCategory').text(labelField && labelField.Label ? labelField.Label : kLg.lblNameAction);
        }
        if (customViewOption.HasAdvertising) {
            var labelAdvertising = customViews[vmCommon.ActionCustomViewType.ADVERTISING];
            $('#area-edit-action #lblAdvertisingMaterial').text(labelAdvertising && labelAdvertising.Label ? labelAdvertising.Label : kLg.lblNameAdvertisingMaterials);
        }
        if (customViewOption.HasAdvertiser) {
            var labelAdvertiser = customViews[vmCommon.ActionCustomViewType.ADVERTISER];
            $('#area-edit-action #lblAdvertiser').text(labelAdvertiser && labelAdvertiser.Label ? labelAdvertiser.Label : kLg.lblNameAdvertiser);
        }
        if (customViewOption.HasRegion) {
            var labelRegion = customViews[vmCommon.ActionCustomViewType.REGION];
            vmGoalAction.RegionTitle = labelRegion && labelRegion.Label ? labelRegion.Label : kLg.lblRegions;
            $('#area-edit-action #lblRegion').text(vmGoalAction.RegionTitle);
        }
        if (customViewOption.HasCustomerJourney) {
            var labelCustomerJourney = customViews[vmCommon.ActionCustomViewType.CUSTOMERJOURNEY];
            vmGoalAction.CustomerJourneyTitle = labelCustomerJourney && labelCustomerJourney.Label ? labelCustomerJourney.Label : kLg.vtextCustomerJourney;
            $('#area-edit-action #lblCustomerJourney').text(vmGoalAction.CustomerJourneyTitle);
        }
    };

    vmEditAction.setupLanguage = function () {
        var labelName = vmGoalAction.popEditAction.options.title;
        if (labelName.contains(kLg.titlepAddMainGoalNew1.trim())) {
            labelName = labelName.replace(kLg.titlepAddMainGoalNew1.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepAddMainGoalNew2.trim())) {
            labelName = labelName.replace(kLg.titlepAddMainGoalNew2.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepEditMainGoalNew1.trim())) {
            labelName = labelName.replace(kLg.titlepEditMainGoalNew1.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepEditMainGoalNew2.trim())) {
            labelName = labelName.replace(kLg.titlepEditMainGoalNew2.trim(), "").trim();
        }

        if (vmGoalAction.actionOptions.fromBoard || vmGoalAction.actionOptions.isDisordered) labelName = kLg.labelActionName;
        $('#area-edit-action #lblName').text(labelName);
        $('#area-edit-action #lblPerson').text(kLg.labelRes);
        $('#area-edit-action #lblPersonInvolved').text(kLg.labelPeopleInvolved);
        $('#area-edit-action #lblCategory').text(language === 'pm' ? 'Kategorie' : kLg.labelCategories);
        $('#area-edit-action #lblDateStart').text(kLg.labelStart);
        $('#area-edit-action #lblDateEnd').text(kLg.labelEnd);
        $('#area-edit-action #lblField').text(kLg.gaLblField);
        $('#area-edit-action #lblInstrument').text(kLg.menuInstrument);
        //$('#area-edit-action #lblDescription').text(kLg.labelDes);
        $('#area-edit-action #lblExpectedEffect').text(kLg.gaLblExpectedEffect);
        $('#area-edit-action #lblActualEffect').text(kLg.gaLblActualEffect);
        $('#area-edit-action #lblExpectedCost').text(kLg.gaLblExpectedCost);
        $('#area-edit-action #lblActualCost').text(kLg.gaLblActualCost);
        $('#area-edit-action #lblStatusProtocol').text(kLg.gaLblStatusProtocol);
        $('#area-edit-action #lblDateStatus').text(kLg.labelDate);
        $('#area-edit-action #lblStatus').text(kLg.gaLblStatus);
        $('#area-edit-action #lblComment').text(kLg.labelComment);
        $('#area-edit-action #lblAddStatus').text(kLg.gaLblAddStatus);
        $('#area-edit-action #lblVisibility').text(kLg.labelVisibility);
        $('#area-edit-action #lblFinish').text(htmlEncode((kLg.language === "en" ? "&nbsp;&nbsp;" : "")) + kLg.labelFinishAction);
        $('#area-edit-action #lblEP').text(kLg.gaLblEP);
        $('#area-edit-action #lblClose').text(kLg.lblClose);

        $("#area-edit-action #lblConnection").text(kLg.textConnection);

        $("#area-edit-action #lblNumberOfDay").text(kLg.NumberOfDay);
        $("#area-edit-action #lblAdvertisingMaterial").text(kLg.lblNameAdvertisingMaterials);
        $("#area-edit-action #lblAdvertiser").text(kLg.lblNameAdvertiser);
        $("#area-edit-action #lblSubjetThema").text(kLg.lblNameSubjetThema);
        $("#area-edit-action #lblUpStream").text(kLg.upstreamAction);

        $("#area-edit-action #lblMasterGoal").text(kLg.textMasterbudget);
        $("#area-edit-action #lblRegion").text(vmGoalAction.RegionTitle ? vmGoalAction.RegionTitle : kLg.lblRegions);

        $("#area-edit-action #lblSubProductGroup").text(kLg.filterLblProduct);

        $("#area-edit-action #lblSubClientGroup").text(kLg.lblSubmarket);
        $("#area-edit-action .lblReminder").text(kLg.reminder);
        $("#area-edit-action .lblAssignInfo").text(kLg.assignInfo);

        $("#area-edit-action #lblAddTemplate").text(kLg.btnSaveAsTemplate);
        $("#area-edit-action #lblDeleteTemplate").text(kLg.DeleteTemplate);
        $("#area-edit-action #lblEvaluationicon").text(kLg.Evaluationiconiconactionplan);
        $("#area-edit-action #lblFileAssignedicon").text(kLg.titleFileAssigned);

        $("#area-edit-action #lblCostKategorie").text(kLg.lblNameAction);

        //Todo labels
        $("#area-edit-action #lblTodoKategorie").text(kLg.lblNameAction);
        $('#area-edit-action #lblTodoDueDate').text("Due Date");
        $('#area-edit-action #lblTodoFinish').text(kLg.labelFinishAction);
        $('#area-edit-action #lblTodoRespon').text(kLg.labelRes);
        $('#area-edit-action #lblApConnection').text(kLg.lblApConnection);
    };

    vmEditAction.bindPopUpEvent = function () {
        vmGoalAction.popEditAction.bind("close", function (e) {
            vmFile.enableAssignedIcon = false;
            var aid = vmEditAction.viewModel.action.Id;
            
            if (typeof MsaApp == 'object') {
                MsaApp.setLastActiveElement(aid);
                // chua lam gi da dong luon form
                if (!MsaApp.isLastLoadTimeAction('vmEditActionDataserviceCreateAction')) {
                    MsaApp.scrollXY2Action(aid, function () {
                        MsaApp.pushLoadTimeActions('checkDone_ScrollTo_Action');
                    });
                }
            }
            else {      // cac trang khac ActionPlan
                if (vmGoalAction.actionOptions.IsEdit)
                    $('.last-active-element').removeClass("last-active-element");
                $("div[id~='" + aid + "']").addClass("last-active-element");
            }

            if (vmFile && vmFile.idFileAssigned && vmFile.idFileAssigned.contents) {
                vmFile.idFileAssigned.contents = [];
            }

            if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) {
                vmEditAction.modelChanged = false;
            }

            if (vmEditAction.modelChanged) {
                if (confirm(kLg.saveConfirmQuestion)) {
                    //<!--valid for subjet\thema
                    var subjetThemaName = vmEditAction.viewModel.get("subjetThemaName");
                    var subjetThemaObj = vmCommon.findByFunc(vmGoalAction.setting.SubjetThemas, function (it) { return it.Name === subjetThemaName; });
                    if (subjetThemaName !== undefined && subjetThemaName.length > 0 && subjetThemaObj === null) {
                        $("#acSubjetThema").tooltip('destroy');
                        $("#acSubjetThema").attr("title", kLg.InvalidData);
                        $("#acSubjetThema").tooltip({ trigger: "manual" }).tooltip('show');
                        e.preventDefault();
                        return;
                    }
                    //-->
                    vmEditAction.viewModel.update();
                    if (isValidDate() && $('#fEditAction').valid() && vmEditAction.valid && isValidStatus() && isValidStream() && isValidSub() && vmEditAction.validMasterBudget()) {

                        if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                            vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                        } else if (typeof vmGoalAction === 'object') {
                            vmCommon.AddressBar.ClientQuery.resetAddressBar();
                        }

                        if (vmGoalAction.popEditAction) vmGoalAction.popEditAction.destroy();
                        vmGoalAction.popEditAction = null;
                        delete vmCommon.LstKpiData;
                        delete vmGoalAction.actionOptions.isDisordered;

                        $('.navbar-collapse.collapse.block-nav').after('<div id="popEditAction"></div>');
                    } else {
                        e.preventDefault();
                    }
                } else {
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                        vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                    };
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                        teamBoardVM.reloadBoardLineAfterUpdateElement({
                            Name: vmEditAction.viewModel.get("action.Name"),
                            Id: vmEditAction.viewModel.get("action.Id"),
                            NewColor: ""
                        });
                    };

                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan) && vmCommon.TexEditor.wasDataChanged()) {
                        MsaApp.updateDataProductOrTheme_Expand_InView_Observer();   // vmEditAction.modelChanged == true || 'string not empty' || != 0
                        
                    }

                    if (vmGoalAction.popEditAction) vmGoalAction.popEditAction.destroy();
                    vmGoalAction.popEditAction = null;
                    delete vmCommon.LstKpiData;
                    delete vmGoalAction.actionOptions.isDisordered;
                    $('.navbar-collapse.collapse.block-nav').after('<div id="popEditAction"></div>');
                }
            } else {
                if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan) && vmCommon.TexEditor.wasDataChanged()) {
                    MsaApp.updateDataProductOrTheme_Expand_InView_Observer();   // vmEditAction.modelChanged == false || undefined || '' || null || 0
                    
                }

                if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                    vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                } else if (typeof vmGoalAction === 'object') {
                    vmCommon.AddressBar.ClientQuery.resetAddressBar();
                }

                if (vmGoalAction.popEditAction) vmGoalAction.popEditAction.destroy();
                vmGoalAction.popEditAction = null;
                delete vmCommon.LstKpiData;
                delete vmGoalAction.actionOptions.isDisordered;
                $('.navbar-collapse.collapse.block-nav').after('<div id="popEditAction"></div>');
                vmCommon.popup.close();
            }

        });

        var $rowtodoicon = $("#todostablecost .row.todos").last();
        if ($rowtodoicon.length < 1) {
            $('#btnaddtodo').css({ "right": "14px", "margin-top": "0px" });
        } else {
            var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
            $('#btnaddtodo').insertAfter($icondeletewhentodo);
            $('#btnaddtodo').css({ "right": "6px", "margin-top": "1px" });
        }
    };

    vmEditAction.syncKpiService = function () {
        var model, kpiSetting;

        var getTopic = function (topics, topicType) {
            var topic;

            if (topics.some(t => t.TypeId == topicType) == false) {
                var newId = vmCommon.min(topics.filter(t => t.Id < 0).map(t => t.Id), 0);
                var textRegion = vmGoalAction.RegionTitle ? vmGoalAction.RegionTitle : kLg.vtextRegion;
                topic = { Id: --newId, Name: topicType == vmCommon.KpiGoalTopicType.LandRegion ? textRegion : topicType == vmCommon.KpiGoalTopicType.Market ? kLg.titleStackholderGroups : topicType == vmCommon.KpiGoalTopicType.Product ? kLg.filterLblProduct : "[Topic Name]", ActionId: null, TypeId: topicType, Description: "", MIndex: 0, DataState: dataState.Added, KpiMasterIndexes: [] };
                topics.push(topic);
            }

            return topics.find(t => t.TypeId == topicType);
        };

        var syncIndexTime = function (index, times) {
            times = times || [];
            var _indexTimeId = 0;

            for (var i = 0; i < times.length; i++) {
                var time = times[i];

                index.KpiMasterIndexTimes.push({ Id: --_indexTimeId, KpiActionMasterIndexId: index.Id, KpiActionMasterTimeId: time.Id, KpiValue: null, DataState: dataState.Added });
            }
        };

        var reCalculatePercent = function (indexes) {
            var count = indexes.length;
            var p = Math.floor((100 / count) * 100) / 100;
            for (var i = 0; i < count; i++) {
                var index = indexes[i];
                index.KpiPercent = p;

                //for last index
                if (i > 0 && i == count - 1) index.KpiPercent = 100 - (count - 1) * p;
                if (index.DataState == dataState.Unchanged) index.DataState = dataState.Modified;
            }
        };

        var getNewIndexId = function (topics) {
            var lst = [];
            topics.forEach(t => {
                lst.push(vmCommon.min(t.KpiMasterIndexes.filter(t => t.Id < 0).map(t => t.Id), 0));
            });

            return vmCommon.min(lst, 0);
        };

        var syncRegion = function () {
            var kpiData = model.action.KpiMasterData;
            var labeRegion = model.labeRegionSrc;

            //add new topic
            var topics = kpiData.KpiMasterTopics || [];
            if (labeRegion.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.LandRegion) == false) return;

            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.LandRegion);

            //config data for index
            var indexes = topic.KpiMasterIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (index.TypeId == vmCommon.MsKpiGoalIndexType.LAND || labeRegion.some(t => t.ObjectId == index.LongLinkId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEXMASTER, Item: index });
            }

            for (var i = 0; i < labeRegion.length; i++) {
                var label = labeRegion[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == vmCommon.MsKpiGoalIndexType.REGION)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: 2, KpiActionMasterTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiMasterIndexTimes: [] };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData.KpiMasterTimes);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);

        };
        var syncMarket = function () {
            var kpiData = model.action.KpiMasterData;
            var labeMarket = model.displayClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4).map(t => { return { ObjectId: t.ObjectId, TypeId: t.TypeId == 1 ? 3 : t.TypeId == 2 ? 4 : t.TypeId == 3 ? 5 : 0, Name: t.Name }; });

            //add new topic
            var topics = kpiData.KpiMasterTopics || [];
            if (labeMarket.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.Market) == false) return;

            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.Market);

            //config data for index
            var indexes = topic.KpiMasterIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (labeMarket.some(t => t.ObjectId == index.LongLinkId && t.TypeId == index.TypeId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEXMASTER, Item: index });
            }

            for (var i = 0; i < labeMarket.length; i++) {
                var label = labeMarket[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == label.TypeId)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: label.TypeId, KpiActionMasterTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiMasterIndexTimes: [] };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData.KpiMasterTimes);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);
        };
        var syncProduct = function () {
            var kpiData = model.action.KpiMasterData;
            var labeProduct = model.displaySrc.map(t => { return { ObjectId: t.ObjectId, TypeId: t.TypeId == 1 ? 6 : t.TypeId == 2 ? 7 : t.TypeId == 3 ? 8 : 0, Name: t.Name }; });

            //add new topic
            var topics = kpiData.KpiMasterTopics || [];
            if (labeProduct.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.Product) == false) return;

            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.Product);

            //config data for index
            var indexes = topic.KpiMasterIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (labeProduct.some(t => t.ObjectId == index.LongLinkId && t.TypeId == index.TypeId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEXMASTER, Item: index });
            }

            for (var i = 0; i < labeProduct.length; i++) {
                var label = labeProduct[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == label.TypeId)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: label.TypeId, KpiActionMasterTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiMasterIndexTimes: [] };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData.KpiMasterTimes);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);
        };

        var sync = function (actionModel, topicType) {
            if (actionModel == undefined) return;

            model = actionModel;
            switch (topicType) {
                case vmCommon.KpiGoalTopicType.LandRegion:
                    syncRegion();
                    break;
                case vmCommon.KpiGoalTopicType.Market:
                    syncMarket();
                    break;
                case vmCommon.KpiGoalTopicType.Product:
                    syncProduct();
                    break;
            }
        };

        var clearTopic = function (actionModel, topicType) {
            if (actionModel == undefined) return;
            model = actionModel;

            var kpiData = model.action.KpiMasterData;
            var topics = kpiData.KpiMasterTopics;

            if (topics == null || topics.length == 0) return;
            var topic = topics.find(t => t.TypeId == topicType);

            if (topic == undefined) return;

            var topicIndex = topics.indexOf(topic);
            if (topic.Id >= 0) kpiData.DeletedItems.push({ Id: topic.Id, Type: vmCommon.KpiGoalType.TOPICMASTER });

            var indexes = topic.KpiMasterIndexes || [];
            for (var i = 0; i < indexes.length; i++) {
                var index = indexes[i];

                if (index.Id >= 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEXMASTER });

                var indextimes = index.KpiMasterIndexTimes || [];
                for (var j = 0; j < indextimes.length; j++) {
                    var indextime = indextimes[j];

                    if (indextime.Id >= 0) kpiData.DeletedItems.push({ Id: indextime.Id, Type: vmCommon.KpiGoalType.INDEXTIMEMASTER });
                }
            }

            topics.splice(topicIndex, 1);
        };

        var init = function (actionModel, topicType) {
            if (kpiSetting == undefined) {
                vmGoalAction.dataservice.getKpiData(null, function (res) {
                    kpiSetting = res.value;
                    sync(actionModel, topicType);
                });
            } else {
                sync(actionModel, topicType);
            }
        };

        return { init: init, clearTopic: clearTopic };
    }();

    vmEditAction.getSourceForSub = function (lst, status) {
        return $.grep(lst, function (it) { return it.IsSelect === status });
    };

    vmGoalAction.popAdvertiser = undefined;
    vmEditAction.openPopAdvertiser = function () {
        vmGoalAction.popAdvertiser = showPopup(vmGoalAction.popAdvertiser,
            $("#popadvertiser"),
            vmCommon.rootUrl + "Contents/MsPopSelectAdvertiser.html",
            {
                title: kLg.lblNameAdvertiser + '/' + kLg.lblKpiFormat,
                width: 650,
                height: 525,
                resizable: false
            }
        );
    };

    vmEditAction.setupValidate = function () {
        $('#fEditAction').validate({
            rules: {
                txtName: {
                    required: true,
                    maxlength: 130
                }
            },
            messages: {
                txtName: {
                    required: kLg.msgRequired,
                    maxlength: kLg.msgMaxlenghNameAction
                }
            }
        });
    };

    vmEditAction.formatTotalCost = function (cost, currency) {
        currency = currency || "";
        return currency + " " + vmCommon.formatOriginCost(cost);
    };
    function setPopupHeight() {
        vmEditAction.AdjustPopupHeight($('#fEditAction').height());
    };
    vmEditAction.AdjustPopupHeight = function (height) {
        if (vmGoalAction.popEditAction) {
            var modalfooterHeight = $('#area-edit-action .modal-market-footer').height() + 2;  // boder 1px
            var _height = height ? height : $('#area-edit-action .modal-body').height();
            var popupHeight = vmCommon.getPopupHeight(_height + 20, modalfooterHeight);
            $('#area-edit-action .modal-body').height(popupHeight - modalfooterHeight - 22);
            resizePopUp(vmGoalAction.popEditAction, { width: $('#area-edit-action').width(), height: popupHeight });
        }
    };
    function textAreaScaleHeight() {
        $('#txt-area-description').height($('#txt-area-description').get(0).scrollHeight);
        $('#txt-area-expectedeffect').height($('#txt-area-expectedeffect').get(0).scrollHeight);
        $('#txt-area-actualeffect').height($('#txt-area-actualeffect').get(0).scrollHeight);
    };
    vmEditAction.autoStyleForTodos = function (isBigger) {
        if (isBigger) {
            //todo-col1
            //Labels
            //$("#lblTodoDescription").css("width", "150px");
            $("#lblTodoDescription").css("margin-left", "15px");
            $("#lblTodoDescription").closest('div').css({ "width": "40%", "margin-right": " 41px" });
            //Values
            $(".todo-col1").css("width", "45%");
            $(".todo-col1 .todo-name").css("width", "351px");
            $(".todo-col1 .todo-name").css("margin-left", "15px");
            $(".todo-col1 span[class~='k-dropdown']").css("width", "163px");
            $(".todo-col1 span[class~='k-dropdown']").css("margin-left", "15px");

            //todo-col2
            //Labels
            $("#lblTodoFinish").closest('div').css("width", "29%");
            $("#lblTodoDueDate").closest('div').css("margin-left", "63px");
            $("#lblTodoFinish").closest('label').css("margin-right", "202px");
            //Values
            $(".todo-col2").css("width", "13%");
            $(".todo-col2 .xx1").css({ "width": "93px", "margin-left": "4px" });
            $(".todo-col2 span[class~='k-datepicker']").css("width", "98px");
            $(".todo-col2 .xx2").css("margin-left", "12px");
            $(".todo-col2 .xx3").css("margin-left", "25px");

            //todo-col3
            //Labels
            $("#lblTodoRespon").closest('div').css("width", "0%");
            $("#lblTodoRespon").css("margin-left", "-198px");
            //Values
            $(".todo-col3").css("width", "25%");
            $(".todo-col3 .xx1").css({
                "width": "64%",
                "margin-left": "14px",
                'max-width': ""
            });
            $(".todo-col3 .xx2 span[class~='icon-bin']").css("margin-right", "-10px");
        }
        else {
            //todo-col1
            //Labels
        //    $("#lblTodoDescription").css("width", "231px");
            $("#lblTodoDescription").css("margin-left", "0");
            $("#lblTodoDescription").closest('div').css("width", "40%");
            //Values
            $(".todo-col1").css("width", "40%");
            $(".todo-col1 .todo-name").css("width", "231px");
            $(".todo-col1 .todo-name").css("margin-left", "0");
            $(".todo-col1 span[class~='k-dropdown']").css("width", "118px");
            $(".todo-col1 span[class~='k-dropdown']").css("margin-left", "19px");

            //todo-col2
            //Labels
            $("#lblTodoFinish").closest('div').css("width", "19%");
            //Values
            $(".todo-col2").css("width", "19%");
            $(".todo-col2 .xx1").css("width", "120px");
            $(".todo-col2 span[class~='k-datepicker']").css("width", "118px");
            $(".todo-col2 .xx2").css("margin-left", "5px");
            $(".todo-col2 .xx3").css("margin-left", "20px");

            //todo-col3
            //Labels
            $("#lblTodoRespon").closest('div').css("width", "41%");
            $("#lblTodoRespon").css("margin-left", "0");
            //Values
            $(".todo-col3").css("width", "41%");
            $(".todo-col3 .xx1").css({
                "width": "66%",
                "margin-left": "10px",
                "max-width": ""
            });
            $(".todo-col3 .xx2 span[class~='icon-bin']").css("margin-right", "9px");
        }

        $("#area-edit-action .lblReminder").text(kLg.reminder);
        $("#area-edit-action .lblAssignInfo").text(kLg.assignInfo);
        vmEditAction.reloadTodoFilesIcon();
    };
    vmEditAction.AutoWidthByActionCost = function (flag) {
        var wForm = flag ? 1300 : 1080;

        vmGoalAction.popEditAction.wrapper.css({
            width: wForm
        });
        vmGoalAction.popEditAction.center();

        function bindInput() {
            $("#popEditAction .truecost input").css({ "width": (flag ? "107" : "164") + "px" });
        };

        //actioncost
        if (flag) {

            $("#popEditAction .descost").removeClass("hidden");

            $("#popEditAction .timecost").removeClass("col-md-6");
            $("#popEditAction .timecost").addClass("col-md-3");

            $("#popEditAction .truecost").removeClass("col-md-6");
            $("#popEditAction .truecost").addClass("col-md-3");

            //todos
            vmEditAction.autoStyleForTodos(true);

        } else {
            $("#popEditAction .descost input").val("");

            $("#popEditAction .descost").addClass("hidden");

            $("#popEditAction .timecost").removeClass("col-md-3");
            $("#popEditAction .timecost").addClass("col-md-6");

            $("#popEditAction .truecost").removeClass("col-md-3");
            $("#popEditAction .truecost").addClass("col-md-6");

            //todos
            vmEditAction.autoStyleForTodos(false);

            var actionCosts = vmEditAction.viewModel.get("action.ActionCosts");
            actionCosts.forEach(function (it) {
                it.set("Description", '');
                it.set("CategoryId", null);
            });
        }

        bindInput();
        //masterbudget
        vmEditAction.AutoWidthForMasterBudget();
        vmEditAction.visibleCostField(customViewOption.HasCost);
    };

    vmEditAction.AutoWidthByTodoCost = function (actionModel) {
        var flagCost = actionModel.ActionCosts.filter(t => t.DataState !== dataState.Deleted).length > 1;
        var flagTodo = actionModel.ActionTodos.filter(t => t.DataState !== dataState.Deleted).length > 0;

        var flag = flagCost || flagTodo;

        var wForm = flag ? 1300 : 1080;

        vmGoalAction.popEditAction.wrapper.css({
            width: wForm
        });
        vmGoalAction.popEditAction.center();

        function bindInput() {
            $("#popEditAction .truecost input").css({ "width": (flagCost ? "94" : flag ? "90" : "89") + "%" });
        };

        vmEditAction.autoStyleForTodos(flagTodo);

        if (flagCost) {
            $("#popEditAction .timecost").removeClass("col-md-6");
            $("#popEditAction .timecost").addClass("col-md-3");

            $("#popEditAction .truecost").removeClass("col-md-6");
            $("#popEditAction .truecost").addClass("col-md-3");

        } else {
            $("#popEditAction .timecost").removeClass("col-md-3");
            $("#popEditAction .timecost").addClass("col-md-6");

            $("#popEditAction .truecost").removeClass("col-md-3");
            $("#popEditAction .truecost").addClass("col-md-6");
        }

        if (flagCost) {
            $("#popEditAction .descost").removeClass("hidden");
        } else {
            $("#popEditAction .descost input").val("");
            $("#popEditAction .descost").addClass("hidden");

            var actionCosts = vmEditAction.viewModel.get("action.ActionCosts");
            actionCosts.forEach(function (it) {
                it.set("Description", '');
                it.set("CategoryId", null);
            });
        }
        
        bindInput();
        //masterbudget
        vmEditAction.AutoWidthForMasterBudget();
        vmEditAction.visibleCostField(customViewOption.HasCost);
    };

    vmEditAction.AutoWidthForMasterBudget = function () {
        var flag = $("#popEditAction").width() === 1300;

        $(".percentdiv").css({ "width": flag ? "77px" : "60px" });
        $(".percentdiv .k-input").css({ "width": flag ? "68px" : "51px" });
    };

    vmEditAction.theAction = {};

    vmEditAction.setLimitedDate = function (options) {
        if (options) {
            vmEditAction.theAction.OutMinDate = options.OutMinDate;
            vmEditAction.theAction.OutMaxDate = options.OutMaxDate;
        }
    };

    vmEditAction.getSubMarketMenu = function (regionId, successFunc) {
        vmEditAction.dataservice.getSubMarketMenu(regionId, successFunc);
    };

    vmEditAction.bindAdvertiserMenu = function (action, datas) {
        var rs = vmCommon.deepCopy(datas);
        if (action.Advertiser == null) return rs;

        var formatIds = action.Formats.filter(function (it) { return it.DataState != dataState.Deleted; }).map(function (it) { return it.KpiFormatId.toString(); });
        for (var i = 0; i < rs.length; i++) {
            var item = rs[i];

            if (((item.TypeId == 2 || item.TypeId == 1) && item.Id == action.Advertiser) || (item.TypeId == 3 && formatIds.indexOf(item.Id) >= 0)) {
                item.IsSelect = true;
            }
        }

        return rs;
    };

    vmEditAction.eConflict = {
        conflict: -1
    };

    vmEditAction.bindCustomView = function (views) {
        var cvTemp = new CustomView(views);
        cvTemp.HasMasterBudget = cvTemp.HasMasterBudget && isSelectMaster;
        cvTemp.HasRegion = cvTemp.HasRegion && isSelectRegion;

        return cvTemp;
    };

    function CustomView(views) {
        var temp = views || {};
        this.HasMasterBudget = temp[vmCommon.ActionCustomViewType.MASTERBUGET] != undefined && !vmGoalAction.actionOptions.isDisordered;
        this.HasProduct = temp[vmCommon.ActionCustomViewType.PRODUCT] != undefined;
        this.HasMarket = temp[vmCommon.ActionCustomViewType.MARKET] != undefined;
        this.HasDescription = temp[vmCommon.ActionCustomViewType.DESCRIPTION] != undefined;
        this.HasExpectedEffect = temp[vmCommon.ActionCustomViewType.EXPECTEDEFFECT] != undefined;
        this.HasActualEffect = temp[vmCommon.ActionCustomViewType.ACTUALEFFECT] != undefined;
        this.HasResponsibility = temp[vmCommon.ActionCustomViewType.RESPONSIBILITY] != undefined;
        this.HasInvolvedPeople = temp[vmCommon.ActionCustomViewType.INVOLVEDPEOPLE] != undefined;
        this.HasCategory = temp[vmCommon.ActionCustomViewType.CATEGORY] != undefined;
        this.HasField = temp[vmCommon.ActionCustomViewType.FIELD] != undefined;
        this.HasAdvertising = temp[vmCommon.ActionCustomViewType.ADVERTISING] != undefined;
        this.HasAdvertiser = temp[vmCommon.ActionCustomViewType.ADVERTISER] != undefined;
        this.HasSubjectThema = temp[vmCommon.ActionCustomViewType.SUBJECTTHEMA] != undefined;
        this.HasRegion = temp[vmCommon.ActionCustomViewType.REGION] != undefined && !vmGoalAction.actionOptions.isDisordered;
        this.HasCost = temp[vmCommon.ActionCustomViewType.COST] != undefined;
        this.HasUpStream = temp[vmCommon.ActionCustomViewType.UPSTREAM] != undefined && !vmGoalAction.actionOptions.isDisordered;
        this.HasResourcePlanning = temp[vmCommon.ActionCustomViewType.RESOURCEPLANNING] != undefined && !vmGoalAction.actionOptions.isDisordered;
        this.HasVisibility = temp[vmCommon.ActionCustomViewType.VISIBILITY] != undefined && !vmGoalAction.actionOptions.isDisordered;
        this.HasCustomerJourney = temp[vmCommon.ActionCustomViewType.CUSTOMERJOURNEY] != undefined;

        //#region label language
        let lbl = temp[vmCommon.ActionCustomViewType.DESCRIPTION];
        lbl = typeof lbl == 'object' ? lbl.Label : '';
        this.LabelDescription = lbl ? lbl : kLg.labelDes;

        lbl = temp[vmCommon.ActionCustomViewType.ACTIVITY];
        lbl = typeof lbl == 'object' ? lbl.Label : '';
        this.LabelActivity = lbl ? lbl : kLg.titleSubActionActivity;
        lbl = lbl ? htmlEscape(lbl) : '';
        this.LblTooltipActivity = lbl ? kLg.AddNewTxt.replaceAll("{0}", lbl) : kLg.addnewactivity;

        lbl = temp[vmCommon.ActionCustomViewType.TODO];
        lbl = typeof lbl == 'object' ? lbl.Label : '';
        this.LabelTodo = lbl ? lbl : kLg.titleToDos;
        lbl = lbl ? htmlEscape(lbl) : '';
        this.LblTooltipTodo = lbl ? kLg.AddNewTxt2.replaceAll("{0}", lbl) : kLg.addnewtodo;
        //#endregion

        return this;
    };

    vmEditAction.visibleCostField = function (state) {
        if (state) {
            $(".truecost").removeClass("hidden");
        } else {
            $(".truecost").addClass("hidden");
        }
    };

    vmEditAction.formatService = function () {
        var formats = [];

        var init = function (lst) {
            formats = lst;
        };

        var clear = function () {
            for (var i = formats.length - 1; i >= 0; i--) {
                var temp = formats[i];

                if (temp.Id > 0) temp.DataState = dataState.Deleted;
                else formats.splice(i, 1);
            }
        };

        var add = function (formatId) {
            var temp = vmCommon.findByFunc(formats, function (it) { return it.KpiFormatId == formatId; });

            if (temp == null)
                formats.push({ Id: 0, ActionId: null, KpiFormatId: formatId, DataState: dataState.Added });
            else
                if (temp.DataState == dataState.Deleted) temp.DataState = dataState.Unchanged;
        };

        var getData = function () {
            return formats;
        };

        return { init: init, clear: clear, getData: getData, add: add };
    }();

    vmEditAction.getCategorySrc = function () {
        var src = vmGoalAction.setting.ActionCategory;
        var view = customViews[vmCommon.ActionCustomViewType.CATEGORY];
        if (view && view.DefaultValue) {
            var ids = view.DefaultValue.split(",").map(t => Number(t)).filter(t => t > 0);
            if (ids.length)
                return src.filter(t => ids.indexOf(t.Id) >= 0);
        }

        return src;
    };

    var customViews, customViewOption, actionDefaultValue, actionPlanRegions = [];
    var landregionMenuData = [];
    vmGoalAction.kpiActionSettings = undefined;
    var isHasKpi = false;
    
    vmEditAction.getAdvertiserSrc = function (advertisingIds) {
        return vmGoalAction.setting.ActAdvertiser.filter(t => advertisingIds.indexOf(t.ParentId) >= 0)
    };
    
    $(function () {
        //Clear files cache
        if (vmFile && vmFile.idFileAssigned && vmFile.idFileAssigned.contents) {
            vmFile.idFileAssigned.contents = [];
        }

        var oldConnection = [];
        var oldPeople = [];
        vmEditAction.modelChanged = false;
        vmEditAction.valid = true;
        vmGoalAction.fibuOptions = {};

        customViews = vmGoalAction.actionOptions.customViews;
        isSelectRegion = vmGoalAction.actionOptions.regionSelectable;
        actionPlanRegions = vmGoalAction.actionOptions.actionPlanRegions;
        actionDefaultValue = vmGoalAction.actionOptions.actionDefaultValue || { Instrument: null, AdvertisingMaterial: null, Advertiser: null, AdvertiserName: "", KpiData: [{ IsEmpty: true }] };

        vmEditAction.lstAccounts = vmCommon.pushApply([], vmGoalAction.setting.Accounts, function (item) { return { AccountId: item.Id, Name: item.Name, Email: item.Email, FirstName: item.FirstName, LastName: item.LastName }; });

        var columnId = vmGoalAction.actionOptions.columnId;
        var color = vmGoalAction.actionOptions.fromBoard || vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan) ? "#B8C92E" : "#b8c92e";    // Khach hang yeu cau mau cu~, ngai xoa' qua' nen doi 1FD4AF thanh B8C92E
        if (vmGoalAction.actionOptions.isEdit || vmGoalAction.actionOptions.fromBoard) {
            vmEditAction.theAction = vmGoalAction.actionOptions.action;
            vmEditAction.theAction.ActionPlanColumnId = columnId;
            vmEditAction.theAction.SubMarketProductId = vmGoalAction.actionOptions.subMarketProductId;
            vmEditAction.theAction.IndependencyId = vmGoalAction.actionOptions.independencyId;
            oldPeople = vmCommon.pushApply([], vmEditAction.theAction.People, function (item) { return { AccountId: item.AccountId, Email: item.Email, FirstName: item.FirstName, LastName: item.LastName }; });
            if (vmEditAction.theAction.ActionCosts.length === 0) {
                vmEditAction.theAction.ActionCosts.push(new ActionCost(new Date()));
            }
            if (vmGoalAction.actionOptions.fromBoard) {
                vmEditAction.theAction.Color = color;
            }
            if(!!vmCommon.ObjEditAction) {
                vmEditAction.theAction.Id = vmCommon.ObjEditAction.Id;
                vmEditAction.theAction.GetId = vmCommon.ObjEditAction.Id;
                vmEditAction.theAction.Name = vmCommon.ObjEditAction.Name;
                vmEditAction.theAction.Description = vmCommon.ObjEditAction.Description;
                vmEditAction.theAction.ExpectedEffect = vmCommon.ObjEditAction.ExpectedEffect;
                vmEditAction.theAction.ActionActualEffect = vmCommon.ObjEditAction.ActionActualEffect;
                vmEditAction.theAction.MaingoalId = vmCommon.ObjEditAction.MaingoalId;
                vmEditAction.theAction.GoalId = vmCommon.ObjEditAction.GoalId;
                vmEditAction.theAction.ActualCost = vmCommon.ObjEditAction.ActualCost;
                vmEditAction.theAction.ExpectedCost = vmCommon.ObjEditAction.ExpectedCost;
                vmEditAction.theAction.AdvertiserName = vmCommon.ObjEditAction.AdvertiserName;
                vmEditAction.theAction.AdvertisingName = vmCommon.ObjEditAction.AdvertisingName;
                vmEditAction.theAction.Start = vmCommon.ObjEditAction.Start ? vmCommon.ObjEditAction.Start.jsonToDate():null;
                vmEditAction.theAction.End = vmCommon.ObjEditAction.End ? vmCommon.ObjEditAction.End.jsonToDate():null;
            }
        } else {
            vmEditAction.theAction = {
                Name: '',
                IsCalendar: vmGoalAction.actionOptions.isCalendar != undefined ? vmGoalAction.actionOptions.isCalendar : true,
                Visibility: true,
                Finish: false,
                Categories: [],
                Fields: [],
                Instrument: actionDefaultValue.Instrument || 0,
                SubjetThema: null,
                Start: new Date(),
                End: new Date(),
                Evaluation: -1,
                Description: '',
                ExpectedEffect: '',
                ActualEffect: '',
                ExpectedCost: 0,
                ActualCost: 0,
                People: [],
                PeopleInvolved: [],
                Status: [],
                OutMinDate: null,
                OutMaxDate: null,
                Advertiser: actionDefaultValue.Advertiser,
                AdvertiserName: actionDefaultValue.AdvertiserName,
                KpiFormatId: null,
                AdvertisingMaterial: actionDefaultValue.AdvertisingMaterial,
                ActionUpStreamConnect: null,
                NumberOfDay: 0,
                SubProducts: [],
                Color: vmGoalAction.actionOptions.action ? (vmGoalAction.actionOptions.action.Color ? vmGoalAction.actionOptions.action.Color : color) : color,
                MasterId: null,
                FibuSupplier: "",
                FibuDescription: "",
                ActionCosts: [new ActionCost(vmGoalAction.actionOptions.parentStart)],
                MasterBudgets: [],
                KpiData: actionDefaultValue.KpiData || [],
                KpiMasterData: actionDefaultValue.KpiMasterData,
                ActionPlanRegions: [],
                GoalId: vmGoalAction.actionOptions.goalId,
                ActionTodos: [],
                Formats: [],
                ActionPlanColumnId: columnId,
                Links: [],
                CreatedDate: new Date(),
                BoardColumnId: vmGoalAction.actionOptions.isDisordered ? vmGoalAction.actionOptions.boardColumnId : null
            };

            void function validCreatedDate() {
                var a = vmEditAction.theAction.CreatedDate;
                if (typeof a == "string") {
                    var b = a.replace('/Date(', '');
                    b = b.replace(')/', '');
                    b = +b; //  convert to integer
                    if (b < 0) {
                        vmEditAction.theAction.CreatedDate = new Date();
                    }
                }
            }();
            if (vmGoalAction.actionOptions.parentMasterId) {
                var inheritMaster = new MasterBudget();
                inheritMaster.MasterId = vmGoalAction.actionOptions.parentMasterId;
                inheritMaster.MPercent = 100;

                vmEditAction.theAction.MasterBudgets.push(inheritMaster);
            }
        }

        // add icon evaluation
        createEvaluationIcon();
        var subjetThemaObj = vmCommon.findByFunc(vmGoalAction.setting.SubjetThemas, function (it) { return it.Id === vmEditAction.theAction.SubjetThema; });

        for (var i = 0; i < vmEditAction.theAction.SubProducts.length; i++) {
            var actionItem = vmEditAction.theAction.SubProducts[i];
            for (var k = 0; k < vmGoalAction.actionOptions.customConnection.length; k++) {
                var subItem = vmGoalAction.actionOptions.customConnection[k];
                if (actionItem.SubProductId === subItem.SubProductId && actionItem.Type === subItem.Type) {
                    actionItem.Id = subItem.Id;

                    oldConnection.push(actionItem);
                }
            }
            if (actionItem.Id === 0) {
                actionItem.DataState = dataState.Modified;
            }
        }

        for (var j = 0; j < vmEditAction.theAction.Status.length; j++) {
            vmEditAction.theAction.Status[j].IsOrigin = true;
            vmEditAction.theAction.Status[j].Description = vmEditAction.theAction.Status[j].Description || kLg.labelComment;
        }

        vmEditAction.actionUpStreamId = vmEditAction.theAction.ActionUpStreamConnectionAction != null ? vmEditAction.theAction.ActionUpStreamConnectionAction.ActionId : null;
        vmEditAction.isConnect = vmEditAction.theAction.ActionUpStreamConnectionAction != null ? true : false;

        vmEditAction.paths = vmEditAction.theAction.UpPaths != null ? vmEditAction.theAction.UpPaths : null;

        $("#picker").kendoColorPicker({
            buttons: false,
            columns: 9,
            tileSize: 25,
            palette: colorPaletteAction,
            open: function (e) {
                $("#picker").data("kendoColorPicker").isClosed = false;
            },
            close: function (e) {
                $("#picker").data("kendoColorPicker").isClosed = true;
            }
        });

        isSelectMaster = (vmGoalAction.actionOptions.masterGoal ? true : false) && vmGoalAction.actionOptions.hasMasterGoal;

        vmGoalAction.GoalMaster.FirstCost = vmEditAction.theAction.ActualCost;
        vmGoalAction.GoalMaster.FirstIds = vmCommon.selectProperty(vmEditAction.theAction.MasterBudgets, "MasterId");

        vmEditAction.theAction.Start = vmCommon.toDateUtc(vmEditAction.theAction.Start);
        vmEditAction.theAction.End = vmCommon.toDateUtc(vmEditAction.theAction.End);

        var actionSelect = null;
        if (vmEditAction.actionUpStreamId != null) {
            for (var i = 0; i < vmGoalAction.actionOptions.actionStream.length; i++) {
                if (vmGoalAction.actionOptions.actionStream[i].Id == vmEditAction.actionUpStreamId) {
                    actionSelect = vmGoalAction.actionOptions.actionStream[i];
                    break;
                }
            }
        }

        if (actionSelect == null && vmEditAction.theAction.ActionUpStreamConnectionAction != null) {
            actionSelect = { Name: vmEditAction.theAction.ActionUpStreamConnectionAction.ActionName };
        }
        var isSelect = false;
        //subproduct
        var subProductGroups = vmGoalAction.actionOptions.subProductGroups;
        var autoSubSrc = vmEditAction.getSourceForSub(subProductGroups, false),
            labeSubSrc = vmEditAction.getSourceForSub(subProductGroups, true);

        //actionplanregion
        var regionGroups = actionPlanRegions;
        var autoRegionSrc = vmEditAction.getSourceForSub(regionGroups, false),
            labeRegionSrc = vmEditAction.getSourceForSub(regionGroups, true);

        //subclient
        var subClientGroups = vmGoalAction.actionOptions.subClientGroups;
        //var isVisibleClient = true;

        var autoClientSrc = vmEditAction.getSourceForSub(subClientGroups, false),
            labeClientSrc = vmEditAction.getSourceForSub(subClientGroups, true);

        //cutomer journey
        var customerJourneyGroups = vmGoalAction.actionOptions.customerJourneyGroups;
        var autoCusSrc = vmEditAction.getSourceForSub(customerJourneyGroups, false),
            labeCusSrc = vmEditAction.getSourceForSub(customerJourneyGroups, true);

        //crm client
        var crmClientItem = undefined;
        for (var i = labeClientSrc.length - 1; i >= 0; i--) {
            var item = labeClientSrc[i];

            if (item.TypeId === 4 || item.TypeId === 5 || item.TypeId === 6) {
                crmClientItem = item;
                crmClientItem.groupClass = "group-crm";

                labeClientSrc.splice(i, 1);
                break;
            }
        }

        var totalExpCost = 0, totalActCost = 0;
        if (vmEditAction.theAction.ActionCosts) {
            for (var i = 0, len = vmEditAction.theAction.ActionCosts.length; i < len; i++) {
                totalExpCost += vmEditAction.theAction.ActionCosts[i].ExpectedCost;
                totalActCost += vmEditAction.theAction.ActionCosts[i].ActualCost;
                vmEditAction.theAction.ActionCosts[i].IsConnectionUp = vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit ? true : vmEditAction.theAction.ActionCosts[i].IsConnectionUp;

                vmEditAction.theAction.ActionCosts[i].IsShowAddCost = false;
                if (i == len - 1 && vmEditAction.theAction.ActionCosts[i].DataState != dataState.Deleted) {
                    vmEditAction.theAction.ActionCosts[i].IsShowAddCost = true;
                }

            }
        }
        vmEditAction.theAction.ExpectedCost = totalExpCost;
        vmEditAction.theAction.ActualCost = totalActCost;

        // re-calculate master cost
        if (vmGoalAction.actionOptions.masterGoal) {
            var masters = vmGoalAction.actionOptions.masterGoal || [];
            for (var i = 0; i < masters.length; i++) {
                var mb = vmCommon.findByFunc(vmEditAction.theAction.MasterBudgets, function (it) { return it.MasterId === masters[i].Id; });
                if (mb) {
                    masters[i].ExpectedCost = masters[i].ExpectedCost - ((totalExpCost * mb.MPercent) / 100) * vmEditAction.getRating(masters[i].Currency, msCurrency);
                    masters[i].ActualCost = masters[i].ActualCost - ((totalActCost * mb.MPercent) / 100) * vmEditAction.getRating(masters[i].Currency, msCurrency);
                }
            }
        }

        //bind master source
        if (vmEditAction.theAction.MasterBudgets.length === 0) {
            var newMaster = new MasterBudget();
            newMaster.MPercent = 100;
            vmEditAction.theAction.MasterBudgets.push(newMaster);
        } else {
            maxMasterIndex = vmEditAction.theAction.MasterBudgets && vmEditAction.theAction.MasterBudgets.length > 0 ? vmEditAction.theAction.MasterBudgets.first().MIndex : 0;
        }

        isAutoPercent = vmEditAction.theAction.MasterBudgets.length === 1;
        rebindMasterSource(vmEditAction.theAction.MasterBudgets, vmGoalAction.actionOptions.masterGoal || []);

        maxIndex = vmEditAction.theAction.ActionCosts.length ? vmEditAction.theAction.ActionCosts.last().MIndex : 0;
        customViewOption = vmEditAction.bindCustomView(customViews);

        var isVisibleKpi = vmGoalAction.actionOptions.isHasKpi && vmEditAction.theAction.AdvertisingMaterial != null && vmEditAction.theAction.AdvertisingMaterial > 0 && vmEditAction.theAction.Advertiser != null && vmEditAction.theAction.Advertiser > 0;

        if (vmEditAction.theAction.ActionTodos) {
            setTimeout(function () {
                for (var i = 0; i < vmEditAction.theAction.ActionTodos.length; i++) {
                    bindCustomPersonInputEvent(vmEditAction.theAction.ActionTodos[i].Id);
                }
            }, 750);
        }

        //17.05.2019
        var hasDisabledStreamCon = vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit || hasActionCostDateInvalid(vmEditAction.theAction.ActionCosts);

        var listActAdvertisingMaterial = vmGoalAction.setting.ActAdvertisingMaterial;//defaultAdvertising
        if (vmEditAction.theAction.Instrument > 0 && customViews) {
            var advs = customViews[vmCommon.ActionCustomViewType.ADVERTISING];
            let sDefaultAdv = !!advs && typeof advs == 'object' ? advs.DefaultValue : '';
            var defaultAdvertising = sDefaultAdv ? sDefaultAdv.split(',').filter(e => { return e != ''; }) : [];
            if (defaultAdvertising.length > 0) {
                defaultAdvertising = defaultAdvertising.map(f => { return Number(f); });
            } else
                defaultAdvertising = [];

            if (defaultAdvertising.length > 1) {
                listActAdvertisingMaterial = vmGoalAction.setting.ActAdvertisingMaterial.filter(a => {
                    return defaultAdvertising.includes(a.Id) || a.Id < 0;
                });
            };
        }
        
        vmCommon.LstKpiData = vmCommon.deepCopy(vmEditAction.theAction.KpiData);

        vmEditAction.viewModel = kendo.observable({
            hasLink: !vmGoalAction.actionOptions.isDisordered && (vmEditAction.theAction.Visibility || vmEditAction.theAction.Links.some(t => t.IsShow)),
            //TemplateId: null,
            isDisordered: vmGoalAction.actionOptions.isDisordered == true,
            isHasKpi: vmGoalAction.actionOptions.isHasKpi,
            isHasKpiSecond: !customViewOption.HasExpectedEffect && !customViewOption.HasActualEffect && vmGoalAction.actionOptions.isHasKpi,

            isSyncSelectable: vmGoalAction.actionOptions.isHasKpi && vmGoalAction.actionOptions.role >= vmCommon.MemberRole.Edit,
            checkHasOutSideConnect: function () {
                return this.isHasKpi && (this.labeRegionSrc.length > 0 || this.labeSubSrc.length > 0 || this.labeClientSrc.length > 0);
            },
            setVisibleKpi: function () {
                this.set("isVisibleKpi", this.isHasKpi && this.action.AdvertisingMaterial != null && this.action.AdvertisingMaterial > 0 && this.action.Advertiser != null && this.action.Advertiser > 0);
            },
            customViewOption: customViewOption,
            isVisibleKpi: isVisibleKpi,
            isVisibleSelectedRegion: labeRegionSrc.length > 0,
            isVisibleSelectedSub: labeSubSrc.length > 0,
            isVisibleSelectedClient: labeClientSrc.length > 0 || crmClientItem,
            isVisibleSelectedCus: labeCusSrc.length > 0,
            crmClientItem: crmClientItem,
            actionSelectName: actionSelect == null ? null : actionSelect.Name,
            actionSelect: actionSelect,
            actionStream: vmGoalAction.actionOptions.actionStream,
            autoRegionValue: null,
            tempRegionValue: null,
            autoSubValue: null,
            tempSubValue: null,
            autoClientValue: null,
            tempClientValue: null,
            autoCusValue: null,
            tempCusValue: null,
            budgetInfo: findMasterGoalInfo(1, vmGoalAction.actionOptions.masterGoal, vmEditAction.theAction.MasterId),
            etCostInfo: findMasterGoalInfo(2, vmGoalAction.actionOptions.masterGoal, vmEditAction.theAction.MasterId),
            atCostInfo: findMasterGoalInfo(3, vmGoalAction.actionOptions.masterGoal, vmEditAction.theAction.MasterId),

            autoRegionSrc: autoRegionSrc,
            labeRegionSrc: labeRegionSrc,
            autoSubSrc: autoSubSrc,
            labeSubSrc: labeSubSrc,
            autoClientSrc: autoClientSrc,
            labeClientSrc: labeClientSrc,
            autoCusSrc: autoCusSrc,
            labeCusSrc: labeCusSrc,
            displaySrc: [],
            displayClientSrc: [],
            displayCusSrc: [],
            IsFileAssignedRole: vmGoalAction.actionOptions.isEdit && (vmGoalAction.actionOptions.role > 0 || (vmEditAction.theAction.Files && vmEditAction.theAction.Files.length > 0)),
            fileAssignHref: `javascript:vmFile.openFileAsignCrm(${vmFile.idFileAssigned.assignidi ? vmFile.idFileAssigned.assignidi : (vmFile.idFileAssigned.assignidu)}) , ${vmFile.idFileAssigned.assigntype})`,
            isSaveTemplate: vmGoalAction.actionOptions.isEdit,
            templateId: null,
            templateSource: vmGoalAction.actionOptions.templates || [],
            isActiveTemp: (vmGoalAction.actionOptions.templates != null && vmGoalAction.actionOptions.templates.length > 0) && (vmGoalAction.actionOptions.role >= vmCommon.MemberRole.Edit),
            saveTemplate: function () {
                var action = vmCommon.deepCopy(vmEditAction.viewModel.get("action"));

                if (!isValidDate() || !$("#fEditAction").valid() || !vmEditAction.valid || !isValidStream() || !isValidSub()
                    || !isValidClient() || !isValidStatus() || !vmEditAction.validMasterBudget()) {
                    if ($('#txtName').val() === "") {
                        $('#txtName').focus();
                    }
                    return;
                }

                var subjetThemaName = vmEditAction.viewModel.get("subjetThemaName");
                var subjetThemaObj = vmCommon.findByFunc(vmGoalAction.setting.SubjetThemas, function (it) { return it.Name === subjetThemaName; });
                if (subjetThemaName !== null && subjetThemaName.length > 0 && subjetThemaObj === null) {
                    $("#acSubjetThema").tooltip('destroy');
                    $("#acSubjetThema").attr("title", kLg.InvalidData);
                    $("#acSubjetThema").tooltip({ trigger: "manual" }).tooltip('show');
                    return;
                }
                if (subjetThemaObj != null)
                    action.SubjetThema = subjetThemaObj.Id;
                else
                    action.SubjetThema = 0;

                popName(kLg.titleSaveTemplate).then(function () {
                    if (action.Status.length > 0) {
                        var sStatus = [];
                        for (var sidx = 0; sidx < action.Status.length; sidx++) {
                            if (action.Status[sidx].IsNew) action.Status[sidx].Id = vmCommon.emptyGuid;

                            if (action.Status[sidx].IsOrigin === false) {
                            }
                            else {
                                sStatus.push(action.Status[sidx]);
                            }
                        }

                        action.Status = sStatus;
                    }

                    action.ActionPlanRegions = vmCommon.deepCopy(vmEditAction.viewModel.labeRegionSrc);
                    action.SubProductGroups = vmCommon.deepCopy(vmGoalAction.subService.dataSelected());
                    action.SubClientGroups = vmCommon.deepCopy(vmGoalAction.subService.dataClientSelected());
                    action.CustomerJourneyGroups = vmCommon.deepCopy(vmGoalAction.subService.dataCusSelected());
                    if (action.AdvertisingMaterial == null)
                        action.ActionAdvertisers = [];
                    else if (action.AdvertisingMaterial != -2)
                        action.ActionAdvertisers = [{ Id: action.Advertiser, Name: action.AdvertiserName, ParentId: action.AdvertisingMaterial }];
                    
                    var actionEntry = {
                        Template: { Name: popName.Data },
                        Action: action,
                        ActionType: vmCommon.GoalType.Action
                    };
                    vmEditAction.dataservice.createTemplate(actionEntry, function (res) {

                        if (res.value) {
                            var source = vmEditAction.viewModel.get("templateSource") || [];
                            source.push(res.value);
                            vmEditAction.viewModel.set("templateSource", source);
                            vmEditAction.viewModel.set("isActiveTemp", true);
                            //vmEditAction.viewModel.set("templateId", res.value);
                        }
                    });
                    return;
                });
            },
            selectTemplate: function (e) {
                if (e.sender._oldIndex === 0) {
                    vmEditAction.viewModel.set("templateId", null);

                    vmFile.reLoadFileAssigned();
                    return;
                }

                var temp = e.data.templateId;

                if (temp) {
                    ynConfirmTemp(kLg.msgConfirmApplyNewTemplate).then(function () {
                        var actiontemp = vmEditAction.TempCache[temp.Id];
                        if (actiontemp) {
                            vmEditAction.bindActionTemplateData(actiontemp);
                            return;
                        }

                        var edate = $('#txtNewStartDate').data("kendoDatePicker").value();
                        var year = edate.getFullYear();
                        var month = (1 + edate.getMonth()).toString();
                        month = month.length > 1 ? month : '0' + month;
                        var day = edate.getDate().toString();
                        day = day.length > 1 ? day : '0' + day;
                        var newStartDate = month + '/' + day + '/' + year;

                        var curAction = vmEditAction.viewModel.get("action");

                        vmEditAction.dataservice.getTemplates({ CurrentActionId: curAction.Id, ActionId: temp.Value, TemplateId: temp.Id, NewStartDate: newStartDate, independencyId: vmGoalAction.actionOptions.independencyId, subMarketProductId: vmGoalAction.actionOptions.subMarketProductId, subGoalId: vmGoalAction.actionOptions.goalId }, function (res) {
 
                            if (res.value) {
                                vmEditAction.viewModel.set("templateId", temp);
                                vmEditAction.TempCache[temp.Id] = res.value;
                                vmEditAction.theAction.DateSpace = res.value.Action.DateSpace;
                                vmEditAction.viewModel.action.ActionPlanEvalData = res.value.Action.ActionPlanEvalData;
                
                                vmEditAction.bindActionTemplateData(res.value);
                                $('#tablecost .row.row-cost:not([style*="display: none;"])').last().find('.btnaddcost').show();
                            }
                        });

                    }, function () {
                        vmEditAction.viewModel.set("templateId", null);
                    });
                }
            },
            deleteTemplate: function () {
                var temps = vmEditAction.viewModel.get("templateSource") || [];

                var template = kendo.template($("#actionTemplateChooser").html());
                $("#popEditTemplate").html(template(temps));

                vmEditAction.popTemplate = $("#popEditTemplate").kendoWindow({
                    modal: true,
                    title: kLg.DeleteTemplate,
                    height: 360,
                    width: 600,
                    scrollable: false,
                    resizable: false
                }).getKendoWindow();

                vmEditAction.popTemplate.center().open();

                vmEditAction.popTemplate.bind("close", function (e) {
                    vmEditAction.closePopTemplate();
                });
            },
            listTodoPersons: vmGoalAction.actionOptions.actionTodoDataX,
            addActionTodos: function () {
                if (this.roleEdit) {
                    return;
                }
                var todos = {
                    Id: vmCommon.getNewId(this.action.ActionTodos),
                    Name: '',
                    CategoryId: 0,
                    DueDate: null,
                    Finish: false,
                    IsShowReminderX: false,
                    Persons: [],
                    Files: [],
                    Reminder: {},
                    MIndex: 0
                };
                this.action.ActionTodos.push(todos);
                vmEditAction.changeKpiActionBySI(this.action);

                vmCommon.updatePosition(this.action.ActionTodos);
                var aCosts = vmCommon.findAllByFunc([], this.action.ActionCosts, function (x) { return x.DataState !== dataState.Deleted; });
                vmEditAction.autoStyleForTodos(aCosts.length > 1);
                
                $('#btnaddtodo').insertAfter($('#todostablecost'));       // prevent rebind data will lose btnaddtodo

                var isExpandWidth = $.grep(vmEditAction.viewModel.action.ActionTodos, function (it) { return it.DataState !== dataState.Deleted; }).length > 0;
                if (!isExpandWidth) {

                    var actionLocal = vmEditAction.viewModel.get("action");

                    for (var h = 0; h < actionLocal.ActionTodos.length; h++) {
                        if (actionLocal.ActionTodos[h].DataState !== dataState.Deleted) {
                            actionLocal.ActionTodos[h].Description = "";
                            if (actionLocal.ActionTodos[h].DataState !== dataState.Added)
                                actionLocal.ActionTodos[h].DataState = dataState.Modified;
                        }
                    }

                    vmEditAction.viewModel.set("action", actionLocal);
                    this.action.ActionCosts = actionLocal.ActionCosts;
                }

                vmEditAction.AutoWidthByTodoCost(this.action);

                bindCustomPersonInputEvent(todos.Id);

                setPopupHeight();
                
                setBlurTodoDateChange();
                var $rowtodoicon = $("#todostablecost .row.todos").last();

                if ($rowtodoicon.length > 0) {
                    var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
                    $('#btnaddtodo').insertAfter($icondeletewhentodo);
                    $('.popover.fade.top.in').remove();
                    $('#btnaddtodo').css({ "right": "6px", "margin-top": "0px" });
                    
                }
            },
            removeActionTodos: function (e) {
                if (this.roleEdit) {
                    return;
                }
                var index = this.action.ActionTodos.indexOf(e.data);

                if (index === -1) return;

                $('#btnaddtodo').insertAfter($('#todostablecost')); // truoc khi xoa thi phai dua ra ngoai #todostablecost
                this.action.ActionTodos.splice(index, 1);       // xoa todo
                
                var $rowtodoicon = $("#todostablecost .row.todos").last();
                if ($rowtodoicon.length > 0) {
                    var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
                    $('#btnaddtodo').insertAfter($icondeletewhentodo);
                    $('#btnaddtodo').css({ "right": "6px", "margin-top": "0px" });
                } else {
                    $('#btnaddtodo').css({ "right": "14px", "margin-top": "0px"});
                }

                vmEditAction.changeKpiActionBySI(this.action);

                setPopupHeight();

                vmEditAction.AutoWidthByTodoCost(this.action);

            },
            changeTodoDueDate: function (e) {
                for (var i = 0; i < this.action.ActionTodos.length; i++) {
                    if (e.data.Id == this.action.ActionTodos[i].Id) {

                        var flag = checkShowTodoReminder(this.action.ActionTodos[i]);
                        this.action.ActionTodos[i].IsShowReminderX = flag;
                        var $reminder = $(e.sender.element[0]).closest('div.todo-col2').find('.reminder');
                        if (flag) {
                            $reminder.css("display", "block");
                        } else {
                            $reminder.css("display", "none");
                        }
                        break;
                    }
                }
            },
            changeTodoFinish: function (e) {
                for (var i = 0; i < this.action.ActionTodos.length; i++) {
                    if (e.data.Id == this.action.ActionTodos[i].Id) {

                        var flag = checkShowTodoReminder(this.action.ActionTodos[i]);
                        this.action.ActionTodos[i].IsShowReminderX = flag;
                        var $reminder = $(e.currentTarget).closest('div.todo-col2').find('.reminder');
                        if (flag) {
                            $reminder.css("display", "block");
                        } else {
                            $reminder.css("display", "none");
                        }
                        break;
                    }
                }

                vmEditAction.changeKpiActionBySI(this.action);
                
            },
            openTodoFileAssign: function (e) {
                var todoFiles = e.data.Files.map(t => {
                    return {
                        Id: t.FileId,
                        Name: t.FileName,
                        PhysicalName: t.FilePhysicalName,
                        Description: t.FileDescription,
                        Type: t.FileType,
                        ParentId: t.FileParentId,
                        ProjectId: t.FileProjectId,
                        MIndex: t.FileMIndex,
                        FromAssigned: t.FromAssigned,
                        CreatedBy: t.FileCreatedBy,
                        CreatedDate: t.FileCreatedDate,
                        Mdf: t.FileMdf
                    };
                });

                vmFile.idFileAssigned.assigntype = vmCommon.enumType.ActionTodoFile;
                vmFile.idFileAssigned.assignidi = e.data.Id;
                vmFile.idFileAssigned.otherId = 0;
                vmFile.oldAssignedFile = vmCommon.deepCopy(todoFiles);
                vmFile.contentFileAssigned = vmCommon.deepCopy(todoFiles);
                vmFile.idFileAssigned.contents = vmCommon.deepCopy(todoFiles);

                vmFile.idFileAssigned.fileids = todoFiles.map(t => "cbx" + t.Id);
                vmFile.idFileAssigned.func = function (files) {
                    e.data.set("Files", files.map(t => {
                        return {
                            FileId: t.Id,
                            FileName: t.Name,
                            FilePhysicalName: t.PhysicalName,
                            FileDescription: t.Description,
                            FileType: t.Type,
                            FileParentId: t.ParentId,
                            FileProjectId: t.ProjectId,
                            FileMIndex: t.MIndex,
                            FromAssigned: t.FromAssigned,
                            FileCreatedBy: t.CreatedBy,
                            FileCreatedDate: t.CreatedDate,
                            FileMdf: t.Mdf
                        };
                    }));

                    if (e.data.Files.length > 0) {
                        $(".todo-col3 .xx2 span[fopenid~='" + e.data.Id + "']").attr("hasFile", "true");
                    }

                    var styleClass = e.data.Files.length > 0 ? "icon-assignedfile-circle" : "icon-folder-circle";
                    $(".todo-col3 .xx2 span[hasFile][fopenid~='" + e.data.Id + "']").removeClass("icon-folder-circle");
                    $(".todo-col3 .xx2 span[hasFile][fopenid~='" + e.data.Id + "']").removeClass("icon-assignedfile-circle");
                    $(".todo-col3 .xx2 span[hasFile][fopenid~='" + e.data.Id + "']").addClass(styleClass);
                };

                if (vmFile.oldAssignedFile.length > 0) {
                    vmFile.openPopUpFileAssign();
                } else {
                    vmFile.openPopUpToAssign('openassign');
                }

            },
            changeTodoResponsibility: function (e) {
                var item = e.data;
                if (item) {
                    var listAcc = vmCommon.deepCopy(item.Persons).sort(SortByLastName);
                    var vmtodos = vmEditAction.viewModel.get("action.ActionTodos");
                    var atodos = vmCommon.deepCopy(vmtodos);;
                    for (var i = 0; i < atodos.length; i++) {
                        atodos[i].DueDate = vmtodos[i].DueDate;
                        if (atodos[i].Id == item.Id) {
                            atodos[i].Persons = listAcc;
                            atodos[i].IsShowReminderX = checkShowTodoReminder(atodos[i]);
                        }
                    }
                    $('#btnaddtodo').insertAfter($('#todostablecost'));       // prevent rebind data will lose btnaddtodo
                    vmEditAction.viewModel.set("action.ActionTodos", atodos);

                    //KhanhGVtodo
                    var $rowtodoicon = $("#todostablecost .row.todos").last();
                    if ($rowtodoicon.length > 0) {
                        var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
                        $('#btnaddtodo').insertAfter($icondeletewhentodo);
                        $('#btnaddtodo').css({ 'margin-top': '1px', 'right': '6px' });
                    }

                    vmEditAction.autoStyleForTodos(vmEditAction.viewModel.action.ActionCosts.length > 1 || vmEditAction.viewModel.action.ActionTodos.length > 0);

                    setTimeout(function () {
                        for (var i = 0; i < atodos.length; i++) {
                            bindCustomPersonInputEvent(atodos[i].Id);
                        }
                    }, 222);
                }
            },

            listSubjetThemas: vmGoalAction.setting.SubjetThemas,
            subjetThemaSource: [],
            subjetThemaName: subjetThemaObj !== null ? subjetThemaObj.Name : "",
            selectSubjetThema: function () {

            },
            addCatSubjetThema: function () {
                if (this.roleEdit) {
                    return;
                }

                var htmlId = "#acSubjetThema";
                var inputText = vmEditAction.viewModel.get("subjetThemaName");
                //Validate input
                if (inputText == null || inputText.trim().length < 1) {
                    $(htmlId).tooltip('destroy');
                    $(htmlId).attr("title", kLg.msgRequired);
                    $(htmlId).tooltip({ trigger: "manual" }).tooltip('show');
                    return;
                }

                vmEditAction.addNewCategories(vmEditAction.enumCategoriesMarketing, vmEditAction.enumTypeSubjetThema, inputText, htmlId);
            },

            mastergoalIndexChange: function (e) {
                var idx = e.sender.selectedIndex;
                var bginfo = findMasterGoalInfo(1, vmGoalAction.actionOptions.masterGoal, vmGoalAction.actionOptions.masterGoal[idx].Id);
                var etinfo = findMasterGoalInfo(2, vmGoalAction.actionOptions.masterGoal, vmGoalAction.actionOptions.masterGoal[idx].Id);
                var atinfo = findMasterGoalInfo(3, vmGoalAction.actionOptions.masterGoal, vmGoalAction.actionOptions.masterGoal[idx].Id);
                $(".budgetInfo").text('').text(bginfo);
                $(".etCostInfo").text('').text(etinfo);
                $(".atCostInfo").text('').text(atinfo);
            },

            isRemovableMaster: vmEditAction.theAction.MasterBudgets.length > 1,
            HasMasterGoalCost: vmEditAction.theAction.MasterBudgets.length > 0 && (vmEditAction.theAction.MasterBudgets[0].Budget != '' || vmEditAction.theAction.MasterBudgets[0].ExpectedCost != '' || vmEditAction.theAction.MasterBudgets[0].ActualCost != ''),
            addMasterBudget: function (e) {
                vmEditAction.clearMasterAlert();

                var newItem = new MasterBudget();
                newItem.MIndex = ++maxMasterIndex;

                this.action.MasterBudgets.unshift(newItem);

                var lst = $.grep(this.action.MasterBudgets, function (it) { return it.DataState !== dataState.Deleted; });
                if (isAutoPercent) {
                    var count = lst.length;

                    var per = Math.floor(100 / lst.length);
                    for (var i = 0; i < lst.length; i++) {
                        lst[i].set("MPercent", per);

                        if (lst[i].DataState === dataState.Unchanged) {
                            lst[i].set("DataState", dataState.Modified);
                        }
                    }

                    if (count > 1) {
                        lst[count - 1].set("MPercent", 100 - per * (count - 1));
                    }
                }

                this.set("isRemovableMaster", true);
                this.rebindMasterSourceModel();

                vmEditAction.AutoWidthForMasterBudget();

                var hasMGC = this.action.MasterBudgets.length > 0 && (this.action.MasterBudgets[0].Budget != '' || this.action.MasterBudgets[0].ActualCost != '' || this.action.MasterBudgets[0].ExpectedCost != '');
                this.set("HasMasterGoalCost", hasMGC);
            },
            selectMasterBudget: function (e) {
                if (e.dataItem.IsFinish || e.dataItem.IsMain) {
                    e.preventDefault();
                }
            },
            changeMasterBudget: function (e) {
                vmEditAction.clearMasterAlert();

                this.rebindMasterSourceModel();
                if (e.data.DataState === dataState.Unchanged) {
                    e.data.set("DataState", dataState.Modified);
                };
                var masterItem = vmCommon.findById(e.data.MasterId, vmGoalAction.actionOptions.masterGoal || []);
                var expectedCost = this.action.ExpectedCost;
                var actualCost = this.action.ActualCost;

                var expctStr = masterItem && (masterItem.ExpectedCost > 0 || expectedCost > 0) ? "P: " + masterItem.Currency + " " + Math.round((masterItem.ExpectedCost + ((expectedCost * e.data.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "";
                var actCstStr = masterItem && (masterItem.ActualCost > 0 || actualCost > 0) ? "C: " + masterItem.Currency + " " + Math.round((masterItem.ActualCost + ((actualCost * e.data.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "";
                e.data.set("Budget", masterItem ? "B: " + masterItem.Currency + " " + masterItem.MasterBudget : "");
                e.data.set("ExpectedCost", expctStr);
                e.data.set("ActualCost", actCstStr);

                var hasMGC = this.action.MasterBudgets.length > 0 && (this.action.MasterBudgets[0].Budget != '' || this.action.MasterBudgets[0].ActualCost != '' || this.action.MasterBudgets[0].ExpectedCost != '');
                this.set("HasMasterGoalCost", hasMGC);
            },
            removeMasterBudget: function (e) {

                vmEditAction.clearMasterAlert();
                //remove item
                var index = this.action.MasterBudgets.indexOf(e.data);
                if (index === -1) return;

                if (e.data.Id === 0) {
                    this.action.MasterBudgets.splice(index, 1);
                } else {
                    e.data.set("DataState", dataState.Deleted);
                    e.data.set("IsVisible", false);
                }

                //get visible masters
                var visibleMasters = $.grep(this.action.MasterBudgets, function (it) { return it.IsVisible; });

                if (visibleMasters.length === 1) {
                    visibleMasters[0].set("MPercent", 100);
                    if (visibleMasters[0].Id > 0) {
                        visibleMasters[0].set("DataState", dataState.Modified);
                    }

                };
                this.set("isRemovableMaster", visibleMasters.length > 1);
                isAutoPercent = (visibleMasters.length === 1);

                this.rebindMasterSourceModel();

                var hasMGC = this.action.MasterBudgets.length > 0 && (this.action.MasterBudgets[0].Budget != '' || this.action.MasterBudgets[0].ActualCost != '' || this.action.MasterBudgets[0].ExpectedCost != '');
                this.set("HasMasterGoalCost", hasMGC);
            },
            changePercent: function (e) {
                vmEditAction.clearMasterAlert();
                if (e.data.MPercent == null) e.data.set("MPercent", 0);

                isAutoPercent = false;

                if (e.data.DataState === dataState.Unchanged) {
                    e.data.set("DataState", dataState.Modified);
                }

                var masterItem = vmCommon.findById(e.data.MasterId, vmGoalAction.actionOptions.masterGoal || []);
                e.data.set("ExpectedCost", masterItem && (masterItem.ExpectedCost > 0 || this.action.ExpectedCost > 0) ? "P: " + masterItem.Currency + " " + Math.round((masterItem.ExpectedCost + ((this.action.ExpectedCost * e.data.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
                e.data.set("ActualCost", masterItem && (masterItem.ActualCost > 0 || this.action.ActualCost > 0) ? "C: " + masterItem.Currency + " " + Math.round((masterItem.ActualCost + ((this.action.ActualCost * e.data.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
            },

            rebindMasterSourceModel: function () {
                var lst = $.grep(this.action.MasterBudgets, function (it) { return it.DataState !== dataState.Deleted; });
                var source = vmGoalAction.actionOptions.masterGoal || [];

                var ids = $.grep(vmCommon.selectProperty(lst, "MasterId"), function (it) { return it !== vmCommon.emptyGuid; });
                var remains = $.grep(source, function (it) { return ids.indexOf(it.Id) === -1; });

                for (var i = 0; i < lst.length; i++) {
                    var item = lst[i];
                    var temp = vmCommon.deepCopy(remains);

                    if (item.MasterId !== vmCommon.emptyGuid) {
                        for (var j = 0; j < source.length; j++) {
                            if (item.MasterId === source[j].Id) {
                                temp.unshift(source[j]);
                            }
                        }
                    }

                    temp.sort((a, b) => { return a.MIndex - b.MIndex; });

                    for (var j = 0; j < temp.length; j++) {
                        var _ms = temp[j];
                        var nextItem = temp[j + 1];
                        if ((_ms.IsMain && nextItem == null) || (_ms.IsMain && nextItem != null && nextItem.IsMain)) {
                            temp.splice(j, 1);
                        }
                    }

                    temp.unshift({ Id: vmCommon.emptyGuid, Name: "" });
                    item.set("Src", temp);
                }

                var expectedCost = this.action.ExpectedCost;
                var actualCost = this.action.ActualCost;

                var masterBudgets = this.action.MasterBudgets;
                for (var i = 0; i < masterBudgets.length; i++) {
                    var masterItem = vmCommon.findById(masterBudgets[i].MasterId, vmGoalAction.actionOptions.masterGoal || []);

                    masterBudgets[i].set("ExpectedCost", masterItem && (masterItem.ExpectedCost > 0 || expectedCost > 0) ? "P: " + masterItem.Currency + " " + Math.round((masterItem.ExpectedCost + ((expectedCost * masterBudgets[i].MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
                    masterBudgets[i].set("ActualCost", masterItem && (masterItem.ActualCost > 0 || actualCost > 0) ? "C: " + masterItem.Currency + " " + Math.round((masterItem.ActualCost + ((actualCost * masterBudgets[i].MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
                }

                toggleSingleMaster(lst.length > 1);
            },
            selectRegionGroup: function (e) {
                var selectedRegion = e.dataItem;
                if (selectedRegion.Id > 0) selectedRegion.set("DataState", dataState.Modified);

                var index = this.autoRegionSrc.indexOf(selectedRegion);
                if (index > -1) {
                    this.labeRegionSrc.push(selectedRegion);
                    this.autoRegionSrc.splice(index, 1);
                }
            },
            changeRegionGroup: function (e) {
                this.set("autoRegionValue", null);
                this.set("tempRegionValue", null);
                this.set("isVisibleSelectedRegion", this.labeRegionSrc.length > 0);

                this.setVisibleKpi();

                //sync
                var that = this;
                vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.LandRegion);
            },
            selectSubProductGroup: function (e) {
                DestroyToolTip($(e.sender.element));
                vmEditAction.isValidSub = true;

                var item = e.sender.dataItem(e.item.index());
                item.IsSelect = true;
                item.DataState = item.Id == null ? dataState.Modified : dataState.Unchanged;

                this.tempSubValue = item;
            },
            selectSubClientGroup: function (e) {
                DestroyToolTip($(e.sender.element));
                vmEditAction.isValidClient = true;

                var item = e.sender.dataItem(e.item.index());
                item.IsSelect = true;
                item.DataState = item.Id == null ? dataState.Modified : dataState.Unchanged;

                this.tempClientValue = item;
            },
            selectCusGroup: function (e) {
                DestroyToolTip($(e.sender.element));
                var item = e.sender.dataItem(e.item.index());
                item.IsSelect = true;
                item.DataState = item.Id == null ? dataState.Modified : dataState.Unchanged;

                this.tempCusValue = item;

            },
            changeCusGroup: function (e) {
                if (this.tempCusValue) {
                    var index = this.autoCusSrc.indexOf(this.tempCusValue);
                    this.labeCusSrc.push(this.tempCusValue);
                    this.autoCusSrc.splice(index, 1);

                    vmGoalAction.subService.autoChange(this.tempCusValue, vmGoalAction.subService.rootType.CustomerJourney);
                    vmGoalAction.subService.groupCus();

                    this.set("autoCusValue", null);
                    this.set("tempCusValue", null);

                    this.set("isVisibleSelectedCus", this.labeCusSrc.length > 0);
                } else {
                    if (e.sender.element[0].value.trim() === "") {
                        DestroyToolTip($(e.sender.element));
                        //vmEditAction.isValidSub = true;
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        //vmEditAction.isValidSub = false;
                    }
                }

                vmGoalAction.autoSubHeight();
            },
            changeSubProductGroup: function (e) {

                if (this.tempSubValue) {
                    var index = this.autoSubSrc.indexOf(this.tempSubValue);
                    this.labeSubSrc.push(this.tempSubValue);
                    this.autoSubSrc.splice(index, 1);

                    vmGoalAction.subService.autoChange(this.tempSubValue, vmGoalAction.subService.rootType.SubProduct);
                    vmGoalAction.subService.groupSub();

                    this.set("autoSubValue", null);
                    this.set("tempSubValue", null);

                    this.set("isVisibleSelectedSub", this.labeSubSrc.length > 0);
                } else {
                    if (e.sender.element[0].value.trim() === "") {
                        DestroyToolTip($(e.sender.element));
                        vmEditAction.isValidSub = true;
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        vmEditAction.isValidSub = false;
                    }

                }

                this.setVisibleKpi();

                //sync
                var that = this;
                vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Product);

                vmGoalAction.autoSubHeight();
            },

            changeSubClientGroup: function (e) {
                var tempItem = vmCommon.deepCopy(this.tempClientValue);

                if (this.tempClientValue) {
                    var index = this.autoClientSrc.indexOf(this.tempClientValue);
                    this.labeClientSrc.push(this.tempClientValue);
                    this.autoClientSrc.splice(index, 1);

                    vmGoalAction.subService.autoChange(this.tempClientValue, vmGoalAction.subService.rootType.SubClient);
                    vmGoalAction.subService.groupClient();

                    this.set("autoClientValue", null);
                    this.set("tempClientValue", null);

                    this.set("isVisibleSelectedClient", this.labeClientSrc.length > 0);
                } else {
                    if (e.sender.element[0].value.trim() === "") {
                        DestroyToolTip($(e.sender.element));
                        vmEditAction.isValidClient = true;
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        vmEditAction.isValidClient = false;
                    }

                }

                this.setVisibleKpi();

                //sync
                if (tempItem && tempItem.TypeId != 7 && tempItem.TypeId != 4) {
                    var that = this;
                    vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Market);
                }

                vmGoalAction.autoSubHeight();
            },
            onChangeRegionCheck: function (e) {
                if (e.data.Id > 0) e.data.set("DataState", dataState.Modified);
            },
            openSelectCus: function () {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.subOptions = { RootType: vmGoalAction.subService.rootType.CustomerJourney };
                vmGoalAction.subOptions.GoalActionType = 2;
                vmGoalAction.subOptions.gaModel = this;

                vmGoalAction.openPopSubProduct(kLg.strSelectionFormat.format(vmGoalAction.CustomerJourneyTitle ? vmGoalAction.CustomerJourneyTitle : kLg.vtextCustomerJourney));
            },
            openSelectRegion: function (e) {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.selectRegionOptions = {};
                vmGoalAction.selectRegionOptions.GoalActionType = 2; //action

                vmGoalAction.selectRegionOptions.viewModel = vmEditAction.viewModel;
                vmGoalAction.selectRegionOptions.selectedRegions = vmEditAction.viewModel.labeRegionSrc;
                vmGoalAction.selectRegionOptions.autoRegions = vmEditAction.viewModel.autoRegionSrc;

                function getLandRegionCallback() {
                    vmGoalAction.selectRegionOptions.menuData = landregionMenuData;

                    vmGoalAction.openPopSelectRegion();

                }

                if (landregionMenuData && landregionMenuData.length > 0) {
                    getLandRegionCallback();
                } else {
                    vmGoalAction.dataservice.getLandRegionMenuData({ subMarketProductId: vmGoalAction.actionOptions.subMarketProductId, independencyId: vmGoalAction.actionOptions.independencyId }, function (res) {
                        landregionMenuData = res.value;
                        getLandRegionCallback();
                    });
                }
            },

            removeRegion: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var removedRegion = e.data;
                removedRegion.set("IsCheck", false);
                if (removedRegion.Id > 0) e.data.set("DataState", dataState.Deleted);

                var index = this.labeRegionSrc.indexOf(removedRegion);
                if (index > -1) {
                    this.autoRegionSrc.push(removedRegion);
                    this.labeRegionSrc.splice(index, 1);

                    this.autoRegionSrc.sort(function (a, b) { return a.Index - b.Index; });
                }

                this.setVisibleKpi();

                //sync
                var that = this;
                vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.LandRegion);

                this.set('isVisibleSelectedRegion', this.labeRegionSrc.length > 0);
            },
            removeCustomerJourney: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var tempItem = e.data;
                var index = vmCommon.findIndexByFunc(this.labeCusSrc, function (it) { return it.ObjectId == tempItem.ObjectId && it.TypeId == tempItem.TypeId; });
                tempItem.IsSelect = false;
                tempItem.DataState = tempItem.Id == null ? dataState.Unchanged : dataState.Deleted;

                this.autoCusSrc.push(tempItem);
                this.labeCusSrc.splice(index, 1);

                vmGoalAction.subService.autoChange(tempItem, vmGoalAction.subService.rootType.CustomerJourney);

                this.set("isVisibleSelectedCus", this.labeCusSrc.length > 0);
                vmGoalAction.subService.groupCus();

                vmGoalAction.autoSubHeight();
            },

            removeSubProduct: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var tempItem = e.data;
                var index = vmCommon.findIndexByFunc(this.labeSubSrc, function (it) { return it.ObjectId == tempItem.ObjectId && it.TypeId == tempItem.TypeId; });

                tempItem.IsSelect = false;
                tempItem.DataState = tempItem.Id == null ? dataState.Unchanged : dataState.Deleted;

                this.autoSubSrc.push(tempItem);
                this.labeSubSrc.splice(index, 1);

                vmGoalAction.subService.autoChange(tempItem, vmGoalAction.subService.rootType.SubProduct);

                this.set("isVisibleSelectedSub", this.labeSubSrc.length > 0);
                vmGoalAction.subService.groupSub();

                this.setVisibleKpi();

                //sync
                var that = this;
                vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Product);

                vmGoalAction.autoSubHeight();
            },
            removeSubClient: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var tempItem = e.data;
                var index = vmCommon.findIndexByFunc(this.labeClientSrc, function (it) { return it.ObjectId == tempItem.ObjectId && it.TypeId == tempItem.TypeId; });

                tempItem.IsSelect = false;
                tempItem.DataState = tempItem.Id == null ? dataState.Unchanged : dataState.Deleted;

                if (index >= 0) {
                    this.autoClientSrc.push(tempItem);
                    this.labeClientSrc.splice(index, 1);
                }

                if (tempItem.TypeId === 4 || tempItem.TypeId === 5 || tempItem.TypeId === 6) {
                    this.set("crmClientItem", null);
                    vmGoalAction.subService.deleteCrmClientItem();
                } else {
                    vmGoalAction.subService.autoChange(tempItem, vmGoalAction.subService.rootType.SubClient);
                }

                this.set("isVisibleSelectedClient", this.labeClientSrc.length > 0 || this.crmClientItem);
                vmGoalAction.subService.groupClient();

                this.setVisibleKpi();

                //sync
                if (tempItem && tempItem.TypeId != 7 && tempItem.TypeId != 4) {
                    var that = this;
                    vmEditAction.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Market);
                }

                vmGoalAction.autoSubHeight();
            },

            openSubProduct: function () {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.subOptions = { RootType: vmGoalAction.subService.rootType.SubProduct };
                vmGoalAction.subOptions.GoalActionType = 2;
                vmGoalAction.subOptions.gaModel = this;

                vmGoalAction.openPopSubProduct(kLg.strSelectionFormat.format(kLg.filterLblProduct));
            },
            openSubClient: function () {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.subOptions = { RootType: vmGoalAction.subService.rootType.SubClient };
                vmGoalAction.subOptions.GoalActionType = 2;
                vmGoalAction.subOptions.gaModel = this;

                vmGoalAction.openPopSubProduct(kLg.strSelectionFormat.format(kLg.titleStackholderGroups));
            },
            redirectOrg: function (e) {
                var item = e.data;
                if (!item.OrganisationId) return;

                var url = "", strategyId = strategies[2];
                switch (item.TypeId) {
                    case 4:
                        url = "/Pages/CrmActivities.aspx?lang=" + kLg.language + "&projid=" + projectId + "&strid=" + strategyId + "&aid=" + item.OrganisationId;
                        break;
                    default:
                        url = "/Pages/CrmOrganisation.aspx?lang=" + kLg.language + "&projid=" + projectId + "&strid=" + strategyId + "&oid=" + item.OrganisationId;
                        break;

                }

                window.open(url, "_blank");
            },

            autoSelectStream: function (e) {

                DestroyToolTip($(e.sender.element));
                vmEditAction.isValidStream = true;

                var item = e.sender.dataItem(e.item.index());
                this.actionSelect = item;
                vmEditAction.actionUpStreamId = item.Id;
                vmEditAction.paths = item.Path;

                var temp = { ActionId: item.Id, ActionName: item.Name, TypeId: item.Type === 1 ? 1 : 6, End: item.End };
                this.action.set("ActionUpStreamConnectionAction", temp);
                vmEditAction.theAction.ActionUpStreamConnectionAction = temp;
                this.actionSelectName = item.Name;

                var date = item.End.jsonToDate();
                vmEditAction.bindActionCostByUpStream(date);

                isSelect = true;

            },
            autoChangeStream: function (e) {

                if (!isSelect) {
                    if (e.sender.element[0].value.length === 0) {
                        DestroyToolTip($(e.sender.element));
                        vmEditAction.isValidStream = true;
                        $('#popEditAction #btnUpdate').prop('disabled', false);
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        vmEditAction.isValidStream = false;
                    }

                    this.actionSelect = null;
                    vmEditAction.actionUpStreamId = null;
                    vmEditAction.paths = null;

                    vmEditAction.removeUpStreamTooltip();

                    this.action.set("ActionUpStreamConnectionAction", null);
                    vmEditAction.theAction.ActionUpStreamConnectionAction = null;
                    this.actionSelectName = null;

                    vmEditAction.bindActionCostByUpStream();
                }

                isSelect = false;
            },
            openReminder: function (e) {
                vmGoalAction.openPopReminder(e, vmCommon.EnumTypeReminder.Action);
            },
            openTodoReminder: function (e) {
                if (!(e.ReminderDay > 0)) e.ReminderDay = null;
                vmGoalAction.openPopReminder(e, vmCommon.EnumTypeReminder.ActionTodo);
            },
            setGoalActionOutlook: function (e) {
                var listEmail = "";
                var action = vmCommon.deepCopy(vmEditAction.viewModel.action);
                var peopleEmailTemp = [];
                $.grep(action.People, function (it) { peopleEmailTemp.push(it.Email); });
                var peopleInvolvedEmailTemp = [];
                $.grep(action.PeopleInvolved, function (it) { peopleInvolvedEmailTemp.push(it.Email); });
                var peopleEmailMerged = peopleEmailTemp.concat(peopleInvolvedEmailTemp).unique();

                var emailsOutlook = peopleEmailMerged;

                for (var i = 0; i < emailsOutlook.length; i++) {
                    if (i === emailsOutlook.length - 1) {
                        listEmail += emailsOutlook[i];
                    } else {
                        listEmail += emailsOutlook[i] + "; ";
                    }
                }

                var name = action.Name ? action.Name : " ";
                var des = action.Description ? action.Description : "";
                name = name.replaceAll("&", "%26");

                var isDashboard = vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard);
                var _fullUrlEncoded = isDashboard ? vmDashboard.AddressBar.ClientQuery.getFullUrlEncoded() : vmCommon.AddressBar.ClientQuery.getFullUrlEncoded();
                var body = des + " \n \n " + _fullUrlEncoded;

                $('a.assignInfo').removeAttr("href");
                $('a.assignInfo').attr("href", "mailto:" + listEmail + "?Subject=" + name + "&Body=" + encodeURIComponent(body));
                $('a.assignInfo').attr("target", "_top");
            },
            setActionTodoOutlook: function (e) {
                var todo = e.data;
                var emailsOutlook = [];
                $.grep(todo.Persons, function (x) { emailsOutlook.push(x.PersonEmail); });
                emailsOutlook = emailsOutlook.unique();
                var listEmail = "";
                for (var i = 0; i < emailsOutlook.length; i++) {
                    if (listEmail.length > 0)
                        listEmail += ";" + emailsOutlook[i];
                    else
                        listEmail += emailsOutlook[i];
                }

                var action = vmCommon.deepCopy(vmEditAction.viewModel.action);
                var name = action.Name ? action.Name : " ";
                var des = action.Description ? action.Description : "";
                name = name.replaceAll("&", "%26");
                var isDashboard = vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard);
                var _fullUrlEncoded = isDashboard ? vmDashboard.AddressBar.ClientQuery.getFullUrlEncoded() : vmCommon.AddressBar.ClientQuery.getFullUrlEncoded();
                var body = des + " \n \n " + _fullUrlEncoded;

                $('a.assignInfo').removeAttr("href");
                $('a.assignInfo').attr("href", "mailto:" + listEmail + "?Subject=" + name + "&Body=" + encodeURIComponent(body));
                $('a.assignInfo').attr("target", "_top");
            },
            isShowReminder: function (e) {
                if (vmEditAction.theAction.People === null || vmEditAction.theAction.People === undefined || vmEditAction.theAction.People.length === 0) {
                    if (vmEditAction.theAction.PeopleInvolved === null || vmEditAction.theAction.PeopleInvolved === undefined || vmEditAction.theAction.PeopleInvolved.length === 0) {
                        return false;
                    }

                }
                if (e.Finish) {
                    return false;
                }
                if (e.EndDate === null || e.EndDate === undefined) {
                    return false;
                }
                var d = new Date();
                var enddate;
                if (Object.prototype.toString.call(e.EndDate) === "[object Date]") {
                    enddate = e.EndDate;
                } else {
                    enddate = new Date(parseInt(e.EndDate.substr(6)));
                }

                if (!compareDate(d, enddate) || equalDate(d, enddate)) {
                    return false;
                }
                return true;


            },
            isHasFibu: vmGoalAction.actionOptions.isHasFibu && (vmGoalAction.actionOptions.isDisordered ? !vmGoalAction.actionOptions.isDisordered : true),
            isSelectMaster: isSelectMaster,
            masterGoal: vmGoalAction.actionOptions.masterGoal || [],
            oldConnections: oldConnection,
            subProducts: vmGoalAction.actionOptions.customConnection,
            roleEdit: vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit,
            hidenicontodo: vmGoalAction.actionOptions.role >= vmCommon.MemberRole.Edit,
            isDisabledConStream: hasDisabledStreamCon,
            listActionCategory: vmEditAction.getCategorySrc(),//vmGoalAction.setting.ActionCategory,
            listActionInstrument: vmGoalAction.setting.ActionInstrument,
            listProtocolStatus: vmGoalAction.setting.ProtocolStatus,
            listActionField: vmGoalAction.setting.ActionField,
            listActionFieldDepartmentTodos: vmGoalAction.setting.ActionField,
            listPerson: vmEditAction.lstAccounts,
            listPersonInvolved: vmCommon.deepCopy(vmEditAction.lstAccounts),
            action: vmEditAction.theAction,
            visiable: (vmEditAction.theAction.ActionUpStreamConnectionAction == null && !vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) ? false : true,
            listActAdvertiser: vmEditAction.theAction.AdvertisingMaterial == -2 ? vmEditAction.getAdvertiserSrc(listActAdvertisingMaterial.map(t => t.Id)) :
                vmEditAction.getAdvertiserSrc(vmEditAction.theAction.AdvertisingMaterial ? [vmEditAction.theAction.AdvertisingMaterial] : listActAdvertisingMaterial.map(t => t.Id)),
            listActAdvertisingMaterial: listActAdvertisingMaterial,
            multiSelectFiltering: function (e) {
                var filter = e.filter;
                if (filter && filter.value != '') {
                    filter.value = filter.value.replace(/\s\s+/g, ' ');
                    if (filter.value.indexOf(' ') == 0) {
                        filter.value = filter.value.slice(1);
                    };
                    e.sender.input.val(filter.value);
                };
            },
            dropdownListFiltering: function (e) {
                var filter = e.filter;
                if (filter) {
                    filter.value = filter.value.replace(/\s\s+/g, ' ');
                    if (filter.value.indexOf(' ') == 0) {
                        filter.value = filter.value.slice(1);
                    };
                    e.sender.filterInput.val(filter.value);
                }
            },
            filteringInInstrument: function (e) {
                this.dropdownListFiltering(e);
                var drplst = e.sender;
                if (vmEditAction.InstrumentSelectName == undefined) {
                    vmEditAction.InstrumentSelectName = drplst.text();
                };
                setTimeout(function () {
                    var hasChildSelected = false;
                    drplst.ul.children().each(function () {
                        if ($(this).text() == vmEditAction.InstrumentSelectName) {
                            hasChildSelected = true;
                        }
                    });

                    if (hasChildSelected == true) {
                        drplst.select(function (dataItem) {
                            return dataItem.Name == vmEditAction.InstrumentSelectName;
                        });
                    }
                }, 9);

            },
            filteringInAdvertising: function (e) {
                this.dropdownListFiltering(e);
                var drplst = e.sender;
                if (vmEditAction.AdvertisingSelectName == undefined) {
                    vmEditAction.AdvertisingSelectName = drplst.text();
                };
                setTimeout(function () {
                    var hasChildSelected = false;
                    drplst.ul.children().each(function () {
                        if ($(this).text() == vmEditAction.AdvertisingSelectName) {
                            hasChildSelected = true;
                        }
                    });

                    if (hasChildSelected == true) {
                        drplst.select(function (dataItem) {
                            return dataItem.Name == vmEditAction.AdvertisingSelectName;
                        });
                    }
                }, 9);

            },
            totalExpectedCost: "P: " + vmEditAction.formatTotalCost(totalExpCost, msCurrency),
            totalActualCost: "C: " + vmEditAction.formatTotalCost(totalActCost, msCurrency),
            updateTotalCost: function () {
                var costs = this.action.ActionCosts, totalExpectedCost = 0, totalActualCost = 0;
                for (var i = 0, len = costs.length; i < len; i++) {
                    if (costs[i].DataState === dataState.Deleted) {
                        continue;
                    }
                    totalExpectedCost += costs[i].ExpectedCost;
                    totalActualCost += costs[i].ActualCost;
                }

                this.set("totalExpectedCost", "P: " + vmEditAction.formatTotalCost(totalExpectedCost, msCurrency));
                this.set("totalActualCost", "C: " + vmEditAction.formatTotalCost(totalActualCost, msCurrency));

                this.action.set("ExpectedCost", totalExpectedCost);
                this.action.set("ActualCost", totalActualCost);

                var masterBudgets = this.action.MasterBudgets;
                for (var i = 0; i < masterBudgets.length; i++) {
                    var masterItem = vmCommon.findById(masterBudgets[i].MasterId, vmGoalAction.actionOptions.masterGoal || []);

                    masterBudgets[i].set("ExpectedCost", masterItem && (masterItem.ExpectedCost > 0 || totalExpectedCost > 0) ? "P: " + masterItem.Currency + " " + Math.round((masterItem.ExpectedCost + ((totalExpectedCost * masterBudgets[i].MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
                    masterBudgets[i].set("ActualCost", masterItem && (masterItem.ActualCost > 0 || totalActualCost > 0) ? "C: " + masterItem.Currency + " " + Math.round((masterItem.ActualCost + ((totalActualCost * masterBudgets[i].MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "");
                }
            },
            changeCost: function (e) {
                var item = e.data;
                if (!item.ExpectedCost) {
                    item.set("ExpectedCost", 0);
                }

                if (!item.ActualCost) {
                    item.set("ActualCost", 0);
                }

                this.updateTotalCost();
            },
            changeFinish: function (e) {
                var elementsReminder = $(e.target).closest("div.col-md-6").prev().find('.reminder');
                var index = this.action.ActionCosts.indexOf(e.data);
                if (vmEditAction.checkReminder(e.data)) {
                    vmEditAction.showHideReminder(elementsReminder, 'block');
                } else {
                    vmEditAction.showHideReminder(elementsReminder, 'none');
                }

                vmEditAction.changeKpiActionBySI(this.action);
            },
            openActionFibu: function (e) {

                vmGoalAction.fibuOptions = { role: vmGoalAction.actionOptions.role };
                vmGoalAction.fibuOptions.Cost = e.data;
                vmGoalAction.fibuOptions.ActionFibus = e.data.Fibus;

                vmGoalAction.fibuOptions.ActualCost = e.data.ActualCost || 0;
                vmGoalAction.fibuOptions.ExpectedCost = e.data.ExpectedCost || 0;
                vmGoalAction.fibuOptions.IsEdit = vmGoalAction.actionOptions.isEdit;
                vmGoalAction.fibuOptions.RegionId = vmGoalAction.actionOptions.regionId || 0;

                vmGoalAction.fibuOptions.IndependencyId = vmGoalAction.actionOptions.independencyId || 0;
                vmGoalAction.fibuOptions.FibuSupplier = e.data.FibuSupplier;
                vmGoalAction.fibuOptions.FibuDescription = e.data.FibuDescription;
                vmGoalAction.fibuOptions.FibuSupplierId = e.data.FibuSupplierId;

                vmGoalAction.openPopupActionFibu(this.action.Id);

            },
            addStatus: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit)
                    return;
                this.action.Status.unshift({
                    Date: new Date(),
                    StatusId: -1,
                    Description: kLg.labelComment,
                    IsOrigin: true,
                    IsNew: true,
                    Id: '' + Date.now() + '_' + vmCommon.emptyGuid // use Date.now() to save data in format popup
                });
                vmEditAction.AdjustPopupHeight();
                $("#gridStatusProtocol input[data-role='datepicker']").kendoDatePicker({
                    weekNumber: true
                });
                vmEditAction.initTabIndex();
                setPopupHeight();

                vmCommon.TexEditor.Placeholder.setAttr($('.dnbStatusKendoEditor').first(), vmCommon.TexEditor.Type.Status
                ).setInnerHTML()(vmEditAction.viewModel.roleEdit);
            },
            delStatus: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit)
                    return;
                var status = this.action.Status;
                var theStatus = e.data;
                var index = status.indexOf(theStatus);
                this.action.Status[index].set("IsOrigin", false);

                if (index >= 0 && (theStatus.Id == null || theStatus.Id == vmCommon.emptyGuid)) {
                    this.action.Status.splice(index, 1);
                }

                setPopupHeight();
                vmEditAction.initTabIndex();
            },
            visibleUpStream: function () {
                var flag = this.action.ActionCosts.every(function (it) { return it.StartDate != null && it.DataState !== dataState.Deleted; });
                //$("#popEditAction #txtUpStream").data("kendoAutoComplete").enable(flag);
                this.set("isDisabledConStream", !flag);
                return flag;
            },
            autoChangePeople: function (e) {
                var listAcc = vmCommon.deepCopy(vmEditAction.viewModel.get("action.People")).sort(SortByLastName);
                vmEditAction.viewModel.set("action.People", listAcc);

                $("#tablecost input[data-role='datepicker'][name='end']").each(function (e) {
                    var index = $(this).closest("div.row-cost").index();
                    var item = vmEditAction.viewModel.action.ActionCosts[index];

                    var elementsReminder = $(this).closest("div.col-md-6").next().find(".reminder");
                    if (vmEditAction.checkReminder(item)) {
                        vmEditAction.showHideReminder(elementsReminder, 'block');
                    } else {
                        vmEditAction.showHideReminder(elementsReminder, 'none');
                    }
                });
            },
            autoChangePeopleInvolved: function (e) {
                var listAcc = vmCommon.deepCopy(vmEditAction.viewModel.get("action.PeopleInvolved")).sort(SortByLastName);
                vmEditAction.viewModel.set("action.PeopleInvolved", listAcc);

                $("#tablecost input[data-role='datepicker'][name='end']").each(function (e) {
                    var index = $(this).closest("div.row-cost").index();
                    var item = vmEditAction.viewModel.action.ActionCosts[index];

                    var elementsReminder = $(this).closest("div.col-md-6").next().find(".reminder");
                    if (vmEditAction.checkReminder(item)) {
                        vmEditAction.showHideReminder(elementsReminder, 'block');
                    } else {
                        vmEditAction.showHideReminder(elementsReminder, 'none');
                    }
                });
            },
            startDateChange: function (e) {
                var index = $(e.sender.element).closest("div.row-cost").index();
                var item = vmEditAction.viewModel.action.ActionCosts[index];

                vmEditAction.startDateChange(e.sender.element, item);

                var elementsReminder = $(e.sender.element).closest("div.row").find(".reminder");
                if (vmEditAction.checkReminder(item)) {
                    vmEditAction.showHideReminder(elementsReminder, 'block');
                } else {
                    vmEditAction.showHideReminder(elementsReminder, 'none');
                }
            },
            IsEdit: vmGoalAction.actionOptions.isEdit,

            endDateChange: function (e) {
                var index = $(e.sender.element).closest("div.row-cost").index();
                var item = vmEditAction.viewModel.action.ActionCosts[index];

                vmEditAction.endDateChange(e.sender.element, item);

                var elementsReminder = $(e.sender.element).closest("div.col-md-6").next().find(".reminder");
                if (vmEditAction.checkReminder(item)) {
                    vmEditAction.showHideReminder(elementsReminder, 'block');
                } else {
                    vmEditAction.showHideReminder(elementsReminder, 'none');
                }

            },
            numberOfDayChange: function (e) {
                var item = e.data, row = $(e.sender.element).closest("div.row");

                var startElem = $(row).find("input[name='start']"), dayElem = $(row).find("input[name='day']").prev(), endElem = $(row).find("input[name='end']");
                if (item.NumberOfDay == null) {
                    item.set("EndDate", null);
                    $(endElem).tooltip("destroy");
                    this.visibleUpStream();
                    return;
                }

                if (item.NumberOfDay > 0 && item.NumberOfDay < 1) {
                    item.set("NumberOfDay", Math.round(item.NumberOfDay));
                }

                if (item.StartDate == null) {
                    this.visibleUpStream();
                    return;
                }

                if (typeof item.StartDate === "string") {
                    if (item.StartDate.indexOf("/Date") === -1) {
                        item.set("StartDate", new Date(item.StartDate));
                    } else {
                        item.set("StartDate", item.StartDate.jsonToDate());
                    }
                }

                var newEndDate = new Date(item.StartDate);
                newEndDate.setDate(newEndDate.getDate() + item.NumberOfDay);
                item.set("EndDate", newEndDate);
                vmEditAction.changeKpiActionBySI(this.action);

                $(endElem).tooltip("destroy");

                var elementsReminder = $(e.sender.element).closest("div.row").find(".reminder");
                if (vmEditAction.checkReminder(item)) {
                    vmEditAction.showHideReminder(elementsReminder, 'block');
                } else {
                    vmEditAction.showHideReminder(elementsReminder, 'none');
                }

                this.visibleUpStream();
            },
            dateChange: function (e) {
                var elem = e.sender.element[0];

                var sdate = isValidStartDate();
                if (elem.id === "txtStartDate") {
                    if (sdate) {
                        if (this.action.NumberOfDay != null) {
                            var newEndDate = new Date(this.action.Start);
                            newEndDate.setDate(newEndDate.getDate() + this.action.NumberOfDay);

                            $("#txtEndDate").tooltip("destroy");
                            this.action.set("End", new Date(newEndDate));
                        }
                    } else if (elem.value.length > 0) {
                        //goto: blur
                    }
                } else {
                    var edate = isValidEndDate();
                    if (edate) {
                        if (this.action.End != null) {
                            if (this.action.Start != null) {
                                this.action.Start.setHours(0, 0, 0, 0);
                                this.action.End.setHours(0, 0, 0, 0);

                                if (compareDate(this.action.Start, this.action.End)) {
                                    this.action.set("NumberOfDay", this.action.Start.days(this.action.End));
                                }
                            }
                        } else {
                            this.action.set("NumberOfDay", null);
                        }

                    } else if (elem.value.length > 0) {
                        //goto: blur
                    }

                }
            },
            addActionCost: function () {
                if (this.roleEdit) {
                    return;
                }

                this.action.ActionCosts.push(new ActionCost());
                this.set("enableRemoveCost", true);
                vmEditAction.visibleCostField(customViewOption.HasCost);

                //this.styleButtonTodoActionCost();

                $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

                $("#tablecost input[data-role='datepicker'][name='start']").kendoDatePicker({
                    weekNumber: true,
                    change: function (e) {
                        vmEditAction.viewModel.startDateChange(e);
                    }
                });
                $("#tablecost input[data-role='datepicker'][name='end']").kendoDatePicker({
                    weekNumber: true,
                    change: function (e) {
                        vmEditAction.viewModel.endDateChange(e);
                    }
                });

                this.updateTotalCost();
                vmEditAction.changeKpiActionBySI(this.action);

                //Fix auto-complete can not select case 2
                var tempScroll = $("#area-edit-action").scrollTop();
                $("#area-edit-action").scrollTop(0);
                $("#area-edit-action").scrollTop(tempScroll);


                var isExpandWidth = $.grep(vmEditAction.viewModel.action.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; }).length > 1;
                if (!isExpandWidth) {
                    var actionLocal = vmEditAction.viewModel.get("action");

                    for (var h = 0; h < actionLocal.ActionCosts.length; h++) {
                        if (actionLocal.ActionCosts[h].DataState !== dataState.Deleted) {
                            actionLocal.ActionCosts[h].Description = "";
                            if (actionLocal.ActionCosts[h].DataState !== dataState.Added)
                                actionLocal.ActionCosts[h].DataState = dataState.Modified;
                        }
                    }

                    vmEditAction.viewModel.set("action", actionLocal);
                    this.action.ActionCosts = actionLocal.ActionCosts;
                }
                vmEditAction.AutoWidthByTodoCost(this.action);
                bindStartDateAutoformat();
                bindEndDateAutoformat();

                evaluateStreamConnection(this.action.ActionCosts);
                this.updateVisibleLastAddActionCost();

                $("#area-edit-action .lblReminder").text(kLg.reminder);
                $("#area-edit-action .lblAssignInfo").text(kLg.assignInfo);
                vmEditAction.initTabIndex();
                bindAutoFocus();
                setPopupHeight();
                $('#tablecost .row.row-cost:not([style*="display: none;"])').find('.btnaddcost').hide();
                $('#tablecost .row.row-cost:not([style*="display: none;"])').last().find('.btnaddcost').show();
                setupTooltipAddCost();
            },
            enableRemoveCost: vmEditAction.theAction.ActionCosts.length > 1,
            updateVisibleLastAddActionCost: function () {
                var lastAddAC = 0;
                vmEditAction.viewModel.action.ActionCosts.forEach((ac, i) => {
                    ac.set("IsShowAddCost", false);
                    if (ac.DataState != dataState.Deleted && ac.IsShow) {
                        lastAddAC = i;
                    }
                });
                vmEditAction.viewModel.action.ActionCosts[lastAddAC].set("IsShowAddCost", true);
                
            },
            removeActionCost: function (e) {
                if (this.roleEdit) {
                    return;
                }
                var item = e.data;
                var index = this.action.ActionCosts.indexOf(item);

                if (item.Id) {
                    item.set("DataState", dataState.Deleted);
                    item.set("IsShow", false);
                } else {
                    this.action.ActionCosts.splice(index, 1);
                }

                vmEditAction.visibleCostField(customViewOption.HasCost);
                this.updateTotalCost();
                vmEditAction.changeKpiActionBySI(this.action);

                this.set("enableRemoveCost", this.action.ActionCosts.filter(t => t.IsShow).length > 1);

                this.visibleUpStream();
                this.updateVisibleLastAddActionCost();
                vmEditAction.AutoWidthByTodoCost(this.action);
                setPopupHeight();
                //Fix auto-complete can not select case 1
                var tempScroll = $("#area-edit-action").scrollTop();
                $("#area-edit-action").scrollTop(0);
                $("#area-edit-action").scrollTop(tempScroll);                
                vmEditAction.initTabIndex();
                setTimeout(function () {
                    setBlurChangeDate();
                }, 1000);
                $('#tablecost .row.row-cost:not([style*="display: none;"])').last().find('.btnaddcost').show();
            },
            LastChange: function () {
                if (vmGoalAction.actionOptions.isEdit)
                    return kLg.LastChange + ": " + kendo.toString(vmGoalAction.actionOptions.action.ModifiedDate.jsonToDate(), "d") + " " + vmGoalAction.actionOptions.action.ModifiedName;
                else return '';
            },
            saveFromFormatForm: function (dataId, value) {
                var theAction = vmCommon.deepCopy(this.action);

                if (vmGoalAction.actionOptions.isEdit) {
                    var data = getDataByDataId();
                    if (data) {
                        data.Id = theAction.Id;

                        vmEditAction.dataservice.updateFromFormatPopup(data, function (serData) { //var resObj = serData.value;
                            vmEditAction.modelChanged = true;
                        });
                    }
                };

                function getDataByDataId() {
                    var dataEntry = {};

                    switch (dataId) {
                        case 'txt-area-description':
                            dataEntry.Description = value;
                            vmEditAction.viewModel.action.set("Description", value);
                            return dataEntry;
                        case 'txt-area-expectedeffect':
                            dataEntry.ExpectedEffect = value;
                            vmEditAction.viewModel.action.set("ExpectedEffect", value);
                            return dataEntry;
                        case 'txt-area-actualeffect':
                            dataEntry.ActualEffect = value;
                            vmEditAction.viewModel.action.set("ActualEffect", value);
                            return dataEntry;
                        default:

                            var txtPre = 'dnbStatusEditor_';
                            if (dataId.indexOf(txtPre) === 0) {         // statuses
                                var statusId = dataId.replace(txtPre, '');

                                if (dataId.split('_').length > 2) {         // Add new from format popup
                                    var eData = theAction.Status.find(elm => { return elm.Id == statusId });
                                    if (eData != undefined && value) {
                                        eData.Id = undefined;
                                        eData.Description = value;
                                        eData.ActionId = theAction.Id;  // GoalId = null/undefined
                                        vmEditAction.dataservice.addStatusFromFormatPopup(eData, function (serData) {
                                            var resObj = serData.value;
                                            var newId = resObj.Id;

                                            // set new id in DOM
                                            var $textAreaId = $('#' + dataId);
                                            $textAreaId.attr("id", txtPre + newId);
                                            var $divDataId = $(`div[data-id="${dataId}"]`);
                                            $divDataId.attr("data-id", txtPre + newId);
                                            var $areaControl = $(`ul[aria-controls="${dataId}"]`);
                                            $areaControl.attr("aria-controls", txtPre + newId);

                                            vmCommon.TexEditor.setSelectorFromEdit(txtPre + newId);

                                            // update id in data source
                                            vmEditAction.viewModel.action.Status.forEach(elm => {
                                                if (elm.Id == statusId) {
                                                    elm.IsNew = false;
                                                    elm.Description = value;
                                                    elm.Id = newId;
                                                    elm.ActionId = theAction.Id;
                                                    elm.Date = resObj.Date;
                                                    elm.CreatedBy = resObj.CreatedBy;
                                                }
                                            });
                                        });
                                    }
                                } else {                                    // Edit from format popup
                                    statusId = dataId.replace(txtPre, '');
                                    if (statusId != vmCommon.emptyGuid) {
                                        vmEditAction.dataservice.updateStatusFromFormatPopup({
                                            Id: statusId,
                                            Description: value
                                        }, function (serData) {
                                            //var resObj = serData.value;
                                            // update description in data source
                                            vmEditAction.viewModel.action.Status.forEach(elm => {
                                                if (elm.Id == statusId) {
                                                    elm.Description = value;
                                                }
                                            });
                                        });
                                    }
                                }
                            };

                            return undefined;
                    }
                }

            },
            update: function () {
                $('#popEditAction #btnUpdate').prop('disabled', true); // prevent internet slow to create mutil douplicate
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) {
                    vmGoalAction.popEditAction.close();
                    return;
                };
                if (!isValidDate() || !$("#fEditAction").valid() || !vmEditAction.valid || !isValidStream()
                    || !isValidSub() || !isValidClient() || !isValidStatus() || !vmEditAction.validMasterBudget()) {
                    if ($('#txtName').val() === "") {
                        $('#txtName').focus();
                    }
                    return;
                };
                var theAction = vmCommon.deepCopy(this.action);

                theAction.Status.forEach(el => {
                    if (el.Date) el.Date = changeHourOfDate(el.Date);

                    el.Description = htmlEncode($("#dnbStatusEditor_" + el.Id).val());
                    if (el.Id.indexOf(vmCommon.emptyGuid) > 0) {
                        el.Id = vmCommon.emptyGuid;
                    };
                });

                var isChangeConection = false;
                var tempSubPro = vmCommon.pushApply([], this.oldConnections, function (it) { return it.Id });
                var subproducts = [];
                for (var m = 0; m < tempSubPro.length; m++) {
                    var temp = vmEditAction.FindById(vmGoalAction.actionOptions.customConnection, Number(tempSubPro[m]));
                    if (temp) {
                        subproducts.push({ SubProductId: temp.SubProductId, Type: temp.Type, Id: temp.Id });
                    }
                }
                var newPeople = vmCommon.pushApply([], this.action.People, function (it) { return it.AccountId });
                var newPeopleInvolved = vmCommon.pushApply([], this.action.PeopleInvolved, function (it) { return it.AccountId });
                var oldPeopleTemp = vmCommon.pushApply([], oldPeople, function (it) { return it.AccountId });

                var typeAction;
                theAction.ActionFibus = vmGoalAction.fibuOptions.ActionFibus || [];

                delete theAction.SubClientGroups;
                delete theAction.SubProductGroups;

                theAction.subProductGroups = vmGoalAction.subService.dataToSave();
                theAction.subClientGroups = vmGoalAction.subService.dataClientToSave();
                theAction.customerJourneyGroups = vmGoalAction.subService.dataCusToSave();

                var actionRegions = vmCommon.deepCopy(this.labeRegionSrc);
                this.autoRegionSrc.forEach(function (it) {
                    if (it.Id > 0) {
                        it.DataState = dataState.Deleted;
                        actionRegions.push(vmCommon.deepCopy(it));
                    }
                });

                var isChangeRegionOver = !actionPlanRegions.filter(t => t.IsSelect).compare(actionRegions, (t1, t2) => t1.Id == t2.Id && t1.IsCheck == t2.IsCheck);

                theAction.ActionCosts = vmEditAction.bindToSaveCost(theAction.ActionCosts);
                theAction.Start = changeHourOfDate(vmGoalAction.getIndexOfMinDate(theAction.ActionCosts).MinDate);
                theAction.End = changeHourOfDate(vmGoalAction.getIndexOfMaxDate(theAction.ActionCosts).MaxDate);

                vmEditAction.updateCostForAction(theAction);

                if (theAction.ActionTodos) {
                    for (var i = 0; i < theAction.ActionTodos.length; i++) {
                        if (theAction.ActionTodos[i].DueDate != null)
                            theAction.ActionTodos[i].DueDate = changeHourOfDate(theAction.ActionTodos[i].DueDate);
                    }
                }

                var subjetThemaName = vmEditAction.viewModel.get("subjetThemaName");
                var subjetThemaObj = vmCommon.findByFunc(vmGoalAction.setting.SubjetThemas, function (it) { return it.Name === subjetThemaName; });
                if (subjetThemaName !== null && subjetThemaName.length > 0 && subjetThemaObj === null) {
                    $("#acSubjetThema").tooltip('destroy');
                    $("#acSubjetThema").attr("title", kLg.InvalidData);
                    $("#acSubjetThema").tooltip({ trigger: "manual" }).tooltip('show');
                    return;
                }

                if (subjetThemaObj != null)
                    theAction.SubjetThema = subjetThemaObj.Id;
                else
                    theAction.SubjetThema = 0;

                theAction.MasterBudgets = $.grep(theAction.MasterBudgets, function (it) { return !((it.MasterId == null || it.MasterId === vmCommon.emptyGuid) && it.DataState === dataState.Added); });

                vmGoalAction.GoalMaster.LastCost = theAction.ActualCost;
                vmGoalAction.GoalMaster.LastIds = vmCommon.selectProperty($.grep(theAction.MasterBudgets, function (it) { return it.DataState !== dataState.Deleted; }), "MasterId");

                var templateObj = vmEditAction.viewModel.get("templateId");
                var templateId = templateObj === null ? vmCommon.emptyGuid : templateObj.Id;

                theAction.SubMarketProductId = vmGoalAction.actionOptions.subMarketProductId;
                theAction.IndependencyId = vmGoalAction.actionOptions.independencyId;
                theAction.ActionPlanRegions = actionRegions;

                theAction.displaySubs = vmEditAction.viewModel.displaySrc.map(t => t);
                theAction.displayClients = vmEditAction.viewModel.displayClientSrc.filter(t => t.TypeId == 1 || t.TypeId == 2 || t.TypeId == 3).map(t => t);
                theAction.displayCus = vmEditAction.viewModel.displayCusSrc.map(t => t);

                theAction.Description = vmCommon.TexEditor.getValueFromEditor($('#popEditAction #txt-area-description'));
                theAction.ExpectedEffect = vmCommon.TexEditor.getValueFromEditor($('#popEditAction #txt-area-expectedeffect'));
                theAction.ActualEffect = vmCommon.TexEditor.getValueFromEditor($('#popEditAction #txt-area-actualeffect'));

                if (this.isMultipleAdvertiser) {
                    theAction.ActionAdvertisers = theAction.ActionAdvertisers.map(i => { return { Id: i.Id, Name: i.Name, ParentId: i.ParentId } });
                } else {
                    theAction.ActionAdvertisers = [];
                }
                if (vmGoalAction.actionOptions.isEdit) { //Update action
                    isChangeConection = !oldConnection.equals(tempSubPro);
                    this.action.ActionUpStreamConnectionAction = vmEditAction.theAction.ActionUpStreamConnectionAction;
                    if (vmEditAction.viewModel.get("templateId") != null && theAction.Status.length > 0) {
                        var sStatus = [];
                        for (var sidx = 0; sidx < theAction.Status.length; sidx++) {
                            if (theAction.Status[sidx].IsOrigin === false) {

                            }
                            else {
                                sStatus.push(theAction.Status[sidx]);
                            }
                        }
                        theAction.Status = sStatus;
                    }
                    if (isChangeConection) {
                        if (subproducts.length === 0) {
                            theAction.SubProducts.forEach(function (item) {
                                if (item.DataState !== dataState.Modified) {
                                    item.DataState = dataState.Deleted;
                                }
                            });
                        } else {
                            for (var i = 0; i < theAction.SubProducts.length; i++) {
                                var oldItem = theAction.SubProducts[i];
                                if (!vmEditAction.FindById(subproducts, oldItem.Id)) {
                                    if (oldItem.DataState !== dataState.Modified) {
                                        oldItem.DataState = dataState.Deleted;
                                    }
                                }
                            }
                            for (var i = 0; i < subproducts.length; i++) {
                                var tempSub = subproducts[i];
                                if (!vmEditAction.FindById(theAction.SubProducts, tempSub.Id)) {
                                    theAction.SubProducts.push({ SubProductId: tempSub.SubProductId, Type: tempSub.Type, DataState: dataState.Added });
                                }
                            }
                        }
                    }
                    if (theAction.IsFromTemplate == undefined) theAction.IsFromTemplate = false;
                    var entryData = {
                        Action: theAction,
                        OldPeople: oldPeopleTemp,
                        NewPeople: newPeople,
                        isFile: vmFile.isSaveFromOtherSource,
                        TemplateId: templateId,
                        PathParentId: vmGoalAction.actionOptions.pathParentId,
                        PathParentMdf: vmGoalAction.actionOptions.pathParentMdf
                    };
                    vmEditAction.dataservice.updateAction(entryData, function (serData) {
                        vmEditAction.modelChanged = false;
                        if (!vmGoalAction.checkRole(serData)) return;
                        if (serData.value.ResultStatus !== vmEditAction.eConflict.conflict) {
                            vmCommon.popup.close(theAction);

                            if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                                if (vmGoalAction.popEditAction)
                                    vmGoalAction.popEditAction.close();

                                vmDashGoal.loadGoalAction(vmDashGoal.pageIndex, vmDashGoal.mKey, vmDashGoal.mValue);
                                return;
                            }
                            else if (vmCommon.checkCurrentPage(vmCommon.enumPage.Calendar)) {
                                msFilter.controlService.onReloadDataMix();
                            }
                            else if (vmCommon.checkCurrentPage(vmCommon.enumPage.RoadMap)) {
                                if (vmGoalAction.actionOptions.goalActionNavigationCallback) vmGoalAction.actionOptions.goalActionNavigationCallback();
                                msRoadmapApp.reloadData();
                            }
                            else if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan)) {
                                if (vmGoalAction.isReloadByRegionView(theAction)) {
                                    msFilter.controlService.reLoadData();
                                } else {
                                    var isResetByResults = vmGoalAction.hasResultsFilter(theAction.Id, theAction.GoalId, vmGoalAction.actionOptions.subMarketProductId, vmGoalAction.actionOptions.independencyId);
                                    var isReset = isResetByResults && vmEditAction.checkFitFilter(theAction, serData.value.TheObject);

                                    if (msFilter.controlService.hasCriteria(mFilter.enumFilter.masterGoal) &&
                                        vmGoalAction.isActionFitFilterMaster(theAction.Id, theAction.GoalId, vmGoalAction.GoalMaster.FirstIds, vmGoalAction.GoalMaster.LastIds))
                                        isResetByResults = true;

                                    MsaApp.pushExpand(theAction.GoalId, 'subgoal');
                                    const aid = theAction.Id;
                                    MsaApp.setLastActiveElement(aid);
                                    MsaApp.pushLoadTimeActions('vmEditActionDataserviceUpdateAction');
                                    if(typeof vmCommon.updateActionClient == 'function') {
                                        vmCommon.updateActionClient(theAction);
                                        delete vmCommon.ObjEditAction;
                                    }
                                    if (isReset) {
                                        msFilter.controlService.reLoadData();
                                    } else {
                                        var isConnection = false, isSubConnection = false;
                                        var areaId = vmGoalAction.actionOptions.independencyId || vmGoalAction.actionOptions.subMarketProductId;

                                        var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);// actionPlanComponents[areaId];
                                        if (areaCpn) {
                                            isConnection = areaCpn.IsConnection;
                                            isSubConnection = areaCpn.IsSubConnection;
                                        }

                                        if (((isConnection || isSubConnection) && (isChangeConection || theAction.subProductGroups.length > 0)) || isChangeRegionOver) {
                                            msFilter.controlService.reLoadData();
                                        }
                                    }

                                    if ((theAction.subProductGroups.length > 0 || theAction.subClientGroups.length > 0) || theAction.customerJourneyGroups.length > 0) {
                                        msFilter.controlService.reLoadDataFilter();
                                    }
                                }
                            }
                            else if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                                var primeColor = theAction.Categories.length > 0 ? theAction.Categories[0].Color : theAction.Color;

                                teamBoardVM.reloadBoardLineAfterUpdateElement({
                                    Name: theAction.Name,
                                    Id: theAction.Id,
                                    NewColor: primeColor
                                },
                                    vmGoalAction.actionOptions.goalActionNavigationCallback);

                            }

                            if (vmGoalAction.popEditAction)
                                vmGoalAction.popEditAction.close();

                        } else {
                            alert(kLg.msgConflictData);
                        }
                    });
                } else { //Add new action
                    theAction.GoalId = vmGoalAction.actionOptions.goalId;
                    var indexStatus = theAction.Status.length;
                    while (indexStatus--) {
                        if (theAction.Status[indexStatus].IsOrigin === false && theAction.Status[indexStatus].Id == null) {
                            theAction.Status.splice(indexStatus, 1);
                        } else {
                            theAction.Status[indexStatus].Date = getCurrentHourOfDate(theAction.Status[indexStatus].Date);
                        }
                    }
                    if (theAction.Status.length > 0) {
                        var sStatus = [];
                        for (var sidx = 0; sidx < theAction.Status.length; sidx++) {
                            if (theAction.Status[sidx].IsOrigin === false) {

                            }
                            else {
                                sStatus.push(theAction.Status[sidx]);
                            }
                        }
                        theAction.Status = sStatus;
                    }
                    if (vmEditAction.actionUpStreamId == null) {
                        this.action.ActionUpStreamConnectionAction = null;
                    } else {
                        typeAction = vmEditAction.typeActionConnect.add;
                        this.action.ActionUpStreamConnectionAction = { ActionId: vmEditAction.actionUpStreamId, TypeId: typeAction };
                    }
                    theAction.SubProducts = subproducts;
                    if (theAction.ApSwotanalyseTemplateId == -1) theAction.ApSwotanalyseTemplateId = null;

                    if (!theAction.CreatedDate || typeof theAction.CreatedDate == "string") {
                        theAction.CreatedDate = new Date();
                    };
                    var dataEntry = {
                        Action: theAction,
                        ParentSubMarketProductId: vmGoalAction.actionOptions.parentSubMarketProductId || vmCommon.emptyGuid,
                        IndependencyId: vmGoalAction.actionOptions.independencyId || 0,
                        NewPeople: newPeople,
                        NewPeopleInvolved: newPeopleInvolved,
                        TemplateId: templateId,
                        GoalId: theAction.GoalId,
                        BoardColumnId: vmGoalAction.actionOptions.boardColumnId,
                        IsDisordered: vmGoalAction.actionOptions.isDisordered,
                        SubMarketProductId: vmGoalAction.actionOptions.subMarketProductId,
                        PathParentId: vmGoalAction.actionOptions.pathParentId,
                        PathParentMdf: vmGoalAction.actionOptions.pathParentMdf
                    };
                    if(vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan) && Array.isArray(vmCommon.RefLstGa)){
                        vmEditAction.modelChanged = false;    
                        MsaApp.pushLoadTimeActions('vmEditActionDataserviceCreateAction');
                        let act = vmCommon.deepCopy(theAction);
                        if(vmCommon.RefAddTypeStr == 'addActionByNav') {
                            const mg = {
                                SubMarketProductId: act.SubMarketProductId,
                                IndependencyId: act.IndependencyId,
                            }
                            let nMg = sHandler.getNewMain(mg, true);
                            let nSg = sHandler.getNewSub(mg, true);
                            let cAct = sHandler.getNewAction(act);
                            MsaApp.pushExpand(nSg.Id, 'subgoal');
                            MsaApp.pushExpand(nMg.Id, 'maingoal');
                            MsaApp.setLastActiveElement(cAct.Id);
                            cAct.GoalId = nSg.Id;
                            nSg.ListAction.push(cAct);
                            nSg.ParentId = nMg.Id;
                            nMg.ListSubGoal.push(nSg);
                            vmCommon.RefLstGa.push(nMg);
                        } else if(vmCommon.RefAddTypeStr == 'refPopupAddAction'){
                            let cAct = sHandler.getNewAction(act);
                            vmCommon.RefLstGa.push(cAct);
                        }
                        delete vmCommon.RefAddTypeStr;
                        delete vmCommon.RefLstGa;
                        if (vmGoalAction.popEditAction)
                            vmGoalAction.popEditAction.close();
                        return;
                    }
                    vmEditAction.dataservice.createAction(dataEntry, function (serData) {
                        vmEditAction.modelChanged = false;                        
                        if (!vmGoalAction.checkRole(serData)) return;
                        if (serData.value.ResultStatus !== vmEditAction.eConflict.conflict) {
                            if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                                var newAction = serData.value || {};
                                teamBoardVM && (teamBoardVM.reLoadBoardLineCreateNewElement(newAction.ActionId));

                            } else { //Action Plan
                                var areaId = vmGoalAction.actionOptions.independencyId || vmGoalAction.actionOptions.subMarketProductId;
                                var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);//actionPlanComponents[areaId];

                                const aid = serData.value.ActionId;
                                
                                if (typeof MsaApp == 'object') {
                                    MsaApp.pushExpand(serData.value.MainGoalId, 'maingoal', 'nochange');
                                    MsaApp.pushExpand(serData.value.SubGoalId, 'subgoal');

                                    //todo: expand area
                                    MsaApp.pushExpand(areaId, vmGoalAction.actionOptions.independencyId ? "Theme" : "Product");
                                    if (areaCpn && areaCpn.IsExpand == false) areaCpn.onClickToggleShow();

                                    MsaApp.setLastActiveElement(aid);
                                    MsaApp.pushLoadTimeActions('vmEditActionDataserviceCreateAction');
                                }

                                // Update Evaluation title XYZ
                                if (typeof vmCommon.vmApEvalxDataServiceSaveTitleLang == 'function') {
                                    vmCommon.vmApEvalxDataServiceSaveTitleLang(aid);
                                    delete vmCommon.vmApEvalxDataServiceSaveTitleLang;
                                }

                                var isResetByResults = vmGoalAction.hasResultsFilter(theAction.Id, theAction.GoalId, vmGoalAction.actionOptions.subMarketProductId, vmGoalAction.actionOptions.independencyId);
                                var isReset = isResetByResults && vmEditAction.checkFitFilter(theAction, serData.value.TheObject);

                                if (msFilter.controlService.hasCriteria(mFilter.enumFilter.masterGoal) &&
                                    vmGoalAction.isActionFitFilterMaster(theAction.Id, theAction.GoalId, vmGoalAction.GoalMaster.FirstIds, vmGoalAction.GoalMaster.LastIds))
                                    isReset = true;

                                if (isReset) {
                                    msFilter.controlService.reLoadData();
                                } else {
                                    var isConnection = false, isSubConnection = false;
                                    if (areaCpn) {
                                        isConnection = areaCpn.IsConnection;
                                        isSubConnection = areaCpn.IsSubConnection;
                                    }

                                    if (((isConnection || isSubConnection) && (isChangeConection || theAction.subProductGroups.length > 0)) || isChangeRegionOver) {
                                        msFilter.controlService.reLoadData();
                                    }
                                }

                                if ((theAction.subProductGroups.length > 0 || theAction.subClientGroups.length > 0) || theAction.customerJourneyGroups.length > 0) {
                                    msFilter.controlService.reLoadDataFilter();
                                }

                                // if (typeof MsaApp == 'object' && MsaApp) {
                                //     MsaApp.reloadAllDataOfPage('MsPopEditAction_addNewAction').then(() => {
                                        
                                //     });
                                // }
                            }
                            if (vmGoalAction.popEditAction)
                                vmGoalAction.popEditAction.close();

                        } else {
                            pAlert(kLg.msgConflictData); // kLg.msgActionConflict
                        }
                    });
                }
            },
            showLblTooltipAdd: function (e) {
                
                $(e.target).popover({
                    placement: 'top', html: true,
                    title: '',
                    trigger: "hover"
                }).popover('show');
            },
            clickEdit: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit)
                    return;
                $(e.target).hide();
                $(e.target).next().show();
                $(e.target).next().focus();
            },
            clickView: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit)
                    return;
                $(e.target).hide();
                $(e.target).prev().show();
            },
            autoSizeX: function (e) {
                var _this = $(e.target).get(0);
                var minHeight = jQuery(_this).css('min-height').slice(0, 2); // string removed 'px' at the end
                if (_this.scrollHeight > Number(minHeight)) jQuery(_this).css('height', 'auto');
                jQuery(_this).height(_this.scrollHeight);

                (function adjustPopupHeight() {               // replace for function vmEditAction.AdjustPopupHeight;
                    var $popup = $('#area-edit-action').closest('.k-widget.k-window');
                    var popupHeight = (window.outerHeight - 70) / window.devicePixelRatio - 50;
                    var isZoomOut = popupHeight > $popup.height() + 15;
                    var isZoomIn = popupHeight < $popup.height() - 15;
                    if (isZoomIn || isZoomOut) {
                        var limitHeight = $('#area-edit-action').find('#fEditAction').first().height();
                        var $header = $popup.children('.k-window-titlebar.k-header').first();
                        var $footer = $('#area-edit-action').children('.modal-market-footer').first();
                        var $body = $('#area-edit-action').children('.modal-body.ms-modal-body').first();

                        if (popupHeight - $header.height() - $footer.height() - 6 < limitHeight && limitHeight - 60 > $footer.height() + 18) {
                            $body.height(popupHeight - $header.height() - $footer.height() - 6);

                            resizePopUp(vmGoalAction.popEditAction, { height: popupHeight });
                        }
                    }
                })();
            },
            togglePlaceholderKendoEditor: function (e) {

                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).checkData();

            },
            onKeyUpChangeValKendoEditor: function (e) {
                var newValue = vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).checkValue();

                if (newValue) {
                    var $textArea = e.sender.textarea;
                    var idElement = $textArea.attr("id");
                    var actionLocal = vmEditAction.viewModel.get("action");

                    if (idElement == 'txt-area-description') {

                        vmEditAction.modelChanged = newValue != vmCommon.TexEditor.stripHtml(actionLocal.Description);

                    } else if (idElement == 'txt-area-expectedeffect') {

                        vmEditAction.modelChanged = newValue != vmCommon.TexEditor.stripHtml(actionLocal.ExpectedEffect);

                    } else if (idElement == 'txt-area-actualeffect') {

                        vmEditAction.modelChanged = newValue != vmCommon.TexEditor.stripHtml(actionLocal.ActualEffect);

                    }
                };
            },
            onKeyDownChangeValKendoEditor: function (e) {

                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).preCheckValue();
            },
            onPasteValKendoEditor: function (e) {
                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).preCheckValue();
            },
            menuAction: vmGoalAction.getSubMarketMenuValue,
            selectInstrument: function (e) {
                
                var selectedItem = e.dataItem;
                vmEditAction.InstrumentSelectName = selectedItem.Name;
                var id = selectedItem.Id ? selectedItem.Id : null;
                if (id == this.action.Instrument) return;
                vmEditAction.dataservice.getCustomViews({ instrumentId: id }, function (res) {
                    customViews = res.value;        // array

                    customViewOption = vmEditAction.bindCustomView(customViews);
                    vmEditAction.viewModel.set("customViewOption", customViewOption);

                    setPopupHeight();

                    vmEditAction.setupLanguageCustomView();
                    vmEditAction.synchronizedViews();
                    vmEditAction.synchronizedDefaultViews();

                    if (!customViewOption.HasDescription || !customViewOption.HasActualEffect || !customViewOption.HasExpectedEffect) {
                        if (!customViewOption.HasDescription) {
                            const $selector = $('#txt-area-description');
                            resetHeightKEditor($selector);
                        }
                        if (!customViewOption.HasActualEffect) {
                            const $selector = $('#txt-area-actualeffect');
                            resetHeightKEditor($selector);
                        }
                        if (!customViewOption.HasExpectedEffect) {
                            const $selector = $('#txt-area-expectedeffect');
                            resetHeightKEditor($selector);
                        }

                        function resetHeightKEditor($selector) {
                            if (!$selector || $selector.length < 1) return;
                            var kendoEditor = $selector.data("kendoEditor");
                            if (!kendoEditor) return;
                            var $wrapperTable = kendoEditor.wrapper;
                            var $iframe = kendoEditor.textarea.closest('.k-editable-area').find('.k-content').first();
                            height = '72px';
                            $wrapperTable.css({ 'height': height });
                            $iframe.css({ 'height': height });
                        }
                    }
                });
            },
            tempAdvertiser: null,
            selectAdvertiser: function (e) {
                if (e.dataItem.Id == this.action.Advertiser)
                    return;
                this.tempAdvertiser = e.dataItem;
            },
            changeAdvertiser: function (e) {
                var actionModel = vmEditAction.viewModel.action;
                if (this.tempAdvertiser) {
                    this.set("isVisibleKpi", true);
                    actionModel.set("Advertiser", this.tempAdvertiser.Id);
                    actionModel.set("AdvertiserName", this.tempAdvertiser.Name);

                    //update parent
                    actionModel.set("AdvertisingMaterial", Number(this.tempAdvertiser.ParentId));
                    this.set("listActAdvertiser", vmEditAction.getAdvertiserSrc([actionModel.AdvertisingMaterial]));

                    //formart
                    vmEditAction.formatService.clear();
                    vmEditAction.dataservice.getKpiFormatData({ advertiser: actionModel.Advertiser }, function (res) {
                        var formats = res.value;
                        if (formats.length == 1) {
                            vmEditAction.formatService.add(formats[0].Id);
                            actionModel.set("Formats", vmEditAction.formatService.getData());
                        }

                        vmEditAction.updateKpiActionData();
                    });

                    this.tempAdvertiser = null;
                } else {
                    this.set("isVisibleKpi", false);
                    
                    actionModel.set("Advertiser", null);
                    actionModel.set("AdvertiserName", null);
                    actionModel.set("Formats", []);

                    vmEditAction.formatService.clear();
                    vmEditAction.updateKpiActionData();
                }
            },
            selectAdvertising: function (e) {
                var selectedItem = e.dataItem;
                vmEditAction.AdvertisingSelectName = selectedItem.Name;
            },
            onChangeMultipleAdvertiser: function (e) {
                var listAcc = vmCommon.deepCopy(this.get('action.ActionAdvertisers'));
                listAcc.sort((a, b) => a.MIndex - b.MIndex);    // có vẻ thừa nhưng mặc kệ
                const lstAdsing = this.listActAdvertisingMaterial;
                const lstA = [];
                listAcc.forEach(a => {
                    var _p = lstAdsing.find(_asing => _asing.Id == a.ParentId);
                    if (_p) {
                        a.ParentMIndex = _p.MIndex;
                        lstA.push(a);
                    }
                });
                lstA.sort((a, b) => a.MIndex - b.MIndex).sort((a, b) => a.ParentMIndex - b.ParentMIndex);
                lstA.forEach(a => { delete a.ParentMIndex; });      // sort xong rồi thì xóa đi

                this.set('action.ActionAdvertisers', lstA);
                vmEditAction.updateKpiActionData();
            },
            isMultipleAdvertiser: vmEditAction.theAction.AdvertisingMaterial == -2,
            isMultipleAdvertiserShow: vmEditAction.theAction.AdvertisingMaterial == -2 && vmGoalAction.actionOptions.isHasKpi,
            changeAdvertising: function (e) {
                if (customViewOption.HasAdvertiser == false) return;

                var id = this.action.AdvertisingMaterial;

                updateSrcAdv();
                var isKpiDataDeleteState = false;
                
                var child = { isVisibleKpi: false, Advertiser: null, AdvertiserName: "", KpiFormatId: null, KpiFormatIds: [] };
                switch (true) {
                    //multipleSelect
                    case id == -2:  // Giữ lại Advertiser nếu trong Direct Outcome có Index
                        const adv_Id = this.get('action.Advertiser');
                        var hasKpiIndx = false;
                        this.action.KpiData.find(kpiD => {
                            if (kpiD.AdvertiserId == adv_Id && kpiD.KpiIndexes.length) {
                                hasKpiIndx = true;
                                return true;
                            }
                        });
                        if (hasKpiIndx) {
                            const _adv = this.get('listActAdvertiser').find(t => t.Id == adv_Id);  // tim item tu source
                            if (_adv) {
                                const lstAdv = this.get('action.ActionAdvertisers') ?? [];
                                lstAdv.push(_adv);
                                lstAdv.sort((a, b) => a.MIndex - b.MIndex);
                                this.set('action.ActionAdvertisers', lstAdv);
                            } else
                                setStateDelete();
                        } else {
                            clearActionAdvertisers();
                            setStateDelete();
                        }
                        this.set('action.Advertiser', 0);
                        this.set('action.AdvertiserName', '');
                        this.set('isVisibleKpi', false);
                        break;
                    // chuyển từ multipleSelect sang (single adv hoặc chọn null)
                    case id != null && id != -2 && this.isMultipleAdvertiser:     // set state Delete cho KpiData
                        setStateDelete();
                        isKpiDataDeleteState = true;
                    // Không break vì còn chạy xuống case ở dưới id > 0 (dùng để set 1 Advertiser và con mắt)
                    // Chuyển giữa các single adv
                    case id > 0:
                        var datas;
                        clearActionAdvertisers();
                        if (vmEditAction.Advertisers["" + id]) {
                            datas = vmEditAction.Advertisers["" + id];
                            var flag = checkAutoSelectAdvCallback(datas);
                            setData(child);
                            if (flag) {
                                vmEditAction.updateKpiActionData();
                            } else {
                                !isKpiDataDeleteState && setStateDelete();
                                resetKpiData();
                            }
                        } else {
                            vmEditAction.dataservice.getAdvertiserMenu({ AdvertisingId: id }, function (res) {
                                datas = res.value;
                                vmEditAction.Advertisers["" + id] = datas;
                                var flag = checkAutoSelectAdvCallback(datas);
                                setData(child);
                                if (flag) {
                                    vmEditAction.updateKpiActionData();
                                } else {
                                    !isKpiDataDeleteState && setStateDelete();
                                    resetKpiData();
                                }
                            });
                        }
                        updateSrcAdv(id);

                        function resetKpiData() {
                            if (datas.length) {
                                var advertisers = $.grep(datas, function (it) { return it.TypeId == 1; });
                                if (advertisers.length != 1) {
                                    vmEditAction.viewModel.action.KpiData.forEach(kpiD => {
                                        if(kpiD.DataState == dataState.Deleted)
                                            kpiD.KpiIndexes.forEach(ki => ki.DataState = dataState.Deleted);
                                    })
                                }
                            }
                        }
                        function checkAutoSelectAdvCallback(datas) {
                            if (datas.length == 0) return false;

                            var advertisers = $.grep(datas, function (it) { return it.TypeId == 1; });
                            if (advertisers.length) {
                                var advertiser = advertisers[0];
                                var formats = $.grep(datas, function (it) { return it.TypeId == 3 && it.ParentId == advertiser.Id; });

                                if (advertisers.length == 1) {
                                    if (formats.length <= 1) {
                                        child.isVisibleKpi = true;
                                        child.Advertiser = Number(advertiser.Id);
                                        child.AdvertiserName = advertiser.Name;
                                        !isKpiDataDeleteState && setStateDelete([child.Advertiser])
                                    } else 
                                        !isKpiDataDeleteState && setStateDelete();

                                    if (formats.length == 1) {
                                        child.KpiFormatIds = [Number(formats[0].Id)];
                                    } else {
                                        vmEditAction.formatService.clear();
                                    }
                                    return true;
                                }
                                return false;
                            } else {
                                return false;
                            }
                        }
                        break;
                    default:
                        setStateDelete();
                        setData(child);
                        break;
                }

                // Ẩn hiện 2 control là dropdownList và multipleSelect
                this.set('isMultipleAdvertiser', id == -2);
                if (this.isHasKpi) this.set('isMultipleAdvertiserShow', id == -2);

                function setData(ads) {
                    var actionModel = vmEditAction.viewModel.action;
                    vmEditAction.viewModel.set("isVisibleKpi", vmEditAction.viewModel.isHasKpi && ads.isVisibleKpi);
                    actionModel.set("Advertiser", ads.Advertiser);
                    actionModel.set("AdvertiserName", ads.AdvertiserName);

                    vmEditAction.formatService.clear();
                    child.KpiFormatIds.forEach(function (it) {
                        vmEditAction.formatService.add(it);
                    });
                };
                
            },
            openSelectAdvertiser: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) return;

                var advertisingId = this.action.AdvertisingMaterial;
                var actionModel = this.action;

                vmGoalAction.advertiserOptions = {};
                vmGoalAction.advertiserOptions.viewModel = this;
                vmGoalAction.advertiserOptions.actionModel = actionModel;
                vmGoalAction.advertiserOptions.KpiFormatDataSource = vmEditAction.KpiFormatDataSource;

                let srcIds = advertisingId > 0 ? [advertisingId] : this.listActAdvertisingMaterial.filter(i => i.Id > 0).map(t => t.Id);
               
                vmEditAction.dataservice.getAdvertiserMenu2({ AdvertisingIds: srcIds }, function (res) {
                    var datas = res.value;
                    if (vmGoalAction.advertiserOptions.viewModel.isMultipleAdvertiser) {
                        datas = datas.filter(i => i.TypeId != 3);       // remove Fomat đi 
                        const value = actionModel.ActionAdvertisers;
                        if (value && value.length) {
                            datas.forEach(it => {
                                if (value.find(_i => _i.Id == it.Id)) {
                                    it.IsSelect = true;
                                };
                            });
                        }
                    }
                    vmGoalAction.advertiserOptions.Datas = vmEditAction.bindAdvertiserMenu(actionModel, datas);
                    //open form
                    vmEditAction.openPopAdvertiser();
                });

            },
            openKpiIndex: function () {
                if (this.action.Advertiser == null) return;

                var actionModel = this.action;

                vmGoalAction.kpiActionOptions = {};
                vmGoalAction.kpiActionOptions.actionModel = actionModel;
                vmGoalAction.kpiActionOptions.role = vmGoalAction.actionOptions.role;
                vmGoalAction.kpiActionOptions.enableSI = vmGoalAction.checkEnableSI(actionModel);

                vmGoalAction.kpiActionOptions.enableOutcomeTime = false;
                vmGoalAction.kpiActionOptions.enableOutcome = true;

                vmGoalAction.kpiActionOptions.currency = msCurrency;
                vmGoalAction.kpiActionOptions.selectableTopics = vmEditAction.getSelectableTopics();

                var that = this;
                vmGoalAction.kpiActionOptions.callback = function (kpiData) {
                    vmEditAction.syncActionPlanConnection.sync(that);
                };

                if (vmGoalAction.kpiActionSettings) {
                    vmGoalAction.kpiActionOptions.Settings = vmGoalAction.kpiActionSettings;

                    vmGoalAction.openActionIndex(kLg.lblDirectOutcomeAds);
                } else {
                    var templateId = vmEditAction.viewModel.get("templateId") ? vmEditAction.viewModel.get("templateId").Id : null;
                    vmEditAction.dataservice.getKpiActionSetting({ IndependencyId: vmGoalAction.actionOptions.independencyId, SubMarketProductId: vmGoalAction.actionOptions.subMarketProductId, SubGoalId: actionModel.GoalId, ActionId: actionModel.Id, GoalActionType: vmCommon.GoalActionContentType.Action, TemplateId: templateId }, function (res) {
                        vmGoalAction.kpiActionSettings = res.value;
                        vmGoalAction.kpiActionOptions.Settings = vmGoalAction.kpiActionSettings;

                        vmGoalAction.openActionIndex(kLg.lblDirectOutcomeAds);
                    });
                }

            },
            openKpiIndexTime: function () { //editable outcome-time
                var that = this;
                var actionModel = this.action;

                vmGoalAction.kpiActionOptions = {};
                vmGoalAction.kpiActionOptions.actionModel = actionModel;
                vmGoalAction.kpiActionOptions.role = vmGoalAction.actionOptions.role;
                vmGoalAction.kpiActionOptions.enableSI = vmGoalAction.checkEnableSI(actionModel);

                vmGoalAction.kpiActionOptions.enableOutcomeTime = true;
                vmGoalAction.kpiActionOptions.enableOutcome = this.isVisibleKpi;

                vmGoalAction.kpiActionOptions.currency = msCurrency;
                vmGoalAction.kpiActionOptions.selectableTopics = vmEditAction.getSelectableTopics();

                vmGoalAction.kpiActionOptions.callback = function (kpiData) {
                    vmEditAction.syncActionPlanConnection.sync(that);
                };

                if (vmGoalAction.kpiActionSettings) {
                    vmGoalAction.kpiActionOptions.Settings = vmGoalAction.kpiActionSettings;

                    vmGoalAction.openActionIndex(kLg.lblDirectOutcome);
                } else {
                    var templateId = vmEditAction.viewModel.get("templateId") ? vmEditAction.viewModel.get("templateId").Id : null;
                    vmEditAction.dataservice.getKpiActionSetting({ IndependencyId: vmGoalAction.actionOptions.independencyId, SubMarketProductId: vmGoalAction.actionOptions.subMarketProductId, SubGoalId: actionModel.GoalId, ActionId: actionModel.Id, GoalActionType: vmCommon.GoalActionContentType.Action, TemplateId: templateId }, function (res) {
                        vmGoalAction.kpiActionSettings = res.value;
                        vmGoalAction.kpiActionOptions.Settings = vmGoalAction.kpiActionSettings;

                        vmGoalAction.openActionIndex(kLg.lblDirectOutcome);
                    });
                }

            },
            addLink: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) return;

                var that = this;

                var callback = function () {
                    var otherLinks = that.action.Links;

                    vmGoalAction.linkOptions = {};
                    vmGoalAction.linkOptions.IsEdit = false;

                    var newLink = new ActionPlanLink();
                    newLink.MIndex = vmCommon.getMaxMIndex(otherLinks) + 1;

                    vmGoalAction.linkOptions.Link = newLink;
                    vmGoalAction.linkOptions.goalActionModel = that.action;

                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, newLink);

                    vmGoalAction.openPopEditLink();
                };

                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.action.Id, GoalActionTypeId: vmCommon.GoalActionContentType.Action }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            addLinkBeLow: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) return;

                var index = this.action.Links.indexOf(e.data);
                var that = this;

                var callback = function () {
                    vmGoalAction.linkOptions = {};

                    var newLink = new ActionPlanLink();
                    newLink.MIndex = e.data.MIndex + 1;

                    vmGoalAction.linkOptions.afterIndex = index;
                    vmGoalAction.linkOptions.IsEdit = false;

                    vmGoalAction.linkOptions.Link = newLink;
                    vmGoalAction.linkOptions.goalActionModel = that.action;

                    var otherLinks = that.action.Links;
                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, newLink);

                    vmGoalAction.openPopEditLink();
                };

                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.action.Id, GoalActionTypeId: vmCommon.GoalActionContentType.Action }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            editLink: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) return;

                var that = this;
                var link = e.data;

                var callback = function () {
                    vmGoalAction.linkOptions = {};
                    vmGoalAction.linkOptions.IsEdit = true;

                    vmGoalAction.linkOptions.Link = link;
                    vmGoalAction.linkOptions.goalActionModel = that.action;

                    var otherLinks = that.action.Links.filter(t => t != link);
                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, link);

                    vmGoalAction.openPopEditLink();
                };

                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.action.Id, GoalActionTypeId: vmCommon.GoalActionContentType.Action }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            deleteLink: function (e) {
                if (vmGoalAction.actionOptions.role < vmCommon.MemberRole.Edit) return;

                var link = e.data;
                var that = this;
                pConfirm(kLg.confirmDeleteLink).then(
                    function () {
                        if (link.Id > 0) {
                            link.set("IsShow", false);
                            link.set("DataState", dataState.Deleted);
                        } else {
                            that.action.Links.splice($(e.currentTarget.closest("tr")).index(), 1);
                        }

                        that.set("hasLink", !that.isDisordered && (that.action.Visibility || that.action.Links.some(t => t.IsShow)));
                    }
                );


            },
            onChangeVisibility: function () {
                if (!this.action.Visibility) {
                    var links = this.action.Links;
                    for (var i = links.length - 1; i >= 0; i--) {
                        var link = links[i];
                        if (link.IsMasterLink) continue;

                        if (link.Id > 0) {
                            link.set("IsShow", false);
                            link.set("DataState", dataState.Deleted);
                        } else {
                            links.splice(i, 1);
                        }
                    }
                }

                this.set("hasLink", !this.isDisordered && (this.action.Visibility || this.action.Links.some(t => t.IsShow)));
            },
            openGoalAction: function (e) {
                if (e.data.RoleId >= 0 && e.data.Url && e.data.IsActive) {
                    //var url = '/Pages/MsGoalAction.aspx?lang=' + kLg.language + '&projid=' + projectId + '&strid=' + strategyId + '&fromdash=true' + e.data.Url;
                    var url = "../Handlers/MsGoalAction.ashx?funcName=getMixShortDetail" + "&projid=" + projectId + "&strid=" + strategyId;
                    callAjaxPostGet('divloading', url, null, { id: e.data.LinkId, type: e.data.LinkTypeId }, function (serData) {
                        if (serData.value.Role < 0) {
                            window.location = "/Default.aspx?lang=" + kLg.language;
                            return;
                        }

                        var data = serData.value.Data;
                        if (data) {
                            url = '/Pages/MsGoalAction.aspx?lang=' + kLg.language + '&projid=' + projectId + '&strid=' + strategyId + '&actpopup=' + data.ActpopupEncode;
                            url += '&fromactionplanconnect=1';

                            window.open(url, "_blank");
                        }
                    });

                }
            }
        });
        vmEditAction.viewModel.bind("change", function (e) {
            if (vmEditAction.isInitSubSerice === false) {
                vmEditAction.isInitSubSerice = undefined;
                return;
            };
            vmEditAction.modelChanged = true;
            $('#popEditAction #btnUpdate').prop('disabled', false);
        });

        vmEditAction.activeModelChange = function () {
            vmEditAction.modelChanged = true;
            $('#popEditAction #btnUpdate').prop('disabled', false);
        };
        vmEditAction.formatService.init(vmEditAction.viewModel.action.Formats);

        //set max value for number of day
        $("#area-edit-action input[data-role=datepicker]").attr('data-format', kendo.culture().calendars.standard.patterns.d);
        
        kendo.bind($("#area-edit-action"), vmEditAction.viewModel);
        // #region Text editor (Des, Expected, Occured)
        vmCommon.TexEditor.Placeholder.setAttr($('#txt-area-description'), vmCommon.TexEditor.Type.NoPlaceholder).setInnerHTML()(vmEditAction.viewModel.roleEdit);
        vmCommon.TexEditor.Placeholder.setAttr($('#txt-area-expectedeffect'), vmCommon.TexEditor.Type.NoPlaceholder).setInnerHTML()(vmEditAction.viewModel.roleEdit);
        vmCommon.TexEditor.Placeholder.setAttr($('#txt-area-actualeffect'), vmCommon.TexEditor.Type.NoPlaceholder).setInnerHTML()(vmEditAction.viewModel.roleEdit);
        $('.dnbStatusKendoEditor').each(function () {
            vmCommon.TexEditor.Placeholder.setAttr($(this), vmCommon.TexEditor.Type.Status
            ).setInnerHTML()(vmEditAction.viewModel.roleEdit);
        });
        // #endregion Text editor
        toggleSingleMaster(vmEditAction.theAction.MasterBudgets.length > 1);
        vmGoalAction.subService.init(vmEditAction.viewModel, subProductGroups, subClientGroups, crmClientItem)(function () {
            vmEditAction.isInitSubSerice = true;
        });
        if (vmGoalAction.actionOptions.role >= vmCommon.MemberRole.Edit) {
            vmEditAction.bindSortTable($("#tablecost"));
            setupTodoDragDrop();
        } else {
            $("#tablecost input[name='start']").each(function () {
                $(this).data("kendoDatePicker").enable(false);
            });
        }
        vmEditAction.AutoWidthByTodoCost(vmEditAction.viewModel.action);
        textAreaScaleHeight();
        vmEditAction.find = function (id, listMenu) {
            for (var i = 0; i < listMenu.length; i++) {
                var product = listMenu[i].items;
                for (var k = 0; k < product.length; k++) {
                    if (product[k].select === true && product[k].id === id) {

                        return product;
                    }
                    continue;
                }
            }

            return undefined;
        };

        vmEditAction.checkFitFilter = function (theAction, theStatus) {
            var isReset = false,
                actionVisibility = theAction.Visibility ? mFilter.enumFilterVisibility.Show : mFilter.enumFilterVisibility.Hide;
            var isConnection = false, isSubConnection = false;
            var areaId = theAction.IndependencyId || theAction.SubMarketProductId;

            var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);// actionPlanComponents[areaId];
            if (areaCpn && areaCpn.item) {
                isConnection = areaCpn.item.IsConnection;
                isSubConnection = areaCpn.item.IsSubConnection;
            }

            //if (theAction.Visibility)
            //    actionVisibility = mFilter.enumFilterVisibility.Show;
            //else
            //    actionVisibility = mFilter.enumFilterVisibility.Hide;

            if (!msFilter.controlService.checkFitFilter([actionVisibility], mFilter.enumFilter.visibility)) {
                isReset = true;
            }

            var lstCateIds = [];
            if (theAction.Categories && theAction.Categories.length > 0) theAction.Categories.filter(t => t.Id > 0).forEach(t => lstCateIds.pushx(t.Id));
            if (theAction.ActionCosts && theAction.ActionCosts.length > 0) theAction.ActionCosts.filter(t => t.CategoryId > 0).forEach(t => lstCateIds.pushx(t.CategoryId));
            if (!msFilter.controlService.checkFitFilter(lstCateIds, mFilter.enumFilter.actionCategory)) {
                isReset = true;
            }

            if (!vmEditAction.checkFitTask(theAction)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitFilter([theAction.Instrument], mFilter.enumFilter.instrument)) {
                isReset = true;
            }

            var advertierIds = [], advertisingIds = [];
            if (theAction.AdvertisingMaterial > 0) {
                advertisingIds.push(Number(theAction.AdvertisingMaterial));

                if (theAction.Advertiser > 0)
                    advertierIds.push(Number(theAction.Advertiser));
                
            }
            else if (theAction.AdvertisingMaterial == -2) {
                for (var i = 0; i < theAction.ActionAdvertisers.length; i++) {
                    advertierIds.push(theAction.ActionAdvertisers[i].Id);
                    advertisingIds.push(theAction.ActionAdvertisers[i].ParentId);
                }
            }

            if (!msFilter.controlService.checkFitFilter(advertierIds, mFilter.enumFilter.advertiser)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitFilter(advertisingIds, mFilter.enumFilter.advertisingMaterial)) {
                isReset = true;
            }

            var subjetThemaId = theAction.SubjetThema > 0 ? theAction.SubjetThema : null;
            if (!msFilter.controlService.checkFitFilter([subjetThemaId], mFilter.enumFilter.subjetThema)) {
                isReset = true;
            }

            var supplierIds = theAction.ActionCosts.filter(t => t.DataState !== dataState.Deleted).map(t => t.FibuSupplierId).filter(t => t > 0);
            if (!msFilter.controlService.checkFitFilter(supplierIds, mFilter.enumFilter.supplier)) {
                isReset = true;
            }

            var lstFieldIds = [];
            if (theAction.Fields && theAction.Fields.length > 0) lstFieldIds = theAction.Fields.filter(t => t.Id > 0).map(t => t.Id);
            for (var i = 0; i < theAction.ActionTodos.length; i++) {
                var todo = theAction.ActionTodos[i];
                if (todo.ActionTodoDepartments && todo.ActionTodoDepartments.length)
                    lstFieldIds = lstFieldIds.concat(todo.ActionTodoDepartments.map(x => x.Id));
            }

            if (!msFilter.controlService.checkFitFilter(lstFieldIds, mFilter.enumFilter.field)) {
                isReset = true;
            }

            var lstPeopleIds = [];
            if (theAction.People && theAction.People.length > 0) theAction.People.filter(t => t.AccountId > 0).forEach(t => lstPeopleIds.pushx(t.AccountId));
            if (theAction.PeopleInvolved && theAction.PeopleInvolved.length > 0) theAction.PeopleInvolved.filter(t => t.AccountId > 0).forEach(t => lstPeopleIds.pushx(t.AccountId));

            if (!msFilter.controlService.checkFitFilter(lstPeopleIds, mFilter.enumFilter.person)) {
                isReset = true;
            }

            //
            var allStatusIds = [], lstStatusIds = [];
            if (typeof (theStatus) !== 'undefined' && theStatus != null && theStatus.length > 0) {
                allStatusIds = theStatus.map(t => t.StatusId);
                lstStatusIds = [allStatusIds[0]];
            }
            if (!msFilter.controlService.checkFitFilter(lstStatusIds, mFilter.enumFilter.lastStatus)) {
                isReset = true;
            }
            if (!msFilter.controlService.checkFitFilter(allStatusIds, mFilter.enumFilter.protocolStatus)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitTimeRange(theAction.Start, theAction.End))
                isReset = true;

            var masterBudgetIds = theAction.MasterBudgets.map(t => t.MasterId).filter(t => t != null && t != vmCommon.emptyGuid);
            if (!msFilter.controlService.checkFitFilter(masterBudgetIds, mFilter.enumFilter.masterGoal))
                isReset = true;

            var goalIndexIds = [];
            if (theAction.KpiMasterData && theAction.KpiMasterData.KpiMasterTopics) {
                var topics = theAction.KpiMasterData.KpiMasterTopics.filter(t => t.TypeId == vmCommon.KpiGoalTopicType.Goal);
                topics.forEach(t => {
                    var indexes = t.KpiMasterIndexes || [];
                    indexes.forEach(i => {
                        goalIndexIds.pushx(i.GuidLinkId);
                    });
                });
            }

            if (!msFilter.controlService.checkFitFilter(goalIndexIds, mFilter.enumFilter.masterGoalKpi))
                isReset = true;

            var listFibuData = [], costs = $.grep(theAction.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; });
            for (var i = 0; i < costs.length; i++) {
                if (costs[i].Fibus == null || costs[i].Fibus.length == 0) continue;

                var fibus = costs[i].Fibus.filter(t => t.DataState != dataState.Deleted);
                if (fibus.length == 0) continue;

                vmCommon.pushApply(listFibuData, fibus);
            }
            if (!msFilter.controlService.checkFitFilter(listFibuData, mFilter.enumFilter.fibuKostenstellen))
                isReset = true;

            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.goalCategory)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.goalCategory);
                isReset = true;
            }

            //var isConnection = $("a[ms-role=child]#" + (theAction.SubMarketProductId || theAction.IndependencyId)).hasClass("item-connection");
            if (isConnection && !msFilter.controlService.checkFitFilter(theAction.displaySubs, mFilter.enumFilter.productGroup))
                isReset = true;

            if (isConnection && !msFilter.controlService.checkFitFilter(theAction.displayClients, mFilter.enumFilter.market))
                isReset = true;

            var cus = vmCommon.deepCopy(theAction.displayCus) || [];
            //if (vmGoalAction.actionOptions.isEdit) {
            //    var $columnElement = $("#" + theAction.Id).closest("div.msa-subgoal-view-column[mstype='column']");
            //    var cId = $columnElement.attr("cid");
            //    var cType = $columnElement.attr("ctype");

            //    if (cId && cType && !isNaN(Number(cId)) && !isNaN(Number(cType))) cus.push({ ObjectId: Number(cId), TypeId: Number(cType) });
            //}

            if (isConnection && !msFilter.controlService.checkFitFilter(cus, mFilter.enumFilter.customerJourney))
                isReset = true;

            var searchValues = [
                theAction.Name,
                theAction.Description,
                theAction.Purpose,
                theAction.ExpectedEffect,
                theAction.Arrived,
                theAction.Budget + "",
                theAction.ExpectedCost + "",
                theAction.ActualCost + "",
                theAction.ActualEffect + ""
            ];

            theAction.Status.forEach(t => {
                searchValues.push(t.Description);
            });

            theAction.ActionCosts.filter(t => t.DataState !== dataState.Deleted).forEach(t => {
                searchValues.push(t.Description);
                searchValues.push(t.FibuDescription);
            });

            if (!msFilter.controlService.checkFitTextSearch(searchValues))
                isReset = true;

            return isReset;
        };

        vmEditAction.checkFitTask = function (action) {
            var costs = action.ActionCosts.filter(t => t.DataState != dataState.Deleted);
            var todos = action.ActionTodos.filter(t => t.DataState != dataState.Deleted);

            //fix date
            costs.forEach(t => {
                if (typeof t.EndDate == "string") t.EndDate = t.EndDate.toDate();
            })

            todos.forEach(t => {
                if (typeof t.DueDate == "string") t.EndDate = t.EndDate.toDate();
            })

            var itemFilters = msFilter.controlService.getItemFilters(mFilter.enumFilter.date).filter(t => t.ParentValue > 0);
            if (itemFilters.length == 0) return true;

            //msFilter.enumDate = Object.freeze({ Overdue: 1, DueToday: 2, NextTenDays: 3, OverTenDays: 4, StillOpen: 5, AlreadyFnished: 6 });
            var notFitTypes = [];
            //AlreadyFnished
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.AlreadyFnished) && !costs.some(t => t.Finish) && !todos.some(t => t.Finish))
                notFitTypes.push(mFilter.enumDate.AlreadyFnished);

            //StillOpen
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.StillOpen) && !costs.some(t => !t.Finish) && !todos.some(t => !t.Finish))
                notFitTypes.push(mFilter.enumDate.StillOpen);


            //Overdue
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.Overdue)) {
                var today = new Date();

                var tempCosts = costs.filter(t => t.EndDate != null);
                var tempTodos = todos.filter(t => t.DueDate != null);

                if (!tempCosts.some(t => vmCommon.compareDate2(t.EndDate, today) == -1) && !tempTodos.some(t => vmCommon.compareDate2(t.DueDate, today) == -1))
                    notFitTypes.push(mFilter.enumDate.Overdue);
            }

            //DueToday
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.DueToday)) {
                var today = new Date();

                var tempCosts = costs.filter(t => t.EndDate != null);
                var tempTodos = todos.filter(t => t.DueDate != null);

                if (!tempCosts.some(t => vmCommon.compareDate2(t.EndDate, today) == 0) && !tempTodos.some(t => vmCommon.compareDate2(t.DueDate, today) == 0))
                    notFitTypes.push(mFilter.enumDate.DueToday);
            }

            //NextTenDays
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.NextTenDays)) {
                var nextTenDay = new Date(); nextTenDay.addDays(10);
                var today = new Date();

                var tempCosts = costs.filter(t => t.EndDate != null);
                var tempTodos = todos.filter(t => t.DueDate != null);

                if (!tempCosts.some(t => vmCommon.compareDate2(t.EndDate, today) > 0 && vmCommon.compareDate2(t.EndDate, nextTenDay) <= 0) && !tempTodos.some(t => vmCommon.compareDate2(t.DueDate, today) > 0 && vmCommon.compareDate2(t.DueDate, nextTenDay) <= 0))
                    notFitTypes.push(mFilter.enumDate.NextTenDays);
            }

            //OverTenDays
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.OverTenDays)) {
                var nextTenDay = new Date(); nextTenDay.addDays(10);

                var tempCosts = costs.filter(t => t.EndDate != null);
                var tempTodos = todos.filter(t => t.DueDate != null);

                if (!tempCosts.some(t => vmCommon.compareDate2(t.EndDate, nextTenDay) > 0) && !tempTodos.some(t => vmCommon.compareDate2(t.DueDate, nextTenDay) > 0))
                    notFitTypes.push(mFilter.enumDate.OverTenDays);
            }

            msFilter.controlService.removeItemFilterByParent(mFilter.enumFilter.date, notFitTypes);

            return notFitTypes.length == 0;
        };

        vmEditAction.setupLanguage();
        vmEditAction.setupLanguageCustomView();
        vmEditAction.bindPopUpEvent();

        vmEditAction.setupValidate();

        vmGoalAction.focusFirstInput('#area-edit-action');
        $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

        $("#tablecost input[data-role='datepicker'][name='start']").kendoDatePicker({
            weekNumber: true,
            change: function (e) {
                vmEditAction.viewModel.startDateChange(e);
            }
        });
        $("#tablecost input[data-role='datepicker'][name='end']").kendoDatePicker({
            weekNumber: true,
            change: function (e) {
                vmEditAction.viewModel.endDateChange(e);
            }
        });
        //startdate
        $("#tablecost input[data-role='datepicker'][name='start']").on("blur change", function (e) {
            $(this).tooltip("destroy");
            var text = $(this).val().trim();
            if (!text) {
                return;
            }

            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            vmEditAction.startDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.row").find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });

        //enddate
        $("#tablecost input[data-role='datepicker'][name='end']").on("blur change", function (e) {
            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            var text = $(this).val().trim();
            if (!text) {
                $(this).tooltip("destroy");
                return;
            }

            if (item.EndDate) {
                return;
            }

            vmEditAction.endDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.col-md-6").next().find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });

        bindAutoFocus();
        vmEditAction.initTabIndex();
        $('#txtName').on('change paste', function () {
            if (vmEditAction) vmEditAction.viewModel.action.Name = $(this).val();
            vmEditAction.activeModelChange();
        });

        vmEditAction.visibleCostField(customViewOption.HasCost);

        void function processHandleEventUI() {
            $('#popEditAction .modal-body.ms-modal-body').on('scroll', function (evnt) {
                if ($("#picker").data("kendoColorPicker").isClosed == false) {
                    $("#picker").data("kendoColorPicker").close();
                };
                $(document.body).find("[data-role=popup]").each(function () {
                    var popup = $(this).data("kendoPopup");
                    popup.close();
                });
            });
        }();

        if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
            vmDashboard.AddressBar.ClientQuery.updateAddressBar();
        } else if (typeof vmGoalAction === 'object') {
            vmCommon.AddressBar.ClientQuery.updateAddressBar();
        }

        vmGoalAction.autoSubHeight();
        vmEditAction.modelChanged = false;
        vmEditAction.AdjustPopupHeight();

    });
    function updateSrcAdv(adsingId) {
        if (adsingId) {
            var lstSrcAdv = vmGoalAction.setting.ActAdvertiser.filter(t => adsingId == t.ParentId);
            vmEditAction.viewModel.set('listActAdvertiser', lstSrcAdv);
            return;
        }
        const lsrSrcAsing = vmEditAction.viewModel.listActAdvertisingMaterial.filter(s => s.Id > 0);
        const lsrSrcAsingId = vmCommon.deepCopy(lsrSrcAsing.map(s => s.Id));
        var lstSrcAdv = vmGoalAction.setting.ActAdvertiser.filter(t => lsrSrcAsingId.includes(t.ParentId));
        vmEditAction.viewModel.set('listActAdvertiser', lstSrcAdv);
    }
    function setStateDelete(lstAdvIdIgnore) {
        const lstIgnore = Array.isArray(lstAdvIdIgnore) ? lstAdvIdIgnore : [];
        const lstKpiD = vmEditAction.viewModel.action.KpiData;
        var lstKpiDelIndx = [];
        lstKpiD.forEach((kpiD, i) => {
            if (kpiD.DataState != dataState.Added) {
                switch (true) {
                    // không có ignore, State = delete, list gốc đã có item (list lúc mở form edit)
                    case (!lstAdvIdIgnore && kpiD.DataState == dataState.Deleted && vmCommon.LstKpiData.find(or => or.AdvertiserId == kpiD.AdvertiserId)):
                    // nằm trong list ignore
                    case (lstIgnore.includes(kpiD.AdvertiserId)):
                        kpiD.DataState = dataState.Modified;
                        break;
                    default:
                        kpiD.DataState = dataState.Deleted;
                        kpiD.KpiIndexes.forEach(ki => ki.DataState = dataState.Deleted);
                        break;
                }
            } else {        // dataState == add thì remove đi 
                if (!lstIgnore.includes(kpiD.AdvertiserId))
                    lstKpiDelIndx.push(i);
            }
        });
        if (lstKpiDelIndx.length)
            lstKpiDelIndx.forEach(i => lstKpiD.splice(i, 1)); // xóa những item được add ở client (vì ở server chưa lưu item đó)
        
        var lstCurrentAdvId = vmCommon.deepCopy(vmEditAction.viewModel.action.ActionAdvertisers);
        lstCurrentAdvId = Array.isArray(lstCurrentAdvId) ? lstCurrentAdvId.map(a => a.Id) : [];
        lstKpiD.forEach(k => {
            if (!lstCurrentAdvId.includes(k.AdvertiserId) && k.DataState != dataState.Deleted)
                k.DataState = dataState.Deleted;
        });
        // #region kiểm tra list ban đầu có không (nghĩa là cache đang có item), nếu có thì set state = delete
        const lstState2 = vmCommon.deepCopy(vmCommon.LstKpiData.filter(k => k.DataState == 2));
        if (!lstKpiD.length && lstState2.length) {
            lstState2.forEach(k2 => {
                k2.DataState = dataState.Deleted;
                lstKpiD.push(k2);
            });
        }
        // #endregion check origin list (dùng cho trường hợp change Instruments)
    }
    function clearActionAdvertisers() {
        vmEditAction.viewModel.set('action.ActionAdvertisers', []);
    }
    setupTooltipAddTodoAddCost();

    vmEditAction.bindDate = function () {
        $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

        $("#tablecost input[data-role='datepicker'][name='start']").kendoDatePicker({
            weekNumber: true
            ,
            change: function (e) {
                vmEditAction.viewModel.startDateChange(e);
            }
        });
        $("#tablecost input[data-role='datepicker'][name='end']").kendoDatePicker({
            weekNumber: true
            ,
            change: function (e) {
                vmEditAction.viewModel.endDateChange(e);
            }
        });
        //startdate
        $("#tablecost input[data-role='datepicker'][name='start']").on("blur change", function (e) {
            $(this).tooltip("destroy");
            var text = $(this).val().trim();
            if (!text) {

                return;
            }

            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            vmEditAction.startDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.row").find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });

        //enddate
        $("#tablecost input[data-role='datepicker'][name='end']").on("blur change", function (e) {
            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            var text = $(this).val().trim();
            if (!text) {
                $(this).tooltip("destroy");
                return;
            }

            if (item.EndDate) {
                return;
            }

            vmEditAction.endDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.col-md-6").next().find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });
    };

    vmEditAction.updateKpiActionData = function () {
        var actionModel = vmEditAction.viewModel.action;
        var enableSI = vmGoalAction.checkEnableSI(actionModel);
        var endDate = changeHourOfDate(vmGoalAction.getIndexOfMaxDate(actionModel.ActionCosts).MaxDate);

        vmEditAction.viewModel.set("isVisibleKpi", vmEditAction.viewModel.isHasKpi && (actionModel.AdvertisingMaterial != null && actionModel.AdvertisingMaterial > 0 && actionModel.Advertiser != null && actionModel.Advertiser > 0));
        var isMultiSlct = vmEditAction.viewModel.isMultipleAdvertiser;
        vmEditAction.dataservice.getKpiSetting({
            Advertiser: actionModel.Advertiser,
            IsMultiSelect: isMultiSlct,
            Advertisers: !!actionModel.ActionAdvertisers ? actionModel.ActionAdvertisers.map(it => it.Id) : [],
            KpiFormatIds: actionModel.Formats.filter(function (it) { return it.DataState != dataState.Deleted; }).map(function (it) { return it.KpiFormatId; }),
            EnableSI: enableSI, EndDate: endDate
        }, function (res) {
            if (isMultiSlct) {
                var kpiDatas = vmCommon.deepCopy(actionModel.get('KpiData'));
                var delKDIndxs = [];
                if (kpiDatas.length >= res.value.length) {
                    kpiDatas.forEach((k, i) => {
                        var newKpi = res.value.find(nk => k.AdvertiserId == nk.AdvertiserId);
                        if (newKpi) {
                            if (k.DataState == dataState.Deleted && newKpi.DataState == dataState.Added) {
                                if (vmCommon.LstKpiData.find(or => or.AdvertiserId == newKpi.AdvertiserId)) {       // kiểm tra có trong list ban đầu khi mở popup không
                                    newKpi.DataState = dataState.Modified;
                                }
                                kpiDatas.splice(i, 1, newKpi); // replace
                            }
                        } else {
                            if (k.DataState != dataState.Added)
                                k.DataState = dataState.Deleted; // set state
                            else {
                                delKDIndxs.push(i);
                            }
                        }
                    });
                    if (delKDIndxs.length) {
                        delKDIndxs.forEach(i => kpiDatas.splice(i, 1));
                    }
                    res.value.forEach(nk => {
                        var tkpi = kpiDatas.find(k => k.AdvertiserId == nk.AdvertiserId);
                        if (!tkpi) {
                            if (vmCommon.LstKpiData.find(or => or.AdvertiserId == nk.AdvertiserId)) {       // kiểm tra có trong list ban đầu khi mở popup không
                                nk.DataState = dataState.Modified;
                            }
                            kpiDatas.push(nk);
                        }
                    });
                } else {
                    var newKpis = res.value.filter(nk => !kpiDatas.some(k => { return k.AdvertiserId == nk.AdvertiserId }));
                    newKpis.forEach(nk => {
                        if (vmCommon.LstKpiData.find(or => or.AdvertiserId == nk.AdvertiserId)) {       // kiểm tra có trong list ban đầu khi mở popup không
                            nk.DataState = dataState.Modified;
                        } else
                            nk.DataState = dataState.Added;

                        kpiDatas.push(nk);      // thêm những phần tử không có trong list kpiData
                    });
                }
                kpiDatas = kpiDatas.filter(adv => adv.AdvertiserId != null);
                actionModel.set('KpiData', kpiDatas.sort((a, b) => a.AdvertiserIndex - b.AdvertiserIndex)); // set lai model
            } else {
                var lstNewKpi = res.value;
                const lstKD = vmCommon.deepCopy(vmCommon.LstKpiData);
                if (Array.isArray(lstKD))
                    lstKD.forEach(ork => {
                        if (!lstNewKpi.find(nk => nk.AdvertiserId == ork.AdvertiserId)) {
                            ork.DataState = dataState.Deleted;
                            ork.KpiFormats.forEach(okf => {
                                okf.KpiFormatItems.forEach(kfi => { kfi.DataState = dataState.Deleted; } );
                                okf.DataState = dataState.Deleted;
                            });
                            res.value.push(ork);
                        }
                    });
                lstNewKpi = lstNewKpi.filter(adv => adv.AdvertiserId != null);
                actionModel.set('KpiData', lstNewKpi);
            }
            if (isMultiSlct) return;

            //fix date
            if (res.value.length && actionModel.KpiData[0]) {
                var kpiDt = actionModel.KpiData[0];
                if (kpiDt.KpiOutcomeTimes && kpiDt.KpiOutcomeTimes.length > 0 && kpiDt.KpiOutcomeTimes[0])
                    kpiDt.KpiOutcomeTimes[0].Name = endDate ? endDate : new Date();
            }
            var actioncosts = actionModel.ActionCosts;
            var formats = res.value.length ? (actionModel.KpiData[0] ? actionModel.KpiData[0].KpiFormats : []) : [];
            if (actioncosts.length === 1 && formats.length == 1) {
                var firstCost = actioncosts[0];
                var format = formats[0];

                if (firstCost.ExpectedCost == 0 && typeof format == 'object' && format.KpiFormatItems.length > 0) {
                    var costItem = vmCommon.findByFunc(format.KpiFormatItems, function (it) { return it.FTypeId == vmCommon.FormatType.COST; });

                    if (costItem != null && costItem.MValue != null && costItem.MValue != 0) {
                        firstCost.set("ExpectedCost", costItem.MValue.toNumber());
                        if (firstCost.DataState == dataState.Unchanged) firstCost.set("DataState", dataState.Modified);
                    }
                }
            }
        });
    };

    //ENTITY
    function KpiSettingData() {
        this.AccountId = null;
        this.ProjectId = null;
        this.CategoryId = null;
        this.ActionId = null;

        this.KpiIndexes = [];
        this.KpiFormats = [];
        this.KpiOutcomeTimes = [];

        this.DeletedItems = [];

        return this;
    };

    function KpiMasterData() {
        this.AccountId = 0;
        this.ProjectId = 0;
        this.ActionId = null;

        this.KpiMasterTopics = [];
        this.KpiMasterTimes = [];

        this.DeletedItems = [];
        this.DataState = dataState.Added;

        return this;
    };

    vmEditAction.addNewCategories = function (parenttype, type, name, htmlId) {
        if (!name || name.length === 0) return;

        var url = "../Handlers/SettingHandler.ashx?funcName=addcategories&projid=" + projectId;

        var cat = {};
        cat.Id = 0;
        cat.Name = name;
        cat.Type = type;
        cat.ParentType = parenttype;
        cat.NonArchive = false;

        callAjax('add-categori-loading', url, JSON.stringify(cat), function (data) {
            var response = data;
            switch (response) {
                case vmEditAction.enumCheckExistedCategoryName:
                    $(htmlId).tooltip('destroy');
                    $(htmlId).attr("title", kLg.msgDuplicateName);
                    $(htmlId).tooltip({ trigger: "manual" }).tooltip('show');
                    break;
                default:
                    vmEditAction.reloadCategoriesByType(parenttype, type, name);

                    if (!vmCommon.checkCurrentPage(vmCommon.enumPage.SubMarket))
                        msFilter.controlService.reLoadDataFilter();

                    var label = (kLg.lblNameSubjetThema.length < 16) ? kLg.lblNameSubjetThema : kLg.lblNameSubjetThema.substr(0, 15);
                    vmCommon.showNotification(htmlId, label + ' ' + kLg.SubjetThemaAddedSuf, 2000, 20, 300);
                    break;
            }
        }, AjaxConst.PostRequest);
    }

    vmEditAction.reloadCategoriesByType = function (parentType, type, name) {
        var url = "../Handlers/SettingHandler.ashx?funcName=getallcategoriesbytype&parentType=" + parentType + "&type=" + type + "&projid=" + projectId;

        callAjax('categories-loading', url, null, function (data) {
            vmGoalAction.setting.SubjetThemas = data.value;
            vmEditAction.viewModel.set("listSubjetThemas", data.value);
            vmEditAction.viewModel.set("subjetThemaName", name);

        }, AjaxConst.GetRequest);
    };

    vmEditAction.checkReminder = function (item) {
        if (vmEditAction.viewModel.action.People === null || vmEditAction.viewModel.action.People === undefined || vmEditAction.viewModel.action.People.length === 0) {
            if (vmEditAction.viewModel.action.PeopleInvolved === null || vmEditAction.viewModel.action.PeopleInvolved === undefined || vmEditAction.viewModel.action.PeopleInvolved.length === 0) {
                return false;
            }
        }
        if (item.Finish) {
            return false;
        }
        if (item.EndDate === null || item.EndDate === undefined) {
            return false;
        }
        var d = new Date();
        var enddate;
        if (Object.prototype.toString.call(item.EndDate) === "[object Date]") {
            enddate = item.EndDate;
        } else {
            enddate = new Date(parseInt(item.EndDate.substr(6)));
        }

        if (!compareDate(d, enddate) || equalDate(d, enddate)) {
            return false;
        }
        return true;
    }


    function equalDate(date1, date2) {
        if (date1.getYear() === date2.getYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate()) {
            return true;
        }
        return false;
    }

    function findMasterGoalInfo(type, source, masterId) {
        if (source == null || masterId == undefined) return "";
        var mginfo = "";
        var mgitem = null;
        for (var i = 0; i < source.length; i++) {
            if (source[i].Id === masterId) {
                mgitem = source[i];
                break;
            }
        }
        if (mgitem !== null) {
            switch (type) {
                case 1:
                    mginfo = mgitem.MasterBudget != null && mgitem.MasterBudget > 0 ? ("B: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.MasterBudget)) : "";
                    break;
                case 2:
                    mginfo = mgitem.ExpectedCost != null && mgitem.ExpectedCost > 0 ? ("P: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.ExpectedCost)) : "";
                    break;
                case 3:
                    mginfo = mgitem.ActualCost != null && mgitem.ActualCost > 0 ? ("C: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.ActualCost)) : "";
                    break;
                default:
                    break;
            }
        }

        return mginfo;
    }

    function isValidStatus() {
        var status = vmEditAction.viewModel.action.Status;

        var listStatus = $('#tableEditAction input[data-role=datepicker]:visible'),
            len = listStatus.length,
            i = 0;
        for (i; i < len; i++) {
            if ($(listStatus[i]).val() === "") continue;
            if ($(listStatus[i]).data("kendoDatePicker").value() == null) {
                if ($(listStatus[i]).val() === "") {
                    return true;
                }
                $(listStatus[i]).focus();
                return false;
            } else {
                status[i].Date = $(listStatus[i]).data("kendoDatePicker").value();
            }
        }
        return true;
    };

    function inputEvent(e) {
        var val = e.target.value;
        if (val.trim() == '') {
            DestroyToolTip($(e.target));
            $('#popEditAction #btnUpdate').prop('disabled', false);
        }
    };
    function isValidDate() {
        var isValidActCost = vmEditAction.validActionCost();
        var $todoDates = $('#todostablecost').find('input[data-role="datepicker"]');

        if ($todoDates.length > 0) {
            $todoDates.each(function () {
                var $this = $(this);
                if ($this.val() != '') {
                    var dateVal = $this.data("kendoDatePicker").value();
                    if (dateVal == null) {
                        ShowToolTip2($this, kLg.msgDateInValid);

                        // html element: $this.get(0);
                        $this.get(0).removeEventListener('input', inputEvent);
                        $this.get(0).addEventListener('input', inputEvent);

                        isValidActCost = isValidActCost && false;
                    } else {
                        DestroyToolTip($this);
                    }
                } else {
                    DestroyToolTip($this);
                }
            });
        };
        return isValidActCost;
    };

    $('#tableEditAction input[data-role=datepicker]').preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
    $("#tablecost input[data-role=datepicker]").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
    $('#tableEditAction input[data-role=datepicker]').kendoDatePicker({
        weekNumber: true
    });

    $('#tableEditAction').on("blur change", 'input[data-role=datepicker]', function (e) {
        if ($(this).val().length === 0) {
            $(this).tooltip('destroy');
            return true;
        }
        var dt = $(this).data("kendoDatePicker").value();
        if (dt == null) {
            $(this).attr("title", kLg.msgDateInValid);
            $(this).tooltip({ trigger: "manual" }).tooltip('show').attr("title", "");
            return false;
        }
        $(this).tooltip('destroy');
        return true;
    });

    //manhlv
    function compareDate(sdate, edate) {
        if (sdate.getYear() < edate.getYear()) return true;
        if (sdate.getYear() > edate.getYear()) return false;
        if (sdate.getMonth() < edate.getMonth()) return true;
        if (sdate.getMonth() > edate.getMonth()) return false;
        if (sdate.getDate() < edate.getDate()) return true;
        if (sdate.getDate() > edate.getDate()) return false;
        return true;
    }
    vmEditAction.popSelectAction = null;

    function showSelectAction() {
        if (!vmEditAction.viewModel.visibleUpStream() || vmEditAction.viewModel.isDisabledConStream || vmEditAction.viewModel.roleEdit)
            return;
        var entryData = { ActionId: vmEditAction.theAction.Id, RegionId: vmGoalAction.actionOptions.regionId || 0, IndependencyId: vmGoalAction.actionOptions.independencyId || 0 };
        vmEditAction.getSubMarketMenu(entryData, function (serData) {
            vmEditAction.getSubMarketMenuValue = serData.value;
            vmEditAction.actionStream = vmCommon.deepCopy(vmGoalAction.actionOptions.actionStream);

            vmEditAction.popSelectAction = showPopup(vmEditAction.popSelectAction,
                $('#popSelectAction'),
                vmCommon.rootUrl + 'Contents/MsPopSelectAction.html',
                {
                    title: kLg.titleSelectUpStream,
                    width: 800,
                    height: 525,
                    resizable: false,
                    scrollable: true
                }
            );
        });
    };

    vmEditAction.FindById = function (source, id) {
        return vmCommon.findByFunc(source, function (obj) { return obj.Id === id; });
    };

    function isValidStream() {
        if (!vmEditAction.isValidStream) {
            $("#area-edit-action #txtUpStream").focus();
        }

        return vmEditAction.isValidStream;
    };

    function isValidSub() {
        if (!vmEditAction.isValidSub) {
            $("#area-edit-action #txtSubPg").focus();
        }

        return vmEditAction.isValidSub;
    };

    function isValidClient() {
        if (!vmEditAction.isValidClient) {
            $("#area-edit-action #txtSubClient").focus();
        }

        return vmEditAction.isValidClient;
    };

    vmEditAction.checkDate = function (e) {
        var inputDate = $(e);

        inputDate.preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

        var statusdateString = inputDate.val();
        var dateString = vmCommon.autoFormatDateByLang(statusdateString, kLg.language);
        var kendoDateString = vmCommon.toKendoDatePickerString(dateString);

        if (!statusdateString && statusdateString.length < 1) {
            inputDate.tooltip('destroy');
        } else {
            inputDate.tooltip('destroy');
            inputDate.attr("title", kLg.msgDateInValid);
            inputDate.tooltip({ trigger: "manual" }).tooltip('show');
        }

        if (vmCommon.isDate(vmCommon.toEnDateString(dateString))) {
            inputDate.val(kendoDateString);

            var action = vmEditAction.viewModel.get("action");

            if (action) {
                var itemIndex = inputDate.closest("tr").index();
                var dateValue = new Date(vmCommon.toEnDateString(dateString));
                action.Status[itemIndex].Date = dateValue;
                vmEditAction.viewModel.set("action", action);
            }

            inputDate.tooltip('destroy');
        }

    };

    $("#area-edit-action").on("mouseenter", "li.group-sub", function (e) {
        var id = $(this).attr("oid");
        var typeId = $(this).attr("otype");

        //1:subproduct, 2:subclient
        var rtype = $(this).attr("rtype");

        if (id == undefined || typeId == undefined) {
            return;
        }

        id = Number(id);
        typeId = Number(typeId);
        if (isNaN(id) || isNaN(typeId)) return;

        if (vmEditAction.viewModel == undefined) return;

        var model = vmEditAction.viewModel;
        var labeSrc = undefined;

        var placement = "bottom";
        switch (rtype) {
            case "1":
                labeSrc = vmCommon.deepCopy(model.labeSubSrc);
                placement = "right";
                break;
            case "2":
                labeSrc = vmCommon.deepCopy(model.labeClientSrc);
                placement = "left";
                break;
        }

        if (labeSrc == undefined) return;

        var childTypeId = typeId + 1;
        var src = vmCommon.sortBy($.grep(labeSrc, function (it) { return it.ParentId === id && it.TypeId === childTypeId; }), "Index");

        var pos = $(this).position(), wid = $(this).width(), hei = $(this).height() + 12;
        var template = kendo.template($("#subchild").html());

        //1000: width of form, 410: max width of popover
        //var placement = 1000 - (pos.left + wid) > 410 ? "right" : pos.left > 410 ? "left" : "bottom";

        $(this).popover({
            html: true,
            content: template(src),
            title: kLg.titleSelectedSub,
            trigger: "hover",
            placement: placement
        }).popover("show");

        var popElem = $(this).next("div.popover");

        var arrows = $(popElem).children("div.arrow");
        if (arrows.length === 0) return;

        var arrowElem = arrows[0];
        if (placement !== "bottom") {
            //28: higher than element, 45: from popover top to element
            $(popElem).css({ top: (pos.top - 28) + "px" });
            $(arrowElem).css({ top: 45 + "px" });
        } else {
            $(popElem).css({ top: (pos.top + hei) + "px" });
        }
    });

    vmEditAction.bindToSaveCost = function (costs) {
        for (var i = 0, len = costs.length; i < len; i++) {
            var item = costs[i];
            item.StartDate = changeHourOfDate(item.StartDate);
            item.EndDate = changeHourOfDate(item.EndDate);

            if (item.DataState === dataState.Deleted)
                continue;

            if (item.Id) {
                maxIndex = item.MIndex;
            }

            if (isChangePosition) {
                item.MIndex = i;

                if (item.Id) {
                    item.DataState = dataState.Modified;
                }
            } else {
                if (item.Id === 0) {
                    item.MIndex = ++maxIndex;
                }
            }

            if (item.Id && item.DataState == dataState.Unchanged)
                item.DataState = dataState.Modified;
        }

        return costs;
    };

    //startdate
    vmEditAction.startDateChange = function (elem, item) {
        var text = $(elem).val().trim();
        var row = $(elem).closest("div.row-cost"); var endElem = $(row).find("input[name='end']");

        $(elem).tooltip("destroy");
        var temp = vmCommon.formatStringToDate(text, kLg.language);

        if (temp == null) {
            ShowToolTip2($(elem), kLg.msgDateInValid);
            return;
        }

        item.set("StartDate", temp);
        vmEditAction.viewModel.visibleUpStream();
        //3.valid
        if (item.StartDate == null) {
            ShowToolTip2($(elem), kLg.msgDateInValid);
            return;
        }

        //4.bind data
        if (item.NumberOfDay != null) {
            var newEndDate = new Date(item.StartDate);
            newEndDate.setDate(newEndDate.getDate() + item.NumberOfDay);
            item.set("EndDate", newEndDate);

            $(endElem).tooltip("destroy");

            vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);
        } else if (item.EndDate != null) {
            if (typeof item.EndDate === "string") {
                if (item.EndDate.indexOf("/Date") === -1) {
                    item.set("EndDate", new Date(item.EndDate));
                } else {
                    item.set("EndDate", item.EndDate.jsonToDate());
                }

                vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);
            }

            if (vmCommon.compareDate2(item.StartDate, item.EndDate) === 1) {

                return;
            }

            item.set("NumberOfDay", item.StartDate.days(item.EndDate));
            $(endElem).tooltip("destroy");
        } else {
            var newEndDateFirst = new Date(item.StartDate);
            item.set("EndDate", changeHourOfDate(newEndDateFirst));
            item.set("NumberOfDay", item.StartDate.days(item.EndDate));

            vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);

            $(endElem).tooltip("destroy");
        }

        item.StartDate = changeHourOfDate(item.StartDate);

        if (vmEditAction.viewModel.action.ActionUpStreamConnectionAction != null) {
            var limitedDate = vmEditAction.viewModel.action.ActionUpStreamConnectionAction.End;
            if (typeof limitedDate === "string") {
                limitedDate = limitedDate.toDate();
            }

            if (vmCommon.compareDate2(item.StartDate, limitedDate) === -1) {
                ShowToolTip2($(elem), kLg.msgValidDateWithUpStream);
                $(elem).attr("ertype", 1);
            }
        }

    };

    //enddate
    vmEditAction.endDateChange = function (elem, item) {
        var text = $(elem).val().trim();

        $(elem).tooltip("destroy");
        if (item.EndDate == null && text.length > 0) {
            var temp = vmCommon.formatStringToDate(text, kLg.language);

            if (temp == null) {
                ShowToolTip2($(elem), kLg.msgDateInValid);
                return;
            }
            item.set("EndDate", temp);
            vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);
        }

        //4.bind data
        if (item.StartDate == null || (typeof item.StartDate === "string" && !vmCommon.dateRangeIsValid(item.StartDate)) || item.EndDate == null) {
            item.set("NumberOfDay", null);
            vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);
            return;
        }

        item.EndDate = changeHourOfDate(item.EndDate);
        vmEditAction.changeKpiActionBySI(vmEditAction.viewModel.action);

        if (typeof item.StartDate === "string") {
            if (item.StartDate.indexOf("/Date") === -1) {
                item.set("StartDate", new Date(item.StartDate));
            } else {
                item.set("StartDate", item.StartDate.jsonToDate());
            }
        }

        if (item.StartDate == null) {
            return;
        }

        if (vmCommon.compareDate2(item.EndDate, item.StartDate) >= 0) {
            item.set("NumberOfDay", item.StartDate.days(item.EndDate));
        } else {
            ShowToolTip2($(elem), kLg.msgValidateStartEndDate);
            return;
        }

    };

    $("input.date-cost").on("keypress", function () {
        $(this).tooltip("destroy");
    });

    vmEditAction.validActionCost = function () {

        var rows = $("#tablecost").children(":visible");
        var costs = $.grep(vmEditAction.viewModel.action.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; });
        var flag = true;

        if (rows.length === 0)
            return true;

        var limitedDate = vmEditAction.viewModel.action.ActionUpStreamConnectionAction ? vmEditAction.viewModel.action.ActionUpStreamConnectionAction.End : null;
        if (typeof limitedDate === "string") {
            limitedDate = limitedDate.toDate();
        }

        for (var i = 0, len = rows.length; i < len; i++) {
            var row = rows[i], item = vmCommon.deepCopy(costs[i]);

            //find elements
            var startElem = $(row).find("input[name='start']"), dayElem = $(row).find("input[name='day']").prev(), endElem = $(row).find("input[name='end']");

            if (item.StartDate == null) {

                continue;
            }

            if (typeof item.StartDate === "string") {
                if (item.StartDate.indexOf("/Date") !== -1) {
                    item.StartDate = item.StartDate.jsonToDate();
                } else {
                    item.StartDate = new Date(item.StartDate);
                }
            }

            if (item.StartDate !== null && limitedDate != null && vmCommon.compareDate2(item.StartDate, limitedDate) === -1) {
                ShowToolTip2($(startElem), kLg.msgValidDateWithUpStream);
                //$(startElem).get(0).removeEventListener('input', inputEvent);
                //$(startElem).get(0).addEventListener('input', inputEvent);
                $(startElem).attr("ertype", 1);
                flag = false;
                continue;
            }

            if (item.EndDate == null) {
                continue;
            }

            if (typeof item.EndDate === "string") {
                if (item.EndDate.indexOf("/Date") !== -1) {
                    item.EndDate = item.EndDate.jsonToDate();
                } else {
                    item.EndDate = new Date(item.EndDate);
                }
            }

            if (item.StartDate != null && item.EndDate != null && vmCommon.compareDate2(item.EndDate, item.StartDate) >= 0) {
                continue;
            } else {
                flag = false;
                ShowToolTip2($(endElem), kLg.msgValidateStartEndDate);
                //$(endElem).get(0).removeEventListener('input', inputEvent);
                //$(endElem).get(0).addEventListener('input', inputEvent);
            }
        }

        return flag;
    };

    vmEditAction.bindActionCostByUpStream = function (upDate) {

        if (upDate)
            upDate = changeHourOfDate(upDate);

        if (!vmEditAction.viewModel.visibleUpStream()) return false;

        var costs = $.grep(vmEditAction.viewModel.action.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; });
        if (!upDate) {
            for (var i = 0, len = costs.length; i < len; i++) {
                if (costs[i].IsConnectionUp) {
                    costs[i].set("IsConnectionUp", false);

                    if (costs[i].Id && costs[i].DataState == dataState.Unchanged) {
                        costs[i].set("DataState", dataState.Modified);
                    }
                    //break;
                }
            }

            return true;
        }

        var temp = vmGoalAction.getIndexOfMinDate(costs);
        var minDate = temp.MinDate, minIndex = temp.MinIndex;

        var days = dateDiffInDays(minDate, upDate);
        for (var i = 0, len = costs.length; i < len; i++) {
            var item = costs[i];

            if (item.StartDate == null) {
                continue;
            }

            if (typeof item.StartDate === "string") {
                item.StartDate = item.StartDate.toDate();
            }

            var newStartDate = changeHourOfDate(new Date(item.StartDate));
            newStartDate.setDate(newStartDate.getDate() + days);
            item.set("StartDate", newStartDate);

            if (item.Id && item.DataState == dataState.Unchanged) {
                item.set("DataState", dataState.Modified);
            }

            if (i === minIndex) {
                item.set("IsConnectionUp", true);
            }

            if (item.NumberOfDay != null && item.EndDate != null) {
                if (typeof item.EndDate === "string") {
                    item.EndDate = item.EndDate.toDate();
                }

                var newEndDate = new Date(item.EndDate);
                newEndDate.setDate(newEndDate.getDate() + days);

                item.set("EndDate", newEndDate);
            }
        }

        setupTooltipAddTodoAddCost();
        return true;
    };

    vmEditAction.updateCostForAction = function (action) {
        var costs = $.grep(action.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; });
        var todos = action.ActionTodos;

        action.Finish = costs.every(function (it) { return it.Finish; }) && todos.every(function (it) { return it.Finish; });

        action.ExpectedCost = 0;
        action.ActualCost = 0;

        for (var i = 0, len = costs.length; i < len; i++) {
            costs[i].ExpectedCost = costs[i].ExpectedCost || 0;
            costs[i].ActualCost = costs[i].ActualCost || 0;

            action.ExpectedCost += costs[i].ExpectedCost;
            action.ActualCost += costs[i].ActualCost;
        }

        action.ExpectedCost = Math.round(action.ExpectedCost);
        action.ActualCost = Math.round(action.ActualCost);
    };

    vmEditAction.removeUpStreamTooltip = function () {
        $("#tablecost input[name='start'][ertype='1']").each(function (it) {

            $(this).tooltip("destroy");
            $(this).removeAttr("ertype");

        });
    }

    vmEditAction.showHideReminder = function (elements, type) {
        if (elements.length > 0) {
            for (var i = 0; i < elements.length; i++) {
                $(elements[i]).attr('style', 'display: ' + type);
            }
        }
    }

    function bindAutoFocus() {
        $("input[focusevent='cost-focus']").bind("focus", function () {
            var input = $(this);
            try {
                var costNumber = parseInt(input.val());
                if (costNumber === 0) input.val(null);
            } catch (e) {
                input.val(null);
            }
        });
    }

    function bindEndDateAutoformat() {
        //enddate
        $("#tablecost input[data-role='datepicker'][name='end']").off("blur change").on("blur change", function (e) {
            evaluateStreamConnection();

            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            var text = $(this).val().trim();
            if (!text) {
                $(this).tooltip("destroy");
                return;
            }

            if (item.EndDate) {
                return;
            }

            vmEditAction.endDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.col-md-6").next().find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });
    }

    function bindStartDateAutoformat() {
        //startdate
        $("#tablecost input[data-role='datepicker'][name='start']").off("blur change").on("blur change", function (e) {
            evaluateStreamConnection();
            $(this).tooltip("destroy");

            var index = $(this).closest("div.row-cost").index();
            var item = vmEditAction.viewModel.action.ActionCosts[index];

            var text = $(this).val().trim();
            if (!text) {
                //ShowToolTip2($(this), kLg.msgDateInValid);
                item.set("NumberOfDay", null);
                return;
            }

            vmEditAction.startDateChange(this, item);

            var elementsReminder = $(e.target).closest("div.row").find(".reminder");
            if (vmEditAction.checkReminder(item)) {
                vmEditAction.showHideReminder(elementsReminder, 'block');
            } else {
                vmEditAction.showHideReminder(elementsReminder, 'none');
            }
        });
    };

    function rebindMasterSource(lst, source) {
        //source
        var ids = $.grep(vmCommon.selectProperty(lst, "MasterId"), function (it) { return it !== vmCommon.emptyGuid; });
        var remains = $.grep(source, function (it) { return ids.indexOf(it.Id) === -1; });

        for (var i = 0; i < lst.length; i++) {
            var item = lst[i];
            item.Src = vmCommon.deepCopy(remains);

            if (item.MasterId !== vmCommon.emptyGuid) {
                for (var j = 0; j < source.length; j++) {
                    if (item.MasterId === source[j].Id) {
                        item.Src.splice(j, 0, source[j]);
                    }
                }
            }

            item.Src.unshift({ Id: vmCommon.emptyGuid, Name: "" });
        }

        //msCurrency
        var expectedCost = vmEditAction.theAction.ExpectedCost;
        var actualCost = vmEditAction.theAction.ActualCost;
        //cost
        for (var i = 0; i < lst.length; i++) {
            var item = lst[i];
            var masterItem = vmCommon.findById(item.MasterId, vmGoalAction.actionOptions.masterGoal || []);

            item.Budget = masterItem && masterItem.MasterBudget > 0 ? "B: " + masterItem.Currency + " " + masterItem.MasterBudget : "";
            item.ExpectedCost = masterItem && (masterItem.ExpectedCost > 0 || expectedCost > 0) ? "P: " + masterItem.Currency + " " + Math.round((masterItem.ExpectedCost + ((expectedCost * item.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "";
            item.ActualCost = masterItem && (masterItem.ActualCost > 0 || actualCost > 0) ? "C: " + masterItem.Currency + " " + Math.round((masterItem.ActualCost + ((actualCost * item.MPercent) / 100) * vmEditAction.getRating(masterItem.Currency, msCurrency)) * 10) / 10 : "";

        }
    };

    function getMasterSource(lst, source) {
        var ids = $.grep(vmCommon.selectProperty(lst, "MasterId"), function (it) { return it !== vmCommon.emptyGuid; });
        var remains = $.grep(source, function (it) { return ids.indexOf(it.Id) === -1; });

        remains.unshift({ Id: vmCommon.emptyGuid, Name: "" });

        return remains;
    };

    function toggleSingleMaster(flag) {
        if (flag) {
            $(".select-master").removeClass("w-93per").addClass("w-80per");
        } else {
            $(".select-master").removeClass("w-80per").addClass("w-93per");
        }
    }

    vmEditAction.validMasterBudget = function () {
        //clear alert
        vmEditAction.clearMasterAlert();
        var isValid = true;

        var controls = $("#masterdata .masteritem:visible");
        var datas = $.grep(vmEditAction.viewModel.action.MasterBudgets, function (it) { return it.DataState !== dataState.Deleted; });

        var masterIds = $.grep(vmCommon.selectProperty(datas, "MasterId"), function (it) { return it !== vmCommon.emptyGuid; });
        if ((datas.length === 0 || datas.length === 1) && masterIds.length === 0) return true;

        var total = 0;
        //valid each select-master
        for (var i = 0; i < datas.length; i++) {
            var item = datas[i];
            if (item.MasterId === vmCommon.emptyGuid && item.MPercent === 0) continue;

            if (item.MasterId === vmCommon.emptyGuid) {
                isValid = false;
                $(controls[i]).find(".masternotify").removeClass("hidden");
            }
        }

        if (!isValid) {
            ShowToolTip2($("#lblMasterGoal"), kLg.msgMissingMaster, "right");
            return false;
        };

        //valid each select percent
        for (var i = 0; i < datas.length; i++) {
            var item = datas[i];
            if (item.MasterId === vmCommon.emptyGuid && item.MPercent === 0) continue;

            total += item.MPercent;

            if (item.MPercent === 0) {
                isValid = false;
                $(controls[i]).find(".masternotify").removeClass("hidden");
            }
        }

        if (!isValid) {
            ShowToolTip2($("#lblMasterGoal"), kLg.msgGreaterThanZeroPercent, "right");
            return false;
        };

        //valid total percent
        if (total !== 100) {
            ShowToolTip2($("#lblMasterGoal"), kLg.msgTotalMasterBudget, "right");
            return false;
        }

        return true;
    };

    vmEditAction.clearMasterAlert = function () {
        $("#lblMasterGoal").tooltip("destroy");

        $("#masterdata .masteritem .masternotify").each(function () {
            $(this).addClass("hidden");
        });
    };

    vmEditAction.reCalculateMasterCost = function () { };

    vmEditAction.bindActionTemplateData = function (serData) {
        var actionData = serData.Action;
        var curAction = vmEditAction.viewModel.get("action");

        var $todobtn = $('#btnaddtodo');
        $todobtn.insertAfter($('#todostablecost')); // dua ra ngoai #todostablecost
        customViews = serData.CustomViews;
        customViewOption = vmEditAction.bindCustomView(customViews);

        vmEditAction.theAction.DateSpace = actionData.DateSpace;


        //aptitlelang
        if (actionData.ActionPlanEvalData && actionData.ActionPlanEvalData.APEvaluationData) {
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleX) actionData.ActionPlanEvalData.APEvaluationData.TitleX = kLg.lblApAxisX;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleY) actionData.ActionPlanEvalData.APEvaluationData.TitleY = kLg.lblApAxisY;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleZ) actionData.ActionPlanEvalData.APEvaluationData.TitleZ = kLg.lblApAxisZ;

            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleNegativeX) actionData.ActionPlanEvalData.APEvaluationData.TitleNegativeX = kLg.lblNegative;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleNeutralX) actionData.ActionPlanEvalData.APEvaluationData.TitleNeutralX = kLg.lblNeutral;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitlePositiveX) actionData.ActionPlanEvalData.APEvaluationData.TitlePositiveX = kLg.lblPositive;

            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleNegativeY) actionData.ActionPlanEvalData.APEvaluationData.TitleNegativeY = kLg.lblNegative;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitleNeutralY) actionData.ActionPlanEvalData.APEvaluationData.TitleNeutralY = kLg.lblNeutral;
            if (!actionData.ActionPlanEvalData.APEvaluationData.TitlePositiveY) actionData.ActionPlanEvalData.APEvaluationData.TitlePositiveY = kLg.lblPositive;
        }

        //important value
        actionData.Id = curAction.Id;
        actionData.Mdf = curAction.Mdf;
        actionData.SubMarketProductId = curAction.SubMarketProductId;
        actionData.IndependencyId = curAction.IndependencyId;
        actionData.IsFinishAll = curAction.IsFinishAll;
        actionData.IsVisibilityAll = curAction.IsVisibilityAll;
        actionData.SubProducts = curAction.SubProducts;
        actionData.MasterBudgets = curAction.MasterBudgets;
        actionData.MasterId = curAction.MasterId;
        actionData.ActionPlanColumnId = vmEditAction.theAction.ActionPlanColumnId;
        actionData.IsFromTemplate = true;
        //actionData.Links = curAction.Links;

        for (var i = curAction.Links.length - 1; i >= 0; i--) {
            var link = curAction.Links[i];
            if (link.Id > 0) {
                link.set("IsShow", false);
                link.set("DataState", dataState.Deleted);
            }
            else
                curAction.Links.splice(i, 1);
        }
        actionData.Links = curAction.Links;

        for (var h1 = 0; h1 < actionData.MasterBudgets.length; h1++) {
            actionData.MasterBudgets[h1].DataState = 4;
        }

        var peos = vmCommon.pushApply([], actionData.People, function (item) { return { AccountId: item.AccountId, Email: item.Email }; });
        actionData.People = peos;

        var peosInvolved = vmCommon.pushApply([], actionData.PeopleInvolved, function (item) { return { AccountId: item.AccountId, Email: item.Email }; });
        actionData.PeopleInvolved = peosInvolved;

        //rebind status list
        var oldSts = $.grep(curAction.Status, function (s) { return s.Id !== vmCommon.emptyGuid });
        $.each(oldSts, function (t) {
            oldSts[t].IsOrigin = false;
        });

        var sts = vmCommon.pushApply(oldSts, actionData.Status, function (item) {
            return { ActionId: vmCommon.emptyGuid, CreatedBy: 0, CreatedDate: new Date(), Date: item.Date, Description: item.Description, GoalId: actionData.Id, Id: item.Id, IsOrigin: true, Mdf: 0, ModifiedBy: 0, ModifiedDate: new Date(), StatusId: item.StatusId, IsNew: true };
        });

        actionData.Status = sts;
        //rebulding source for advertising/advertiser
        if (customViewOption.HasAdvertising) {
            //get default advertising
            let sDefaultAdv = customViews[vmCommon.ActionCustomViewType.ADVERTISING].DefaultValue;
            var defaultAdvertising = sDefaultAdv ? sDefaultAdv.split(',').filter(e => { return e != ''; }) : [];
            if (defaultAdvertising.length > 0) {
                defaultAdvertising = defaultAdvertising.map(f => { return Number(f); });
            }
            else defaultAdvertising = null;

            //get default advertiser
            var defaultAdvertiser = customViewOption.HasAdvertiser ? customViews[vmCommon.ActionCustomViewType.ADVERTISER].DefaultValue : null;
            if (defaultAdvertiser) {
                defaultAdvertiser = defaultAdvertiser.split(',').filter(e => {
                    return e != '';
                }).map(f => Number(f));

                if (defaultAdvertiser.length < 1 || defaultAdvertising.length > 1)
                    defaultAdvertiser = null;
            }
            else
                defaultAdvertiser = null;

            // building source
          
            if (defaultAdvertising == null || defaultAdvertising.length == 1) {
                vmEditAction.viewModel.set('listActAdvertisingMaterial', vmGoalAction.setting.ActAdvertisingMaterial);
            } else {
                let sourceActAdvertisingMaterial = vmGoalAction.setting.ActAdvertisingMaterial.filter(a => {
                    let f = defaultAdvertising.find(e => { return e == a.Id });
                    return f != undefined || a.Id < 0;
                });

                vmEditAction.viewModel.set('listActAdvertisingMaterial', sourceActAdvertisingMaterial);
            }

            if (vmEditAction.viewModel.isHasKpi)
                vmEditAction.viewModel.set('isMultipleAdvertiserShow', actionData.AdvertisingMaterial == -2);
            vmEditAction.viewModel.set('isMultipleAdvertiser', actionData.AdvertisingMaterial == -2);
            vmEditAction.viewModel.set('listActAdvertiser', actionData.AdvertisingMaterial > 0 ? vmGoalAction.setting.ActAdvertiser.filter(t => t.ParentId == actionData.AdvertisingMaterial) : vmGoalAction.setting.ActAdvertiser);

            if (actionData.AdvertisingMaterial == -2) {
                vmEditAction.viewModel.set('action.ActionAdvertisers', actionData.ActionAdvertisers);
            }

        }

        vmEditAction.viewModel.set("action", actionData);

        var $rowtodoicon = $("#todostablecost .row.todos").last();
        if ($rowtodoicon.length < 1) {
            $todobtn.css({ "right": "14px", "margin-top": "0px" });
        } else {
            $('.popover.fade.top.in').remove();
            var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
            $('#btnaddtodo').insertAfter($icondeletewhentodo);
            $('#btnaddtodo').css({ "right": "6px", "margin-top": "1px" });
        }

        var actionModel = vmEditAction.viewModel.action;

        if (vmGoalAction.actionOptions.isEdit) {
            vmFile.setFileFromOtherSource(actionData.Files);
            vmFile.isSaveFromOtherSource = true;
        }

        var subjetThemaTempObj = vmCommon.findByFunc(vmGoalAction.setting.SubjetThemas, function (it) { return it.Id === actionData.SubjetThema; });
        vmEditAction.viewModel.set("listSubjetThemas", vmGoalAction.setting.SubjetThemas);
        vmEditAction.viewModel.set("subjetThemaName", subjetThemaTempObj !== null ? subjetThemaTempObj.Name : "");
        vmEditAction.viewModel.updateTotalCost();
        vmEditAction.activeModelChange();

        var isExpandWidth = $.grep(vmEditAction.viewModel.action.ActionCosts, function (it) { return it.DataState !== dataState.Deleted; }).length > 1;
        vmEditAction.viewModel.set("enableRemoveCost", isExpandWidth);
        vmEditAction.AutoWidthByTodoCost(vmEditAction.viewModel.action);

        //actionplanregion
        var autoRegionSrc = vmEditAction.getSourceForSub(actionData.ActionPlanRegions, false),
            labeRegionSrc = vmEditAction.getSourceForSub(actionData.ActionPlanRegions, true);

        vmEditAction.viewModel.set("autoRegionSrc", autoRegionSrc);
        vmEditAction.viewModel.set("labeRegionSrc", labeRegionSrc);

        //actionplansubclient
        var autoClientSrc = vmEditAction.getSourceForSub(actionData.SubClientGroups, false),
            labeClientSrc = vmEditAction.getSourceForSub(actionData.SubClientGroups, true);

        vmEditAction.viewModel.set("autoClientSrc", autoClientSrc);
        vmEditAction.viewModel.set("labeClientSrc", labeClientSrc);

        vmGoalAction.subService.groupClient();

        //actionplansubproduct
        var autoSubSrc = vmEditAction.getSourceForSub(actionData.SubProductGroups, false),
            labeSubSrc = vmEditAction.getSourceForSub(actionData.SubProductGroups, true);

        vmEditAction.viewModel.set("autoSubSrc", autoSubSrc);
        vmEditAction.viewModel.set("labeSubSrc", labeSubSrc);

        vmGoalAction.subService.groupSub();

        //actionplancustomerjourney
        var autoCusSrc = vmEditAction.getSourceForSub(actionData.CustomerJourneyGroups, false),
            labeCusSrc = vmEditAction.getSourceForSub(actionData.CustomerJourneyGroups, true);

        vmEditAction.viewModel.set("autoCusSrc", autoCusSrc);
        vmEditAction.viewModel.set("labeCusSrc", labeCusSrc);

        vmGoalAction.subService.groupCus();

        vmEditAction.viewModel.set("isVisibleSelectedSub", labeSubSrc.length > 0);
        vmEditAction.viewModel.set("isVisibleSelectedRegion", labeRegionSrc.length > 0);
        vmEditAction.viewModel.set("isVisibleSelectedClient", labeClientSrc.length > 0);
        vmEditAction.viewModel.set("isVisibleSelectedCus", labeCusSrc.length > 0);

        vmEditAction.viewModel.set("customViewOption", customViewOption);
        vmEditAction.setupLanguageCustomView();
        vmEditAction.synchronizedViews();
        
        //category
        var cates = vmEditAction.getCategorySrc();
        var cateIds = cates.map(t => t.Id);
        actionModel.set("Categories", actionModel.Categories.filter(t => cateIds.indexOf(t.Id) >= 0));
        actionModel.ActionTodos.forEach(t => {
            if (t.CategoryId > 0 && cateIds.indexOf(t.CategoryId) == -1) t.set("CategoryId", null);
        });

        actionModel.ActionCosts.forEach(t => {
            if (t.CategoryId > 0 && cateIds.indexOf(t.CategoryId) == -1) t.set("CategoryId", null);
        });
        vmEditAction.viewModel.set("listActionCategory", cates);

        vmEditAction.viewModel.set("isVisibleKpi", vmEditAction.viewModel.isHasKpi && (actionModel.AdvertisingMaterial != null && actionModel.AdvertisingMaterial > 0 && actionModel.Advertiser != null && actionModel.Advertiser > 0));
        vmEditAction.syncActionPlanConnection.syncType(vmEditAction.viewModel, vmCommon.KpiGoalTopicType.Goal);

        vmEditAction.bindDate();

        vmCommon.TexEditor.setEditorObserver(['#txt-area-description', '#txt-area-expectedeffect', '#txt-area-actualeffect']);

    };

    vmEditAction.closePopTemplate = function () {
        vmEditAction.popTemplate.destroy();
        vmEditAction.popTemplate = null;
        $(".navbar-collapse.collapse.block-nav").after("<div id='popEditTemplate'></div>");
    };

    vmEditAction.deleteTemplate = function () {
        var temps = vmEditAction.viewModel.get("templateSource");
        var curTemplate = vmEditAction.viewModel.get("templateId");
        var delTemps = [];
        $("#popEditTemplate input[type=checkbox]:checked").each(function () {
            delTemps.push(this.id);
        });

        if (delTemps.length > 0) {
            ynConfirm(kLg.confirmDeleteLabel).then(function () {
                vmEditAction.dataservice.deleteTemplateByList({ temps: delTemps }, function (res) {
                    if (res.value > 0) {
                        for (var i = 0, len = delTemps.length; i < len; i++) {
                            var tid = delTemps[i];
                            temps.remove(vmEditAction.FindById(temps, tid));
                            $(tid).checked = false;

                            if (curTemplate && curTemplate.Id === tid) {
                                vmEditAction.viewModel.set("templateId", null);
                                //vmEditGoal.optionTemp.Applying = null;
                                //reload file assigned
                                vmFile.reLoadFileAssigned();
                            }
                        }
                        vmEditAction.viewModel.set("templateSource", temps);
                        if (temps.length === 0) {
                            vmEditAction.viewModel.set("isActiveTemp", false);
                            //setLabelForDropTemplate();
                        }
                    }
                    vmEditAction.closePopTemplate();
                });

            }, function () {
                vmEditAction.closePopTemplate();
            });
        } else {
            vmEditAction.closePopTemplate();
        }
    };

    vmEditAction.changeKpiActionBySI = function (action) {
        var enableSI = vmGoalAction.checkEnableSI(action);
        if (action.KpiData == null || action.KpiData.length == 0) return;

        for (var x = 0; x < action.KpiData.length; x++) {
            var kpiAction = action.KpiData[x];

            if (kpiAction.DataState == dataState.Deleted) continue;

            var times = kpiAction.KpiOutcomeTimes;
            var indexes = kpiAction.KpiIndexes;

            for (var i = times.length - 1; i >= 0; i--) {
                var time = times[i]
                if (time.IsAuto) {
                    var xTimes = times.splice(i, 1);
                    if (xTimes.length == 0) continue;

                    var xTime = xTimes.first();
                    if (xTime.Id > 0) kpiAction.DeletedItems.push({ Id: xTime.Id, Type: vmCommon.KpiGoalType.TIME });

                    for (var j = 0; j < indexes.length; j++) {
                        var index = indexes[j];
                        var xTimeIndexes = index.KpiIndexTimes.splice(i, 1);
                        if (xTimeIndexes.length == 0) continue;

                        var xTimeIndex = xTimeIndexes.first();
                        if (xTimeIndex.Id > 0) kpiAction.DeletedItems.push({ Id: xTimeIndex.Id, Type: vmCommon.KpiGoalType.INDEXTIME });
                    }
                }
            }
            vmEditAction.calculateIndex(kpiAction);
            if (enableSI == false) continue;

            if (indexes == undefined || indexes.length == 0) continue;
            if (!indexes.some(function (it) { return it.DataState != dataState.Deleted && it.IsKpiDefault; })) continue;

            var maxDate = vmGoalAction.getIndexOfMaxDate(action.ActionCosts).MaxDate;
            //TODO: remove same time columns
            for (var i = times.length - 1; i >= 0; i--) {
                var time = times[i]
                if (time.Name && typeof (time.Name) == "string") {
                    time.Name = time.Name.toDate();
                }

                if (vmCommon.compareDate2(time.Name, maxDate) === 0) {
                    var xTimes = times.splice(i, 1);
                    if (xTimes.length == 0) continue;

                    var xTime = xTimes.first();
                    if (xTime.Id > 0) kpiAction.DeletedItems.push({ Id: xTime.Id, Type: vmCommon.KpiGoalType.TIME });

                    for (var j = 0; j < indexes.length; j++) {
                        var index = indexes[j];
                        var xTimeIndexes = index.KpiIndexTimes.splice(i, 1);
                        if (xTimeIndexes.length == 0) continue;

                        var xTimeIndex = xTimeIndexes.first();
                        if (xTimeIndex.Id > 0) kpiAction.DeletedItems.push({ Id: xTimeIndex.Id, Type: vmCommon.KpiGoalType.INDEXTIME });
                        //TODO: recalculate
                    }
                }
            }
            vmEditAction.calculateIndex(kpiAction);

            //maxDate is alway not null
            var maxTimeIndex = vmCommon.findIndexByFunc(times, function (it) {
                if (it.Name && typeof (it.Name) == "string") {
                    it.Name = it.Name.toDate();
                }

                return vmCommon.compareDate2(it.Name, maxDate) === 0;
            });

            if (maxTimeIndex === -1) {
                //add time
                var timeId = 0, timeIndex = 0;
                for (i = 0; i < times.length; i++) {
                    var time = times[i];

                    if (time.Name && typeof (time.Name) == "string") {
                        time.Name = time.Name.toDate();
                    }

                    if (timeId > time.Id) timeId = vmCommon.deepCopy(time.Id);
                    if (timeIndex < time.MIndex) timeIndex = vmCommon.deepCopy(time.MIndex);
                }
                times.unshift({ Id: --timeId, Name: changeHourOfDate(maxDate), MIndex: ++timeIndex, ActionId: null, DataState: dataState.Added, IsAuto: true });

                maxTimeIndex = 0;
            }

            //get min outcomeId
            var outcomeTimeId = 0;
            for (i = 0; i < kpiAction.KpiIndexes.length; i++) {
                var index = kpiAction.KpiIndexes[i];

                for (j = 0; j < index.KpiIndexTimes.length; j++) {
                    var indextime = index.KpiIndexTimes[j];
                    if (outcomeTimeId > indextime.Id) outcomeTimeId = vmCommon.deepCopy(indextime.Id);
                }
            }

            var maxTime = kpiAction.KpiOutcomeTimes[maxTimeIndex];
            for (var i = 0; i < indexes.length; i++) {
                var index = kpiAction.KpiIndexes[i];

                //kpi-index
                if (index.IsKpiDefault) {
                    index.LstValue = index.ExpectedValue;
                    index.KpiPercent = (index.ExpectedValue != null && index.ExpectedValue != 0 && index.LstValue != null) ? 100 : null;
                    if (index.DataState == dataState.Unchanged) index.DataState = dataState.Modified;
                }

                var indexTime = vmCommon.findByFunc(index.KpiIndexTimes, function (it) { return it.KpiActionIndexId == index.Id && it.KpiOutcomeTimeId == maxTime.Id && it.DataState != dataState.Deleted; });
                if (indexTime == undefined) {
                    indexTime = { Id: --outcomeTimeId, KpiActionIndexId: index.Id, KpiOutcomeTimeId: maxTime.Id, KpiValue: index.IsKpiDefault ? index.LstValue : null, DataState: dataState.Added };
                    index.KpiIndexTimes.splice(maxTimeIndex, 0, indexTime);
                }

                //TODO: recalculate
            }

            vmEditAction.calculateIndex(kpiAction);
        }

        return;
    };

    vmEditAction.calculateIndex = function (kpiAction) {
        if (kpiAction == null) return;

        var times = kpiAction.KpiOutcomeTimes;
        var indexes = kpiAction.KpiIndexes;

        //
        var getMaxTime = function (times) {
            var maxTime = null;
            if (times.length > 0) {
                maxTime = vmCommon.deepCopy(times[0]);
                maxTime.index = 0;

                for (var i = 1; i < times.length; i++) {
                    var time = vmCommon.deepCopy(times[i]);
                    if (vmCommon.compareDate2(new Date(maxTime.Name), new Date(time.Name)) === -1) {
                        maxTime = time;
                        maxTime.index = i;
                    }
                }
            }

            return maxTime;
        };

        //
        var calculateImplement = function (index) {

            if (index.ExpectedValue == null || index.ExpectedValue == 0) {
                index.KpiPercent = null;
            } else if (index.LstValue == null) {
                index.KpiPercent = null;
            } else {
                index.KpiPercent = Number(((Number(index.LstValue) / Number(index.ExpectedValue)) * 100).toFixed(2));
            }

            if (index.DataState === dataState.Unchanged) index.DataState = dataState.Modified;
        };

        //
        var orderTime = function (times) {
            var newArr = [];

            var temps = vmCommon.deepCopy(times);
            if (temps.length > 1) {
                while (temps.length > 0) {
                    var maxTime = getMaxTime(temps);
                    newArr.push(maxTime);

                    temps.splice(maxTime.index, 1);
                }

            } else if (temps.length === 1) {
                newArr.push(temps[0]);
            }

            return newArr;
        };

        var validTimes = $.grep(times, function (it) { return !it.isInvalid; });
        var orderTimes = orderTime(validTimes);

        var i, j;
        var enableSIx = vmGoalAction.checkEnableSI(vmEditAction.viewModel.action);
        for (i = 0; i < indexes.length; i++) {
            var index = indexes[i];
            if (enableSIx && index.IsKpiDefault) continue;

            var newLstValue = null;
            for (j = 0; j < orderTimes.length; j++) {
                var time = orderTimes[j];
                var indextime = index.KpiIndexTimes.find(it => it.KpiActionIndexId === index.Id && it.KpiOutcomeTimeId === time.Id);// vmCommon.findByFunc(index.KpiIndexTimes, function (it) { return it.KpiActionIndexId === index.Id && it.KpiOutcomeTimeId === time.Id; });

                if (indextime.KpiValue != null) {
                    newLstValue = indextime.KpiValue;

                    break;
                }
            }

            index.LstValue = newLstValue;
            if (index.DataState === dataState.Unchanged) index.DataState = dataState.Modified;

            calculateImplement(index);
        }
    };

    vmEditAction.getMasterKpi = function (action) {
        if (action.GoalId == null) return [];

        return vmGoalAction.getMasterKpiForAction(action.SubMarketProductId, action.IndependencyId, action.GoalId);
    };

    function checkShowTodoReminder(todo) {

        if (!todo) return false;
        var peoples = [];
        vmCommon.pushApply(peoples, todo.Persons, null, function (y) { return y.PersonType == 1; });

        if (peoples === null
            || peoples === undefined
            || peoples.length <= 0
            || todo.Finish
            || todo.DueDate === null
            || todo.DueDate === undefined) return false;

        var d = new Date();
        var enddate;
        if (Object.prototype.toString.call(todo.DueDate) === "[object Date]") {
            enddate = todo.DueDate;
        } else {
            try {
                enddate = new Date(todo.DueDate);
            } catch (e) {
                enddate = new Date(parseInt(todo.DueDate.substr(6)));
            }

        }

        if (!compareDate(d, enddate) || equalDate(d, enddate)) {
            return false;
        }

        return true;
    }

    var countBindTodoControl = 0;

    function bindCustomPersonInputEvent(todoId) {
        $("div[todopersonid~='" + todoId + "'] input.k-input").on('keyup', function (e) {
            if (e.keyCode === 13) {

                var todoValue = $(e.target).val();
                if (todoValue.trim().length <= 0) return;
                if (vmCommon.findByFunc(vmEditAction.viewModel.listTodoPersons, function (xx) { return xx.PersonName == todoValue; }) != null) return;
                var todoItem = vmCommon.findByFunc(vmEditAction.viewModel.action.ActionTodos, function (xx) { return xx.Id == todoId; });

                var widget = $("div[todopersonid~='" + todoId + "'] select").getKendoMultiSelect();
                var dataSource = widget.dataSource;

                var x1 = [];

                dataSource.data().map(t => x1.push({ Id: t.PersonId }));

                var newId = vmCommon.getNewId(x1);

                var newAccount = {
                    PersonId: newId,
                    PersonIdTmp: 2 + '_' + newId,
                    PersonName: $(e.target).val(),
                    PersonType: 2,
                    FirstName: $(e.target).val(),
                    LastName: $(e.target).val(),
                    PersonEmail: ''
                };

                vmEditAction.viewModel.listTodoPersons.push(newAccount);

                if (todoItem != null) {
                    var tempPersons = vmCommon.deepCopy(todoItem.Persons);
                    tempPersons.push(newAccount);
                    var listAcc = tempPersons.sort(SortByLastName);
                    todoItem.set("Persons", listAcc);
                }
            }
        });
    }

    function hasActionCostDateInvalid(listAc) {

        if (!listAc || listAc.length <= 0) return true;
        var checkObject = vmCommon.findByFunc(listAc, function (x) { return x.StartDate === undefined || x.StartDate === null; });
        return checkObject !== null;
    }

    function evaluateStreamConnection(ac) {

        var aCost = ac ? ac : vmEditAction.viewModel.action.ActionCosts;
        if (hasActionCostDateInvalid(aCost)) {
            vmEditAction.viewModel.set("isDisabledConStream", true);
        }
        else {
            vmEditAction.viewModel.set("isDisabledConStream", false);
        }
    };

    $("input[type=text]").bind("paste", function (e) {
        var model = vmEditAction.viewModel;

        var id = $(e.target).attr("id");
        if (id) id = id.toLowerCase();
        var value = $(e.target).val().trim();

        switch (id) {
            case "txtname":
                model.action.set("Name", value);
                break;
        }
    });

    function setupTodoDragDrop() {
        var el = "#todostablecost";
        var sTodoIndex, tTodoIndex;
        $(el).sortable({
            axis: "y",
            items: "div.todos",
            helper: function (event, ui) {
                var $clone = $(ui).clone();
                $clone.css("position", "absolute");
                
                return $clone.get(0);
            },
            cursor: "n-resize",
            revert: false,
            opacity: 0.5,
            zIndex: 10003,
            tolerance: "pointer",
            containment: $(el),
            start: function (event, ui) {
                sTodoIndex = ui.item.index();
                $('#area-edit-action .modal-body.ms-modal-body').css({ "overflow-x": "hidden" });
                $('#btnaddtodo').css({'opacity' : '0'})
            },
            stop: function (event, ui) {
                $('#btnaddtodo').css({ 'opacity': '' })
                tTodoIndex = ui.item.index();
                var tmpTodos = vmEditAction.viewModel.action.ActionTodos;
                var todos = vmCommon.deepCopy(tmpTodos);
                $('#area-edit-action .modal-body.ms-modal-body').css({ "overflow-x": " " });
                
                if (todos.length <= 1) return;

                for (var i = 0; i < todos.length; i++) {
                    todos[i].DueDate = tmpTodos[i].DueDate;
                }
                var temp = todos.splice(sTodoIndex, 1);
                todos.splice(tTodoIndex, 0, temp[0]);
                $('#btnaddtodo').insertAfter($('#todostablecost'));
                $('#btnaddtodo').css({ 'margin-top': '0px', 'right': '6px' })
                vmCommon.updatePosition(todos);
                vmEditAction.viewModel.set("action.ActionTodos", todos);
                setTimeout(function () {
                    for (var i = 0; i < todos.length; i++) {
                        bindCustomPersonInputEvent(todos[i].Id);
                    }
                }, 222);

                vmEditAction.autoStyleForTodos(vmEditAction.viewModel.action.ActionCosts.filter(t => t.DataState !== dataState.Deleted).length > 1 || vmEditAction.viewModel.action.ActionTodos.filter(t => t.DataState !== dataState.Deleted).length > 0);

                var $rowtodoicon = $("#todostablecost .row.todos").last();
                if ($rowtodoicon.length > 0) {
                    var $icondeletewhentodo = $rowtodoicon.find('.icondeletewhentodo').first();
                    $('#btnaddtodo').insertAfter($icondeletewhentodo);
                }

                // dainb rebind validate date time
                setBlurTodoDateChange();
            }
        });

    };


    vmEditAction.getSelectableTopics = function () {
        var lst = [];
        
        if (vmGoalAction.actionOptions.kpiGoalSelectable) lst.push(vmCommon.KpiGoalTopicType.Goal);

        return lst;
    };

    vmEditAction.syncActionPlanConnection = function () {
        var model;

        var syncRegion = function (topic) {
            var indexes = topic ? topic.KpiMasterIndexes.filter(index => index.TypeId == 2) : [];
            var labeSrc = model.labeRegionSrc;
            var autoSrc = model.autoRegionSrc;

            var newItems = indexes.filter(a => !labeSrc.some(b => b.ObjectId == a.LongLinkId));
            var delItems = labeSrc.filter(a => !indexes.some(b => b.LongLinkId == a.ObjectId));

            delItems.forEach(t => {
                var delIndex = labeSrc.indexOf(t);
                if (delIndex <= -1) return;

                if (t.Id > 0) t.set("DataState", dataState.Deleted);
                autoSrc.push(t);
                labeSrc.splice(delIndex, 1);
            });

            newItems.forEach(t => {
                var newItem = autoSrc.find(x => x.ObjectId == t.LongLinkId);
                if (newItem == undefined) return;

                var newIndex = autoSrc.indexOf(newItem);
                if (newItem.Id > 0) newItem.set("DataState", dataState.Modified);
                labeSrc.push(newItem);
                autoSrc.splice(newIndex, 1);
            });

            model.set("isVisibleSelectedRegion", labeSrc.length > 0);
            model.setVisibleKpi();
        };

        var syncProduct = function (topic) {
            var indexes = topic ? topic.KpiMasterIndexes : [];
            var labeProduct = model.displaySrc;

            var labeSrc = model.labeSubSrc;
            var autoSrc = model.autoSubSrc;

            var newItems = indexes.filter(a => !labeProduct.some(b => b.ObjectId == a.LongLinkId && ((a.TypeId == 6 && b.TypeId == 1) || (a.TypeId == 7 && b.TypeId == 2) || (a.TypeId == 8 && b.TypeId == 3))));
            var delItems = labeProduct.filter(b => !indexes.some(a => a.LongLinkId == b.ObjectId && ((a.TypeId == 6 && b.TypeId == 1) || (a.TypeId == 7 && b.TypeId == 2) || (a.TypeId == 8 && b.TypeId == 3))));

            delItems.forEach(t => {
                var delIndex = vmCommon.findIndexByFunc(model.labeSubSrc, function (it) { return it.ObjectId == t.ObjectId && it.TypeId == t.TypeId; });
                if (delIndex <= -1) return;

                t.IsSelect = false;
                t.set("DataState", t.Id > 0 ? dataState.Deleted : dataState.Unchanged);

                model.autoSubSrc.push(t);
                model.labeSubSrc.splice(delIndex, 1);

                vmGoalAction.subService.autoChange(t, vmGoalAction.subService.rootType.SubProduct);
                vmGoalAction.subService.groupSub();
            });

            newItems.forEach(t => {
                var newItem = model.autoSubSrc.find(x => x.ObjectId == t.LongLinkId && ((x.TypeId == 1 && t.TypeId == 6) || (x.TypeId == 2 && t.TypeId == 7) || (x.TypeId == 3 && t.TypeId == 8)));
                if (newItem == undefined) return;

                newItem.IsSelect = true;
                var newIndex = model.autoSubSrc.indexOf(newItem);
                newItem.set("DataState", newItem.Id > 0 ? dataState.Modified : dataState.Added);
                model.labeSubSrc.push(newItem);
                model.autoSubSrc.splice(newIndex, 1);

                vmGoalAction.subService.autoChange(newItem, vmGoalAction.subService.rootType.SubProduct);
                vmGoalAction.subService.groupSub();
            });

            model.set("isVisibleSelectedSub", model.displaySrc.length > 0);
            model.setVisibleKpi();
        };

        var syncMarket = function (topic) {
            var indexes = topic ? topic.KpiMasterIndexes : [];
            var labeMarket = model.displayClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);

            var labeSrc = model.labeClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);
            var autoSrc = model.autoClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);

            var newItems = indexes.filter(a => !labeMarket.some(b => b.ObjectId == a.LongLinkId && ((a.TypeId == 3 && b.TypeId == 1) || (a.TypeId == 4 && b.TypeId == 2) || (a.TypeId == 5 && b.TypeId == 3))));
            var delItems = labeMarket.filter(b => !indexes.some(a => a.LongLinkId == b.ObjectId && ((a.TypeId == 3 && b.TypeId == 1) || (a.TypeId == 4 && b.TypeId == 2) || (a.TypeId == 5 && b.TypeId == 3))));

            delItems.forEach(t => {
                var delIndex = vmCommon.findIndexByFunc(model.labeClientSrc, function (it) { return it.ObjectId == t.ObjectId && it.TypeId == t.TypeId; });
                if (delIndex <= -1) return;

                t.IsSelect = false;
                t.set("DataState", t.Id > 0 ? dataState.Deleted : dataState.Unchanged);

                model.autoClientSrc.push(t);
                model.labeClientSrc.splice(delIndex, 1);

                vmGoalAction.subService.autoChange(t, vmGoalAction.subService.rootType.SubClient);
                vmGoalAction.subService.groupClient();
            });

            newItems.forEach(t => {
                var newItem = model.autoClientSrc.find(x => x.ObjectId == t.LongLinkId && ((x.TypeId == 1 && t.TypeId == 3) || (x.TypeId == 2 && t.TypeId == 4) || (x.TypeId == 3 && t.TypeId == 5)));
                if (newItem == undefined) return;

                newItem.IsSelect = true;
                var newIndex = model.autoClientSrc.indexOf(newItem);
                newItem.set("DataState", newItem.Id > 0 ? dataState.Modified : dataState.Added);
                model.labeClientSrc.push(newItem);
                model.autoClientSrc.splice(newIndex, 1);

                vmGoalAction.subService.autoChange(newItem, vmGoalAction.subService.rootType.SubClient);
                vmGoalAction.subService.groupClient();
            });

            model.set("isVisibleSelectedClient", model.displayClientSrc.length > 0);
            model.setVisibleKpi();
        };

        var syncConnection = function (topic) {
            var indexes = topic ? topic.KpiMasterIndexes : [];
            var links = model.action.Links;
            var deletedItems = model.action.KpiMasterData.DeletedItems;

            for (var i = links.length - 1; i >= 0; i--) {
                var l = links[i];
                l.set("IsMasterLink", indexes.some(t => t.GuidLinkId == l.LinkId));

                var deletedIndexes = deletedItems.filter(t => !l.IsMasterLink && t.Item.GuidLinkId == l.LinkId && !t.IsSync);
                if (deletedIndexes.length > 0 || (!l.IsMasterLink && !model.action.Visibility) || !l.IsVisibility) {
                    deletedIndexes.forEach(t => t.IsSync = true);

                    if (l.Id > 0) {
                        l.set("IsShow", false);
                        l.set("DataState", dataState.Deleted);
                    } else {
                        links.splice(i, 1);
                    }
                }

                $("#link-" + l.LinkId + "-" + l.Id).html(vmCommon.bindingContent("temp-kpiinfo", l));
                $("#link-" + l.LinkId + "-" + l.Id).attr("id", "link-" + l.LinkId + "-" + l.Id);
            }

            var newLinks = [];
            indexes.forEach(i => {
                var avaiableLinks = links.filter(t => t.DataState != dataState.Deleted);
                if (avaiableLinks.some(t => t.LinkId == i.GuidLinkId)) return;

                newLinks.pushx(i.GuidLinkId);
            });

            if (newLinks.length > 0) {
                vmGoalAction.dataservice.getMenuLinkInfos({ GoalActionIds: newLinks }, function (res) {
                    var temps = res.value;
                    temps.forEach(l => {
                        var newLink = new ActionPlanLink();
                        newLink.LinkId = l.Id;
                        newLink.LinkName = l.Name;
                        newLink.LinkTypeId = vmCommon.GoalActionContentType.SubGoal;

                        newLink.LinkDescription = l.Description;
                        newLink.MIndex = vmCommon.getMaxMIndex(links) + 1;

                        newLink.IsMasterLink = true;
                        newLink.RoleId = l.RoleId;
                        newLink.Path = l.Path;
                        newLink.Url = l.Url;
                        newLink.IsVisibility = l.IsVisibility;

                        newLink.ApEvaluation = l.ApEvaluation;
                        newLink.KpiInfo = l.KpiInfo;
                        newLink.TodoPercent = l.TodoPercent;

                        links.push(newLink);
                    });
                });
            }

            model.set("hasLink", !model.isDisordered && (model.action.Visibility || model.action.Links.some(t => t.IsShow)));
        };

        var sync = function (actionModel) {
            if (actionModel == undefined || actionModel.action == undefined) return;

            var action = actionModel.action;
            if (action == undefined || action.KpiMasterData == undefined) return;

            model = actionModel;
            var topics = action.KpiMasterData.KpiMasterTopics || [];

            //region
            var regiontopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.LandRegion);
            syncRegion(regiontopic);

            //product
            var producttopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Product);
            syncProduct(producttopic);

            //market
            var markettopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Market);
            syncMarket(markettopic);

            //connection
            var goaltopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Goal);
            syncConnection(goaltopic);


            vmGoalAction.autoSubHeight();
        };

        var syncType = function (actionModel, topicType) {
            if (actionModel == undefined || actionModel.action == undefined) return;

            var action = actionModel.action;
            if (action == undefined || action.KpiMasterData == undefined) return;

            model = actionModel;
            var topics = action.KpiMasterData.KpiMasterTopics || [];

            var topic = topics.find(t => t.TypeId == topicType);
            switch (topicType) {

                case vmCommon.KpiGoalTopicType.LandRegion:
                    syncRegion(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Product:
                    syncProduct(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Market:
                    syncMarket(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Goal:
                    syncConnection(topic);
                    break;
            }
        };

        return { sync: sync, syncType: syncType };
    }();

    $("#area-edit-action").on("mouseenter", ".linkname", function (e) {
        if (vmEditAction.viewModel == undefined || vmEditAction.viewModel.action == undefined) return;

        var target = e.currentTarget;
        var index = $(target).closest("tr").index();

        $("#area-edit-action .linkname").not(target).each(function () {
            var other = $(this).data("kendoTooltip");
            if (other) other.destroy();
        });

        var links = vmEditAction.viewModel.action.Links;
        var link = links[index];
        if (link.LinkDescription) {
            //destroy other
            var tt = $(target).data("kendoTooltip");
            if (tt) return;

            var template = kendo.template($("<div><div class='xx' style='width: 100%;text-align: initial;'><label>#:kLg.vtextDescription#</label><div class='clear'></div><div class='ms-content-tooltip'>#:vmCommon.TexEditor.stripHtml(data.Description)#</div></div></div>").html());
            var tooltip = $(target).kendoTooltip({
                position: "left",
                autoHide: true,
                content: template({ Description: link.LinkDescription }),
                width: 300,
                //height: 150,
                hide: function () {
                    var tt = $(this.element).data("kendoTooltip");
                    if (tt) tt.destroy();
                }
            }).data("kendoTooltip");
            tooltip.show();
        }
    });
</script>