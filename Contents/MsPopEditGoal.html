<link href="css/msGoalAction.css" rel="stylesheet" />
<style type="text/css">
    #fEditGoal > title {
        display: none;
    }
    #popEditMainGoal div[class*="col-"] {  float: left; }

    #fEditGoal .ms-modal-body {
        padding: 10px !important;
        overflow-y: scroll;
    }
    .Iconextention .popover-content { width: initial; }
    .date-goal {
        margin-bottom: 15px;
    }

    .temp-button {
        margin-top: 0 !important;
    }

    .temp-place {
        margin-bottom: 10px;
    }

        .temp-place span {
            border-color: #38baf8 !important;
        }

        .temp-place .k-dropdown {
            background-color: #38baf8;
            border-radius: 3px;
            width: 190px;
        }

        .temp-place .k-dropdown-wrap {
            background-color: #38baf8;
            border-radius: 3px;
        }

        .temp-place .k-state-hover {
            color: white !important;
        }

        .temp-place .k-input {
            background-color: #38baf8;
            color: white !important;
        }

        .temp-place .k-select {
            background-color: #38baf8;
        }

    #fEditGoal .ms-drop {
        margin-left: 181px !important;
        width: 300px !important;
        margin-top: 3px !important;
    }

    #fEditGoal textarea.modal-textarea {
        min-height: 70px;
        max-height: 155px;
    }

    .ms-wrapper label {
        white-space: pre;
    }

    /* multiselect */
    .divtag .k-multiselect-wrap input[class~="k-input"] {
        background-color: transparent !important;
        border-width: 0 !important;
    }

    .divtag .k-multiselect-wrap {
        border-radius: 0px !important;
    }

    .divtag .k-multiselect.k-header {
        border-color: #E7E7E7 !important;
    }

    .k-animation-container .k-state-focused {
        border-width: 0;
        border-color: #E7E7E7;
        box-shadow: none;
    }
    /**/
    .divtag .k-multiselect-wrap li[class~="k-button"] {
        color: #2e2e2e;
        border-color: #fafafa;
        background-color: #fafafa;
        border-radius: 30px;
        max-width: 99%;
    }

        .divtag .k-multiselect-wrap li[class~="k-button"]:hover {
            color: #2e2e2e;
            border-color: #EBEBEB;
            background-color: #EBEBEB;
            border-radius: 30px;
            max-width: 99%;
        }

    .divtag .k-multiselect, #ddlSubProductConnection-list, #ddlResponsibility-list {
        width: 393px !important;
    }

    /* multiselect */

    .auto-stream {
        width: 93%;
    }

    ul.ulsub {
        list-style-type: none;
        padding-left: 6px !important;
        margin-bottom: 0 !important;
    }

        ul.ulsub li {
            margin-right: 3px;
            margin-top: 3px;
            padding: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,.2),0 2px 3px rgba(0,0,0,.05);
            padding-bottom: 5px;
            display: inline-block;
        }

    .ebebeb {
        background-color: #ebebeb;
    }

    .group-sub {
        background-color: #F7F7F7;
    }

    .ulsub .popover {
        z-index: 100005;
    }

        .ulsub .popover .popover-content {
            padding: 9px 14px;
            border-radius: 0 !important;
        }

    ul.ulpop {
        list-style-type: circle;
        min-width: 200px;
        max-width: 400px;
        min-height: 40px;
        display: block;
        padding-left: 20px;
    }

        ul.ulpop li {
            box-shadow: none;
            display: list-item;
            word-wrap: break-word;
        }

    .divtag .popover-title {
        font-size: 15px;
        padding: 3px 14px;
    }

    .master-goal-label {
        padding: 0px;
    }

    .master-goal-cost {
        color: #8B8891;
        font-weight: normal;
    }

    .mg-firstcost {
        padding: 0px;
        font-size: 11px;
        margin-right: 20px;
    }

    .mg-notfirstcost {
        padding: 0 0 0 2px;
        font-size: 11px;
        margin-right: 20px;
    }

    .abs-bottom-left {
        position: absolute;
        bottom: 0;
        left: 0;
    }

    .abs-bottom-right {
        position: absolute;
        bottom: 0;
        right: 0;
    }

    .w-100per {
        width: 98% !important;
    }

    .col-md-6 {
        width: 44%;
    }

    .col-md-6-fix {
        width: 49% !important;
    }

    #area-edit-goal .k-datepicker {
        padding: 0 !important;
    }

        #area-edit-goal .k-datepicker .k-select {
            width: 21px !important;
            padding-top: 1px;
        }

        #area-edit-goal .k-datepicker .k-input {
            height: 22px !important;
        }

    label.ms-select-lable::after {
        content: '';
        font: 8px "Glyphicons Halflings", monospace;
        color: #90817c;
        -webkit-transform: rotate(90deg);
        -moz-transform: rotate(90deg);
        -ms-transform: rotate(90deg);
        right: 10px;
        top: 8px;
        padding: 0 0 2px;
        position: absolute;
        pointer-events: none;
    }

    .k-numerictextbox .k-input {
        width: 164px !important;
        padding-right: 5px !important;
    }

    #tableEditGoal textarea.modal-textarea-autosize {
        max-height: 70px;
    }

    #txtEffect { overflow-x: hidden; }

    .dropdown-main-mastergoal-color { color: black; }
    .k-colorpicker .k-select { display: none; }
    .k-colorpicker { width: 28px; }
    .form-group.divtag > div.k-multiselect.k-widget > div.k-multiselect-wrap > ul.k-reset > li.k-button {
        overflow-x: hidden
    }
    .form-group.divtag > div.k-multiselect.k-widget > div.k-multiselect-wrap > ul.k-reset > li.k-button > span:last-child {
        background-color: #fafafa
    }

    .dnbTextAreaEditor {
        margin-top: -5px;
        margin-right: -3px;
        margin-left: -3px;
    }

    .dnbTextAreaEditor > table.k-editor {
        border: none;
        background-color: transparent;
    }

    .dnbTextAreaEditor > table.k-editor .k-editable-area {
        border-color: #E7E7E7;
    }

    .dnbTextAreaEditor td.k-editor-toolbar-wrap { height: 0 }

    .dnb-parent-pin-editor-form .k-colorpicker .k-select {
        display: block; opacity: 0
    }

    .dnb-flex { display: flex; }

    .icon-zoom {
        background-position: -180px -662px;
        cursor: pointer;
        width: 22px !important;
        height: 20px !important;
    }

    .title-oneline {
        max-width: 218px;
        max-height: 20px;
        overflow: hidden;
        margin-bottom: 0;
    }
    .dnbTextEditorViewRole {position: relative}
    .dnbTextEditorViewRole:after {content: ''; position: absolute; top:0;left:0; display:block;width:100%;height:100%;opacity:0}
    .linkkpi {height: 30px; background-color: #38baf8; margin-left: 8px; position: relative; padding-right: 18px; display: inline-block; border-radius: 3px;}
    .styleiconkpiGoal {height: 28px; background-color: #38baf8; width: 77px; top: 8px; position: relative; left: 9px;}
    .styletextkpiGoal {color: white; margin-left: 12px; position: relative;  top: 5px;}
    .stylelinkassigfile {height: 30px!important; background-color: #38baf8; margin-left: 8px; position: relative; padding-right: 18px; display: inline-block; border-radius: 3px;width: initial !important;}

    .btn-export-kpi-report {
        height: 30px !important;
        background-color: #38baf8;
        margin-left: 12px;
        position: relative;
        padding-right: 18px;
        border-radius: 3px;
        display: inline-flex;
    }
    .k-coloreditor-header.k-hstack {display:none;}
</style>
<div id="loading-editgoal" class="loading">
</div>

<div id="area-edit-goal" class="pop-wrapper">
    <div id="popActionFibu"></div>
    <div id="pop-Reminder"></div>
    <form id="fEditGoal">
        <div class="modal-body ms-modal-body">
            <div class=" temp-place" style=" display: flex; justify-content: space-between;" id="btemplate">
                <div style=" display: flex;">
                    <button type="button" class="ms-button pull-left temp-button" data-bind="events:{ click: saveTemplate}, visible: isSaveTemplate, disabled: roleEdit" id="btnAddTemplate">
                        <span class="icon-20 icon-left-block plus-status"></span>
                        <span id="lblAddTemplate">Add template</span>
                    </button>

                    <input data-option-label="{Name: kLg.btnSelectTemp}"
                           data-role="dropdownlist"
                           data-auto-bind="false"
                           data-value-primitive="false"
                           data-text-field="Name"
                           data-value-field="Id"
                           data-bind="value: templateId, source: goaltemps, disabled: roleEdit, events: {change: selectTemplate}, enabled: isActiveTemp" class="pull-left" id="dropTemp" />

                    <button id="btnDeleteTemplate" type="button" class="ms-left-button temp-button" data-bind="events:{ click: delTemplate}, disabled: roleEdit">
                        <span class="icon-20 icon-bin-sub icon-left-block margin-right6"></span>
                        <span id="lblDeleteTemplate">Vorlage löschen</span>
                    </button>
                </div>
                <div class="Iconextention" style=" float: left; display: flex; width: 136px; justify-content: flex-end;">
                    <a style="padding-right: 6px;" role="button" href="javascript:exportKpiReport();"
                       class="pull-left rpkpi btn-export-kpi-report ShowtooltipiconKPI"
                       data-bind="visible: isShowExportKpiReport">
                        <span style="position: relative; top: 7px;margin-left: 8px;" role="presentation" class="icon-16 icon-kpigoalreport"></span>
                        <!--<span id="lblKPIReporticon" style="color:white; margin-top:5px;">KPI Report</span>-->
                    </a>
                    <a role="button" href="javascript:vmGoalAction.showPopupGoalActionEval(1);" class="pull-left rpkpi linkkpi Showtooltipiconevaluation">
                        <span role="presentation" class="font-focus styleiconkpiGoal"></span>
                        <!--<span id="lblEvaluationicon" class="styletextkpiGoal">Bewertung</span>-->
                    </a>

                    <a style=" padding-right: 6px!important;" role="button" 
                       class=" pull-left stylelinkassigfile showicontooltipAssigned" tabindex="2" data-bind="visible: IsFileAssignedRole, attr: { href: fileAssignHref}">
                        <span style="top: 7px; position: relative;margin-left: 8px ;" id="iconEmpty" role="presentation" class="icon-16 icon-file"></span>
                        <!--<span id="lblFileAssignedicon" style="color: white; ">Zugeordnete Dateien</span>-->
                    </a>

                </div>

            </div>
            <div class="clear"></div>
            <hr class="modal-organ-hr">
            <label class="modal-label" id="lblName">Name</label>

            <div class="clear"></div>
            <div class="dnb-flex">
                <input tabindex="0" id="txtName" name="txtName" data-trigger="focus" data-placement="bottom"
                       class="modal-input col-md-12 txtInput" type="text" data-value-update="keyup"
                       onkeypress="vmEditGoal.activeModelChange()"
                       data-bind="value: goal.Name, disabled: roleEdit" maxlength="200">

                <input id="picker" class="pointer" name="picker" data-bind="value:goal.MColor, disabled: roleEdit"
                       type="color" style="height: 30px; width: 30px;" />
            </div>

            <div class="clear"></div>

            <div style="width: 100%;margin-top: 20px;">
                <div class="pull-left" style="width: 50%" data-bind="visible: isSelectMaster, disabled: roleEdit">
                    <div class="w-100per">
                        <!--MasterGoal-->
                        <label class="modal-label col-md-3 master-goal-label" id="lblMasterGoal">Masterziel &nbsp;</label>
                        <label class="master-goal-cost budgetInfo mg-firstcost" data-bind="text: budgetInfo"></label>
                        <label class="master-goal-cost etCostInfo mg-notfirstcost" data-bind="text: etCostInfo"></label>
                        <label class="master-goal-cost atCostInfo mg-notfirstcost" data-bind="text: atCostInfo"></label>
                    </div>
                    <input data-role="dropdownlist" class="w-100per"
                           data-value-primitive="true"
                           data-text-field="Name"
                           data-value-field="Id"
                           data-template="ddMasterGoalTemplate"
                           data-bind="source: masterGoal, value: goal.MasterId, disabled: roleEdit, events: {change: mastergoalIndexChange, select: selectMasterGoal}" />
                </div>

                <div class="pull-left" style="width: 49%" data-bind="visible: isSelectRegion, disabled: roleEdit">
                    <label class="modal-label master-goal-label pull-left" id="lblRegion"></label>
                    <div class="clear"></div>

                    <div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedRegion" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: labeRegionSrc" data-template="selectedregion" class="ulsub"></ul>
                        </div>
                    </div>
                    <input tabindex="0" id="txtAutoRegion" class="auto-stream"
                           data-role="autocomplete"
                           data-text-field="Name"
                           data-value-field="ObjectId"
                           data-filter="contains"
                           data-bind="value: autoRegionValue, source: autoRegionSrc, events:{ select: selectRegionGroup, change: changeRegionGroup }, enabled: isSyncSelectable" />

                    <div class="ms-dropdow" style="right: 0px;">
                        <span class="icon-24 icon-right-block iconright-modal-mass pointer" data-bind="disabled: roleEdit, events:{click: openSelectRegion}, visible:isHasKpi"></span>
                    </div>
                </div>

                <div class="pull-left" style="width: 50%"></div>
            </div>

            <div class="clear"></div>

            <!-- sub product group -->
            <div id="subpanel" class="row" data-bind="visible: isVisibleSub" style="margin-left: 0; margin-right: 0; position: relative;">
                <div class="col-md-6-fix col-md-6 noPaddingLeft" style="padding-top: 20px; margin-bottom: -15px; overflow: hidden;">
                    <div class="form-group divtag">
                        <label id="lblSubProductGroup">Abc xyz</label>
                        <div class="clear"></div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedSub" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: displaySrc" data-template="selectedsub" class="ulsub"></ul>
                        </div>
                        <div class="clear"></div>
                        <input tabindex="0" id="txtSubPg" class="auto-stream"
                               data-role="autocomplete"
                               data-value-primitive="true"
                               data-text-field="Name"
                               data-value-field="ObjectId"
                               data-filter="contains"
                               data-bind="value: autoSubValue, source: autoSubSrc, events:{ select: selectSubProductGroup, change: changeSubProductGroup}, enabled: isSyncSelectable" />

                        <div class="ms-dropdow">
                            <span class="icon-24 icon-right-block iconright-modal-mass" data-bind="disabled: roleEdit, events:{ click: openSubProduct}, visible:isHasKpi"></span>
                        </div>
                    </div>
                </div>

                <div class="col-md-6-fix col-md-6goal-modal-first-col noPaddingLeft noPaddingRight pull-left" style="margin-top: 20px; margin-bottom: -15px;">
                    <div class="form-group divtag">
                        <label id="lblSubClientGroup" style="max-width:460px;overflow:hidden;">Abc xyz</label>
                        <div class="clear"></div>
                        <div class="pull-left" data-bind="visible: isVisibleSelectedClient" style="margin-bottom: 6px; padding-bottom: 3px; width: 100%;">
                            <div class="clear"></div>
                            <ul data-bind="source: displayClientSrc" data-template="selectedclient" class="ulsub"></ul>
                        </div>
                        <div class="clear"></div>

                        <input tabindex="0" id="txtSubClient" class="auto-stream"
                               data-role="autocomplete"
                               data-value-primitive="true"
                               data-text-field="Name"
                               data-value-field="ObjectId"
                               data-filter="contains"
                               data-bind="value: autoClientValue, source: autoClientSrc, events:{ select: selectSubClientGroup, change: changeSubClientGroup }, enabled: isSyncSelectable" />

                        <div class="ms-dropdow">
                            <span class="icon-24 icon-right-block iconright-modal-mass" data-bind="disabled: roleEdit, events:{ click: openSubClient }, visible:isHasKpi"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clear"></div>

            <div class="clear"></div>
            <!-- connection -->

            <div class="row" style="margin-left: 0; margin-right: 0; margin-top: 20px; margin-bottom: -15px;">
                <hr class="modal-mass-hr">
                <div class="row" style="margin-left: 0; margin-right: 0">
                    <div class="col-md-6-fix col-md-6 goal-modal-first-col mleft-custom-tabindex">
                        <div class="form-group divtag">
                            <label id="lblPerson">Verantwortung</label>
                            <div class="clear"></div>

                            <select data-role="multiselect"
                                    data-placeholder=""
                                    data-filter="contains"
                                    data-text-field="Name"
                                    data-value-field="AccountId"
                                    data-bind="source: listPerson, value: goal.People, disabled: roleEdit,
                                        events: { change: autoCheckReminder, filtering: multiSelectFiltering}"
                                    id="ddlResponsibility"></select>

                        </div>

                        <div>
                            <div class="form-group divtag">
                                <label class="modal-label title-oneline" id="lblCategory">Kategorie</label>

                                <select data-role="multiselect"
                                        data-placeholder=""
                                        data-filter="contains"
                                        data-text-field="Name"
                                        data-value-field="Id"
                                        data-bind="source: listGoalCategory, value: goal.Categories,
                                            events: { filtering: multiSelectFiltering},
                                            disabled: roleEdit">
                                </select>
                            </div>

                            <div class="form-group divtag">
                                <label class="modal-label title-oneline" id="lblField">Field</label>

                                <select data-role="multiselect"
                                        data-placeholder=""
                                        data-filter="contains"
                                        data-text-field="Name"
                                        data-value-field="Id"
                                        data-bind="source: listActionField, value: goal.Fields,
                                            events: { filtering: multiSelectFiltering},
                                            disabled: roleEdit"></select>
                            </div>
                        </div>
                        <div style="margin-top: 33px;">
                            <div class="form-group">
                                <div class="dnb-flex" style="justify-content: space-between;">
                                    <div class="dnb-flex">
                                        <label id="lblEffect">Erwartetes Ergebnis / Situation</label>
                                        <div style="margin-left: 3px;">
                                            <span class="icon-20 icon-kpi-goal-small pointer"
                                                  data-bind="visible:isHasKpi, events:{click: openKpiGoal}"
                                                  style="margin-top: -1px;"></span>
                                        </div>
                                    </div>
                                    <div class="icon-32 icon-zoom" data-id="txtEffect"
                                         onclick="vmCommon.TexEditor.addWindowEditor(this)">
                                    </div>
                                </div>
                                <div class="clear"></div>
                                <div class="dnbTextAreaEditor">
                                    <textarea rows="1" id="txtEffect"
                                              class="modal-textarea w-100per"
                                              data-role="editor" data-tools="[]"
                                              data-bind="value: goal.Effect,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                    </textarea>
                                </div>
                            </div>
                            <div class="col-md-6" style="padding-left: 0px !important">
                                <label id="lblEvaluation" class="title-oneline">Zielbewertung</label>
                                <select data-role="dropdownlist" class="w-100per"
                                        data-filter="contains"
                                        data-text-field="Name"
                                        data-value-field="Id"
                                        data-bind="source: listGoalEvaluation,
                                            events:{select: selectEvaluation, filtering: filteringEvaluation},
                                            value: goal.Evaluation, disabled: roleEdit">
                                </select>
                            </div>
                            <div class="col-md-6 noPaddingRight">
                                <label id="lblBudget">Budget</label>
                                <div class="clear"></div>
                                <div class="input-append">
                                    <input data-role="numerictextbox" focusevent="cost-focus" class="text-right" data-spinners="false" data-max="999999999999"
                                           data-format="##,#.00"
                                           onkeypress="vmEditGoal.activeModelChange()"
                                           data-bind="value: goal.Budget, events:{change: changeCost}, disabled: roleEdit" />
                                </div>
                            </div>
                        </div>
                        <div class="clear"></div>
                        <div style="margin-top: 20px;">
                            <div>
                                <div class="noPaddingLeft" style="width: 40%; float: left; margin-right: 50px;">
                                    <label id="lblStartDate">Beginn</label>
                                    <div class="clear"></div>
                                    <div class="input-append date form_datetime1 date-goal" style="width: 85%;">
                                        <input id="txtStartDate" maxlength="10" data-role="datepicker" name="poiu" data-bind="value: goal.StartDate, disabled: roleEdit, events: {change: startDateChange}" />
                                    </div>
                                </div>

                                <div style="width: 40%; float: left;">
                                    <div class="clear"></div>
                                    <label id="lblDate">Ende</label>
                                    <div class="clear"></div>
                                    <div class="input-append date form_datetime1 date-goal" style="width: 85%;">
                                        <input id="txtDate" maxlength="10" data-role="datepicker" name="poiu" data-bind="value: goal.Date, disabled: roleEdit, events: {change: dateChange}" />
                                    </div>
                                </div>

                                <div class="ms-dropdow" style="margin-top: 23px;" data-bind="click: setGoalActionOutlook">
                                    <div class="icon-24 iconright-modal-mass margin-right6" data-toggle="dropdown" style="width: 23px; height: 23px;"></div>
                                    <ul role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: auto;top: auto; bottom: auto;">
                                        <li class="reminder" data-bind="click: openReminder"><a class="dropdow-menu-li-a" data-toggle="modal" data-target=".bs-example-modal-lg"> <span class="icon-24  icon-left-block icon-reminder"></span><span id="lblReminder" style="margin-left: 10px;">Erinnerung</span></a></li>
                                        <li role="presentation" class="divider icon-divider reminder"></li>
                                        <li><a class="dropdow-menu-li-a a69 assignInfo" href="mailto:?Subject=" target="_top"><span class="icon-24  icon-left-block icon-assigninfo"></span><span id="lblAssignInfo" style="margin-left: 10px;">Zuweisen / Info</span></a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6-fix col-md-6 noPaddingRight mright-custom-tabindex">
                        <div class="form-group">
                            <div class="dnb-flex" style="justify-content: space-between;">
                                <label id="lblDescription">Beschreibung</label>
                                <div class="icon-32 icon-zoom" data-id="txtDescriptionMainSub"
                                     onclick="vmCommon.TexEditor.addWindowEditor(this)"> </div>
                            </div>
                            <div class="clear"></div>
                            <div class="dnbTextAreaEditor">
                                <textarea rows="1" id="txtDescriptionMainSub"
                                          class="modal-textarea w-100per"
                                          data-role="editor" data-tools="[]"
                                          data-bind="value: goal.Description,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                </textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="dnb-flex" style="justify-content: space-between;">
                                <label id="lblPurpose">Zweck / Grundsätze</label>
                                <div class="icon-32 icon-zoom" data-id="txtPurpose"
                                     onclick="vmCommon.TexEditor.addWindowEditor(this)"> </div>
                            </div>
                            <div class="clear"></div>
                            <div class="dnbTextAreaEditor">
                                <textarea rows="1" id="txtPurpose"
                                          class="modal-textarea w-100per"
                                          data-role="editor" data-tools="[]"
                                          data-bind="value: goal.Purpose,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                </textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="dnb-flex" style="justify-content: space-between;">
                                <div class="dnb-flex">
                                    <label id="lblArrived">Eingetroffenes Ergebnis / Situation</label>
                                    <div style="margin-left: 3px;">
                                        <span class="icon-20 icon-kpi-goal-small pointer"
                                              data-bind="visible:isHasKpi, events:{click: openKpiGoal}"
                                              style="margin-top: -1px;"></span>
                                    </div>
                                </div>
                                <div class="icon-32 icon-zoom" data-id="txtArrived"
                                     onclick="vmCommon.TexEditor.addWindowEditor(this)">
                                </div>
                            </div>
                            <div class="clear"></div>
                            <div class="dnbTextAreaEditor">
                                <textarea rows="1" id="txtArrived"
                                          class="modal-textarea w-100per"
                                          data-role="editor" data-tools="[]"
                                          data-bind="value: goal.Arrived,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                </textarea>
                            </div>
                        </div>
                        <div class="clear"></div>
                        
                        <div class="col-md-6 noPaddingLeft">
                            <label id="lblExpectedCost">Expected cost</label>
                            <div class="clear"></div>
                            <input data-role="numerictextbox" class="text-right" data-spinners="false" data-max="999999999999" data-format="##,#.00"
                                   onkeypress="vmEditGoal.activeModelChange()" tabindex="-1"
                                   data-bind="value: goal.ExpectedCost" disabled />
                        </div>
                        <div class="col-md-6">
                            <label id="lblActualCost">Actual cost</label>
                            <div class="clear"></div>
                            <div class="input-append">
                                <input data-role="numerictextbox" class="text-right" data-spinners="false" data-max="999999999999" data-format="##,#.00"
                                       onkeypress="vmEditGoal.activeModelChange()" tabindex="-1"
                                       data-bind="value: goal.ActualCost" disabled />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row m-custom-tabindex" style="margin-left: 0; margin-right: 0">
                    <div class="col-md-6-fix col-md-6 goal-modal-first-col">
                        <div style="width: 40%;float: left;margin-right: 50px;">
                            <div class="checkbox" style="padding-left: 0;">
                                <label>
                                    <span class="checkbox-inline" style="padding-left: 1px;">
                                        <label>
                                            <span id="lblFinish">Finish</span>
                                            <input type="checkbox"
                                                   id="cbFinish"
                                                   data-bind="checked: goal.Finish, disabled: roleEdit, events:{click: confirmAll, change: autoCheckReminder}" />
                                            <span class="checkmarkd"></span>
                                        </label>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div style="width: 40%;float: left;">
                            <div class="checkbox"style="padding-left: 0px; padding-top: 2px;">
                                <label>
                                    <span class="checkbox-inline"style="padding-left: 1px;">
                                        <label>
                                            <span id="lblVisibility">Visibility</span>
                                            <input type="checkbox"
                                                   id="cbVisibility"
                                                   data-bind="checked: goal.Visibility, disabled: roleEdit, events:{click: confirmAll, change: onChangeVisibility }" />
                                            <span class="checkmarkd"></span>
                                        </label>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="checkbox" style="float: right; margin-right: -148px; width: 178px; height: 22px;padding-left: 0;">
                            <label>
                                <span class="checkbox-inline" style="padding-left:3px;">
                                    <label>
                                        <span id="lblIsCalendar">Resource planning</span>
                                        <input type="checkbox"
                                               id="cbIsCalendar"
                                               data-bind="checked: goal.IsCalendar, disabled: roleEdit, events: {click: confirmIsCalendar}" />
                                        <span class="checkmarkd"></span>
                                    </label>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ap connection -->
                <div class="row" style="margin-left: 0; margin-right: 0;margin-bottom: 12px;" data-bind="visible: hasLink">
                    <label id="lblApConnection">Action plan connections</label><br />
                    <span class="icon-32 cursor-pointer icon-add" data-bind="events: {click : addLink }, visible: goal.Visibility"></span>
                    <table class="tbgrid modal-table modal-mass-tb-status" style="margin-top: 6px;">
                        <tbody data-template="temp-link" data-bind="source: goal.Links"></tbody>
                    </table>
                    <div></div>

                    <script id="temp-kpiinfo" type="text/x-kendo-template">
                        <span class="icon-20 #:vmCommon.getGaIcon(LinkTypeId, IsMasterLink)# pull-left"></span>
                        <div style="min-height: 22px;width: 65px;float:right;">
                            # var kovArrow = KpiInfo.Trend == 1 ? 'kpi-overview-up' : (KpiInfo.Trend == 2 ? 'kpi-overview-equal' : (KpiInfo.Trend == 3 ? 'kpi-overview-down' : ''));#
                            #if (ApEvaluation != null){#
                            <div class="pull-left kpi-overview kpi-overview-goal #:kovArrow# #:ChoseColorPercent(ApEvaluation)#">
                                <span style="margin-top: 1px;max-width: 70px;width: 100%;text-align: center;" title="#:ApEvaluation#">#:ApEvaluation#</span>
                            </div>
                            #}else if (KpiInfo.IsShow){#
                            #var kovBg = KpiInfo.Percent < 70.51 ? 'kpi-overview-bgdown' : (KpiInfo.Percent < 99.5 ? 'kpi-overview-bgequal' : 'kpi-overview-bgup');#
                            #var classMsaKpiBg = 'msa-kpi-bg';#
                            #if(KpiInfo.Percent <= 60) { classMsaKpiBg += '60'; } else if(KpiInfo.Percent <= 80) { classMsaKpiBg += '60-80'; } else { classMsaKpiBg += '80'; }#

                            <div class="pull-left kpi-overview #:kovArrow# #:kovBg# #:classMsaKpiBg#">
                                <span class="xnxx"></span>
                                <span style="margin-top: 2px;padding: 0 4px 0 4px;" title="#:KpiInfo.PercentStr#%">#:KpiInfo.PercentStr#%</span>
                            </div>
                            #}else if (TodoPercent != null){#
                            #var classMsaKpiBg = 'msa-kpi-bg';#
                            #if(TodoPercent <= 60) { classMsaKpiBg += '60'; } else if(TodoPercent <= 80) { classMsaKpiBg += '60-80'; } else { classMsaKpiBg += '80'; }#
                            <div class="pull-left kpi-overview #:classMsaKpiBg#">
                                <span class="xnxx"></span>
                                <span style="margin-top: 2px;padding: 0 4px 0 4px;" title="#:TodoPercent#%">#:Math.round(TodoPercent, 2)#%</span>
                            </div>
                            #}#
                        </div>
                    </script>

                    <script id="temp-link" type="text/x-kendo-template">
                        <tr data-bind="visible: IsShow">
                            <td width="52%">
                                <div class="file-sub" style="max-width: 460px;overflow: hidden;">
                                    <span class="goalactionpath" data-bind="{ text: Path }"></span>
                                </div>
                            </td>
                            <td width="35%">
                                <div class="file-sub" style="max-width: 285px;overflow: hidden;">
                                    <span class="linkname" data-bind="{ text: LinkName, events : { dblclick: openGoalAction } }"></span>
                                </div>
                            </td>
                            <td width="10%" style="padding: 3px; border-right: none;">
                                <div style="width: 100%;">
                                    <div class="kpiinfo" id="link-#:LinkId#-#:Id#" style="display: flex;margin-top: 2px;float: left;">
                                        #=vmCommon.bindingContent("temp-kpiinfo", data)#
                                    </div>
                                </div>
                            </td>
                            <td width="3%" style="padding: 5px; border-left: none;">
                                <div class="ms-dropdow" style="float:right;" data-bind="invisible: IsMasterLink">
                                    <div class="icon-24 iconright-modal-mass margin-right6 pointer" data-toggle="dropdown" style="width: 23px; height: 23px;"></div>
                                    #if(vmGoalAction.goalOptions.role > 0){#
                                    #var pad = kLg.language == 'de' ? -226: -169;#
                                    <ul aria-labelledby="btnGroupVerticalDrop1" class="popup-menu dropdown-menu ms-popup-menu posAbsolute" role="menu" style="left:#:pad#px;">
                                        #if (RoleId > 0){#
                                        <li data-bind="events: {click : editLink }">
                                            <a class="dropdow-menu-li-a">
                                                <span class="icon-24 icon-left-block icon-edit"></span><span>#:kLg.lblEditApConnection#</span>
                                            </a>
                                        </li>
                                        <li role="presentation" class="divider"></li>
                                        #}#
                                        <li data-bind="events: {click : addLinkBeLow }">
                                            <a class="dropdow-menu-li-a">
                                                <span class="icon-24 icon-left-block icon-add-region"></span><span>#:kLg.lblAddApConnection#</span>
                                            </a>
                                        </li>
                                        #if (RoleId > 0){#
                                        <li role="presentation" class="divider"></li>
                                        <li data-bind="events: {click : deleteLink }">
                                            <a class="dropdow-menu-li-a">
                                                <span class="icon-24 icon-left-block icon-delete"></span><span>#:kLg.lblDeleteApConnection#</span>
                                            </a>
                                        </li>
                                        #}#
                                    </ul>
                                    #}#
                                </div>
                            </td>
                        </tr>
                    </script>
                </div>

                <label id="lblStatusProtocol" class="popup-lable">Statusprotokoll</label>
                <div id="tableEditGoal" class="m2-custom-tabindex">
                    <table id="gridStatusProtocol" class="tbgrid modal-table modal-mass-tb-status">
                        <thead>
                            <tr>
                                <th class="title bg-grey" width="160px" id="lblDateStatus">Datum</th>
                                <th class="title bg-grey" width="160px" id="lblStatus">Status</th>
                                <th class="title bg-grey" width="450px" id="lblComment">Bemerkung</th>
                                <th class="title bg-grey" width="48px"></th>
                            </tr>
                        </thead>
                        <tbody data-template="temp-status" data-bind="source: goal.Status, disabled: roleEdit"></tbody>
                    </table>
                    <script type="text/html" id="tempShowDescription">
                        <div style="min-width: 50px; max-width: 300px">
                            <div class="row-wrapper">
                                <div class="content-break-word" style="text-align: center; color:black;font-size: 14px">#:data#</div>
                                <div class="clear"></div>
                            </div>
                        </div>
                    </script>
                    <script id="temp-status" type="text/x-kendo-template">
                        <tr data-bind="visible: IsOrigin">
                            <td>
                                <div class="input-append date form_datetime1">
                                    <input data-role="datepicker" data-bind="value: Date, disabled: roleEdit"
                                           maxlength="10" onblur="vmEditGoal.checkDate(this)" />
                                </div>
                            </td>
                            <td>
                                <label class="ms-select-lable">
                                    <select data-role="dropdownlist" data-filter = "contains"
                                            data-text-field="Name"
                                            data-value-field="Id"
                                            data-bind="source: listProtocolStatus,
                                                events:{filtering: dropdownListFiltering},
                                                value: StatusId, disabled: roleEdit">
                                    </select>
                                </label>
                            </td>
                            <td style="padding-top:5px;padding-bottom:2px;padding-left:6px; padding-right:6px">
                                # var randomId = "dnbStatusEditor_" + Id; #
                                <div>
                                    <div class="dnb-flex" style="justify-content: flex-end;">
                                        <div class="icon-32 icon-zoom" data-id="#:randomId#"
                                             onclick="vmCommon.TexEditor.addWindowEditor(this)">
                                        </div>
                                    </div>
                                    <div class="dnbTextAreaEditor">
                                        <textarea rows="1" id="#:randomId#"
                                                  class="modal-textarea w-100per dnbStatusKendoEditor"
                                                  data-role="editor" data-tools="[]"
                                                  data-bind="value: Description,
                                                    disabled: roleEdit,
                                                    events: {
                                                        select: togglePlaceholderKendoEditor,
                                                        keyup: onKeyUpChangeValKendoEditor,
                                                        keydown: onKeyDownChangeValKendoEditor,
                                                        paste: onPasteValKendoEditor
                                                    }">
                                        </textarea>
                                    </div>
                                </div>
                            </td>
                            <td class="td-bin td-v-align-middle"><span class="icon-32  icon-bin" data-bind="events: {click: delStatus}"></span></td>
                        </tr>
                    </script>
                </div>
                <div class="modal-mass-iconplus">
                    <button type="button" class="ms-button" data-bind="events:{ click: addStatus}">
                        <span class="icon-16 icon-right-block icon-plus plus-status"></span>
                        <span id="lblAddStatus">Status hinzufugen</span>
                    </button>
                </div>

            </div>

        </div>

        <div class="modal-market-footer">
            <button id="btnUpdate" type="button" class="ms-button" data-bind="events: {click: update}">
                <span class="icon-20 icon-close"></span>
                <span id="lblClose">Close</span>
            </button>
            <span class="pull-right foot-last-change" data-bind="text: LastChange">Last change:</span>
        </div>
    </form>
</div>
<script src="Scripts/jquery.multiple.selectwithicon.js"></script>

<script id="selectedregion" type="text/html">
    <li data-bind="attr:{oid: ObjectId, otype: TypeId}" rtype="3">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;">
            <span class="pull-left" data-bind="text: Name" style="margin-right: 8px;max-width:228px;overflow:hidden"></span>
            <input type="checkbox" class="pull-left" data-bind="checked: IsCheck, disabled: roleEdit, events:{change: onChangeRegionCheck}" style="margin-top: 3px;" />
        </div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer; zoom: 85%; margin-top: 3px;color:transparent;" data-bind="events:{click: removeRegion, invisible: roleEdit}">x</span>
    </li>
</script>

<script id="selectedsub" type="text/html">
    <li data-bind="attr:{oid: ObjectId, otype: TypeId}" rtype="1">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;"><span style="">#:Name#</span></div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer; zoom: 85%; margin-top: 2px;color:transparent;" data-bind="events:{click: removeSubProduct}">x</span>
    </li>
</script>

<script id="selectedclient" type="text/html">
    <li data-bind="attr:{oid: ObjectId, otype: TypeId}" rtype="2">
        <div style="height: 20px; float: left; margin-right: 3px; padding-top: 3px; white-space: nowrap; max-width: 250px; overflow: hidden;">
            #if(OrganisationId){#
            <a style="text-decoration: underline;cursor: pointer;" data-bind="events:{click: redirectOrg}">#:Name#</a>
            #}else{#
            <span style="">#:Name#</span>
            #}#
        </div>
        <span class="pull-right icon-20 ms-icon-delete-gray" style="cursor: pointer;zoom: 85%;margin-top: 3px;color:transparent;" data-bind="events:{click: removeSubClient}">x</span>
    </li>
</script>

<script id="subchild" type="text/html">
    <ul class="ulpop">
        #for(var i = 0; i < data.length; i++){#
        <li>
            <span>#:data[i].Name#</span>
        </li>
        #}#
    </ul>
</script>

<script id="goaltemplate" type="text/html">
    <div class="modal-body ms-modal-body" style="overflow: auto; height: 285px">
        <form>
            <table id='tblTemp' class="tbgrid modal-table">
                <thead>
                    <tr>
                        <th class="title bg-grey" style="width: 55px;"></th>
                        <th class="title bg-grey" id="lblTemplateName">#:kLg.lblTemplateName#</th>
                    </tr>
                </thead>
                <tbody>
                    # for(var i = 0; i < data.length; i ++) { #
                    <tr>
                        <td>
                            <input type="checkbox" id="#=data[i].Id#" />
                        </td>
                        <td>#:data[i].Name#</td>
                    </tr>
                    # } #
                </tbody>
            </table>
        </form>
    </div>
    <div class="modal-market-footer" id="divImportFooter">
        <button type="button" class="ms-button" onclick="vmEditGoal.deleteTemplate()"><span class="icon-20 icon-update margin-right6"></span><span class="btnChoose">#:kLg.lblDelete#</span></button>
    </div>
</script>

<script id="ddMasterGoalTemplate" type="text/x-kendo-template">
    # if (data.IsMain) {#
    <strong class="dropdown-main-mastergoal-color">#: data.Name#</strong>
    #} else {#
    <span class="#: data.IsFinish ? 'k-state-disabled dropdown-mastergoal-color': ''#" style="padding-left:1em;">#: data.Name#</span>
    #}#
</script>

<script>
    vmGoalAction.GoalMaster = {};
    var isSelectMaster = false, isSelectRegion = false;

    var vmEditGoal = vmEditGoal || {};
    vmEditGoal.isValidSub = true;
    vmEditGoal.isValidClient = true;

    vmEditGoal.theGoal = {};
    vmEditGoal.optionTemp = {};
    vmEditGoal.TempCache = [];
    var menuLinkCache = null;

    //vmEditGoal.IsFromTemplate = false;

    var msCurrency = vmGoalAction.currency ? vmGoalAction.currency.Name : (vmGoalAction.goalOptions ? vmGoalAction.goalOptions.Currency : null);

    vmEditGoal.dataservice = (function () {
        var callAjaxGoalAction = function (divId, funcName, entryData, requestType, successCallBack) {
            var url = "../Handlers/MsGoalAction.ashx?funcName=" + funcName + "&projid=" + projectId + "&regid=" + vmGoalAction.goalOptions.RegionId + "&strid=" + strategyId + "&lang=" + kLg.language;
            callAjax(divId, url, entryData, successCallBack, requestType);
        };

        var callAjaxByPost = function (funcName, entryData, successFunc) {
            callAjaxGoalAction('loading-editgoal', funcName, JSON.stringify(entryData), AjaxConst.PostRequest, successFunc);
        };

        var createGoal = function (entryDate, successFunc) {
            callAjaxByPost("createGoal", entryDate, successFunc);
        };

        var updateGoalFromFormatPopup = function (entryDate, successFunc) {
            callAjaxByPost("updategoalfromformatpopup", entryDate, successFunc);
        };
        var updateStatusFromFormatPopup = function (entryDate, successFunc) {
            callAjaxByPost("updatestatusfromformatpopup", entryDate, successFunc);
        };
        var addStatusFromFormatPopup = function (entryDate, successFunc) {
            callAjaxByPost("addstatusfromformatpopup", entryDate, successFunc);
        };

        var updateGoal = function (entryDate, successFunc) {
            callAjaxByPost("updateGoal", entryDate, successFunc);
        };

        var saveTemplate = function (entryDate, successFunc) {
            callAjaxByPost("savetemplate", entryDate, successFunc);
        };

        var delTemplate = function (entryDate, successFunc) {
            callAjaxByPost("deltemplate", entryDate, successFunc);
        };

        var delTemplateByList = function (entryDate, successFunc) {
            callAjaxByPost("deltemplatebylist", entryDate, successFunc);
        };

        var getGoalTemplate = function (entryDate, successFunc) {
            callAjaxByPost("getgoaltemplate", entryDate, successFunc);
        };

        var getGoalOutlook = function (entryDate, successFunc) {
            callAjaxByPost("getgoaloutlook", entryDate, successFunc);
        };

        var getKpiGoalSetting = function (entryDate, successFunc) {
            callAjaxByPost("getkpigoalsetting", entryDate, successFunc);
        };

        var exportKpiReportRequest = function (entryGoal, successFunc) {
            callAjaxByPost("exportkpireport", entryGoal, successFunc);
        };

        return {
            createGoal: createGoal,
            updateGoalFromFormatPopup: updateGoalFromFormatPopup,
            updateStatusFromFormatPopup: updateStatusFromFormatPopup,
            addStatusFromFormatPopup: addStatusFromFormatPopup,
            updateGoal: updateGoal,
            saveTemplate: saveTemplate,
            delTemplate: delTemplate,
            delTemplateByList: delTemplateByList,
            getGoalTemplate: getGoalTemplate,
            getGoalOutlook: getGoalOutlook,
            getKpiGoalSetting: getKpiGoalSetting,
            exportKpiReport: exportKpiReportRequest
        };
    })();

    vmEditGoal.setupLanguage = function () {
        var labelName = vmGoalAction.popEditMainGoal.options.title;
        if (labelName.contains(kLg.titlepAddMainGoalNew1.trim())) {
            labelName = labelName.replace(kLg.titlepAddMainGoalNew1.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepAddMainGoalNew2.trim())) {
            labelName = labelName.replace(kLg.titlepAddMainGoalNew2.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepEditMainGoalNew1.trim())) {
            labelName = labelName.replace(kLg.titlepEditMainGoalNew1.trim(), "").trim();
        }
        if (labelName.contains(kLg.titlepEditMainGoalNew2.trim())) {
            labelName = labelName.replace(kLg.titlepEditMainGoalNew2.trim(), "").trim();
        }
        labelName += language === 'pm' ? 'name' : '';

        if (vmGoalAction.goalOptions.FromBoard) labelName = vmGoalAction.goalOptions.GoalType === vmCommon.GoalType.MainGoal ? kLg.labelMainGoalName : kLg.labelSubGoalName;
        $('#area-edit-goal #lblName').text(labelName);
        $("#area-edit-goal #lblRegion").text(kLg.lblRegions); 

        $('#area-edit-goal #lblPerson').text(kLg.labelRes);
        $('#area-edit-goal #lblCategory').text(kLg.lblNameCatGoal);
        $('#area-edit-goal #lblStartDate').text(kLg.labelStart);
        $('#area-edit-goal #lblDate').text(kLg.labelEnd);
        $('#area-edit-goal #lblEvaluation').text(kLg.labelEvaluation);
        $('#area-edit-goal #lblField').text(kLg.gaLblField);
        $('#area-edit-goal #lblEffect').text(kLg.labelEstimate);
        $('#area-edit-goal #lblStatusProtocol').text(kLg.gaLblStatusProtocol);
        $('#area-edit-goal #lblDateStatus').text(kLg.labelDate);
        $('#area-edit-goal #lblStatus').text(kLg.gaLblStatus);
        $('#area-edit-goal #lblComment').text(kLg.labelComment);
        $('#area-edit-goal #lblAddStatus').text(kLg.gaLblAddStatus);
        $('#area-edit-goal #lblVisibility').text(kLg.labelVisibility);
        $('#area-edit-goal #lblFinish').text(kLg.labelFinish);
        $('#area-edit-goal #lblClose').text(kLg.lblClose);
        $('#area-edit-goal #lblBudget').text(kLg.lblBudget);

        $("#area-edit-goal #lblAddTemplate").text(kLg.btnSaveAsTemplate);
        $("#area-edit-goal #lblDeleteTemplate").text(kLg.DeleteTemplate);
        $("#area-edit-goal #lblEvaluationicon").text(kLg.Evaluationiconiconactionplan);
        $("#area-edit-goal #lblFileAssignedicon").text(kLg.titleFileAssigned);
        $("#area-edit-goal #lblKPIReporticon").text(kLg.KPIReport);

        $("#area-edit-goal #lblConnection").text(kLg.textConnection);

        $("#area-edit-goal #lblExpectedCost").text(kLg.gaLblExpectedCost);
        $("#area-edit-goal #lblActualCost").text(kLg.gaLblActualCost);

        $("#area-edit-goal #lblMasterGoal").text(kLg.textMasterbudget);
        $("#area-edit-goal #lblSubProductGroup").text(kLg.filterLblProduct);
        
        $("#area-edit-goal #lblSubClientGroup").text(kLg.lblSubmarket);
        $('#area-edit-goal #lblEffect').text(kLg.labelEstimate);

        $('#area-edit-goal #lblArrived').text(kLg.labelArrived);

        var labelDes = kLg.PMlabelDes || kLg.labelDes,
            labelPurpose = kLg.PMlabelPurpose || kLg.labelPurpose;

        if (language === 'pm'
            && vmGoalAction.goalOptions.GoalType !== vmCommon.GoalType.MainGoal
            && vmGoalAction.goalOptions.GoalType !== vmCommon.GoalType.Action) {
            labelDes = labelDes.replace(new RegExp('Projektes', "g"), 'Teilprojektes');
            labelPurpose = labelPurpose.replace(new RegExp('Projektes', "g"), 'Teilprojektes');
        };

        $('#area-edit-goal #lblDescription').text(labelDes);
        $('#area-edit-goal #lblPurpose').text(labelPurpose);
        $("#area-edit-goal #lblReminder").text(kLg.reminder);
        $("#area-edit-goal #lblAssignInfo").text(kLg.assignInfo);
        $("#area-edit-goal #lblIsCalendar").text(kLg.gaLblEP);
        $('#area-edit-goal #lblApConnection').text(kLg.lblApConnection);
    };

    vmEditGoal.bindPopUpEvent = function () {
        vmGoalAction.popEditMainGoal.bind("close", function (e) {
            vmFile.enableAssignedIcon = false;
            var gid = vmEditGoal.viewModel.goal.Id;
            if (typeof MsaApp == 'object' && MsaApp) {
                MsaApp.setLastActiveElement(gid);
                // chua lam gi da dong luon form
                const _s = MsaApp.IsShowNavigationMenu ? `[direction-id=nav_${gid}]` : `[direction-id=${gid}]`;
                if (MsaApp.isElementHtmlOutofViewY(_s)) {
                    MsaApp.scrollY(_s, function scrollDone () {
                        MsaApp.pushLoadTimeActions('MsaApp_Done_scrollXY2Element');
                    });
                }
            }
            else {      // cac trang khac ActionPlan

                $("div[class~='divrela']").removeClass("last-active-element");
                $("div[id~='" + gid + "']").addClass("last-active-element");
            }

            if (vmEditGoal.modelChanged) {
                if (confirm(kLg.saveConfirmQuestion)) {
                    vmEditGoal.viewModel.update();

                    if (isValidDate() && $('#fEditGoal').valid() && isValidStatus() && vmEditGoal.valid && isValidSub()) {

                        if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                            vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                        } else if (typeof vmGoalAction === 'object') {
                            vmCommon.AddressBar.ClientQuery.resetAddressBar();
                        }

                        vmGoalAction.popEditMainGoal.destroy();
                        vmGoalAction.popEditMainGoal = null;
                        $('.navbar-collapse.collapse.block-nav').after('<div id="popEditMainGoal"></div>');

                    } else {
                        e.preventDefault();
                    }
                } else {
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                        vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                    } else if (typeof vmGoalAction === 'object') {
                        vmCommon.AddressBar.ClientQuery.resetAddressBar();
                    };
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                        teamBoardVM.reloadBoardLineAfterUpdateElement({
                            Name: vmEditGoal.viewModel.get("goal.Name"),
                            Id: vmEditGoal.viewModel.get("goal.Id"),
                            NewColor: ""
                        });
                    };

                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan) && vmCommon.TexEditor.wasDataChanged()) {
                        MsaApp.updateDataProductOrTheme_Expand_InView_Observer();   // vmEditGoal.modelChanged == true || 'string not empty' || != 0
                        
                    }

                    vmGoalAction.popEditMainGoal.destroy();
                    vmGoalAction.popEditMainGoal = null;
                    $('.navbar-collapse.collapse.block-nav').after('<div id="popEditMainGoal"></div>');
                }

            } else {
                e.preventDefault();

                if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                    vmDashboard.AddressBar.ClientQuery.resetAddressBar();
                } else if (typeof vmGoalAction === 'object') {
                    vmCommon.AddressBar.ClientQuery.resetAddressBar();
                }

                if (vmGoalAction.popEditMainGoal) vmGoalAction.popEditMainGoal.destroy();
                vmGoalAction.popEditMainGoal = null;
                $('.navbar-collapse.collapse.block-nav').after('<div id="popEditMainGoal"></div>');
                vmCommon.popup.close();
            }
            
        });
        //khanhgv
        void function setupTooltip() {
            vmCommon.ShowToolTipDesIcon('.ShowtooltipiconKPI', kLg.KPIReport, '#tempShowDescription', "left");
            vmCommon.ShowToolTipDesIcon('.Showtooltipiconevaluation', kLg.Evaluationiconiconactionplan, '#tempShowDescription', "left");
            vmCommon.ShowToolTipDesIcon('.showicontooltipAssigned', kLg.titleFileAssigned, '#tempShowDescription', "left");
        }();
    };

    //syncType
    vmEditGoal.syncKpiService = function () {
        var model, kpiSetting;

        var reCalculatePercent = function (indexes) {
            var count = indexes.length;
            var p = Math.floor((100 / count) * 100) / 100;
            for (var i = 0; i < count; i++) {
                var index = indexes[i];
                index.KpiPercent = p;

                //for last index
                if (i > 0 && i == count - 1) index.KpiPercent = 100 - (count - 1) * p;
                if (index.DataState == dataState.Unchanged) index.DataState = dataState.Modified;
            }
        };

        var getTopic = function (topics, topicType) {
            var topic;

            if (topics.some(t => t.TypeId == topicType) == false) {
                var newId = vmCommon.min(topics.filter(t => t.Id < 0).map(t => t.Id), 0); 
                topic = { Id: --newId, Name: topicType == vmCommon.KpiGoalTopicType.LandRegion ? kLg.vtextRegion : topicType == vmCommon.KpiGoalTopicType.Market ? kLg.titleStackholderGroups : topicType == vmCommon.KpiGoalTopicType.Product ? kLg.filterLblProduct : "[Topic Name]", GoalId: null, TypeId: topicType, Description: "", MIndex: 0, DataState: dataState.Added, KpiGoalIndexes: [] };
                topics.push(topic);
            }

            return topics.find(t => t.TypeId == topicType);
        };

        var syncIndexTime = function (index, kpiData) {
            if (!kpiData) return;
            var times = Array.isArray(kpiData.KpiGoalTimes) ? kpiData.KpiGoalTimes : [];
            var _indexTimeId = 0;

            for (var i = 0; i < times.length; i++) {
                var time = times[i];

                index.KpiGoalIndexTimes.push({ Id: --_indexTimeId, KpiGoalIndexId: index.Id, KpiGoalTimeId: time.Id, KpiValue: null, DataState: dataState.Added });
            }
        };

        var getNewIndexId = function (topics) {
            var lst = [];
            topics.forEach(t => {
                lst.push(vmCommon.min(t.KpiGoalIndexes.filter(t => t.Id < 0).map(t => t.Id), 0));
            });

            return vmCommon.min(lst, 0);
        };

        var syncRegion = function () {
            var kpiData = model.goal.KpiGoalData;
            if (!kpiData) return;       // check undefined, null

            var labeRegion = model.labeRegionSrc;
            //add new topic
            var topics = kpiData.KpiGoalTopics || [];
            if (labeRegion.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.LandRegion) == false) return;
            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.LandRegion);

            //config data for index
            var indexes = topic.KpiGoalIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (index.TypeId == vmCommon.MsKpiGoalIndexType.LAND || labeRegion.some(t => t.ObjectId == index.LongLinkId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEX, Item: index });
            }

            for (var i = 0; i < labeRegion.length; i++) {
                var label = labeRegion[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == vmCommon.MsKpiGoalIndexType.REGION)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: 2, KpiGoalTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiGoalIndexTimes: [], IsCalculate: true };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);
        };
        var syncMarket = function () {
            var kpiData = model.goal.KpiGoalData;
            if (!kpiData) return;       // check undefined, null

            var labeMarket = model.displayClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4).map(t => { return { ObjectId: t.ObjectId, TypeId: t.TypeId == 1 ? 3 : t.TypeId == 2 ? 4 : t.TypeId == 3 ? 5 : 0, Name: t.Name }; });
            //add new topic
            var topics = kpiData.KpiGoalTopics || [];
            if (labeMarket.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.Market) == false) return;
            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.Market);

            //config data for index
            var indexes = topic.KpiGoalIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (labeMarket.some(t => t.ObjectId == index.LongLinkId && t.TypeId == index.TypeId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEX, Item: index });
            }

            for (var i = 0; i < labeMarket.length; i++) {
                var label = labeMarket[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == label.TypeId)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: label.TypeId, KpiGoalTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiGoalIndexTimes: [], IsCalculate: true };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);

        };
        var syncProduct = function () {
            var kpiData = model.goal.KpiGoalData;
            if (!kpiData) return;   // check undefined, null

            var labeProduct = model.displaySrc.map(t => { return { ObjectId: t.ObjectId, TypeId: t.TypeId == 1 ? 6 : t.TypeId == 2 ? 7 : t.TypeId == 3 ? 8 : 0, Name: t.Name }; });
            //add new topic
            var topics = kpiData.KpiGoalTopics || [];
            if (labeProduct.length == 0 && topics.some(t => t.TypeId == vmCommon.KpiGoalTopicType.Product) == false) return;
            var topic = getTopic(topics, vmCommon.KpiGoalTopicType.Product);

            //config data for index
            var indexes = topic.KpiGoalIndexes;
            var newIndexId = getNewIndexId(topics);
            var mIndex = vmCommon.max(indexes.map(t => t.MIndex), 0);

            for (var i = indexes.length - 1; i >= 0; i--) {
                var index = indexes[i];
                if (labeProduct.some(t => t.ObjectId == index.LongLinkId && t.TypeId == index.TypeId)) continue;

                indexes.splice(i, 1);
                if (index.Id > 0) kpiData.DeletedItems.push({ Id: index.Id, Type: vmCommon.KpiGoalType.INDEX, Item: index });
            }

            for (var i = 0; i < labeProduct.length; i++) {
                var label = labeProduct[i];
                if (indexes.some(t => t.LongLinkId == label.ObjectId && t.TypeId == label.TypeId)) continue;

                var newIndex = { Id: --newIndexId, Name: label.Name, LongLinkId: label.ObjectId, GuidLinkId: null, LinkIds: "", KpiUnitId: 0, KpiPercent: 0, ImplementPercent: null, ExpectedValue: null, LstValue: null, TypeId: label.TypeId, KpiGoalTopicId: topic.Id, MIndex: ++mIndex, DataState: dataState.Added, KpiGoalIndexTimes: [], IsCalculate: true };
                var unit = kpiSetting.KpiUnits.first() || vmCommon.defaultUnit();
                newIndex.KpiUnitId = unit.Id;

                //TODO: add kpi index time
                syncIndexTime(newIndex, kpiData);

                indexes.push(newIndex);
            }

            //recalculate percent
            reCalculatePercent(indexes);
        };

        var sync = function (goalModel, topicType) {
            if (goalModel == undefined) return;

            model = goalModel;
            switch (topicType) {
                case vmCommon.KpiGoalTopicType.LandRegion:
                    syncRegion();
                    break;
                case vmCommon.KpiGoalTopicType.Market:
                    syncMarket();
                    break;
                case vmCommon.KpiGoalTopicType.Product:
                    syncProduct();
                    break;
            }
        };

        var init = function (goalModel, topicType) {
            if (kpiSetting == undefined) {
                vmGoalAction.dataservice.getKpiData(null, function (res) {
                    kpiSetting = res.value;
                    sync(goalModel, topicType);
                });
            } else {
                sync(goalModel, topicType);
            }
        };

        return { init: init };
    }();

    vmEditGoal.getSourceForSub = function (lst, status) {
        return $.grep(lst, function (it) { return it.IsSelect === status });
    };

    vmGoalAction.setupValidate = function () {
        $('#fEditGoal').validate({
            rules: {
                txtName: {
                    maxlength: 200,
                    required: true
                }
            },
            messages: {
                txtName: {
                    required: kLg.msgRequired,
                    maxlength: kLg.msgMaxlenghNameGoal
                }
            }
        });
    };

    //#region Utils
    vmEditGoal.AdjustPopupHeight = function () {
        if (vmGoalAction.popEditMainGoal) {
            var modalfooterHeight = $('#popEditMainGoal .modal-market-footer').height() + 2;  // boder 1px
            var popupHeight = vmCommon.getPopupHeight($('#popEditMainGoal .modal-body').height() + 20, modalfooterHeight);
            popupHeight += 6;
            var popupWidth = $('#popEditMainGoal .modal-body').width() + 20;
            $('#popEditMainGoal .modal-body').height(popupHeight - modalfooterHeight - 21);
            resizePopUp(vmGoalAction.popEditMainGoal, { /*width: popupWidth,*/ height: popupHeight });
        }
    };

    //#endregion
    vmEditGoal.setLimitedDate = function (options) {
        if (options) {
            vmEditGoal.theGoal.OutMinDate = vmCommon.tryJsonToLocalDate(options.OutMinDate);
            vmEditGoal.theGoal.OutMaxDate = vmCommon.tryJsonToLocalDate(options.OutMaxDate);
        }
    };

    vmEditGoal.showHideGoalReminder = function (type) {
        var elements = $('.reminder');
        if (vmEditGoal.viewModel.goal.People.length === 0 || vmEditGoal.viewModel.goal.Finish) {
            type = 'none';
        }

        if (elements.length > 0) {
            for (var i = 0; i < elements.length; i++) {
                $(elements[i]).attr('style', 'display: ' + type);
            }
        }

    }

    vmEditGoal.checkReminderReady = function (goal) {

        if (goal.People === null || goal.People === undefined || goal.People.length === 0) {
            return false;
        }
        if (goal.Finish) {
            return false;
        }
        if (goal.Date === null || goal.Date === undefined) {
            return false;
        }
        var d = new Date();
        if (!compareDate(d, goal.Date) || equalDate(d, goal.Date)) {
            return false;
        }
        return true;
    };

    vmEditGoal.initTabIndex = function ({ ParentSelector, IndexStart, ColWidth, ColCount, KeepIndex }, fnc) {
        var selector = '.k-numeric-wrap.k-state-default, .k-picker-wrap.k-state-default, .k-widget.k-dropdown, .k-multiselect-wrap, textarea:visible, button:visible',
            tabIndex = IndexStart,
            colCount = 0;
        $(ParentSelector).find(selector).each(function (index) {
            var input = $(this).find('input');
            input.attr('tabindex', tabIndex);
            if (!$(this).hasClass('k-picker-wrap') && !$(this).hasClass('k-numeric-wrap')) {
                if ($(this).width() < ColWidth) {
                    $(this).attr('tabindex', tabIndex);
                    if (++colCount > ColCount - 1) {
                        tabIndex++;
                        colCount = 0;
                    }
                } else {
                    if (index !== KeepIndex) {
                        $(this).attr('tabindex', tabIndex++);
                    } else {
                        $(this).attr('tabindex', tabIndex);
                    }
                };

                if (fnc && index > 2) {
                    tabIndex = fnc(tabIndex, index);
                }
            };
        });
        return tabIndex;
    };

    vmEditGoal.resetTabIndex = function () {
        var tab1 = vmEditGoal.initTabIndex({ ParentSelector: '#popEditMainGoal .mleft-custom-tabindex', IndexStart: 1, ColWidth: 200, ColCount: 2, KeepIndex: 1 }, function (tabIndex, index) {
            if ($('#popEditMainGoal .mright-custom-tabindex').height() > 552) {
                if (index > 2) tabIndex--;
            } else if ($('#popEditMainGoal .mright-custom-tabindex').height() > 483) {
                if (index > 2 && index < 5) tabIndex--;
            }
            return tabIndex;
        });

        vmEditGoal.initTabIndex({ ParentSelector: '.mright-custom-tabindex', IndexStart: 1, ColWidth: 200, ColCount: 2 });

        $('#popEditMainGoal .m-custom-tabindex').find('input:visible').each(function () {
            $(this).attr('tabindex', tab1);
        });

        tab1 = vmEditGoal.initTabIndex({ ParentSelector: '#popEditMainGoal .m2-custom-tabindex', IndexStart: 8, ColWidth: 500, ColCount: 3 });

        $('#popEditMainGoal .modal-mass-iconplus button').attr('tabindex', tab1++);
        $('#popEditMainGoal .modal-market-footer button').attr('tabindex', tab1);
        $('#btemplate > span[aria-disabled="false"]').attr('tabindex', ++tab1);
        $('#btemplate > #btnAddTemplate').attr('tabindex', tab1);
        $('#btemplate > button:eq(1)').attr('tabindex', tab1);

        setTimeout(function () {
            if (document.getElementById('popEditMainGoal_wnd_title')) {
                tab1++;
                $('#popEditMainGoal_wnd_title').next().children().each(function (index) {
                    if (index == 1) $(this).attr('tabindex', tab1);
                    else $(this).attr('tabindex', (tab1 + 1));
                });
            }
        }, 1000);
    };
    //Pageload
    var actionPlanRegions = [];
    var landregionMenuData = [];
    vmGoalAction.kpiGoalDeleted = [];

    function destroyKpiTooltip() {
        //destroy tooltip
        $("#area-edit-goal .icon-kpi-goal-small").each(function () {
            var other = $(this).data("kendoTooltip");
            if (other) other.destroy();
        });
    };

    $(document).ready(function () {
        var oldConnection = [];
        var oldPeople = [];

        limitedTabKey();

        vmEditGoal.valid = true;
        vmEditGoal.modelChanged = false;
        vmEditGoal.lstAccounts = vmCommon.pushApply([], vmGoalAction.setting.Accounts, function (item) { return { AccountId: item.Id, Name: item.Name, Email: item.Email, FirstName: item.FirstName, LastName: item.LastName }; });
        isSelectRegion = vmGoalAction.goalOptions.RegionSelectable;
        
        actionPlanRegions = vmGoalAction.goalOptions.ActionPlanRegions;

        if (vmGoalAction.goalOptions.IsEdit || vmGoalAction.goalOptions.FromBoard) {
            if (vmGoalAction.goalOptions.IsEdit) {
                vmFile.idFileAssigned.assigntype = vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.MainGoal ? 'maingoal' : 'subgoal';
                vmFile.objAssign.type = vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.MainGoal ? "maingoal" : 'subgoal';
                vmFile.assginedIcon("popEditMainGoal");
            }

            vmEditGoal.theGoal = vmGoalAction.goalOptions.Goal;
            vmEditGoal.theGoal.IsFinishAll = false;
            vmEditGoal.theGoal.IsVisibilityAll = false;
            vmEditGoal.theGoal.IsCalendarAll = false;
            vmEditGoal.theGoal.IsChangeStartDateAll = false;

            oldPeople = vmCommon.pushApply([], vmEditGoal.theGoal.People, function (item) { return { AccountId: item.AccountId, Email: item.Email, FirstName: item.FirstName, LastName: item.LastName }; });

            if (vmGoalAction.goalOptions.IsHasKpiReport || vmGoalAction.msSubMarketIsHasKpi)
                createKpiReportIcon(vmEditGoal.theGoal.Id);

            //config goal from board
            if (vmGoalAction.goalOptions.FromBoard) {
                //vmEditGoal.theGoal.StartDate = new Date();
                //vmEditGoal.theGoal.Date = new Date();
                vmEditGoal.theGoal.MColor = "#B8C92E";
            }

        } else {
            vmEditGoal.theGoal = {
                Name: "",
                MColor: '#B8C92E',
                Finish: false,
                Visibility: true,
                Categories: [],
                Date: null,
                StartDate: null,
                Evaluation: -1,
                EvaluationComment: '',
                Fields: [],
                Description: "",
                Effect: "",
                People: [],
                Status: [],
                IsFinishAll: false,
                IsVisibilityAll: false,
                IsChangeStartDateAll: null,
                IsCalendarAll: false,
                InMinDate: null,
                InMaxDate: null,
                OutMinDate: null,
                OutMaxDate: null,
                Budget: 0,
                ExpectedCost: 0,
                ActualCost: 0,
                SubProducts: [],
                MasterId: vmGoalAction.goalOptions.parentMasterId,
                Purpose: "",
                Arrived: "",
                KpiGoalData: vmGoalAction.goalOptions.DefaultKpi,
                ParentId: vmGoalAction.goalOptions.ParentId,
                IsCalendar: vmGoalAction.goalOptions.IsCalendar != undefined ? vmGoalAction.goalOptions.IsCalendar : true,
                ActionPlanRegions: [],
                Links: [],
                CreatedDate: new Date()
                //ActionPlanEvalData: {
                //    APEvaluationData:
                //    {
                //        APEvaluations: [],
                //        APEvaluationsY: [],
                //        APEvaluationsZ: [],
                //        TitleX: null,
                //        TitleY: null,
                //        TitleZ: null
                //    },
                //    ApSwotanalyses: [],
                //    TargetData: {}
                //}
            };

            void function validCreatedDate() {
                var a = vmEditGoal.theGoal.CreatedDate;
                if (typeof a == "string") {
                    var b = a.replace('/Date(', '');
                    b = b.replace(')/', '');
                    b = +b; //  convert to integer
                    if (b < 0) {
                        vmEditGoal.theGoal.CreatedDate = new Date();
                    }
                }
            }();
            vmEditGoal.theGoal.StartDate = vmGoalAction.goalOptions.parentStart;
            vmEditGoal.theGoal.Date = vmGoalAction.goalOptions.parentEnd;
        }
        
        // add icon evaluation
        createEvaluationIcon(vmEditGoal.theGoal.Id);

        //connection
        for (var i = 0; i < vmEditGoal.theGoal.SubProducts.length; i++) {
            var goalItem = vmEditGoal.theGoal.SubProducts[i];
            for (var k = 0; k < vmGoalAction.goalOptions.customConnection.length; k++) {
                var subItem = vmGoalAction.goalOptions.customConnection[k];
                if (goalItem.SubProductId === subItem.SubProductId && goalItem.Type === subItem.Type) {
                    goalItem.Id = subItem.Id;

                    oldConnection.push(goalItem);
                }
            }

            if (goalItem.Id === 0) {
                goalItem.DataState = dataState.Modified;
            }
        }

        for (var j = 0; j < vmEditGoal.theGoal.Status.length; j++) {
            vmEditGoal.theGoal.Status[j].IsOrigin = true;
            vmEditGoal.theGoal.Status[j].Description = vmEditGoal.theGoal.Status[j].Description || kLg.labelComment;
        }

        //var newCons = [];
        //var delCons = [];

        var isActiveTemp = false;
        if (vmGoalAction.goalTemplates.length) {
            isActiveTemp = true;
        }

        isSelectMaster = (vmGoalAction.goalOptions.MasterGoal ? true : false) && vmGoalAction.goalOptions.HasMasterGoal;
        vmGoalAction.GoalMaster.FirstId = vmEditGoal.theGoal.MasterId;

        if (vmGoalAction.goalOptions.MasterGoal) {
            vmGoalAction.goalOptions.MasterGoal.unshift({ Name: "" });
        }

        vmEditGoal.theGoal.StartDate = vmCommon.toDateUtc(vmEditGoal.theGoal.StartDate);
        vmEditGoal.theGoal.Date = vmCommon.toDateUtc(vmEditGoal.theGoal.Date);
        vmEditGoal.theGoal.DateSpace = 0;

        //subproduct
        var subProductGroups = vmGoalAction.goalOptions.SubProductGroups;
        var regionGroups = actionPlanRegions;
        var isVisibleSub = true;

        var autoSubSrc = vmEditGoal.getSourceForSub(subProductGroups, false),
            labeSubSrc = vmEditGoal.getSourceForSub(subProductGroups, true);

        var autoRegionSrc = vmEditGoal.getSourceForSub(regionGroups, false),
            labeRegionSrc = vmEditGoal.getSourceForSub(regionGroups, true);

        //subclient
        var subClientGroups = vmGoalAction.goalOptions.SubClientGroups;
        var isVisibleClient = true;

        var autoClientSrc = vmEditGoal.getSourceForSub(subClientGroups, false),
            labeClientSrc = vmEditGoal.getSourceForSub(subClientGroups, true);

        vmGoalAction.kpiGoalSettings = undefined;

        vmEditGoal.theGoal.SubMarketProductId = vmGoalAction.goalOptions.SubMarketProductId;
        vmEditGoal.theGoal.IndependencyId = vmGoalAction.goalOptions.IndependencyId;

        vmEditGoal.viewModel = kendo.observable({
            hasLink: vmEditGoal.theGoal.Visibility || vmEditGoal.theGoal.Links.some(t => t.IsShow),
            isHasKpi: vmGoalAction.goalOptions.IsHasKpi,
            isSyncSelectable: vmGoalAction.goalOptions.IsHasKpi && vmGoalAction.goalOptions.role >= vmCommon.MemberRole.Edit,
            setVisibleKpi: function () { },
            openKpiGoal: function () {
                var that = this;
                destroyKpiTooltip();

                //get kpigoal-setting
                var template = this.templateId || {};
                vmGoalAction.kpiGoalOptions = {};
                vmGoalAction.kpiGoalOptions.goalModel = this.goal;
                vmGoalAction.kpiGoalOptions.goalModel.ParentId = vmGoalAction.goalOptions.ParentId;

                vmGoalAction.kpiGoalOptions.role = vmGoalAction.goalOptions.role;
                vmGoalAction.kpiGoalOptions.templateId = template.Id;
                vmGoalAction.kpiGoalOptions.selectableTopics = vmEditGoal.getSelectableTopics();

                //callback
                vmGoalAction.kpiGoalOptions.callBack = function (kpiData) {
                    vmEditGoal.syncActionPlanConnection.sync(that);
                };

                vmGoalAction.kpiGoalOptions.KpiData = this.goal.KpiGoalData;

                vmGoalAction.kpiGoalOptions.isMain = vmGoalAction.goalOptions.GoalType === vmCommon.GoalType.MainGoal;

                if (vmGoalAction.kpiGoalSettings == undefined) {
                    vmEditGoal.dataservice.getKpiGoalSetting({ IndependencyId: vmGoalAction.goalOptions.IndependencyId, SubMarketProductId: vmGoalAction.goalOptions.SubMarketProductId, MainGoalId: vmGoalAction.kpiGoalOptions.isMain ? this.goal.Id : this.goal.ParentId, SubGoalId: vmGoalAction.kpiGoalOptions.isMain ? null : this.goal.Id, GoalActionType: vmGoalAction.kpiGoalOptions.isMain ? vmCommon.GoalActionContentType.MainGoal : vmCommon.GoalActionContentType.SubGoal, TemplateId: template.Id }, function (res) {
                        vmGoalAction.kpiGoalSettings = res.value;
                        vmGoalAction.kpiGoalOptions.Settings = vmGoalAction.kpiGoalSettings;

                        vmGoalAction.showPopKpiGoal();
                    });
                } else {
                    vmGoalAction.kpiGoalOptions.Settings = vmGoalAction.kpiGoalSettings;
                    vmGoalAction.showPopKpiGoal();
                }
            },

            isVisibleSub: isVisibleSub,
            isVisibleClient: isVisibleClient,

            isVisibleSelectedRegion: labeRegionSrc.length > 0,
            isVisibleSelectedSub: labeSubSrc.length > 0,
            isVisibleSelectedClient: labeClientSrc.length > 0,
            isSelectRegion: isSelectRegion,
            isSelectMaster: isSelectMaster,
            masterGoal: vmGoalAction.goalOptions.MasterGoal || [],
            isActiveTemp: isActiveTemp && (vmGoalAction.goalOptions.role >= vmCommon.MemberRole.Edit),
            oldConnections: oldConnection,
            subProducts: vmGoalAction.goalOptions.customConnection,
            IsFileAssignedRole: vmGoalAction.goalOptions.IsEdit && (vmGoalAction.goalOptions.role > 0 || (vmEditGoal.theGoal.Files && vmEditGoal.theGoal.Files.length > 0)),
            fileAssignHref: `javascript:vmFile.openFileAsignCrm(${vmFile.idFileAssigned.assignidi ? vmFile.idFileAssigned.assignidi : (vmFile.idFileAssigned.assignidu)}) , ${vmFile.idFileAssigned.assigntype})`,
            isSaveTemplate: vmGoalAction.goalOptions.IsEdit,
            isShowExportKpiReport: !!(vmGoalAction.goalOptions.IsHasKpiReport || vmGoalAction.msSubMarketIsHasKpi),
            templateId: null,
            goaltemps: vmGoalAction.goalTemplates,
            roleEdit: vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit,
            listGoalCategory: vmGoalAction.setting.GoalCategory,
            listGoalEvaluation: vmGoalAction.setting.GoalEvaluation,
            multiSelectFiltering: function (e) {
                var filter = e.filter;
                if (filter) {
                    filter.value = filter.value.replace(/\s\s+/g, ' ');
                    if (filter.value.indexOf(' ') == 0) {
                        filter.value = filter.value.slice(1);
                    };
                    e.sender.input.val(filter.value);
                };
            },
            dropdownListFiltering: function (e) {
                var filter = e.filter;
                if (filter) {
                    filter.value = filter.value.replace(/\s\s+/g, ' ');
                    if (filter.value.indexOf(' ') == 0) {
                        filter.value = filter.value.slice(1);
                    };
                    e.sender.filterInput.val(filter.value);
                }
            },
            filteringEvaluation: function (e) {
                this.dropdownListFiltering(e);
                var drplst = e.sender;
                if (vmEditGoal.EvaluationSelectName == undefined) {
                    vmEditGoal.EvaluationSelectName = drplst.text();
                };
                setTimeout(function () {
                    var hasChildSelected = false;
                    drplst.ul.children().each(function () {
                        if ($(this).text() == vmEditGoal.EvaluationSelectName) {
                            hasChildSelected = true;
                        }
                    });

                    if (hasChildSelected == true) {
                        drplst.select(function (dataItem) {
                            return dataItem.Name == vmEditGoal.EvaluationSelectName;
                        });
                    }
                }, 9);
            },
            selectEvaluation: function (e) {
                var selectedItem = e.dataItem;
                vmEditGoal.EvaluationSelectName = selectedItem.Name;
            },
            listActionField: vmGoalAction.setting.ActionField,
            listProtocolStatus: vmGoalAction.setting.ProtocolStatus,
            listPerson: vmEditGoal.lstAccounts,
            goal: vmEditGoal.theGoal,
            budgetInfo: findMasterGoalInfo(1, vmGoalAction.goalOptions.MasterGoal, vmEditGoal.theGoal.MasterId),
            etCostInfo: findMasterGoalInfo(2, vmGoalAction.goalOptions.MasterGoal, vmEditGoal.theGoal.MasterId),
            atCostInfo: findMasterGoalInfo(3, vmGoalAction.goalOptions.MasterGoal, vmEditGoal.theGoal.MasterId),
            //dateFormat: getDateFormat(),
            autoSubValue: null,
            tempSubValue: null,

            autoClientValue: null,
            tempClientValue: null,

            autoRegionSrc: autoRegionSrc,
            labeRegionSrc: labeRegionSrc,

            autoSubSrc: autoSubSrc,
            labeSubSrc: labeSubSrc,

            autoClientSrc: autoClientSrc,
            labeClientSrc: labeClientSrc,

            displaySrc: [],
            displayClientSrc: [],
            openReminder: function (e) {
                vmGoalAction.openPopReminder(e, vmCommon.EnumTypeReminder.Goal);
            },
            autoCheckReminder: function (e) {

                var goalR = vmEditGoal.viewModel.goal;

                var listAcc = vmCommon.deepCopy(goalR.People).sort(SortByLastName);
                vmEditGoal.viewModel.set("goal.People", listAcc);

                if (goalR.People.length > 0 && !goalR.Finish && goalR.Date !== null) {
                    var d = new Date();
                    if (!compareDate(d, goalR.Date) || equalDate(d, goalR.Date)) {
                        vmEditGoal.showHideGoalReminder('none');
                    } else {
                        vmEditGoal.showHideGoalReminder('block');
                    }
                } else {
                    vmEditGoal.showHideGoalReminder('none');
                }
                return true;
            },
            setGoalActionOutlook: function (e) {
                var listEmail = "";
                var goalOutlook = vmEditGoal.viewModel.goal;
                for (var i = 0; i < goalOutlook.People.length; i++) {
                    if (i === goalOutlook.People.length - 1) {
                        listEmail += goalOutlook.People[i].Email;
                    } else {
                        listEmail += goalOutlook.People[i].Email + "; ";
                    }
                }
                var name = goalOutlook.Name ? goalOutlook.Name : " ";
                var des = goalOutlook.Description ? goalOutlook.Description : "";
                name = name.replaceAll("&", "%26");
                var isDashboard = vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard);
                var _fullUrlEncoded = isDashboard ? vmDashboard.AddressBar.ClientQuery.getFullUrlEncoded() : vmCommon.AddressBar.ClientQuery.getFullUrlEncoded();
                var body = des + " \n \n " + _fullUrlEncoded;

                $('a.assignInfo').removeAttr("href");
                $('a.assignInfo').attr("href", "mailto:" + listEmail + "?Subject=" + name + "&Body=" + encodeURIComponent(body));

                $('a.assignInfo').attr("target", "_top");
            },
            selectMasterGoal: function (e) {
                if (e.dataItem.IsFinish || e.dataItem.IsMain) {
                    e.preventDefault();
                }
            },
            mastergoalIndexChange: function (e) {
                var idx = e.sender.selectedIndex;
                var bginfo = findMasterGoalInfo(1, vmGoalAction.goalOptions.MasterGoal, vmGoalAction.goalOptions.MasterGoal[idx].Id);
                var etinfo = findMasterGoalInfo(2, vmGoalAction.goalOptions.MasterGoal, vmGoalAction.goalOptions.MasterGoal[idx].Id);
                var atinfo = findMasterGoalInfo(3, vmGoalAction.goalOptions.MasterGoal, vmGoalAction.goalOptions.MasterGoal[idx].Id);
                $(".budgetInfo").text('').text(bginfo);
                $(".etCostInfo").text('').text(etinfo);
                $(".atCostInfo").text('').text(atinfo);
            },
            changeCost: function (e) {
                var item = e.data;
                if (item.goal.Budget === null) {
                    item.goal.set("Budget", 0);
                }
            },

            onChangeRegionCheck: function (e) {
                if (e.data.Id > 0) e.data.set("DataState", dataState.Modified);
            },

            openSelectRegion: function (e) {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.selectRegionOptions = {};
                vmGoalAction.selectRegionOptions.GoalActionType = 1; //goal

                vmGoalAction.selectRegionOptions.viewModel = vmEditGoal.viewModel;
                vmGoalAction.selectRegionOptions.selectedRegions = vmEditGoal.viewModel.labeRegionSrc;
                vmGoalAction.selectRegionOptions.autoRegions = vmEditGoal.viewModel.autoRegionSrc;

                function getLandRegionCallback() {
                    vmGoalAction.selectRegionOptions.menuData = landregionMenuData;

                    vmGoalAction.openPopSelectRegion();
                }

                if (landregionMenuData && landregionMenuData.length > 0) {
                    getLandRegionCallback();
                } else {
                    vmGoalAction.dataservice.getLandRegionMenuData({ subMarketProductId: vmGoalAction.goalOptions.SubMarketProductId, independencyId: vmGoalAction.goalOptions.IndependencyId }, function (res) {
                        landregionMenuData = res.value;
                        getLandRegionCallback();
                    });
                }
            },

            removeRegion: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var removedRegion = e.data;
                removedRegion.set("IsCheck", false);
                if (removedRegion.Id > 0) e.data.set("DataState", dataState.Deleted);

                var index = this.labeRegionSrc.indexOf(removedRegion);
                if (index > -1) {
                    this.autoRegionSrc.push(removedRegion);
                    this.labeRegionSrc.splice(index, 1);

                    this.autoRegionSrc.sort(function (a, b) { return a.Index - b.Index; });
                }

                //sync
                var that = this;
                vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.LandRegion);
            },

            selectRegionGroup: function (e) {
                var selectedRegion = e.dataItem;
                if (selectedRegion.Id > 0) selectedRegion.set("DataState", dataState.Modified);

                var index = this.autoRegionSrc.indexOf(selectedRegion);
                if (index > -1) {
                    this.labeRegionSrc.push(selectedRegion);
                    this.autoRegionSrc.splice(index, 1);
                }

                //sync
                var that = this;
                vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.LandRegion);
            },

            changeRegionGroup: function (e) {
                this.set("autoRegionValue", null);
                this.set("tempRegionValue", null);
                this.set("isVisibleSelectedRegion", this.labeRegionSrc.length > 0);
            },
            selectSubProductGroup: function (e) {
                DestroyToolTip($(e.sender.element));
                vmEditGoal.isValidSub = true;

                var item = e.sender.dataItem(e.item.index());
                item.IsSelect = true;
                item.DataState = item.Id == null ? dataState.Modified : dataState.Unchanged;

                this.tempSubValue = item;
            },
            selectSubClientGroup: function (e) {
                DestroyToolTip($(e.sender.element));
                vmEditGoal.isValidClient = true;

                var item = e.sender.dataItem(e.item.index());
                item.IsSelect = true;
                item.DataState = item.Id == null ? dataState.Modified : dataState.Unchanged;

                this.tempClientValue = item;
            },
            changeSubProductGroup: function (e) {
                if (this.tempSubValue) {
                    var index = this.autoSubSrc.indexOf(this.tempSubValue);
                    this.labeSubSrc.push(this.tempSubValue);
                    this.autoSubSrc.splice(index, 1);

                    vmGoalAction.subService.autoChange(this.tempSubValue, vmGoalAction.subService.rootType.SubProduct);
                    vmGoalAction.subService.groupSub();

                    this.set("autoSubValue", null);
                    this.set("tempSubValue", null);

                    this.set("isVisibleSelectedSub", this.labeSubSrc.length > 0);
                } else {
                    if (e.sender.element[0].value.trim() === "") {
                        DestroyToolTip($(e.sender.element));
                        vmEditGoal.isValidSub = true;
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        vmEditGoal.isValidSub = false;
                    }
                }

                //sync
                var that = this;
                vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Product);

                vmGoalAction.autoSubHeight();
            },
            changeSubClientGroup: function (e) {
                var tempItem = vmCommon.deepCopy(this.tempClientValue);

                if (this.tempClientValue) {
                    var index = this.autoClientSrc.indexOf(this.tempClientValue);
                    this.labeClientSrc.push(this.tempClientValue);
                    this.autoClientSrc.splice(index, 1);

                    vmGoalAction.subService.autoChange(this.tempClientValue, vmGoalAction.subService.rootType.SubClient);
                    vmGoalAction.subService.groupClient();

                    this.set("autoClientValue", null);
                    this.set("tempClientValue", null);

                    this.set("isVisibleSelectedClient", this.labeClientSrc.length > 0);
                } else {
                    if (e.sender.element[0].value.trim() === "") {
                        DestroyToolTip($(e.sender.element));
                        vmEditGoal.isValidClient = true;
                    } else {
                        ShowToolTip($(e.sender.element), kLg.InvalidData, "top");
                        vmEditGoal.isValidClient = false;
                    }
                }

                //sync
                if (tempItem && tempItem.TypeId != 7 && tempItem.TypeId != 4) {
                    var that = this;
                    vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Market);
                }

                vmGoalAction.autoSubHeight();
            },

            removeSubProduct: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var tempItem = e.data;
                var index = vmCommon.findIndexByFunc(this.labeSubSrc, function (it) { return it.ObjectId == tempItem.ObjectId && it.TypeId == tempItem.TypeId; });

                tempItem.IsSelect = false;
                tempItem.DataState = tempItem.Id == null ? dataState.Unchanged : dataState.Deleted;

                this.autoSubSrc.push(tempItem);
                this.labeSubSrc.splice(index, 1);

                vmGoalAction.subService.autoChange(tempItem, vmGoalAction.subService.rootType.SubProduct);

                this.set("isVisibleSelectedSub", this.labeSubSrc.length > 0);
                vmGoalAction.subService.groupSub();

                //sync
                var that = this;
                vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Product);

                vmGoalAction.autoSubHeight();
            },
            removeSubClient: function (e) {
                if (this.roleEdit) {
                    return;
                }

                var tempItem = e.data;
                var index = vmCommon.findIndexByFunc(this.labeClientSrc, function (it) { return it.ObjectId == tempItem.ObjectId && it.TypeId == tempItem.TypeId; });

                tempItem.IsSelect = false;
                tempItem.DataState = tempItem.Id == null ? dataState.Unchanged : dataState.Deleted;

                this.autoClientSrc.push(tempItem);
                this.labeClientSrc.splice(index, 1);

                vmGoalAction.subService.autoChange(tempItem, vmGoalAction.subService.rootType.SubClient);

                this.set("isVisibleSelectedClient", this.labeClientSrc.length > 0);
                vmGoalAction.subService.groupClient();

                //sync
                if (tempItem && tempItem.TypeId != 7 && tempItem.TypeId != 4) {
                    var that = this;
                    vmEditGoal.syncKpiService.init(that, vmCommon.KpiGoalTopicType.Market);
                }

                vmGoalAction.autoSubHeight();
            },

            openSubProduct: function () {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.subOptions = { RootType: vmGoalAction.subService.rootType.SubProduct };
                vmGoalAction.subOptions.GoalActionType = 1;
                vmGoalAction.subOptions.gaModel = this;

                vmGoalAction.openPopSubProduct(kLg.strSelectionFormat.format(kLg.filterLblProduct));
            },
            openSubClient: function () {
                if (this.roleEdit) {
                    return;
                }

                vmGoalAction.subOptions = { RootType: vmGoalAction.subService.rootType.SubClient };
                vmGoalAction.subOptions.GoalActionType = 1;
                vmGoalAction.subOptions.gaModel = this;

                vmGoalAction.openPopSubProduct(kLg.strSelectionFormat.format(kLg.titleStackholderGroups));
            },

            redirectOrg: function (e) {
                var item = e.data;
                if (!item.OrganisationId) return;

                var url = "/Pages/CrmOrganisation.aspx?lang=" + kLg.language + "&projid=" + projectId + "&strid=" + strategies[2] + "&oid=" + item.OrganisationId;
                window.open(url, "_blank");
            },

            delTemplate: function (e) {
                vmEditGoal.showPopEditTemplate();
            },
            hasSelectTemplate: false,
            selectTemplate: function (e) {
                if (e.sender._oldIndex === 0) {
                    vmEditGoal.viewModel.set("templateId", null);
                    vmEditGoal.optionTemp.Applying = null;

                    vmFile.reLoadFileAssigned();
                    return;
                }

                var temp = e.data.templateId;
                if (temp) {
                    ynConfirmTemp(kLg.msgConfirmApplyNewTemplate).then(function () {
                        //var goaltemp = vmEditGoal.findTempCache(temp.Id);
                        //if (goaltemp) {
                        //    vmEditGoal.bindGoalTemplateData(goaltemp);
                        //    return;
                        //}

                        var edate = $('#txtNewStartDate').data("kendoDatePicker").value();
                        var year = edate.getFullYear();
                        var month = (1 + edate.getMonth()).toString();
                        month = month.length > 1 ? month : '0' + month;
                        var day = edate.getDate().toString();
                        day = day.length > 1 ? day : '0' + day;
                        var newStartDate = month + '/' + day + '/' + year;

                        var goal = vmEditGoal.viewModel.get("goal");

                        vmEditGoal.dataservice.getGoalTemplate({ currentGoalId: goal.Id, goalId: temp.Value, templateId: temp.Id, newStartDate: newStartDate, GoalType: vmGoalAction.goalOptions.GoalType, regionId: vmGoalAction.goalOptions.RegionId || 0, independencyId: vmGoalAction.goalOptions.IndependencyId || 0, parentId: vmGoalAction.goalOptions.ParentId, subMarketProductId: vmGoalAction.goalOptions.SubMarketProductId }, function (res) {
                            if (res.value) {
                                vmEditGoal.viewModel.set("hasSelectTemplate", true);
                                vmEditGoal.theGoal.DateSpace = res.value.DateSpace;
                                //vmEditGoal.TempCache[temp.Id] = res.value;

                                vmEditGoal.bindGoalTemplateData(res.value);

                                //vmEditGoal.IsFromTemplate = true;
                            }
                        });

                    }, function () {
                        vmEditGoal.viewModel.set("templateId", vmEditGoal.optionTemp.Applying || null);
                    });
                }
            },

            saveTemplate: function (e) {

                popName(kLg.titleSaveTemplate).then(function () {
                    vmEditGoal.optionTemp.Template = { Name: popName.Data };
                    vmEditGoal.viewModel.update();
                    return;
                },
                    function () {
                        delete vmEditGoal.optionTemp.Template;
                        return;
                    });
            },
            addStatus: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;
                this.goal.Status.unshift({
                    Date: new Date(),
                    StatusId: -1,
                    Description: kLg.labelComment,
                    IsOrigin: true,
                    IsNew: true,
                    Id: '' + Date.now() + '_' + vmCommon.emptyGuid // use Date.now() to save data in format popup
                });
                vmEditGoal.AdjustPopupHeight();
                $("#gridStatusProtocol input[data-role='datepicker']").kendoDatePicker({
                    weekNumber: true
                });
                vmEditGoal.resetTabIndex();

                vmCommon.TexEditor.Placeholder.setAttr($('.dnbStatusKendoEditor').first(), vmCommon.TexEditor.Type.Status
                    ).setInnerHTML()(vmEditGoal.viewModel.roleEdit);
                
            },
            delStatus: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;
                var status = this.goal.Status;
                var theStatus = e.data;
                var index = status.indexOf(theStatus);
                this.goal.Status[index].set("IsOrigin", false);

                if (index >= 0 && (theStatus.Id == null || theStatus.Id == vmCommon.emptyGuid)) {
                    this.goal.Status.splice(index, 1);
                }

                vmEditGoal.AdjustPopupHeight();
                vmEditGoal.resetTabIndex();
            },
            startDateChange(e) {
                showMessageConfirmChangeStartDate();
                reCalculatEndDate();
                this.dateChange(e);
            },
            IsEdit: vmGoalAction.goalOptions.IsEdit,
            dateChange: function (e) {
                if (typeof this.goal.StartDate === "string") {
                    this.goal.StartDate = this.goal.StartDate.jsonToDate();
                }
                if (typeof this.goal.Date === "string") {
                    this.goal.Date = this.goal.Date.jsonToDate();
                }
                var elem = e.sender.element[0];
                if (!this.goal.Date) {
                    if ($("#txtDate").val().trim().length > 0) {
                        $("#txtDate").attr("title", kLg.msgDateInValid);
                        $("#txtDate").tooltip({ trigger: "manual" }).tooltip("show");
                    } else {
                        $("#txtDate").tooltip("destroy");
                    }
                    vmEditGoal.showHideGoalReminder('none');
                }

                if (!this.goal.StartDate) {
                    $("#txtStartDate").attr("title", kLg.msgDateInValid);
                    $("#txtStartDate").tooltip({ trigger: "manual" }).tooltip("show");
                    vmEditGoal.valid = false;
                    return;
                } else {
                    vmEditGoal.valid = true;
                    $("#txtStartDate").tooltip("destroy");

                }
                if (this.goal.Date) {
                    var oldDate = this.goal.Date;
                    if (!compareDate(this.goal.StartDate, this.goal.Date)) {
                        if (elem.id === "txtStartDate") {
                            oldDate.setFullYear(this.goal.StartDate.getFullYear());
                            this.goal.set("Date", oldDate);
                            $('#txtDate').data("kendoDatePicker").value(oldDate);
                            if (!compareDate(this.goal.StartDate, oldDate)) {
                                $('#txtDate').tooltip("destroy");
                                $('#txtDate').attr("title", kLg.msgValidateStartEndDate);
                                $('#txtDate').tooltip({ trigger: "manual" }).tooltip('show');
                                vmEditGoal.showHideGoalReminder('none');
                                vmEditGoal.valid = false;
                            } else {
                                vmEditGoal.valid = true;
                                $('#txtStartDate').tooltip('destroy');
                                $('#txtDate').tooltip('destroy');

                            }
                        } else {
                            $('#txtDate').tooltip("destroy");
                            $('#txtDate').attr("title", kLg.msgValidateStartEndDate);
                            $('#txtDate').tooltip({ trigger: "manual" }).tooltip('show');
                            vmEditGoal.showHideGoalReminder('none');
                            vmEditGoal.valid = false;
                        }
                    } else {
                        $('#txtStartDate').tooltip('destroy');
                        $('#txtDate').tooltip('destroy');
                        var d = new Date();
                        if (!compareDate(d, this.goal.Date) || equalDate(d, this.goal.Date)) {
                            vmEditGoal.showHideGoalReminder('none');
                        } else {
                            vmEditGoal.showHideGoalReminder('block');
                        }

                        vmEditGoal.valid = true;
                    }
                }
            },
            LastChange: function () {
                if (vmGoalAction.goalOptions.IsEdit) {
                    var modifiedDate = vmGoalAction.goalOptions.Goal.ModifiedBy == 0 ? vmGoalAction.goalOptions.Goal.CreatedDate : vmGoalAction.goalOptions.Goal.ModifiedDate;
                    return kLg.LastChange + ": " + kendo.toString(modifiedDate.jsonToDate(), "d") + " " + vmGoalAction.goalOptions.Goal.ModifiedName;
                }
                else return '';
            },
            saveFromFormatForm: function (dataId, value) {
                var theGoal = vmCommon.deepCopy(this.goal);

                if (vmGoalAction.goalOptions.IsEdit) {
                    var data = getDataByDataId();
                    if (data) {
                        data.Id = theGoal.Id;

                        vmEditGoal.dataservice.updateGoalFromFormatPopup(data, function (serData) { //var resObj = serData.value;
                            vmEditGoal.modelChanged = true;
                            vmEditGoal.isChangeText = true;
                        });
                    }
                }


                function getDataByDataId() {
                    var dataEntry = {};

                    if (vmGoalAction.goalOptions.GoalType === vmCommon.GoalType.SubGoal) {
                        dataEntry.ParentId = vmGoalAction.goalOptions.ParentId;
                    };
                    switch (dataId) {
                        case 'txtDescriptionMainSub':
                            if (value == kLg.labelDesPlace) {
                                value = '';
                            }
                            dataEntry.Description = value;
                            vmEditGoal.viewModel.goal.set("Description", value);
                            return dataEntry;
                        case 'txtEffect':
                            if (value == kLg.labelEffectPlace) {
                                value = '';
                            }
                            dataEntry.Effect = value;
                            vmEditGoal.viewModel.goal.set("Effect", value);
                            return dataEntry;
                        case 'txtPurpose':
                            if (value == kLg.labelPurposePlace) {
                                value = '';
                            }
                            dataEntry.Purpose = value;
                            vmEditGoal.viewModel.goal.set("Purpose", value);
                            return dataEntry;
                        case 'txtArrived':
                            if (value == kLg.labelArrivedPlace) {
                                value = '';
                            }
                            dataEntry.Arrived = value;
                            vmEditGoal.viewModel.goal.set("Arrived", value);
                            return dataEntry;
                        default:

                            var txtPre = 'dnbStatusEditor_';
                            if (dataId.indexOf(txtPre) === 0) {                 // list of status
                                var statusId = dataId.replace(txtPre, '');

                                if (dataId.split('_').length > 2) {           // Add new from format popup
                                    var eData = theGoal.Status.find(elm => { return elm.Id == statusId });
                                    if (eData != undefined && value) {
                                        eData.Id = undefined;
                                        eData.Description = value;
                                        eData.GoalId = theGoal.Id;  // ActionId = null/undefined
                                        vmEditGoal.dataservice.addStatusFromFormatPopup(eData, function (serData) {
                                            var resObj = serData.value;
                                            var newId = resObj.Id;

                                            // set new id in DOM
                                            var $textAreaId = $('#' + dataId);
                                            $textAreaId.attr("id", txtPre + newId);
                                            var $divDataId = $(`div[data-id="${dataId}"]`);
                                            $divDataId.attr("data-id", txtPre + newId);
                                            var $areaControl = $(`ul[aria-controls="${dataId}"]`);
                                            $areaControl.attr("aria-controls", txtPre + newId);

                                            vmCommon.TexEditor.setSelectorFromEdit(txtPre + newId);

                                            // update id in data source
                                            vmEditGoal.viewModel.goal.Status.forEach(elm => {
                                                if (elm.Id == statusId) {
                                                    elm.IsNew = false;
                                                    elm.Description = value;
                                                    elm.Id = newId;
                                                    elm.GoalId = theGoal.Id;
                                                    elm.Date = resObj.Date;
                                                    elm.CreatedBy = resObj.CreatedBy;
                                                }
                                            });
                                        });
                                    }
                                } else {            // Edit from format popup
                                    statusId = dataId.replace(txtPre, '');
                                    if (statusId != vmCommon.emptyGuid) {
                                        vmEditGoal.dataservice.updateStatusFromFormatPopup({
                                            Id: statusId,
                                            Description: value
                                        }, function (serData) {
                                            //var resObj = serData.value;
                                            // update description in data source
                                            vmEditGoal.viewModel.goal.Status.forEach(elm => {
                                                if (elm.Id == statusId) {
                                                    elm.Description = value;
                                                }
                                            });
                                        });
                                    }
                                }
                            };

                            return undefined;
                    }
                }

            },
            isValidName: function () {
                if ($('#txtName').val().trim() === "") {
                    $('#txtName').attr("title", kLg.msgRequired);
                    $('#txtName').tooltip({ trigger: "manual" }).tooltip('show').attr("title", "");
                    return false;
                };
                return true;
            },
            update: function () {
                $('form#fEditGoal #btnUpdate').prop('disabled', true); // prevent internet slow to create mutil douplicate
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit) {
                    vmGoalAction.popEditMainGoal.close();
                    return;
                };
                if (!isValidDate() || !$("#fEditGoal").valid() || !vmEditGoal.valid || !isValidSub() || !isValidClient() || !isValidStatus()) {
                    if (!this.isValidName()) {
                        $('#txtName').focus();
                    }
                    return;
                }

                var theGoal = vmEditGoal.optionTemp.Template ? JSON.parse(JSON.stringify(this.goal)) : this.goal;

                // convert Id to emptyGuid because addStatus: (Id: '' + Date.now() + '_' + vmCommon.emptyGuid);
                theGoal.Status.forEach(el => {
                    el.Description = htmlEncode($("#dnbStatusEditor_" + el.Id).val());
                    if (el.Id.indexOf(vmCommon.emptyGuid) > 0) {
                        el.Id = vmCommon.emptyGuid;
                    };
                });

                theGoal = fixGoalData(theGoal);
                vmGoalAction.GoalMaster.LastId = theGoal.MasterId;
                theGoal.Date = changeHourOfDate(theGoal.Date);
                theGoal.StartDate = changeHourOfDate(theGoal.StartDate);
                theGoal.Description = vmCommon.TexEditor.getValueFromEditor($('#area-edit-goal #txtDescriptionMainSub'));
                theGoal.Purpose = vmCommon.TexEditor.getValueFromEditor($('#area-edit-goal #txtPurpose'));
                theGoal.Effect = vmCommon.TexEditor.getValueFromEditor($('#area-edit-goal #txtEffect'));
                theGoal.Arrived = vmCommon.TexEditor.getValueFromEditor($('#area-edit-goal #txtArrived'));

                theGoal.SubMarketProductId = theGoal.SubMarketProductId || theGoal.submarketProductId || vmCommon.emptyGuid;
                
                var newPeople = vmCommon.pushApply([], this.goal.People, function (it) { return it.AccountId });

                //region save template

                if (vmEditGoal.optionTemp.Template) {
                    var iStatus = theGoal.Status.length;
                    while (iStatus--) {
                        if (theGoal.Status[iStatus].IsOrigin === false) {
                            theGoal.Status.splice(iStatus, 1);
                        } else {
                            theGoal.Status[iStatus].Date = getCurrentHourOfDate(theGoal.Status[iStatus].Date);
                        }
                    }

                    theGoal.ActionPlanRegions = vmCommon.deepCopy(vmEditGoal.viewModel.labeRegionSrc);
                    theGoal.SubProductGroups = vmCommon.deepCopy(vmEditGoal.viewModel.labeSubSrc);
                    theGoal.SubClientGroups = vmCommon.deepCopy(vmEditGoal.viewModel.labeClientSrc);

                    var dtEntry = {
                        Template: vmEditGoal.optionTemp.Template,
                        Goal: theGoal,
                        GoalType: vmGoalAction.goalOptions.GoalType
                    };
                    vmEditGoal.dataservice.saveTemplate(dtEntry, function (res) {
                        if (res.value) {
                            var gtemps = vmEditGoal.viewModel.get("goaltemps");

                            gtemps.push(res.value);
                            vmEditGoal.viewModel.set("goaltemps", gtemps);
                            vmEditGoal.viewModel.set("templateId", res.value);
                            vmEditGoal.viewModel.set("isActiveTemp", (vmGoalAction.goalOptions.role >= vmCommon.MemberRole.Edit));

                            vmEditGoal.viewModel.templateId = res.value;
                            vmEditGoal.optionTemp.Applying = null;

                        }
                        delete vmEditGoal.optionTemp.Template;

                        return;
                    });

                } //endregion
                else {                    
                    var isChangeConection = false;
                    var tempSubPro = vmCommon.pushApply([], this.oldConnections, function (it) { return it.Id });

                    var subproducts = [];
                    for (var m = 0; m < tempSubPro.length; m++) {
                        var temp = vmEditGoal.FindById(vmGoalAction.goalOptions.customConnection, Number(tempSubPro[m]));
                        if (temp) {
                            subproducts.push({ SubProductId: temp.SubProductId, Type: temp.Type, Id: temp.Id });
                        }
                    }

                    var actionRegions = vmCommon.deepCopy(this.labeRegionSrc);
                    this.autoRegionSrc.forEach(function (it) {
                        if (it.Id > 0) {
                            it.DataState = dataState.Deleted;
                            actionRegions.push(vmCommon.deepCopy(it));
                        }
                    });

                    var isMasterArea = $("span[childId='" + vmGoalAction.goalOptions.IndependencyId + "'].master-title:visible").length > 0 || $("span[smpid='" + vmGoalAction.goalOptions.SubMarketProductId + "'].master-title:visible").length > 0;
                    theGoal.displaySubs = vmEditGoal.viewModel.displaySrc.map(t => t);
                    theGoal.displayClients = vmEditGoal.viewModel.displayClientSrc.filter(t => t.TypeId == 1 || t.TypeId == 2 || t.TypeId == 3).map(t => t);

                    if (vmGoalAction.goalOptions.IsEdit) {
                        isChangeConection = !oldConnection.equals(tempSubPro);
                        var index = theGoal.Status.length;
                        while (index--) {
                            if (theGoal.Status[index].IsOrigin === false && theGoal.Status[index].Id === vmCommon.emptyGuid) {
                                theGoal.Status.splice(index, 1);
                            } else {
                                theGoal.Status[index].Date = getCurrentHourOfDate(theGoal.Status[index].Date);
                            }
                        }

                        if (isChangeConection) {
                            if (subproducts.length === 0) {
                                theGoal.SubProducts.forEach(function (item) {
                                    if (item.DataState !== dataState.Modified) {
                                        item.DataState = dataState.Deleted;
                                    }
                                });
                            } else {
                                for (var i = 0; i < theGoal.SubProducts.length; i++) {
                                    var oldItem = theGoal.SubProducts[i];
                                    if (!vmEditGoal.FindById(subproducts, oldItem.Id)) {
                                        if (oldItem.DataState !== dataState.Modified) {
                                            oldItem.DataState = dataState.Deleted;
                                        }
                                    }
                                }

                                for (var i = 0; i < subproducts.length; i++) {
                                    var tempSub = subproducts[i];
                                    if (!vmEditGoal.FindById(theGoal.SubProducts, tempSub.Id)) {
                                        theGoal.SubProducts.push({ SubProductId: tempSub.SubProductId, Type: tempSub.Type, DataState: dataState.Added });
                                    }
                                }
                            }
                        }

                        oldPeople = vmCommon.pushApply([], oldPeople, function (it) { return it.AccountId });

                        delete theGoal.SubClientGroups;
                        delete theGoal.SubProductGroups;

                        theGoal.subProductGroups = vmGoalAction.subService.dataToSave();
                        for (var item of theGoal.displaySubs) {
                            item.Id = null;
                        }
                        theGoal.subProductGroups.push(...theGoal.displaySubs);

                        theGoal.subClientGroups = vmGoalAction.subService.dataClientToSave();
                        for (var item of theGoal.displayClients) {
                            item.Id = null;
                        }
                        theGoal.subClientGroups.push(...theGoal.displayClients);

                        theGoal.ActionPlanRegions = actionRegions;
                        if (theGoal.IsFromTemplate == undefined) theGoal.IsFromTemplate = false;

                        var entryData = {
                            Goal: theGoal,
                            OldPeople: oldPeople,
                            NewPeople: newPeople,
                            GoalType: vmGoalAction.goalOptions.GoalType,
                            isFile: vmFile.isSaveFromOtherSource,
                            PathParentId: vmGoalAction.goalOptions.PathParentId,
                            PathParentMdf: vmGoalAction.goalOptions.PathParentMdf,
                            HasSelectTemplate: vmEditGoal.viewModel.hasSelectTemplate
                        };
                        if (vmEditGoal.optionTemp.Applying) entryData.TemplateId = vmEditGoal.optionTemp.Applying.Id;

                        vmEditGoal.dataservice.updateGoal(entryData, function (serData) {
                            if (vmCommon.checkConflict(serData.value.ResultStatus)) {
                                vmCommon.popup.close(theGoal, vmEditGoal.optionTemp.Applying);

                                vmEditGoal.modelChanged = false;

                                if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
                                    if (vmGoalAction.popEditMainGoal) {
                                        if (vmCommon.TexEditor.getSelectorEditor() == undefined) {
                                            vmGoalAction.popEditMainGoal.close();
                                        }
                                    } else {
                                        vmEditGoal.modelChanged = false;
                                    }

                                    vmDashGoal.loadGoalAction(vmDashGoal.pageIndex, vmDashGoal.mKey, vmDashGoal.mValue);
                                    return;
                                }
                                else if (vmCommon.checkCurrentPage(vmCommon.enumPage.Calendar)) {
                                    msFilter.controlService.onReloadDataMix();
                                }
                                else if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan)) {
                                    if (vmGoalAction.isReloadByRegionView(theGoal)) {
                                        msFilter.controlService.reLoadData();
                                    } else {
                                        var isResetByResults = vmGoalAction.hasResultsFilter(theGoal.Id, theGoal.ParentId, vmGoalAction.goalOptions.SubMarketProductId, vmGoalAction.goalOptions.IndependencyId);
                                        var isReset = isResetByResults && vmEditGoal.checkFitFilter(theGoal, serData.value.TheObject);

                                        if (msFilter.controlService.hasCriteria(mFilter.enumFilter.masterGoal) &&
                                            vmGoalAction.isGoalFitFilterMaster(vmGoalAction.goalOptions.GoalType, theGoal.Id, theGoal.ParentId, vmGoalAction.GoalMaster.FirstId, vmGoalAction.GoalMaster.LastId))
                                            isResetByResults = true;

                                        if (isReset) {
                                            msFilter.controlService.reLoadData();
                                        }
                                        else {
                                            var isConnection = false, isSubConnection = false;
                                            var areaId = vmGoalAction.goalOptions.IndependencyId || vmGoalAction.goalOptions.SubMarketProductId;

                                            var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);// actionPlanComponents[areaId];
                                            if (areaCpn && areaCpn.item) {
                                                isConnection = areaCpn.item.IsConnection;
                                                isSubConnection = areaCpn.item.IsSubConnection;
                                            }

                                            if ((isConnection || isSubConnection) && (isChangeConection || theGoal.subProductGroups.length > 0)) {
                                                msFilter.controlService.reLoadData();
                                            } else {
                                                if (!theGoal.ParentId) {
                                                    var pid = vmGoalAction.goalOptions.SubMarketProductId || vmGoalAction.goalOptions.IndependencyId;
                                                    vmGoalAction.goalFilterService.updateItemFilter(pid, { Id: theGoal.Id, Name: theGoal.Name });
                                                };

                                                MsaApp.updateDataProductOrTheme_Expand_InView_Observer();   // isReset false, !isConnection, !isSubConnection, ...
                                                
                                            }
                                        }

                                        if (isMasterArea) {
                                            setTimeout(function () {
                                                msFilter.controlService.reLoadDataFilter();
                                            }, 200);
                                        }

                                        if (typeof MsaApp == 'object') {
                                            if (vmGoalAction.goalOptions.GoalType != vmCommon.GoalType.MainGoal) {
                                                MsaApp.pushExpand(theGoal.Id, 'subgoal');
                                            }
                                            else {
                                                MsaApp.pushExpand(theGoal.Id, 'maingoal');
                                            }

                                            const goalId = theGoal.Id;
                                            MsaApp.setLastActiveElement(goalId);
                                            MsaApp.pushLoadTimeActions('vmEditGoalDataserviceUpdateGoal');

                                        }
                                    }

                                    if (typeof MsaApp == 'object') {
                                        MsaApp.reloadAllDataOfPage('MsPopEditGoal_updateGoal').then(vals => {
                                            MsaApp.updateNavigationMenu(theGoal);
                                        });
                                    }
                                }
                                else if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                                    teamBoardVM.reloadBoardLineAfterUpdateElement({
                                        Name: theGoal.Name,
                                        Id: theGoal.Id,
                                        NewColor: theGoal.MColor
                                    },
                                        vmGoalAction.goalOptions.goalActionNavigationCallback);

                                }
                                else if (vmCommon.checkCurrentPage(vmCommon.enumPage.RoadMap)) {
                                    if (vmGoalAction.goalOptions.goalActionNavigationCallback) vmGoalAction.goalOptions.goalActionNavigationCallback();
                                    msRoadmapApp.reloadData();
                                }
                                if (vmGoalAction.popEditMainGoal)
                                    if (vmCommon.TexEditor.getSelectorEditor() == undefined) {
                                        vmGoalAction.popEditMainGoal.close();
                                    }
                            } else {
                                vmEditGoal.modelChanged = false;

                            }
                        }); 
                    } else { //Add new Goal
                        if (vmGoalAction.goalOptions.GoalType === vmCommon.GoalType.SubGoal) {
                            theGoal.ParentId = vmGoalAction.goalOptions.ParentId;
                        }
                        
                        var indexStatus = theGoal.Status.length;
                        while (indexStatus--) {
                            theGoal.Status[indexStatus].Date = getCurrentHourOfDate(theGoal.Status[indexStatus].Date);
                        }

                        if (theGoal.ApSwotanalyseTemplateId == -1) theGoal.ApSwotanalyseTemplateId = null;

                        delete theGoal.SubClientGroups;
                        delete theGoal.SubProductGroups;

                        theGoal.subProductGroups = vmGoalAction.subService.dataToSave();
                        theGoal.subClientGroups = vmGoalAction.subService.dataClientToSave();
                        theGoal.SubProducts = subproducts;                        
                        theGoal.SubMarketProductId = theGoal.SubMarketProductId || vmGoalAction.goalOptions.SubMarketProductId || vmCommon.emptyGuid;
                        theGoal.submarketProductId = theGoal.SubMarketProductId;
                        theGoal.IndependencyId = vmGoalAction.goalOptions.IndependencyId;
                        theGoal.independencyId = theGoal.IndependencyId
                        theGoal.ActionPlanRegions = actionRegions;

                        if (!theGoal.CreatedDate || typeof theGoal.CreatedDate === "string") {
                            theGoal.CreatedDate = new Date();
                        };

                        var dataEntry = {
                            Goal: theGoal,
                            GoalType: vmGoalAction.goalOptions.GoalType,
                            BoardColumnId: vmGoalAction.goalOptions.BoardColumnId,
                            PathParentId: vmGoalAction.goalOptions.PathParentId,
                            PathParentMdf: vmGoalAction.goalOptions.PathParentMdf,
                            HasSelectTemplate: vmEditGoal.viewModel.hasSelectTemplate
                        };

                        if (this.templateId) dataEntry.TemplateId = this.templateId.Id;
                        vmEditGoal.dataservice.createGoal(dataEntry, function (serData) {
                            if (!vmGoalAction.checkRole(serData))
                                return;
                            
                            if (vmCommon.checkConflict(serData.value.ResultStatus)) {
                                vmEditGoal.modelChanged = false;
                                if(!serData.value.TheObject) {
                                    if(Array.isArray(vmCommon.RefLstGa)){                                        
                                        let cGoal = vmCommon.deepCopy(theGoal);
                                        cGoal.Name = theGoal.Name;
                                        MsaApp.pushLoadTimeActions('vmEditGoalDataserviceCreateGoal');
                                        if(vmCommon.RefAddTypeStr == 'addMaingoalByNav') {
                                            cGoal = sHandler.getNewMain(cGoal);
                                            MsaApp.setLastActiveElement(cGoal.Id);
                                        } else if(vmCommon.RefAddTypeStr == 'addSubgoalByNav') {
                                            const mg = sHandler.getNewMain(cGoal, true);
                                            const sg = sHandler.getNewSub(cGoal);
                                            sg.ParentId = mg.Id;
                                            MsaApp.setLastActiveElement(sg.Id);
                                            mg.ListSubGoal.push(sg);
                                            cGoal = mg;
                                        }
                                        else {
                                            cGoal = sHandler.getNewSub(cGoal);
                                            MsaApp.setLastActiveElement(cGoal.Id);
                                        }
                                        if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan)){
                                            if (vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.SubGoal){
                                                MsaApp.pushExpand(cGoal.Id, 'subgoal');
                                            } else {
                                                MsaApp.pushExpand(cGoal.Id, 'maingoal');
                                            }
                                        }
                                        vmCommon.RefLstGa.push(cGoal);
                                        delete vmCommon.RefAddTypeStr;
                                        delete vmCommon.RefLstGa;
                                       if (vmGoalAction.popEditMainGoal) {
                                            vmGoalAction.popEditMainGoal.close();
                                        }
                                    }
                                    return;
                                }
                                var goalId = serData.value.TheObject.GoalId;        // new subgoal || maingoal
                                if (vmCommon.checkCurrentPage(vmCommon.enumPage.TeamBoard)) {
                                    var newGoal = serData.value.TheObject || {};
                                    teamBoardVM && (teamBoardVM.reLoadBoardLineCreateNewElement(newGoal.GoalId));

                                } else {// action plan
                                    var areaId = vmGoalAction.goalOptions.IndependencyId || vmGoalAction.goalOptions.SubMarketProductId;
                                    var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);// actionPlanComponents[areaId];

                                    var mgoalId = serData.value.TheObject.MainGoalId;   // maingoal
                                    if (typeof MsaApp == 'object' && MsaApp) {
                                        if (mgoalId != null && mgoalId != vmCommon.emptyGuid) {
                                            MsaApp.pushExpand(mgoalId, 'maingoal', 'nochange');
                                            MsaApp.pushExpand(goalId, 'subgoal');
                                        } else if (mgoalId == null || mgoalId == vmCommon.emptyGuid) {
                                            if (vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.SubGoal)
                                                MsaApp.pushExpand(goalId, 'subgoal');
                                            else {
                                                // tao moi detached subgoal
                                                MsaApp.pushExpand(goalId, 'maingoal');
                                            }
                                        }
                                        
                                        //todo: expand area
                                        MsaApp.pushExpand(areaId, vmGoalAction.goalOptions.IndependencyId ? "Theme" : "Product");
                                        if (areaCpn && areaCpn.IsExpand == false) areaCpn.onClickToggleShow();

                                        MsaApp.setLastActiveElement(goalId);
                                        MsaApp.pushLoadTimeActions('vmEditGoalDataserviceCreateGoal');
                                    }

                                    // Update Evaluation title XYZ
                                    if (typeof vmCommon.vmApEvalxDataServiceSaveTitleLang == 'function') {
                                        vmCommon.vmApEvalxDataServiceSaveTitleLang(goalId);
                                        delete vmCommon.vmApEvalxDataServiceSaveTitleLang;
                                    }

                                    //Check if fit with current filter
                                    var statusObj = serData.value.TheObject.StatusObj;
                                    
                                    var isResetByResults = vmGoalAction.hasResultsFilter(theGoal.Id, theGoal.ParentId, vmGoalAction.goalOptions.SubMarketProductId, vmGoalAction.goalOptions.IndependencyId);
                                    var isReset = isResetByResults && vmEditGoal.checkFitFilter(theGoal, statusObj);

                                    if (vmGoalAction.isGoalFitFilterMaster(vmGoalAction.goalOptions.GoalType, theGoal.Id, theGoal.ParentId, vmGoalAction.GoalMaster.FirstId, vmGoalAction.GoalMaster.LastId))
                                        isResetByResults = true;

                                    if (vmGoalAction.isGoalFitVisibility(theGoal)) {
                                        isReset = true;
                                    }

                                    if (isReset) {
                                        msFilter.controlService.reLoadData();
                                    }
                                    else {
                                        var isConnection = false, isSubConnection = false;
                                        if (areaCpn && areaCpn.item) {
                                            isConnection = areaCpn.item.IsConnection;
                                            isSubConnection = areaCpn.item.IsSubConnection;
                                        }

                                        if ((isConnection || isSubConnection) && (isChangeConection || theGoal.subProductGroups.length > 0)) {
                                            msFilter.controlService.reLoadData();
                                        }
                                    }

                                    if (isMasterArea) {
                                        setTimeout(function () {
                                            msFilter.controlService.reLoadDataFilter();
                                        }, 200);
                                    }

                                    if (typeof MsaApp == 'object' && MsaApp) {
                                        MsaApp.reloadAllDataOfPage('MsPopEditGoal_addNewGoal').then((vals) => {
                                            MsaApp.updateNavigationMenu(theGoal);
                                        });
                                    }
                                }
                                
                                if (vmGoalAction.popEditMainGoal) {
                                    if (vmCommon.TexEditor.getSelectorEditor() == undefined) {
                                        vmGoalAction.popEditMainGoal.close();
                                    }
                                }
                            } else {
                                vmEditGoal.modelChanged = false;
                            }
                        });
                    }
                }
            },
            clickEdit: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;

            },
            togglePlaceholderKendoEditor: function (e) {

                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).checkData();

            },

            onKeyUpChangeValKendoEditor: function (e) {
                var newValue = vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).checkValue();

                if (newValue) {
                    var $textArea = e.sender.textarea;
                    var idElement = $textArea.attr("id");
                    var curGoal = vmEditGoal.viewModel.get("goal");

                    if (idElement == 'txtDescriptionMainSub') {

                        vmEditGoal.modelChanged = newValue != vmCommon.TexEditor.stripHtml(curGoal.Description);

                    } else if (idElement == 'txtPurpose') {

                        vmEditGoal.modelChanged = newValue != vmCommon.TexEditor.stripHtml(curGoal.Purpose);

                    } else if (idElement == 'txtEffect') {

                        vmEditGoal.modelChanged = newValue != vmCommon.TexEditor.stripHtml(curGoal.Effect);

                    } else if (idElement == 'txtArrived') {

                        vmEditGoal.modelChanged = newValue != vmCommon.TexEditor.stripHtml(curGoal.Arrived);

                    }
                };
            },
            onKeyDownChangeValKendoEditor: function (e) {

                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).preCheckValue();
            },
            onPasteValKendoEditor: function (e) { // e.html
                vmCommon.TexEditor.Placeholder.getHtmlFrom(e.sender).preCheckValue();
            },
            confirmAll: function (e) {
                if (!e.data.goal.Id) return;
                var isFinish = (e.target.id === "cbFinish") ? true : false, isChecked = e.target.checked;
                ynConfirm(isFinish ? (isChecked ? kLg.msgFinishAll : kLg.msgUnFinishAll) : (isChecked ? kLg.msgVisibleAll : kLg.msgInvisibleAll)).then(function () {

                    if (isFinish) {
                        vmEditGoal.viewModel.goal.set("IsFinishAll", true);
                    } else {
                        vmEditGoal.viewModel.goal.set("IsVisibilityAll", true);
                    }

                    if (isChecked) {
                        var fall = $("td[parentid~='" + e.data.goal.Id + "']").find("div[itemstillopen]");
                        for (var h = 0; h < fall.length; h++) {
                            $(fall[h]).removeAttr("itemstillopen");
                        }
                    } else {
                        var oall = $("td[parentid~='" + e.data.goal.Id + "']").find("div[itemfinished]");
                        for (var h = 0; h < oall.length; h++) {
                            $(oall[h]).removeAttr("itemfinished");
                        }
                    }

                }, function () {
                    if (isFinish) {
                        vmEditGoal.viewModel.goal.set("IsFinishAll", false);
                    } else {
                        vmEditGoal.viewModel.goal.set("IsVisibilityAll", false);
                    }
                });

                //e.preventDefault();
            },
            confirmIsCalendar: function (e) {
                if (!e.data.goal.Id) return;
                ynConfirm(kLg.msgIsCalendarAll).then(function () {
                    vmEditGoal.viewModel.goal.set("IsCalendarAll", true);
                }, function () {
                    vmEditGoal.viewModel.goal.set("IsCalendarAll", false);
                });

            },
            addLink: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;

                var that = this;

                var callback = function () {
                    var otherLinks = that.goal.Links;

                    vmGoalAction.linkOptions = {};
                    vmGoalAction.linkOptions.IsEdit = false;

                    var newLink = new ActionPlanLink();
                    newLink.MIndex = vmCommon.getMaxMIndex(otherLinks) + 1;

                    vmGoalAction.linkOptions.Link = newLink;
                    vmGoalAction.linkOptions.goalActionModel = that.goal;

                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, newLink);

                    vmGoalAction.openPopEditLink();
                };

                var goalType = vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.MainGoal ? vmCommon.GoalActionContentType.MainGoal : vmCommon.GoalActionContentType.SubGoal;
                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.goal.Id, GoalActionTypeId: goalType }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            addLinkBeLow: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;

                var index = this.goal.Links.indexOf(e.data);
                var that = this;

                var callback = function () {
                    vmGoalAction.linkOptions = {};
                    vmGoalAction.linkOptions.afterIndex = index;

                    vmGoalAction.linkOptions.IsEdit = false;

                    var newLink = new ActionPlanLink();
                    newLink.MIndex = e.data.MIndex + 1;

                    vmGoalAction.linkOptions.Link = newLink;
                    vmGoalAction.linkOptions.goalActionModel = that.goal;

                    var otherLinks = that.goal.Links;
                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, newLink);

                    vmGoalAction.openPopEditLink();
                };

                var goalType = vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.MainGoal ? vmCommon.GoalActionContentType.MainGoal : vmCommon.GoalActionContentType.SubGoal;
                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.goal.Id, GoalActionTypeId: goalType }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            editLink: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;

                var that = this;
                var link = e.data;

                var callback = function () {
                    vmGoalAction.linkOptions = {};
                    vmGoalAction.linkOptions.IsEdit = true;

                    vmGoalAction.linkOptions.Link = link;
                    vmGoalAction.linkOptions.goalActionModel = that.goal;

                    var otherLinks = that.goal.Links.filter(t => t != link);
                    vmGoalAction.linkOptions.MenuLinkData = vmGoalAction.mergeMenuLink(menuLinkCache, otherLinks, link);

                    vmGoalAction.openPopEditLink();
                };

                var goalType = vmGoalAction.goalOptions.GoalType == vmCommon.GoalType.MainGoal ? vmCommon.GoalActionContentType.MainGoal : vmCommon.GoalActionContentType.SubGoal;
                if (menuLinkCache) {
                    callback();
                } else {
                    vmGoalAction.dataservice.getMenuLink({ GoalActionId: this.goal.Id, GoalActionTypeId: goalType }, function (res) {
                        menuLinkCache = res.value;
                        callback();
                    });
                }
            },
            deleteLink: function (e) {
                if (vmGoalAction.goalOptions.role < vmCommon.MemberRole.Edit)
                    return;

                var link = e.data;
                var that = this;
                pConfirm(kLg.confirmDeleteLink).then(
                    function () {
                        if (link.Id > 0) {
                            link.set("IsShow", false);
                            link.set("DataState", dataState.Deleted);
                        } else {
                            that.goal.Links.splice($(e.currentTarget.closest("tr")).index(), 1);
                        }

                        that.set("hasLink", that.goal.Visibility || that.goal.Links.some(t => t.IsShow));
                    }
                );
            },
            onChangeVisibility: function () {
                if (!this.goal.Visibility) {
                    var links = this.goal.Links;
                    for (var i = links.length - 1; i >= 0; i--) {
                        var link = links[i];
                        if (link.IsMasterLink) continue;

                        if (link.Id > 0) {
                            link.set("IsShow", false);
                            link.set("DataState", dataState.Deleted);
                        } else {
                            links.splice(i, 1);
                        }
                    }
                }

                this.set("hasLink", this.goal.Visibility || this.goal.Links.some(t => t.IsShow));
            },
            openGoalAction: function (e) {
                if (e.data.RoleId >= 0 && e.data.Url && e.data.IsActive) {
                    //var url = '/Pages/MsGoalAction.aspx?lang=' + kLg.language + '&projid=' + projectId + '&strid=' + strategyId + '&fromdash=true' + e.data.Url;
                    var url = "../Handlers/MsGoalAction.ashx?funcName=getMixShortDetail" + "&projid=" + projectId + "&strid=" + strategyId;
                    callAjaxPostGet('divloading', url, null, { id: e.data.LinkId, type: e.data.LinkTypeId }, function (serData) {
                        if (serData.value.Role < 0) {
                            window.location = "/Default.aspx?lang=" + kLg.language;
                            return;
                        }

                        var data = serData.value.Data;
                        if (data) {
                            url = '/Pages/MsGoalAction.aspx?lang=' + kLg.language + '&projid=' + projectId + '&strid=' + strategyId + '&actpopup=' + data.ActpopupEncode;
                            url += '&fromactionplanconnect=1';

                            window.open(url, "_blank");
                        }
                    });

                }
            }
        });

        vmEditGoal.viewModel.bind("change", function () {
            vmEditGoal.modelChanged = true;
            $('form#fEditGoal #btnUpdate').prop('disabled', false);
        });
        vmEditGoal.activeModelChange = function () {
            vmEditGoal.modelChanged = true;
            $('form#fEditGoal #btnUpdate').prop('disabled', false);
        };

        if (msCurrency) {
            var format = msCurrency.encodeDola();
            $("#area-edit-goal input[data-role=numerictextbox]").attr('data-format', format + ' ##,#.00');
        }

        $("#area-edit-goal input[data-role=datepicker]").attr('data-format', kendo.culture().calendars.standard.patterns.d);

        kendo.bind($("#area-edit-goal"), vmEditGoal.viewModel);

        vmGoalAction.subService.init(vmEditGoal.viewModel, subProductGroups, subClientGroups);

        //vmGoalAction.autoSubHeight();
        //vmEditGoal.modelChanged = false;
        //vmEditGoal.AdjustPopupHeight();

        vmEditGoal.checkFitFilter = function (theGoal, theStatus) {
            var isReset = false,
                lstStatusIds = [],
                allStatusIds = [],
                goalVisibility = theGoal.Visibility ? mFilter.enumFilterVisibility.Show : mFilter.enumFilterVisibility.Hide,
                lstPeopleIds = [],
                lstCatGoalIds = [],
                lstFieldGoalIds = [];

            var isConnection = false, isSubConnection = false;
            var areaId = theGoal.IndependencyId || theGoal.SubMarketProductId;

            var areaCpn = MsaApp.componentService(MsaApp.IsShowNavigationMenu).get(areaId);//actionPlanComponents[areaId];
            if (areaCpn && areaCpn.item) {
                isConnection = areaCpn.item.IsConnection;
                isSubConnection = areaCpn.item.IsSubConnection;
            }


            //if (theGoal.Visibility)
            //    goalVisibility = mFilter.enumFilterVisibility.Show;
            //else
            //    goalVisibility = mFilter.enumFilterVisibility.Hide;

            if (!msFilter.controlService.checkFitFilter([goalVisibility], mFilter.enumFilter.visibility)) {
                isReset = true;
            }

            if (typeof (theStatus) !== "undefined" && theStatus != null && theStatus.length > 0) {
                allStatusIds = theStatus.map(t => t.StatusId);
                lstStatusIds = [allStatusIds[0]];
            }

            if (!msFilter.controlService.checkFitFilter(lstStatusIds, mFilter.enumFilter.lastStatus)) {
                isReset = true;
            }
            if (!msFilter.controlService.checkFitFilter(allStatusIds, mFilter.enumFilter.protocolStatus)) {
                isReset = true;
            }

            if (theGoal.People && theGoal.People.length > 0) {
                lstPeopleIds = theGoal.People.filter(t => t.AccountId > 0).map(t => t.AccountId);
            }

            if (theGoal.Categories && theGoal.Categories.length > 0) {
                lstCatGoalIds = theGoal.Categories.filter(t => t.Id > 0).map(t => t.Id);
            }

            if (theGoal.Fields && theGoal.Fields.length > 0) {
                lstFieldGoalIds = theGoal.Fields.filter(t => t.Id > 0).map(t => t.Id);
            }

            if (!vmEditGoal.checkFitTask(theGoal))
                isReset = true;

            if (!msFilter.controlService.checkFitFilter(lstCatGoalIds, mFilter.enumFilter.goalCategory)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitFilter(lstFieldGoalIds, mFilter.enumFilter.field)) {
                isReset = true;
            }
            if (!msFilter.controlService.checkFitFilter(lstPeopleIds, mFilter.enumFilter.person)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitFilter([mFilter.enumFilterType.OnlyGoal], mFilter.enumFilter.type)) {
                isReset = true;
            }

            if (!msFilter.controlService.checkFitFilter([theGoal.MasterId], mFilter.enumFilter.masterGoal))
                isReset = true;

            var goalIndexIds = [];
            if (theGoal.KpiGoalData && theGoal.KpiGoalData.KpiGoalTopics) {
                var topics = theGoal.KpiGoalData.KpiGoalTopics.filter(t => t.TypeId == vmCommon.KpiGoalTopicType.Goal);
                topics.forEach(t => {
                    var indexes = t.KpiGoalIndexes || [];
                    indexes.forEach(i => {
                        goalIndexIds.pushx(i.GuidLinkId);
                    });
                });
            }

            if (!msFilter.controlService.checkFitFilter([], mFilter.enumFilter.masterGoalKpi))
                isReset = true;

            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.actionCategory)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.actionCategory);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.instrument)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.instrument);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.fibuKostenstellen)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.fibuKostenstellen);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.customerJourney)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.customerJourney);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.advertisingMaterial)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.advertisingMaterial);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.advertiser)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.advertiser);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.subjetThema)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.subjetThema);
                isReset = true;
            }
            if (msFilter.controlService.hasCriteria(mFilter.enumFilter.supplier)) {
                msFilter.controlService.removeItemFilter(mFilter.enumFilter.supplier);
                isReset = true;
            }

            if (!msFilter.controlService.checkFitTimeRange(theGoal.StartDate, theGoal.Date))
                isReset = true;

            var searchValues = [
                theGoal.Name,
                theGoal.Description || "",
                theGoal.Purpose || "",
                theGoal.Effect || "",
                theGoal.Arrived || "",
                theGoal.Budget + "",
                theGoal.ExpectedCost + "",
                theGoal.ActualCost + ""
            ];

            theGoal.Status.forEach(t => {
                searchValues.push(t.Description);
            });

            if (!msFilter.controlService.checkFitTextSearch(searchValues))
                isReset = true;

            //var isConnect = $("a[ms-role=child]#" + (theGoal.SubMarketProductId || theGoal.IndependencyId)).hasClass("item-connection");

            //var isNotCheckProduct = vmGoalAction.isBelongRegionView($("#" + theGoal.Id)) || !msFilter.controlService.hasCriteria(mFilter.enumFilter.productGroup);
            if (isConnection && !msFilter.controlService.checkFitFilter(theGoal.displaySubs, mFilter.enumFilter.productGroup))
                isReset = true;

            //var isNotCheckMarket = vmGoalAction.isBelongRegionView($("#" + theGoal.Id)) || !msFilter.controlService.hasCriteria(mFilter.enumFilter.market);
            if (isConnection && !msFilter.controlService.checkFitFilter(theGoal.displayClients, mFilter.enumFilter.market))
                isReset = true;

            //}
            ////--!> change logic
            //if (vmFilter.IsExistTypeInDFilter(vmFilter.enumFilter.productGroup)
            //    && vmGoalAction.checkFitSubProductSubClientV3(theGoal, vmFilter.enumFilter.productGroup, vmGoalAction.goalOptions)) {
            //    isReset = true;
            //}

            //if (vmFilter.IsExistTypeInDFilter(vmFilter.enumFilter.market)
            //    && vmGoalAction.checkFitSubProductSubClientV3(theGoal, vmFilter.enumFilter.market, vmGoalAction.goalOptions)) {
            //    isReset = true;
            //}

            //if (vmFilter.IsExistTypeInDFilter(vmFilter.enumFilter.marketScope)
            //    && vmGoalAction.checkFitSubProductSubClientV3(theGoal, vmFilter.enumFilter.marketScope, vmGoalAction.goalOptions)) {
            //    isReset = true;
            //}
            ////<!--
            //if (vmFilter.filterContainer.Dates != null && vmFilter.filterContainer.Dates.length > 0 && vmEditGoal.checkTodo(theGoal)) {
            //    isReset = true;
            //}

            //if (vmFilter.filterContainer.MasterGoalsKpi != null && vmFilter.filterContainer.MasterGoalsKpi.length > 0 && vmEditGoal.checkKpi(theGoal)) {
            //    isReset = true;
            //}

            return isReset;
        };

        vmEditGoal.checkFitTask = function (theGoal) {
            var endDate = theGoal.Date;
            var itemFilters = msFilter.controlService.getItemFilters(mFilter.enumFilter.date).filter(t => t.ParentValue > 0);
            if (itemFilters.length == 0) return true;

            var endDateTemp = vmCommon.deepCopy(endDate);
            if (endDateTemp != null && typeof endDateTemp == "string") endDateTemp = endDateTemp.toDate();

            var notFitTypes = [];

            //AlreadyFnished
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.AlreadyFnished)) //&& !theGoal.Finish
                notFitTypes.push(mFilter.enumDate.AlreadyFnished);

            //StillOpen
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.StillOpen)) //&& theGoal.Finish
                notFitTypes.push(mFilter.enumDate.StillOpen);

            ////Overdue
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.Overdue)) {
                var today = new Date();

                if (endDateTemp == null || vmCommon.compareDate2(endDateTemp, today) >= 0) notFitTypes.push(mFilter.enumDate.Overdue);
            }

            //DueToday
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.DueToday)) {
                var today = new Date();

                if (endDateTemp == null || vmCommon.compareDate2(endDateTemp, today) != 0) notFitTypes.push(mFilter.enumDate.DueToday);
            }

            //NextTenDays
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.NextTenDays)) {
                var nextTenDay = new Date(); nextTenDay.addDays(10);
                var today = new Date();

                if (vmCommon.compareDate2(endDateTemp, today) <= 0 || vmCommon.compareDate2(endDateTemp, nextTenDay) > 0) notFitTypes.push(mFilter.enumDate.NextTenDays);
            }

            //OverTenDays
            if (itemFilters.some(t => t.ParentValue == mFilter.enumDate.OverTenDays)) {
                var nextTenDay = new Date(); nextTenDay.addDays(10);

                if (vmCommon.compareDate2(endDateTemp, nextTenDay) <= 0) notFitTypes.push(mFilter.enumDate.OverTenDays);
            }

            msFilter.controlService.removeItemFilterByParent(mFilter.enumFilter.date, notFitTypes);

            return notFitTypes.length == 0;
        };

        vmEditGoal.checkKpi = function (goal) {
            return true;

        };

        vmEditGoal.checkTodo = function (goal) {
            return true;

        };

        vmEditGoal.checkFitTextSearch = function (goal) {
            return true;

        };

        vmEditGoal.checkGoalTimeRange = function (goal) {
            return true;

        };

        vmEditGoal.checkGoalResetByMasterGoal = function (g) {
            return true;

            //TODO: recode late

            //var tempRs = [];
            //vmFilter.buildMasterFilter(tempRs);
            //var flag = $.grep(tempRs, function (it) { return it.Id === g.MasterId; }).length === 0;


            //if (!flag) {
            //    var temp = $.grep(vmFilter.DFilter, function (it) { return it.TypeValue === vmFilter.enumFilter.masterGoal; });
            //    for (var i = 0; i < temp.length; i++) {
            //        vmGoalAction.fitCriterias.push(temp[i]);
            //    }
            //}

            //return flag;
        };

        //Setup language
        vmEditGoal.setupLanguage();
        //Bind close event to popup
        vmEditGoal.bindPopUpEvent();

        vmGoalAction.setupValidate();

        vmGoalAction.focusFirstInput('#area-edit-goal');

        $('#tableEditGoal input[data-role=datepicker]').preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
        $('#tableEditGoal input[data-role=datepicker]').kendoDatePicker({
            weekNumber: true
        });

        $('#tableEditGoal').on("blur change", 'input[data-role=datepicker]', function (e) {
            if ($(this).val().length === 0) {
                $(this).tooltip('destroy');
                return true;
            }
            var dt = $(this).data("kendoDatePicker").value();
            if (dt == null) {
                $(this).attr("title", kLg.msgDateInValid);
                $(this).tooltip({ trigger: "manual" }).tooltip('show').attr("title", "");
                return false;
            }
            $(this).tooltip('destroy');
            return true;
        });

        $("input[focusevent='cost-focus']").bind("focus", function () {
            var evtFocus = $(this);
            try {
                var costNumber = parseInt(evtFocus.val());
                if (costNumber === 0) evtFocus.val(null);
            } catch (e) {
                evtFocus.val(null);
            }
        });

        vmFile.vmObject = vmEditGoal;

        if (vmEditGoal.checkReminderReady(vmEditGoal.theGoal)) {
            vmEditGoal.showHideGoalReminder('block');
        } else {
            vmEditGoal.showHideGoalReminder('none');
        }
        $('#txtName').on('change paste', function () {
            if (vmEditGoal) vmEditGoal.viewModel.goal.Name = $(this).val();
            vmEditGoal.activeModelChange();
        });

        vmEditGoal.resetTabIndex();

        $("#picker").kendoColorPicker({
            buttons: false,
            columns: 9,
            tileSize: 25,
            palette: colorPaletteAction,
            open: function (e) {
                $("#picker").data("kendoColorPicker").isClosed = false;
            },
            close: function (e) {
                $("#picker").data("kendoColorPicker").isClosed = true;
            },
            change: function (e) {
                vmEditGoal.modelChanged = true;
            }
        });

        void function processHandleEventUI() {
            $('#popEditMainGoal .modal-body.ms-modal-body').on('scroll', function (evnt) {
                if ($("#picker").data("kendoColorPicker").isClosed == false) {
                    $("#picker").data("kendoColorPicker").close();
                };
                $(document.body).find("[data-role=popup]").each(function () {
                    var popup = $(this).data("kendoPopup");
                    popup.close();
                });
            });
        }();
        void function setupPlaceholderForTextEditorAndStatus() {
            var lblDesPlace = kLg.labelDesPlace,
                lblEffectPlace = kLg.labelEffectPlace,
                labelDes = kLg.PMlabelDes || kLg.labelDes,
                labelPurpose = kLg.PMlabelPurpose || kLg.labelPurpose;

            if (language === 'pm') {
                labelDes = labelDes.replace(new RegExp('Projektes', "g"), 'Teilprojektes');
                labelPurpose = labelPurpose.replace(new RegExp('Projektes', "g"), 'Teilprojektes');
                lblDesPlace = lblDesPlace.replace(new RegExp('Projekt', "g"), 'Teilprojekt');
                lblEffectPlace = lblEffectPlace.replace(new RegExp('Teilprojekte und Aufgaben', "g"), 'Aufgaben');
            };

            vmCommon.TexEditor.Placeholder.setAttr($('#txtDescriptionMainSub'), lblDesPlace).setInnerHTML()(vmEditGoal.viewModel.roleEdit);
            vmCommon.TexEditor.Placeholder.setAttr($('#txtPurpose'), kLg.labelPurposePlace).setInnerHTML()(vmEditGoal.viewModel.roleEdit);
            vmCommon.TexEditor.Placeholder.setAttr($('#txtEffect'), lblEffectPlace).setInnerHTML()(vmEditGoal.viewModel.roleEdit);
            vmCommon.TexEditor.Placeholder.setAttr($('#txtArrived'), kLg.labelArrivedPlace).setInnerHTML()(vmEditGoal.viewModel.roleEdit);
            $('.dnbStatusKendoEditor').each(function () {
                vmCommon.TexEditor.Placeholder.setAttr($(this), vmCommon.TexEditor.Type.Status
                ).setInnerHTML()(vmEditGoal.viewModel.roleEdit)
            });

            //fix bug 20986
            var purpose = vmEditGoal.theGoal.Purpose || '';
            if (purpose.indexOf('<img') == 0) {
                $('#txtPurpose').data('kendoEditor').value(purpose);
            }

            var effect = vmEditGoal.theGoal.Effect || '';
            if (effect.indexOf('<img') == 0) {
                $('#txtEffect').data('kendoEditor').value(effect);
            }

            var arrived = vmEditGoal.theGoal.Arrived || '';
            if (arrived.indexOf('<img') == 0) {
                $('#txtArrived').data('kendoEditor').value(arrived);
            }

            var des = vmEditGoal.theGoal.Description || '';
            if (des.indexOf('<img') == 0) {
                $('#txtDescriptionMainSub').data('kendoEditor').value(des);
            }
            //

        }();
        if (vmCommon.checkCurrentPage(vmCommon.enumPage.Dashboard)) {
            vmDashboard.AddressBar.ClientQuery.updateAddressBar();
        } else if (typeof vmGoalAction === 'object') {
            vmCommon.AddressBar.ClientQuery.updateAddressBar();
        }

        vmGoalAction.autoSubHeight();
        vmEditGoal.modelChanged = false;
        vmEditGoal.AdjustPopupHeight();
    });

    function createKpiReportIcon(goalId) {
        if (goalId == undefined || goalId == vmCommon.emptyGuid) return;

        var s = "margin-left: 4px; margin-top: 4px;";
        //$("#popEditMainGoal_wnd_title").next().prepend('<a role="button" href="javascript:exportKpiReport(\'' + goalId + '\');" class="pull-left rpkpi" style="' + s + '"><span role="presentation" class="icon-16 icon-kpigoalreport"></span></a>');
    }

    function createEvaluationIcon(goalId) {
        var s = "margin-left: -20px; margin-top: 4px; line-height:4px;";
        //$("#popEditMainGoal_wnd_title").next().prepend('<a role="button" href="javascript:vmGoalAction.showPopupGoalActionEval(1);" class="pull-left rpkpi" style="' + s + '"><span role="presentation" class="font-focus"></span></a>');
    }

    function exportKpiReport(goalId) {
        goalId = vmEditGoal.theGoal.Id;
        var entry = { ProjectId: projectId, Id: goalId, Currency: msCurrency, Lang: language };
        vmEditGoal.dataservice.exportKpiReport(entry, function (res) {
            var data = res.value;
            if (!data) return;
            switch (data.ResultStatus) {
                case vmCommon.ResultState.CONFLICT:
                    pAlert("Error");
                    break;
                case vmCommon.ResultState.SUCCESS:

                    var aTag = document.createElement('a');
                    aTag.href = data.TheObject.Link;
                    aTag.download = data.TheObject.Name;
                    document.body.appendChild(aTag);
                    aTag.click();
                    setTimeout(function () {
                        aTag.remove();
                    }, 2000);
                    break;
            }
        });
    }

    function isValidStatus() {
        var status = vmEditGoal.viewModel.goal.Status;

        var listStatus = $('#tableEditGoal input[data-role=datepicker]:visible'),
            len,
            i;
        for (i = 0, len = listStatus.length; i < len; i++) {
            if ($(listStatus[i]).val() === "") continue;
            if ($(listStatus[i]).data("kendoDatePicker").value() == null) {
                if ($(listStatus[i]).val() === "") {
                    return true;
                }
                $(listStatus[i]).focus();
                return false;
            } else {
                status[i].Date = $(listStatus[i]).data("kendoDatePicker").value();
            }
        }
        return true;
    }

    //manhlv
    function compareDate(sdate, edate) {
        try {
            if (sdate.getYear() < edate.getYear()) return true;
            if (sdate.getYear() > edate.getYear()) return false;
            if (sdate.getMonth() < edate.getMonth()) return true;
            if (sdate.getMonth() > edate.getMonth()) return false;
            if (sdate.getDate() < edate.getDate()) return true;
            if (sdate.getDate() > edate.getDate()) return false;
        } catch (e) {
            console.log(sdate, edate);
            console.log(e);
            return false;
        }

        return true;
    }

    function equalDate(date1, date2) {
        if (date1.getYear() === date2.getYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate()) {
            return true;
        }
        return false;
    }

    function setLabelForDropTemplate(lblTemp) {
        $("#dropTemp").prev().children("span[class=k-input]").text(lblTemp ? lblTemp : kLg.btnSelectTemp);
    }

    vmEditGoal.FindById = function (source, id) {
        return vmCommon.findByFunc(source, function (obj) { return obj.Id === id; });
    };

    function isValidStartDate() {

        var goal = vmEditGoal.viewModel.goal;
        var sdate = $('#txtStartDate').data("kendoDatePicker").value();
        if (sdate == null) {
            $('#txtStartDate').tooltip('destroy');
            $('#txtStartDate').attr("title", kLg.msgDateInValid);
            $('#txtStartDate').tooltip({ trigger: "manual" }).tooltip('show');
            vmEditGoal.valid = false;
            return false;
        } else {
            var edate = $('#txtDate').data("kendoDatePicker").value();
            var edateOld = edate;
            if (edate != null) {
                if (!compareDate(sdate, edate)) {
                    edateOld.setFullYear(sdate.getFullYear());
                    $('#txtDate').data("kendoDatePicker").value(edateOld);
                    goal.Date = $('#txtDate').data("kendoDatePicker").value();
                    if (!compareDate(sdate, edateOld)) {
                        $('#txtDate').tooltip("destroy");
                        $('#txtDate').attr("title", kLg.msgValidateStartEndDate);
                        $('#txtDate').tooltip({ trigger: "manual" }).tooltip('show');
                        vmEditGoal.valid = false;
                        vmEditGoal.showHideGoalReminder('none');
                        return false;
                    } else {
                        $('#txtDate').tooltip('destroy');
                        var d = new Date();
                        if (!compareDate(d, edate) || equalDate(d, edate)) {
                            vmEditGoal.showHideGoalReminder('none');
                        } else {
                            vmEditGoal.showHideGoalReminder('block');
                        }
                    }

                } else {
                    $('#txtDate').tooltip('destroy');
                    var dn = new Date();
                    if (!compareDate(dn, edate) || equalDate(dn, edate)) {
                        vmEditGoal.showHideGoalReminder('none');
                    } else {
                        vmEditGoal.showHideGoalReminder('block');
                    }
                }
            }
        }
        $('#txtStartDate').tooltip('destroy');
        vmEditGoal.valid = true;
        return true;
    }


    var startDateBeforeForConfirm = vmEditGoal.theGoal.StartDate;
    function showMessageConfirmChangeStartDate() {
        var goal = vmEditGoal.viewModel.goal;

        var sdate = $('#txtStartDate').data("kendoDatePicker").value();
        var isChangeStartDateAll = vmEditGoal.viewModel.goal.get("IsChangeStartDateAll");

        if (sdate !== null && isChangeStartDateAll != null
            && (startDateBeforeForConfirm != null && startDateBeforeForConfirm.toDateString() != sdate.toDateString())
        ) {
            ynConfirm(kLg.msgChangeStartDateAll).then(function () {
                vmEditGoal.viewModel.goal.set("IsChangeStartDateAll", true);
            },
                function () {
                    vmEditGoal.viewModel.goal.set("IsChangeStartDateAll", false);
                }
            );

            startDateBeforeForConfirm = goal.StartDate;
        }
    };

    var addDays_reCalculatEndDate = (new moment.duration(moment(vmEditGoal.theGoal.Date).startOf('day')._d - moment(vmEditGoal.theGoal.StartDate).startOf('day')._d)).asDays();
    function reCalculatEndDate() {
        var goal = vmEditGoal.viewModel.goal;
        var sdate = $('#txtStartDate').data("kendoDatePicker").value();

        if (sdate !== null && vmEditGoal.theGoal.StartDate != null) {
            try {
                let addDays = addDays_reCalculatEndDate;
                sdate.addDays(addDays);

                $('#txtDate').data("kendoDatePicker").value(sdate);
                goal.set('Date', sdate);

            } catch (e) {
                console.log(e);
                console.trace();
            }
        }
    };

    function isValidEndDate() {

        var edate = $('#txtDate').data("kendoDatePicker").value();
        var sdate = $('#txtStartDate').data("kendoDatePicker").value();

        if (edate == null && $('#txtDate').val() !== "") {
            $('#txtDate').tooltip('destroy');
            $('#txtDate').attr("title", kLg.msgDateInValid);
            $('#txtDate').tooltip({ trigger: "manual" }).tooltip('show');
            vmEditGoal.showHideGoalReminder('none');
            vmEditGoal.valid = false;
            return false;
        } else {
            if ($('#txtDate').val() !== "" && !compareDate(sdate, edate)) {
                $('#txtDate').tooltip("destroy");
                $('#txtDate').attr("title", kLg.msgValidateStartEndDate);
                $('#txtDate').tooltip({ trigger: "manual" }).tooltip('show');
                vmEditGoal.showHideGoalReminder('none');
                vmEditGoal.valid = false;
                return false;
            } else {
                if ($('#txtDate').val() === "") {
                    vmEditGoal.showHideGoalReminder('none');
                } else {
                    var d = new Date();
                    if (!compareDate(d, edate) || equalDate(d, edate)) {
                        vmEditGoal.showHideGoalReminder('none');
                    } else {
                        vmEditGoal.showHideGoalReminder('block');
                    }
                }

            }
        }

        $('#txtDate').tooltip('destroy');
        vmEditGoal.valid = true;

        if (vmEditGoal.valid) {
            var edate = $('#txtDate').data("kendoDatePicker").value();
            var sdate = $('#txtStartDate').data("kendoDatePicker").value();
            if (edate != null) {
                addDays_reCalculatEndDate = (new moment.duration(moment(edate).startOf('day')._d - moment(sdate).startOf('day')._d)).asDays();
            }
        }

        return true;
    }

    function isValidDate() {
        return isValidEndDate() && isValidStartDate();
    }

    $("#txtDate").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
    $('#txtDate').kendoDatePicker({
        weekNumber: true,
        close: function (e) {
            destroyKpiTooltip();
        }
    });

    $("#txtDate").on("blur", function () {
        var goal = vmEditGoal.viewModel.goal;
        var enddateString = $("#txtDate").val();
        $("#txtDate").val(vmCommon.autoFormatDate(enddateString, kLg.language));

        var enddatePicker = vmCommon.convertDateFormat($("#txtDate").val(), kLg.language);
        if (enddatePicker != null) {
            var year = enddatePicker.getFullYear();
            if (year >= 1900 && year <= 2099) {
                $('#txtDate').data("kendoDatePicker").value(enddatePicker);
                goal.Date = $('#txtDate').data("kendoDatePicker").value();
            }
        }
        isValidEndDate();
    });

    $('#txtDate').on('keypress', function (e) {
        if (e.which === 13) {
            var goal = vmEditGoal.viewModel.goal;

            var enddateString = $("#txtDate").val();
            $("#txtDate").val(vmCommon.autoFormatDate(enddateString, kLg.language));

            var enddatePicker = vmCommon.convertDateFormat($("#txtDate").val(), kLg.language);
            if (enddatePicker != null) {
                var year = enddatePicker.getFullYear();
                if (year >= 1900 && year <= 2099) {
                    $('#txtDate').data("kendoDatePicker").value(enddatePicker);
                    goal.Date = $('#txtDate').data("kendoDatePicker").value();
                }
            }
            isValidEndDate();
        }
    });

    $("#txtStartDate").preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);
    $("#txtStartDate").kendoDatePicker({
        weekNumber: true,
        close: function (e) {
            destroyKpiTooltip();
        }
    });

    $("#txtStartDate").on("blur", function () {

        var goal = vmEditGoal.viewModel.goal;
        var startdateString = $("#txtStartDate").val();
        $("#txtStartDate").val(vmCommon.autoFormatDate(startdateString, kLg.language));

        var startdatePicker = vmCommon.convertDateFormat($("#txtStartDate").val(), kLg.language);
        if (startdatePicker != null) {
            var year = startdatePicker.getFullYear();
            if (year >= 1900 && year <= 2099) {
                $('#txtStartDate').data("kendoDatePicker").value(startdatePicker);
                goal.StartDate = $('#txtStartDate').data("kendoDatePicker").value();
            }
        }

        isValidStartDate();

        showMessageConfirmChangeStartDate();
    });

    $('#txtStartDate').on('keypress', function (e) {
        if (e.which === 13) {
            var goal = vmEditGoal.viewModel.goal;

            var startdateString = $("#txtStartDate").val();
            $("#txtStartDate").val(vmCommon.autoFormatDate(startdateString, kLg.language));

            var startdatePicker = vmCommon.convertDateFormat($("#txtStartDate").val(), kLg.language);
            if (startdatePicker != null) {
                var year = startdatePicker.getFullYear();
                if (year >= 1900 && year <= 2099) {
                    $('#txtStartDate').data("kendoDatePicker").value(startdatePicker);
                    goal.StartDate = $('#txtStartDate').data("kendoDatePicker").value();
                }
            }

            isValidStartDate();

            showMessageConfirmChangeStartDate();

            reCalculatEndDate();
        }
    });

    $('#txtStartDate').on('keyup', function (e) {
        var goal = vmEditGoal.viewModel.goal;
        var startdateString = $("#txtStartDate").val();

        if (startdateString.length > 7) {
            $("#txtStartDate").val(vmCommon.autoFormatDate(startdateString, kLg.language));

            var startdatePicker = vmCommon.convertDateFormat($("#txtStartDate").val(), kLg.language);
            if (startdatePicker != null) {
                var year = startdatePicker.getFullYear();
                if (year >= 1900 && year <= 2099) {
                    $('#txtStartDate').data("kendoDatePicker").value(startdatePicker);
                    goal.StartDate = $('#txtStartDate').data("kendoDatePicker").value();
                }
            }

            reCalculatEndDate();
            showMessageConfirmChangeStartDate();
        }
    });

    vmEditGoal.popTemplate = undefined;
    vmEditGoal.showPopEditTemplate = function () {
        var temps = vmEditGoal.viewModel.get("goaltemps");

        var template = kendo.template($("#goaltemplate").html());
        $("#popEditTemplate").html(template(temps));

        vmEditGoal.popTemplate = $("#popEditTemplate").kendoWindow({
            modal: true,
            title: kLg.DeleteTemplate,
            height: 360,
            width: 600,
            scrollable: false,
            resizable: false
        }).getKendoWindow();

        //vmEditGoal.popTemplate = $("#popEditTemplate").data("kendoWindow");
        vmEditGoal.popTemplate.center().open();

        vmEditGoal.popTemplate.bind("close", function (e) {
            vmEditGoal.closePopTemplate();
        });
    }

    vmEditGoal.deleteTemplate = function () {
        var temps = vmEditGoal.viewModel.get("goaltemps");
        var curTemplate = vmEditGoal.viewModel.get("templateId");
        var delTemps = [];
        $("#popEditTemplate input[type=checkbox]:checked").each(function () {
            delTemps.push(this.id);
        });

        if (delTemps.length > 0) {
            ynConfirm(kLg.confirmDeleteLabel).then(function () {
                vmEditGoal.dataservice.delTemplateByList({ temps: delTemps }, function (res) {
                    if (res.value > 0) {
                        for (var i = 0, len = delTemps.length; i < len; i++) {
                            var tid = delTemps[i];
                            temps.remove(vmEditGoal.FindById(temps, tid));
                            $(tid).checked = false;

                            if (curTemplate && curTemplate.Id === tid) {
                                vmEditGoal.viewModel.set("templateId", null);
                                vmEditGoal.optionTemp.Applying = null;
                                //reload file assigned
                                vmFile.reLoadFileAssigned();
                            }
                        }
                        vmEditGoal.viewModel.set("goaltemps", temps);
                        if (temps.length === 0) {
                            vmEditGoal.viewModel.set("isActiveTemp", false);
                            setLabelForDropTemplate();
                        }
                    }
                    vmEditGoal.closePopTemplate();
                });

            }, function () {
                vmEditGoal.closePopTemplate();
            });
        } else {
            vmEditGoal.closePopTemplate();
        }
    };

    vmEditGoal.closePopTemplate = function () {
        vmEditGoal.popTemplate.destroy();
        vmEditGoal.popTemplate = null;
        $(".navbar-collapse.collapse.block-nav").append("<div id='popEditTemplate'></div>");
    };

    vmEditGoal.findTempCache = function (tempId) {
        return vmEditGoal.TempCache[tempId];
    }

    vmEditGoal.bindGoalTemplateData = function (goaltemp) {
        var goalData = goaltemp;

        var curGoal = vmEditGoal.viewModel.get("goal");
        //aptitlelang
        if (goalData.ActionPlanEvalData && goalData.ActionPlanEvalData.APEvaluationData) {
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleX) goalData.ActionPlanEvalData.APEvaluationData.TitleX = kLg.lblApAxisX;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleY) goalData.ActionPlanEvalData.APEvaluationData.TitleY = kLg.lblApAxisY;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleZ) goalData.ActionPlanEvalData.APEvaluationData.TitleZ = kLg.lblApAxisZ;

            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleNegativeX) goalData.ActionPlanEvalData.APEvaluationData.TitleNegativeX = kLg.lblNegative;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleNeutralX) goalData.ActionPlanEvalData.APEvaluationData.TitleNeutralX = kLg.lblNeutral;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitlePositiveX) goalData.ActionPlanEvalData.APEvaluationData.TitlePositiveX = kLg.lblPositive;

            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleNegativeY) goalData.ActionPlanEvalData.APEvaluationData.TitleNegativeY = kLg.lblNegative;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitleNeutralY) goalData.ActionPlanEvalData.APEvaluationData.TitleNeutralY = kLg.lblNeutral;
            if (!goalData.ActionPlanEvalData.APEvaluationData.TitlePositiveY) goalData.ActionPlanEvalData.APEvaluationData.TitlePositiveY = kLg.lblPositive;
        }

        //important value
        goalData.Id = curGoal.Id;
        goalData.Mdf = curGoal.Mdf;
        goalData.SubMarketProductId = curGoal.SubMarketProductId;
        goalData.IndependencyId = curGoal.IndependencyId;
        goalData.IsFinishAll = curGoal.IsFinishAll;
        goalData.IsVisibilityAll = curGoal.IsVisibilityAll;
        goalData.SubProducts = curGoal.SubProducts;
        goalData.IsFromTemplate = true;

        var isMasterSubGoalKpi = vmGoalAction.goalOptions.IsMasterGoalKpi && vmGoalAction.goalOptions.IsEdit && vmGoalAction.goalOptions.GoalType != vmCommon.GoalType.MainGoal;
        for (var i = curGoal.Links.length - 1; i >= 0; i--) {
            var link = curGoal.Links[i];
            if (link.IsMasterLink && isMasterSubGoalKpi) continue;

            if (link.Id > 0) {
                link.set("IsShow", false);
                link.set("DataState", dataState.Deleted);
            }
            else
                curGoal.Links.splice(i, 1);
        }
        goalData.Links = curGoal.Links;

        //rebind people list
        var peos = vmCommon.pushApply([], goalData.People, function (item) { return { AccountId: item.AccountId, Email: item.Email }; });

        goalData.People = peos;

        //rebind status list
        var oldSts = $.grep(curGoal.Status, function (s) { return s.Id !== vmCommon.emptyGuid });
        $.each(oldSts, function (t) {
            oldSts[t].IsOrigin = false;
        });

        var sts = vmCommon.pushApply(oldSts, goalData.Status, function (item) {
            return {
                ActionId: vmCommon.emptyGuid,
                CreatedBy: 0,
                CreatedDate: new Date(),
                Date: item.Date,
                Description: item.Description,
                GoalId: goalData.Id,
                Id: item.Id,
                IsOrigin: true,
                Mdf: 0,
                ModifiedBy: 0,
                ModifiedDate: new Date(),
                StatusId: item.StatusId,
                IsNew: true
            };
        });

        goalData.Status = sts;

        //#region actionplanregion

        var autoRegionSrc = vmEditGoal.getSourceForSub(goalData.ActionPlanRegions, false),
            labeRegionSrc = vmEditGoal.getSourceForSub(goalData.ActionPlanRegions, true);

        vmEditGoal.viewModel.set("autoRegionSrc", autoRegionSrc);
        vmEditGoal.viewModel.set("labeRegionSrc", labeRegionSrc);

        vmEditGoal.viewModel.set("isVisibleSelectedRegion", labeRegionSrc.length > 0);
        //#endregion

        //#region actionplansubclient
        var autoClientSrc = vmEditGoal.getSourceForSub(goalData.SubClientGroups, false),
            labeClientSrc = vmEditGoal.getSourceForSub(goalData.SubClientGroups, true);

        vmEditGoal.viewModel.set("autoClientSrc", autoClientSrc);
        vmEditGoal.viewModel.set("labeClientSrc", labeClientSrc);

        vmEditGoal.viewModel.set("isVisibleSelectedClient", labeClientSrc.length > 0);
        vmGoalAction.subService.groupClient();
        //#endregion

        //#region actionplansubproduct
        var autoSubSrc = vmEditGoal.getSourceForSub(goalData.SubProductGroups, false),
            labeSubSrc = vmEditGoal.getSourceForSub(goalData.SubProductGroups, true);

        vmEditGoal.viewModel.set("autoSubSrc", autoSubSrc);
        vmEditGoal.viewModel.set("labeSubSrc", labeSubSrc);

        //vmGoalAction.subService.autoChange(this.tempSubValue, vmGoalAction.subService.rootType.SubProduct);
        vmGoalAction.subService.groupSub();

        vmEditGoal.viewModel.set("isVisibleSelectedSub", labeSubSrc.length > 0);
        //#endregion

        vmEditGoal.optionTemp.Applying = vmEditGoal.viewModel.get("templateId");

        // map data kpi
        let { KpiGoalData: { KpiGoalTopics: topicsTem } } = goalData;

        let k = 0;
        for (const { KpiGoalIndexes: index } of topicsTem) {
            index.forEach(t => t.Id = --k);
        }

        vmEditGoal.viewModel.set("goal", goalData);

        //apply the new color
        var colorPicker = $("#picker").data("kendoColorPicker");
        if (colorPicker) colorPicker.value(goalData.MColor);

        vmEditGoal.syncActionPlanConnection.syncType(vmEditGoal.viewModel, vmCommon.KpiGoalTopicType.Goal);

        if (vmGoalAction.goalOptions.IsEdit) {
            vmFile.setFileFromOtherSource(goalData.Files);
            vmFile.isSaveFromOtherSource = true;
        }

        vmEditGoal.activeModelChange();

        vmCommon.TexEditor.setEditorObserver(['#txtDescriptionMainSub', '#txtPurpose', '#txtEffect', '#txtArrived']);

    }

    function findMasterGoalInfo(type, source, masterId) {
        if (source == null || masterId == undefined) return "";
        var mginfo = "";
        var mgitem = null;
        for (var i = 0; i < source.length; i++) {
            if (source[i].Id === masterId) {
                mgitem = source[i];
                break;
            }
        }
        if (mgitem !== null) {
            switch (type) {
                case 1:
                    mginfo = mgitem.MasterBudget != null && mgitem.MasterBudget > 0 ? ("B: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.MasterBudget)) : "";
                    break;
                case 2:
                    mginfo = mgitem.ExpectedCost != null && mgitem.ExpectedCost > 0 ? ("P: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.ExpectedCost)) : "";
                    break;
                case 3:
                    mginfo = mgitem.ActualCost != null && mgitem.ActualCost > 0 ? ("C: " + mgitem.Currency + " " + vmCommon.formatCost(mgitem.ActualCost)) : "";
                    break;
                default:
                    break;
            }
        }

        return mginfo;
    }

    function fixGoalData(goal) {
        goal.Budget = goal.Budget || 0;

        return goal;
    }

    vmEditGoal.checkDate = function (e) {
        var inputDate = $(e);
        inputDate.preventPressAlphabetChar(kLg.language === "de" | "pm" ? [46] : [47]);

        var statusdateString = inputDate.val();
        var dateString = vmCommon.autoFormatDateByLang(statusdateString, kLg.language);
        var kendoDateString = vmCommon.toKendoDatePickerString(dateString);

        if (!statusdateString && statusdateString.length < 1) {
            inputDate.tooltip('destroy');
        } else {
            inputDate.tooltip('destroy');
            inputDate.attr("title", kLg.msgDateInValid);
            inputDate.tooltip({ trigger: "manual" }).tooltip('show');
        }

        if (vmCommon.isDate(vmCommon.toEnDateString(dateString))) {
            inputDate.val(kendoDateString);

            var goal = vmEditGoal.viewModel.get("goal");

            if (goal) {
                var itemIndex = inputDate.closest("tr").index();
                var dateValue = new Date(vmCommon.toEnDateString(dateString));
                goal.Status[itemIndex].Date = dateValue;
                vmEditGoal.viewModel.set("goal", goal);
            }

            inputDate.tooltip('destroy');
        }

    };

    $("#area-edit-goal").on("mouseenter", "li.group-sub", function (e) {
        var id = $(this).attr("oid");
        var typeId = $(this).attr("otype");

        //1:subproduct, 2:subclient
        var rtype = $(this).attr("rtype");

        if (id == undefined || typeId == undefined) {
            return;
        }

        id = Number(id);
        typeId = Number(typeId);
        if (isNaN(id) || isNaN(typeId)) return;

        if (vmEditGoal.viewModel == undefined) return;

        var model = vmEditGoal.viewModel;

        var labeSrc = undefined;

        var placement = "bottom";
        switch (rtype) {
            case "1":
                labeSrc = vmCommon.deepCopy(model.labeSubSrc);
                placement = "right";
                break;
            case "2":
                labeSrc = vmCommon.deepCopy(model.labeClientSrc);
                placement = "left";
                break;
        }

        if (labeSrc == undefined) return;

        var childTypeId = typeId + 1;
        var src = vmCommon.sortBy($.grep(labeSrc, function (it) { return it.ParentId === id && it.TypeId === childTypeId; }), "Index");

        var pos = $(this).position(), wid = $(this).width(), hei = $(this).height() + 12;
        var template = kendo.template($("#subchild").html());

        //1000: width of form, 410: max width of popover
        //var placement = 1000 - (pos.left + wid) > 410 ? "right" : pos.left > 410 ? "left" : "bottom";
        $(this).popover({
            html: true,
            content: template(src),
            title: kLg.titleSelectedSub,
            trigger: "hover",
            placement: placement
        }).popover("show");

        var popElem = $(this).next("div.popover");

        var arrows = $(popElem).children("div.arrow");
        if (arrows.length === 0) return;

        var arrowElem = arrows[0];
        if (placement !== "bottom") {
            //28: higher than element, 45: from popover top to element
            $(popElem).css({ top: (pos.top - 28) + "px" });
            $(arrowElem).css({ top: 45 + "px" });
        } else {
            $(popElem).css({ top: (pos.top + hei) + "px" });
        }
    });

    function isValidSub() {
        if (!vmEditGoal.isValidSub) {
            $("#area-edit-goal #txtSubPg").focus();
        }

        return vmEditGoal.isValidSub;
    };

    function isValidClient() {
        if (!vmEditGoal.isValidClient) {
            $("#area-edit-goal #txtSubClient").focus();
        }

        return vmEditGoal.isValidClient;
    };

    $("#area-edit-goal").on("mouseenter", ".icon-kpi-goal-small", function (e) {
        if (vmEditGoal.viewModel == undefined || vmEditGoal.viewModel.goal == undefined) return;

        var target = e.currentTarget;

        //destroy other
        $("#area-edit-goal .icon-kpi-goal-small").not(target).each(function () {
            var other = $(this).data("kendoTooltip");
            if (other) other.destroy();
        });

        var tt = $(target).data("kendoTooltip");
        if (tt) return;

        var goal = vmEditGoal.viewModel.goal;
        var kpiData = goal.KpiGoalData;

        function callback(kpiDatas, settings) {
            var kpiUnits = settings.KpiUnits;
            var rowCount = 0;
            var kpiDataTemp = vmCommon.deepCopy(kpiDatas);
            if (!kpiDataTemp) return;
            var kpiGt = Array.isArray(kpiDataTemp.KpiGoalTimes) ? kpiDataTemp.KpiGoalTimes : [];

            for (var t = 0; t < kpiGt.length; t++) {
                var time = kpiGt[t];

                if (time.Name && typeof (time.Name) == "string") {
                    time.Name = time.Name.toDate();
                }
            }

            for (var i = 0; i < kpiDataTemp.KpiGoalTopics.length; i++) {
                var topic = kpiDataTemp.KpiGoalTopics[i];
                var indexes = topic.KpiGoalIndexes;

                rowCount += 2;
                rowCount += indexes.length;

                for (var j = 0; j < indexes.length; j++) {
                    var index = indexes[j];

                    //unit name
                    var unit = vmCommon.findById(index.KpiUnitId, kpiUnits) || vmCommon.defaultUnit();
                    index.KpiUnitText = unit.Name;

                    //css
                    index.posClass = unit.PositionId == 1 ? "unit-left" : unit.PositionId == 3 ? "unit-center" : unit.PositionId == 2 ? "unit-right" : "";

                    function formatNumber(number, orFormat) {
                        return (number != null) ? kendo.toString(number, orFormat) : "";
                    };

                    //numeric
                    var orderFormat = unit.OrderId === 2 ? "{0} ##,#.00" : "##,#.00 {0}";
                    orderFormat = orderFormat.format(unit.Symbol.encodeDola().encodeSymbol());

                    //ExpectedValue
                    index.ExpectedValueText = formatNumber(index.ExpectedValue, orderFormat);
                    //LstValue
                    index.LstValueText = formatNumber(index.LstValue, orderFormat);

                    //KpiValue
                    var indextimes = index.KpiGoalIndexTimes;
                    for (var k = 0; k < indextimes.length; k++) {
                        var indextime = indextimes[k];
                        indextime.KpiValueText = formatNumber(indextime.KpiValue, orderFormat);
                    }
                }
            }

            var template = kendo.template($("#kpigoalviewtemplate").html());
            var tooltip = $(target).kendoTooltip({
                autoHide: false,
                content: template(kpiDataTemp),
                width: 833 + ((kpiGt.length > 7 ? 7 : kpiGt.length) * 120),
                height: 60 + (rowCount < 4 ? 4 : rowCount) * 36,
                hide: function () {
                    var tt = $(this.element).data("kendoTooltip");
                    if (tt) tt.destroy();
                },
                show: function (e) {
                    this.content.css({ 'max-width': 'none' })
                }
            }).data("kendoTooltip");
            tooltip.show();

            var content = tooltip.content;
            if (kpiGt.length > 7) $(content).children("div.kpidivview").css({ "overflow-x": "auto" });
        };

        if (vmGoalAction.kpiGoalSettings == undefined) {
            var goalTemplate = vmEditGoal.viewModel.templateId || {};
            var isMain = vmGoalAction.goalOptions.GoalType === vmCommon.GoalType.MainGoal;

            vmEditGoal.dataservice.getKpiGoalSetting({ IndependencyId: vmGoalAction.goalOptions.IndependencyId, SubMarketProductId: vmGoalAction.goalOptions.SubMarketProductId, MainGoalId: isMain ? goal.Id : goal.ParentId, SubGoalId: isMain ? null : goal.Id, GoalActionType: isMain ? vmCommon.GoalActionContentType.MainGoal : vmCommon.GoalActionContentType.SubGoal, TemplateId: goalTemplate.Id }, function (res) {
                vmGoalAction.kpiGoalSettings = res.value;
                callback(kpiData, vmGoalAction.kpiGoalSettings);
            });
        } else {
            callback(kpiData, vmGoalAction.kpiGoalSettings);
        }
    });

    vmEditGoal.getMasterKpi = function (goal) {
        var rs = [];
        //1. from kpidata
        var goalTopics = $.grep(goal.KpiGoalData.KpiGoalTopics, function (it) { return it.TypeId == vmCommon.KpiGoalTopicType.Goal; });
        var goalIndexes = [];
        for (var i = 0; i < goalTopics.length; i++) {
            var topic = goalTopics[i];
            var indexes = topic.KpiGoalIndexes;
            for (var j = 0; j < indexes.length; j++) {
                goalIndexes.push(indexes[j]);
            }
        }
        rs = goalIndexes.map(function (it) { return it.GuidLinkId; }).unique();

        var deletedItems = goal.KpiGoalData.DeletedItems || [];
        for (var i = 0; i < deletedItems.length; i++) {
            if (deletedItems[i].TypeId == vmCommon.KpiGoalType.INDEX && deletedItems[i].Item.GuidLinkId != undefined) rs.push(deletedItems[i].Item.GuidLinkId);
        }

        //2. from goal's block
        rs = rs.concat(vmGoalAction.getMasterKpiForGoal(goal.SubMarketProductId, goal.IndependencyId, goal.Id || goal.ParentId));

        return rs.unique();
    };

    vmEditGoal.getSelectableTopics = function () {
        var lst = [];
        //if (isSelectRegion) lst.push(vmCommon.KpiGoalTopicType.LandRegion);
        //lst.push(vmCommon.KpiGoalTopicType.Market);
        //lst.push(vmCommon.KpiGoalTopicType.Product);
        if (vmGoalAction.goalOptions.KpiGoalSelectable) lst.push(vmCommon.KpiGoalTopicType.Goal);

        return lst;
    };

    vmEditGoal.syncActionPlanConnection = function () {
        var model;

        var syncRegion = function (topic) {
            var indexes = topic ? topic.KpiGoalIndexes.filter(index => index.TypeId == 2) : [];
            var labeSrc = model.labeRegionSrc;
            var autoSrc = model.autoRegionSrc;

            var newItems = indexes.filter(a => !labeSrc.some(b => b.ObjectId == a.LongLinkId));
            var delItems = labeSrc.filter(a => !indexes.some(b => b.LongLinkId == a.ObjectId));

            delItems.forEach(t => {
                var delIndex = labeSrc.indexOf(t);
                if (delIndex <= -1) return;

                if (t.Id > 0) t.set("DataState", dataState.Deleted);
                autoSrc.push(t);
                labeSrc.splice(delIndex, 1);
            });

            newItems.forEach(t => {
                var newItem = autoSrc.find(x => x.ObjectId == t.LongLinkId);
                if (newItem == undefined) return;

                var newIndex = autoSrc.indexOf(newItem);
                if (newItem.Id > 0) newItem.set("DataState", dataState.Modified);
                labeSrc.push(newItem);
                autoSrc.splice(newIndex, 1);
            });

            model.set("isVisibleSelectedRegion", labeSrc.length > 0);
            model.setVisibleKpi();
        };

        var syncProduct = function (topic) {
            var indexes = topic ? topic.KpiGoalIndexes : [];
            var labeProduct = model.displaySrc;

            var labeSrc = model.labeSubSrc;
            var autoSrc = model.autoSubSrc;

            var newItems = indexes.filter(a => !labeProduct.some(b => b.ObjectId == a.LongLinkId && ((a.TypeId == 6 && b.TypeId == 1) || (a.TypeId == 7 && b.TypeId == 2) || (a.TypeId == 8 && b.TypeId == 3))));
            var delItems = labeProduct.filter(b => !indexes.some(a => a.LongLinkId == b.ObjectId && ((a.TypeId == 6 && b.TypeId == 1) || (a.TypeId == 7 && b.TypeId == 2) || (a.TypeId == 8 && b.TypeId == 3))));

            delItems.forEach(t => {
                var delIndex = vmCommon.findIndexByFunc(model.labeSubSrc, function (it) { return it.ObjectId == t.ObjectId && it.TypeId == t.TypeId; });
                if (delIndex <= -1) return;

                t.IsSelect = false;
                t.set("DataState", t.Id > 0 ? dataState.Deleted : dataState.Unchanged);

                model.autoSubSrc.push(t);
                model.labeSubSrc.splice(delIndex, 1);

                vmGoalAction.subService.autoChange(t, vmGoalAction.subService.rootType.SubProduct);
                vmGoalAction.subService.groupSub();
            });

            newItems.forEach(t => {
                var newItem = model.autoSubSrc.find(x => x.ObjectId == t.LongLinkId && ((x.TypeId == 1 && t.TypeId == 6) || (x.TypeId == 2 && t.TypeId == 7) || (x.TypeId == 3 && t.TypeId == 8)));
                if (newItem == undefined) return;

                newItem.IsSelect = true;
                var newIndex = model.autoSubSrc.indexOf(newItem);
                newItem.set("DataState", newItem.Id > 0 ? dataState.Modified : dataState.Added);
                model.labeSubSrc.push(newItem);
                model.autoSubSrc.splice(newIndex, 1);

                vmGoalAction.subService.autoChange(newItem, vmGoalAction.subService.rootType.SubProduct);
                vmGoalAction.subService.groupSub();
            });

            model.set("isVisibleSelectedSub", model.displaySrc.length > 0);
            model.setVisibleKpi();
        };

        var syncMarket = function (topic) {
            var indexes = topic ? topic.KpiGoalIndexes : [];
            var labeMarket = model.displayClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);

            var labeSrc = model.labeClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);
            var autoSrc = model.autoClientSrc.filter(t => t.TypeId != 7 && t.TypeId != 4);

            var newItems = indexes.filter(a => !labeMarket.some(b => b.ObjectId == a.LongLinkId && ((a.TypeId == 3 && b.TypeId == 1) || (a.TypeId == 4 && b.TypeId == 2) || (a.TypeId == 5 && b.TypeId == 3))));
            var delItems = labeMarket.filter(b => !indexes.some(a => a.LongLinkId == b.ObjectId && ((a.TypeId == 3 && b.TypeId == 1) || (a.TypeId == 4 && b.TypeId == 2) || (a.TypeId == 5 && b.TypeId == 3))));

            delItems.forEach(t => {
                var delIndex = vmCommon.findIndexByFunc(model.labeClientSrc, function (it) { return it.ObjectId == t.ObjectId && it.TypeId == t.TypeId; });
                if (delIndex <= -1) return;

                t.IsSelect = false;
                if (t.Id > 0) t.set("DataState", dataState.Deleted);
                model.autoClientSrc.push(t);
                model.labeClientSrc.splice(delIndex, 1);

                vmGoalAction.subService.autoChange(t, vmGoalAction.subService.rootType.SubClient);
                vmGoalAction.subService.groupClient();
            });

            newItems.forEach(t => {
                var newItem = model.autoClientSrc.find(x => x.ObjectId == t.LongLinkId && ((x.TypeId == 1 && t.TypeId == 3) || (x.TypeId == 2 && t.TypeId == 4) || (x.TypeId == 3 && t.TypeId == 5)));
                if (newItem == undefined) return;

                newItem.IsSelect = true;
                var newIndex = model.autoClientSrc.indexOf(newItem);
                newItem.set("DataState", newItem.Id > 0 ? dataState.Modified : dataState.Added);
                model.labeClientSrc.push(newItem);
                model.autoClientSrc.splice(newIndex, 1);

                vmGoalAction.subService.autoChange(newItem, vmGoalAction.subService.rootType.SubClient);
                vmGoalAction.subService.groupClient();
            });

            model.set("isVisibleSelectedClient", model.displayClientSrc.length > 0);
            model.setVisibleKpi();
        };

        var syncConnection = function (topic) {
            if (vmGoalAction.goalOptions.IsMasterGoalKpi && vmGoalAction.goalOptions.IsEdit && vmGoalAction.goalOptions.GoalType != vmCommon.GoalType.MainGoal) return;

            var indexes = topic ? topic.KpiGoalIndexes : [];
            var links = model.goal.Links;
            var deletedItems = model.goal.KpiGoalData.DeletedItems;

            for (var i = links.length - 1; i >= 0; i--) {
                var l = links[i];
                l.set("IsMasterLink", indexes.some(t => t.GuidLinkId == l.LinkId));

                var deletedIndexes = deletedItems.filter(t => !l.IsMasterLink && t.Item.GuidLinkId == l.LinkId && !t.IsSync);
                if (deletedIndexes.length > 0 || (!l.IsMasterLink && !model.goal.Visibility) || !l.IsVisibility) {
                    deletedIndexes.forEach(t => t.IsSync = true);

                    if (l.Id > 0) {
                        l.set("IsShow", false);
                        l.set("DataState", dataState.Deleted);
                    } else {
                        links.splice(i, 1);
                    }
                }

                $("#link-" + l.LinkId + "-" + l.Id).html(vmCommon.bindingContent("temp-kpiinfo", l));
                $("#link-" + l.LinkId + "-" + l.Id).attr("id", "link-" + l.LinkId + "-" + l.Id);
            }

            var newLinks = [];
            indexes.forEach(i => {
                var avaiableLinks = links.filter(t => t.DataState != dataState.Deleted);
                if (avaiableLinks.some(t => t.LinkId == i.GuidLinkId)) return;

                newLinks.pushx(i.GuidLinkId);
            });

            if (newLinks.length > 0) {
                vmGoalAction.dataservice.getMenuLinkInfos({ GoalActionIds: newLinks }, function (res) {
                    var temps = res.value;
                    temps.forEach(l => {
                        var newLink = new ActionPlanLink();
                        newLink.LinkId = l.Id;
                        newLink.LinkName = l.Name;
                        newLink.LinkTypeId = vmCommon.GoalActionContentType.SubGoal;

                        newLink.LinkDescription = l.Description;
                        newLink.MIndex = vmCommon.getMaxMIndex(links) + 1;

                        newLink.IsMasterLink = true;
                        newLink.RoleId = l.RoleId;
                        newLink.Path = l.Path;
                        newLink.Url = l.Url;
                        newLink.IsVisibility = l.IsVisibility;

                        newLink.ApEvaluation = l.ApEvaluation;
                        newLink.KpiInfo = l.KpiInfo;
                        newLink.TodoPercent = l.TodoPercent;

                        links.push(newLink);
                    });
                });
            }

            model.set("hasLink", model.goal.Visibility || model.goal.Links.some(t => t.IsShow));
        };

        var sync = function (goalModel) {
            if (goalModel == undefined || goalModel.goal == undefined) return;

            var goal = goalModel.goal;
            if (goal == undefined || goal.KpiGoalData == undefined) return;

            model = goalModel;
            var topics = goal.KpiGoalData.KpiGoalTopics || [];

            //region
            var regiontopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.LandRegion);
            syncRegion(regiontopic);

            //product
            var producttopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Product);
            syncProduct(producttopic);

            //market
            var markettopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Market);
            syncMarket(markettopic);

            //connection

            var goaltopic = topics.find(t => t.TypeId == vmCommon.KpiGoalTopicType.Goal);
            syncConnection(goaltopic);

            //vmGoalAction.autoSubHeight();
        };

        var syncType = function (goalModel, topicType) {
            if (goalModel == undefined || goalModel.goal == undefined) return;

            var goal = goalModel.goal;
            if (goal == undefined || goal.KpiGoalData == undefined) return;

            model = goalModel;
            var topics = goal.KpiGoalData.KpiGoalTopics || [];

            var topic = topics.find(t => t.TypeId == topicType);
            switch (topicType) {

                case vmCommon.KpiGoalTopicType.LandRegion:
                    syncRegion(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Product:
                    syncProduct(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Market:
                    syncMarket(topic);
                    break;
                case vmCommon.KpiGoalTopicType.Goal:
                    syncConnection(topic);
                    break;
            }
        };

        return { sync: sync, syncType: syncType };
    }();
    var goalActionLinkInfos = {};

    $("#area-edit-goal").on("mouseenter", ".linkname", function (e) {
        if (vmEditGoal.viewModel == undefined || vmEditGoal.viewModel.goal == undefined) return;

        var target = e.currentTarget;
        var index = $(target).closest("tr").index();

        $("#area-edit-goal .linkname").not(target).each(function () {
            var other = $(this).data("kendoTooltip");
            if (other) other.destroy();
        });

        var links = vmEditGoal.viewModel.goal.Links;
        var link = links[index];
        if (link.LinkDescription) {
            //destroy other
            var tt = $(target).data("kendoTooltip");
            if (tt) return;

            var template = kendo.template($("<div><div class='xx' style='width: 100%;text-align: initial;'><label>#:kLg.vtextDescription#</label><div class='clear'></div><div class='ms-content-tooltip'>#:vmCommon.TexEditor.stripHtml(data.Description)#</div></div></div>").html());
            var tooltip = $(target).kendoTooltip({
                position: "left",
                autoHide: true,
                content: template({ Description: link.LinkDescription }),
                width: 300,
                //height: 150,
                hide: function () {
                    var tt = $(this.element).data("kendoTooltip");
                    if (tt) tt.destroy();
                }
            }).data("kendoTooltip");
            tooltip.show();
        }
    });
</script>