<style type="text/css">
    .crm-label {
    }

    .div-item .ms-drop {
        margin-top: 4px;
        margin-left: 142px !important;
    }

    .clear35px {
        height: 35px;
    }

    .crm-drop {
        width: 174px !important;
    }
    .k-list-container  {
       width: 174px !important;
    }  
    

    /*.k-autocomplete > input {
        width: 99% !important;
    }*/

    .img-logo img {
        height: 100%;
        width: inherit;
    }
    .info-value.iv-textedit-box { position: relative; }
    .iv-textedit-removebtn {
        position: absolute; top:10px;right:154px;
        display:inline-flex;margin-top:3px;
    }
    .iv-textedit-removebtn .remove-item {margin-top: 5px;}
    .info-value .tooltip {
        left: 436px !important;
    }
    
    .k-autocomplete .k-input {
        height: 1.65em;
        line-height: 1.65em;
        padding: 0.177em 0;
        text-indent: 4px;
        border: 0px !important;
        margin: 0;
    }

    /* multiselect */
    .divtag .k-multiselect-wrap input[class~="k-input"] {
        /* display: none !important;*/
        border: none !important;
        background-color: white !important;
    }

    .divtag .k-multiselect-wrap {
        border-radius: 0px !important; 
    }

    .divtag .k-multiselect.k-header {
        border-color: #E7E7E7 !important;
    }

    .k-animation-container .k-state-focused {
        border-width: 0;
        border-color: #E7E7E7;
        box-shadow: none;
    }
    /**/
    .divtag .k-multiselect-wrap li[class~="k-button"] {
        color: #2e2e2e;
        border-color: #fafafa;
        background-color: #fafafa;
        border-radius: 30px;
        max-width: 99%;
    }

    .divtag .k-multiselect-wrap li[class~="k-button"]:hover {
        color: #2e2e2e;
        border-color: #EBEBEB;
        background-color: #EBEBEB;
        border-radius: 30px;
        max-width: 99%;
    }
    .iv-selector-box {margin-top:9px;}
    .divtag .k-multiselect, #ddlTags-list {
        width: 393px !important;
    }
    
    .dnbTextAreaEditor {
        width: 202px; max-height:42px;
        margin-right: -3px;
        margin-left: -3px;
    }
    .dnbTextAreaEditor > table.k-editor {
        border: none; 
        max-height: 36px; min-height:36px;
        background-color: transparent;
    }
    .dnbTextAreaEditor > table.k-editor iframe.k-content {
        background-color: #F7F7F7;
        max-height: 32px; min-height:32px;
    }
    .dnbTextAreaEditor > table.k-editor .k-editable-area {
        border-color: #E7E7E7;
    }
    .dnbTextAreaEditor td.k-editor-toolbar-wrap {
        height: 0
    }
    .dnbTextAreaEditor .modal-textarea {
        min-height: 70px;
        display: inline-block;
        width: 91%;
        max-height: 155px;
    }
    .dnbTextAreaEditor[data-crm-id="crmOrgNotes"], 
    .dnbTextAreaEditor[data-crm-id="-crmOrgNotes"] {   /* Addnew Org*/
        width: 404px;
    }
    .iv-relationship-box {position:relative;}
    .iv-relationship-box .dnbTextAreaEditor.txtedit-relationship-box {
        width: 180px;
    }
    .iv-relationship-box .dnbTextAreaEditor.txtedit-relationship-box .k-editor iframe.k-content{
        box-sizing: border-box;
    }
    .iv-relationship-box .iv-textedit-removebtn{
        right: -53px;
    }
    .dnbTextAreaEditor[data-crm-id="crmOrgNotes"] > table.k-editor iframe.k-content,
    .dnbTextAreaEditor[data-crm-id="-crmOrgNotes"] > table.k-editor iframe.k-content { /* Addnew Org*/
        min-height: 165px;
    }
    .dnbTextAreaEditor[data-crm-id="crmOrgNotes"] + .iv-icexpand-texteditor,
    .dnbTextAreaEditor[data-crm-id="-crmOrgNotes"] + .iv-icexpand-texteditor { /* Addnew Org*/
        position: absolute;
        top: -15px;
        right: -9px;
    }
    .iv-top11 {margin-top:6px;padding-top:3px;}
    .k-editor-toolbar-wrap span.k-widget.k-colorpicker.k-header.k-editor-widget[role="textbox"] {
        width: 30px
    }
</style>
<link href="../Css/multiple-select.css" rel="stylesheet" />
<div id="edit-form-organisation" data-bind="events:{change: formChange}">
    <div class="modal-body ms-modal-body organ-modal" style="height: 660px; overflow-x: hidden; overflow-y: scroll;">
    <div class="div-name-organ">
        <div class="col-div-60 pull-left" style="padding-bottom: 20px;">
            <label class="lable-md-organ" id="lblName">Name</label>
            <div class="clear"></div>
            <input class="input-filter input-icon" id="txtName" data-bind="value: organisation.Name" data-value-update="keyup, change" maxlength="100" >
        </div>
        <div class="col-div-40 pull-left" style="width: 38% !important;padding-bottom: 20px;">
            <label class="lable-md-organ" id="lblKundenNr">Kunden Nr.</label>
            <div class="clear"></div>
            <div>
                <input class="input-filter input-icon" style="width: 165px;float: left" id="txtKundenNr" data-bind="value: organisation.KundenNr" data-value-update="keyup" maxlength="50" onchange="">
                <span class="icon-55 icon-organisation" style="float: right;"></span>
            </div>
        </div>
    </div>
        <div class="clear"></div>
        <hr class="modal-organ-hr">
        <div class="div-detail-organ">
            <div class="col-div-60 pull-left">
                <div>
                    <div id="address-control" data-bind="source: organisation.CrmAddress" data-template="temp-address"></div>
                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddAddress" data-bind="events: {click: addControl}">Addresse hinzufügen</a>
                    </div>
                </div>
                <div>
                    <div id="phone-control" data-bind="source: infoGroup.telephone" data-template="temp-info">
                    </div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddTelephone" data-bind="events:{click: addControl}">Telefon hinzufügen</a>
                    </div>
                </div>

                <div>
                    <div id="fax-control" data-bind="source: infoGroup.fax" data-template="temp-info">
                    </div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddFax" data-bind="events:{click: addControl}">Fax hinzufügen</a>
                    </div>
                </div>
                <div>
                    <div id="email-control" data-bind="source: infoGroup.email" data-template="temp-info">
                    </div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddEmail" data-bind="events:{click: addControl}">E-Mail hinzufügen</a>
                    </div>
                </div>
                <div>

                    <div id="website-control" data-bind="source: infoGroup.website" data-template="temp-info">
                    </div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddWebsite" data-bind="events:{click: addControl}">Website hinzufügen</a>
                    </div>
                </div>

                <div class="clear"></div>
                <hr class="modal-organ-hr">

                <div>
                    <div>
                        <div class="col-div pull-left">
                            <label class="lable-md-organ" id="lblNetwork">Netzwerk</label>
                            <div class="clear"></div>
                        </div>
                        <div class="col-div-2 pull-left">
                            <label class="lable-md-organ" id="lblUrl">URL</label>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div id="network-control" data-bind="source: infoGroup.network" data-template="temp-info"></div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-net pull-left" id="linkAddNetwork" data-bind="events:{click: addControl}">Netzwerk hinzufügen</a>
                    </div>
                </div>

                <div class="clear"></div>
                <hr class="modal-organ-hr">
                <div>
                    <div>
                        <div class="col-div pull-left">
                            <label class="lable-md-organ" id="lblResource">Ressource</label>
                            <div class="clear"></div>
                        </div>
                        <div class="col-div-2 pull-left">
                            <label class="lable-md-organ crm-label">Bezeichnung</label>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div id="resource-control" data-bind="source: infoGroup.resource" data-template="temp-info-texteditor"></div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-ressource pull-left" id="linkAddResource" data-bind="events:{click: addControl}">Ressource hinzufügen</a>
                    </div>
                </div>
                <div class="clear"></div>
                <div>
                    <div>
                        <div class="col-div pull-left">
                            <label class="lable-md-organ" id="lblCompetence">Kompetenz</label>
                            <div class="clear"></div>
                        </div>
                        <div class="col-div-2 pull-left">
                            <label class="lable-md-organ crm-label">Bezeichnung</label>
                            <div class="clear"></div>
                        </div>
                    </div>

                    <div id="competence-control" data-bind="source: infoGroup.competence" data-template="temp-info-texteditor"></div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-compet pull-left" id="linkAddCompetence" data-bind="events:{click: addControl}">Kompetenz hinzufügen</a>
                    </div>
                </div>
                <div class="clear"></div>
                <hr class="modal-organ-hr">
                <div>
                    <div>
                        <div class="col-div pull-left">
                            <label class="lable-md-organ" id="lblCategory">Kategorie</label>
                            <div class="clear"></div>
                        </div>
                        <div class="col-div-2 pull-left">
                            <label class="lable-md-organ crm-label">Bezeichnung</label>
                            <div class="clear"></div>
                        </div>
                    </div>

                    <div id="category-control" data-bind="source: infoGroup.category" data-template="temp-info-texteditor"></div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-compet pull-left" id="linkAddCategory" data-bind="events:{click: addControl}">Kategorie hinzufügen</a>
                    </div>
                </div>
                <div class="clear"></div>
                <hr class="modal-organ-hr">
                <div>
                    <div>
                        <div class="pull-left col-div-33">
                            <label class="lable-md-organ" id="lblRelationship">Organisation</label>
                            <div class="clear"></div>
                        </div>
                        <div class="pull-left col-div-33">
                            <label class="lable-md-organ" id="lblTypeOfRelationship">Beziehung</label>
                            <div class="clear"></div>
                        </div>
                        <div class="pull-left">
                            <label class="lable-md-organ" id="lblNote">Bemerkung</label>
                            <div class="clear"></div>
                        </div>
                    </div>
                    <div class="clear"></div>

                    <div id="relationPer-control" data-template="temp-addRelationship" data-bind="source: organisation.CrmRelationships"></div>

                    <div class="pull-right col-div-2 row-item">
                        <a class="add-compet pull-left" id="linkAddRelationship" data-bind="events:{click: addRelationship}">Persion hinzufügen</a>
                    </div>
                </div>
            </div>
            <div class="col-div-40 pull-left crm-custom-tabindex" style="width: 38% !important;">
                <div>
                    <div class="col-div-50 pull-left">
                        <div class="div-item">
                            <label class="lable-md-organ" id="lblLegalForm">Rechtsform</label>
                            <div class="clear"></div>

                            <select class="crm-drop"
                                    data-option-label=" "
                                    data-value-primitive="true"
                                    data-role="dropdownlist"
                                    data-text-field="Name"
                                    data-value-field="Id"
                                    data-bind="value: organisation.LegalForm, source: legalFormGroup, events:{change: onChange}" ></select>

                        </div>
                        <div class="div-item">
                            <label class="lable-md-organ" id="lblEmployee">Mitarbeiter</label>
                            <div class="clear"></div>

                            <select class="crm-drop"
                                    data-option-label=" "
                                    data-value-primitive="true"
                                    data-role="dropdownlist"
                                    data-text-field="Name"
                                    data-value-field="Id"
                                    data-bind="value: organisation.Employee, source: employeeGroup"></select>

                        </div>
                        <div class="div-item">
                            <label class="lable-md-organ" id="lblResponbility">Verantwortung</label>
                            <div class="clear"></div>
                            <div class="div-item divtag">

                                <select data-role="multiselect"
                                        data-placeholder=""
                                        data-filter="contains"
                                        data-text-field="Name"
                                        data-value-field="Id"
                                        data-bind="value: oldAcc, source: accounts, events:{change: onChangeAccount, filtering: multiSelectFiltering}"
                                        id="ddlTags">
                                </select>
                            </div>
                         </div>
                        
                        <div class="div-item-2">
                            <label class="lable-md-organ" id="lblLogo">Logo</label>
                            <div class="clear"></div>
                            <div class="div-item" id="div-show-logo">
                                <div class="img-logo">
                                    <img data-bind="attr:{src: organisation.Logo}, events:{change: onchangeLogo}" alt="" id="imgLogo">
                                </div>
                                <span class="icon-32 icon-bin-logo icon-bin icon-bin-filter" data-bind="events:{click: deleteLogo}"></span>
                            </div>
                            <div class="div-item margin-top-5" id="div-upload-logo">
                                <input type="file" id="txtLogo" style="display: none;" accept="image/*" data-bind="events:{change: changeLogo}" />
                                <button type="button" class="ms-button pull-left" id="btnAddLogo" onclick="addLogo();">
                                    <span class="icon-20 icon-img-white pull-left margin-right6"></span>
                                    <span id="linkAddLogo">Logo hinzufügen</span>
                                </button>
                            </div>
                        </div>

                    </div>
                    <div class="col-div-50 pull-left">
                        <div class="div-item" style="padding-left:7px;">
                            <label class="lable-md-organ" id="lblBranch">Branche</label>
                            <div class="clear"></div>

                            <select class="crm-drop"
                                    data-option-label=" "
                                    data-value-primitive="true"
                                    data-role="dropdownlist"
                                    data-text-field="Name"
                                    data-value-field="Id"
                                    data-bind="value: organisation.Branch, source: branchGroup" ></select>

                        </div>
                        <div class="div-item">
                            <div class="div-item" style="padding-left:7px;">
                                <label class="lable-md-organ" id="lblRevenue">Revenue</label>
                                <div class="clear"></div>

                                <select class="crm-drop"
                                        data-option-label=" "
                                        data-value-primitive="true"
                                        data-role="dropdownlist"
                                        data-text-field="Name"
                                        data-value-field="Id"
                                        data-bind="value: organisation.Revenue, source: revenueGroup" ></select>

                            </div>
                        </div>
                        <div class="div-item">

                        </div>
                    </div>
                </div>
                <div class="clear"></div>
                <div class="div-item divtag">
                    <label class="lable-md-organ" id="lblTag">Tags</label>
                    <div class="clear"></div>
                    <!--<select id="ddlTags" class="w-100per" data-text-field="Name" data-value-field="Id" data-bind="source: tagGroup, value: oldTags" multiple></select>-->

                    <select data-role="multiselect"
                            data-placeholder=""
                             data-filter="contains"
                            data-text-field="Name"
                            data-value-field="Id"
                            data-bind="value: oldTags, source: tagGroup, events:{filtering: multiSelectFiltering "
                            id="ddlTags"></select>

                </div>
                <div class="clear"></div>
                <div class="div-item-2">
                    <label class="lable-md-organ" id="lblNotes" style="margin-bottom:0">Notizen</label>
                    <div class="clear"></div>
                    <div style="position:relative">
                        <div class="dnbTextAreaEditor" data-crm-id="crmOrgNotes">
                            <textarea rows="1" class="modal-textarea" data-value-update="keyup"
                                      data-role="editor" data-tools="[]"
                                      data-bind="value: organisation.Note,
                                        events: {
                                            keyup: onKeyUpChangeNoteEditor,
                                            paste: onKeyUpChangeNoteEditor,
                                            change: onChangeNoteEditor
                                        }">
                            </textarea>
                        </div>
                        <span class="icon-16 iv-icexpand-texteditor"
                              data-bind="events: {click: onExpandNotesPopup}"> </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="clearx2"></div>
        
    </div>
<div class="modal-market-footer">

    <button type="button" class="ms-button" id="btnSave" data-bind="events:{click: valid}"><span class="icon-16 icon-close margin-right6"></span><span id="lblClose">Speichern und schliessen</span></button>
    <span class="pull-right foot-last-change" data-bind="text: organisation.LastChange"></span>
    <span class="pull-left foot-confirm-address k-icon k-i-calendar" data-bind="events:{click: confirmAddress}"></span>
    <span class="pull-left foot-confirm-address" data-bind="visible: organisation.IsApproved, text: organisation.FullMessage"  ></span>
</div>
</div>

<script type="text/html" id="temp-info-texteditor">
    <div data-bind="visible: IsVisible, events:{change: onChange}">
        <div class="clear"></div>
        <div class="col-div pull-left iv-selector-box">
            <select class="crm-drop"
                    data-role="dropdownlist"
                    data-text-field="Name"
                    data-value-field="Id"
                    data-bind="value: CategoryId, source: src"></select>
        </div>
        <div class="col-div-2 pull-left info-value iv-textedit-box">
            <div class="dnbTextAreaEditor dnbHideScroll" data-bind="attr: { typeCate: TypeCate, data-crm-id: Id}">
                <textarea rows="1" class="modal-textarea" data-value-update="keyup" 
                          data-role="editor" data-tools="[]"
                          data-bind="value: Value,
                                events: {
                                    keyup: onKeyUpChangeValKendoEditor,
                                    paste: onPasteValKendoEditor,
                                    change: onChangeInfoEditor
                                }">
                </textarea>
            </div>
            <span class="iv-textedit-removebtn">
                <span class="icon-16 iv-icexpand-texteditor" 
                      data-bind="events: {click: onExpandTextEditorPopup}"> </span>
                <span class="icon-16 icon-remove-blue remove-item"
                      data-bind="events:{click: removeControl}"></span>
            </span>
        </div>
        <div class="clearx2"></div>
    </div>
</script>
<script type="text/html" id="temp-info">
    <div data-bind="visible: IsVisible, events:{change: onChange}">
        <div class="clear"></div>
        <div class="col-div pull-left">
            <select class="crm-drop"
                    data-role="dropdownlist"
                    data-text-field="Name"
                    data-value-field="Id"
                    data-bind="value: CategoryId, source: src"></select>
        </div>
        <div class="col-div-2 pull-left info-value">
            <input class="modal-organ-input pull-left input-icon" data-value-update="keyup, change" data-bind="value: Value, attr: { typeCate: TypeCate}" maxlength="100">
            <span class="icon-16 icon-remove-blue pull-left remove-item" data-bind="events:{click: removeControl}"></span>
        </div>
        <div class="clearx2"></div>
    </div>
</script>

<script type="text/html" id="temp-address">
    <div data-bind="visible: IsVisible, events:{change: onChange}">
        <div class="clear"></div>
        <div class="div-row">
            <div class="col-div pull-left">
                <div class="clear35px"></div>
                <select class="crm-drop"
                        data-role="dropdownlist"
                        data-text-field="Name"
                        data-value-field="Id"
                        data-bind="value: CategoryId, source: addressCate"></select>
            </div>
            <div class="col-div pull-left">
                <label class="lable-md-organ" data-bind="text: AddressLanguageLabel.Street">Straße</label>
                <div class="clear"></div>
                <input class="modal-organ-input input-icon" data-value-update="keyup, change" data-bind="value: Street" maxlength="100">
            </div>
            <div class="col-div pull-left">
                <label class="lable-md-organ" data-bind="text: AddressLanguageLabel.Number">Nr</label>
                <div class="clear"></div>
                <input class="modal-organ-input input-icon" data-value-update="keyup, change" data-bind="value: Nr" maxlength="100">
            </div>
        </div>

        <div class="clear"></div>

                <div>
            <div class="min-height-65 col-div pull-left">
            </div>
            <div class="div-item col-div pull-left">
                <label class="lable-md-organ" data-bind="text: AddressLanguageLabel.AdditionAddress" >Additional Address</label>
                <input class="modal-add-address-input input-icon" data-value-update="keyup, change" data-bind="value: AdditionAddress" maxlength="400">
            </div>

            <div class="clear"></div>
        </div>

        <div>
            <div class="min-height-65 col-div pull-left">
            </div>
            <div class="div-item col-div pull-left">
                <label class="lable-md-organ" data-bind="text: AddressLanguageLabel.Zipcode">PLZ</label>
                <input class="modal-organ-input input-icon classPlz" data-value-update="keyup, change" data-bind="value: Plz" maxlength="6">
            </div>
            <div class="div-item col-div pull-left">
                <label class="lable-md-organ" data-bind="text: AddressLanguageLabel.Place">Ort</label>
                <input class="modal-organ-input pull-left input-icon" data-value-update="keyup, change" data-bind="value: Ort" maxlength="100">
            </div>
            <div class="clear"></div>
        </div>

        <div>
            <div class="min-height-65 col-div pull-left row-item">
            </div>
            <div class="pull-left col-div-2 row-item">
                <label class="lable-md-organ">Land</label>
                <div class="clear"></div>
                <div>
                    <select class="crm-drop pull-left"
                            data-option-label=" "
                            data-value-primitive="true"
                            data-role="dropdownlist"
                            data-text-field="Name"
                            data-value-field="Id"
                            data-bind="value: CrmLandId, source: landGroup"></select>

                    <span class="icon-16 icon-remove-blue pull-left remove-item" data-bind="events:{click: removeControl}"></span>
                    <div class="clearx2"></div>
                </div>
            </div>
        </div>
    </div>
</script>

<script id="temp-addRelationship" type="text/html">
    <div class="div-item" data-bind="visible: IsVisible">        
        <div class="pull-left col-div-32 iv-top11">
            <div class="autosearch">
                <input class="input-search"
                       data-role="autocomplete"
                       data-placeholder=""
                       data-value-field="Id"
                       data-text-field="Name"
                       data-filter="contains"
                       data-bind="value: CrmName, source: OrgSrc, events:{select: selectAutoRelationship, change: changeAutoRelationship}" />
                <span class="iconsearch"></span>
            </div>
        </div>
        <div class="pull-left col-div-32 iv-top11">
            <select class="crm-drop pull-left"
                    data-role="dropdownlist"
                    data-text-field="Name"
                    data-value-field="Id"
                    data-bind="value: CategoryId, source: CateSrc, events: {select: changeRalationship}"></select>
        </div>
        <div class="pull-left iv-relationship-box">
            <div class="dnbTextAreaEditor dnbHideScroll txtedit-relationship-box" data-bind="attr: { data-relation-crm-id: Id}">
                <textarea rows="1" class="modal-textarea" data-value-update="keyup"
                          data-role="editor" data-tools="[]"
                          data-bind="value: Note,
                                events: {
                                    keyup: changeRalationship,
                                    paste: changeRalationship,
                                    change: onChangeRelationEditor
                                }">
                </textarea>
            </div>
            <span class="iv-textedit-removebtn">
                <span class="icon-16 iv-icexpand-texteditor"
                      data-bind="events: {click: onExpandNoteRelationshipPopup}"> </span>
                <span class="icon-16 icon-remove-blue remove-item"
                      data-bind="events:{click: removeRelationship}"></span>
            </span>
        </div>
        <div class="clearx2"></div>
    </div>
</script>

<script src="../Scripts/jquery.multiple.selectwithicon.js"></script>
<!-- ReSharper disable once ClosureOnModifiedVariable -->
<!-- ReSharper disable ClosureOnModifiedVariable -->
<script type="text/javascript">
    vmEditOrg.theOrganisation = {};

    vmEditOrg.isModified = false;
    var viewModel = undefined,
        isProcessing = false;
    function addLogo() {
        $('#txtLogo').click();
    }

    var addressLanguageLabel = { Street: kLg.textStreet, Number: kLg.textNumber, Zipcode: kLg.textZipcode, Place: kLg.textPlace, AdditionAddress: kLg.AdditionAddress};

    vmEditOrg.popEditOrg.bind("close", function (e) {
        
        if (vmEditOrg.isModified) {
            if (confirm(kLg.saveConfirmQuestion)) {
                viewModel.valid();
                e.preventDefault();
            } else {
                vmEditOrg.destroyPop();
            }            
        } else {
            vmEditOrg.destroyPop();
        }
    });

    function readURL(input) {
        var reader = new FileReader();
        reader.onload = function(e) {
            $('#imgLogo').attr('src', e.target.result);
        };
        reader.readAsDataURL(input.target.files[0]);
    }

    function showLogoForm(status) {
        var imageForm = $('#div-show-logo'),
            uploadForm = $('#div-upload-logo');
        if (status) {
            uploadForm.addClass('hidden');
            if (imageForm.hasClass('hidden')) {
                imageForm.removeClass('hidden');
            }
        } else {
            if (uploadForm.hasClass('hidden')) {
                uploadForm.removeClass('hidden');
            }
            imageForm.addClass('hidden');
        }
    }

    vmEditOrg.destroyPop = function() {
        if (vmEditOrg.popEditOrg != null) vmEditOrg.popEditOrg.destroy();
        vmEditOrg.popEditOrg = null;
        $('.body-content').after('<div id="pop-edit-crm"></div>');
        vmFile.setOffMenuIcon();
        vmCommon.PopupInstance.close("org");
    };
    
    $("#txtKundenNr").change(function () {
        $('#txtKundenNr').tooltip('destroy');
    });

    var srcRelationships = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.ArtOfRelationship] || [], proOrgs = vmEditOrg.orgOptions.ProOrg, remainOrgs = [], rsIndex = 0;
    $(function () {
        vmFile.assginedIcon("pop-edit-crm", vmEditOrg.popEditOrg);
        var oldTags = [], i, oldAcc = [];

        vmEditOrg.theOrganisation = vmEditOrg.orgOptions.organisation;
        if (vmEditOrg.orgOptions.organisation.ShowKunden === "1") {
            $('#txtKundenNr').attr('readonly', true);
        }

        if (!vmEditOrg.orgOptions.IsEdit) {
            vmEditOrg.theOrganisation.Logo = '';
            remainOrgs = vmCommon.deepCopy(proOrgs);
        } else {
            vmEditOrg.theOrganisation.Logo = (vmEditOrg.theOrganisation.Logo == '') ? vmEditOrg.theOrganisation.Logo : (vmEditOrg.theOrganisation.Logo + '#' + new Date().getTime());

            if (vmEditOrg.theOrganisation.ApprovedBy) {
                vmEditOrg.theOrganisation.FullMessage = kendo.toString(vmEditOrg.theOrganisation.ApprovedDate.jsonToDate(), "d") + " " + kLg.confirmApproveBy + " " + vmEditOrg.theOrganisation.ApprovedName; 
            }

            if (vmEditOrg.theOrganisation.ModifiedDate) {
                vmEditOrg.theOrganisation.LastChange = kLg.LastChange + ": " + kendo.toString(vmEditOrg.theOrganisation.ModifiedDate.jsonToDate(), "d") + " " + vmEditOrg.theOrganisation.ModifiedName;
            }
            //Task: 6820
            //vmCommon.pushApply(oldTags, vmEditOrg.theOrganisation.CrmTags, function (item) { return item.CategoryId; });

            if (vmEditOrg.theOrganisation.CrmAddress.length > 0) {
                for (i = 0; i < vmEditOrg.theOrganisation.CrmAddress.length; i++) {
                    vmEditOrg.theOrganisation.CrmAddress[i].IsVisible = true;
                    vmEditOrg.theOrganisation.CrmAddress[i].TypeCate = vmCrmEnum.OrganisationSetting.Address;
                    vmEditOrg.theOrganisation.CrmAddress[i].DataState = dataState.Unchanged;
                }
            }

            var relas = vmEditOrg.theOrganisation.CrmRelationships;
            var selectedCrmIds = vmCommon.selectProperty(relas, "CrmId");
            remainOrgs = $.grep(proOrgs, function(it) { return selectedCrmIds.indexOf(it.Id) === -1; });

            for (var j = 0; j < relas.length; j++) {
                var item = relas[j];
                item.CateSrc = srcRelationships;

                var tempSrc = $.grep(vmCommon.deepCopy(selectedCrmIds), function (it) { return it !== item.CrmId; });
                item.OrgSrc = $.grep(proOrgs, function (it) { return tempSrc.indexOf(it.Id) === -1; });
            }
            rsIndex = relas.length > 0 ? relas.last().MIndex : 0;
        }

        //Task: 6820
        var tagGroup = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Tags];
        for (var i = 0; i < tagGroup.length; i++) {
            if ($.grep(vmEditOrg.theOrganisation.CrmTags, function (it) { return it.CategoryId == tagGroup[i].Id; }).length > 0) {
                oldTags.push(tagGroup[i]);
            }
        }
        var accs = vmEditOrg.orgOptions.accounts;
        for (i = 0; i < accs.length; i++) {
            if ($.grep(vmEditOrg.theOrganisation.Responsibility, function (it) { return it.AccountId == accs[i].Id; }).length > 0) {
                oldAcc.push(accs[i]);
            }
        }
        function getCreatedDate(organisation) {
            var createDate = organisation.CreatedDate;
            if (Object.prototype.toString.call(createDate) === "[object Date]")
                return createDate;

            if (createDate && typeof createDate == 'string') {
                if (createDate.includes('-')) {
                    organisation.CreatedDate = new Date();
                    return organisation.CreatedDate;
                } else {
                    return createDate.jsonToDate();
                }
            }
            organisation.CreatedDate = new Date();
            return organisation.CreatedDate;
        }
        var isSelectRelationship = false;
        viewModel = kendo.observable({
            AddressLanguageLabel: addressLanguageLabel,
            organisation: vmEditOrg.theOrganisation,
            categories: vmEditOrg.Cate,
            infoGroup: vmEditOrg.orgOptions.infoGroup,
            branchGroup: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Branch],
            legalFormGroup: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.LegalForm],
            employeeGroup: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Employee],
            revenueGroup: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Revenue],
            accounts: vmEditOrg.orgOptions.accounts,
            tagGroup: tagGroup,
            landGroup: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Land],
            addressCate: vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Address],
            oldAcc: oldAcc,

            multiSelectFiltering: function (e) {
                var filter = e.filter;
                if (filter) {
                    filter.value = filter.value.replace(/\s\s+/g, ' ');
                    if (filter.value.indexOf(' ') == 0) {
                        filter.value = filter.value.slice(1);
                    };
                    e.sender.input.val(filter.value);
                };
               
            },

            onChangeAccount: function () {
                var listAcc = vmCommon.deepCopy(this.get("oldAcc")).sort(SortByLastName);
                viewModel.set("oldAcc", listAcc);
            },

            selectAutoRelationship: function (e) {
                isSelectRelationship = true;
                e.data.set("CrmId", e.dataItem.Id);
                if (e.data.Id > 0) e.data.set("DataState", dataState.Modified);

                remainOrgs = $.grep(remainOrgs, function (it) { return it.Id !== e.data.CrmId; });
                var relas = this.organisation.CrmRelationships;
                for (var i = 0; i < relas.length; i++) {
                    if (relas[i] !== e.data)
                        relas[i].set("OrgSrc", $.grep(relas[i].OrgSrc, function (it) { return it.Id !== e.data.CrmId; }));
                }
            },
            changeAutoRelationship: function (e) {
                if (isSelectRelationship) {
                    $(e.sender.element).closest("div.div-item").find("span.remove-item").tooltip("destroy");
                    isSelectRelationship = false;
                    return;
                }

                if (e.data.CrmId) {
                    var item = vmCommon.findById(e.data.CrmId, proOrgs);
                    if (item) {
                        remainOrgs.push(vmCommon.deepCopy(item));

                        var relas = this.organisation.CrmRelationships;
                        for (var i = 0; i < relas.length; i++) {
                            var src = relas[i].OrgSrc;
                            if (vmCommon.findById(e.data.CrmId, src)) continue;

                            src.push(vmCommon.deepCopy(item));
                        }
                    }
                }

                ShowToolTip2($(e.sender.element).closest("div.div-item").find("span.remove-item"), kLg.InvalidData, "right");
                e.data.set("CrmId", 0);
            },
            onChangeNoteEditor: function (e) {
                var dataItem = e.data.organisation;
                let innerText = e.sender.body.innerText.trim();
                let isHasImg = e.sender.body.innerHTML.includes('<img ');
                var newHTMLValue = vmCommon.getClearAttrNotNeed(e.sender.body.innerHTML);
                if (innerText == '' && !isHasImg) {
                    dataItem.set('Note', '');
                } else
                    dataItem.set('Note', newHTMLValue);
            },
            onKeyUpChangeNoteEditor: function (e) {
                
                vmEditOrg.isModified = true;
            },
            onChangeInfoEditor: function (e) {
                var dataItem = e.data;
                let innerText = e.sender.body.innerText.trim();
                let isHasImg = e.sender.body.innerHTML.includes('<img ');

                var newHTMLValue = vmCommon.getClearAttrNotNeed(e.sender.body.innerHTML);
                
                if (innerText == '' && !isHasImg) {
                    dataItem.set('Value', '');
                } else
                    dataItem.set('Value', newHTMLValue);
            },
            onKeyUpChangeValKendoEditor: function (e) {
                this.onChange(e);
            },
            onPasteValKendoEditor: function (e) {
                this.onChange(e);
            },
            onExpandTextEditorPopup: function (e) {
                var dataItem = e.data, SaveBtn;
                var createdDate = getCreatedDate(this.organisation);
                if (dataItem.Id > 0) {
                    SaveBtn = function (newValue) {
                        
                        if (dataItem.Value == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        if (dataItem.Id > 0) {
                            dataItem.set('Value', newHTMLValue);                 // run viewModel.bind('change')
                            dataItem.set('DataState', dataState.Unchanged);             // run viewModel.bind('change')
                            var newInfos = vmViewOrg.viewModel.infos.filter(info => {
                                if (info.Id == dataItem.Id) {
                                    info.Value = newHTMLValue;
                                }
                                return true;
                            });
                            vmViewOrg.viewModel.set('infos', newInfos);

                            vmEditOrg.dataservice.updateInfoFromEditorPopup({ Id: dataItem.Id, Value: newHTMLValue }, function (res) {
                                vmEditOrg.isModified = true;
                            });
                        } else if (dataItem.Id < 0) {
                            dataItem.set('Value', newHTMLValue);                 // run viewModel.bind('change')
                        }
                    }
                }

                vmCommon.TexEditor.addWindowEditor(`[data-crm-id="${dataItem.Id}"]`,
                    SaveBtn,
                    function Close(newValue) {
                        if (dataItem.Value == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        if (dataItem.Id > 0) {
                            setValue(newHTMLValue);                 // run viewModel.bind('change')
                            dataItem.set('DataState', dataState.Modified);             // run viewModel.bind('change')
                        } else if (dataItem.Id < 0) {
                            setValue(newHTMLValue);                 // run viewModel.bind('change')
                        }

                        function setValue(newValue) {
                            if (newValue.trim() == '' && !vmCommon.TexEditor.hasImg(newValue)) {
                                dataItem.set('Value', '');
                            } else
                                dataItem.set('Value', newValue);
                        }
                    }, createdDate
                );
            },
            onExpandNotesPopup: function (e) {
                var dataItem = e.data.organisation; 
                var fakeOrgId = -(Date.now()), SaveBtn;
                var createdDate = getCreatedDate(this.organisation);
                if (dataItem.Id < 1) {
                    fakeOrgId = '-crmOrgNotes';
                    $(`[data-crm-id="crmOrgNotes"]`).attr('data-crm-id', fakeOrgId);
                    
                } else {
                    fakeOrgId = 'crmOrgNotes';
                    SaveBtn = function (newValue) {
                        if (dataItem.Note == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        dataItem.set('Note', newHTMLValue);

                        var org = {
                            Id: dataItem.Id, Note: newHTMLValue
                        }
                        vmEditOrg.dataservice.updateOrgNoteEditorPopup(org, function (res) {
                            vmEditOrg.isModified = true;
                        });
                    };
                };

                vmCommon.TexEditor.addWindowEditor(`[data-crm-id="${fakeOrgId}"]`,
                    SaveBtn,
                    function Close(newValue) {
                        if (dataItem.Note == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        if (newHTMLValue.trim() == '' && !vmCommon.TexEditor.hasImg(newHTMLValue)) {
                            dataItem.set('Note', '');
                        } else
                            dataItem.set('Note', newHTMLValue);                 // run viewModel.bind('change')
                    }, createdDate
                );
            },
            onExpandNoteRelationshipPopup: function (e) {
                var dataItem = e.data, SaveBtn;
                var createdDate = getCreatedDate(this.organisation);
                if (dataItem.Id > 0) {
                    SaveBtn = function (newValue) {

                        if (dataItem.Note == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        dataItem.set('Note', newHTMLValue);

                        var org = {
                            Id: dataItem.Id, Note: newHTMLValue
                        }
                        vmEditOrg.dataservice.updateRelationshipNotePopup(org, function (res) {
                            vmEditOrg.isModified = true;
                        });
                    }
                }

                vmCommon.TexEditor.addWindowEditor(`[data-relation-crm-id="${dataItem.Id}"]`,
                    SaveBtn,
                    function Close(newValue) {
                        if (dataItem.Note == newValue) {
                            return;
                        }
                        var newHTMLValue = vmCommon.getClearAttrNotNeed(newValue);
                        if (newHTMLValue.trim() == '' && !vmCommon.TexEditor.hasImg(newHTMLValue)) {
                            dataItem.set('Note', '');
                        } else
                            dataItem.set('Note', newHTMLValue);                 // run viewModel.bind('change')
                    }, createdDate
                );
            },
            onChangeRelationEditor: function (e) {
                var dataItem = e.data;
                let isHasImg = e.sender.body.innerHTML.includes('<img ');
                var newHTMLValue = vmCommon.getClearAttrNotNeed(e.sender.body.innerHTML);
                if (e.sender.body.innerText.trim() == '' && !isHasImg) {
                    dataItem.set('Note', '');
                } else
                    dataItem.set('Note', newHTMLValue);
            },
            changeRalationship: function (e) {
                if (e.data.Id > 0) e.data.set("DataState", dataState.Modified);
            },
            addRelationship: function () {
                if (srcRelationships.length === 0) { // || proOrgs.length === 0
                    pAlert(kLg.msgNotExistSetting); return;
                }
                var newItem = {
                    Id: -(Date.now()),  // use for text-editor
                    CrmOrganisationId: this.organisation.Id,
                    CrmId: 0, CrmName: "", CategoryId: srcRelationships[0].Id,
                    DataState: dataState.Added, IsVisible: true,
                    CateSrc: srcRelationships, OrgSrc: remainOrgs,
                    Note: "", MIndex: ++rsIndex
                }
                this.organisation.CrmRelationships.push(newItem);
                setupTabIndex();
            },
            removeRelationship: function (e) {
                var src = this.organisation.CrmRelationships;
                var index = src.indexOf(e.data);
                
                if (e.data.Id < 1) {
                    src.splice(index, 1);
                } else {
                    e.data.set("IsVisible", false);
                    e.data.set("DataState", dataState.Deleted);
                }

                if (e.data.CrmId) {
                    var item = vmCommon.findById(e.data.CrmId, proOrgs);
                    if (item) {
                        remainOrgs.push(vmCommon.deepCopy(item));

                        var relas = this.organisation.CrmRelationships;
                        for (var i = 0; i < relas.length; i++) {
                            relas[i].OrgSrc.push(vmCommon.deepCopy(item));
                        }
                    }
                }
                setupTabIndex();
            },
            oldTags: oldTags,
            deleteLogo: function (e) {
                this.organisation.set("Logo", "");
                $('#txtLogo').val('');
                showLogoForm(false);
            },
            changeLogo: function (e) {
                if (e.target.value != "") {
                    readURL(e);
                    showLogoForm(true);
                }
            },
            addControl: function (e) {
                addOrgControl(e.target.id);
                vmEditOrg.reCheckEmail();
                setupTabIndex();
            },
            removeControl: function (e) {
                removeOrgControl(e.data);
                vmEditOrg.reCheckEmail();
                setupTabIndex();
            },
            onChange: function (e) {
                if (e.data.Id > 0) {
                    e.data.set("DataState", dataState.Modified);
                }
            },
            valid: function () {
                if (vmEditOrg.isModified || !vmEditOrg.orgOptions.IsEdit) {
                    if (vmEditOrg.validForm() && vmEditOrg.isValidEmail() && vmEditOrg.validRelationShip()) {
                        if (isProcessing) return;

                        isProcessing = true;

                        var newName = this.organisation.Name.trim();
                        if (this.organisation.Id && newName !== vmEditOrg.theOrganisation.Name) {
                            vmEditOrg.dataservice.validName({ Id: this.organisation.Id, Name: this.organisation.Name.trim() }, function (res) {
                                if (res.value === 1) {
                                    vmEditOrg.isModified = false;
                                    viewModel.update();
                                } else {
                                    vmCommon.showTooltip($("#edit-form-organisation #txtName"), kLg.msgDuplicateName, 3000);
                                }

                                isProcessing = false;
                            });
                        } else {
                            viewModel.update();
                        }

                    } else {
                        isProcessing = false;
                    }
                } else {
                    vmEditOrg.destroyPop();
                }

            },
            update: function (e) {
                var file = $('#txtLogo').prop('files');

                if (file.length > 0) {
                    var data = new FormData();
                    var logoname = vmCommon.newGuid() + "." + getFileExtention(file[0].name);
                    data.append("logo", file[0]);
                    data.append("logoname", logoname);
                    this.organisation.set("Logo", vmEditOrg.LogoPath + logoname);

                    if (typeof vmViewOrg == 'object' && typeof vmViewOrg.viewModel == 'object') {
                        vmViewOrg.viewModel.set("currentorg.logo", vmEditOrg.LogoPath + logoname);
                    }

                    var url = "../Handlers/CrmOrganisationHandler.ashx?funcName=savelogo&projid=" + projectId + "&strid=" + strategyId;
                    vmCommon.sendFile(url, data, null);
                }

                if (this.organisation.Logo) {
                    var xIndex = this.organisation.Logo.indexOf("#");
                    if (xIndex > 0) {
                        this.organisation.Logo = this.organisation.Logo.substring(0, xIndex);
                    }
                }

                setupCrmInfo(this.infoGroup);

                var listTags = vmCommon.pushApply([], this.oldTags, function (item) { return { CategoryId: item.Id }; });
                this.organisation.set("CrmTags", listTags);

                var listResponsibility = vmCommon.pushApply([], this.oldAcc, function (item) { return { AccountId: item.Id }; });
                this.organisation.set("Responsibility", listResponsibility);

                var theOrg = this.organisation;
                filterElementOrgChanged(theOrg);

                var funcname = vmEditOrg.orgOptions.IsEdit ? "update" : "create";

                //save organisation
                vmEditOrg.isModified = false;

                var orgname = { ProjectId: projectId, OrgId: theOrg.Id, Name: theOrg.Name};
                vmEditOrg.dataservice.checkNameOrg(orgname, function (resName) {
                    if (resName.value.IsExisted) {
                        ShowToolTip2($("#txtName"), kLg.msgOrgNameExisted, "top");
                        isProcessing = false;
                        vmEditOrg.isModified = true;
                        return;
                    }
                    // #region vefiry html attr/tags
                    
                    var newHTMLValue = vmCommon.getClearAttrNotNeed(theOrg.Note);
                    theOrg.Note = newHTMLValue;
                    theOrg.CrmRelationships.filter(crmRlsh => {
                        if (crmRlsh.Id < 0) {
                            crmRlsh.Id = 0;
                        }
                        newHTMLValue = vmCommon.getClearAttrNotNeed(crmRlsh.Note);
                        crmRlsh.Note = newHTMLValue;
                        return true;
                    });
                    // endregion
                    vmEditOrg.dataservice.saveorganisation(funcname, theOrg, function (res) {
                        if (Number(res.value) == vmCrmEnum.ResultStatus.CONFLICT) {
                            pAlert(kLg.msgConflickData);
                            isProcessing = false;
                            return;
                        }

                        if (Number(res.value) === vmCrmEnum.ResultStatus.DUPLICATE) {
                            ShowToolTip($('#txtKundenNr'), kLg.titleKundenNrExist, "top");
                            isProcessing = false;
                            return;
                        } else {
                            vmCrmFilterControl.reloadfilter(res.value, vmCrmEnum.SettingType.Organisation);
                        }

                        vmEditOrg.destroyPop();
                    });
                });

            },
            formChange: function () {
                vmEditOrg.isModified = true;
            },
            activeModelChange: function() {
                vmEditOrg.isModified = true;
            },
            confirmAddress: function () {
                pConfirm(kLg.confirmApproveAddress).then(function() {
                    viewModel.organisation.set("IsApproved", true);
                    viewModel.organisation.set("IsChangeApproved", true);
                    var fullMessage = kendo.toString(kendo.date.today(), "d") + " " + kLg.confirmApproveBy + " " + vmUser.currentAccount.Name;
                    viewModel.organisation.set("FullMessage", fullMessage);
                    
                });
            }
        });
        viewModel.bind('change', function () {
            vmEditOrg.isModified = true;
        });
        
        kendo.bind($('#edit-form-organisation'), viewModel);
        $('.classPlz').preventPressAlphabetChar();
        getCreatedDate(viewModel.organisation);
        var isHasLogo = (vmEditOrg.theOrganisation.Logo != undefined && vmEditOrg.theOrganisation.Logo != '');
        showLogoForm(isHasLogo);

        vmEditOrg.setupLanguage();
        limitedTabKey();
        $('#edit-form-organisation #txtName').focus();
                
        var maxTabindex = setupTabIndex();
        setTimeout(function () {
            $('#pop-edit-crm_wnd_title').parent().find('.k-window-actions > a').attr('tabindex', ++maxTabindex);
        }, 1000);

        void function setupOverflow() {
            $('.dnbTextAreaEditor.dnbHideScroll > table.k-editor .k-editable-area').find('textarea').each(function () {
                $($(this).data('kendoEditor').body).css({
                    'overflow': 'hidden', 'padding-top': '9px'
                })
            });

            var bodyTxtEditor = $('.dnbTextAreaEditor[data-crm-id="crmOrgNotes"] > table.k-editor .k-editable-area').find('textarea').data('kendoEditor').body;
            $(bodyTxtEditor).css({ 'overflow-y': 'scroll' });
        }();
    });

    function setupTabIndex() {
        var selector = 'input:visible,.k-dropdown:visible, textarea:visible, button:visible, .k-multiselect-wrap';
        var n = 0;
        var tab0 = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #address-control'), 1, function ($this, tabindex, _index) {
            if (_index > 5 && (_index) / 7 == 1) {
                n = (_index) / 7;                
                tabindex++;
            };
            var index = _index - 7 * n;
            switch (index) {
                case 0:
                case 1:
                case 2:
                    $this.attr('tabindex', tabindex);
                    break;
                case 3:
                    $this.attr('tabindex', ++tabindex);
                    tabindex++;
                    break;
                case 4:
                case 5:
                    $this.attr('tabindex', tabindex);
                    break;
                default:
                    $this.attr('tabindex', ++tabindex);
                    break;
            };
            return tabindex;
        });

        var tbb = 0;
        if ($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #address-control').find(selector).length < 1) {
            tbb = 1;
        } else if ($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #address-control').find(selector).length < 8) {
            if ($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #phone-control').find(selector).length < 1) tbb = 6;
            else tbb = 5;
        } else {
            tbb = tab0;
        }
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #phone-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });            
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #fax-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #email-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #website-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });   
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #network-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });  
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #resource-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });   
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #competence-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });   
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #category-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 2 === 1) tabindex++;
            return tabindex;
        });   
        tbb = setupTabindexColumn($('#edit-form-organisation > .modal-body.ms-modal-body .col-div-60.pull-left:eq(1) #relationPer-control'), tbb, function ($this, tabindex, index) {
            $this.attr('tabindex', tabindex);
            if ((index + 1) / 3 === 1) tabindex++;
            return tabindex;
        });            

        // .crm-custom-tabindex
        var tab1 = setupTabindexColumn($('#pop-edit-crm #lblLegalForm').closest('.col-div-50.pull-left'), 1);
        var tab2 = setupTabindexColumn($('#pop-edit-crm #lblBranch').closest('.col-div-50.pull-left'), 1);
        tab1 = tab1 > tab2 ? tab1 : tab2;
        
        tab1 = setupTabindexColumn($('#pop-edit-crm #lblTag').parent(), tab1);
        tab1 = setupTabindexColumn($('#pop-edit-crm #lblNotes').parent(), tab1);

        tab1 = tab1 > tbb ? tab1 : tbb;
        tab1 = setupTabindexColumn($('#pop-edit-crm .modal-market-footer'), tab1);

        if ($('#txtKundenNr').prop('readonly')) {
            $('#txtKundenNr').attr('tabindex', '-1');
        }

        function setupTabindexColumn($ParentSelector, startIndex, fcn ) {
            var selector = 'input:visible,.k-dropdown:visible, textarea:visible, button:visible, .k-multiselect-wrap',
                tabindex = startIndex;

            $ParentSelector.find(selector).each(function (index) {
                if (fcn)
                    tabindex = fcn($(this), tabindex, index);
                else
                    $(this).attr('tabindex', tabindex++);
            });

            return tabindex;
        }
        return tab0 > tab1 ? tab0 : tab1;
    }

    function setupCrmInfo(infoGroup) {
        var listInfo = [];
        
        var newHTMLValue = '';
        infoGroup.resource.filter(rs => {
            if (rs.Id < 0) {
                rs.Id = 0;
            }
            newHTMLValue = vmCommon.getClearAttrNotNeed(rs.Value);
            rs.Value = newHTMLValue;
            return true;
        });
        infoGroup.competence.filter(ctc => {
            if (ctc.Id < 0) {
                ctc.Id = 0;
            }
            newHTMLValue = vmCommon.getClearAttrNotNeed(ctc.Value);
            ctc.Value = newHTMLValue;
            return true;
        });
        infoGroup.category.filter(cate => {
            if (cate.Id < 0) {
                cate.Id = 0;
            }
            newHTMLValue = vmCommon.getClearAttrNotNeed(cate.Value);
            cate.Value = newHTMLValue;
            return true;
        });

        vmCommon.pushApply(listInfo, infoGroup.telephone);
        vmCommon.pushApply(listInfo, infoGroup.fax);
        vmCommon.pushApply(listInfo, infoGroup.email);
        vmCommon.pushApply(listInfo, infoGroup.website);
        vmCommon.pushApply(listInfo, infoGroup.network);
        vmCommon.pushApply(listInfo, infoGroup.resource);
        vmCommon.pushApply(listInfo, infoGroup.competence);
        vmCommon.pushApply(listInfo, infoGroup.category);

        viewModel.organisation.set("CrmInformations", listInfo);
    }

    function removeOrgControl(ctrl) {
        var catetype = ctrl.get("TypeCate");
        var index, listInfo = [];
        switch (catetype) {
            case vmCrmEnum.OrganisationSetting.Address:
                listInfo = viewModel.organisation.CrmAddress;
                break;
            case vmCrmEnum.OrganisationSetting.Telephone:
                listInfo = viewModel.infoGroup.telephone;
                break;
            case vmCrmEnum.OrganisationSetting.Fax:
                listInfo = viewModel.infoGroup.fax;
                break;
            case vmCrmEnum.OrganisationSetting.Email:
                listInfo = viewModel.infoGroup.email;
                break;
            case vmCrmEnum.OrganisationSetting.Website:
                listInfo = viewModel.infoGroup.website;
                break;
            case vmCrmEnum.OrganisationSetting.Network:
                listInfo = viewModel.infoGroup.network;
                break;
            case vmCrmEnum.OrganisationSetting.Resource:
                listInfo = viewModel.infoGroup.resource;
                break;
            case vmCrmEnum.OrganisationSetting.Competence:
                listInfo = viewModel.infoGroup.competence;
                break;
            case vmCrmEnum.OrganisationSetting.Category:
                listInfo = viewModel.infoGroup.category;
                break;
        }

        index = listInfo.indexOf(ctrl);
        if (listInfo[index].Id < 1) {
            listInfo.splice(index, 1);
        } else {
            listInfo[index].set("IsVisible", false);
            listInfo[index].set("DataState", dataState.Deleted);
        }
    }
    
    function addOrgControl(id) {
        if (id == "linkAddAddress") {
            if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Address].length == 0 || vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Land].length == 0) { pAlert(kLg.msgNotExistSetting); return; }
            var addressItem = { Id: 0, CategoryId: -1, Street: '', Nr: '', Plz: '', Ort: '',AdditionAddress: '', CrmLandId: -1, DataState: dataState.Added, TypeCate: vmCrmEnum.OrganisationSetting.Address, IsVisible: true }
            addressItem.CategoryId = viewModel.addressCate[0].Id;
            viewModel.organisation.CrmAddress.push(addressItem);
            $('.classPlz').preventPressAlphabetChar();

        } else {
            var infoItem = { Id: 0, CategoryId: -1, Value: '', TypeCate: -1, DataState: dataState.Added, IsVisible: true };
            switch (id) {
                case "linkAddTelephone":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Telephone].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Telephone];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Telephone;
                        viewModel.infoGroup.telephone.push(infoItem);
                        break;
                    }
                case "linkAddFax":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Fax].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Fax];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Fax;
                        viewModel.infoGroup.fax.push(infoItem);
                        break;
                    }
                case "linkAddEmail":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Email].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Email];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Email;
                        viewModel.infoGroup.email.push(infoItem);
                        break;
                    }
                case "linkAddWebsite":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Website].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Website];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Website;
                        viewModel.infoGroup.website.push(infoItem);
                        break;
                    }
                case "linkAddNetwork":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Network].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Network];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Network;
                        viewModel.infoGroup.network.push(infoItem);
                        break;
                    }
                case "linkAddResource":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Resource].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Resource];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Resource;
                        infoItem.Id = -(Date.now());  // use for text-editor
                        viewModel.infoGroup.resource.push(infoItem);
                        break;
                    }
                case "linkAddCompetence":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Competence].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Competence];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Competence;
                        infoItem.Id = -(Date.now());  // use for text-editor
                        viewModel.infoGroup.competence.push(infoItem);
                        break;
                    }
                case "linkAddCategory":
                    {
                        if (vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Category].length == 0) { pAlert(kLg.msgNotExistSetting); break; }
                        infoItem.src = vmEditOrg.Cate[vmCrmEnum.OrganisationSetting.Category];
                        infoItem.CategoryId = infoItem.src[0].Id;
                        infoItem.TypeCate = vmCrmEnum.OrganisationSetting.Category;
                        infoItem.Id = -(Date.now());  // use for text-editor
                        viewModel.infoGroup.category.push(infoItem);
                        break;
                    }
            }
        }

    };

    $('#edit-form-organisation #txtName').bind('keydown', function () {
        $(this).tooltip('destroy');
    });

    $('#edit-form-organisation').on("change", 'input[typecate="' + vmCrmEnum.OrganisationSetting.Email + '"]', function (e) {
        vmCommon.CheckEmail(this, kLg.msgInvalidEmail, "right");
    });

    function modifiedForm() {
        vmEditOrg.isModified = true;
    }

    function filterElementOrgChanged(org) {
        org.KundenNr = org.KundenNr.trim();
        var i;
        // 1. Informations
        if (org.CrmInformations.length > 0) {
            var infos = org.CrmInformations;
            if (infos.length > 0) {
                for (i = infos.length - 1; i >= 0 ; i--) {
                    if ((infos[i].Id == 0 && infos[i].Value == '' && !vmEditOrg.isAllowEmpty(infos[i].TypeCate)) || (infos[i].Id != 0 && infos[i].Value == '' && infos[i].DataState != dataState.Deleted && !vmEditOrg.isAllowEmpty(infos[i].TypeCate))) {
                        infos.splice(i, 1);
                    }
                }
            }
        }

        // 2. Address
        if (org.CrmAddress.length > 0) {
            var adds = org.CrmAddress;
            for (i = adds.length - 1; i >= 0 ; i--) {
                if ((adds[i].Id == 0 && adds[i].Street == "" && adds[i].Nr == "" && adds[i].Plz == "" && adds[i].Ort == "" && adds[i].AdditionAddress == "" && adds[i].CrmLandId <= 0) ||
                    (adds[i].Id != 0 && adds[i].Street == "" && adds[i].Nr == "" && adds[i].Plz == "" && adds[i].Ort == "" && adds[i].AdditionAddress == "" && adds[i].CrmLandId <= 0 && adds[i].DataState != dataState.Deleted)) {
                    adds.splice(i, 1);
                }
            }
        }

        return org;
    };

    vmEditOrg.isAllowEmpty = function(typeCate) {
        switch (typeCate) {
        case vmCrmEnum.OrganisationSetting.Category:
        case vmCrmEnum.OrganisationSetting.Competence:
        case vmCrmEnum.OrganisationSetting.Resource:
        case vmCrmEnum.OrganisationSetting.Network:
            return true;
        default:
            return false;
        }
    };

    vmEditOrg.isValidEmail = function () {
        var lst = $("#edit-form-organisation input[typecate=" + vmCrmEnum.OrganisationSetting.Email + "]:visible");
        var rs = true;
        for (var i = lst.length - 1; i >= 0; i--) {
            var it = lst[i];
            if (!vmCommon.CheckEmail($(it), kLg.msgInvalidEmail, "right")) {
                rs = false;
            }
        }

        return rs;
    };

    vmEditOrg.reCheckEmail = function () {
        var lst = $("#edit-form-organisation input[typecate=" + vmCrmEnum.OrganisationSetting.Email + "]:visible");
        var rs = true;
        for (var i = lst.length - 1; i >= 0; i--) {
            var it = $(lst[i]);
            if (it.parent().has("div[class~='tooltip']").length > 0) {
                if (!vmCommon.CheckEmail2(it, kLg.msgInvalidEmail, "right")) {
                    rs = false;
                }
            }
        }

        return rs;
    };

    vmEditOrg.validRelationShip = function() {
        if (!viewModel) return true;

        var lst = viewModel.organisation.CrmRelationships.filter(cr => { return cr.DataState != dataState.Deleted });
        if (lst == undefined || lst.length === 0) return true;

        var flag = true;
        for (var i = 0; i < lst.length; i++) {
            if (lst[i].CrmId > 0) continue;

            flag = false;
            var iconX = $("#relationPer-control").children("div.div-item:eq(" + i + ")").find("span.remove-item");
            if (iconX.length === 0) continue;

            ShowToolTip2($(iconX), kLg.InvalidData, "right");
        }

        return flag;
    };


</script>
<!-- ReSharper restore ClosureOnModifiedVariable -->