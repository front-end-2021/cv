<style type="text/css">
    table.fibutable {
        border-collapse: collapse;
        margin: 10px 10px 30px -8px;
        max-width: 100% !important;
        background-color: transparent !important;
        height: 0 !important;
    }

        table.fibutable tr td {
            width: 180px;
            padding: 10px 0 0 20px;
        }

            table.fibutable tr td span {
                font-weight: bold;
            }

            table.fibutable tr td select {
                display: block;
                width: 90%;
            }

            table.fibutable tr td span.fibuBG {
                background: #76838a;
                display: block;
                width: 98%;
                padding: 5px 0 0 9px;
                height: 30px;
                color: white;
            }

    table.fibukontentable {
        border-collapse: collapse;
        border: 1px solid #E7E7E7;
    }

        table.fibukontentable tr td {
            width: 100px;
            padding-left: 3px;
        }

    .borderRightGray {
        border-right: 1px solid #E7E7E7;
    }

    .borderBottomGray {
        border-bottom: 1px solid #E7E7E7;
    }

    .inputFibu {
        border: 1px solid #E7E7E7;
        background-color: #F7F7F7;
        height: 30px;
        width: 145px;
        margin-left: 10px;
        padding-left: 5px;
        margin-bottom: 5px;
        resize: none;
    }

    .inputFibuTop {
        border: 1px solid #E7E7E7;
        background-color: #F7F7F7;
        height: 30px;
        width: 156px;
        padding-left: 5px;
        margin-bottom: 5px;
        margin-left: -15px;
        resize: none;
    }

    .fibu .ms-dropdow {
        position: absolute;
        right: 0;
    }

    .fibu:hover .icon-dropdow {
        background-position: -81px -299px;
        text-indent: -999px;
        float: right;
        display: block;
        width: 20px;
        height: 20px;
        margin-top: 0px;
    }

    .fibu .icon-dropdow {
        display: none;
        position: absolute;
        right: 2px;
        top: 3px;
    }

    .kosten .ms-dropdow {
        position: absolute;
        right: 0;
    }

    .kosten:hover .icon-dropdow {
        background-position: -81px -299px;
        text-indent: -999px;
        float: right;
        display: block;
        width: 20px;
        height: 20px;
        margin-top: 0px;
    }

    .kosten .icon-dropdow {
        display: none;
        position: absolute;
        right: 2px;
        top: 3px;
    }

    .icon-pd-open {
        content: url(/Images/active-header24.png);
        vertical-align: middle;
        display: inline-block;
    }

    .categoryName {
        border: 1px solid #E7E7E7;
        background-color: #F7F7F7;
        height: 30px;
        width: 350px;
        margin-left: 10px;
        padding-left: 5px;
        margin-bottom: 5px;
        resize: none;
    }

    .lblIOD {
        color: #3a3434;
        padding-right: 20px;
        font-weight: 500;
    }

    .panel-heading-mass-parent-setting {
        background-color: #33a6dc !important;
        background-image: none !important;
        height: 16px;
        font-size: 18px;
        color: #FFFFFF !important;
        text-decoration: none !important;
    }

    .panel-heading-mass-format {
        background-color: #38baf8 !important;
        background-image: none !important;
        height: 16px;
        font-size: 18px;
        color: #FFFFFF !important;
        text-decoration: none !important;
    }

    #place-kpi19 td {
        height: 35px;
        padding-left: 5px;
        font-weight: normal;
        border: 1px solid #e7e7e7;
    }

    #place-kpi19 th {
        color: white;
        height: 35px;
        padding-left: 5px;
        background-color: #999999;
        border: 1px solid white;
        font-weight: normal;
        padding-right: 22px;
    }

    .padding-td-unit {
        padding-left: 20px;
        padding-right: 10px
    }

    .error-star-topic {
        color: red;
        margin-top: 6px;
        font-size: 22px;
        display: none;
        position: absolute;
        left: -10px;
        top: 3px;
    }

    tr.ui-sortable-helper {
        width: 100% !important;
    }

    #pop-kpisettingindex td {
        height: 35px;
        padding-left: 5px;
        font-weight: normal;
        border: 1px solid #e7e7e7;
    }

    #pop-kpisettingindex th {
        color: white;
        height: 35px;
        padding-left: 5px;
        background-color: #999999;
        border: 1px solid white;
        font-weight: normal;
        padding-right: 22px;
    }

    .overflow-hidden {
        overflow: hidden;
    }

    #pop-kpisettingindex table.modal-table-mass td {
        border: none;
    }

    .formatfile {
        margin-bottom: 2px;
    }

    .crmlink-item, .formatfile-item {
        margin-right: 3px;
        margin-top: 2px;
        padding: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,.2), 0 2px 3px rgba(0,0,0,.05);
        padding-bottom: 5px;
        display: inline-flex;
    }

    .goal-truncate {
        height: 17px;
        overflow: hidden;
        /*text-overflow: ellipsis;*/
        white-space: nowrap;
        display: inline-block;
        max-width: 152px;
    }

    #pop-kpisettingindex .td-expected .k-numerictextbox .k-input {
        width: 166px !important;
        padding-right: 3px !important;
    }

    #pop-kpisettingindex .tblformat span.k-numerictextbox.formatinput {
        width: 175px !important;
        padding-left: 0 !important;
    }

        #pop-kpisettingindex .tblformat span.k-numerictextbox.formatinput input.k-input {
            width: 163px !important;
        }

    .crmlink {
        margin-bottom: 5px;
    }

    .tdUnit {
        overflow: hidden;
        white-space: nowrap;
        max-width: 115px;
    }

    .smp-button-upload {
        float: left;
        margin-top: 10px;
    }

        .smp-button-upload span {
            float: left;
        }

    div.k-animation-container div.k-notification-wrap span.k-i-close {
        display: none;
    }

    div.k-animation-container div.k-notification-wrap .k-i-note {
        display: none;
    }

    .k-widget.k-notification.k-notification-info {
        background-color: #38baf8;
        border-color: #38baf8;
    }

    div#hoand-k-notification-8290 {
        display: inline-block;
        padding-left: 3px;
        padding-bottom: -5px;
    }

    #place-categories1 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories2 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories3 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories6 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories7 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories8 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories14 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time,
    #place-categories15 > .table-bordered > tbody td.td-v-align-top > div.itemDraggable > span.text-justify-time {
        max-width: 653px;
    }

    #pop-setting > #pop-setting-place .panel-title input.cssCategories {
        margin-top: -26px;
        height: 22px;
    }

    #pop-setting > #pop-setting-place .panel-title .cssCategories:hover {
        text-decoration: underline;
        cursor: pointer;
    }

    #pop-setting > #pop-setting-place .panel-title input.cssKpiCategories {
        margin-top: -26px;
        height: 22px;
    }

    #pop-setting > #pop-setting-place .panel-title span.cssCategories {
        max-height: 22px;
        overflow: hidden;
        display: inline-block;
        max-width: 690px;
    }

    #pop-setting .title-oneline-settings {
        display: inline-block;
        overflow: hidden;
        max-height: 16px;
    }

    #pop-setting .ProductClickEdit {
        float: left;
        max-width: 700px;
        overflow: hidden;
    }

    #categories24 {
        overflow: hidden;
    }

    #categories-view24 .view-container {
        width: 750px;
        max-width: 750px;
        padding: 33px 7px 50px 7px !important;
        margin: 0;
        min-height: 100px;
    }

    #categories-view24 .view-container table.tbgrid {
        margin-top: 14px;
        margin-bottom: 0;
    }

    #categories-view24 .tab-modal {
        color: #FFFFFF;
        background-color: #33a6dc;
    }

    #categories-view24 .nav-tabs > li.active > a,
    #categories-view24 .nav-tabs > li.active > a:hover,
    #categories-view24 .nav-tabs > li.active > a:focus {
        color: #555555;
        background-color: #ffffff;
    }

    .tbgrid th.padding-lr-9, .tbgrid td.padding-lr-9 {
        padding-left: 9px;
        padding-right: 9px
    }

    #categories-view24 thead th, #categories-view24 tbody td {
        font-size: 12px !important;
        height: 30px;
    }

    #categories-view24 thead th:nth-child(1) {
        min-width: 109px; max-width: 109px;
    }
    #categories-view24 tbody td:nth-child(1) > span {
        min-width: 109px; max-width: 109px; display: inline-block; max-height: 31px;
    }

    #categories-view24 thead th:nth-child(2),
    #categories-view24 thead th:nth-child(3) {
        min-width: 80px; max-width: 80px;
    }

    #categories-view24 thead th:nth-child(4){
        min-width: 117px; max-width: 117px;
    }
    
    #categories-view24 thead th:nth-child(5) {
        min-width: 108px; max-width: 108px;
    }

    #categories-view24 thead th:nth-child(6) {
        min-width: 36px; max-width: 36px;
    }
    #categories-view24 thead th:nth-child(7) {
        min-width: 30px; max-width: 30px
    }
    #categories-view24 thead th:nth-child(8) {
        min-width: 22px; max-width: 22px
    }

    #categories-view24 tbody td:nth-child(1) > div {
        min-width: 120px; max-width: 120px;
        min-width: 72px; max-width: 72px;
    }

    #categories-view24 tbody td:nth-child(2) > div,
    #categories-view24 tbody td:nth-child(3) > div {
        min-width: 80px; max-width: 80px; overflow: hidden;
    }

    #categories-view24 tbody td:nth-child(4) > div {
        min-width: 134px; max-width: 134px;
        text-overflow: ellipsis;
    }
    #categories-view24 tbody td:nth-child(5) > div {
        min-width: 108px; max-width: 108px;
        text-overflow: ellipsis;
    }

    #categories-view24 tbody td:nth-child(6) > div {
        min-width: 36px; max-width: 36px;
    }
    #categories-view24 tbody td:nth-child(7) > div {
        min-width: 30px; max-width: 30px;
    }
    #categories-view24 tbody td:nth-child(8) > div {
        min-width: 22px; max-width: 22px;
    }
    
    .btn-delete-link, .sp-link {
        cursor: pointer
    }
    .hvLinkSpFilterTmp {
        display: flex; margin-right: 10px;
    }
    .hvLinkSpFilterTmp+.sp-tlp-bt-be {
        border-top: 1px solid #dddddd;
        text-align: left; margin-left: 10px;
        margin-right: 10px; padding-top:10px;
    }
    .hvLinkSpFilterTmp+.sp-tlp-bt-be .sp-tlp-se-block {
        display:flex; padding-top: 5px; padding-bottom: 8px;
    }
    .hvLinkSpFilterTmp .sp-tlp-th {
        display:flex;font-weight: 400;margin-bottom:-15px
    }
    .hvLinkSpFilterTmp .sp-tlp-drp1 {
        margin-left: 10px;
        width: 100px;
    }
    .hvLinkSpFilterTmp .sp-tlp-se-date {
        width: 100%;
        max-height: 30px;
        padding: 0;
    }
    .hvLinkSpFilterTmp .sp-tlp-se-label {
        margin-top: 5px;
        margin-right: 9px;
        color: rgb(132,132,132);
        min-width: 48px
    }
    .hvLinkSpFilterTmp .sp-tlp-drp {
        margin-left: 36px;
        width: 250px;
        max-width: 250px;
        max-height: 31px;
    }
    .lsp-name {display: inline-block;max-width:120px;overflow:hidden;text-overflow:ellipsis;}
    .lsp-name+textarea{
        resize: none;overflow:hidden;max-width:114px;border: 1px solid #E7E7E7; 
        margin-top: 3px; margin-left: -6px; margin-right: -4px;min-height: 18px;
        background-color: #f5f5f5;
    }
    .hvLinkSpFilterTmp tr > td > * {margin-bottom: 13px;}
    /*bug 23560 */
    #place-categories10 div[id^="childType"].collapse, #categories10.collapse { overflow: hidden }
    #place-categories10 div[id^="childType"].collapsing, #categories10.collapsing { overflow: hidden }
    #place-categories10 div[id^="childType"].collapse.in, #categories10.collapse.in { overflow:initial }
    #place-categories10 > div {position:relative}
    #place-categories10 > div > .dnb-setting-menu { position:absolute !important;top:-1px !important;right:-3px !important; }
    #place-categories10 div[id^="child-place-Type"] > div {position:relative;}
    #place-categories10 div[id^="child-place-Type"] > div > .dnb-setting-menu {position:absolute !important;top:0 !important;}
    #place-categories10 div[id^="child-place-Type"] > #pop-kpisettingindex {position:initial !important;}
    #place-categories10 div[id^="child-place-Type"] > #pop-kpisettingindex > div:last-child {position:initial !important;}
    #place-categories10 div[id^="child-place-Type"] #pop-kpisettingindex .k-numeric-wrap .k-i-warning {display:none !important}
    #place-categories10 div[id^="child-place-Type"] #pop-kpisettingindex .dnb-kpi-input {padding-left: 5px !important; padding-right:5px !important}
    #place-categories10 div[id^="child-place-Type"] #pop-kpisettingindex .dnb-kpi-input > span:first-child {width: initial !important}
    #place-categories10 div[id^="child-place-Type"] #pop-kpisettingindex .td-expected .k-numerictextbox .k-input {
        width: 159px !important;
        height: 28px;min-height: 28px;
    }
    #place-categories10 div[id^="child-place-Type"] #pop-kpisettingindex .tblformat span.k-numerictextbox.formatinput input.k-input 
    {width: 177px !important; height:28px;}
    /*end bug 23560 */
    #categories16 span.cssKpiCategories:hover {
        text-decoration: underline;
        cursor: pointer;
    }
    /* Bug 24593: Use for edge cause default in edge is gray (dm edge) */
    #pop-setting input[type="checkbox"], 
    #pop-add-categories-place input[type="checkbox"], 
    #selectdefaultform input[type="checkbox"],
    #pop-setting input[type="radio"], 
    #pop-add-categories-place input[type="radio"], 
    #selectdefaultform input[type="radio"] {
        border-width: 1px; width: 14px; height: 14px;
    }
    #pop-setting input[type="checkbox"]:checked, 
    #pop-add-categories-place input[type="checkbox"]:checked, 
    #selectdefaultform input[type="checkbox"]:checked {
        border-radius: 3px !important;
        border-color: #0d6efd !important;
        color-adjust: exact;
        -webkit-print-color-adjust: exact;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: #0d6efd !important;
        background-repeat: no-repeat;
        background-position: center;
        background-size: 15px 15px;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10l3 3l6-6'/%3e%3c/svg%3e");
    }
    #pop-setting input[type="radio"]:checked,
    #pop-add-categories-place input[type="radio"]:checked,
    #selectdefaultform input[type="radio"]:checked {
        position:relative;
        border-radius: 50% !important;
        border-color: #0d6efd !important;
        color-adjust: exact;
        -webkit-print-color-adjust: exact;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: white !important;
    }
    #pop-setting input[type="radio"]:checked:after,
    #pop-add-categories-place input[type="radio"]:checked:after,
    #selectdefaultform input[type="radio"]:checked input[type="radio"]:checked:after {
        position: relative;
        top: -4px;
        left: 2px;
        content: "";
        width: 8px;
        display: inline-block;
        height: 8px;
        background-color: #0d6efd;
        border-radius: 50%;
    }
    /*end bug 24593*/
	input.st-cm-color-invalid { border-color: red !important; color: red !important; }
    #tables-settings25-colorpalette .k-picker-wrap {border-width: 0; overflow: hidden;}
    .dnb-colorpicker-textview-none-select { cursor: n-resize; user-select: none; padding-right:9px; display: inline-block; }
    .dnb-colorpicker-textview-none-select.view { cursor: initial; }
    .dnb-col-palette-head {display:flex;color:white;background-color: #38baf8;align-items:center;}
    .dnb-col-palette-item {display:flex;align-items:center;height:33px;background-color:white;border-radius:3px;}
    .dnb-cp-item {display: inline-flex;align-items:center;height:30px;min-width:94px;max-width:100px}
    .dnb-cp-item .dnb-col-palette-icon-delete {display:none;padding-left: 3px;cursor:pointer;background-position: -46px -2px;}
    .dnb-cp-item:hover .dnb-col-palette-icon-delete {display:inline-flex;height:30px;align-items:center}
    .connectedSortablePalette .ui-state-highlight {height:32px;width:119px;background-color:rgba(0, 0, 0, 0.12);margin-left:1px;border-radius:3px;}
    #tables-settings25-colorpalette .k-colorpicker[role="textbox"] {max-width:28px;}
    #tables-settings25-colorpalette .k-colorpicker[role="textbox"] span.k-select[role="button"] {display:none}
    #pop-setting .k-dropdown-wrap, #add-kpiunit-form .k-dropdown-wrap,
    #pop-setting .k-formatted-value {
        min-height: 28px;
    }
    #pop-setting #pop-kpisettingindex .k-numerictextbox .k-numeric-wrap {border-width: 0}
    .dnb-ipaddress-item {position: relative; height: 25px; margin-top: 3px;}
    .dnb-ipaddress-item:last-child {margin-bottom: 3px;}
    .dnb-ipaddress-item .ms-dropdow { position:absolute; right: -6px; top: 2px; }
    .dnb-ipaddress-item .icon-dropdow {display:none;}
    .dnblstipaddress_wrap:hover .icon-dropdow {display:none;}
    .dnb-ipaddress-item:hover .icon-dropdow {
        background-position: -81px -299px;
        text-indent: -999px;
        display: block;
        width: 20px;
        height: 20px;
        margin-top: 0px;
    }
    .dnb_alert-typing_ipaddress-tooltip {display:none;}
    .dnb_alert-typing_ipaddress { position: absolute;top: 1px;left: -4px;cursor: pointer; }
    .dnb_alert-typing_ipaddress:hover .dnb_alert-typing_ipaddress-tooltip { display:block; }
    .dnb-linkname_txt {height:21px; min-height: 21px;}
</style>

<div>
    <div id="pop-setting" class="modal-body ms-modal-body">
        <div class="panel-group" id="pop-setting-place"></div>
    </div>
    <div id="pop-add-categories-place"></div>
    <div id="smpPopupHolder" style="height: 0px;"></div>
    <div id="popMenuSubmarketProductSe"></div>
    <div id="popMenuChildSubmarketProductSe"></div>
</div>
<div id="categories-loading" class="loading"></div>
<script id="template-tables-colorpalettes" type="text/html">
    #var dLen = data.length; var tblLen = Math.floor(dLen/9); var oSet = dLen % 9; if(oSet < 1){tblLen = tblLen - 1;}#
    #for(var t = 0; t <= tblLen; t++){#
    <div style="width: 120px;margin-right: 32px">
        <div class="dnb-col-palette-head">
            <div style="display:inline-block;width:34px;height:25px;border-left:1px solid white"></div>
            <div class="" style="border-left: 1px solid white;padding-left: 5px;padding-bottom: 3px;">
                <span style="font-size: 16px;">Hex</span>
            </div>
        </div>
        <div class="connectedSortablePalette">
            # var rStart = t * 9; var rEnd = t < tblLen ? rStart + 9 : dLen;#
            #for(var r = rStart; r < rEnd; r++) { var item = data[r];#
            # var colorVal = item.MValue ? item.MValue : '\#b8c92e'; #
            # var cmId = colorVal.substring(1); var itemId = cmId + '___' + item.Id;#
            <div data-id="#:item.Id#" class="dnb-col-palette-item">
                <div class="td-hover divDroppable ui-droppable" style="padding: 3px 3px 0;">
                    <span id="_stDnbColorMixerView__#:itemId#" class="_stDnbColorMixerView__"></span>
                </div>
                <div style="padding: 0 0 0 3px;">
                    <span class="dnb-cp-item">
                        <span class="dnb-colorpicker-textview-none-select" id="_stDnbColorMixerText__#:itemId#">#:colorVal#</span>
                        <input type="text" value="#:colorVal#" id="_stDnbColorMixerInput__#:itemId#" aria-invalid="true" maxlength="7"
                               style="max-width: 60px;min-height: 24px;padding-right: 0;margin-right: 0;margin-top:3px;display:none">
                        <span class="k-icon k-i-warning" id="_stDnbColorMixerWarning__#:itemId#"
                              style="margin-left:3px;color: red;display:none"></span>
                        #if(dLen > 1 && vmPopSetting.IsOwner){#
                        <span class="dnb-col-palette-icon-delete icon-16" data-id="#:item.Id#" onclick="vmPopSetting.deleteColor(#:item.Id#)"></span>
                        #}#
                    </span>
                </div>
            </div>
            #}#
        </div>
    </div>
    #}#

</script>
<script type="text/html" id="template-setting">
    #for(var i = 0; i< data.length; i++) {#
    # var categories = data[i];#

    <div class="panel panel-default ms-parent w-full">
        <div class="panel-heading panel-heading-mass-parent-setting">
            <h4 class="panel-title" style="line-height: normal">
                <a data-toggle="collapse" data-parent="\\#pop-setting-place" href="\\#categories#:categories.Type#" class="panel-online collapsed "
                   onclick="vmPopSetting.GetCategories(#:categories.Type#)">
                    <span class="arrow-panel-online icon-24 icon-left-block arrow-collapse "></span>
                </a>
                <span data-id="#:categories.Type#" class="cssCategories">#:categories.Name# #:categories.Type == vmPopSetting.enumsType.categoryPlanning ? vmPopSetting.projectName: ''#</span>
            </h4>
        </div>
        <div id="categories#:categories.Type#" class="panel-collapse collapse height0px parent-body">
          #if(categories.Type == 24) {#                     <!--SharepointLinkControl-->
            <div id="categories-view#:categories.Type#">
                <div class="view-container">
                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a class="tab-modal" data-toggle="tab" href="\#place-categories#:categories.Type#-roadmap">Road map</a>
                        </li>
                        <li>
                            <a class="tab-modal" data-toggle="tab" href="\#place-categories#:categories.Type#-mix">#:kLg.tabMarketingmix#</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div id="place-categories#:categories.Type#-roadmap"
                             class="tab-pane fade in active">
                        </div>
                        <div id="place-categories#:categories.Type#-mix"
                             class="tab-pane fade">
                        </div>
                    </div>
                </div>
            </div>
          #} else if(categories.Type == 25) {#                <!--Color palette-->
            <div class="dnb-kendonewlib"></div>
            <div id="categories-view25">
                <div class="popsettings-view-container">
                    <div id="tables-settings25-colorpalette" style="display:flex; padding: 6px; align-items:flex-start"> </div>
                </div>
                #if(vmPopSetting.IsOwner){#<span class="icon-32 icon-add" onclick="vmPopSetting.AddColor(this)"
                                                 style="display: inline-block;margin-left: 8px;cursor:pointer;margin-bottom:27px;"></span>
                #}#
            </div>
          #} else {#
            <form id="categories-form#:categories.Type#" class="valid-form" type="#:categories.Type#">
                <div id="place-categories#:categories.Type#" class="modal-body ms-modal-body" type="content-table-categories">
                </div>
                #if(categories.Type != vmPopSetting.enumsType.categoryPlanning && categories.Type != vmPopSetting.enumsType.categoryProjectLanguage
                && categories.Type != vmPopSetting.enumsType.categoryKpiIndex && categories.Type != vmPopSetting.enumsType.categoryFibu
                && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)) {#
                <div>
                    <table class="popup-table-email">
                        <tr>
                            <td style="padding-bottom: 7px !important;">
                                <span id="spanCatId#:categories.Type#" class="title-oneline-settings" style="float: left;max-width: 700px;overflow: hidden;">
                                    #if(categories.Type==vmPopSetting.enumsType.categoryCustomerJourney){# #:categories.Title# #} else {# #:categories.Name# #}#
                                </span>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div style="display: flex">
                                    <input value="" name="CategoryName" class="categoryName" id="txtName#:categories.Type#" />
                                    <span class="icon-32 icon-add" onclick="vmPopSetting.AddCategory(#:categories.Type#)" style="display: inline-block;margin-left: 8px;"></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                #}#
                <p class="clear4px"></p>
            </form>
          #}#
        </div>
    </div>
    #}#
</script>

<script id="template-tbl-sp-link" type="text/html">
    <table class="tbgrid no-margin-div-right">
        <thead>
            <tr>
                #for(var i = 0, len = data.Heads.length; i < len; i++){ #
                #var item = data.Heads[i];#
                <th class="title panel-heading-mass-parent padding-lr-9">#: item #</th>
                #}#
            </tr>
        </thead>
        <tbody id="tbl-sp-link-#:data.Type#-body" data-template="item-link-tmpl" 
               data-bind="source: dataLinks, events: {mouseout: onCloseMenuItemIpAddressWrp}">
            <!--Id: 123, LinkName: "Link A" -->
        </tbody>
    </table>
</script>
<script id="item-link-tmpl" type="text/x-kendo-template">
    <tr>
        <td class="padding-lr-9" >
            <span data-bind="events: { mouseover: showTooltipSp }">
                <span data-bind="click: enableLnkNameEditting, text: LinkName"
                      class="lsp-name"></span>
                <textarea type="text" data-bind="value: InputEditting" class="dnb-linkname_txt"
                       maxlength="150" style="display:none;"></textarea>
            </span></td>
        <td class="padding-lr-9"><div data-bind="text: FirstName"></div></td>
        <td class="padding-lr-9"><div data-bind="text: LastName"></div></td>
        <!--<td class="padding-lr-9"><div data-bind="text: Departments"></div></td>-->
        <td class="padding-lr-9 dnblstipaddress_wrap"
            data-bind="events: {mouseover: onCloseLstIpAddress}">
            #if(LstIpAddress.length > 0){#
                <div id="lst_ipaddress_item_#:Id#" data-template="item-ipaddress-tmpl" data-bind="source: LstIpAddress"></div>
            #} else {#
                <a class="icon-28 icon-add-small firstSwotButton floatleft" data-bind="events: { click: pushFirstIpAddress}"></a>
            #}#
        </td>
        <td class="padding-lr-9"><div data-bind="text: ExportDateStr"></div></td>
        <td class="padding-lr-9">
            <div class="checkbox margin-auto" style="padding-left: 0;margin-top:-8px;">
                <label>
                    <span class="checkbox-inline" style="padding-left: 10px;">
                        <label>
                            <input type="checkbox"
                                data-bind="checked: IsActive, click: getCheckActive, enabled: IsChkBoxEnabled, disabled: IsEdit != true" >
                            <span class="checkmarkd"></span>
                        </label>
                    </span>
                </label>
            </div>
        </td>
        <td class="padding0px">
            <span class="icon-20 icon-url margin-auto sp-link" data-bind="click: copyLinkToClipboard"></span>
        </td>
        <td class="padding0px">
            <span class="icon-32 icon-bin-298-256 margin-auto btn-delete-link"
                data-bind="click: deleteLink, visible: IsEdit"></span>
        </td>
    </tr>
</script>
<script id="item-ipaddress-tmpl" type="text/x-kendo-template">
    <div class="dnb-ipaddress-item dnbTypeIpWrap dnbipaddr_item#:Id#">
        <input class="dnb_txtinput"
                maxlength="15" placeholder="#:kLg.LblIpAddress#"
                data-bind="value: Name, attr: { id: Id, mindex: MIndex }
                           events: { keyup: validateIpAddress, keydown: ignoreSpaceKey,
                                    mouseout: mouseOutCheckChangeIp, focus: onFocusIpInput }"
                style="height: 20px;width: 99px;margin-bottom: 6px;margin-left: 8px;" />
        <div class="ms-dropdow">
            <span class="icon-16 icon-dropdow" data-toggle="dropdown" style="margin: 2px 0 0 5px;"></span>
            <ul class="dropdown-menu ms-popup-menu" style="left: -140px; top: 15px;">
                <li><a class="dropdow-menu-li-a" data-bind="events: { click: onMenuAddIpAddress}">
                    <span class="icon-24 icon-left-block icon-add-region"></span>#:kLg.add#</a></li>
                <li role="presentation" class="divider"></li>
                <li><a class="dropdow-menu-li-a" data-bind="events: { click: onMenuDeleteIpAddress}">
                    <span class="icon-24 icon-left-block icon-delete"></span>#:kLg.lblDelete#</a></li>
            </ul>
        </div>
    </div>
</script>
<script id="hvLinkSharepointTmp" type="text/html">
    <div class="hvLinkSpFilterTmp">
        <table >
            <thead>
                # for(var i = 0, len = data.Filters.length; i < len; i++) {#
                # var item = data.Filters[i]; #
                #if(item.Start != undefined){#
                <tr>
                    <th colspan="8" style="height: 70px">
                        <div class="sp-tlp-th">
                            <span class="sp-tlp-drp1 k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                                  aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false">
                                <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                    <span unselectable="on" class="k-input">#:item.Operator#</span><span unselectable="on" class="k-select" aria-label="select">
                                        <span class="k-icon k-i-arrow-60-down"></span>
                                    </span>
                                </span>
                            </span>

                            <div style="margin-left: 36px;display: inline-flex;">
                                <strong titlename="start" class="sp-tlp-se-label" >#:item.SLable#</strong>
                                <span class="sp-tlp-se-date k-widget k-datepicker k-header k-input" >
                                    <span class="k-picker-wrap k-state-disabled">
                                        <span style="position: relative;width: 90px;display: inline-block;top: 5px;left: 7px;">#:item.Start#</span>
                                        <span unselectable="on" class="k-select" aria-label="select" role="button">
                                            <span class="k-icon k-i-calendar"></span>
                                        </span>
                                    </span>
                                </span>
                            </div>
                            <div style="margin-left: 120px;display: inline-flex;">
                                <strong titlename="end" class="sp-tlp-se-label">#:item.ELabel#</strong>
                                <span class="sp-tlp-se-date k-widget k-datepicker k-header k-input" >
                                    <span class="k-picker-wrap k-state-disabled">
                                        <span style="position: relative;width: 90px;display: inline-block;top: 5px;left: 7px;">#:item.End#</span>
                                        <span unselectable="on" class="k-select" aria-label="select" role="button">
                                            <span class="k-icon k-i-calendar"></span>
                                        </span>
                                    </span>
                                </span>
                            </div>

                        </div>
                    </th>
                </tr>
                #}#
                #}#
            </thead>
            <tbody >
                # for(var i = 0, len = data.Filters.length; i < len; i++) {#
                # var item = data.Filters[i]; #
                #if(item.Start == undefined){#
                <tr>
                    <td>
                        <span class="sp-tlp-drp1 k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                              aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false">
                            <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                <span unselectable="on" class="k-input">#:item.Operator#</span><span unselectable="on" class="k-select" aria-label="select">
                                    <span class="k-icon k-i-arrow-60-down"></span>
                                </span>
                            </span>
                        </span>
                    </td>
                    <td>
                        <span class="sp-tlp-drp k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                              aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false">
                            <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                <span unselectable="on" class="k-input">#:item.ParentValue#</span><span unselectable="on" class="k-select" aria-label="select">
                                    <span class="k-icon k-i-arrow-60-down"></span>
                                </span>
                            </span>
                        </span>
                    </td>
                    #if(item.ChildValue){#
                    <td>
                        <span class="sp-tlp-drp k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                              aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false">
                            <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                <span unselectable="on" class="k-input">#:item.ChildValue#</span><span unselectable="on" class="k-select" aria-label="select">
                                    <span class="k-icon k-i-arrow-60-down"></span>
                                </span>
                            </span>
                        </span>
                    </td>
                    #}#
                    #if(item.ChildValue1){#
                    <td>
                        <span class="sp-tlp-drp k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                              aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false">
                            <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                <span unselectable="on" class="k-input">#:item.ChildValue1#</span><span unselectable="on" class="k-select" aria-label="select">
                                    <span class="k-icon k-i-arrow-60-down"></span>
                                </span>
                            </span>
                        </span>
                    </td>
                    #}#
                    #if(item.ChildValue2){#
                    <td>
                        <span class="sp-tlp-drp k-widget k-dropdown k-header" unselectable="on" role="listbox" aria-haspopup="true"
                              aria-expanded="false" aria-owns="" aria-disabled="true" aria-busy="false" style="">
                            <span unselectable="on" class="k-dropdown-wrap k-state-disabled">
                                <span unselectable="on" class="k-input">#:item.ChildValue2#</span><span unselectable="on" class="k-select" aria-label="select">
                                    <span class="k-icon k-i-arrow-60-down"></span>
                                </span>
                            </span>
                        </span>
                    </td>
                    #}#
                </tr>
                #}#
                #}#
            </tbody>
        </table>
    </div>
    #if(data.StartDate || data.EndDate){#
    <div class="sp-tlp-bt-be" >
        <strong>#:kLg.ExportPreview#</strong>
        <div class="sp-tlp-se-block">
            #if(data.StartDate){#
            <span style="margin-right: 55px"><strong>#:kLg.textStart#:</strong> #:data.StartDate#</span>
            #}#
            #if(data.EndDate){#
            <span><strong>#:kLg.textEnd#:</strong> #:data.EndDate#</span>
            #}#
        </div>
    </div>
    #}#
</script>

<script type="text/html" id="template-fibu">
    <div style="margin: 15px 0px -10px 13px">
        <span id="msgFibuUnsave" style="color: red; font-weight: bold; display: none">#:kLg.fibuCheckUnsave#</span>
    </div>
    <table>
        <tr>
            <td>
               #var itemRegionFibus = data.fibu.RegionFibus;#
               #if(itemRegionFibus.length > 0 && itemRegionFibus[0].Id != 0) {#
                #for( var j = 0; j < itemRegionFibus.length; j++){#
                    # var item = itemRegionFibus[j];#
                <table class="fibutable">
                    <!--Label Land/Region Nr Des-->
                    <tr>
                        <td><span>#:kLg.fibuLR#</span></td>
                        <td><span>#:kLg.fibuNr#</span></td>
                        <td><span>#:kLg.fibuDes#</span></td>
                        <td></td>
                    </tr>
                    <tr></tr>
                    <!--Dropdown Land/Region + Input Nr Des FibuKonten-->
                    <tr class="fibuTop">
                        <td>
                            <span id="regionUnsave#:j#" class="fbUnsave" #if(item.Unsave !=1){# style="display: none; position: absolute; left: 2px; color: red; margin-top: 6px; font-size: 22px;" #}# 
                                  style="position: absolute; left: 2px; color: red; margin-top: 6px; font-size: 22px;">*</span>
                            <select #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# data-role="dropdownlist" 
                                    style="height: 25px; margin-bottom: 10px; width: 330px" id="ddlFibuRegion#:j#" itemId="#:item.Id#">
                            </select>
                        </td>
                        <td>
                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# onchange=" vmPopSetting.changeFibuTokenNr(this, #:item.Id #, #:j #); " 
                                type="text" class="inputFibuTop checkFibuNumber" maxlength="25" value="#:item.Nr||''#" #if(item.Id=== -1) {# readOnly #}#/>
                        </td>
                        <td>
                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# onchange=" vmPopSetting.changeFibuTokenDes(this, #:item.Id #, #:j #); " 
                                type="text" class="inputFibuTop" maxlength="25" value="#:item.Description||''#" #if(item.Id=== -1) {# readOnly #}#/>
                        </td>
                        <td>
                            #if(item.Fibus[0].Id == 0 && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)){#
                            <a class="icon-28 icon-bin-small floatleft" style="margin-left: -15px;" index="#:j#" onclick=" vmPopSetting.deleteFibuRegion(this, #:item.Id #); "></a>
                            #}#
                        </td>
                    </tr>

                    <tr>
                        <td colspan="4" style="padding: 0 20px 10px 20px;">
                            <table class="fibukontentable">
                                <!--Label FIBU Konten + Kostenstellen-->
                                <tr style="border-style: hidden;">
                                    <td colspan="3" style="width: 363px;">
                                        <span class="fibuBG" style="margin-left: -3px;">#:kLg.konten#</span>
                                    </td>
                                    <td colspan="3" style="padding-left: 1px; width: 363px;">
                                        <span class="fibuBG">#:kLg.kostenstellen#</span>
                                    </td>
                                </tr>
                                <!--Label Nr + Des --- Nr + Des-->
                                <tr>
                                    <td colspan="3" style="width: 363px;" class="borderRightGray">
                                        <span style="margin-left: 7px;">#:kLg.fibuNr#</span>
                                        <span style="margin-left: 145px;">#:kLg.fibuDes#</span>
                                    </td>
                                    <td colspan="3" style="padding-left: 1px; width: 363px;">
                                        <span style="margin-left: 7px;">#:kLg.fibuNr#</span>
                                        <span style="margin-left: 145px;">#:kLg.fibuDes#</span>
                                    </td>
                                </tr>
                                <!--If Fibus.length = 0 -- Button Create Fibus-->
                                #if(item.Fibus[0].Id == 0 ){#
                                <tr>
                                    <td colspan="3" style="width: 363px;" class="borderRightGray">
                                        #if(item.Id > -1 && (vmPopSetting.Role > 1 || vmPopSetting.IsOwner)){#
                                        <a id="btnAddFibus + #:j#" class="icon-28 icon-add-small firstSwotButton floatleft" style="margin-bottom: 5px;" count="#:j#" onclick=" vmPopSetting.addFirstFibus(this); "></a>
                                        #}#
                                    </td>
                                    <td colspan="3" class="kosten borderRightGray borderBottomGray"></td>
                                </tr>

                                <!--If Fibus.length > 0 --- For Fibus.length-->
                             #}else if(item.Fibus.length > 0){#
                              #for( var k = 0; k < item.Fibus.length; k++){#
                               # var itemK = item.Fibus[k];#
                                #for( var g = 0; g < itemK.Kostens.length; g++){#
                                 # var itemG = itemK.Kostens[g];#
                                <tr>
                                    #if(g==0){#
                                    <td colspan="3" rowspan="#:itemK.Kostens.length#" style="vertical-align: top;" class="borderRightGray fibu">
                                        <div style="display: flex; position: relative;">
                                            <span id="fibuUnsave#:k#-#:j#" #if(itemK.Unsave !=1){# style="display: none; position: absolute; color: red; margin-top: 6px; font-size: 22px;" #}# style="position: absolute; color: red; margin-top: 6px; font-size: 22px;">*</span>
                                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# type="text" onchange=" vmPopSetting.changeFibusNr(this,  #:itemK.Id #, #:item.Id #, #:k #); "
                                            class="inputFibu checkFibuNumber" value="#:itemK.Nr||''#" maxlength="25"/>
                                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# type="text" onchange=" vmPopSetting.changeFibusDes(this,  #:itemK.Id #, #:item.Id #, #:k #); "
                                            class="inputFibu" value="#:itemK.Description||''#" maxlength="25"/>
                                            #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true){#
                                            <div class="ms-dropdow">
                                                <span class="icon-16  icon-dropdow" data-toggle="dropdown" style="right:-1px;top:7px;"></span>
                                                <ul aria-labelledby="btnGroupVerticalDrop1" role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: -22px; top: 22px;">
                                                    <li><a class="dropdow-menu-li-a" count="#:j#" onclick=" vmPopSetting.addFibus(this); ">
                                                        <span class="icon-24 icon-left-block icon-add-region"></span>#:kLg.add#</a></li>
                                                    #if(itemG.Id == -2 || itemG.Id == 0){#
                                                    <li role="presentation" class="divider"></li>
                                                    <li><a class="dropdow-menu-li-a" count="#:j#" index="#:k#" onclick=" vmPopSetting.deleteFibus(this, #:itemK.Id #); ">
                                                        <span class="icon-24  icon-left-block icon-delete"></span>#:kLg.lblDelete#</a></li>
                                                    #}#
                                                </ul>
                                            </div>
                                            #}#
                                        </div>
                                    </td>
                                    #} #
                                    <td colspan="3" class="kosten borderRightGray borderBottomGray">
                                        <!-- -2: display plus, -1: new kosten, 0:bind default kosten -->
                                        #if(itemG.Id == -2 || itemG.Id == 1){#
                                        <div style="display: flex; position: relative;width: 330px;">
                                            #if(vmPopSetting.IsOwner == true){#
                                            <a id="plusKosten#:k#-#:j#" #if(itemK.Id == -1) {# style="display: none" #}# class="icon-28 icon-add-small firstSwotButton floatleft"
                                               countFibus="#:j#" countKosten="#:k#" onclick=" vmPopSetting.addFirstKosten(this); "></a>
                                            #}#
                                        </div>
                                        #}else {#
                                        <div style="display: flex; position: relative;">
                                            <!--#if(itemG.Unsave === 1){#-->
                                            <span id="kostenUnsave#:g#-#:k#-#:j#" #if(itemK.Unsave !=1){# style="display: none; position: absolute; color: red; margin-top: 6px; font-size: 22px;" #}# style="position: absolute; color: red; margin-top: 6px; font-size: 22px;">*</span>
                                            <!--#}#-->
                                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# type="text"
                                                onchange=" vmPopSetting.changeKostenNr(this,  #:itemG.Id #, #:itemK.Id #, #:g #); " class="inputFibu checkFibuNumber" value="#:itemG.Nr#" maxlength="25"/>
                                            <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# type="text" 
                                                onchange=" vmPopSetting.changeKostenDes(this,  #:itemG.Id #, #:itemK.Id #, #:g #); " class="inputFibu" value="#:itemG.Description#" maxlength="25"/>
                                           #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true){#
                                            <div class="ms-dropdow" style="right: -4px;top: 4px;">
                                                <span class="icon-16 icon-dropdow" data-toggle="dropdown" style="margin: 2px 0 0 5px;"></span>
                                                <ul aria-labelledby="btnGroupVerticalDrop1" role="menu" class="dropdown-menu ms-popup-menu posAbsolute" style="left: -160px; top: 22px;">
                                                    <li><a class="dropdow-menu-li-a" countFibus="#:j#" countKosten="#:k#" onclick=" vmPopSetting.addKosten(this); ">
                                                        <span class="icon-24  icon-left-block icon-add-region"></span>#:kLg.add#</a></li>
                                                    <li role="presentation" class="divider"></li>
                                                    <li><a class="dropdow-menu-li-a" countFibus="#:j#" countKosten="#:k#" count="#:g#" onclick=" vmPopSetting.deleteKosten(this, #:itemG.Id #); ">
                                                        <span class="icon-24  icon-left-block icon-delete"></span>#:kLg.lblDelete#</a></li>
                                                </ul>
                                            </div>
                                           #}#
                                        </div>
                                        #}#
                                    </td>
                                </tr>
                                #}#
                                #}#
                                #}#
                            </table>
                        </td>
                    </tr>
                </table>
                #}#
                #}#
            </td>
        </tr>
        <tr>
            <td>
                #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
                <a class="icon-28 icon-add-small firstSwotButton floatleft" style="margin-right: 700px; margin-top: 15px; margin-left: 10px;" onclick=" vmPopSetting.addFibuRegion(); "></a>
                #}#
                <!--<a class="icon-pd-open icon-add-small firstSwotButton floatleft" onclick="vmPopSetting.saveFibu();"></a>-->
            </td>
        </tr>
    </table>
</script>

<script type="text/html" id="template-table-categories">
    <table class="table-bordered" style="width: 100%">
        <tr>
            <td class="title" style="padding-left: 15px; padding-right: 10px">
                <span>  #:kLg.labelCategories#</span>
                #if(data[0].Type === vmPopSetting.enumsType.categoryCurrency) {#
                <span class="plankurs-label">#:kLg.lblPlankurs# </span>
                #}#

                #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
                <span class="icon-16 icon-right-block icon-plus" onclick=" vmPopSetting.OpenPopUpAddCategory(#:data[0].Type #) "></span>
                #}#
            </td>
        </tr>
        #if(data.length > 0 && data[0].Id != 0) {#
        #for( var j = 0; j < data.length; j++){#
        # var item = data[j];#
        <tr>
            <td class="td-v-align-top td-hover divDroppable" style="padding-left: 20px; padding-right: 10px;height: 18px;" val="#:item.Id#">
                <div class="itemDraggable dnb-cat_wrap#:item.Type# no-wrap" type="#:item.Type#" style="padding-right: 40px; position: relative;">
                    <span class="icon-16  icon-arow-towway-vertical"></span>

                    #if(item.Type == vmPopSetting.enumsType.categoryCurrency) {#
                    <span class="icon-left-block text-justify-currency">#:item.Name#</span>
                    <input #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# class="modal-input txtInput csscurrencyrate"
                    #if(item.Type === vmPopSetting.enumsType.categoryCurrency && item.NonArchive === true ){# readOnly #}# onchange=" vmPopSetting.OnChangeCurrency(this, #:item.Id #) " value="#:item.Extension || ''#" maxlength="9"/>
                    #} else {#
                    <span style="white-space:normal;width:50%;" class="icon-left-block text-justify-time" val="#:item.Id#">#:item.Name#</span>
                    #}#

                    #if(item.Type === vmPopSetting.enumsType.categoryCurrency && item.NonArchive === true ) {#
                    <span class="text-justify-currency title-currency-popup">#=kLg.lblMainCurrency#</span>
                    #}#

                    #if(item.Type === vmPopSetting.enumsType.categoryKpiTime && item.NonArchive === true) {#
                    <span class="icon-right-block text-justify-time" style="position: absolute;right: 32px;top: -1px;">#=kLg.titleAccumulate#</span>
                    #}#

                    #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true){#
                    <div class="ms-dropdow" style="position: absolute; right: 9px;top:3px;">
                        <span class="icon-16 icon-dropdow" data-toggle="dropdown"></span>
                        <ul aria-labelledby="btnGroupVerticalDrop1" role="menu" class="popup-menu dropdown-menu ms-popup-menu posAbsolute" style="top: 17px; left: inherit; right: 2px; bottom: inherit;">
                            <li><a class="dropdow-menu-li-a" data-toggle="modal" data-target=".bs-example-modal-lg" onclick=" vmPopSetting.OpenPopUpAddCategory(#:item.Type #,#:j #, this) ">
                                <span class="icon-24  icon-left-block icon-edit"></span>#=kLg.edit#</a></li>
                            <li role="presentation" class="divider"></li>
                            <li><a class="dropdow-menu-li-a" onclick="vmPopSetting.DeleteCategories(#:item.Type #,#:j#)"><span class="icon-24  icon-left-block icon-delete"></span>#:kLg.Delele#</a></li>
                        </ul>
                    </div>
                    #}#

                    #if(item.Type == vmPopSetting.enumsType.categoryCurrency || item.Type == vmPopSetting.enumsType.categoryGoalEval || item.Type == vmPopSetting.enumsType.categoryInstrument) {#
                    <input type="checkbox"
                           #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# 
                            onclick="vmPopSetting.OnClickCheckBox(this, #:item.Id #, #:item.Type #)"
                    class="floatright check-popup-currency" #if(item.NonArchive== true) {# checked="true" #}# />
                    #}#

                </div>
            </td>
        </tr>
        #}#
        #}#
    </table>
</script>

<script type="text/html" id="planning-table-template">
    <div>
        <h4 class="planning-title"><b>#=kLg.planningMaster#</b></h4>
        <div id="masterSetting">
            <div id="master-plan">
                <label id="lblMaster">#=kLg.lblMaster#</label>
                <div>
                    <select id="ddlMasterRegion" data-text-field="Name" data-value-field="Id" data-auto-bind="false" data-bind="source: ListMasterRegion, value: SelectedMaster, events: { change: changeMasterRegion }" multiple></select>
                </div>
            </div>
            <div id="slave-plan">
                <label id="lblMaster">#=kLg.lblSlave#</label>
                <div>
                    <select id="ddlSlaveRegion" disabled data-text-field="Name" data-value-field="Id" data-auto-bind="false" data-bind="source: ListSlaveRegion, value: SelectedSlave" multiple></select>
                </div>
            </div>
        </div>
    </div>
    <div class="clear">
        <hr />
    </div>
    <div>
        <h4 class="planning-title">#=kLg.planningTitle#</h4>
        <table class="tbgrid">
            <thead>
                <tr>
                    <th class="title bg-grey"><span id="lblProjectName">#:kLg.projectName#</span></th>
                    <th class="title bg-grey"><span id="lblOwner">#:kLg.projectOwner#</span> </th>
                    <th class="title bg-grey"><span id="lblStartYear">#:kLg.startYear#</span></th>
                    <th class="title bg-grey"><span id="lblEndYear">#:kLg.endYear#</span></th>
                </tr>
            </thead>
            <tbody>
                #for(var i = 0;i < data.length; i ++) {#
                #var item = data[i];#
                <tr valueindex="#=i#">
                    #if(vmPopSetting.CheckNoSpaces(item.Name)){#
                    <td>
                        <div class="truncate text-max-width-140">#:item.Name#</div>
                    </td>
                    #} else {#
                    <td>#:item.Name#</td>
                    #}#
                    <td>#:item.Member#</td>
                    #if(item.IsOwner == true){#
                    <td>
                        <input class="w-combo-planning" id="combobox-startyear#=i#" customvalue="#:item.StartYear#" />
                    </td>
                    <td>
                        <input class="w-combo-planning" id="combobox-endyear#=i#" customvalue="#:item.EndYear#" />
                    </td>
                    #} else {#
                    <td>
                        #:item.StartYear#
                    </td>
                    <td>
                        #:item.EndYear#
                    </td>
                    #}#
                </tr>
                #}#
            </tbody>
        </table>

    </div>
    <div id="prosetting">
        <table>
            <tr>
                <td>
                    <input id="cbIsOverdue" type="checkbox" onchange=" vmPopSetting.changeIsOverdue(); ">
                </td>
                <td>
                    <div style="max-width: 300px; margin-left: 7px; margin-top: 2px;"><span id="lblIsOverdue" class="lblIOD file-sub">#:kLg.IsOverdue#</span></div>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="abcxxx" type="checkbox" data-bind="checked: pro.IsShowMarketLabel, enabled: pro.IsEditSetting, events:{change: changeMarketLabel }" />
                </td>
                <td>
                    <div style="max-width: 300px; margin-left: 7px; margin-top: 2px;"><span class="lblIOD file-sub">#:kLg.titleHideMarketLabel#</span></div>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="isHiddenGoal" type="checkbox" data-bind="checked: pro.IsHiddenGoalContent, enabled: pro.IsEditSetting, events:{change: changehiddengoal }" />
                </td>
                <td>
                    <div style="max-width: 500px; margin-left: 7px; margin-top: 2px;"><span class="lblIOD file-sub">#:kLg.titleHideGoalContent#</span></div>
                </td>
            </tr>
            <tr>
                <td>
                    <input id="isCheckActionDate" type="checkbox" data-bind="checked: pro.IsCheckActionDate, enabled: pro.IsEditSetting, events:{change: changecheckactiondate }" />
                </td>
                <td>
                    <div style="max-width: 500px; margin-left: 7px; margin-top: 2px;"><span class="lblIOD file-sub">#:kLg.IsCheckActionDate#</span></div>
                </td>
            </tr>
        </table>
    </div>
</script>

<script type="text/html" id="project-language-template">
    <div class="panel-body w-100per" style="border: none; padding: 0px;">

        <h4 class="planning-title"><b>#=kLg.langCaption#</b></h4>

        <!--table-->
        <table class="tbgrid w-48per pull-left" style="border-style: none; margin-bottom: 1px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep1#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.Market.length; j++){#
                # var item = data.Market[j];#
                <tr>
                    <td style="border-style: none;">
                        #if(item.Langkeyname!=="space"){#
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#"
                            class="w-100per" maxlength="50" onchange=" vmPopSetting.saveCustomLanguage(this) " />
                        #}#
                    </td>
                </tr>
                #}#
            </tbody>
        </table>

        <table class="tbgrid w-48per pull-right" style="border-style: none; margin-bottom: 1px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep2#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.SubMarket.length; j++){#
                # var item = data.SubMarket[j];#
                <tr>
                    <td style="border-style: none;">
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#"
                            class="w-100per" maxlength="50" onchange=" vmPopSetting.saveCustomLanguage(this) " />
                    </td>
                </tr>
                #}#

            </tbody>
        </table>

        <div class="clear"></div>

        <table class="tbgrid w-48per pull-left" style="border-style: none; margin-bottom: 1px; margin-top: -127px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep3#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.ActionPlan.length; j++){#
                # var item = data.ActionPlan[j];#
                <tr>
                    <td style="border-style: none;">
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#"
                            class="w-100per" maxlength="50" onchange="vmPopSetting.saveCustomLanguage(this) " />
                    </td>
                </tr>
                #}#
            </tbody>
        </table>

        <table class="tbgrid w-48per pull-left" style="border-style: none; margin-bottom: 1px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep4#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.Mix.length; j++){#
                # var item = data.Mix[j];#
                <tr>
                    <td style="border-style: none;">
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#"
                            class="w-100per" maxlength="50" onchange="vmPopSetting.saveCustomLanguage(this) " />
                    </td>
                </tr>
                #}#
            </tbody>
        </table>

        <table class="tbgrid w-48per pull-right" style="border-style: none; margin-bottom: 1px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep5#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.Teamboard.length; j++){#
                # var item = data.Teamboard[j];#
                <tr>
                    <td style="border-style: none;">
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#" 
                            class="w-100per" maxlength="50" onchange="vmPopSetting.saveCustomLanguage(this) " />
                    </td>
                </tr>
                #}#
            </tbody>
        </table>

        <table class="tbgrid w-48per pull-left" style="border-style: none; margin-bottom: 1px;">
            <thead>
                <tr>
                    <th><h5 class="planning-title"><b>#=kLg.captionStep6#</b></h5></th>
                </tr>
            </thead>
            <tbody>
                #for( var j = 0; j < data.Roadmap.length; j++){#
                # var item = data.Roadmap[j];#
                <tr>
                    <td style="border-style: none;">
                        <label>#=item.Label#</label>
                        <br />
                        <input type="text" #if(vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false){#disabled#}# value="#=item.Value#" langkeyname="#=item.Langkeyname#"
                            class="w-100per" maxlength="50" onchange="vmPopSetting.saveCustomLanguage(this) " />
                    </td>
                </tr>
                #}#
            </tbody>
        </table>

    </div>
</script>

<script type="text/html" id="template-setting-kpi-type">
    #for(var i = 0; i< data.Data.length; i++) {#
    # var categories = data.Data[i];#
    <div class="panel panel-default ms-parent w-full">
        <!-- Title category -->
        <div class="panel-heading panel-heading-mass-parent" style="height: 18px; padding-top: 7px;">
            <h4 class="panel-title" style="line-height: normal">
                <a data-toggle="collapse" data-parent="\\#place-categories#:data.ParentType#" href="\\#kpiIndex#:categories.Type#" class="panel-online collapsed" onclick=" vmPopSetting.GetSubCategories(#:categories.Type #) ">
                    <span class="arrow-panel-online icon-24 icon-left-block arrow-collapse" style="margin-top: -2px;"></span>
                </a>
                <div class="truncate" style="width: 660px;"><span data-id="#:categories.Type#" class="cssKpiCategories"> #:categories.Name #</span></div>
            </h4>
        </div>
        <div id="kpiIndex#:categories.Type#" class="panel-collapse collapse height0px parent-body kpi-panel">
            <form id="categories-form#:categories.Type#" class="valid-form" type="#:categories.Type#">
                <div id="place-kpi#:categories.Type#" class="modal-body ms-modal-body" type="content-table-kpi" style="margin-bottom: 30px;">
                </div>

                #if((categories.Type == vmPopSetting.enumsType.categoryKpiTime)  && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)) {#
                <div>
                    <table class="popup-table-email">
                        <tr>
                            <td style="padding-bottom: 7px !important;"><span id="spanCatId#:categories.Type#">#:categories.Name#</span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>
                                <input value="" name="CategoryName" class="categoryName" id="txtName#:categories.Type#" />
                            </td>
                            <td valign="bottom">
                                <span class="icon-32 icon-add" onclick=" vmPopSetting.AddCategory(#:categories.Type#) "></span>
                            </td>
                        </tr>
                    </table>
                </div>
                #}#
                <p class="clear4px"></p>
            </form>
        </div>
    </div>
    #}#
</script>

<script type="text/html" id="template-table-kpiunit">
    <table class="table-bordered" style="width: 100%">
        <tr>
            <td class="title" style="padding-left: 15px; padding-right: 10px">
                <span>  #:kLg.labelCategories#</span>
            </td>
            <td class="title" style="padding-left: 15px; padding-right: 10px">
                <span>  #:kLg.lblType#</span>
                #if((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) && vmPopSetting.KpiType == vmPopSetting.enumsType.categoryKpiUnit ){#
                <span class="icon-16 icon-right-block icon-plus" onclick=" vmPopSetting.OpenPopUpAddKpiUnit() "></span>
                #}#
            </td>
        </tr>
        #if(data.length > 0 && data[0].Id != 0) {#
        #for( var j = 0; j < data.length; j++){#
        # var item = data[j];#
        <tr>
            <td class="td-v-align-top td-hover divDroppable padding-td-unit" val="#:item.Id#">
                <div class="itemDraggable no-wrap" type="#:vmPopSetting.enumsType.categoryKpiUnit#" style="padding-right: 40px;">
                   #if((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) && vmPopSetting.KpiType == vmPopSetting.enumsType.categoryKpiUnit ){#
                    <span class="icon-16  icon-arow-towway-vertical"></span>
                   #}#
                    <div style="height: 22px;overflow: hidden;"><span class="icon-left-block text-kpi-justify">#:item.Name#</span></div>
                </div>
            </td>
            <td class="td-hover posRelative padding-td-unit">
                <span>#:item.TypeName#</span>
                #if((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true) && vmPopSetting.KpiType == vmPopSetting.enumsType.categoryKpiUnit){#
                <div class="ms-dropdow" style="position: absolute; right: 9px;top: 9px;">
                    <span class="icon-16 icon-dropdow" data-toggle="dropdown"></span>
                    <ul aria-labelledby="btnGroupVerticalDrop1" role="menu" class="popup-menu dropdown-menu ms-popup-menu posAbsolute" style="top: 15px;left: inherit;right: 2px;bottom: inherit;">
                        <li><a class="dropdow-menu-li-a" data-toggle="modal" data-target=".bs-example-modal-lg" onclick=" vmPopSetting.OpenPopUpAddKpiUnit(#:j #) ">
                            <span class="icon-24 icon-left-block icon-edit"></span>#=kLg.edit#</a></li>
                        <li role="presentation" class="divider"></li>
                        <li><a class="dropdow-menu-li-a" onclick=" vmPopSetting.DeleteKpiUnit(#:j #) "><span class="icon-24  icon-left-block icon-delete"></span>#:kLg.Delele#</a></li>
                    </ul>
                </div>
                #}#
            </td>
        </tr>
        #}#
        #}#
    </table>
</script>

<script type="text/html" id="template-kpitopicindex">
    <div>
        <span id="msgTopicIndexUnsave" style="color: red; font-weight: bold; display: none">#:kLg.fibuCheckUnsave#</span>
    </div>
    <table style="width: 100%" id="tblKpiTopicIndex">
        <tr>
            <th colspan="2" style="width: 400px;"><span id="lblKpiName"></span></th>
            <th><span id="lblKpiUnitName"> </span> </th>
            <th style="border-right: none;"><span id="lblKpiTime"> </span></th>
            <th style="min-width: 1px;border-left: none;"></th>
        </tr>
        #for(var i = 0;i < data.KpiTopics.length; i ++) {#
        #var item = data.KpiTopics[i];
        var lengthIndex = item.KpiIndexs.length;#
        <tr class="topic-header pointer">
            <td id="#:item.Id#" colspan="5" class="add-kpi-goal-td topicname noborder posRelative">
                <span id="sTopic#:i#" class="error-star-topic">*</span>
                <span class="TopicClickEdit">#:item.Name#</span>
                #if(item.KpiIndexs[0].Id == 0 && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)){#
                <span class="icon-20 icon-close pointer no-wrap pull-right" style="padding-left: 5px;" onclick="vmPopSetting.deleteKpiTopic(#:i #)"></span>
                #}#
            </td>
        </tr>
        #if(item.KpiIndexs[0].Id == 0 ){#
        <tr>
            <td colspan="5">
                #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
                <span id="spAddKpiIndex" class="icon-32 icon-kpi-add-gray pointer" onclick="vmPopSetting.OpenPopUpAddKpiIndex(#:i #,-1)"></span>
                #}#
            </td>
        </tr>
        #}else{#
        #for( var g = 0; g < lengthIndex; g++){#
        # var itemG = item.KpiIndexs[g];#
        <tr class="tr-kpi-hover pointer" id="#:itemG.Id#" parentid="#:item.Id#">
            <td class="posRelative">

                <span id="sIndex#:i##:g#" style="color: red; margin-top: -8px; font-size: 22px; display: none;position: absolute;left: -10px;bottom: 0;">*</span>

                #if((g == lengthIndex-1) && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)){#
                <span class="icon-28 icon-kpi-add-gray pointer" onclick="vmPopSetting.OpenPopUpAddKpiIndex(#:i #,#:g #)"></span>
                #}#
            </td>
            <td>
                <input class="modal-input txtInput w-94per" value="#:itemG.Name#" maxlength="50" onchange="vmPopSetting.changeNameIndex(this, #:i #,#:g #);" />
            </td>
            <td>
                <input class="cssKpiUnit" id="ddlKpiUnit#:i#a#:g#" value="#:itemG.KpiUnitId#" />
            </td>
            <td class="posRelative" style="border-right: none;">
                <input class="cssKpiTime" id="ddlKpiTime#:i#a#:g#" value="#:itemG.KpiTimeId#" />

            </td>
            <td class="posRelative" style="border-left: none;">
                #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
                <span class="icon-20 icon-close2 pointer no-wrap pull-right kpi-close posAbsolute" style="right: 3px;top: 7px;" onclick="vmPopSetting.deleteKpiIndex(#:i #,#:g #)"></span>
                #}#
            </td>
        </tr>
        #}#
        #}#
        #}#
        #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
        <tr>
            <td class="add-kpi-goal-td" style="text-align: center; padding-left: 0;">
                <span class="icon-28 icon-kpi-add-blue pointer" onclick="vmPopSetting.OpenPopUpAddKpiTopic()"></span>
            </td>
            <td colspan="3" class="noborder"></td>
        </tr>
        #}#
    </table>
</script>

<script type="text/html" id="template-parent-categories">
    <!-- End -->
    #if(data.length > 0 && data[0].Id != 0) {#
    #for( var j = 0; j < data.length; j++){#
    # var item = data[j];#
    # var classType = item.Type === vmPopSetting.enumsType.categoryAdvertisingMaterials?'childcategories':'advertiser'#
    <div style="margin-bottom:2px;" class="div-hover">
        <span class="icon-16 icon-arow-towway-vertical icon-category"></span>
        <div class="panel panel-default ms-parent w-full">
            <div class="panel-heading panel-heading-mass-parent" style="height: 18px; padding-top: 7px;">
                <h4 class="panel-title" style="float: left; line-height: normal; width: 96%;word-break: break-all;height: 22px;overflow: hidden;">
                    <a data-toggle="collapse" data-parent="\\#place-categories#:item.Type#" href="\\#childType#:item.Type##:item.Id#"
                       class="panel-online collapsed #:classType#" onclick="vmPopSetting.openAdvertises(#:item.Id#,#:item.Type #) ">
                        <span class="arrow-panel-online icon-24 icon-left-block arrow-collapse" style="margin-top: -2px;"></span>
                        <span>#:item.Name#</span>
                    </a>
                </h4>
            </div>
            <div id="childType#:item.Type##:item.Id#" class="panel-collapse collapse height0px parent-body">
                <!-- div gan teamplate template-setting-type-->
                <div id="child-place-Type#:item.Id#" class="modal-body ms-modal-body" type="content-table-child-categories#:item.Type#">
                </div>
                <!-- end div gan template template-setting-type -->
                #if((item.Type == vmPopSetting.enumsType.categoryAdvertisingMaterials) && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true)) {#
                <div style="margin-bottom: 15px;">
                    <table class="popup-table-email">
                        <tr>
                            <td style="padding-bottom: 7px !important;" itype="#:vmPopSetting.enumsType.categoryAdvertiser#">
                                <span id="lblAdvertiser#:item.Id#" class="ProductClickEdit">
                                    Advertiser
                                </span>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div style="display: flex">
                                    <input value="" name="CategoryName" class="categoryName" id="txtName#:item.Id#" />
                                    <span class="icon-32 icon-add" onclick="vmPopSetting.AddChildCategory(#:item.Id #)" style="margin-left: 8px;"></span>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                #}#
            </div>
        </div>
        #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true){#
        <div class="dnb-setting-menu" style="position:relative;top:-38px;right:0;float: right;z-index:1">
            <span class="icon-20  icon-right-block cursor-pointer icon-edit-white-independency" data-toggle="dropdown" style="position: absolute; right: 6px; top: 10px;"></span>
            <ul role="menu" class="popup-menu dropdown-menu ms-popup-menu-left" style="top: 26px !important; left: initial; right: 7px; bottom: initial;">
                <li>
                    <a class="dropdow-menu-li-a" style="width: inherit;" onclick=" vmPopSetting.OpenPopUpAddCategory(#:item.Type #,#:j #) ">
                        <span class="icon-24  icon-left-block icon-edit"></span>#:kLg.edit#
                    </a>
                </li>
                <li role="presentation" class="divider"></li>
                <li>
                    <a class="dropdow-menu-li-a" style="width: inherit;" onclick=" vmPopSetting.DeleteCategories(#:item.Type #,#:j #) ">
                        <span class="icon-24  icon-left-block icon-delete"></span>#:kLg.lblDelete#
                    </a>
                </li>
            </ul>
        </div>
        #}#
    </div>
    #}#
    #}#

</script>

<script type="text/html" id="template-parent-submarketproduct">
    #if(data.length > 0 && data[0].Id != 0) {#
    #for( var j = 0; j < data.length; j++){#
    # var item = data[j];#
    # var genIds = "" + item.Type + item.Level + item.Id;#
    # var isMarketType = item.Type == vmPopSetting.enumsType.categorySubmarket;#
    # var isProductType = item.Type == vmPopSetting.enumsType.categoryProduct;#
    # var isJourneyType = item.Type == vmPopSetting.enumsType.categoryCustomerJourney;#
    #
    var lang4Add = 'Add';
    switch(true)
    {
    case isMarketType && item.Level == 1:
    lang4Add = 'Add Submarket';
    break;
    case isMarketType && item.Level == 2:
    lang4Add = 'Add SubClient';
    break;
    case isProductType && item.Level == 1:
    lang4Add = 'Add Product';
    break;
    case isProductType && item.Level == 2:
    lang4Add = 'Add SubProduct';
    break;
    case isJourneyType && item.Level == 1:
    lang4Add = 'Add Journey';
    break;
    case isJourneyType && item.Level == 2:
    lang4Add = 'Add Sub-Journey';
    break;
    }
    lang4Add = vmPopSetting.getTitleForPopSubmarketProduct(item.Type, item.Level, kLg.add);
    var dragClass = 'SmpSeDragDrop' + item.Type + item.Level;
    #

    <div style="position: relative;margin-bottom:2px;" class="div-hover #:dragClass#" iid="#:item.Id#" itype="#:item.Type#" ilv="#:item.Level#" ipid="#:item.ParentId#">
        <span class="icon-16 icon-arow-towway-vertical icon-category"></span>
        <div class="panel panel-default ms-parent w-full">
            <div class="panel-heading panel-heading-mass-parent" style="height: 18px; padding-top: 7px;">
                <h4 class="panel-title" style="float: left; line-height: normal; width: 96%;word-break: break-all;height: 22px;overflow: hidden;">
                    <a data-toggle="collapse" data-parent="\\#place-categories#:item.Type#" href="\\#childType#:genIds#"
                       class="panel-online collapsed childsubmarketproduct#:genIds#" onclick="vmPopSetting.GetChildSubmarketProduct(#:item.Type#,#:item.Level#,#:item.Id#) ">
                        <span class="arrow-panel-online icon-24 icon-left-block arrow-collapse" style="margin-top: -2px;"></span>
                        <span>#:item.Name#</span>
                    </a>
                </h4>
            </div>

            <div id="childType#:genIds#" class="panel-collapse collapse height0px parent-body">
                <!-- div contents of child-->
                <div id="child-place#:genIds#" class="modal-body ms-modal-body" type="div-child-submarketproduct#:genIds#"></div>

                <!-- end div contents of child -->
                #if((isMarketType || isProductType || isJourneyType) && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true)) {#

                <div style="margin-bottom: 15px;">
                    <table class="popup-table-email w-100per">
                        #if(item.Level < 3){#
                        <tr>
                            <td style="padding-bottom: 7px !important;" itype="#:item.Type#" ilv="#:item.Level#">
                                <span id="lblParentCategory#:genIds#" class="ProductClickEdit">
                                </span>
                            </td>
                            <td></td>
                        </tr>
                        <tr>
                            <td style="float: left;">
                                <input value="" name="CategoryName" class="categoryName" id="txtName#:genIds#" />
                            </td>
                            <td style="float: left;">
                                <span class="icon-32 icon-add" onclick="vmPopSetting.addNameChildSubmarketProductSe(#:item.Type#,#:item.Id#,#:item.Level#)"></span>
                            </td>
                        </tr>
                        #}else{#
                        <tr>
                            <td style="padding-bottom: 7px !important;">
                                <label id="lblPopDescription">#:kLg.Description#</label>
                                <div class="clear"></div>
                                <textarea id="smpChildDescription#:genIds#" class="modal-textarea w-65per" style="height: 169px;"
                                          onchange="vmPopSetting.smpUpdateChildDes(#:item.Type#,#:item.ParentId#,#:item.Id#,#:item.Level#)">#:item.Description#</textarea>
                            </td>
                        </tr>
                        #if(!isJourneyType){#
                        <tr>
                            <td>
                                <label>#: kLg.lblDocument#</label>
                                #=vmPopSetting.smpRenDocument(item.Type, item.Level, item.ParentId, item.Id, item.SubmarketProductDocuments)#
                                <div class="clear"></div>
                                <button type="button" class="ms-button smp-button-upload" name="uploadFile"
                                        onclick="vmPopSetting.smpUploadDocument(#:item.Type#,#:item.Level#,#:item.ParentId#,#:item.Id#)">
                                    <span class="icon-16 icon-upload"></span><span>#: kLg.lblBrowse#</span>
                                </button>
                            </td>
                        </tr>
                        #}#
                        #}#
                    </table>
                </div>
                #}#

            </div>
        </div>
        #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true){#
        <div>
            <span class="icon-20  icon-right-block cursor-pointer icon-edit-white-independency" data-toggle="dropdown" style="position: absolute; right: 6px; top: 10px;"></span>
            <ul role="menu" class="popup-menu dropdown-menu ms-popup-menu-left" style="top: 26px !important; left: initial; right: 7px; bottom: initial;">
                <li><a class="dropdow-menu-li-a" style="width: inherit;" onclick=" vmPopSetting.popEditSubmarketProductSe(#:item.Type#,#:item.Id#,#:item.Level#) "><span class="icon-24  icon-left-block icon-edit"></span>#:kLg.edit#</a></li>
                <li role="presentation" class="divider"></li>
                #if(item.Level < 3){#
                <li><a class="dropdow-menu-li-a" style="width: inherit;" onclick=" vmPopSetting.popAddSubmarketProductSe(#:item.Type#,#:item.Id#,#:item.Level#) "><span class="icon-24  icon-left-block icon-add-region"></span> <span class="cssSpan#:item.Type##:item.Level#" style="float:left;max-width: 220px;overflow: hidden;">#: lang4Add#</span> </a></li>
                <li role="presentation" class="divider"></li>
                #}#
                <li><a class="dropdow-menu-li-a" style="width: inherit;" onclick=" vmPopSetting.deleteSubmarketProductSe(#:item.Type#,#:item.ParentId#,#:item.Id#,#:item.Level#) "><span class="icon-24  icon-left-block icon-delete"></span>#:kLg.lblDelete#</a></li>
            </ul>
        </div>
        #}#
    </div>
    #}#
    #}#

</script>

<script type="text/html" id="template-kpisettingindex">
    <div id="pop-kpisettingindex">
        <form id="add-kpitopic-form">
            <table style="width: 100%">
                <thead>
                    <tr>
                        <th style="width: 5%"></th>
                        <th style="width: 27%"><span id="lblKpiName"></span></th>
                        <th style="width: 18%"><span id="lblKpiUnitName">Unit</span></th>
                        <th class="no-wrap"><span id="lblKpiTime">Time</span></th>
                        <th><span id="lblKpiDefault">s=i</span></th>
                        <th style="width: 26%"><span id="lblKpiSollName"></span></th>
                        <th style="width: 5%"></th>
                    </tr>
                </thead>
                <tbody data-template="row-index-template" data-bind="source: settingIndexs"></tbody>
                <tfoot>
                    <tr data-bind="visible: isEmptyIndexs">
                        <td><span class="icon-32 icon-kpi-add-gray pointer" data-bind="visible: IsInvisible, events:{click: addKpiEmptyIndex}" style="margin-left: -3px;"></span> </td>
                        <td  colspan="6"></td>
                    </tr>
                </tfoot>
            </table>

            <div id="pop-kpiformat" class="dnb-settings-sub-sortable"
                 data-bind="source: settingFormats"
                 data-template="kpi-format-template"
                 style="margin-bottom: 20px;margin-top: 20px;position: relative;">
            </div>
            <div>
                <table data-bind="visible: IsInvisible" class="popup-table-email">
                    <tr>
                        <td colspan="2" style="padding-bottom: 7px !important;" class="none-border"><span data-bind="text: formatName"></span></td>
                    </tr>
                    <tr>
                        <td class="none-border">
                            <input value="" name="CategoryName" class="categoryName" data-bind="attr: { id: FormatTxt}" maxlength="100" />
                        </td>
                        <td valign="bottom" class="none-border">
                            <span class="icon-32 icon-add" data-bind="events:{click: addKpiEmptyFormat}"></span>
                        </td>
                    </tr>
                </table>
            </div>
        </form>
    </div>
    <div id="divSelectKpiIndex"></div>
</script>

<script id="row-index-template" type="text/x-kendo-template">
    <tr class="tr-kpi-hover">
        <td style="padding-left: 2px;"> <span class="icon-28 icon-kpi-add-gray pointer" data-bind="visible: VisualAdd, events:{click: addKpiIndex}"></span> </td>
        <td>
            <div style="width: 180px;float: left;overflow: hidden;">
                <span class="goal-truncate" data-bind="text: IndexName"></span>
                <span class="icon-20 icon-url pull-right pointer" style="display: inline-block;" data-bind="visible: IsInvisible, events:{click: selectKpiIndex}"></span>
            </div>
        </td>
        <td>
            <div style="width: 115px;float: left;overflow: hidden;">
                <span class="tdUnit" data-bind="text: KpiUnitName"></span>
            </div>
        </td>
        <td data-bind="text: KpiTimeName"></td>
        <td style="text-align: center">
            <input type="checkbox" data-bind="checked: IsKpiDefault , events:{change: onChangeDefault}, enabled: IsInvisible">
        </td>
        <td class="td-expected dnb-kpi-input" style="text-align:center;padding-left: 0;">
            <input class="text-right" data-max="999999999999" type="text" data-bind="value: ExpectedValue, events:{change: updateExpectedValue}, enabled: IsInvisible" 
                data-format="#:OrderFormat#" data-role="numerictextbox" data-spinners="false" style="width:96%;" />
        </td>
        <td class="posRelative">
            <span class="icon-20 icon-close2 pointer no-wrap pull-right posAbsolute kpi-close" style="top: 8px;right: 7px;" data-bind="visible: IsInvisible, events:{click: deleteKpiIndex}"></span>
        </td>
    </tr>
</script>

<script type="text/html" id="kpi-format-template">
    <div class="dnb-settings-sub-item panel panel-default ms-parent w-full div-hover"
         style="width: 99%; margin-bottom: 0px;overflow: inherit;">
        <div class="panel-heading panel-heading-mass-format">
            <h4 class="panel-title pull-left" style="line-height: normal; width: 96%; word-break: break-all; height: 22px; overflow: hidden;">
                <a id="linkkpiformat#:Id#" data-toggle="collapse" data-parent="\\#pop-kpiformat" href="\\#kpiformat#:Id#" class="panel-online collapsed childcategories" onclick="vmPopSetting.openFormat(#:Id #)" style="display: inline-block;">
                    <span class="arrow-panel-online icon-24 icon-left-block arrow-collapse"></span>
                    <!--<span style="height: 22px;overflow: hidden;"></span>-->
                    <span data-bind="text: Name"></span>
                </a>
            </h4>
        </div>

        <div id="kpiformat#:Id#" class="panel-collapse collapse height0px parent-body overflow-hidden">

            <form id="kpiformat-form#:Id#" class="valid-form" type="#:Id#">
                <div id="place-kpiformat#:Id#" class="modal-body ms-modal-body" type="content-table-categories">
                </div>
                <div style="padding-left: 8px;">

                    <table style="width: 99%; margin-bottom: 0;" class="modal-table-mass margin-modal tblformat">
                        # for(var i = 0; i < KpiFormatItems.length; i++) { #
                        #var item = KpiFormatItems[i]#
                        <tr>
                            <td style="padding-bottom: 7px !important; width: 30%;position:relative;">
                                <label>#:item.Name#</label>
                                <div class="clear"></div>
                                #=renFormatControl(item,CategoryId)#
                                #if(i > 2 && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true)){#
                                <span class="icon-20 icon-close2 pointer no-wrap pull-right" style="position:absolute;right:0;top:33px;" onclick="vmPopSetting.deleteFormatItem(#:item.Id #, #:CategoryId#)"></span>
                                #}#
                            </td>
                        </tr>
                        # } #

                        <tr>
                            #if(KpiFormatItems.length < 5 && (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting == true)){#
                            <td style="padding-bottom: 7px !important;" class="posRelative">
                                <span class="icon-32 icon-add pointer pull-left" onclick="" data-toggle="dropdown"></span>
                                <ul role="menu" class="popup-menu dropdown-menu ms-popup-menu-left" style="top: -6px; left: 47px;">
                                    <li data-bind="visible: IsCrmLink"><a style="width: inherit" class="dropdow-menu-li-a" data-bind="events:{click: addCrmLink}"><span class="icon-24  icon-left-block icon-add-region"></span>#:kLg.lblCrmLink#</a></li>
                                    <li data-bind="visible: IsHideLine" role="presentation" class="divider"></li>
                                    <li data-bind="visible: IsDocument"><a style="width: inherit" class="dropdow-menu-li-a" data-bind="events:{click: addDocument}"><span class="icon-24  icon-left-block icon-copy"></span>#:kLg.lblDocument#</a></li>
                                </ul>
                            </td>
                            #}#
                        </tr>
                    </table>
                </div>
                <p class="clear4px"></p>
            </form>
        </div>
        #if(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting){#
        <div style="position: absolute; right: 12px; top: 9px;">
            <span class="icon-20  icon-right-block cursor-pointer icon-edit-white-independency" data-toggle="dropdown" style="position: absolute; right: -8px;"></span>
            <ul role="menu" class="popup-menu dropdown-menu ms-popup-menu-left" style="right: -6px; top: 16px;">
                <li><a class="dropdow-menu-li-a" data-bind="events:{click: editKpiFormat}" style="width: inherit"><span class="icon-24  icon-left-block icon-edit"></span>#:kLg.edit#</a></li>
                <li role="presentation" class="divider"></li>
                <li><a class="dropdow-menu-li-a" data-bind="events:{click: deleteKpiFormat}" style="width: inherit"><span class="icon-24  icon-left-block icon-delete"></span>#:kLg.lblDelete#</a></li>
            </ul>
        </div>
        #}#
    </div>
</script>

<script src="Scripts/jquery.multiple.select.js"></script>
<!-- ReSharper disable ClosureOnModifiedVariable -->
<!-- ReSharper disable CoercedEqualsUsing -->
<script type="text/javascript">
    var projectId = 42381;
var strategyId = 44743;
var language = 'en';
    var vmPopSetting = vmSetting || {};
    vmPopSetting.enumsType = {
        categoryGoal: 1,
        categoryAction: 2,
        categoryGoalEval: 3,
        categoryCurrency: 4,
        categoryStrategy: 5,
        categoryInstrument: 6,
        categoryField: 7,
        categorySatus: 8,
        categoryPlanning: 9,
        categoryAdvertisingMaterials: 10,
        categoryAdvertiser: 11,
        categoryProjectLanguage: 12, //SONPT. Show panel project language
        categoryFibu: 13,
        categorySupplier: 14,
        categorySubjetThema: 15,
        categoryKpiIndex: 16,
        categoryKpiUnit: 17,
        categoryKpiTime: 18,
        categoryKpiSettingIndex: 19,
        categoryKpiFormat: 20,
        categoryProduct: 21,
        categorySubmarket: 22,
        categoryCustomerJourney: 23,
        SharepointLinkControl: 24,
        catColorPalette: 25
    };

    vmPopSetting.enumFibuType = {
        Nr: 1,
        Des: 2
    };

    vmPopSetting.enumTypeKPI = {
        Number: 1,
        Currency: 2,
        Percent: 3,
        Index: 4,
        M2: 5,
        Hour: 6
    };

    vmPopSetting.enumKpiPosition = {
        Left: 1,
        Right: 2,
        Middle: 3
    };
    vmPopSetting.enumKpiOrder = {
        Before: 1,
        Behind: 2
    };

    vmPopSetting.arrCategories = [];
    vmPopSetting.PlanningList = [];
    vmPopSetting.obj = new queryString(true);
    vmPopSetting.projectId = vmPopSetting.obj.get("projid") || 0;

    vmPopSetting.arrayLabel = [
        { Type: vmPopSetting.enumsType.categoryPlanning, Title: kLg.titleProjectSetting, Name: kLg.titleProjectSetting, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.categoryGoal, Title: kLg.editCategories, Name: kLg.lblNameCatGoal, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.categoryAction, Title: kLg.editCategories, Name: kLg.lblNameAction, Required: kLg.msgErrorRequiredAction, MaxLength: kLg.msgErrorMaxLenghtAction },
        { Type: vmPopSetting.enumsType.categoryGoalEval, Title: kLg.editCategories, Name: kLg.labelEvaluation, Required: kLg.msgErrorRequiredGoalEval, MaxLength: kLg.msgErrorMaxLenghtGoalEval },
        { Type: vmPopSetting.enumsType.categoryCurrency, Title: kLg.editCategories, Name: kLg.Currency, Required: kLg.msgErrorRequiredCurrency, MaxLength: kLg.msgErrorMaxLenghtCurrency },
        { Type: vmPopSetting.enumsType.categoryFibu, Title: kLg.editCategories, Name: kLg.titleActionFibu, Required: kLg.msgErrorRequiredFibu, MaxLength: kLg.msgErrorMaxLenghtFibu },
        { Type: vmPopSetting.enumsType.categoryStrategy, Title: kLg.editCategories, Name: kLg.lblVolumeStrategy, Required: kLg.msgErrorRequiredStrategy, MaxLength: kLg.msgErrorMaxLenghtStrategy },
        { Type: vmPopSetting.enumsType.categoryKpiIndex, Title: kLg.menuKpiIndex, Name: kLg.menuKpiIndex, Required: kLg.msgErrorRequiredFibu, MaxLength: kLg.msgErrorMaxLenghtFibu },
        { Type: vmPopSetting.enumsType.categoryInstrument, Title: kLg.editCategories, Name: kLg.menuInstrument, Required: kLg.msgErrorRequiredInstrument, MaxLength: kLg.msgErrorMaxLenghtInstrument },
        { Type: vmPopSetting.enumsType.categoryProduct, Title: kLg.filterLblProductGroup, Name: kLg.filterLblProductGroup, Required: kLg.requiredName, MaxLength: kLg.msgMaxLength100 },
        { Type: vmPopSetting.enumsType.categorySubmarket, Title: kLg.titleStackholderGroups, Name: kLg.titleStackholderGroups, Required: kLg.requiredName, MaxLength: kLg.msgMaxLength100 },
        { Type: vmPopSetting.enumsType.categoryCustomerJourney, Title: kLg.vtextCustomerJourney, Name: kLg.vtextCustomerJourney, Required: kLg.requiredName, MaxLength: kLg.msgMaxLength100 },
        { Type: vmPopSetting.enumsType.categoryAdvertisingMaterials, Title: kLg.editCategories, Name: kLg.lblNameAdvertisingMaterials, Required: kLg.msgErrorRequiredAdvertisingMaterials, MaxLength: kLg.msgErrorMaxLenghtAdvertisingMaterials },
        { Type: vmPopSetting.enumsType.categorySubjetThema, Title: kLg.editCategories, Name: kLg.lblNameSubjetThema, Required: kLg.msgErrorRequiredSubjetThema, MaxLength: kLg.msgErrorMaxLenghtSubjetThema },
        { Type: vmPopSetting.enumsType.categorySupplier, Title: kLg.editCategories, Name: kLg.lblFilterSupplier, Required: kLg.msgErrorRequiredCatSuppliers, MaxLength: kLg.msgErrorMaxLenghtCatSuppliers },
        { Type: vmPopSetting.enumsType.categoryField, Title: kLg.editCategories, Name: kLg.gaLblField, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.SharepointLinkControl, Title: kLg.editCategories, Name: kLg.SharepointLinkControl, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.categorySatus, Title: kLg.editCategories, Name: kLg.gaLblStatusProtocol, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.catColorPalette, Title: kLg.editCategories, Name: kLg.lblColorPalette, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal },
        { Type: vmPopSetting.enumsType.categoryProjectLanguage, Title: kLg.titleProjectLanguageSetting, Name: kLg.titleProjectLanguageSetting, Required: kLg.msgErrorRequiredCatGoal, MaxLength: kLg.msgErrorMaxLenghtCatGoal }
    ];

    vmPopSetting.enumLanguage = {
        1: 'lblNameCatGoal',
        2: 'lblNameAction',
        3: 'labelEvaluation',
        4: 'Currency',
        5: 'lblVolumeStrategy',
        6: 'menuInstrument',
        7: 'gaLblField',
        8: 'gaLblStatusProtocol',
        10: 'lblNameAdvertisingMaterials',
        12: 'titleProjectLanguageSetting',
        13: 'titleActionFibu',
        14: 'lblFilterSupplier',
        15: 'lblNameSubjetThema',
        16: 'menuKpiIndex',
        17: 'lblKpiUnit',
        18: 'lblKpiTimePeriod',
        19: 'lblKpiIndex',
        20: 'lblKpiFormat',
        21: 'filterLblProductGroup',
        22: 'titleStackholderGroups',
        23: 'vtextCustomerJourney',
        24: 'SharepointLinkControl',
        25: 'lblColorPalette'
    };

    vmPopSetting.arrayMarketLanguage = ["tabMarketSegment", "titleMarketSegment", "marketInfo", "lblLands", "AddLand", "lblRegions", "addRegion",
        "lblMarktsegemente", "btnAddMarketSegment", "btnEvaluationSub", "btnStrategy", "btnMoney", "space", "strategyTab"];
    vmPopSetting.arraySubMarketLanguage = ["tabSubMarketProduct", "Produktstrategie", "lblProductGroup", "lblProductGroupLabelL1", "AddProductGroup",
        "createNewProduct", "addProduct", "lblSubmarket", "addNewStakeholderGroup", "menuEvaluation", "menuMatrix", "menuStr", "menuMoney", "AddLable",
        "ExpandLabel", "lblSubProductGroup", "subClient"];
    vmPopSetting.arrayActionPlan = ["tabActionPlan", "labelMainGoalName", "labelSubGoalName", "labelActionName"];
    vmPopSetting.arrayMarketingMix = ["tabMarketingmix"];

    vmPopSetting.arrayRoadmap = ["tabRoadmap"];

    vmPopSetting.arrayTeamboard = ["tabTeamboard"];

    vmPopSetting.arraySettingKpi = [
        { Type: vmPopSetting.enumsType.categoryKpiUnit, Title: kLg.lblKpiUnit, Name: kLg.lblKpiUnit, Required: '', MaxLength: '' },
        { Type: vmPopSetting.enumsType.categoryKpiTime, Title: kLg.lblKpiTimePeriod, Name: kLg.lblKpiTimePeriod, Required: '', MaxLength: '' },
        { Type: vmPopSetting.enumsType.categoryKpiSettingIndex, Title: kLg.menuKpiIndex, Name: kLg.menuKpiIndex, Required: '', MaxLength: '' },
        { Type: vmPopSetting.enumsType.categoryKpiFormat, Title: kLg.lblKpiFormat, Name: kLg.lblKpiFormat, Required: '', MaxLength: '' }
    ];

    vmPopSetting.enumsRoleConflict = {
        conflict: -1,
        noRole: 0,
        using: -2,
        nameExist: -3,
        valueempty: -4
    };

    var dataState = { Detached: 1, Unchanged: 2, Added: 4, Deleted: 8, Modified: 16 };

    $("#pop-setting").on('keydown', function (e) {
        if (e.keyCode == 9 || e.keyCode == 13) {
            e.preventDefault();
            return;
        }
    });

    var divFibu = "place-categories" + vmPopSetting.enumsType.categoryFibu;

    vmPopSetting.ConvertToListLanguage = function (listLang) {
        var listObjectReturn = [];
        for (var i = 0; i < listLang.length; i++) {
            var item = { Label: kLg['caption' + listLang[i]], Value: htmlEscape(kLg[listLang[i]]), Langkeyname: listLang[i] };
            listObjectReturn.push(item);
        }
        return listObjectReturn;
    };

    vmPopSetting.saveCustomLanguage = function (htmlelement) {
        if (htmlelement.value) {
            var objProjectLang = { Id: 0, ProjectId: projectId, ClientKeyName: htmlelement.getAttribute('langkeyname'), LangId: language, Value: htmlelement.value }
            var url = "../Handlers/SettingHandler.ashx?funcName=savecustomlanguage" + "&projid=" + projectId + "&strid=" + strategyId + "&lang=" + language;
            callAjax('categories-loading', url, JSON.stringify(objProjectLang), function (data) {
                htmlelement.defaultValue = htmlelement.value;
                var _langKeyName = $(htmlelement).attr('langkeyname');
                if (_langKeyName === "lblProductGroupLabelL1") {
                    if (typeof (vmSProduct) !== "undefined") {
                        if (kLg.lblProductGroup.localeCompare(htmlelement.value) !== 0) {
                            kLg.lblProductGroup = htmlelement.value;
                        }
                        vmSProduct.setLanguage(htmlelement.value);
                    }
                } else if (_langKeyName === "lblMarktsegemente") {
                    if (kLg.lblMarktsegemente.localeCompare(htmlelement.value) !== 0) {
                        kLg.lblMarktsegemente = htmlelement.value;
                    };
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.Market) && typeof (vmSMarket) !== "undefined") {
                        //vmSMarket.setTitleMarketSegment(); setMarketSearchFilter();
                        vmSMarket.Service.getMarket();
                    }
                }
            }, AjaxConst.PostRequest);
        } else {
            $(htmlelement).val(htmlelement.defaultValue);
        }
    };
    
    vmPopSetting.OnClickCheckBox = function (e, id, type) {
        var $this = $(e);
        var category = vmPopSetting.findCategory(type, id);
        category.NonArchive = $this[0].checked;
        //if (type == vmPopSetting.enumsType.categoryInstrument) vmPopSetting.isReloadData = false;
        var url = "../Handlers/SettingHandler.ashx?funcName=updatenonarchive&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(category), function (data) {
            var state = data.value;
            vmPopSetting.UpdateCallBack(state, category.Type);
        }, AjaxConst.PostRequest);
    };

    vmPopSetting.OnChangeCurrency = function (e, id) {
        var $this = $(e);
        vmPopSetting.DestroyToolTip($this);
        var valueRate = $this[0].value;
        //check first/last character
        if (valueRate) {
            if (valueRate.charAt(0) === "." || valueRate.charAt(valueRate.length - 1) === ".") {
                vmPopSetting.ShowToolTip($this, kLg.InvalidData, "top");
                return;
            }
        }

        if (isNaN(valueRate)) {
            vmPopSetting.ShowToolTip($this, kLg.InvalidData, 'top');
            return;
        }
        var category = { Id: id, Extension: valueRate }
        var url = "../Handlers/SettingHandler.ashx?funcName=updatecurrency&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(category), null, AjaxConst.PostRequest);
    };
    function addNewScript() {
        var _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.core.js`;
        _scrt.setAttribute('id', 'dnb_kendoColorpicker_newlibrary_2021_3_1207');
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.color.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.popup.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.userevents.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.draganddrop.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.slider.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.badge.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.button.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.data.odata.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);
        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.data.xml.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);
        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.data.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.binder.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.floatinglabel.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);
        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.textbox.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.numerictextbox.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);

        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/colorpicker/flatcolorpicker.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);
        _scrt = document.createElement('SCRIPT');
        _scrt.src = `Scripts/2021.3.1207/kendo.colorpicker.js`;
        $('#categories25 .dnb-kendonewlib').append(_scrt);
        kendo.culture(vmCommon.getCultureLang());
    }
    vmPopSetting.getAndBindColorPalette = function (colorPalettes) {
        vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette] = colorPalettes;

        updatePaletteFrom(colorPalettes.map(i => { return i.MValue; }));

        bindTemplate('tables-settings25-colorpalette', "template-tables-colorpalettes", colorPalettes);

        if (vmPopSetting.IsOwner && $('#categories25 #dnb_kendoColorpicker_newlibrary_2021_3_1207').length < 1) {
            addNewScript();
        };
        colorPalettes.forEach((item, r) => {
            var colorVal = item.MValue ? item.MValue : '#b8c92e';
            var cmId = colorVal.substring(1);
            var _options = {
                preview: false,
                input: true,
                value: colorVal,
                columns: 9, tileSize: 25,
                palette: [
                    '#1FD4AF', '#b84300', '#6b5800', '#004300', '#00555e', '#002f73', '#5421ab', '#5f3d1d', '#191919',
                    '#DE7EB5', '#fd7400', '#c1aa03', '#0a7c00', '#009181', '#0046a8', '#9a22cc', '#905011', '#373737',
                    '#EAE572', '#fb9f00', '#f2d500', '#b8c92e', '#00c2a7', '#256bd0', '#eb23af', '#a86925', '#5c5c5c',
                    '#DE9C7E', '#ffd314', '#fff814', '#4dfd1a', '#4effea', '#65a0f4', '#ff68d3', '#de9038', '#9a9a9a',
                    '#ffcab3', '#fff1b4', '#fffdcf', '#d1ff4b', '#c2fff2', '#a8cbff', '#ffb4fc', '#f8bb6c', '#dcdcdc'
                ]
            };

            if (vmPopSetting.IsOwner) {
                _options = Object.assign(_options, {
                    format: "hex", formats: ["hex"],
                    view: "gradient", views: ["gradient", "palette"],
                    change: onSelect
                });

                if (vmCommon.isDeLang()) {
                    _options.open = function onOpenColorPicker(e) {
                        var $popup = e.sender._popup.element;
                        $popup.find('button.k-coloreditor-cancel.k-button').text(kLg.cancel);
                        $popup.find('button.k-coloreditor-cancel.k-button').attr('title', kLg.cancel);
                        $popup.find('button.k-coloreditor-apply.k-button').text(kLg.Apply);
                        $popup.find('button.k-coloreditor-apply.k-button').attr('title', kLg.Apply);
                    }
                }

                $(`#_stDnbColorMixerView__${cmId}___${item.Id}`).kendoColorPicker(_options);

                $(`#_stDnbColorMixerInput__${cmId}___${item.Id}`).on("focusout", onFocusOut);
                $(`#_stDnbColorMixerInput__${cmId}___${item.Id}`).on('keydown', onKeyDown);
                $(`#_stDnbColorMixerText__${cmId}___${item.Id}`).on('dblclick', onDblClickText);
            } else {
                $(`#_stDnbColorMixerView__${cmId}___${item.Id}`).kendoColorPicker(_options);
                var colorpicker = $(`#_stDnbColorMixerView__${cmId}___${item.Id}`).data("kendoColorPicker");
                colorpicker.enable(false);
                $('#tables-settings25-colorpalette .k-widget.k-colorpicker.k-header.k-state-disabled span.k-select[aria-label="select"]').remove();
            }
        });

        if (vmPopSetting.IsOwner)
            $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable({
                connectWith: ".connectedSortablePalette",
                handle: ".dnb-colorpicker-textview-none-select",
                placeholder: "ui-state-highlight",
                stop: function (event, ui) {
                    var $itemFrom = ui.item;
                    var $toItemBefore = ui.item.next();
                    var $toItemAfter = ui.item.prev();

                    var fromId = $itemFrom.attr('data-id');
                    fromId = +fromId;
                    var toIdAfter = -1;
                    if ($toItemAfter.length > 0) {
                        toIdAfter = +($toItemAfter.attr('data-id'));
                    }
                    var toIdBefore = -1;
                    if (toIdAfter < 0 && $toItemBefore.length > 0) {
                        toIdBefore = +($toItemBefore.attr('data-id'));
                    }
                    if (toIdBefore < 0 && toIdAfter < 0) {
                        $('.connectedSortablePalette').sortable("cancel");
                        return;
                    }
                    if (isNewPos(fromId, toIdBefore, toIdAfter)) {
                        handlerDragdrop(fromId, toIdBefore, toIdAfter);
                    } else {
                        $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("cancel");
                    }
                }
            });
        else {
            $('.dnb-cp-item .dnb-colorpicker-textview-none-select').addClass('view');
        }

        if (colorPalettes.length > 9) { // fixbug nhay nut addColor khi keo tha
            $('#tables-settings25-colorpalette').css({ 'min-height': '357px' });
            $('#tables-settings25-colorpalette').css({ 'padding-bottom': '' });
        } else {
            $('#tables-settings25-colorpalette').css({ 'min-height': '' });
            $('#tables-settings25-colorpalette').css({ 'padding-bottom': '48px' });
        }

        if (colorPalettes.length > 44) {
            $('#categories-view25').find('.icon-add').hide();
        }
        if (vmPopSetting.IsOwner) {
            $(`#pop-setting-place #categories25`).off('hidden.bs.collapse').on('hidden.bs.collapse', function () {
                $('.dnb-kendonewlib').html('');
                (typeof reLoadOldLibrary == 'function') && (reLoadOldLibrary())
            });
        }
        
        function handlerDragdrop(fromId, toIdBefore, toIdAfter) {
            $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("disable");
            const entry = { FromId: fromId, ToIdBefore: toIdBefore, ToIdAfter: toIdAfter };
            var url = `../Handlers/SettingHandler.ashx?funcName=dragdropcolor&projid=${projectId}`;
            callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
                if (data.ResultStatus < vmCommon.ResultData.SUCCESS) {
                    $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("enable");
                    return;
                }
                vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette] = data.TheObject;
                vmPopSetting.getAndBindColorPalette(data.TheObject)
            }, AjaxConst.PostRequest);
        }
        function isNewPos(id, idbefore, idafter) {
            const lsC = vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette];
            var i1 = -1;
            var e = lsC.filter(function (e, ii) {
                if (e.Id == id) {
                    i1 = ii;
                    return true;
                }
                return false;
            });
            var i0 = i1 > 0 ? lsC[i1 - 1].Id : -3;
            if (i0 == idafter) return false;
            var i2 = i1 < lsC.length - 1 ? lsC[i1 + 1].Id : -3;
            if (i2 == idbefore) return false;
            return true;
        }
        function onSelect(e) {
            var $elm = e.sender.element;
            var _id = $elm.attr('id');
            var _color = e.value;   // #aab123
            
            if (isChange(_id, _color, 'stDnbColorMixerView')) {
                updateValueAndHideInput(_id, _color);
                updateIdColorPicker(_id, _color.substring(1));
                updateIdAndEventInput(_id, _color.substring(1), 'stDnbColorMixerView');
                updateWarningId(_id, _color.substring(1), 'stDnbColorMixerView');
                updateIdAndEventText(_id, 'stDnbColorMixerView', _color.substring(1));

                handlerUpdate(getElementId(_id), _color);
            }
        }
        function onDblClickText(e) {
            var $this = $(e.target);
            var elmId = $this.attr('id');
            $this.hide();
            showInput(elmId);
        }
        function updateIdAndEventText(id, key, newColor){
            var oldColor = getOldColor(id, key);
            id = id.replace(key, 'stDnbColorMixerText');
            var $spnText = $(`#${id}`);
            $spnText.text(`#${newColor}`);
            $spnText.attr('id', id.replace(oldColor, newColor));
            $spnText.off('dblclick');
            $spnText.on('dblclick', onDblClickText);
            $spnText.show();
        }
        function showInput(elmId) {
            var inputId = elmId.replace('stDnbColorMixerText', 'stDnbColorMixerInput');
            var $input = $(`#${inputId}`);
            $input.show();
            $input.focus()
        }
        function updateIdColorPicker(id, newColor, sourceTxt) {
            var $color, oldColor;
            if (!sourceTxt) {
                oldColor = getOldColor(id, 'stDnbColorMixerView');
            } else {
                oldColor = getOldColor(id, sourceTxt);
                id = id.replace(sourceTxt, 'stDnbColorMixerView');
            }
            $color = $(`#${id}`);
            $color.attr('id', id.replace(oldColor, newColor));
        }
        function updateIdAndEventInput(id, newColor, sourceTxt) {
            var oldColor, $input;
            if (!sourceTxt) {
                oldColor = getOldColor(id, 'stDnbColorMixerInput');
            } else {
                oldColor = getOldColor(id, sourceTxt);
                id = id.replace(sourceTxt, 'stDnbColorMixerInput');
            }
            $input = $(`#${id}`);
            id = id.replace(oldColor, newColor);
            $input.off('focusout');
            $input.off('keydown');
            $input.attr('id', id);
            $input.attr('value', `#${newColor}`);
            $input.on("focusout", onFocusOut);
            $input.on("keydown", onKeyDown);
        }
        function updateWarningId(id, newColor, sourceTxt) {
            var oldColor = getOldColor(id, sourceTxt);
            id = id.replace(sourceTxt, 'stDnbColorMixerWarning');
            var $warning = $(`#${id}`);
            var newWarningId = id.replace(oldColor, newColor);
            $warning.attr('id', newWarningId);
        }
        function updateValueAndHideInput(id, newVal) {
            if (!isHexColor(newVal)) return;
            id = id.replace('stDnbColorMixerView', 'stDnbColorMixerInput');
            $(`#${id}`).val(newVal);
            $(`#${id}`).hide();
            toggleWarning($(`#${id}`), true);
        }
        function getElementId(tagId) {
            var b = tagId.indexOf('___');
            var a = tagId.substring(b + 3);
            return +a;
        }
        function isHexColor(color) {    // #aab123 or #123
            if (typeof color !== 'string') return false;
            if (color.indexOf('#') !== 0) return false;
            if (color.length === 4) {   // #123
                return /^#([0-9A-F]{3}){1,2}$/i.test(color);
            }
            return /^#[0-9A-F]{6}$/i.test(color);
        }
        function isChange(id, hexValue, sourceTxt) {
            if (typeof id !== 'string' || typeof hexValue !== 'string') return false;
            var color = getOldColor(id, sourceTxt);
            hexValue = hexValue.substring(1);   //  #aab123 => aab123
            color = color.toLowerCase();
            hexValue = hexValue.toLowerCase();
            return color !== hexValue;
        }
        function getOldColor(id, fromTxt) {
            if (typeof id !== 'string' || typeof fromTxt !== 'string') return '';
            var _a = id.replace(`_${fromTxt}__`, '');  // `${cmId}___${r}`
            var _i = _a.indexOf(`___`);
            return _a.substring(0, _i);
        }
        function onKeyDown(e) {
            // e.keyCode: 9 = tab key; 13 = enter key
            if (!!e && (e.keyCode == 9 || e.keyCode == 13)) {    // enter key
                e.preventDefault();
                onFocusOut(e);
                return;
            }
        }
        function onFocusOut(e) {
            var _color = $(e.target).val();   // #aab123
            var id = $(e.target).attr('id');
            
            if (isHexColor(_color)) {
                toggleWarning($(e.target), true);

                if (isChange(id, _color, 'stDnbColorMixerInput')) {
                    var $colorPicker = id.replace('stDnbColorMixerInput', 'stDnbColorMixerView');
                    $colorPicker = $(`#${$colorPicker}`).data('kendoColorPicker');
                    $colorPicker.value(_color);

                    updateIdColorPicker(id, _color.substring(1), 'stDnbColorMixerInput');
                    updateIdAndEventInput(id, _color.substring(1));
                    updateWarningId(id, _color.substring(1), 'stDnbColorMixerInput');
                    updateIdAndEventText(id, 'stDnbColorMixerInput', _color.substring(1));

                    handlerUpdate(getElementId(id), _color);
                } else {
                    showTextView(id, 'stDnbColorMixerInput');
                }
                $(e.target).hide();
            } else {    // warning
                toggleWarning($(e.target));
                // bind event hover show tooltip
            }
        }
        function showTextView(id, key) {
            id = id.replace(key, 'stDnbColorMixerText');
            $(`#${id}`).show();
        }
        function toggleWarning($input, isHide) {
            var id = $input.attr('id');
            id = id.replace('stDnbColorMixerInput', 'stDnbColorMixerWarning');
            if (isHide) {
                $input.removeClass('st-cm-color-invalid');
                $(`#${id}`).hide();
                $input.tooltip('disable');
                return;
            }
            $input.tooltip({
                title: kLg.InvalidData,
                trigger: 'hover'
            });
            $input.tooltip('enable');
            $input.addClass('st-cm-color-invalid');
            $(`#${id}`).show();
        }
        function handlerUpdate(elementId, newColor) {   // '#123abc'
            const entry = { Id: elementId, MValue: newColor };
            var url = `../Handlers/SettingHandler.ashx?funcName=editcolor&projid=${projectId}`;
            callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
                if (data <= vmCommon.ResultData.NO_ROLE) return;
                var item = vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].find(c => {
                    return c.Id == entry.Id;
                });
                (!!item) && (item.MValue = newColor);
                updatePaletteFrom(vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].map(i => { return i.MValue; }));
            }, AjaxConst.PostRequest);
        }
    };
    vmPopSetting.AddColor = function (elm) {
        if (vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].length > 44) {
            $('#categories-view25').find('.icon-add').hide();
            return;
        }
        var $elm = $(elm);
        const entry = { Id: 0, MValue: '#b8c92e' };
        var url = `../Handlers/SettingHandler.ashx?funcName=addcolor&projid=${projectId}`;

        $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("disable");
        $elm.css({'pointer-events' : 'none'});

        callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
            $elm.css({ 'pointer-events': '' });
            if (data.ResultStatus < vmCommon.ResultData.SUCCESS) {
                $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("enable");
                return;
            }
            vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].push(data.TheObject);
            vmPopSetting.getAndBindColorPalette(vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette]);
            updatePaletteFrom(vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].map(i => { return i.MValue; }));
        }, AjaxConst.PostRequest);
    };
    vmPopSetting.deleteColor = function (id) {
        var cPalettes = vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette];
        if (cPalettes.length < 2) return;
        pConfirm(kLg.TxtDelColor).then(function () {
            const entry = cPalettes.find(item => item.Id == id);
            var url = `../Handlers/SettingHandler.ashx?funcName=deleteColor&projid=${projectId}`;
            $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("disable");
            callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
                if (data < -1) { // (int)MsResultStatus.Error = -2;
                    pAlert(kLg.msgConflictData);        // F5
                }
                if (data < 1) {
                    $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("enable");
                    return;
                }
                vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette] = cPalettes.filter(i => i.Id != id);
                vmPopSetting.getAndBindColorPalette(vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette]);
                updatePaletteFrom(vmPopSetting.arrCategories[vmPopSetting.enumsType.catColorPalette].map(i => { return i.MValue; }));
            }, AjaxConst.PostRequest);
            $('#categories-view25').find('.icon-add').show();
        }, function cancel() {                      // click cancel or X
            $(`#tables-settings25-colorpalette .connectedSortablePalette`).sortable("enable");
        });
    };
    vmPopSetting.GetCategories = function (type) {
        if (type != 7) {
            $("div[type=content-table-categories]").html("");
        }

        if ($("input[name='CategoryName']").length > 0)
            $("input[name='CategoryName']").tooltip('destroy');

        vmCommon.bindChangeIcon();
        switch (type) {
            case vmPopSetting.enumsType.categoryPlanning:
                vmPopSetting.loadPlanningList(type);
                break;
            case vmPopSetting.enumsType.categoryProjectLanguage:
                if ($('#categories' + type).height() > 0) {
                    $('#categories' + type).prev().find('.arrow-panel-online.icon-24.icon-left-block').click(function () {
                        if ($(this).hasClass('arrow-right-big')) {
                            $(this).removeClass('arrow-right-big');
                            $(this).addClass('arrow-collapse');
                        } else {
                            $(this).addClass('arrow-right-big');
                            $(this).removeClass('arrow-collapse');
                        }
                    });
                } else {
                    vmPopSetting.loadProjectLanguage(type);
                }
                break;
            case vmPopSetting.enumsType.categoryFibu:
                vmPopSetting.loadDataFibu();
                break;
            case vmPopSetting.enumsType.categoryKpiIndex:
                vmPopSetting.loadKpiSetting();
                break;
            
            default:
                vmPopSetting.GetTemplateCategories(type);
                break;
        }
    };

    vmPopSetting.bindSharepointLinkController = function (type, dataSource) {
        function editService() {
            var _rootUrl_ = "../Handlers/SettingHandler.ashx?parentType=" + vmPopSetting.enumsParentType.Marketing + "&type=" + type + "&projid=" + projectId;

            return {
                delete: function (item, callback) {
                    var url = _rootUrl_ + "&funcName=deletelinksharepoint";
                    callAjax('categories-loading', url, JSON.stringify(item), callback, AjaxConst.PostRequest);
                },
                update: function (item, callback) {
                    var url = _rootUrl_ + "&funcName=editlinksharepoint";
                    callAjax('categories-loading', url, JSON.stringify(item), callback, AjaxConst.PostRequest);
                }
            }
        }
        
        var divIdRoadmap = "place-categories" + type + '-roadmap';
        var divIdMix = "place-categories" + type + '-mix';
        var langHeads = [kLg.linksName, kLg.filterfirstname, kLg.filterlastname, /*kLg.Department,*/ kLg.LblIpAddress, kLg.exportTime, kLg.lblActive, kLg.textLink, ''];
        var roadmapType = 'roadmap';
        bindTemplate(divIdRoadmap, "template-tbl-sp-link", {
            Type: roadmapType,    // Roadmap
            Heads: langHeads
        });
        var mixType = 'mix';
        bindTemplate(divIdMix, "template-tbl-sp-link", {
            Type: mixType,    // Mix
            Heads: langHeads
        });

        dataSource = dataSource.length > 0 ? dataSource[0] : { Roadmap: [], Mix: [] };
        function toDateTime(exportDate) {
            if (exportDate) {
                var time = parseInt(exportDate.substring(6));
                var date = new Date(time);

                exportDate = kendo.toString(date, 'd') + "  " + kendo.toString(date, 'HH:mm:ss');
            } else {
                exportDate = '';
            }
            return exportDate;
        }
        var dataRoadmap = dataSource.Roadmaps.map(item => {
            var exDate = item.ExportDate;
            if (vmPopSetting.IsEditSetting) {
                item.IsEdit = vmPopSetting.IsEditSetting;
            }
            item.ExportDateStr = toDateTime(exDate);
            
            return item;
        });
        var dataMix = dataSource.Mixes.map(item => {
            var exportDate = item.ExportDate;
            if (vmPopSetting.IsEditSetting) {
                item.IsEdit = vmPopSetting.IsEditSetting;
            }
            item.ExportDateStr = toDateTime(exportDate);
            return item;
        });

        var modelOptions = {
            deleteLink: function (e) {
                var model = this;       // vmPopSetting.ModelRoadmap or vmPopSetting.ModelMix
                
                if (model.get('IsChkBoxEnabled')) {
                    model.set('IsChkBoxEnabled', false);

                    var source = model.get("dataLinks");
                    var item = e.data;

                    // show popup
                    pConfirm(kLg.confirmDeleteLabel).then(function ok() { // click ok

                        editService().delete(item, function (data) {

                            model.set('IsChkBoxEnabled', true);

                            if (typeof msFilter == 'object' && typeof msFilter.controlService == 'object') {
                                msFilter.controlService.getCurrentModel().setChage(item.TypeId);
                            }
                        });

                        // update ui
                        var newSource = source.filter(itm => { return itm.Id != item.Id });
                        model.set("dataLinks", newSource);
                    }, function cancel() {                      // click cancel or X

                            model.set('IsChkBoxEnabled', true);
                    });
                }
            },
            
            IsChkBoxEnabled: true,
            getCheckActive: function (e) {
                var item = e.data;
                if (item.IsEdit != true)
                    return;

                var model = this;
                model.set('IsChkBoxEnabled', false);

                var entry = { Id: item.Id, IsActive: !item.IsActive, TypeId: item.TypeId };

                editService().update(entry, function (data) {
                    var resultStatus = data.value.ResultStatus;
                    if (resultStatus == vmCommon.ResultState.SUCCESS) {
                        model.set('IsChkBoxEnabled', true);
                    }
                });
            },
            copyLinkToClipboard: function (e) {
                //var model = this;
                var item = e.data;
                if (item.Link.trim() == "")
                    return;
                
                vmCommon.coppyToClipboard(item.Link);

                var $target = $(e.target);
                //var $parent = $target.parent();
                $target.append(`<span id="tooltip-${item.Id}-${item.TypeId}"></span>`);
                var $tpl = $(`#tooltip-${item.Id}-${item.TypeId}`);
                
                $tpl.attr('title', kLg.CopyClipBoard);
                $tpl.tooltip({ placement: 'top', trigger: 'manual' }).tooltip('show');
                setTimeout(function () {
                    $tpl.tooltip('destroy');
                    $tpl.remove();
                }, 989);
                
            },
            onCloseLstIpAddress: function (e) {
                const $wrapper = $(e.target);
                $wrapper.find('.ms-dropdow.open').removeClass('open');
            },
            onCloseMenuItemIpAddressWrp: function (e) {
               // const $body = $(e.target);
               // $body.find('.ms-dropdow.open').removeClass('open');
            },
            enableLnkNameEditting: function (e) {
                var item = e.data;
                if (item.IsEdit != true)
                    return;

                //var model = this;
                item.InputEditting = '';
                item.set('InputEditting', item.LinkName);
                var $target = $(e.target);
                var $input = $target.next();
                
                bindEvents();
                
                showInputAndDestroyTooltip();
                
                function bindEvents() {                    
                   
                    //$input.height($target.height() + 10);
                    
                    $input.on("mouseleave", function switchToSpan() {
                        var newText = $input.val();
                        newText = newText.trim();

                        if (newText != '' && newText != item.LinkName) {

                            item.set('LinkName', newText);

                            var entry = {
                                Id: item.Id, Name: item.LinkName,
                                IsActive: item.IsActive,
                                TypeId: item.TypeId
                            };

                            editService().update(entry, function (data) {

                                $input.off('keydown');
                                $input.off('mouseleave');
                            });
                        }
                        item.set('InputEditting', undefined);
                        $target.show();
                        $input.hide();
                            
                    });

                    $input.on('keydown', function (e) {
                        if (e.keyCode == 13 || e.keyCode == 27) {
                            $input.mouseleave();
                        }
                    });

                }

                function showInputAndDestroyTooltip() {
                    var $parent = $target.parent();

                    $target.hide();
                    $input.show();
                    var tooltip = $parent.data('kendoTooltip');
                    !!tooltip && tooltip.hide();
                    $input.focus();
                    $input.select();
                }
            },
            pushFirstIpAddress(e) {             // e (link item)
                const linkItem = e.data;
                const _modelLinkItem = this.getLinkModelItem(linkItem);
                if (typeof _modelLinkItem == 'object') {
                    const lstIpAddress = _modelLinkItem.get('LstIpAddress');
                    const id = Date.now() + '_dnb-ip';
                    lstIpAddress.push({
                        Id: id, Name: '', LinkSharepointId: _modelLinkItem.Id, MIndex: 0
                    });
                    let _dataLinks = vmCommon.deepCopy(this.dataLinks);
                    this.set('dataLinks', _dataLinks);
                    this.validateAllIpAddr();
                    $(`#${id}`).focus();
                }
            },
            onMenuAddIpAddress: function (e) {
                if (vmCommon.IsSendingToServer) return;
                const thisRef = this;
                const data = e.data;
                const _modelLinkItem = data.parent().parent();
                if (typeof _modelLinkItem == 'object') {
                    const isIpFormat = vmCommon.isIpFormat(data.Name);
                    if (isIpFormat && typeof data.Id == 'string' && data.Name.trim() != '') {
                        thisRef.setIpCached(data);
                        thisRef.sendIpCached2Server().then((res) => {
                            if (res == undefined) return;
                            var id = res.value;
                            id = !!id ? id.TheObject : undefined;
                            id = !!id ? id.Id : data.Id;
                            data.Id = id;
                            setData();
                        });
                    } else {
                        setData();
                    }
                }

                function setData() {
                    const lstIpAddress = _modelLinkItem.LstIpAddress;
                    const index = lstIpAddress.indexOf(data);
                    const id = Date.now() + '_dnb-ip';
                    const mindex0 = data.MIndex;
                    const nextItem = index + 1 < lstIpAddress.length ? lstIpAddress[index + 1] : undefined;
                    const mindex2 = nextItem != undefined ? nextItem.MIndex : mindex0 + 2000;
                    const mindex1 = Math.floor((mindex2 + mindex0) / 2);

                    lstIpAddress.splice(index + 1, 0, {
                        Id: id, Name: '', LinkSharepointId: _modelLinkItem.Id, MIndex: mindex1
                    });
                    let _lstIpAddr = vmCommon.deepCopy(lstIpAddress);
                    _modelLinkItem.set('LstIpAddress', _lstIpAddr);
                    thisRef.validateAllIpAddr(undefined, 'onMenuAddIpAddress');
                    $(`#${id}`).focus();
                }
            },
            ignoreSpaceKey: function (e) {
                if (vmCommon.IsSendingToServer) return;
                if (e.keyCode == 32) {      // space
                    e.preventDefault();
                    const $input = $(e.target);
                    var nameUI = $input.val();
                    nameUI = nameUI.trim();
                    nameUI = nameUI.replace(' ', '');
                    $input.val(nameUI);
                }
            },
            validateIpAddress: function (e) {       // keyup
                if (vmCommon.IsSendingToServer) return;
                
                this.validateAllIpAddr(e);
            },
            onFocusIpInput: function (e) {
                this.sendIpCached2Server();
            },
            IpAddressCached: undefined,
            setIpCached: function (item) {
                if (typeof item != 'object') return;
                item = vmCommon.deepCopy(item);
                this.set('IpAddressCached', item);
            },
            sendIpCached2Server: function () {
                const entry = vmCommon.deepCopy(this.IpAddressCached);
                if (entry == null) return new Promise(resv => { resv() });
              
                const strId = entry.Id;
                const thisRef = this;
                return new Promise(reslv => {
                    const params = `&projid=${projectId}&strid=${strategyId}`;
                    var status = 'Edit';
                    if (typeof this.IpAddressCached.Id == 'string') {
                        status = 'Insert';
                        entry.Id = 0;
                    }
                    if (vmCommon.isIpFormat(entry.Name)) {
                        if (status == 'Insert') {
                            vmCommon.sendingToServer(true);            // disable when pending
                            var url = `../Handlers/SettingHandler.ashx?funcName=insertlinksharepointip${params}`;
                            callAjax('categories-loading', url, JSON.stringify(entry), null, AjaxConst.PostRequest).then(res => {
                                
                                reslv(res, status == 'Insert');

                                vmCommon.sendingToServer(false);        // callback
                                thisRef.set('IpAddressCached', undefined);
                                var id = res.value;
                                id = !!id ? id.TheObject : undefined;
                                id = id ? id.Id : undefined;
                                thisRef.validateAllIpAddr(undefined, strId, id);        // isFromHandler
                            });
                        } else {
                            vmCommon.sendingToServer(true);            // disable when pending
                            var url = `../Handlers/SettingHandler.ashx?funcName=editlinksharepointip${params}`;
                            callAjax('categories-loading', url, JSON.stringify(entry), null, AjaxConst.PostRequest).then(res => {
                                
                                reslv(res, status == 'Insert');

                                vmCommon.sendingToServer(false);   // callback
                                thisRef.set('IpAddressCached', undefined);
                                thisRef.validateAllIpAddr();
                            });
                        }
                    }
                });
            },
            removeSpaces: function (txt) {
                if (typeof txt != 'string') return '';
                var _txt = txt;
                while (_txt.includes(' ')) {
                    _txt = _txt.replace(' ', '');
                }
                return _txt;
            },
            validateAllIpAddr: function (e, strAction, newId) {           // e (ip item)
                const tooltip = `<div class="dnb_alert-typing_ipaddress">
                        <span style="color: red;font-size: 20px;">*</span>
                        <div class="dnb_alert-typing_ipaddress-tooltip" style="position:relative">
                            <div class="tooltip fade top in"
                                style="display: inline-block;min-width: 113px;left: 4px;top: -49px;transform: translate(-50%, -1px);">
                               <div class="tooltip-arrow"></div><div class="tooltip-inner"
                                    style="white-space: pre;max-width: initial;">{0}</div></div>
                        </div>
                    </div>`;
                const thisRef = this;
                if (typeof e == 'undefined') {
                    const dataLnks = this.get('dataLinks');
                    var isFromHandler = typeof newId == 'number' && typeof strAction == 'string' && strAction.includes('_dnb-ip');
                    dataLnks.forEach(function (eL, __i) {
                        var lstIpAddr = eL.get('LstIpAddress');
                        if (strAction == 'onMenuDeleteIpAddress' || isFromHandler)
                            lstIpAddr = checkDuplicate(lstIpAddr);

                        if (isFromHandler) {
                            lstIpAddr.forEach(function (lIp) {
                                if (lIp.Id == strAction) lIp.Id = newId;
                            });
                            dataLnks[__i].set('LstIpAddress', lstIpAddr);
                        }

                        lstIpAddr.forEach(function (lIp) {
                            const name = lIp.Name.trim();
                            const isIpFormat = vmCommon.isIpFormat(name);
                            const $wrap = $(`.dnb_txtinput[id=${lIp.Id}]`).closest('.dnbTypeIpWrap');
                            if (isIpFormat && typeof lIp.msgIpIsExisted == 'string') {
                                $wrap.append(tooltip.format(kLg.msgIpIsExisted));
                            } else if (name == '') {
                                $wrap.append(tooltip.format(kLg.TxtRequiredIpAddress));
                            } else if (!isIpFormat) {
                                $wrap.append(tooltip.format(kLg.InvalidIpAddress));
                            } else {
                                if ($wrap.find('.dnb_alert-typing_ipaddress').length > 0) {
                                    $wrap.find('.dnb_alert-typing_ipaddress').remove();
                                }
                            }
                        });

                    });
                    return;
                }
                function checkDuplicate(lstIpAddr) {
                    lstIpAddr = vmCommon.deepCopy(lstIpAddr);
                    const lstIp = lstIpAddr.map(_ip => { return _ip.Name });
                    const lstDlp = [];
                    const lstFirst = [];
                    lstIp.forEach((_ipN, _i) => {
                        if (lstIp.indexOf(_ipN) != _i) {            // duplicate
                            lstDlp.push({ Name: _ipN, Index: _i });
                        } else {
                            lstFirst.push({ Name: _ipN, Index: _i });
                        }
                    });
                    lstFirst.forEach(_item => {
                        if (typeof lstIpAddr[_item.Index].msgIpIsExisted == 'string') {
                            lstIpAddr[_item.Index].msgIpIsExisted = undefined;
                            
                            if (!isFromHandler) {
                                thisRef.setIpCached(lstIpAddr[_item.Index]);
                                $(`#${lstIpAddr[_item.Index].Id}.dnb_txtinput`).focus();
                            }
                        }
                    });
                    lstDlp.forEach((_item) => {
                        lstIpAddr[_item.Index].msgIpIsExisted = kLg.msgIpIsExisted;
                    });
                    
                    return lstIpAddr;
                }
                function isDuplicate(lstIpAddr, data, nameUI) {
                    if (typeof nameUI == 'undefined' && typeof data == 'object') {
                        nameUI = data.Name
                    }
                    return lstIpAddr.filter(i => i.Id != data.Id && i.Name == nameUI && i.LinkSharepointId == data.LinkSharepointId).length;
                }

                // from: validateIpAddress: function (e)
                const $input = $(e.target);
                var nameUI = $input.val();
                const hasSpace = nameUI.includes(' ');
                nameUI = this.removeSpaces(nameUI);
                const isIpFormat = vmCommon.isIpFormat(nameUI);
                
                if (isIpFormat) {
                    if (hasSpace)    // set lai sau khi remove space, check hasSpace de khong bi chay ham changeIpAddress nhieu lan
                        $input.val(nameUI);

                    const $wrap = $input.closest('.dnbTypeIpWrap');
                    const data = e.data;
                    const lstIpAddr = data.parent();
                    const isDuplct = isDuplicate(lstIpAddr, data, nameUI);
                    if (isDuplct) {
                        if ($wrap.find('.dnb_alert-typing_ipaddress').length < 1) {
                            $wrap.append(tooltip.format(kLg.msgIpIsExisted));
                        } else {
                            $wrap.find('.tooltip-inner').text(kLg.msgIpIsExisted);
                        }
                        data.msgIpIsExisted = kLg.msgIpIsExisted;
                    } else if ($wrap.find('.dnb_alert-typing_ipaddress').length > 0) {
                        $wrap.find('.dnb_alert-typing_ipaddress').remove();
                        data.msgIpIsExisted = undefined;
                    }
                    if (isIpFormat && !isDuplct) {                          // handler enter key events (Insert || Edit)
                        data.msgIpIsExisted = undefined;
                        this.setIpCached(Object.assign(vmCommon.deepCopy(data), { Name: nameUI }));
                        if (e.key == "Enter" || e.key == "Control") this.changeIpAddress(e);      // press Enter key
                    }
                } else {
                    this.set('IpAddressCached', undefined);
                    const $wrap = $input.closest('.dnbTypeIpWrap');
                    if ($wrap.find('.dnb_alert-typing_ipaddress').length < 1) {
                        if (nameUI == '') {
                            $wrap.append(tooltip.format(kLg.TxtRequiredIpAddress));
                        } else {
                            $wrap.append(tooltip.format(kLg.InvalidIpAddress));
                        }
                    } else {
                        if (nameUI == '') {
                            $wrap.find('.dnb_alert-typing_ipaddress').find('.tooltip-inner').text(kLg.TxtRequiredIpAddress);
                        } else {
                            $wrap.find('.dnb_alert-typing_ipaddress').find('.tooltip-inner').text(kLg.InvalidIpAddress);
                        }
                    }
                }
            },
            getLinkModelItem(linkItem) {
                const dataLnks = this.dataLinks;
                const indexLnkItem = dataLnks.indexOf(linkItem);
                const modelLinkItem = dataLnks[indexLnkItem];
                //const lstIpAddress = typeof modelLinkItem == 'object' ? modelLinkItem.LstIpAddress : null;
                if (typeof modelLinkItem != 'object') {
                    return null;
                }
                return modelLinkItem;
            },
            mouseOutCheckChangeIp: function (e) {               // e (ip item)
                const $input = $(e.target);
                const nameUI = $input.val();
                const nameUI2 = this.removeSpaces(nameUI);
                const data = e.data;
                const nameData = data.Name;
                if (nameData != nameUI2) {                      // change
                    this.validateIpAddress(e);
                    const isIpForm = vmCommon.isIpFormat(nameUI2);
                    if (isIpForm == true) {
                        const lstIpAddr = data.parent();
                        const isDuplicate = lstIpAddr.filter(i => i.Id != data.Id && i.Name == nameUI2 && i.LinkSharepointId == data.LinkSharepointId).length;
                        if (!isDuplicate) {
                            data.Name = nameUI2;
                            const entry = vmCommon.deepCopy(data);
                            this.setIpCached(entry);

                            const linkItem = data.parent().parent();
                            const _modelLinkItem = this.getLinkModelItem(linkItem);
                            this.sendIpCached2Server().then((res, isInsert) => {
                                if (typeof res == 'undefined') return;
                                
                                if (isInsert || typeof data.Id == 'string') {
                                    var newIpObj = res.value.TheObject;
                                    data.Id = newIpObj.Id;
                                    if (typeof _modelLinkItem == 'object') {
                                        const _lstIpAddr = vmCommon.deepCopy(lstIpAddr);
                                        _modelLinkItem.set('LstIpAddress', _lstIpAddr);
                                        this.validateAllIpAddr();
                                    }
                                }
                            });
                        }
                    }
                }
            },
            changeIpAddress: function (e) {                 // e (ip item)
                if (vmCommon.IsSendingToServer) return;
                const data = e.data;
                const nameUI = $(e.target).val();       // nameUI has not space anymore
                const isIpFormat = vmCommon.isIpFormat(nameUI);
                
                const linkItem = data.parent().parent();
                const _modelLinkItem = this.getLinkModelItem(linkItem);
                if (typeof _modelLinkItem == 'object') {
                    if (isIpFormat) {
                        data.Name = nameUI;

                        this.sendIpCached2Server().then((res, isInsert) => {
                            if (typeof res == 'undefined') return;
                            if (isInsert || typeof data.Id == 'string') {
                                var newIpObj = res.value.TheObject;
                                data.Id = newIpObj.Id;

                                const _lstIpAddr = vmCommon.deepCopy(_modelLinkItem.LstIpAddress);
                                _modelLinkItem.set('LstIpAddress', _lstIpAddr);
                            }
                            this.validateAllIpAddr();
                        });
                    }
                }
            },
            onMenuDeleteIpAddress: function (e) {
                if (vmCommon.IsSendingToServer) return;
                const data = e.data;
                const parent = data.parent();
                const lstIpAddress = parent.parent().LstIpAddress;
                const index = lstIpAddress.indexOf(data);
                const thisRef = this;
                pConfirm(kLg.TxtDelIpAddress).then(function OK() {
                    vmCommon.IsSendingToServer = true;         // disable when pending
                    var url = `../Handlers/SettingHandler.ashx?funcName=deletelinksharepointip&projid=${projectId}&id=${data.Id}`;
                    callAjax('categories-loading', url, null, function (res) {
                        if (res.value > 0) {
                            lstIpAddress.splice(index, 1);
                            if (lstIpAddress.length < 1) {              // set lai model 
                                let _dataLinks = vmCommon.deepCopy(thisRef.dataLinks);
                                thisRef.set('dataLinks', _dataLinks);
                            } else {
                                thisRef.validateAllIpAddr(undefined, 'onMenuDeleteIpAddress');
                            }
                        } else {
                            pAlert(kLg.ItemDelete).then(function () { });
                        }
                        vmCommon.IsSendingToServer = false;   // callback
                    }, AjaxConst.PostRequest);
                });
            },
            showTooltipSp: function (e) {
                var $target1 = $(e.target);

                var item = e.data;

                if (item.InputEditting != undefined && item.InputEditting != '') return;

                var filters = JSON.parse(item.FilterSnapshot);
                var template = kendo.template($("#hvLinkSharepointTmp").html());
                
                $target1.kendoTooltip({
                    content: template({
                        Filters: filters,
                        StartDate: item.StartDate ? kendo.toString(item.StartDate.jsonToDate(), "d") : '',
                        EndDate: item.EndDate ? kendo.toString(item.EndDate.jsonToDate(), "d") : ''
                    }),
                    autoHide: true,
                    hide: function (e) {
                        var $target = e.sender.element;
                        var tooltip = $target.data('kendoTooltip');
                        !!tooltip && tooltip.destroy();
                        
                    },
                    show: function (e) {
                        var $kTooltipContent = e.sender.content;
                        $kTooltipContent.css({ 'max-width': 'initial'});
                    }
                });

                $target1.data("kendoTooltip").show();
            }
        }

        vmPopSetting.ModelRoadmap = kendo.observable(Object.assign({
            dataLinks: dataRoadmap
        }, modelOptions));

        vmPopSetting.ModelMix = kendo.observable(Object.assign({
            dataLinks: dataMix
        }, modelOptions));

        var $roadmap = $(`#tbl-sp-link-${roadmapType}-body`);
        kendo.bind($roadmap, vmPopSetting.ModelRoadmap);

        var $mix = $(`#tbl-sp-link-${mixType}-body`);
        kendo.bind($mix, vmPopSetting.ModelMix);

    }

    vmPopSetting.GetTemplateCategories = function (type) {
        var url = `../Handlers/SettingHandler.ashx?funcName=getallcategoriesbytype&parentType=${vmPopSetting.enumsParentType.Marketing}&type=${type}&projid=${projectId}`;
        callAjax('categories-loading', url, null, 'callBackReplaceByPromise', AjaxConst.GetRequest).then(function resolve(data) {
            if (type == vmPopSetting.enumsType.catColorPalette) {
                vmPopSetting.getAndBindColorPalette(data.value);
                return; // dung template rieng nen return thoat ham luon
            }
            var divId = "place-categories" + type;
            vmPopSetting.arrCategories[parseInt(type)] = data.value;

            if (vmPopSetting.arrCategories[parseInt(type)].length === 0) {
                var cate = {
                    Id: 0,
                    Type: parseInt(type)
                };
                vmPopSetting.arrCategories[parseInt(type)].push(cate);
            }
            if (type === vmPopSetting.enumsType.categoryAdvertisingMaterials) {
                bindTemplate(divId, "template-parent-categories", vmPopSetting.arrCategories[parseInt(type)]);
                if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) {
                    vmPopSetting.bindCategorySortable(divId, type);
                }
            }
            else if (type === vmPopSetting.enumsType.categoryProduct
                || type === vmPopSetting.enumsType.categorySubmarket
                || type === vmPopSetting.enumsType.categoryCustomerJourney) {
                bindTemplate(divId, "template-parent-submarketproduct", vmPopSetting.arrCategories[parseInt(type)]);
                if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) {
                    vmPopSetting.setupDragDropSmpSe(type, 1);
                }
            }
            else {
                bindTemplate(divId, "template-table-categories", vmPopSetting.arrCategories[parseInt(type)]);
                vmCommon.setupMenuIcon('#pop-setting span[data-toggle=dropdown]', '#setting-pop');
            }

            if (type == vmPopSetting.enumsType.SharepointLinkControl) {
                
                if (typeof vmPopSetting.ModelRoadmap == 'object') {
                    vmPopSetting.ModelRoadmap.sendIpCached2Server();
                }
                if (typeof vmPopSetting.ModelMix == 'object') {
                    vmPopSetting.ModelMix.sendIpCached2Server();
                }

                vmPopSetting.bindSharepointLinkController(type, vmPopSetting.arrCategories[parseInt(type)]);
            }

            if (type == vmPopSetting.enumsType.catColorPalette && $('#dnb_kendoColorpicker_newlibrary_2021_3_1207').length > 0) {
                (typeof reLoadOldLibrary == 'function') && (reLoadOldLibrary())
            }

            vmPopSetting.SetupValidate(type);

            vmPopSetting.setUpMouseClick();
            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) {
                vmPopSetting.SetUpDragDrop();
            }
        }, function reject(data) {
            // cause of reject promise
        }).catch(function () {
            // cause of promise
        });
    };

    vmPopSetting.GetChildCategories = function (id) {

        $("div[type=content-table-child-categories" + vmPopSetting.enumsType.categoryAdvertisingMaterials + "]").html("");
        $('.childcategories').not(this).find("span.arrow-panel-online").removeClass("arrow-right-big").addClass("arrow-collapse");
        var childType = "childType" + vmPopSetting.enumsType.categoryAdvertisingMaterials;
        var divChildType = $("div[id^='" + childType + "'][id!='" + childType + id + "']");
        divChildType.height(0);
        divChildType.removeClass("in");
        vmPopSetting.ParentId = id;
        $("input[name='CategoryName']").tooltip('destroy');
        var divId = "child-place-Type" + id;

        var entryData = { Id: id };
        vmPopSetting.dataservice.getbyparentid(entryData, function (res) {
            var data = res.value;
            if (data.length === 0) {
                var cate = {
                    Id: 0,
                    Type: vmPopSetting.enumsType.categoryAdvertiser
                };
                data.push(cate);
            }
            vmPopSetting.arrCategories[vmPopSetting.enumsType.categoryAdvertiser] = data;

            bindTemplate(divId, "template-parent-categories", data);

            $("#pop-setting #lblAdvertiser" + id).text(kLg.lblNameAdvertiser);

            vmPopSetting.setUpMouseClick();
            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)
                vmPopSetting.bindCategorySortable(divId, vmPopSetting.enumsType.categoryAdvertiser);
            if (vmPopSetting.IsOwner) {
                bindSwitchSpanToInputCatLib(vmPopSetting.updateNameSub, "ProductClickEdit");
            }

        });
    };

    vmPopSetting.GetCategoriesByParent = function (parentId, parentType) {
        if (parentId == undefined || isNaN(Number(parentId))) return;

        var divId = "place-categories" + parentId;
        var url = "../Handlers/SettingHandler.ashx?funcName=getbyparentid" + "&projid=" + projectId;
        var obj = { id: parentId };
        callAjax(divId, url, JSON.stringify(obj), function (res) {
            var data = res.value;
            var childType = parentType === 10 ? 11 : 0;

            if (data.length === 0) {
                var cate = {
                    Id: 0,
                    Type: childType
                };
                data.push(cate);
            }

            bindTemplate(divId, "template-table-categories", data);

            //vmPopSetting.SetupValidate(parentId);
            vmPopSetting.setUpMouseClick();
            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)
                vmPopSetting.SetUpDragDrop();

        }, AjaxConst.PostRequest);
    };

    vmPopSetting.enumsParentType = {
        Marketing: 1
    };

    function Categories() {
        this.Id = 0;
        this.Name = "";
        this.Description = "";
        this.ProjectId = 0;
        this.Mdf = 0;
        this.Type = null;
        this.NonArchive = false;
        this.ParentType = 0;
        this.ParentId = null;
        this.Extension = null;
        this.Extension2 = null;
        this.MIndex = 0;

        return this;
    };

    var popUpCategories = undefined;
    vmPopSetting.OpenPopUpAddCategory = function (type, j, elm) {
        
        vmPopSetting.tmpParentType = parseInt(vmPopSetting.enumsParentType.Marketing);
        if (type === vmPopSetting.enumsType.categoryAdvertiser) {
            vmPopSetting.tmpParentId = vmPopSetting.ParentId;
        }
        vmPopSetting.tmpType = parseInt(type);
        vmPopSetting.category = vmPopSetting.findCategoryByType(type);

        vmPopSetting.tmpTitle = vmPopSetting.category.Title;

        vmPopSetting.categoriesOptions = {};
        if (j == undefined) {
            vmPopSetting.categoriesOptions.isEdit = false;
            vmPopSetting.categoriesOptions.category = new Categories();
            vmPopSetting.categoriesOptions.category.Type = parseInt(type);
            vmPopSetting.categoriesOptions.category.ParentType = vmPopSetting.tmpParentType;

            vmPopSetting.tmpId = 0;
            vmPopSetting.tmpName = "";
            vmPopSetting.tmpDes = "";
            vmPopSetting.tmpMdf = 0;
            vmPopSetting.tmpExtension = "";
            //vmPopSetting.tmpExtension3 = "";
            vmPopSetting.colorExtension = "";
            vmPopSetting.tmpTitle = kLg.addnewCategory;
        } else {
            var cat = vmPopSetting.arrCategories[parseInt(type)][j];

            vmPopSetting.categoriesOptions.isEdit = true;
            vmPopSetting.categoriesOptions.category = vmCommon.deepCopy(cat);

            vmPopSetting.tmpId = cat.Id;
            vmPopSetting.tmpName = cat.Name;
            vmPopSetting.tmpDes = cat.Description;
            vmPopSetting.tmpMdf = cat.Mdf;
            vmPopSetting.tmpExtension = cat.Extension;
            //vmPopSetting.tmpExtension3 = cat.Extension3;
            vmPopSetting.colorExtension = cat.Extension2;
        }
        if (type == vmPopSetting.enumsType.categoryKpiTime) {
            vmPopSetting.openPopupKpiTime();
        }
        else
            if (type == vmPopSetting.enumsType.categoryInstrument) {
                vmPopSetting.dataservice.getActionCustomView({ CategoriesId: vmPopSetting.categoriesOptions.category.Id }, function (res) {
                    vmPopSetting.categoriesOptions.viewData = res;
                    vmPopSetting.openPopupInstrument();
                });
            } else {
                popUpCategories = showPopup(popUpCategories,
                    $('#pop-add-categories-place'),
                    vmCommon.rootUrl + 'Contents/popAddCategories.html',
                    {
                        title: vmPopSetting.tmpTitle,
                        height: 295,
                        width: 500,
                        resizable: false
                    });
                if (type == 3) {        // Evaluation by objectives
                    const $elm = $(elm);
                    const $inputChecked = $elm.closest('.dnb-cat_wrap3').find('input[type="checkbox"]:checked');
                    if ($inputChecked.length > 0) {
                        popUpCategories.NonArchive = true;
                    }
                }
            }
    };

    vmPopSetting.popupCategory = undefined;
    vmPopSetting.openPopupKpiTime = function () {
        vmPopSetting.popupCategory = showPopup(vmPopSetting.popupCategory,
            $("#pop-add-categories-place"),
            vmCommon.rootUrl + "Contents/msPopEditKpiTime.html",
            {
                title: kLg.lblKpiTimePeriod,
                height: 360,
                width: 500,
                resizable: false
            });
    };

    vmPopSetting.popupInstrument = undefined;
    vmPopSetting.openPopupInstrument = function () {
        vmPopSetting.popupInstrument = showPopup(vmPopSetting.popupInstrument,
            $("#pop-add-categories-place"),
            vmCommon.rootUrl + "Contents/popActionCustomView.html",
            {
                title: vmPopSetting.tmpTitle,
                height: 360,
                width: 500,
                resizable: false
            });
    };

    var popUpKpiUnit = undefined;
    vmPopSetting.OpenPopUpAddKpiUnit = function (j) {
        if (j == null) {
            vmPopSetting.KpiUnit = {
                Id: 0, TypeId: vmPopSetting.enumTypeKPI.Number,
                PositionId: vmPopSetting.enumKpiPosition.Right,
                OrderId: vmPopSetting.enumKpiOrder.Behind,
                ProjectId: projectId
            };
        } else {
            vmPopSetting.KpiUnit = vmPopSetting.KpiUnits[j];
        }
        popUpKpiUnit = showPopup(popUpKpiUnit,
            $('#pop-add-categories-place'),
            vmCommon.rootUrl + 'Contents/MsPopAddKpiUnit.html',
            {
                title: kLg.lblKpiUnit,
                height: 650,
                width: 700,
                resizable: false
            });
    };

    vmPopSetting.findCategoryByType = function (type) {
        if (type < vmPopSetting.enumsType.categoryKpiIndex) {
            if (type === vmPopSetting.enumsType.categoryAdvertiser) {
                return {
                    Type: vmPopSetting.enumsType.categoryAdvertiser,
                    Title: kLg.lblTitleAdvertiser,
                    Name: kLg.lblNameAdvertiser,
                    Required: kLg.msgErrorRequiredAdvertiser,
                    MaxLength: kLg.msgErrorMaxLenghtAdvertiser
                };
            }
            for (var i = 0; i < vmPopSetting.arrayLabel.length; i++) {
                if (vmPopSetting.arrayLabel[i].Type == type) {
                    return vmPopSetting.arrayLabel[i];
                }
            }
        } else {



            for (var j = 0; j < vmPopSetting.arraySettingKpi.length; j++) {
                if (vmPopSetting.arraySettingKpi[j].Type === type) {
                    return vmPopSetting.arraySettingKpi[j];
                }
            }

        }

    };

    vmPopSetting.dataservice = function () {

        var callAjaxSetting = function (divId, funcName, entryData, requestType, successCallBack) {
            var url = "../Handlers/SettingHandler.ashx?funcName=" + funcName + "&projid=" + projectId + "&strid=" + strategyId;
            return callAjax(divId, url, entryData, successCallBack, requestType);
        };

        var callAjaxByPost = function (funcName, entryData, successFunc, loadingdiv) {
            return callAjaxSetting(loadingdiv || "categories-loading", funcName, JSON.stringify(entryData), AjaxConst.PostRequest, successFunc);
        };


        var getAllKpiFormatType = function (entryData, successFunc) {
            return callAjaxByPost("getallkpiformattype", entryData, successFunc);
        }
        var getAllKpiUnit = function (entryData, successFunc) {
            return callAjaxByPost("getallkpiunit", entryData, successFunc);
        }
        var getallKpiTopicIndex = function (entryData, successFunc) {
            return callAjaxByPost("getallkpitopicindex", entryData, successFunc);
        }
        var updateKpiIndex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiindex", entryData, successFunc);
        }

        var deleteKpiIndex = function (entryData, successFunc) {
            return callAjaxByPost("deletekpiindex", entryData, successFunc);
        }
        var deleteKpiTopic = function (entryData, successFunc) {
            return callAjaxByPost("deletekpitopic", entryData, successFunc);
        }
        var getbyparentid = function (entryData, successFunc) {
            return callAjaxByPost("getbyparentid", entryData, successFunc);
        }

        var updateKpiTopic = function (entryData, successFunc) {
            return callAjaxByPost("updatekpitopic", entryData, successFunc);
        }
        var updateKpiUnitMindex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiunitmindex", entryData, successFunc);
        }
        var updateKpiTopicMIndex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpitopicmindex", entryData, successFunc);
        }
        var updateKpiIndexMIndex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiindexmindex", entryData, successFunc);
        }

        var getAllSettingIndex = function (entryData, successFunc) {
            return callAjaxByPost("getallsettingindex", entryData, successFunc);
        }

        var updateKpiFormat = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiformat", entryData, successFunc);
        }

        var updateKpiSettingIndex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpisettingindex", entryData, successFunc);
        }
        var getSelectIndex = function (entryData, successFunc) {
            return callAjaxByPost("getselectindex", entryData, successFunc);
        }
        var deleteSettingIndex = function (entryData, successFunc) {
            return callAjaxByPost("deletesettingindex", entryData, successFunc);
        }
        var deleteKpiFormat = function (entryData, successFunc) {
            return callAjaxByPost("deletekpiformat", entryData, successFunc);
        }
        var updateKpiFormatItem = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiformatitem", entryData, successFunc);
        }
        var deleteFormatItem = function (entryData, successFunc) {
            return callAjaxByPost("deleteformatitem", entryData, successFunc);
        }
        var updateKpiFormatMIndex = function (entryData, successFunc) {
            return callAjaxByPost("updatekpiformatmindex", entryData, successFunc);
        }

        var changeCrmLink = function (entryData, successFunc) {
            return callAjaxByPost("changecrmlink", entryData, successFunc);
        };

        var getOrganisationPerson = function (entryData, successFunc) {
            return callAjaxByPost("getorganisationperson", entryData, successFunc);
        };

        var deleteFormatItemValue = function (entryData, successFunc) {
            return callAjaxByPost("deleteformatitemvalue", entryData, successFunc);
        };
        //insertformatfile
        var insertFormatFile = function (entryData, successFunc) {
            return callAjaxByPost("insertformatfile", entryData, successFunc);
        };

        var getActionCustomView = function (entryData, successFunc) {
            return callAjaxByPost("getactioncustomview", entryData, successFunc);
        };

        var saveInstrument = function (entryData, successFunc) {
            return callAjaxByPost("saveinstrument", entryData, successFunc);
        };

        var getSourceForDefaultView = function (entryData, successFunc) {
            return callAjaxByPost("getsourcefordefaultview", entryData, successFunc);
        };

        var saveKpiTime = function (entryData, successFunc) {
            return callAjaxByPost("savekpitime", entryData, successFunc);
        };
        var saveLanguage = function (entryData, successFunc) {
            return callAjaxByPost("savecatlanguage", entryData, successFunc);
        };

        return {
            getAllKpiFormatType: getAllKpiFormatType,
            getAllKpiUnit: getAllKpiUnit,
            getallKpiTopicIndex: getallKpiTopicIndex,
            updateKpiIndex: updateKpiIndex,
            deleteKpiIndex: deleteKpiIndex,
            deleteKpiTopic: deleteKpiTopic,
            getbyparentid: getbyparentid,
            updateKpiTopic: updateKpiTopic,
            updateKpiUnitMindex: updateKpiUnitMindex,
            updateKpiTopicMIndex: updateKpiTopicMIndex,
            updateKpiIndexMIndex: updateKpiIndexMIndex,
            getAllSettingIndex: getAllSettingIndex,
            updateKpiFormat: updateKpiFormat,
            getSelectIndex: getSelectIndex,
            updateKpiSettingIndex: updateKpiSettingIndex,
            deleteSettingIndex: deleteSettingIndex,
            deleteKpiFormat: deleteKpiFormat,
            updateKpiFormatItem: updateKpiFormatItem,
            deleteFormatItem: deleteFormatItem,
            updateKpiFormatMIndex: updateKpiFormatMIndex,
            changeCrmLink: changeCrmLink,
            getOrganisationPerson: getOrganisationPerson,
            deleteFormatItemValue: deleteFormatItemValue,
            insertFormatFile: insertFormatFile,
            getActionCustomView: getActionCustomView,
            saveInstrument: saveInstrument,
            getSourceForDefaultView: getSourceForDefaultView,
            saveKpiTime: saveKpiTime,
            saveLanguage: saveLanguage
        };
    }();

    vmPopSetting.enumTypeFormat = {
        Format: 1,
        Cost: 2,
        Description: 3,
        CrmLink: 4,
        Document: 5
    };
    vmPopSetting.openFormatId = 0;

    vmPopSetting.isReloadData = true;
    vmPopSetting.DeleteCategories = function (type, j) {
        var category = vmPopSetting.arrCategories[parseInt(type)][j];
        var obj = { id: category.Id, mdf: category.Mdf };
        var url = '../Handlers/SettingHandler.ashx?funcName=deletecategories&projid=' + projectId;
        pConfirm(kLg.confirmDeleteCategories).then(function () {
            callAjax('categories-loading', url, JSON.stringify(obj), function (data) {
                var state = data;
                vmPopSetting.UpdateCallBack(state, category.Type);
            }, AjaxConst.PostRequest);
        });
    };

    vmPopSetting.UpdateCallBack = function (state, type) {
        switch (state) {
            case vmPopSetting.enumsRoleConflict.conflict:
                pAlert(kLg.msgConflickData).then(function () {
                    vmPopSetting.ChooseCategories(type);
                });
                break;
            case vmPopSetting.enumsRoleConflict.using:
                pAlert(kLg.msgCategoryAreUsing).then(function () {
                    vmPopSetting.ChooseCategories(type);
                });
                break;
            case vmPopSetting.enumsRoleConflict.nameExist:
                pAlert(kLg.msgNameIsExisted).then(function () {
                    vmPopSetting.ChooseCategories(type);
                });
                break;
            default:
                if (vmPopSetting.isReloadData)
                    vmPopSetting.ChooseCategories(type);
                break;
        }

        vmPopSetting.isReloadData = true;
    };

    vmPopSetting.DataKpiTopics = null;
    vmPopSetting.GetSubCategories = function (type) {
        $("div[type=content-table-kpi]").html("");
        $("input[name='CategoryName']").tooltip('destroy');
        vmPopSetting.KpiType = type;
        vmCommon.bindChangeIcon();
        switch (type) {
            case vmPopSetting.enumsType.categoryKpiTime:
                vmPopSetting.GetTemplateKpi(type);
                break;

            case vmPopSetting.enumsType.categoryKpiFormat:
                vmPopSetting.dataservice.getAllKpiFormatType(null, function (res) {
                    var divId = "place-kpi" + type;
                    bindTemplate(divId, "template-table-kpiunit", vmPopSetting.FormatTrendData(res.value));
                });
                break;
            case vmPopSetting.enumsType.categoryKpiUnit:
                vmPopSetting.dataservice.getAllKpiUnit(null, function (res) {
                    var divId = "place-kpi" + type;
                    vmPopSetting.KpiUnits = vmPopSetting.FormatUnitData(res.value);
                    bindTemplate(divId, "template-table-kpiunit", vmPopSetting.KpiUnits);
                    vmPopSetting.setUpMouseClick();
                    if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)
                        vmPopSetting.SetUpDragDrop();
                });
                break;
            case vmPopSetting.enumsType.categoryKpiSettingIndex:
                vmPopSetting.dataservice.getallKpiTopicIndex(null, function (res) {
                    vmPopSetting.DataKpiTopics = res.value;
                    vmPopSetting.binddlKpiUnit();
                    $('#msgTopicIndexUnsave').hide();
                });


                break;
            default:
                vmPopSetting.GetTemplateKpi(type);
                break;
        }



    };

    vmPopSetting.binddlKpiUnit = function () {
        var divId = "place-kpi" + vmPopSetting.enumsType.categoryKpiSettingIndex;

        bindTemplate(divId, "template-kpitopicindex", vmPopSetting.DataKpiTopics);
        $(".cssKpiUnit").each(function () {
            $(this).kendoDropDownList({
                dataTextField: "Name",
                dataValueField: "Id",
                dataSource: vmPopSetting.DataKpiTopics.KpiUnits,
                change: vmPopSetting.onChangeUnit,
                enable: vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting
            });
        });

        $(".cssKpiTime").each(function () {
            $(this).kendoDropDownList({
                dataTextField: "Name",
                dataValueField: "Id",
                dataSource: vmPopSetting.DataKpiTopics.KpiTimes,
                change: vmPopSetting.onChangeTime,
                enable: vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting
            });
        });

        vmPopSetting.setLangagueKpi();
        if (vmPopSetting.IsOwner)
            bindSwitchSpanToInputLib(vmPopSetting.setNameKpiTopic, "TopicClickEdit", vmPopSetting.removeKpiTopicHover, vmPopSetting.setVisibilityButton);

        //vmPopSetting.bindTopicSortable(); vmPopSetting.bindKpiIndexSortable();
        if (vmPopSetting.Role < 2 && vmPopSetting.IsEditSetting == false) {
            $('#place-kpi' + vmPopSetting.enumsType.categoryKpiSettingIndex + ' input.txtInput').prop("disabled", true);
        }
    };

    vmPopSetting.setLangagueKpi = function () {
        $("#pop-setting #lblKpiName").text(kLg.menuKpiIndex);
        $("#pop-setting #lblKpiUnitName").text(kLg.lblKpiUnit);
        $("#pop-setting #lblKpiTime").text(kLg.lblKpiTimePeriod);
    }

    vmPopSetting.SetLangSettingIndex = function () {
        $("#pop-kpisettingindex #lblKpiName").text(kLg.menuKpiIndex);
        $("#pop-kpisettingindex #lblKpiUnitName").text(kLg.lblKpiUnit);
        $("#pop-kpisettingindex #lblKpiTime").text(kLg.lblKpiTimePeriod);
        $("#pop-kpisettingindex #lblKpiSollName").text(kLg.lblSoll);
    };

    vmPopSetting.setNameKpiTopic = function (id, value) {
        var entryData = { Id: id, Name: value }
        vmPopSetting.dataservice.updateKpiTopic(entryData, function (res) {
            var validvalue = res.value === vmPopSetting.enumsRoleConflict.nameExist;
            vmPopSetting.setTopicInvalid(id, validvalue, value);
            vmPopSetting.checkInvalid();
        });
    }
    
    vmPopSetting.removeKpiTopicHover = function () { }
    vmPopSetting.setVisibilityButton = function () { }
    vmPopSetting.AddCategory = function (type) {
        $("input[name='CategoryName']").tooltip('destroy');
        var validator = $("#categories-form" + type).validate();
        if (!validator.element("#txtName" + type)) return;

        var name = $("#txtName" + type).val().trim();

        var obj = {
            Name: name,
            Type: type,
            ParentType: vmPopSetting.enumsParentType.Marketing
        };
        if (type == 3) {
            obj.NonArchive = false;
        }

        var url = "../Handlers/SettingHandler.ashx?funcName=addcategories&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(obj), function (data) {
            $("#txtName" + type).tooltip('destroy');
            var state = data.ResultStatus;
            switch (state) {
                case vmPopSetting.enumsRoleConflict.using:
                    pAlert(kLg.msgCategoryAreUsing).then(function () {
                        vmPopSetting.ChooseCategories(type);
                    });
                    break;
                case vmPopSetting.enumsRoleConflict.nameExist:
                    $("#txtName" + type).attr('title', kLg.msgNameIsExisted);
                    $("#txtName" + type).tooltip('show');
                    break;
                default:
                    $("#txtName" + type).val("");
                    if (type == vmPopSetting.enumsType.categoryProduct || type == vmPopSetting.enumsType.categorySubmarket
                        || type == vmPopSetting.enumsType.categoryCustomerJourney) {
                        vmPopSetting.GetCategories(type);
                    }
                    else {
                        vmPopSetting.ChooseCategories(type);
                    }

                    break;
            }

        }, AjaxConst.PostRequest);
    };

    vmPopSetting.AddChildCategory = function (parentId) {
        var validator = $("#categories-form" + vmPopSetting.enumsType.categoryAdvertisingMaterials).validate();
        if (!validator.element("#txtName" + parentId)) return;

        var type = vmPopSetting.enumsType.categoryAdvertiser;

        var name = $("#txtName" + parentId).val().trim();
        var obj = {
            Name: name,
            Type: type,
            ParentId: parentId,
            ParentType: vmPopSetting.enumsParentType.Marketing,
            Extension: 1
        };

        var url = "../Handlers/SettingHandler.ashx?funcName=addcategories&projid=" + projectId;
        callAjax('categories-loading',
            url,
            JSON.stringify(obj),
            function (data) {
                $("#txtName" + parentId).tooltip('destroy');
                var state = data;
                switch (state.ResultStatus) {
                    case vmPopSetting.enumsRoleConflict.using:
                        pAlert(kLg.msgCategoryAreUsing).then(function () {
                            vmPopSetting.ChooseCategories(type);
                        });
                        break;
                    case vmPopSetting.enumsRoleConflict.nameExist:
                        $("#txtName" + parentId).attr('title', kLg.msgNameIsExisted);
                        $("#txtName" + parentId).tooltip('show');
                        break;
                    default:
                        $("#txtName" + parentId).val("");
                        vmPopSetting.ChooseCategories(type);
                        break;
                }

            },
            AjaxConst.PostRequest);
    };

    vmPopSetting.ChooseCategories = function (type) {
        if (type < vmPopSetting.enumsType.categoryKpiUnit) {
            if (type === vmPopSetting.enumsType.categoryAdvertiser) {
                vmPopSetting.GetChildCategories(vmPopSetting.ParentId);
            } else {
                vmPopSetting.GetCategories(type);
            }
        } else {
            vmPopSetting.GetSubCategories(type);
        }
    };

    vmPopSetting.openAdvertises = function (id, type) {
        if (type === vmPopSetting.enumsType.categoryAdvertisingMaterials) {
            vmPopSetting.GetChildCategories(id);
        } else {
            vmPopSetting.openAdvertiser(id);
        }
    }

    vmPopSetting.openAdvertiser = function (id) {
        $("div[type=content-table-child-categories" + vmPopSetting.enumsType.categoryAdvertiser + "]").html("");
        $('.advertiser').not(this).find("span.arrow-panel-online").removeClass("arrow-right-big").addClass("arrow-collapse");

        var childType = "childType" + vmPopSetting.enumsType.categoryAdvertiser;
        var divChildType = $("div[id^='" + childType + "'][id!='" + childType + id + "']");

        divChildType.height(0);
        divChildType.removeClass("in");

        $("input[name='CategoryName']").tooltip('destroy');

        var divId = "#child-place-Type" + id;
        $(divId).html($("#template-kpisettingindex").html());
        vmPopSetting.getAndBindIndexFormat(id);
    }

    vmPopSetting.loadPlanningList = function (type) {
        var divId = "place-categories" + type;
        if (vmPopSetting.IsOwner) {
            vmPopSetting.PlanningList.forEach(item => {
                item.IsOwner = true;
            });
        }
        bindTemplate(divId, "planning-table-template", vmPopSetting.PlanningList);
        if (vmPopSetting.PlanningList[0].IsOverdue === null) {
            vmPopSetting.PlanningList[0].IsOverdue = true;
        }
        $('#cbIsOverdue').prop("checked", vmPopSetting.PlanningList[0].IsOverdue);
        vmPopSetting.bindProSetting();
        vmPopSetting.SetComboBox();
        vmPopSetting.loadMasterSetting();
    };

    vmPopSetting.bindProSetting = function () {
        vmPopSetting.ProjectInfo.IsEditSetting = vmPopSetting.ProjectInfo.IsOwner || vmPopSetting.IsEditSetting;
        
        var proModel = kendo.observable({
            pro: vmPopSetting.ProjectInfo,
            changeMarketLabel: function () {
                var state = this.pro.IsShowMarketLabel;
                var url = "../Handlers/SettingHandler.ashx?funcName=changemarketlabel&projid=" + projectId + "&strid=" + strategyId + "&lang=" + language;
                callAjax("", url, JSON.stringify({ status: state }), function (res) {
                    vmSetting.ProjectInfo.IsShowMarketLabel = state;
                    if (vmCommon.checkCurrentPage(vmCommon.enumPage.ActionPlan)) {
                        vmPopSetting.toggleMarketLabel(state);      // có thể bỏ đi, vì dùng vuejs 
                        (MsaApp) && (MsaApp.SetCheckboxFromSettings(state));
                    }
                }, AjaxConst.PostRequest);
            },
            changehiddengoal: function () {
                var state = this.pro.IsHiddenGoalContent;
                var url = "../Handlers/SettingHandler.ashx?funcName=changehiddengoal&projid=" + projectId + "&strid=" + strategyId + "&lang=" + language;
                callAjax("", url, JSON.stringify({ Status: this.pro.IsHiddenGoalContent }), function (res) {
                    vmSetting.ProjectInfo.IsHiddenGoalContent = state;
                    (MsaApp) && (MsaApp.SetCheckboxFromSettings(null, state));
                }, AjaxConst.PostRequest);
            },
            changecheckactiondate: function () {
                var state = this.pro.IsCheckActionDate;
                var url = "../Handlers/SettingHandler.ashx?funcName=changecheckactiondate&projid=" + projectId + "&strid=" + strategyId + "&lang=" + language;
                callAjax("", url, JSON.stringify({ Status: state }), function (res) {
                    vmSetting.ProjectInfo.IsCheckActionDate = state;
                    (MsaApp) && (MsaApp.SetCheckboxFromSettings(null, null, state));
                }, AjaxConst.PostRequest);
            }
        });

        kendo.bind($("#prosetting"), proModel);
    };

    vmPopSetting.toggleMarketLabel = function (state) {
        if (state) {
            $("div.market-title").removeClass("hidden");
            $("div.market-content").addClass("market-show");
            $("div.market-content").addClass("hidden");

            $("a.market-link").each(function () {
                vmGoalAction.openMarket($(this).attr("msrid"), $(this));
            });
        } else {
            $("div.market-title").addClass("hidden");
            $("div.market-content").removeClass("market-show");
            $("div.market-content").removeClass("hidden");

            $("div.market-title").each(function () {
                $(this).data("isOpened", false);
                vmGoalAction.expandService.remove($(this).attr("id"), 3);
            });
        }
    };

    vmPopSetting.loadProjectLanguage = function (type) {
        var url = "../Handlers/SettingHandler.ashx?funcName=getprojectlanguage&projid=" + projectId + "&lang=" + language;
        callAjax('categories-loading', url, null, function (data) {
            vmCommon.loadcustomizeMarketLanguage(data.value);
            var dataLang = {
                Market: vmPopSetting.ConvertToListLanguage(vmPopSetting.arrayMarketLanguage), SubMarket: vmPopSetting.ConvertToListLanguage(vmPopSetting.arraySubMarketLanguage)
                , ActionPlan: vmPopSetting.ConvertToListLanguage(vmPopSetting.arrayActionPlan), Mix: vmPopSetting.ConvertToListLanguage(vmPopSetting.arrayMarketingMix),
                Teamboard: vmPopSetting.ConvertToListLanguage(vmPopSetting.arrayTeamboard), Roadmap: vmPopSetting.ConvertToListLanguage(vmPopSetting.arrayRoadmap)

            };
            var divId = "place-categories" + type;
            bindTemplate(divId, "project-language-template", dataLang);
        });
    };

    vmPopSetting.BindListYear = function (year) {
        var yearList = [];
        if (year == null) return yearList;
        var curYear = new Date().getFullYear();
        for (var i = curYear - 10; i < curYear + 10; i++) {
            yearList.push(i);
        }
        if (year == 0) {
            yearList.push(year);
        }
        return yearList;
    };

    vmPopSetting.SetComboBox = function () {
        for (var i = 0; i < vmPopSetting.PlanningList.length; i++) {

            if ($("#combobox-startyear" + i).length > 0) {
                var startYear = parseInt($("#combobox-startyear" + i).attr('customValue'));
                $("#combobox-startyear" + i).kendoDropDownList({
                    dataSource: vmPopSetting.BindListYear(startYear),
                    change: vmPopSetting.OnChange
                }).data('kendoDropDownList').value(startYear);
            }
            if ($("#combobox-endyear" + i).length > 0) {
                var endYear = parseInt($("#combobox-endyear" + i).attr('customValue'));
                $("#combobox-endyear" + i).kendoDropDownList({
                    dataSource: vmPopSetting.BindListYear(endYear),
                    change: vmPopSetting.OnChange
                }).data('kendoDropDownList').value(endYear);
            }
        }
    };

    vmPopSetting.OnChange = function (e) {
        var index = parseInt(this.element.closest('tr').attr('valueIndex'));
        var itemProject = vmPopSetting.PlanningList[index];
        var start = $('#combobox-startyear' + index).data('kendoDropDownList').value();
        var end = $('#combobox-endyear' + index).data('kendoDropDownList').value();

        if (start > end) {
            this.element.parent('span').attr('title', kLg.msgValidateStartEndDate);
            this.element.parent('span').tooltip('show');
            return;
        }
        itemProject.StartYear = start;
        itemProject.EndYear = end;
        var obj = { Id: itemProject.Id, StartYear: start, EndYear: end, Mdf: itemProject.Mdf };
        var url = "../Handlers/ProjectHandler.ashx?funcName=editprojectyear&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(obj), function (data) {
            switch (data.value) {
                case -1:
                    pAlert(kLg.msgNoEditPermission).then(function () {
                        vmPopSetting.GetCategories(vmPopSetting.enumsType.categoryPlanning);
                    });
                    break;
                case -2:
                    pAlert(kLg.msgConflictData).then(function () {
                        vmPopSetting.GetCategories(vmPopSetting.enumsType.categoryPlanning);
                    });
                    break;
                default:
                    itemProject.Mdf++;
                    break;
            }
        }, AjaxConst.PostRequest);
    };
    //check Currency Special Character
    //Task 5092
    jQuery.validator.addMethod("pattern", function (value, element) {
        return this.optional(element) || /^[^<>'"|]+$/.test(value);
    }, kLg.msgMaxlenghNameCurrencySpecialCharacter);

    vmPopSetting.SetupValidate = function (type) {
        var maxLength = 100;
        switch (type) {
            case vmPopSetting.enumsType.categoryCurrency:
                $('.csscurrencyrate').preventPressAlphabetChar([46, 44]);
                maxLength = 3;
                break;
            case vmPopSetting.enumsType.categoryStrategy:
                maxLength = 50;
                break;
        }

        $("#txtName" + type).attr('maxlength', maxLength);

        $('#categories-form' + type).validate({
            rules: {
                CategoryName: {
                    required: true,
                    maxlength: maxLength,
                    pattern: true

                }
            }
            ,
            messages: {
                CategoryName: {
                    required: kLg.msgRequired,
                    maxlength: kLg.nomorethanCharacters.replace('{0}', maxLength)

                }
            }
        });
    };

    var divDragDropQG;// TienPM disable drag-drop when click

    vmPopSetting.setUpMouseClick = function () {
        $('.icon-dropdow').click(function () {
            if ($('.ms-dropdow').hasClass('open')) {
                $('table.tbgrid td').removeClass('td-hovers');
                $('table.tbgrid td').addClass('td-hover');
                $('table.table-bordered td').removeClass('td-hovers');
                $('table.table-bordered td').addClass('td-hover');
            } else {
                $('table.tbgrid td').removeClass('td-hover');
                $('table.table-bordered td').removeClass('td-hover');
                $(this).parents('td').addClass('td-hovers');
                $(this).parents('.itemDraggable').draggable({ disabled: true });
                divDragDropQG = $(this).parents('.itemDraggable');
            }
            $(document).mouseup(function (e) {
                var container = $('.icon-dropdow');
                if (!container.is(e.target)) {
                    $('table.tbgrid td').removeClass('td-hovers');
                    $('table.tbgrid td').addClass('td-hover');
                    $('table.table-bordered td').removeClass('td-hovers');
                    $('table.table-bordered td').addClass('td-hover');
                    divDragDropQG.draggable({ disabled: false });
                };
            });
        });
    };

    vmPopSetting.SetUpDragDrop = function () {
        var sourceId, desId, tcell, type, /*hDrag, wDrag,*/ position, xDrag, yDrag;

        $('#pop-setting-place .itemDraggable').draggable({
            revert: true,
            cursor: 'defaul',
            cursorAt: { top: 0, left: 0 },
            handler: 'icon-arow-towway-vertical',
            axis: 'y',
            scroll: true,
            start: function (e, ui) {
                $(this).addClass('onDragging');
                var dragOff = $(this).offset();
                xDrag = dragOff.left;
                yDrag = dragOff.top;
                tcell = $(this).closest('td');
                sourceId = parseInt(tcell.attr('val'));
                type = parseInt($(this).attr('type'));
                //hDrag = tcell.height();
                //wDrag = tcell.width();
            },
            stop: function (e, ui) {
                $(this).removeClass('onDragging');
                if (desId == undefined) {
                    return;
                }
                if (type === vmPopSetting.enumsType.categoryKpiUnit) {
                    vmPopSetting.ChangePositionKpiUnit(desId, sourceId, type, position);
                } else {
                    vmPopSetting.ChangePositionCategories(desId, sourceId, type, position);
                }
            }
        });

        $('#pop-setting-place .divDroppable').droppable({
            hoverClass: 'ui-state-hover',
            accept: '.itemDraggable',
            tolerance: 'intersect',
            drop: function (event, ui) {

                desId = parseInt($(this).attr('val'));
                if (sourceId == desId) {
                    return;
                }
                position = vmCommon.getPositionByY(this, ui, yDrag);
                //if (type === vmPopSetting.enumsType.categoryKpiUnit) {
                //    vmPopSetting.ChangePositionKpiUnit(desId, sourceId, type, position);
                //} else {
                //    vmPopSetting.ChangePositionCategories(desId, sourceId, type, position);
                //}
            }
        });

    };

    vmPopSetting.findCategory = function (type, id) {
        return vmCommon.findByFunc(vmPopSetting.arrCategories[type], function (item) { return item.Id == id; });
    };

    vmPopSetting.ChangePositionCategories = function (desId, sourceId, type, position) {
        var source = vmPopSetting.findCategory(parseInt(type), sourceId);
        var des = vmPopSetting.findCategory(parseInt(type), desId);
        var moving = {
            SourceId: sourceId,
            DesId: desId,
            SourceMdf: source.Mdf,
            DesMdf: des.Mdf,
            ParentType: vmPopSetting.enumsParentType.Marketing,
            Type: type,
            Position: position,
            ParentSourceId: source.ParentId === null ? 0 : source.ParentId
        };
        var url = "../Handlers/SettingHandler.ashx?funcName=updatemindex&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(moving), function (data) {

            var state = data;
            switch (state) {
                case vmPopSetting.enumsRoleConflict.using:
                    pAlert(kLg.msgCategoryAreUsing).then(function () {
                        vmPopSetting.ChooseCategories(parseInt(type));
                    });
                    break;
                case vmPopSetting.enumsRoleConflict.nameExist:
                    pAlert(kLg.msgNameIsExisted).then(function () {
                        vmPopSetting.ChooseCategories(parseInt(type));
                    });
                    break;
                default:
                    vmPopSetting.ChooseCategories(parseInt(type));
                    break;
            }
        }, AjaxConst.PostRequest);
    };

    vmPopSetting.ChangePositionKpiTopic = function (desId, sourceId, type, position) {
        var moving = {
            SourceId: sourceId,
            DesId: desId,
            SourceMdf: 0,
            DesMdf: 0,
            ParentType: vmPopSetting.enumsParentType.Marketing,
            Type: type,
            Position: position
        };
        vmPopSetting.dataservice.updateKpiTopicMIndex(moving, function (res) {
            vmPopSetting.GetSubCategories(vmPopSetting.enumsType.categoryKpiSettingIndex);
        });
    };

    vmPopSetting.ChangePositionKpiUnit = function (desId, sourceId, type, position) {
        var moving = {
            SourceId: sourceId,
            DesId: desId,
            SourceMdf: 0,
            DesMdf: 0,
            ParentType: vmPopSetting.enumsParentType.Marketing,
            Type: type,
            Position: position
        };
        vmPopSetting.dataservice.updateKpiUnitMindex(moving, function (res) {
            vmPopSetting.GetSubCategories(vmPopSetting.enumsType.categoryKpiUnit);
        });
    };

    vmPopSetting.ChangePositionKpiIndex = function (desId, sourceId, desParentId, srcParentId, position) {
        var moving = {
            SourceId: sourceId,
            DesId: desId,
            SourceMdf: 0,
            DesMdf: 0,
            ParentSourceId: desParentId,
            ParentDesId: srcParentId,
            Position: position
        };

        vmPopSetting.dataservice.updateKpiIndexMIndex(moving, function (res) {
            vmPopSetting.GetSubCategories(type);
        });
    };

    vmPopSetting.CheckNoSpaces = function (e) {
        return e.trim().indexOf(" ") == -1;
    };

    vmPopSetting.BindOnchange = function () {

        $("#pop-setting .inputFibu").bind("keyup", function () {
            $(this).attr("data-original-title", "");
        });

        $("#pop-setting .categoryName").bind("keyup", function () {
            $(this).attr("data-original-title", "");
        });
        if (vmPopSetting.IsOwner) {
            vmPopSetting.SwitchSpanToInput(vmPopSetting.setNameCategories, "cssCategories");
        } else {
            $("#pop-setting").on("click", ".cssCategories", (e) => $("a[href=#categories" + $(e.target).attr("data-id") + "]").click());
        }
    };

    var listMasterRegions = [];
    var listSlaveRegions = [];
    var selectedMaster = null;
    var selectedSlave = [];
    var regionMaster = null;
    var fibuData = [];

    //Pageload
    $(document).ready(function () {
        $('#pop-setting-place').empty();
        if (vmPopSetting.projectId !== 0) {
            var url = "../Handlers/ProjectHandler.ashx?funcName=getbyid&projid=" + projectId + "&strid=" + strategyId + "&lang=" + language;
            callAjax('categories-loading', url, null, function (data) {;
                
                vmPopSetting.ProjectInfo = data.value;
                vmPopSetting.projectName = data.value.Name;
                vmPopSetting.PlanningList = [data.value];
                vmPopSetting.Role = data.value.Role || 0;
                vmPopSetting.IsOwner = data.value.IsOwner;
                vmPopSetting.IsEditSetting = data.value.IsEditSetting;
                vmPopSetting.IsOwner = vmPopSetting.IsOwner || vmPopSetting.IsEditSetting;

                //if (!vmPopSetting.IsOwner) {
                //    vmPopSetting.arrayLabel = vmPopSetting.arrayLabel.filter((e) => { return e.Type != vmPopSetting.enumsType.catColorPalette });
                //}

                vmCommon.loadcustomizeMarketCatLanguage(data.value.CatLang);

                vmPopSetting.updateArrayLabel();

                bindTemplate('pop-setting-place', 'template-setting', vmPopSetting.arrayLabel);
                vmPopSetting.BindOnchange();
            }, AjaxConst.PostRequest);
        } else {
            bindTemplate('pop-setting-place', 'template-setting', vmPopSetting.arrayLabel);
            vmPopSetting.BindOnchange();
        }
    });

    vmPopSetting.updateArrayLabel = function () {

        for (var i = 1; i < vmPopSetting.arrayLabel.length; i++) {
            var keyLang = vmPopSetting.enumLanguage[vmPopSetting.arrayLabel[i].Type];
            if (keyLang) {
                vmPopSetting.arrayLabel[i].Name = kLg[keyLang];
            }
        }
    }

    vmPopSetting.changeIsOverdue = function () {

        var url = "../Handlers/ProjectHandler.ashx?funcName=updateIsOverdue&projid=" + projectId;
        callAjax('categories-loading', url, null, function (data) {

        }, AjaxConst.PostRequest);
    }

    vmPopSetting.loadDataFibu = function () {
        var url = "/Handlers/SettingHandler.ashx?projId=" + projectId;
        var jsonObj = { funcName: "getFibu" };
        callAjax("categories-loading", url, jsonObj, loadFibuSuccessCallBack, AjaxConst.GetRequest);
    }

    function loadFibuSuccessCallBack(data) {
        fibuData = data.value;
        fibuData.regionland.unshift({ Id: -1, Name: kLg.selectLandRegion });
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
    }

    vmPopSetting.changeFibuTokenNr = function (e, id, index) {
        var textNr = e.value.trim();
        var entryData = { Id: id, Text: textNr, Type: 1 };
        var url = "../Handlers/SettingHandler.ashx?funcName=changefiburegion&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(entryData),
            function (data) { vmPopSetting.changeFibuRegionTextSuccess(index, textNr, 1) }
            , AjaxConst.PostRequest);
    };

    vmPopSetting.changeFibuTokenDes = function (e, id, index) {
        var textDes = e.value.trim();
        var entryData = { Id: id, Text: textDes, Type: 2 };
        var url = "../Handlers/SettingHandler.ashx?funcName=changefiburegion&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(entryData),
            function (data) { vmPopSetting.changeFibuRegionTextSuccess(index, textDes, 2) }
            , AjaxConst.PostRequest);
    };

    vmPopSetting.changeFibuRegionTextSuccess = function (index, text, type) {
        if (type === 1) {
            fibuData.fibu.RegionFibus[index].Nr = text;
        }
        if (type === 2) {
            fibuData.fibu.RegionFibus[index].Description = text;
        }
    };

    vmPopSetting.changeFibusNr = function (e, id, fibuRegionId, index) {
        vmPopSetting.DestroyToolTip($(e));
        vmPopSetting.DestroyToolTip($(e).nextAll('input').first());
        var textNr = e.value.trim();
        var textDes = $(e).nextAll('input').first().val().trim();
        var objectFibus = vmPopSetting.updateChangeFibus(fibuRegionId, index, textNr, textDes);
        if (textNr !== "" && textDes !== "") {
            var entryData = { Id: objectFibus.Id, Nr: textNr, Description: textDes, LandRegionId: fibuRegionId };
            var url = "../Handlers/SettingHandler.ashx?funcName=savefibus&projid=" + projectId;
            callAjax('categories-loading', url, JSON.stringify(entryData),
                function (data) { vmPopSetting.changeFibuSuccess(id, fibuRegionId, index, data.value, e, 1) }
                , AjaxConst.PostRequest);
        } else if (textNr === "") {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                if (fibuData.fibu.RegionFibus[i].Id == fibuRegionId) {
                    fibuData.fibu.RegionFibus[i].Fibus[index].Unsave = 1;
                    $('#fibuUnsave' + index + '-' + i).show();
                    break;
                }
            }
            vmPopSetting.ShowToolTip($(e), kLg.nrRequire, 'top');
        } else {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                if (fibuData.fibu.RegionFibus[i].Id == fibuRegionId) {
                    fibuData.fibu.RegionFibus[i].Fibus[index].Unsave = 1;
                    $('#fibuUnsave' + index + '-' + i).show();
                    break;
                }
            }
            vmPopSetting.ShowToolTip($(e).nextAll('input').first(), kLg.desRequire, 'top');
        }
    };

    vmPopSetting.changeFibusDes = function (e, id, fibuRegionId, index) {
        vmPopSetting.DestroyToolTip($(e).prevAll('input').first());
        vmPopSetting.DestroyToolTip($(e));
        var textDes = e.value.trim();
        var textNr = $(e).prevAll('input').first().val().trim();
        var objectFibus = vmPopSetting.updateChangeFibus(fibuRegionId, index, textNr, textDes);
        if (textNr !== "" && textDes !== "") {
            var entryData = { Id: objectFibus.Id, Nr: textNr, Description: textDes, LandRegionId: fibuRegionId };
            var url = "../Handlers/SettingHandler.ashx?funcName=savefibus&projid=" + projectId;
            callAjax('categories-loading', url, JSON.stringify(entryData),
                function (data) { vmPopSetting.changeFibuSuccess(id, fibuRegionId, index, data.value, e, 2) }
                , AjaxConst.PostRequest);
        } else if (textNr === "") {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                if (fibuData.fibu.RegionFibus[i].Id == fibuRegionId) {
                    fibuData.fibu.RegionFibus[i].Fibus[index].Unsave = 1;
                    $('#fibuUnsave' + index + '-' + i).show();
                    break;
                }
            }
            vmPopSetting.ShowToolTip($(e).prevAll('input').first(), kLg.nrRequire, 'top');

        } else {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                if (fibuData.fibu.RegionFibus[i].Id == fibuRegionId) {
                    fibuData.fibu.RegionFibus[i].Fibus[index].Unsave = 1;
                    $('#fibuUnsave' + index + '-' + i).show();
                    break;
                }
            }
            vmPopSetting.ShowToolTip($(e), kLg.desRequire, 'top');
        }
    };

    vmPopSetting.updateChangeFibus = function (fibuRegionId, index, textNr, textDes) {
        for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
            var itemFibu = fibuData.fibu.RegionFibus[i];
            if (itemFibu.Id === fibuRegionId) {
                fibuData.fibu.RegionFibus[i].Fibus[index].Nr = textNr;
                fibuData.fibu.RegionFibus[i].Fibus[index].Description = textDes;
                return fibuData.fibu.RegionFibus[i].Fibus[index];
            }
        }
        return {};
    };

    vmPopSetting.changeFibuSuccess = function (id, fibuRegionId, index, newId, e, type) {
        if (newId === -1) {
            if (type === 1) {
                vmPopSetting.ShowToolTip($(e), kLg.nrUsed, 'top');
            }
            if (type === 2) {
                vmPopSetting.ShowToolTip($(e).prevAll('input').first(), kLg.nrUsed, 'top');
            }
            return;
        }
        if (id === -1) {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                var itemFibu = fibuData.fibu.RegionFibus[i];
                if (itemFibu.Id === fibuRegionId) {
                    fibuData.fibu.RegionFibus[i].Fibus[index].Id = newId;
                    fibuData.fibu.RegionFibus[i].Fibus[index].Unsave = 0;
                    vmPopSetting.checkFibuUnsave();
                    $('#fibuUnsave' + index + '-' + i).hide();
                    $('#plusKosten' + index + '-' + i).show();
                    break;
                }
            }
        }
    };

    vmPopSetting.changeKostenNr = function (e, id, parrentId, index) {
        vmPopSetting.DestroyToolTip($(e));
        vmPopSetting.DestroyToolTip($(e).nextAll('input').first());
        var textNr = e.value.trim();
        var textDes = $(e).nextAll('input').first().val().trim();
        var objectKosten = vmPopSetting.updateChangeKosten(parrentId, index, textNr, textDes);
        if (textNr !== "" && textDes != "") {
            var entryData = { Id: objectKosten.Id, Nr: textNr, Description: textDes, ParrentId: parrentId };
            var url = "../Handlers/SettingHandler.ashx?funcName=savekosten&projid=" + projectId;
            callAjax('categories-loading', url, JSON.stringify(entryData),
                function (data) { vmPopSetting.changeKostenSuccess(id, parrentId, index, data.value, e, 1) }, AjaxConst.PostRequest);
        } else if (textNr === "") {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                for (var j = 0; j < fibuData.fibu.RegionFibus[i].Fibus.length; j++) {
                    if (fibuData.fibu.RegionFibus[i].Fibus[j].Id == parrentId) {
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Unsave = 1;
                        $('#kostenUnsave' + index + '-' + j + '-' + i).show();
                        break;
                    }
                }
            }
            vmPopSetting.ShowToolTip($(e), kLg.nrRequire, 'top');
        } else {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                for (var j = 0; j < fibuData.fibu.RegionFibus[i].Fibus.length; j++) {
                    if (fibuData.fibu.RegionFibus[i].Fibus[j].Id == parrentId) {
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Unsave = 1;
                        $('#kostenUnsave' + index + '-' + j + '-' + i).show();
                        break;
                    }
                }
            }
            vmPopSetting.ShowToolTip($(e).nextAll('input').first(), kLg.desRequire, 'top');
        }
    };

    vmPopSetting.changeKostenDes = function (e, id, parrentId, index) {
        vmPopSetting.DestroyToolTip($(e).prevAll('input').first());
        vmPopSetting.DestroyToolTip($(e));
        var textDes = e.value.trim();
        var textNr = $(e).prevAll('input').first().val().trim();
        var objectKosten = vmPopSetting.updateChangeKosten(parrentId, index, textNr, textDes);
        if (textNr !== "" && textDes != "") {
            var entryData = { Id: objectKosten.Id, Nr: textNr, Description: textDes, ParrentId: parrentId };
            var url = "../Handlers/SettingHandler.ashx?funcName=savekosten&projid=" + projectId;
            callAjax('categories-loading', url, JSON.stringify(entryData),
                function (data) { vmPopSetting.changeKostenSuccess(id, parrentId, index, data.value, e, 2) }, AjaxConst.PostRequest);
        } else if (textDes === "") {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                for (var j = 0; j < fibuData.fibu.RegionFibus[i].Fibus.length; j++) {
                    if (fibuData.fibu.RegionFibus[i].Fibus[j].Id == parrentId) {
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Unsave = 1;
                        $('#kostenUnsave' + index + '-' + j + '-' + i).show();
                        break;
                    }
                }
            }
            vmPopSetting.ShowToolTip($(e), kLg.desRequire, 'top');
        } else if (textNr === "") {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                for (var j = 0; j < fibuData.fibu.RegionFibus[i].Fibus.length; j++) {
                    if (fibuData.fibu.RegionFibus[i].Fibus[j].Id == parrentId) {
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Unsave = 1;
                        $('#kostenUnsave' + index + '-' + j + '-' + i).show();
                        break;
                    }
                }
            }
            vmPopSetting.ShowToolTip($(e).prevAll('input').first(), kLg.nrRequire, 'top');
        }
    };

    vmPopSetting.updateChangeKosten = function (parrentId, index, textNr, textDes) {
        for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
            var itemFibu = fibuData.fibu.RegionFibus[i].Fibus;
            for (var j = 0; j < itemFibu.length; j++) {
                if (itemFibu[j].Id === parrentId) {
                    fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Nr = textNr;
                    fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Description = textDes;;
                    return fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index];
                }
            }
        }
        return {};
    };

    vmPopSetting.changeKostenSuccess = function (id, parrentId, index, newId, e, type) {
        if (newId === -1) {
            if (type === 1) {
                vmPopSetting.ShowToolTip($(e), kLg.nrUsed, 'top');
            }
            if (type === 2) {
                vmPopSetting.ShowToolTip($(e).prevAll('input').first(), kLg.nrUsed, 'top');
            }
            return;
        }
        if (id === -1) {
            for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
                var itemFibu = fibuData.fibu.RegionFibus[i].Fibus;
                for (var j = 0; j < itemFibu.length; j++) {
                    if (itemFibu[j].Id === parrentId) {
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Id = newId;
                        fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[index].Unsave = 0;
                        vmPopSetting.checkFibuUnsave();
                        $('#kostenUnsave' + index + '-' + j + '-' + i).hide();
                        break;
                    }
                }
            }
        }
    };

    vmPopSetting.loadDdlRegionLand = function (fibuData) {
        for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
            var item = fibuData.fibu.RegionFibus[i];
            $("#ddlFibuRegion" + i).kendoDropDownList({
                dataTextField: "Name",
                dataValueField: "Id",
                value: fibuData.fibu.RegionFibus[i].LandRegionId,
                change: onChange,
                dataSource: fibuData.regionland,
                index: 0
            });
        }

    }


    vmPopSetting.loadFibuTemplate = function (template, divId, data) {
        for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
            if (fibuData.fibu.RegionFibus[i].Id !== -1) {
                fibuData.fibu.RegionFibus[i].Unsave = 0;
            }
        }
        var result = kendo.template($("#" + template).html())(data);
        $("#" + divId).html(result);
        //$(".checkFibuNumber").preventPressAlphabetChar();
        vmPopSetting.checkFibuUnsave();
    }

    vmPopSetting.checkFibuUnsave = function () {
        var checkUnsave = 0;
        for (var i = 0; i < fibuData.fibu.RegionFibus.length; i++) {
            if (fibuData.fibu.RegionFibus[i].Unsave === 1) {
                checkUnsave = 1;
            }
            for (var j = 0; j < fibuData.fibu.RegionFibus[i].Fibus.length; j++) {
                if (fibuData.fibu.RegionFibus[i].Fibus[j].Unsave === 1) {
                    checkUnsave = 1;
                }
                if (fibuData.fibu.RegionFibus[i].Fibus[j].Kostens != null) {
                    for (var k = 0; k < fibuData.fibu.RegionFibus[i].Fibus[j].Kostens.length; k++) {
                        if (fibuData.fibu.RegionFibus[i].Fibus[j].Kostens[k].Unsave === 1) {
                            checkUnsave = 1;
                            $('#kostenUnsave' + k + '-' + j + '-' + i).show();
                        }
                    }
                }
            }
        }
        if (checkUnsave === 1) {
            $('#msgFibuUnsave').show();
        } else {
            $('#msgFibuUnsave').hide();
        }
    };

    vmPopSetting.addFibuRegion = function () {
        var regionFibus = { Unsave: 1, Description: "", Nr: "", Fibus: [{ Id: 0 }], Id: -1, LandRegionId: -1 };
        fibuData.fibu.RegionFibus.push(regionFibus);
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
    }

    vmPopSetting.deleteFibuRegion = function (item, id) {
        pConfirm(kLg.confirmDeleteFibuRegion).then(function () {
            if (id === -1) {
                vmPopSetting.deleteFibuRegionSucess(item);
            } else {
                vmPopSetting.deleteFibuRegionServer(item, id);
            }
        });
    }

    vmPopSetting.deleteFibuRegionServer = function (item, idFibuRegion) {
        var url = "../Handlers/SettingHandler.ashx?funcName=deletefiburegion&projid=" + projectId + "&idFibuRegion=" + idFibuRegion;
        callAjax('categories-loading', url, null, function (data) {
            if (data.value > 0) {
                vmPopSetting.deleteFibuRegionSucess(item);
            } else {
                pAlert(kLg.msgFibuRegionAreUsing).then(function () {
                });
            }
        }, AjaxConst.PostRequest);
    }

    vmPopSetting.deleteFibuRegionSucess = function (item) {
        var index = $(item).attr("index");
        fibuData.fibu.RegionFibus.splice(index, 1);
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
    }

    vmPopSetting.addFirstFibus = function (item) {
        var count = $(item).attr("count");
        var itemFibus = { Unsave: 1, Description: "", Nr: "", Kostens: [{ Description: "", Nr: "", Id: -2, Unsave: 0 }], Id: -1 };
        fibuData.fibu.RegionFibus[count].Fibus[0] = itemFibus;
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
        $('#fibuUnsave' + 0 + '-' + count).show();
    }


    vmPopSetting.addFibus = function (item) {
        var count = $(item).attr("count");
        var itemFibus = { Unsave: 1, Description: "", Nr: "", Kostens: [{ Description: "", Nr: "", Id: -2, Unsave: 0 }], Id: -1 };
        fibuData.fibu.RegionFibus[count].Fibus.push(itemFibus);
        var index = fibuData.fibu.RegionFibus[count].Fibus.length - 1;
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
        $('#fibuUnsave' + index + '-' + count).show();
    }

    vmPopSetting.deleteFibus = function (item, id) {
        pConfirm(kLg.confirmDeleteFibus).then(function () {
            if (id === -1) {
                vmPopSetting.deleteFibusSucess(item);
            } else {
                vmPopSetting.deleteFibusServer(item, id);
            }
        });
    }

    vmPopSetting.deleteFibusServer = function (item, idFibus) {
        var url = "../Handlers/SettingHandler.ashx?funcName=deletefibus&projid=" + projectId + "&idFibus=" + idFibus;
        callAjax('categories-loading', url, null, function (data) {
            if (data.value > 0) {
                vmPopSetting.deleteFibusSucess(item);
            } else {
                pAlert(kLg.msgFibusAreUsing).then(function () {
                });
            }
        }, AjaxConst.PostRequest);
    }

    vmPopSetting.deleteFibusSucess = function (item) {
        var count = $(item).attr("count");
        var index = $(item).attr("index");
        if (fibuData.fibu.RegionFibus[count].Fibus.length > 1) {
            fibuData.fibu.RegionFibus[count].Fibus.splice(index, 1);
        } else {
            var itemFibus = { Id: 0 };
            fibuData.fibu.RegionFibus[count].Fibus[index] = itemFibus;
        }
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
    }

    vmPopSetting.addFirstKosten = function (item) {
        var countFibus = $(item).attr("countFibus");
        var countKosten = $(item).attr("countKosten");
        fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens[0].Id = -1;
        fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens[0].Nr = "";
        fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens[0].Description = "";
        fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens[0].Unsave = 1;
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
        //$('#kostenUnsave' + 0 + '-' + countKosten + '-' + countFibus).show();
    }

    vmPopSetting.addKosten = function (item) {
        var countFibus = $(item).attr("countFibus");
        var countKosten = $(item).attr("countKosten");
        //var rowNumber = fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens.length + 1;
        var itemKosten = { Unsave: 1, Description: "", Nr: "", Id: -1 };
        fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens.push(itemKosten);
        var index = fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens.length - 1;
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
        //$('#kostenUnsave' + index + '-' + countKosten + '-' + countFibus).show();
    }

    vmPopSetting.deleteKosten = function (item, id) {
        pConfirm(kLg.confirmDeleteKosten).then(function () {
            if (id === -1) {
                vmPopSetting.deleteKostenSucess(item);
            } else {
                vmPopSetting.deleteKostenServer(item, id);
            }

        });
    }

    vmPopSetting.deleteKostenServer = function (item, id) {
        var url = "../Handlers/SettingHandler.ashx?funcName=deletekosten&projid=" + projectId + "&idKosten=" + id;
        callAjax('categories-loading', url, null, function (data) {
            if (data.value > 0) {
                vmPopSetting.deleteKostenSucess(item);
            } else {
                pAlert(kLg.msgKostenAreUsing).then(function () {
                });
            }
        }, AjaxConst.PostRequest);
    }

    vmPopSetting.deleteKostenSucess = function (item) {
        var countFibus = $(item).attr("countFibus");
        var countKosten = $(item).attr("countKosten");
        var count = $(item).attr("count");
        if (fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens.length > 1) {
            fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens.splice(count, 1);
        } else {
            var itemKosten = { Description: "", Nr: "", Id: -2 };
            fibuData.fibu.RegionFibus[countFibus].Fibus[countKosten].Kostens[count] = itemKosten;
        }
        vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
        vmPopSetting.loadDdlRegionLand(fibuData);
    }

    vmPopSetting.saveFibu = function () {
        var url = "/Handlers/SettingHandler.ashx?projId=" + projectId + "&funcName=savefibu";
        callAjax("categories-loading", url, JSON.stringify(fibuData.RegionFibus), null, AjaxConst.GetRequest);
    }

    function onChange(e) {
        var dataItem = this.dataItem(e.item);
        var id = this.element.attr("itemId");
        var index = this.element.attr("id").substring(13);
        var entryData = { Id: id, LandRegionId: dataItem.Id, Type: dataItem.Type };
        if (dataItem.Id === -1) {
            fibuData.fibu.RegionFibus[index].Unsave = 1;
            $('#regionUnsave' + index).show();
            vmPopSetting.checkFibuUnsave();
            vmPopSetting.ShowToolTip($(e.sender._inputWrapper), kLg.landregionRequire, 'top');
            return;
        }
        var url = "../Handlers/SettingHandler.ashx?funcName=savefiburegion&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(entryData),
            function (data) { vmPopSetting.changeFibuRegionSuccess(e, index, data.value, dataItem.Id) }
            , AjaxConst.PostRequest);

    };

    vmPopSetting.changeFibuRegionSuccess = function (e, index, newId, landRegionId) {
        vmPopSetting.DestroyToolTip($(e.sender._inputWrapper));
        if (newId === -1) {
            vmPopSetting.ShowToolTip($(e.sender._inputWrapper), kLg.landregionRequire, 'top');
            fibuData.fibu.RegionFibus[index].Unsave = 1;
            $('#regionUnsave' + index).show();
            vmPopSetting.checkFibuUnsave();
        } else {
            fibuData.fibu.RegionFibus[index].Id = newId;
            fibuData.fibu.RegionFibus[index].LandRegionId = landRegionId;
            //fibuData.fibu.RegionFibus[index].Unsave = 0;
            vmPopSetting.loadFibuTemplate("template-fibu", divFibu, fibuData);
            vmPopSetting.loadDdlRegionLand(fibuData);
        }

    };

    vmPopSetting.ShowToolTip = function (currTarget, title, tPostition) {
        setTimeout(function () {
            currTarget.attr("title", title);
            currTarget.tooltip({ trigger: "manual", placement: tPostition }).tooltip('show');
        }, 100);
    };

    vmPopSetting.DestroyToolTip = function (currTarget) {
        currTarget.tooltip('destroy');
    };

    //manh:
    vmPopSetting.loadMasterSetting = function () {
        regionMaster = null;
        listMasterRegions = [];
        selectedSlave = [];

        if (vmPopSetting.projectId !== 0) {
            var url = "../Handlers/SettingHandler.ashx?funcName=getregion&projid=" + projectId;
            callAjax('categories-loading', url, null, function (data) {
                vmPopSetting.IsOwner = data.value.IsOwner || (!!vmPopSetting.IsEditSetting);
                for (var i = 0; i < data.value.Regions.length; i++) {
                    listMasterRegions.push(data.value.Regions[i]);

                    if (data.value.Regions[i].IsMaster) {
                        regionMaster = data.value.Regions[i];
                    } else {
                        //listSlaveRegions.push(data.value.Regions[i]);
                        if (data.value.Regions[i].IsRelation) {
                            selectedSlave.push(data.value.Regions[i]);
                        }
                    }
                }

                listSlaveRegions = data.value.Slave;

                var masterModel = kendo.observable({
                    ListMasterRegion: listMasterRegions,
                    SelectedMaster: regionMaster,
                    ListSlaveRegion: listSlaveRegions,
                    SelectedSlave: selectedSlave
                });

                kendo.bind($('#masterSetting'), masterModel);

                var ddlMaster = $('#ddlMasterRegion').multipleSelect({
                    placeholder: listMasterRegions.length == 0 ? kLg.titleNonMaster : kLg.titleSelectMaster,
                    selectAll: false,
                    single: true,
                    width: '30%',
                    maxHeight: 95,
                    onClick: function (e) {
                        if (e.value == -1) {
                            $('#ddlMasterRegion input[value=-1]').attr('disabled', 'disabled');
                        }
                        saveMaster(e.value, masterModel, ddlSlave);

                    }
                });

                var ddlSlave = $('#ddlSlaveRegion').multipleSelect({
                    placeholder: listSlaveRegions.length == 0 ? kLg.titleNonSlave : kLg.titleSelectSlave,
                    allSelected: kLg.textAllSelected,
                    countSelected: "# " + kLg.charOf + " % " + kLg.charSelected,
                    selectAll: false,
                    width: '30%',
                    maxHeight: 95,
                    onClick: function (e) {
                        if (e.value == -1) {
                            if (e.checked) {
                                $("#ddlSlaveRegion").multipleSelect("checkAll");
                            }
                            saveAllSlave(e.checked);
                            //disableMaster();
                        } else {
                            if (!e.checked) {
                                var checkeds = $('#ddlSlaveRegion').multipleSelect('getSelects');
                                var newchecked = $.grep(checkeds, function (item) {
                                    return item !== "-1";
                                });

                                $('#ddlSlaveRegion').multipleSelect('setSelects', newchecked);
                                //var $optAll = $('#slave-plan input[value=-1]')[0];
                                //if ($optAll.checked) {
                                //    $optAll.checked = false;
                                //}
                            }
                            saveSlave(e.value, e.checked);
                        }

                        disableMaster();
                    },
                    onCheckAll: function () {
                        saveAllSlave(true);
                        disableMaster();
                    },
                    onUncheckAll: function () {
                        saveAllSlave(false);
                        disableMaster();
                    }
                });

                var $opt = $("<option />", { value: -1, text: kLg.titleNonMaster });
                $opt.prop("selected", (listMasterRegions.length > 0 && regionMaster == null) ? true : false);
                //$opt.prop("selected", false);
                ddlMaster.prepend($opt).multipleSelect('refresh');

                var $optSlave = $("<option />", { value: -1, text: '<span style="color:blue;font-weight:bold">' + kLg.textSelectAll + '</span>' });
                if (data.value.IsAll) {
                    $optSlave.prop("selected", true);
                }
                ddlSlave.prepend($optSlave).multipleSelect('refresh');

                disableSlave();
                disableMaster();
                disableOverdue();

            }, AjaxConst.PostRequest);
        }
    };


    function rebindSlave(newModel, newSlave, listSlave) {

        selectedSlave = [];
        listSlaveRegions = listSlave;

        newModel = kendo.observable({
            ListMasterRegion: listMasterRegions,
            SelectedMaster: regionMaster,
            ListSlaveRegion: listSlaveRegions,
            SelectedSlave: selectedSlave
        });

        kendo.bind($('#masterSetting'), newModel);

        newSlave = $('#ddlSlaveRegion').multipleSelect({
            placeholder: listSlaveRegions.length == 0 ? kLg.titleNonSlave : kLg.titleSelectSlave,
            allSelected: kLg.textAllSelected,
            countSelected: "# " + kLg.charOf + " % " + kLg.charSelected,
            selectAll: false,
            width: '30%',
            maxHeight: 95,
            onClick: function (e) {
                saveSlave(e.value, e.checked);
                disableMaster();
            },
            onCheckAll: function () {
                saveAllSlave(true);
                disableMaster();
            },
            onUncheckAll: function () {
                saveAllSlave(false);
                disableMaster();
            }
        });

        if ($("#ddlSlaveRegion option[value='-1']").length === 0) {
            var $optSlave = $("<option />", { value: -1, text: '<span style="color:blue;font-weight:bold">' + kLg.textSelectAll + '</span>' });
            //if (data.value.IsAll) {
            //    $optSlave.prop("selected", true);
            //}
            newSlave.prepend($optSlave).multipleSelect('refresh');
        }

    }

    function saveAllSlave(status) {
        var masterId = $('#ddlMasterRegion').multipleSelect('getSelects')[0];
        var url = "../Handlers/SettingHandler.ashx?funcName=saveallslave&projid=" + projectId;
        var objSave = { statuscheck: status, masterRegionId: (+masterId) };
        callAjax('categories-loading', url, JSON.stringify(objSave), function (data) {
            if (data) {
                disableSlave();
            }
        }, AjaxConst.PostRequest);
    }

    function saveMaster(masterid, masterModel, ddlSlave) {
        var url = "../Handlers/SettingHandler.ashx?funcName=savemaster&projid=" + projectId;
        callAjax('categories-loading', url, masterid, function (data) {

            if (data) {
                disableSlave();
                rebindSlave(masterModel, ddlSlave, data.value.Slave);
            }
        }, AjaxConst.PostRequest);
    }

    function saveSlave(id, status) {
        var master = $('#ddlMasterRegion').multipleSelect('getSelects')[0];
        var url = "../Handlers/SettingHandler.ashx?funcName=saveslave&projid=" + projectId;
        var slaveObject = { slaveid: id, statuscheck: status, masterid: master };
        callAjax('categories-loading', url, JSON.stringify(slaveObject), function (data) {
            if (data) {
                disableSlave();
            }
        }, AjaxConst.PostRequest);
    }

    function disableMaster() {

        if ($('#ddlSlaveRegion').multipleSelect('getSelects').filter(i => i != '-1').length > 0 || listMasterRegions.length == 0 || !vmPopSetting.IsOwner) {
            $('#ddlMasterRegion').multipleSelect('disable');
        } else {
            $('#ddlMasterRegion').multipleSelect('enable');
        }
    }

    function disableSlave() {
        if (!($('#ddlMasterRegion').multipleSelect('getSelects').length > 0) || $('#ddlMasterRegion').multipleSelect('getSelects')[0] == "-1" || !vmPopSetting.IsOwner) {
            $('#ddlSlaveRegion').multipleSelect('disable');
        } else {
            $('#ddlSlaveRegion').multipleSelect('enable');
        }
    }

    function disableOverdue() {
        if (!vmPopSetting.IsOwner) {
            $('#cbIsOverdue').attr("disabled", true);
        } else {
            $('#cbIsOverdue').removeAttr("disabled");
        }
    }

    vmPopSetting.loadKpiSetting = function () {
        var parentType = vmPopSetting.enumsType.categoryKpiIndex;
        var divId = "place-categories" + parentType;

        var data = { ParentType: parentType, Data: vmPopSetting.arraySettingKpi };
        bindTemplate(divId, "template-setting-kpi-type", data);
        if (vmPopSetting.IsOwner) {
            vmPopSetting.SwitchSpanToInput(vmPopSetting.setNameCategories, "cssKpiCategories");
        } else {
            $("#pop-setting").on("click", ".cssKpiCategories", (e) => $("a[href=#kpiIndex" + $(e.target).attr("data-id") + "]").click());
        }
    };

    vmPopSetting.GetTemplateKpi = function (type) {
        var url = "../Handlers/SettingHandler.ashx?funcName=getallcategoriesbytype&parentType=" + vmPopSetting.enumsParentType.Marketing + "&type=" + type + "&projid=" + projectId;
        callAjax('categories-loading', url, null, function (data) {
            var divId = "place-kpi" + type;
            vmPopSetting.arrCategories[parseInt(type)] = data.value;
            if (vmPopSetting.arrCategories[parseInt(type)].length === 0) {
                var cate = {
                    Id: 0,
                    Type: parseInt(type)
                };
                vmPopSetting.arrCategories[parseInt(type)].push(cate);
            }
            bindTemplate(divId, "template-table-categories", vmPopSetting.arrCategories[parseInt(type)]);
            vmPopSetting.SetupValidate(type);
            vmCommon.setupMenuIcon('#pop-setting span[data-toggle=dropdown]', '#setting-pop');
            vmPopSetting.setUpMouseClick();
            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) {
                vmPopSetting.SetUpDragDrop();
            }
        }, AjaxConst.GetRequest);
    };
    vmPopSetting.returnSettingHome = function (state, typeId) {
        switch (state) {
            case vmPopSetting.enumsRoleConflict.conflict:
                pAlert(kLg.msgConflickData).then(function () {
                    vmPopSetting.GetSubCategories(typeId);
                });
                break;
            case vmPopSetting.enumsRoleConflict.using:
                var msg = (typeId === vmPopSetting.enumsType.categoryKpiUnit)
                    ? kLg.msgUnitAreUsing
                    : kLg.msgCategoryAreUsing;

                pAlert(msg).then(function () {
                });
                break;
            case vmPopSetting.enumsRoleConflict.nameExist:
                if (typeId === vmPopSetting.enumsType.categoryKpiUnit) {
                    $("#pop-add-kpiunit #txtNameCategories").attr('title', kLg.msgNameIsExisted);
                    $("#pop-add-kpiunit #txtNameCategories").tooltip('show');
                } else {
                    pAlert(kLg.msgNameIsExisted).then(function () {
                    });
                }
                break;
            default:
                vmPopSetting.GetSubCategories(typeId);
                break;
        }
    };

    vmPopSetting.DeleteKpiUnit = function (j) {
        var kpiUnit = vmPopSetting.KpiUnits[j];
        var obj = { id: kpiUnit.Id };
        var url = '../Handlers/SettingHandler.ashx?funcName=deletekpiunit&projid=' + projectId + "&strid=" + strategyId;
        pConfirm(kLg.confirmDeleteCategories).then(function () {
            callAjax('categories-loading', url, JSON.stringify(obj), function (data) {
                vmPopSetting.returnSettingHome(data.value, vmPopSetting.enumsType.categoryKpiUnit);
            }, AjaxConst.PostRequest);
        });
    };

    vmPopSetting.FormatUnitData = function (kpiUnits) {

        if (kpiUnits == null) return kpiUnits;
        for (var i = 0; i < kpiUnits.length; i++) {
            switch (kpiUnits[i].TypeId) {
                case vmPopSetting.enumTypeKPI.Number:
                    kpiUnits[i].TypeName = kLg.lblKpiNumber;
                    break;
                case vmPopSetting.enumTypeKPI.Currency:
                    kpiUnits[i].TypeName = kLg.lblKpiCurrency;
                    break;
                case vmPopSetting.enumTypeKPI.Percent:
                    kpiUnits[i].TypeName = kLg.lblKpiPercent;
                    break;
                case vmPopSetting.enumTypeKPI.Index:
                    kpiUnits[i].TypeName = kLg.menuKpiIndex;
                    break;
                case vmPopSetting.enumTypeKPI.M2:
                    kpiUnits[i].TypeName = kLg.lblKpiM2;
                    break;
                case vmPopSetting.enumTypeKPI.Hour:
                    kpiUnits[i].TypeName = kLg.lblKpiHour;
                    break;
            }

        }
        return kpiUnits;
    };

    vmPopSetting.FormatTrendData = function (formats) {

        if (formats == null) return formats;
        for (var i = 0; i < formats.length; i++) {
            formats[i].TypeName = kLg.lblKpiFormatDefault;
        }
        return formats;
    };
    var popUpKpiTopic = undefined;
    vmPopSetting.OpenPopUpAddKpiTopic = function () {
        popUpKpiTopic = showPopup(popUpKpiTopic,
            $('#pop-add-categories-place'),
            vmCommon.rootUrl + 'Contents/MsPopAddKpiTopic.html',
            {
                title: kLg.lblKpiTopic,
                height: 185,
                width: 500,
                resizable: false
            });
    };

    vmPopSetting.OpenPopUpAddKpiIndex = function (i, g) {

        $("#spAddKpiIndex").tooltip('destroy');
        if (vmPopSetting.DataKpiTopics.KpiUnits.length === 0 || vmPopSetting.DataKpiTopics.KpiTimes.length === 0) {
            vmPopSetting.ShowToolTip($("#spAddKpiIndex"), kLg.msgUnitorTimenotAvailable, 'right');
            return;
        }
        var topics = vmPopSetting.DataKpiTopics.KpiTopics[i];
        var lastkpiIndex = topics.KpiIndexs[topics.KpiIndexs.length - 1];
        var mIndex = 1000;
        if (lastkpiIndex.MIndex) {
            mIndex = lastkpiIndex.MIndex + 1000;
        }

        var kpiIndex = {
            Id: -1, Name: '', ProjectId: projectId, MIndex: mIndex, KpiUnitId: vmPopSetting.DataKpiTopics.KpiUnits[0].Id,
            KpiTimeId: vmPopSetting.DataKpiTopics.KpiTimes[0].Id, KpiTopicId: topics.Id
        };
        if (g === -1) {
            topics.KpiIndexs[0] = kpiIndex;
        } else {
            topics.KpiIndexs.push(kpiIndex);
        }
        vmPopSetting.binddlKpiUnit();

        vmPopSetting.showResultKpi(vmPopSetting.enumsRoleConflict.valueempty, i, g + 1);
    };

    vmPopSetting.changeNameIndex = function (e, i, g) {
        var name = e.value.trim();
        if (name === "") {
            vmPopSetting.showResultKpi(vmPopSetting.enumsRoleConflict.valueempty, i, g);
            return;
        }
        vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g].Name = e.value.trim();
        var entryData = vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g];
        vmPopSetting.dataservice.updateKpiIndex(entryData, function (res) {
            if (entryData.Id === -1 && res.value > 0) {
                entryData.Id = res.value;
                $('#sIndex' + i + g).hide();
            }
            vmPopSetting.showResultKpi(res.value, i, g);
        });

    }

    vmPopSetting.showResultKpi = function (rv, i, g) {
        if (rv < 1) {
            //$('#sIndex' + i + g).show();
            vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g].IsInvalid = true;
            //$('#msgTopicIndexUnsave').show();
        } else if (rv > 0) {
            //$('#sIndex' + i + g).hide();
            vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g].IsInvalid = false;
            //$('#msgTopicIndexUnsave').hide();
        }
        vmPopSetting.checkInvalid();

    }

    vmPopSetting.checkInvalid = function () {
        $('#msgTopicIndexUnsave').hide();
        var topics = vmPopSetting.DataKpiTopics.KpiTopics;
        var isInvalid = false;

        if (typeof topics !== 'undefined' && topics.length > 0) {
            for (var i = 0; i < topics.length; i++) {
                if (topics[i].IsInvalid === true) {
                    isInvalid = true;
                    $('#sTopic' + i).show();
                } else {
                    $('#sTopic' + i).hide();
                }


                if (topics[i].KpiIndexs.length > 0) {
                    for (var g = 0; g < topics[i].KpiIndexs.length; g++) {
                        if (topics[i].KpiIndexs[g].IsInvalid === true) {
                            isInvalid = true;
                            $('#sIndex' + i + g).show();
                        } else {
                            $('#sIndex' + i + g).hide();
                        }

                    }

                }
            }
        }

        if (isInvalid) {
            $('#msgTopicIndexUnsave').show();
        }

    }
    vmPopSetting.setTopicInvalid = function (id, validValue, value) {
        var topics = vmPopSetting.DataKpiTopics.KpiTopics;
        for (var i = 0; i < topics.length; i++) {
            if (topics[i].Id === Number(id)) {
                topics[i].IsInvalid = validValue;
                topics[i].Name = value;
                break;
            }

        }
    }


    vmPopSetting.onChangeUnit = function () {
        var dropdown = this.element.data('kendoDropDownList');
        var idData = this.element.attr('id').substr(10);
        var indexU = idData.indexOf("a");
        var g = idData.substr(indexU + 1, idData.length);
        var i = idData.substr(0, indexU);
        vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g].KpiUnitId = parseFloat(dropdown.value());
        var entryData = vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g];

        vmPopSetting.dataservice.updateKpiIndex(entryData, function (res) {
            if (entryData.Id === -1 && res.value > 0) {
                entryData.Id = res.value;
                $('#sIndex' + i + g).hide();
            }

        });
    }

    vmPopSetting.onChangeTime = function () {
        var dropdown = this.element.data('kendoDropDownList');
        var idData = this.element.attr('id').substr(10);
        var indexU = idData.indexOf("a");
        var g = idData.substr(indexU + 1, idData.length);
        var i = idData.substr(0, indexU);
        vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g].KpiTimeId = parseFloat(dropdown.value());
        var entryData = vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g];
        vmPopSetting.dataservice.updateKpiIndex(entryData, function (res) {
            if (entryData.Id === -1 && res.value > 0) {
                entryData.Id = res.value;
                $('#sIndex' + i + g).hide();
            }
        });

    }

    vmPopSetting.deleteKpiIndex = function (i, g) {
        pConfirm(kLg.deleteKpiIndex).then(function () {
            var kpiIndex = vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs[g];
            var entryData = { Id: kpiIndex.Id };
            if (kpiIndex.Id === -1 || kpiIndex.Id === -3) {
                if (vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs.length === 1) {
                    kpiIndex.Id = 0;
                } else {
                    vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs.splice(g, 1);
                }
                vmPopSetting.binddlKpiUnit();
                vmPopSetting.checkInvalid();
            } else {
                vmPopSetting.dataservice.deleteKpiIndex(entryData, function (res) {
                    if (res.value > 0) {
                        if (vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs.length === 1) {
                            kpiIndex.Id = 0;
                        } else {
                            vmPopSetting.DataKpiTopics.KpiTopics[i].KpiIndexs.splice(g, 1);
                        }
                        vmPopSetting.binddlKpiUnit();
                        vmPopSetting.checkInvalid();
                    } else {
                        pAlert(kLg.msgIndexAreUsing).then(function () {
                        });
                    }
                });
            }

            vmPopSetting.checkInvalid();

        });

    }

    vmPopSetting.deleteKpiTopic = function (i) {

        pConfirm(kLg.deleteConfirmQuestion).then(function () {

            var kpiTopic = vmPopSetting.DataKpiTopics.KpiTopics[i];
            var entryData = { Id: kpiTopic.Id };
            vmPopSetting.dataservice.deleteKpiTopic(entryData, function (res) {
                vmPopSetting.DataKpiTopics.KpiTopics.splice(i, 1);
                vmPopSetting.binddlKpiUnit();
                vmPopSetting.checkInvalid();
            });

        });
    }

    var srcIndex = 0, desIndex = 0;
    vmPopSetting.bindCategorySortable = function (id, type) {
        $('#' + id).sortable({
            axis: "y",
            items: "div.div-hover",
            cancel: "input,textarea,table,div.dnb-settings-sub-sortable",
            cursor: "n-resize",
            revert: false,
            opacity: 0.8,
            tolerance: "pointer",
            containment: "parent",
            start: function (event, ui) {
                srcIndex = ui.item.index();
            },
            stop: function (event, ui) {
                desIndex = ui.item.index();
                if (srcIndex === desIndex) return;

                var src = vmPopSetting.arrCategories[type];

                if (src.length === 0) return;

                var srcId = src[srcIndex].Id;
                var desId = src[desIndex].Id;
                vmPopSetting.ChangePositionCategories(desId, srcId, type, srcIndex > desIndex ? 0 : 1);
            }
        });
        $('#' + id).children().css('top', 0);
    }

    vmPopSetting.bindTopicSortable = function () {
        $("#tblKpiTopicIndex").sortable({
            axis: "y",
            items: "tr.topic-header",
            cancel: "input,textarea.table",
            cursor: "n-resize",
            revert: false,
            opacity: 0.8,
            tolerance: "pointer",
            containment: "parent",
            start: function (event, ui) {
                srcIndex = $("#tblKpiTopicIndex").find("tr.topic-header").index(ui.item);
            },
            stop: function (event, ui) {
                desIndex = $("#tblKpiTopicIndex").find("tr.topic-header").index(ui.item);
                if (srcIndex === desIndex) return;

                var src = vmPopSetting.DataKpiTopics.KpiTopics;
                if (src.length === 0) return;

                var srcId = src[srcIndex].Id;
                var desId = src[desIndex].Id;

                vmPopSetting.ChangePositionKpiTopic(desId, srcId, vmPopSetting.enumsType.categoryAdvertisingMaterials, srcIndex > desIndex ? 0 : 1);
            }
        });
    }
    var srcId = 0;
    var srcParentId = 0;
    vmPopSetting.bindKpiIndexSortable = function () {
        $("#tblKpiTopicIndex").sortable({
            axis: "y",
            items: "tr.tr-kpi-hover",
            cancel: "input,textarea",
            cursor: "n-resize",
            revert: false,
            opacity: 0.8,
            tolerance: "pointer",
            containment: "parent",
            start: function (event, ui) {

                //srcIndex = $("#tblKpiTopicIndex").find("tr.tr-kpi-hover").index(ui.item);
                srcId = $(ui.item).attr("id");
                //alert(srcId);
                //srcParentId = $(ui.item).attr("parentid");
            },
            stop: function (event, ui) {

                //desIndex = $("#tblKpiTopicIndex").find("tr.tr-kpi-hover").index(ui.item);
                var desId = $(ui.item).attr("id");
                //var desParentId = $(uis.item).attr("parentid");
                //alert(desId);
                ////if (srcId === desId) return;

                //var src = vmPopSetting.DataKpiTopics.KpiTopics;
                //if (src.length === 0) return;

                //vmPopSetting.ChangePositionKpiIndex(desId, srcId, desParentId, srcParentId, srcIndex > desIndex ? 0 : 1);
            }
        });
    }

    vmPopSetting.binKpiFormat = function (indexformat, categoryId) {

        var viewModelSettingIndex = kendo.observable({
            settingIndexs: vmPopSetting.updateListSettingIndex(indexformat.KpiSettingIndexs),
            settingFormats: indexformat.KpiFormats,
            formatName: kLg.lblKpiFormat,
            CategoryId: categoryId,
            IsInvisible: vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting,
            FormatTxt: "txtKpiFormat" + categoryId,
            //formChange : function(){
            //    vmPopSetting.IsModified = true;
            //},
            isEmptyIndexs: indexformat.KpiSettingIndexs.length === 0,
            selectKpiIndex: function (e) {
                //var src = this.settingIndexs;
                vmPopSetting.IndexObj = e.data;
                //vmPopSetting.Index = src.indexOf(e.data);
                vmPopSetting.selectKpiUnit(e.data.Id);
            },
            addKpiIndex: function (e) {
                vmPopSetting.IndexObj = { Id: 0, CategoryId: e.data.CategoryId };
                vmPopSetting.selectKpiUnit(0);
            },
            addKpiEmptyIndex: function () {

                vmPopSetting.IndexObj = { Id: 0, CategoryId: categoryId };
                vmPopSetting.selectKpiUnit(0);
            },
            updateExpectedValue: function (e) {
                var eData = e.data;
                var entryData = {
                    Id: eData.Id,
                    CategoryId: eData.CategoryId,
                    ExpectedValue: eData.ExpectedValue,
                    KpiIndexId: eData.IndexId,
                    IsKpiDefault: eData.IsKpiDefault
                };
                vmPopSetting.dataservice.updateKpiSettingIndex(entryData, function (res) {

                });
            },
            onChangeDefault: function (e) {
                var eData = e.data;
                var entryData = {
                    Id: eData.Id,
                    CategoryId: eData.CategoryId,
                    ExpectedValue: eData.ExpectedValue,
                    KpiIndexId: eData.IndexId,
                    IsKpiDefault: eData.IsKpiDefault
                };
                vmPopSetting.dataservice.updateKpiSettingIndex(entryData, function (res) {

                });
            },
            deleteKpiIndex: function (e) {
                pConfirm(kLg.deleteKpiIndex).then(function () {
                    var entryData = { Id: e.data.Id };
                    vmPopSetting.dataservice.deleteSettingIndex(entryData, function (res) {
                        vmPopSetting.getAndBindIndexFormat(e.data.CategoryId);
                    });
                });
            },
            editKpiFormat: function (e) {
                var eData = e.data;
                vmPopSetting.OpenPopUpKpiFormat(eData);
            },
            deleteKpiFormat: function (e) {
                pConfirm(kLg.deleteConfirmQuestion).then(function () {
                    var entryData = { Id: e.data.Id };
                    vmPopSetting.dataservice.deleteKpiFormat(entryData, function (res) {
                        if (res.value === vmPopSetting.enumsRoleConflict.using) {
                            pAlert(kLg.msgFormatAreUsing).then(function () {
                            });
                        } else {
                            vmPopSetting.getAndBindIndexFormat(e.data.CategoryId);
                        }
                    });
                });
            },
            addCrmLink: function (e) {

                var entryData = { Id: 0, KpiFormatId: e.data.Id, FTypeId: vmPopSetting.enumTypeFormat.CrmLink }
                vmPopSetting.dataservice.updateKpiFormatItem(entryData, function (res) {
                    vmPopSetting.getAndBindIndexFormat(categoryId);
                });
            },
            addDocument: function (e) {
                var entryData = { Id: 0, KpiFormatId: e.data.Id, FTypeId: vmPopSetting.enumTypeFormat.Document }
                vmPopSetting.dataservice.updateKpiFormatItem(entryData, function (res) {
                    vmPopSetting.getAndBindIndexFormat(categoryId);
                });
            },
            addKpiEmptyFormat: function () {
                vmPopSetting.addKpiFormat(categoryId);
            }

        });

        kendo.bind($("#pop-kpisettingindex"), viewModelSettingIndex);


    }

    vmPopSetting.updateListSettingIndex = (function (listSettingIndex) {
        if (listSettingIndex.length === 0) {
            listSettingIndex = [];
            return listSettingIndex;
        }


        listSettingIndex[listSettingIndex.length - 1].VisualAdd = (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting);
        for (var i = 0; i < listSettingIndex.length; i++) {
            //if (listSettingIndex[i].ExpectedValue === 0) {
            //    listSettingIndex[i].ExpectedValue = '';
            //}
            var orderFormat = listSettingIndex[i].OrderId === 2 ? "{0} ##,#.00" : "##,#.00 {0}";

            listSettingIndex[i].IsEdit = vmPopSetting.Role > 0;
            listSettingIndex[i].OrderFormat = orderFormat.format(listSettingIndex[i].Symbol.encodeDola().encodeSymbol());
        }
        return listSettingIndex;

    });

    vmPopSetting.addKpiFormat = function (categoryId) {

        var validator = $("#categories-form" + vmPopSetting.enumsType.categoryAdvertisingMaterials).validate();
        if (!validator.element("#txtKpiFormat" + categoryId)) return;

        var txtformat = $("#txtKpiFormat" + categoryId).val();
        var entryData = { Id: 0, CategoryId: categoryId, Name: txtformat };
        vmPopSetting.dataservice.updateKpiFormat(entryData, function (res) {

            if (res.value === vmPopSetting.enumsRoleConflict.nameExist) {
                vmPopSetting.ShowToolTip($("#txtKpiFormat" + categoryId), kLg.msgUsingKpiFormat.format(kLg.lblKpiFormat), 'top');
            } else {
                vmPopSetting.getAndBindIndexFormat(categoryId);
                $("#txtKpiFormat" + categoryId).val("");
            }

        });
    }

    vmPopSetting.openFormat = function (id) {

        if ($("#kpiformat" + id).attr("class").indexOf("collapsed") !== -1) {
            vmPopSetting.openFormatId = 0;
        } else
            vmPopSetting.openFormatId = id;

        $("input[name='CategoryName']").tooltip('destroy');

    };

    vmPopSetting.formatDataService = function () {
        var formats = [];

        var add = function (lst) {
            if (lst && lst.constructor === Array) {
                for (var i = 0; i < lst.length; i++) {
                    var newItem = lst[i];
                    var index = formats.findIndex(function (it) { return it.Id == newItem.Id; });
                    if (index === -1)
                        formats.push(newItem);
                    else
                        formats[index] = newItem;
                }

                return true;
            }

            return false;
        };

        var getById = function (id) {
            return vmCommon.findByFunc(formats, function (it) { return it.Id == id; });
        };

        var all = function () {
            return formats;
        };

        return { add: add, getById: getById, all: all };
    }();

    vmPopSetting.getAndBindIndexFormat = function (categoryId) {
        var entryData = { Id: categoryId };
        vmPopSetting.dataservice.getAllSettingIndex(entryData, function (res) {
            $("#txtKpiFormat" + categoryId).tooltip('destroy');
            vmPopSetting.AllData = res.value;
            vmPopSetting.formatDataService.add(res.value.KpiFormats);

            vmPopSetting.binKpiFormat(res.value, categoryId);
            if (vmPopSetting.openFormatId !== 0) {
                $("#linkkpiformat" + vmPopSetting.openFormatId).trigger('click');
            }

            $("#txtKpiFormat" + categoryId).bind("keyup", function () {
                $("#txtKpiFormat" + categoryId).tooltip('destroy');
            });

            vmPopSetting.SetLangSettingIndex();
            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)
                vmPopSetting.bindFormatSortable(categoryId);

            if (vmPopSetting.Role < 1 && !vmPopSetting.IsEditSetting) {
                $('#child-place-Type' + categoryId + ' input[type="text"]').prop("disabled", true);
                $('#child-place-Type' + categoryId + ' textarea.eval-textarea').prop("disabled", true);
            }
        });
    }

    var popUpSelectIndex = undefined;
    vmPopSetting.selectKpiUnit = function (id) {
        var entryData = { Id: id }
        vmPopSetting.dataservice.getSelectIndex(entryData, function (serData) {
            vmPopSetting.TopicIndex = serData.value.KpiTopics;
            vmPopSetting.Paths = serData.value.Paths;
            popUpSelectIndex = showPopup(popUpSelectIndex,
                $('#divSelectKpiIndex'),
                vmCommon.rootUrl + 'Contents/MsPopSelectSettingIndex.html',
                {
                    title: kLg.titleSelectKpiIndex.format(kLg.menuKpiIndex),
                    width: 800,
                    height: 525,
                    resizable: false,
                    scrollable: true
                }
            );
        });
    };

    var popUpKpiFormat = undefined;
    vmPopSetting.OpenPopUpKpiFormat = function (data) {
        vmPopSetting.FormatItem = data;
        popUpKpiFormat = showPopup(popUpKpiFormat,
            $('#divSelectKpiIndex'),
            vmCommon.rootUrl + 'Contents/MsPopAddKpiFormat.html',
            {
                title: kLg.lblKpiFormat,
                height: 290,
                width: 500,
                resizable: false
            });
    };

    vmPopSetting.ControlType = {
        Format: 1,
        Cost: 2,
        Description: 3,
        Link: 4,
        MFile: 5

    };

    function renFormatControl(item, categoryId) {
        var res = '';
        switch (item.FTypeId) {
            case vmPopSetting.ControlType.Format:
                res = vmPopSetting.renFormatTextbox(item);
                break;
            case vmPopSetting.ControlType.Cost:
                res = vmPopSetting.renCostTextbox(item);
                break;
            case vmPopSetting.ControlType.Description:
                res = vmPopSetting.renFormatTextArea(item);
                break;
            case vmPopSetting.ControlType.Link:
                res = vmPopSetting.renCrmLink(item, categoryId);
                break;
            case vmPopSetting.ControlType.MFile:
                res = vmPopSetting.renDocument(item, categoryId);
                break;
        }

        return res;
    };

    vmPopSetting.renDocument = function (item, categoryId) {
        var rs = "<div class='formatcontent'>";

        rs += "<div class='clear'></div>";

        rs += "<div class='formatfile' fi='" + item.Id + "'>";
        for (var i = 0; i < item.ItemValues.length; i++) {
            var itemValue = item.ItemValues[i];
            rs += vmPopSetting.renFormatItemValue(itemValue, categoryId);
        }

        rs += "</div>";

        if (vmPopSetting.Role > vmCommon.MemberRole.Edit || vmPopSetting.IsOwner) {
            rs += "<input type='file' fi='" + item.Id + "' name='txtFile" + item.Id + "' id='txtFile" + item.Id + "' style='display: none;' class='modal-input txtInput w-470' multiple>";
            rs += "<button type='button' class='ms-button button-upload' name='uploadFile' style='margin-right: 0;height: 19px;margin-top: 3px;float: initial;' fi='" + item.Id;
            rs += "' cateid='" + categoryId + "' fcount='" + item.ItemValues.length + "' formatid='" + item.KpiFormatId;
            rs += "' onclick='vmPopSetting.upLoadFile(this);'><span class='icon-16 icon-upload' ></span><span>Durchsuchen...</span></button>";
        }

        rs += "</div>";
        rs += "<div class='clear'></div>";

        return rs;
    };

    //ENTITY
    function KpiFormatItemValue() {
        this.Id = 0;
        this.Name = "";
        this.KpiFormatItemId = 0;
        this.BId = null;
        this.GId = null;
        this.TypeId = 0;
        this.DataState = dataState.Added;
        this.FileTypeId = 0;

        return this;
    };
    function getSettingRoleNumber() {
        if (vmPopSetting.IsEditSetting || vmPopSetting.IsOwner)
            return vmCommon.MemberRole.Owner;
        return vmPopSetting.Role;
    }
    vmPopSetting.upLoadFile = function (e) {
        vmFile.CurrentRole = getSettingRoleNumber(); //!vmPopSetting.IsOwner ? vmPopSetting.Role : vmCommon.MemberRole.Owner;
        
        var formatItemId = $(e).attr("fi");
        var categoryId = $(e).attr("cateid");
        var fCount = $(e).attr("fcount");
        var formatId = $(e).attr("formatid");

        if (formatId == undefined || formatItemId == undefined || categoryId == undefined || fCount == undefined || isNaN(Number(formatItemId)) || isNaN(Number(categoryId)) || isNaN(Number(fCount)) || isNaN(Number(formatId))) return;

        formatItemId = Number(formatItemId);
        categoryId = Number(categoryId);
        fCount = Number(fCount);
        formatId = Number(formatId);

        var format = vmPopSetting.formatDataService.getById(formatId);
        if (!format.AdvertisingName || format.AdvertisingName.indexOf("/") > -1 || !format.AdvertiserName || format.AdvertiserName.indexOf("/") > -1 || !format.Name || format.Name.indexOf("/") > -1) return;

        var paths = [format.AdvertisingName, format.AdvertiserName, format.Name].join("/");

        //upload callback
        function uploadCallback(savedFiles) {
            if (savedFiles.length === 0) return;

            vmPopSetting.dataservice.insertFormatFile({ Ids: savedFiles.map(function (it) { return it.Id; }).join(), KpiFormatItemId: formatItemId }, function (res) {
                vmPopSetting.getAndBindIndexFormat(categoryId);
            });
        };

        function validAttachFile(files) {
            //var nSize = 0;
            for (var i = 0; i < files.length; i++) {
                if (files[i].size > (100 * 1024 * 1024)) {
                    pAlert(kLg.msgTotalFileOverLoad);
                    return false;
                }
            }

            if ((files.length + fCount) > 10) {
                pAlert(kLg.msgLimit10file);
                return false;
            }

            return true;
        };

        //upload file
        function upFile(files) {
            if (files.length === 0 || !validAttachFile(files)) return false;

            var cpdata = new FormData();
            var count = 0;

            for (var i = 0; i < files.length; i++) {
                cpdata.append(files[i].name, files[i]);
                count++;
            }

            cpdata.append("structure", paths);

            var url = "../Handlers/DFolderHandler.ashx?funcName=uploadformatfile&projid=" + projectId + "&strid=" + strategyId;
            vmCommon.sendFile(url, cpdata, function (res) {
                var savedFiles = res.value;
                uploadCallback(savedFiles);

            }, "");

            return true;
        };

        //upload url callback
        function upUrl(dFolder) {
            dFolder.Type = vmCommon.FileType.Url;
            var url = "../Handlers/DFolderHandler.ashx?funcName=uploadformaturl&projid=" + projectId + "&strid=" + strategyId;
            callAjax("", url, JSON.stringify({ Url: dFolder, Paths: paths }), function (res) {
                var savedFiles = res.value;
                uploadCallback(savedFiles);

            }, AjaxConst.PostRequest);

            return true;
        };

        //upload path callback
        function upPath(dFolder) {
            dFolder.Type = vmCommon.FileType.Path;
            var url = "../Handlers/DFolderHandler.ashx?funcName=uploadformaturl&projid=" + projectId + "&strid=" + strategyId;
            callAjax("", url, JSON.stringify({ Url: dFolder, Paths: paths }), function (res) {
                var savedFiles = res.value;
                uploadCallback(savedFiles);

            }, AjaxConst.PostRequest);

            return true;
        };

        vmFile.uploadOptions = {};
        vmFile.uploadOptions.Func = new UploadFunc(upFile, upUrl, upPath);

        showUploadFile();
        return;
    };

    vmPopSetting.renFormatItemValue = function (itemValue, categoryId) {
        var rs = "";
        rs += "<div class='formatfile-item' iv='" + itemValue.Id + "'>" +
            "<div class='pull-left'>";

        if (itemValue.FileTypeId === vmCommon.FileType.Url) {
            rs += "<a class='goal-truncate ms-link' onclick='vmKpiAction.copy2Clipboard(this)'>" + itemValue.Name + "</a>";
        } else if (itemValue.FileTypeId === vmCommon.FileType.Path) {
            rs += "<span class='goal-truncate ms-link' onclick='vmKpiAction.copy2Clipboard(this)'>" + itemValue.Name + "</span>";
        } else {
            rs += "<a class='goal-truncate ms-link' onclick='vmKpiAction.copy2Clipboard(this)'>" + itemValue.Name + "</a>";
        }
        rs += "</div>";

        if (vmPopSetting.Role > vmCommon.MemberRole.Edit || vmPopSetting.IsOwner) {
            rs += "<span class='icon-20 ms-icon-delete-gray' style='cursor: pointer;zoom: 85%;' ivid='" + itemValue.Id + "' cateid='" + categoryId + "' onclick='vmPopSetting.deleteFile(this)'></span>";
        }
        rs += "</div>";

        return rs;
    };

    vmPopSetting.deleteFile = function (e) {
        var itemValueId = $(e).attr("ivid");
        var categoryId = $(e).attr("cateid");

        if (itemValueId == undefined || categoryId == undefined || isNaN(Number(itemValueId)) || isNaN(Number(categoryId))) return;
        itemValueId = Number(itemValueId);
        categoryId = Number(categoryId);

        vmPopSetting.dataservice.deleteFormatItemValue({ Id: itemValueId }, function (res) {
            vmPopSetting.getAndBindIndexFormat(categoryId);
        });
    };

    vmPopSetting.renCrmLink = function (item, categoryId) {
        var divStr = "<div class='formatcontent'>";
        divStr += "<div class='clear'></div>";
        divStr += "<div class='crmlink' fi='" + item.Id + "'>";

        var itemValues = $.grep(item.ItemValues, function (it) { return it.DataState !== dataState.Deleted; });
        for (var i = 0; i < itemValues.length; i++) {
            var itemValue = itemValues[i];
            divStr += "<div class='crmlink-item' fi='" + item.Id + "'><div class='pull-left'><a class='goal-truncate ms-link'>" + itemValue.Name + "</a></div>";

            if (vmPopSetting.Role > vmCommon.MemberRole.Edit || vmPopSetting.IsOwner) {
                divStr += "<span class='icon-20 ms-icon-delete-gray' cateid='" + categoryId + "' ivid='" + itemValue.Id + "' style='cursor: pointer;zoom: 85%;' onclick='vmPopSetting.deleteCrmLink(this)'></span>";
            }

            divStr += "</div>";
        }

        divStr += "</div>";

        if (vmPopSetting.Role > vmCommon.MemberRole.Edit || vmPopSetting.IsOwner) {
            divStr += "<div class='crmlink-add' fi='" + item.Id + "'><span class='icon-32 cursor-pointer icon-add' fid='" + item.KpiFormatId + "' fi='" + item.Id + "' cateid='" + categoryId + "' onclick='vmPopSetting.selectCrmLink(this)'></span></div>";
        }

        divStr += "</div>";
        return divStr + "<div class='clear'></div>";
    };

    var vmGoalAction = vmGoalAction || {};
    var vmKpiAction = vmKpiAction || {};
    vmPopSetting.CrmData = undefined;
    vmGoalAction.popCrmLink = undefined;

    vmPopSetting.selectCrmLink = function (e) {
        var formatItemId = $(e).attr("fi");
        var formatId = $(e).attr("fid");
        var categoryId = $(e).attr("cateid");

        if (formatId == undefined || formatItemId == undefined || categoryId == undefined || isNaN(Number(formatItemId)) || isNaN(Number(categoryId)) || isNaN(Number(formatId))) return;

        formatId = Number(formatId);
        formatItemId = Number(formatItemId);
        categoryId = Number(categoryId);

        var format = vmPopSetting.formatDataService.getById(formatId);
        if (format == null) return;

        var formatItem = vmCommon.findByFunc(format.KpiFormatItems, function (it) { return it.Id == formatItemId; });
        if (formatItem == null) return;

        if (formatItem.ItemValues.length >= 10) {
            pAlert(kLg.msgLimitedCrmLink);
            return;
        }

        function changeCrmLinkCallback(itemvalue) {
            itemvalue.FTypeId = 1; //setting
            itemvalue.KpiFormatItemId = formatItemId;

            vmPopSetting.dataservice.changeCrmLink(itemvalue, function (res) {
                if (res == -1) {
                    pAlert(itemvalue.TypeId == 1 ? kLg.msgCrmFormatExistOrganisation : kLg.msgCrmFormatExistPerson);
                } else {
                    vmPopSetting.getAndBindIndexFormat(categoryId);
                }

            });
        };

        vmKpiAction.formatItemOptions = {};
        vmKpiAction.formatItemOptions.crmLink = { Id: 0, Name: "", KpiFormatItemId: 0, BId: null, GId: null, TypeId: 0, DataState: dataState.Added, FileTypeId: 0 };
        vmKpiAction.formatItemOptions.callback = changeCrmLinkCallback;

        if (vmPopSetting.CrmData == undefined) {
            vmPopSetting.dataservice.getOrganisationPerson(null, function (res) {
                vmPopSetting.CrmData = res.value;
                vmKpiAction.formatItemOptions.CrmData = vmPopSetting.CrmData;
                vmPopSetting.openSelectCrmLink();
            });

        } else {
            vmKpiAction.formatItemOptions.CrmData = vmPopSetting.CrmData;
            vmPopSetting.openSelectCrmLink();
        }
    };

    vmPopSetting.deleteCrmLink = function (e) {
        var itemvalueId = $(e).attr("ivid");
        var categoryId = $(e).attr("cateid");

        if (itemvalueId == undefined || categoryId == undefined || isNaN(Number(itemvalueId)) || isNaN(Number(categoryId))) return;
        itemvalueId = Number(itemvalueId);
        categoryId = Number(categoryId);

        vmPopSetting.dataservice.deleteFormatItemValue({ Id: itemvalueId }, function (res) {
            vmPopSetting.getAndBindIndexFormat(categoryId);
        });
    };

    vmPopSetting.openSelectCrmLink = function () {
        vmGoalAction.popCrmLink = showPopup(vmGoalAction.popCrmLink,
            $("#pop-selectcrmlink"),
            vmCommon.rootUrl + "Contents/MsPopSelectCrmLink.html",
            {
                title: kLg.titleSelectCrmLink,
                width: 650,
                height: 525,
                resizable: false
            });
    };

    vmPopSetting.renFormatTextbox = function (item) {
        return '<input type="text" class="input-kpi-format-item" style="padding-left: 5px;"  maxlength="50" value="' + item.MValue + '" onchange="vmPopSetting.updateFormatItem(this,' + item.Id + ')"' +
            ' id="ft' + item.Id + '" ' + ((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting === true) ? "" : "disabled") + ' x/>';
    }

    vmPopSetting.renCostTextbox = function (item) {
        return '<input class="text-right txtInput formatinput" data-role="numerictextbox" data-spinners="false" style="padding-left: 3px;" type="text" data-max="999999999999" value="' +
            item.MValue + '" onchange="vmPopSetting.updateFormatItem(this,' + item.Id + ')"' +
            ' id="ft' + item.Id + '" ' + ((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting === true) ? "" : "disabled") + ' />';
    }

    vmPopSetting.renFormatTextArea = function (item) {
        return '<textarea class="eval-textarea" onchange="vmPopSetting.updateFormatItem(this,' + item.Id + ')"' +
            ' id="ft' + item.Id + '" ' + ((vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting === true) ? "" : "disabled") + ' >' + item.MValue + '</textarea>';
    }

    vmPopSetting.deleteFormatItem = function (id, categoryId) {
        pConfirm(kLg.confirmDeleteCategories).then(function () {
            var entryData = { Id: id };
            vmPopSetting.dataservice.deleteFormatItem(entryData, function (res) {
                vmPopSetting.getAndBindIndexFormat(categoryId);
            });
        });

    }

    vmPopSetting.updateFormatItem = function (e, id) {
        var value = e.value.trim();
        if ($(e).attr("data-role") === "numerictextbox") {
            value = value.toNumber();

            var min = -999999999999;
            var max = 999999999999;

            if (value < min) value = min;
            if (value > max) value = max;
        }

        var entryData = { Id: id, MValue: value };
        vmPopSetting.dataservice.updateKpiFormatItem(entryData, function (res) {
        });
    }

    var srcIndex = 0, desIndex = 0;
    vmPopSetting.bindFormatSortable = function (categoryId) {
        $("#pop-kpiformat").sortable({
            axis: "y",
            items: "div.div-hover",
            cancel: "h4.panel-title,a.childcategories,input,textarea, table.popup-table-email",
            cursor: "n-resize",
            revert: false,
            opacity: 0.8,
            connectWith: ".dnb-settings-sub-sortable",
            tolerance: "pointer",
            containment: "parent",
            start: function (event, ui) {
                srcIndex = ui.item.index();
            },
            stop: function (event, ui) {
                desIndex = ui.item.index();
                if (srcIndex === desIndex) return;

                var src = vmPopSetting.AllData.KpiFormats;
                if (src.length === 0) return;

                var srcId = src[srcIndex].Id;
                var desId = src[desIndex].Id;
                vmPopSetting.ChangePositionFormat(desId,
                    srcId,
                    vmPopSetting.enumsType.categoryKpiFormat,
                    srcIndex > desIndex ? 0 : 1,
                    categoryId);
            }
        });
    }

    vmPopSetting.ChangePositionFormat = function (desId, sourceId, type, position, parentId) {
        var moving = {
            SourceId: sourceId,
            DesId: desId,
            SourceMdf: 0,
            DesMdf: 0,
            ParentType: vmPopSetting.enumsParentType.Marketing,
            Type: type,
            Position: position,
            ParentSourceId: parentId
        };
        vmPopSetting.dataservice.updateKpiFormatMIndex(moving, function (res) {

        });
    };

    vmKpiAction.copy2Clipboard = function (e) {
        if (!e) return;
        var text = $(e).text() || $(e).html();
        if (text.length <= 0) return;
        text = vmCommon.cutQuotaSymbol(text);
        if (text.length <= 0) return;
        vmCommon.coppyToClipboard(text);
        vmCommon.showNotification(e, kLg.msgCopyClipBoardSucc, 750, -65);
    };

    vmPopSetting.smpGetTitleByLevel = function (type, level) {
        var title = "";

        if (level > 3) level = 3;
        switch (level) {
            case 1:
                if (type == vmPopSetting.enumsType.categoryCustomerJourney) {
                    title = kLg.vtextCustomerJourney;
                }
                else {
                    title = type == vmPopSetting.enumsType.categoryProduct
                        ? kLg.filterLblProductGroup
                        : kLg.lblSubmarket;
                }
                break;
            case 2:
                if (type == vmPopSetting.enumsType.categoryCustomerJourney) {
                    title = kLg.titleJourney;
                }
                else {
                    title = type == vmPopSetting.enumsType.categoryProduct
                        ? kLg.filterLblProduct
                        : kLg.contactPerson;
                }
                break;
            case 3:
                if (type == vmPopSetting.enumsType.categoryCustomerJourney) {
                    title = kLg.titleSubJourney;
                }
                else {
                    title = type == vmPopSetting.enumsType.categoryProduct
                        ? kLg.filterLblSubProduct
                        : kLg.contactSubPerson;
                }
                break;
            default:
                title = ""; break;
        }
        return title;
    };

    vmPopSetting.GetChildSubmarketProduct = function (type, level, id, delFlag) {

        var genIds = '' + type + level + id;
        var isDelete = delFlag != undefined ? delFlag : false;
        $("div[type=div-child-submarketproduct" + genIds + "]").html("");
        if (!isDelete) {
            switch (level) {
                case 1:
                    $("a[class*='childsubmarketproduct']").not('.childsubmarketproduct' + genIds).find('span.arrow-panel-online').removeClass("arrow-right-big").addClass("arrow-collapse");
                    break;
                case 2:
                    $("a[class*='childsubmarketproduct']").not('.childsubmarketproduct' + genIds).not("a[class*='childsubmarketproduct" + type + (level - 1) + "']").find('span.arrow-panel-online').removeClass("arrow-right-big").addClass("arrow-collapse");
                    break;
                case 3:
                    $("a[class*='childsubmarketproduct']").not('.childsubmarketproduct' + genIds).not("a[class*='childsubmarketproduct" + type + (level - 1) + "']").not("a[class*='childsubmarketproduct" + type + (level - 2) + "']").find('span.arrow-panel-online').removeClass("arrow-right-big").addClass("arrow-collapse");
                    break;
            }
        }

        var divChildType = $("div[id*='childType" + type + level + "']").not("#childType" + genIds);
        divChildType.height(0);
        divChildType.removeClass("in");

        $("input[name='CategoryName']").tooltip('destroy');
        var divId = "child-place" + genIds;
        var entry = { ProjectId: projectId, ParentType: vmPopSetting.enumsParentType.Marketing, Type: type, Level: level, Id: id };

        var url = "../Handlers/SettingHandler.ashx?funcName=getchildforsubmarketproduct&parentType=" + vmPopSetting.enumsParentType.Marketing + "&type=" + type + "&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
            if (data.length === 0) {
                var cate = {
                    Id: 0,
                    Type: type
                };
                data.push(cate);
            }

            bindTemplate(divId, "template-parent-submarketproduct", data);

            $("#lblParentCategory" + genIds).text(vmPopSetting.smpGetTitleByLevel(type, level + 1));
            if (vmPopSetting.IsOwner) {
                bindSwitchSpanToInputCatLib(vmPopSetting.updateNameSub, "ProductClickEdit");
            }

            if (vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting) {
                vmPopSetting.setupDragDropSmpSe(type, level + 1);
            }
        }, AjaxConst.PostRequest);
    };

    vmPopSetting.updateNameSub = function (typeId, levelId, values) {
        var titleName = '';
        switch (parseInt(typeId)) {
            case vmPopSetting.enumsType.categoryProduct:
                switch (parseInt(levelId)) {
                    case 1:
                        titleName = 'filterLblProduct';
                        break;
                    case 2:
                        titleName = 'filterLblSubProduct';
                        break;
                }
                break;
            case vmPopSetting.enumsType.categorySubmarket:
                switch (parseInt(levelId)) {
                    case 1:
                        titleName = 'contactPerson';
                        break;
                    case 2:
                        titleName = 'contactSubPerson';
                        break;
                }
                break;
            case vmPopSetting.enumsType.categoryCustomerJourney:
                switch (parseInt(levelId)) {
                    case 1:
                        titleName = 'titleJourney';
                        break;
                    case 2:
                        titleName = 'titleSubJourney';
                        break;
                }
                break;
            case vmPopSetting.enumsType.categoryAdvertiser:
                titleName = 'lblNameAdvertiser';
                break;
        }
        var entryData = { ClientKeyName: titleName, Value: values, LangId: kLg.language };
        vmPopSetting.dataservice.saveLanguage(entryData, function (res) {
            kLg[titleName] = values;
            $('.cssSpan' + typeId + levelId).each(function () {
                var tit = vmPopSetting.getTitleForPopSubmarketProduct(typeId, levelId, kLg.add);
                $(this).text(tit);
            });
        });
    }

    vmPopSetting.addNameChildSubmarketProductSe = function (type, parentid, level) {
        $("input[name='CategoryName']").tooltip('destroy');
        var genIds = '' + type + level + parentid;
        var name = $("#txtName" + genIds).val().trim();
        if (!name || name.length == 0) return;
        var entry = {
            ProjectId: projectId,
            Name: name,
            Type: type,
            ParentId: parentid,
            Level: level,
            ParentType: vmPopSetting.enumsParentType.Marketing
        };
        var url = "../Handlers/SettingHandler.ashx?funcName=addChildSubmarketProductSeByCat&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
            $("#txtName" + genIds).tooltip('destroy');
            var state = data.ResultStatus;
            switch (state) {
                case vmPopSetting.enumsRoleConflict.using:
                    pAlert(kLg.msgCategoryAreUsing).then(function () {
                        vmPopSetting.ChooseCategories(type);
                    });
                    break;
                case vmPopSetting.enumsRoleConflict.nameExist:
                    $("#txtName" + genIds).attr('title', kLg.msgNameIsExisted);
                    $("#txtName" + genIds).data('tooltip', true)
                    $("#txtName" + genIds).tooltip('show');
                    $("#txtName" + genIds).off('input').on('input', function () {
                        if ($(this).data('tooltip')) {
                            $(this).removeAttr('title');
                            $(this).removeAttr('data-original-title');
                            $(this).removeAttr('aria-required');
                            $(this).removeAttr('aria-invalid');
                            $(this).tooltip('destroy');
                            $(this).data('tooltip', false);
                        }
                    });
                    break;
                default:
                    $("#txtName" + genIds).val("");
                    vmPopSetting.GetChildSubmarketProduct(type, level, parentid);
                    break;
            }

        }, AjaxConst.PostRequest);
    };

    vmPopSetting.smpUpdateChildDes = function (type, parentId, sid, level) {
        var url = "../Handlers/SettingHandler.ashx?funcName=smpUpdateChildDes&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify({ SubItemId: sid, Type: type, Description: $('#smpChildDescription' + type + level + sid).val() }), function (data) {

            var plv = level - 1;
            vmPopSetting.GetChildSubmarketProduct(type, plv, parentId, true);
            setTimeout(function () {
                var sstr = '.childsubmarketproduct' + type + level + sid;
                $(sstr).click();
            }, 350);
        }, AjaxConst.PostRequest);
    };

    vmPopSetting.smpRenDocument = function (type, level, parentid, subid, docs) {

        if (!docs || docs.length == 0) return '';
        var parentLv = level - 1;
        var str = '<div class="clear"></div>';
        for (var i = 0; i < docs.length; i++) {
            var dFundown = "vmPopSetting.downloadSPFile(this,'" + docs[i].PhysicalName + "','" + docs[i].FolderFileName + "'," + docs[i].FileTypeId + ")";
            str += '<div class="document-item pull-left"><div class="pull-left"><a onclick="' + dFundown + '" class="goal-truncate ms-link">';
            str += docs[i].FolderFileName;
            str += '</a></div>';
            var dFunc = "vmPopSetting.smpDeleteDocument(" + type + "," + parentLv + "," + parentid + "," + subid + "," + docs[i].FolderFileId + ")";
            str += '<span class="icon-20 ms-icon-delete-gray" style="margin-top: -3px;" onclick="' + dFunc + '"></span>';
            str += '</div>';
        }
        return str;
    };

    vmPopSetting.smpDeleteDocument = function (type, level, pid, sid, ffid) {
        var url = "../Handlers/SettingHandler.ashx?funcName=smpDeleteDocFromSetting&projid=" + projectId;
        callAjax('categories-loading', url, JSON.stringify({ SubItemId: sid, FolderFileId: ffid }), function (data) {

            var clv = level + 1;
            vmPopSetting.GetChildSubmarketProduct(type, level, pid, true);
            setTimeout(function () {
                var sstr = '.childsubmarketproduct' + type + clv + sid;
                $(sstr).click();
            }, 350);
        }, AjaxConst.PostRequest);
    };

    vmPopSetting.downloadSPFile = function (element, path, name, fileTypeId) {
        vmCommon.ClickToDownAndCopy("../FileUpload/" + path,
            name,
            fileTypeId,
            element);
    };
    
    vmPopSetting.smpUploadDocument = function (type, level, pid, sid) {
        var role = getSettingRoleNumber();
        vmCommon.showUploadDocument(function (savedFiles) {
            var ffids = "";
            for (var i = 0; i < savedFiles.length; i++) {
                if (ffids.length > 0) ffids += ',' + savedFiles[i].Id;
                else ffids += '' + savedFiles[i].Id;
            }
            if (ffids.length > 0) {
                var url = "../Handlers/SettingHandler.ashx?funcName=smpAssignDocumentFormSetting&projid=" + projectId;
                callAjax('categories-loading', url, JSON.stringify({ Type: type, SubItemId: sid, Level: level, FolderFileIds: ffids }), function (data) {

                    var plv = level - 1;
                    vmPopSetting.GetChildSubmarketProduct(type, plv, pid, true);
                    setTimeout(function () {
                        var sstr = '.childsubmarketproduct' + type + level + sid;
                        $(sstr).click();
                    }, 350);
                }, AjaxConst.PostRequest);
            }

        }, role);
    };

    vmPopSetting.getTitleForPopSubmarketProduct = function (type, level, action) {
        var langTitle = "Add";
        var isSubMarketType = type == vmPopSetting.enumsType.categorySubmarket;
        var isProductType = type == vmPopSetting.enumsType.categoryProduct;
        var isJourneyType = type == vmPopSetting.enumsType.categoryCustomerJourney;

        switch (true) {
            case action == kLg.edit && isSubMarketType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.lblSubmarket);
                break;
            case action == kLg.edit && isSubMarketType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.contactPerson);
                break;
            case action == kLg.edit && isSubMarketType && level == 3:
                langTitle = vmCommon.joinString(action, kLg.contactSubPerson);
                break;

            case action == kLg.edit && isProductType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.lblProductGroupLabelL1);
                break;
            case action == kLg.edit && isProductType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.filterLblProduct);
                break;
            case action == kLg.edit && isProductType && level == 3:
                langTitle = vmCommon.joinString(action, kLg.filterLblSubProduct);
                break;

            case action == kLg.add && isSubMarketType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.contactPerson);
                break;
            case action == kLg.add && isSubMarketType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.contactSubPerson);
                break;
            case action == kLg.add && isProductType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.filterLblProduct);
                break;
            case action == kLg.add && isProductType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.filterLblSubProduct);
                break;

            case action == kLg.edit && isJourneyType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.vtextCustomerJourney);
                break;
            case action == kLg.edit && isJourneyType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.titleJourney);
                break;
            case action == kLg.edit && isJourneyType && level == 3:
                langTitle = vmCommon.joinString(action, kLg.titleSubJourney);
                break;

            case action == kLg.add && isJourneyType && level == 1:
                langTitle = vmCommon.joinString(action, kLg.titleJourney);
                break;
            case action == kLg.add && isJourneyType && level == 2:
                langTitle = vmCommon.joinString(action, kLg.titleSubJourney);
                break;
        }

        return htmlDecode(langTitle);
    };

    vmPopSetting.popEditSubmarketProductSe = function (type, id, level) {

        var isJourneyType = type == vmPopSetting.enumsType.categoryCustomerJourney;
        var linkTemplate = vmCommon.rootUrl + 'Contents/MsPopSubmarketProductSe.html';
        var height = 336;

        if (isJourneyType) {
            linkTemplate = vmCommon.rootUrl + 'Contents/MsPopCustomerJourneySe.html';
            height = 274;
        }

        vmCommon.popSubmarketProductSeDatas = { Type: type, Id: id, Level: level, Role: getSettingRoleNumber() };
        vmCommon.popSubmarketProductSe = showPopup(vmCommon.popSubmarketProductSe, $('#popMenuSubmarketProductSe'),
            linkTemplate,
            {
                height: height,
                width: 530,
                resizable: false
            });
        var t = vmPopSetting.getTitleForPopSubmarketProduct(type, level, kLg.edit);
        vmCommon.popSubmarketProductSe.title(htmlDecode(t));
    };
    
    vmPopSetting.popAddSubmarketProductSe = function (type, parentId, level) {
        var isJourneyType = type == vmPopSetting.enumsType.categoryCustomerJourney;
        var linkTemplate = vmCommon.rootUrl + 'Contents/MsPopSubmarketProductSe.html';
        var height = 336;

        if (isJourneyType) {
            linkTemplate = vmCommon.rootUrl + 'Contents/MsPopCustomerJourneySe.html';
            height = 274;
        }

        vmCommon.popSubmarketProductSeDatas = { Type: type, ParentId: parentId, Id: 0, Level: level, Role: getSettingRoleNumber() };
        vmCommon.popSubmarketProductSe = showPopup(vmCommon.popSubmarketProductSe, $('#popMenuSubmarketProductSe'),
            linkTemplate,
            {
                height: height,
                width: 530,
                resizable: false
            });
        var t = vmPopSetting.getTitleForPopSubmarketProduct(type, level, kLg.add);
        vmCommon.popSubmarketProductSe.title(htmlDecode(t));
    };

    vmPopSetting.deleteSubmarketProductSe = function (type, parentid, id, level) {
        pConfirm(kLg.confirmDeleteCategories).then(function () {
            var entry = {
                ProjectId: projectId,
                Type: type,
                Id: id,
                Level: level,
                ParentType: vmPopSetting.enumsParentType.Marketing
            };
            var url = "../Handlers/SettingHandler.ashx?funcName=deleteSubmarketProductSe&projid=" + projectId;
            callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
                var state = data.ResultStatus;
                switch (state) {
                    case vmPopSetting.enumsRoleConflict.using:
                        pAlert(kLg.msgCategoryAreUsing).then(function () {
                            vmPopSetting.ChooseCategories(type);
                        });
                        break;
                    default:
                        if (level == 1)
                            vmPopSetting.GetTemplateCategories(type);
                        else {
                            level = level - 1;
                            vmPopSetting.GetChildSubmarketProduct(type, level, parentid, true);
                        }
                        break;
                }

            }, AjaxConst.PostRequest);
        }, function () {
            //Cancel Option
        });

    };

    vmPopSetting.setupDragDropSmpSe = function (type, level) {
        if (!(vmPopSetting.Role > 1 || vmPopSetting.IsEditSetting)) return;

        var selector = ".SmpSeDragDrop" + type + level;
        var sId, sType, sLevel, tId, tType, tLevel, parentId;
        $(selector).draggable({
            revert: true,
            cursor: 'default',
            cursorAt: { top: 0, left: 0 },
            handler: selector,
            axis: 'y',
            scroll: true,
            start: function () {
                $(this).addClass('onDragging');
                sId = parseInt($(this).attr("iid"));
                sType = parseInt($(this).attr("itype"));
                sLevel = parseInt($(this).attr("ilv"));
                parentId = parseInt($(this).attr("ipid"));
            },
            stop: function () {

                $(this).removeClass('onDragging');
                if (!sId || !tId || sId == tId) return;

                var entry = {
                    ProjectId: projectId,
                    SrcId: sId,
                    SrcType: sType,
                    SrcLevel: sLevel,
                    TargetId: tId,
                    TargetType: tType,
                    TargetLevel: tLevel,
                    ParentId: parentId
                };

                var url = "../Handlers/SettingHandler.ashx?funcName=smpUpdateMIndex&projid=" + projectId;
                callAjax('categories-loading', url, JSON.stringify(entry), function (data) {
                    var state = data.ResultStatus;
                    switch (state) {
                        case 1:
                            if (entry.SrcLevel == 1)
                                vmPopSetting.GetTemplateCategories(entry.SrcType);
                            else {
                                if (parentId > 0) {
                                    var level = entry.SrcLevel - 1;
                                    vmPopSetting.GetChildSubmarketProduct(entry.SrcType, level, parentId);
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }, AjaxConst.PostRequest);
            }
        });

        $(selector).droppable({
            hoverClass: 'ui-state-hover',
            accept: selector,
            tolerance: 'intersect',
            drop: function () {
                tId = parseInt($(this).attr("iid"));
                tType = parseInt($(this).attr("itype"));
                tLevel = parseInt($(this).attr("ilv"));
                parentId = parseInt($(this).attr("ipid"));
            }
        });
    };

    vmPopSetting.setNameCategories = function (id, value) {
        var entryData = { ClientKeyName: vmPopSetting.enumLanguage[id], Value: value, LangId: kLg.language };
        kLg[vmPopSetting.enumLanguage[id]] = value;
        vmPopSetting.dataservice.saveLanguage(entryData, function (res) {
            $("#pop-setting #spanCatId" + id).text(value);
        });
    }
    var clicks = 0, timer = null;
    vmPopSetting.SwitchSpanToInput = function (updateData, cssSelector, maxlength) {
        var currentText = '';
        var switchToInput = function (el) {
            currentText = $(el).text().trim();
            var textWidth = $(el).width();
            var $input = $("<input>",
                {
                    val: currentText,
                    type: "text"
                });
            if (maxlength)
                $input.attr('maxlength', maxlength);
            else
                $input.attr('maxlength', 100);

            if (textWidth < 200) textWidth = 200;
            else if (textWidth > 690) textWidth = 690;
            

            $input.addClass(cssSelector);
            $input.attr("data-id", $(el).attr("data-id"));
            $input.css({ 'color': 'black' });
            $(el).replaceWith($input);
            $input.width(textWidth + "px");
            $input.addClass('span-to-input');
            $input.off('mouseleave').on("mouseleave", switchToSpan);
            $input.select();

            $input.keydown(function (e) {
                if (e.keyCode == 13 || e.keyCode == 27) {
                    $input.mouseleave();
                }
            });
        };


        function switchToSpan() {
            var objId = $(this).attr('data-id');
            var $span = $("<span>",
                {
                    text: $(this).val()
                });

            var newText = $(this).val().trim();

            if (newText.length > 0 && newText != currentText) {
                updateData(objId, newText);
            } else {
                $span.text(currentText);
            }

            $span.addClass(cssSelector);
            $(this).replaceWith($span);
            $span.attr("data-id", objId);
            //$span.attr("data-toggle", 'collapse');
            //$span.attr("data-target", spanId + typeId);
            handleClick();
        };

        // handle click and dblclick

        function handleClick() {
            $("." + cssSelector).off('click').click(function () {
                var $this = $(this);
                var id = parseInt($this.attr('data-id'));

                if (id == vmPopSetting.enumsType.categoryPlanning) {
                    $(`a[href=#categories${id}]`).click();
                    return;
                }

                clicks++;

                if (clicks == 1) {
                    timer = setTimeout(function () {
                        clicks = 0;
                        var x = cssSelector == "cssCategories" ? "categories" : cssSelector == "cssKpiCategories" ? "kpiIndex" : "";
                        $(`a[href=#${x}${id}]`).click();
                    }, 550);
                }
                if (clicks == 2) {
                    clearTimeout(timer);
                    clicks = 0;
                    switchToInput($this);
                }
            });

        };

        handleClick();
    };


</script>

<style>
    .tooltip { z-index: 30000 !important; }
    #pop-setting > #pop-setting-place .panel-title span.cssCategories {
        word-break: break-all
    }
    #pop-setting-place .tbgrid {
        margin-left: -2px;
    }
</style>
